const _0x9b8979=_0x24a9;(function(_0x56aaf9,_0x45772c){const _0x2a7ac5=_0x24a9,_0x497f7=_0x56aaf9();while(!![]){try{const _0x31a768=parseInt(_0x2a7ac5(0x1fb))/0x1*(parseInt(_0x2a7ac5(0x1b3))/0x2)+-parseInt(_0x2a7ac5(0x1ec))/0x3*(parseInt(_0x2a7ac5(0x1fd))/0x4)+-parseInt(_0x2a7ac5(0x1f5))/0x5+parseInt(_0x2a7ac5(0x1c9))/0x6*(-parseInt(_0x2a7ac5(0x1f0))/0x7)+parseInt(_0x2a7ac5(0x1d1))/0x8*(parseInt(_0x2a7ac5(0x1d0))/0x9)+parseInt(_0x2a7ac5(0x1f7))/0xa+parseInt(_0x2a7ac5(0x1e3))/0xb*(parseInt(_0x2a7ac5(0x1f9))/0xc);if(_0x31a768===_0x45772c)break;else _0x497f7['push'](_0x497f7['shift']());}catch(_0x2f626c){_0x497f7['push'](_0x497f7['shift']());}}}(_0x3ce4,0x1f1cd));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x38a249 from'path';import _0x4ef5ed from'fs';import _0x294110 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x22d203 from'file-type';import{MsgListener}from'@/core/listeners';import _0x5c279b from'image-size';function _0x24a9(_0x15bea2,_0x1f17e5){const _0x3ce488=_0x3ce4();return _0x24a9=function(_0x24a950,_0x4752c4){_0x24a950=_0x24a950-0x1b0;let _0x565650=_0x3ce488[_0x24a950];return _0x565650;},_0x24a9(_0x15bea2,_0x1f17e5);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x512fbe=>{const _0x42b58e=_0x24a9;for(const [_0xca9f7b,_0x51232a]of downloadMediaTasks){_0x51232a(_0x512fbe),downloadMediaTasks[_0x42b58e(0x1bd)](_0xca9f7b);}},setTimeout(()=>{const _0x37de98=_0x24a9;napCatCore[_0x37de98(0x1bc)](()=>{const _0x51c0af=_0x37de98;napCatCore[_0x51c0af(0x1c4)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x49ae8a){const _0x24508f=_0x24a9;return _0x22d203[_0x24508f(0x1c7)](_0x49ae8a);}static async[_0x9b8979(0x1bf)](_0x54cdc4,_0x9e7e42){const _0x56e2f1=_0x9b8979;await napCatCore[_0x56e2f1(0x1ed)][_0x56e2f1(0x1bf)](_0x54cdc4,_0x9e7e42);}static async[_0x9b8979(0x1b9)](_0x57f60d){const _0x14fff3=_0x9b8979;return await napCatCore[_0x14fff3(0x1ed)]['getFileSize'](_0x57f60d);}static async[_0x9b8979(0x1bb)](_0x2c355e,_0x592024=ElementType[_0x9b8979(0x1e2)],_0x45e85e=0x0){const _0x312108=_0x9b8979,_0x5c003b={'nCtLD':function(_0x2c1624,_0x408c5a){return _0x2c1624(_0x408c5a);},'DupNk':function(_0x272263,_0xc4fd98){return _0x272263===_0xc4fd98;}},_0x43987e=await _0x5c003b[_0x312108(0x1cb)](calculateFileMD5,_0x2c355e);let _0xb27eca=(await NTQQFileApi[_0x312108(0x1b0)](_0x2c355e))?.[_0x312108(0x1c5)]||'';_0xb27eca&&(_0xb27eca='.'+_0xb27eca);let _0x51efee=''+_0x38a249[_0x312108(0x1e1)](_0x2c355e);_0x5c003b[_0x312108(0x1c8)](_0x51efee[_0x312108(0x1e5)]('.'),-0x1)&&(_0x51efee+=_0xb27eca);const _0x364ebd=napCatCore[_0x312108(0x1fa)][_0x312108(0x1d7)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x43987e,'fileName':_0x51efee,'elementType':_0x592024,'elementSubType':_0x45e85e,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x2c355e,_0x364ebd);const _0x580878=await NTQQFileApi[_0x312108(0x1b9)](_0x2c355e);return{'md5':_0x43987e,'fileName':_0x51efee,'path':_0x364ebd,'fileSize':_0x580878,'ext':_0xb27eca};}static async[_0x9b8979(0x1ea)](_0x5cb8f9,_0x430609,_0x3d062c,_0x57fb54,_0x3a3e9f,_0x245d04,_0x1f638e=0x3e8*0x3c*0x2,_0x356700=![]){const _0x329dc6=_0x9b8979,_0x138aa7={'sicbQ':function(_0x4305fb,_0x45da88){return _0x4305fb(_0x45da88);},'RjyeF':_0x329dc6(0x1d9),'CIaBj':function(_0x14a766){return _0x14a766();},'nTcpO':function(_0x35c055,_0xa850be,_0x119662){return _0x35c055(_0xa850be,_0x119662);}};if(_0x245d04&&_0x4ef5ed[_0x329dc6(0x1f3)](_0x245d04)){if(_0x356700)try{await _0x294110[_0x329dc6(0x1b6)](_0x245d04);}catch(_0x548f01){}else return _0x245d04;}return new Promise((_0xf5ba90,_0x9eb567)=>{const _0x55f940=_0x329dc6,_0x21ce3e={'jiDCm':function(_0xb92873,_0x2eca90){return _0xb92873===_0x2eca90;},'zvbUK':function(_0x480c87,_0x2231c3){const _0x4c766e=_0x24a9;return _0x138aa7[_0x4c766e(0x1c1)](_0x480c87,_0x2231c3);},'PBhTh':function(_0x21b79c,_0x38ff03){return _0x21b79c(_0x38ff03);},'Npfdk':_0x138aa7['RjyeF']};let _0x3d1dfa=![];const _0xb20044=_0x10c2bc=>{const _0x13f8ec=_0x24a9;if(_0x21ce3e['jiDCm'](_0x10c2bc['msgId'],_0x5cb8f9)){_0x3d1dfa=!![];let _0x1a7077=_0x10c2bc[_0x13f8ec(0x1f2)];if(_0x1a7077['startsWith']('\x5c')){const _0x4f41c4=sessionConfig[_0x13f8ec(0x1ca)];_0x1a7077=_0x38a249['join'](_0x4f41c4,_0x1a7077);}_0x21ce3e[_0x13f8ec(0x1ef)](_0xf5ba90,_0x1a7077);}};downloadMediaTasks[_0x55f940(0x1eb)](_0x138aa7[_0x55f940(0x1b7)](randomUUID),_0xb20044),_0x138aa7['nTcpO'](setTimeout,()=>{const _0x5b7b13=_0x55f940;!_0x3d1dfa&&_0x21ce3e['PBhTh'](_0x9eb567,_0x21ce3e[_0x5b7b13(0x1ee)]);},_0x1f638e),napCatCore[_0x55f940(0x1fa)][_0x55f940(0x1d7)]()[_0x55f940(0x1c6)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x5cb8f9,'chatType':_0x430609,'peerUid':_0x3d062c,'elementId':_0x57fb54,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3a3e9f});});}static async[_0x9b8979(0x1d2)](_0xca9f1c){const _0x1f7dbd={'nCoFa':function(_0x175c47,_0x42afe2){return _0x175c47(_0x42afe2);},'YLdfh':function(_0x44aaf3,_0x38b4e5,_0x28da0b){return _0x44aaf3(_0x38b4e5,_0x28da0b);}};return new Promise((_0x3c399e,_0x4cc644)=>{const _0x493f22=_0x24a9,_0x5dcc93={'GkSYA':function(_0x3617e5,_0x24bd62){const _0x28e813=_0x24a9;return _0x1f7dbd[_0x28e813(0x1da)](_0x3617e5,_0x24bd62);}};_0x1f7dbd[_0x493f22(0x1de)](_0x5c279b,_0xca9f1c,(_0x1c511d,_0x4e31a4)=>{const _0x423f94=_0x493f22;_0x1c511d?_0x4cc644(_0x1c511d):_0x5dcc93[_0x423f94(0x1d5)](_0x3c399e,_0x4e31a4);});});}static async[_0x9b8979(0x1d6)](_0x482f87,_0x4b97c9){const _0x2f3438=_0x9b8979,_0x5f2db5={'shMPe':_0x2f3438(0x1ce),'pYiiI':'&rkey=','kYImZ':function(_0x5e6766,_0x5afa6c){return _0x5e6766+_0x5afa6c;},'dPeCK':function(_0x3c93cf,_0x1a1e01){return _0x3c93cf+_0x1a1e01;},'VEMrW':function(_0x344785,_0x5a1f19){return _0x344785+_0x5a1f19;},'DbkrN':function(_0x285465,_0x4d3f4d){return _0x285465||_0x4d3f4d;},'ngQBm':function(_0xf477c0,_0x59b7b6){return _0xf477c0||_0x59b7b6;},'zUCIw':function(_0x578089,_0x491dfc,_0x3fa955){return _0x578089(_0x491dfc,_0x3fa955);},'ctIQS':_0x2f3438(0x1df)};if(!_0x482f87)return'';const _0x26ef6a=_0x482f87[_0x2f3438(0x1d3)],_0x4b1696=_0x482f87[_0x2f3438(0x1b5)],_0x3c31b2=_0x482f87[_0x2f3438(0x1b5)],_0x1a5de0=_0x482f87[_0x2f3438(0x1f4)];if(_0x26ef6a){if(_0x26ef6a['startsWith'](_0x5f2db5[_0x2f3438(0x1dc)])){if(_0x26ef6a[_0x2f3438(0x1dd)](_0x5f2db5[_0x2f3438(0x1cc)]))return _0x5f2db5[_0x2f3438(0x1e8)](IMAGE_HTTP_HOST_NT,_0x26ef6a);const _0x312db8=await rkeyManager[_0x2f3438(0x1b1)](),_0x4e7e35=_0x4b97c9?_0x312db8[_0x2f3438(0x1e9)]:_0x312db8['group_rkey'];return _0x5f2db5[_0x2f3438(0x1ba)](_0x5f2db5[_0x2f3438(0x1c2)](IMAGE_HTTP_HOST_NT,_0x26ef6a),''+_0x4e7e35);}else return _0x5f2db5[_0x2f3438(0x1ba)](IMAGE_HTTP_HOST,_0x26ef6a);}else{if(_0x5f2db5[_0x2f3438(0x1e7)](_0x3c31b2,_0x4b1696))return IMAGE_HTTP_HOST+_0x2f3438(0x1d4)+_0x5f2db5[_0x2f3438(0x1b8)](_0x3c31b2,_0x4b1696)[_0x2f3438(0x1b2)]()+'/0';}return _0x5f2db5[_0x2f3438(0x1e4)](logDebug,_0x5f2db5[_0x2f3438(0x1be)],_0x482f87),'';}}export class NTQQFileCacheApi{static async[_0x9b8979(0x1cf)](_0x31921e=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x9b8979(0x1f1)](_0x436bec=['tmp',_0x9b8979(0x1c0)]){const _0x429d9c=_0x9b8979;return napCatCore[_0x429d9c(0x1fa)]['getStorageCleanService']()[_0x429d9c(0x1fc)](_0x436bec);}static['addCacheScannedPaths'](_0x5b85b1={}){const _0x12cc40=_0x9b8979;return napCatCore[_0x12cc40(0x1fa)][_0x12cc40(0x1f6)]()[_0x12cc40(0x1b4)](_0x5b85b1);}static[_0x9b8979(0x1d8)](){const _0x17b42d=_0x9b8979;return napCatCore['session'][_0x17b42d(0x1f6)]()[_0x17b42d(0x1d8)]();}static[_0x9b8979(0x1cd)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x9b8979(0x1c3)](_0x244fd4,_0x152a84=0x3e8,_0x1338aa=0x0){const _0x2263f2=_0x9b8979;return napCatCore[_0x2263f2(0x1fa)][_0x2263f2(0x1f6)]()[_0x2263f2(0x1db)](_0x244fd4,_0x152a84,0x1,_0x1338aa);}static[_0x9b8979(0x1e0)](_0x157945,_0x3b0d46=0x3e8,_0x2d8d31){const _0xa7a330=_0x2d8d31?_0x2d8d31:{'fileType':_0x157945};}static async[_0x9b8979(0x1e6)](_0x3dc690=[],_0x1cd413=[]){const _0x334f0e=_0x9b8979;return napCatCore[_0x334f0e(0x1fa)][_0x334f0e(0x1f6)]()[_0x334f0e(0x1f8)](_0x3dc690,_0x1cd413);}}function _0x3ce4(){const _0x303dac=['GkSYA','getImageUrl','getMsgService','scanCache','下载超时','nCoFa','getChatCacheInfo','shMPe','includes','YLdfh','图片url获取失败','getFileCacheInfo','basename','PIC','9053ihLwSv','zUCIw','indexOf','clearChatCache','DbkrN','kYImZ','private_rkey','downloadMedia','set','48mrCwTq','util','Npfdk','zvbUK','44548VkkHtv','clearCache','filePath','existsSync','fileUuid','923050RXOhiW','getStorageCleanService','1404710IPoZJU','clearChatCacheInfo','1464xzNPnU','session','5322ypRZue','clearCacheDataByKeys','29968Fviaqv','getFileType','getRkey','toUpperCase','82TvnyUf','addCacheScanedPaths','md5HexStr','unlink','CIaBj','ngQBm','getFileSize','dPeCK','uploadFile','onLoginSuccess','delete','ctIQS','copyFile','hotUpdate','sicbQ','VEMrW','getChatCacheList','addListener','ext','downloadRichMedia','fileTypeFromFile','DupNk','186ufVQcV','defaultFileDownloadPath','nCtLD','pYiiI','getHotUpdateCachePath','/download','setCacheSilentScan','108gCvzux','113416wuJqvp','getImageSize','originImageUrl','/gchatpic_new/0/0-0-'];_0x3ce4=function(){return _0x303dac;};return _0x3ce4();}