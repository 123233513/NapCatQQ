const _0x5296ff=_0x32a2;(function(_0x31a4d6,_0x4df530){const _0x1a3d25=_0x32a2,_0x4a156e=_0x31a4d6();while(!![]){try{const _0x29d5be=-parseInt(_0x1a3d25(0xfc))/0x1+-parseInt(_0x1a3d25(0xf4))/0x2*(-parseInt(_0x1a3d25(0x102))/0x3)+-parseInt(_0x1a3d25(0xfb))/0x4+-parseInt(_0x1a3d25(0xc3))/0x5+-parseInt(_0x1a3d25(0xd9))/0x6*(-parseInt(_0x1a3d25(0xe3))/0x7)+-parseInt(_0x1a3d25(0xbf))/0x8+-parseInt(_0x1a3d25(0xd5))/0x9*(-parseInt(_0x1a3d25(0xcb))/0xa);if(_0x29d5be===_0x4df530)break;else _0x4a156e['push'](_0x4a156e['shift']());}catch(_0x491d46){_0x4a156e['push'](_0x4a156e['shift']());}}}(_0x496b,0xf31a6));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x2e915c from'path';import _0x57e56d from'fs';import _0x19efc1 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';function _0x496b(){const _0x4465d6=['KFEUC','OtYrh','basename','onRichMediaDownloadComplete','join','clearCacheDataByKeys','clearCache','vJpcG','hLTXa','kBAYU','10KbvdKM','getRichMediaFilePathForGuild','YZkGN','nkKuA','getImageUrl','setCacheSilentScan','tmp','7675988KcQEBB','1520883nCrehB','lvlae','copyFile','VhRyb','defaultFileDownloadPath','getChatCacheInfo','972501mKMNUq','getFileCacheInfo','onLoginSuccess','private_rkey','getMsgService','OTzjI','9908408MCRJnL','nLYbV','msgId','addCacheScanedPaths','3083950kzgaPt','existsSync','toUpperCase','hotUpdate','getFileSize','fileUuid','LktTo','includes','4551500Llienf','getCacheSessionPathList','filePath','jNSGH','/download','downloadMedia','set','unlink','getDesktopTmpPath','scanCache','81TpEULS','IznvL','startsWith','getStorageCleanService','573786LpHmXi','getFileType','PIC','fileTypeFromFile','util','delete','getRkey','getImageSize','clearChatCacheInfo','nsKbs','42WMXvLd','addListener','clearChatCache','md5HexStr','downloadRichMedia','下载超时','session'];_0x496b=function(){return _0x4465d6;};return _0x496b();}import{calculateFileMD5}from'@/common/utils/file';import*as _0x3053e5 from'file-type';import{MsgListener}from'@/core/listeners';import _0x6a80cc from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x5296ff(0xed)]=_0x3266f7=>{const _0x3f6621=_0x5296ff;for(const [_0x570e3f,_0x4e4799]of downloadMediaTasks){_0x4e4799(_0x3266f7),downloadMediaTasks[_0x3f6621(0xde)](_0x570e3f);}},setTimeout(()=>{const _0x50ce86=_0x5296ff;napCatCore[_0x50ce86(0xbb)](()=>{const _0x257bfc=_0x50ce86;napCatCore[_0x257bfc(0xe4)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x5296ff(0xda)](_0x10b684){const _0x40e9bc=_0x5296ff;return _0x3053e5[_0x40e9bc(0xdc)](_0x10b684);}static async[_0x5296ff(0xfe)](_0x53e496,_0x2123d1){const _0x4e7577=_0x5296ff;await napCatCore[_0x4e7577(0xdd)]['copyFile'](_0x53e496,_0x2123d1);}static async[_0x5296ff(0xc7)](_0x5d811f){const _0x4dc65f=_0x5296ff;return await napCatCore['util'][_0x4dc65f(0xc7)](_0x5d811f);}static async['uploadFile'](_0x150a88,_0x5c3e46=ElementType[_0x5296ff(0xdb)],_0x32aeb9=0x0){const _0x41688d=_0x5296ff,_0x103c0f={'VhRyb':function(_0x55a939,_0x251463){return _0x55a939+_0x251463;},'DzDqz':function(_0x272be1,_0xdedf00){return _0x272be1===_0xdedf00;}},_0x5ec0d1=await calculateFileMD5(_0x150a88);let _0x5913b0=(await NTQQFileApi['getFileType'](_0x150a88))?.['ext']||'';_0x5913b0&&(_0x5913b0=_0x103c0f[_0x41688d(0xff)]('.',_0x5913b0));let _0xfec204=''+_0x2e915c[_0x41688d(0xec)](_0x150a88);_0x103c0f['DzDqz'](_0xfec204['indexOf']('.'),-0x1)&&(_0xfec204+=_0x5913b0);const _0x59bd39=napCatCore['session'][_0x41688d(0xbd)]()[_0x41688d(0xf5)]({'md5HexStr':_0x5ec0d1,'fileName':_0xfec204,'elementType':_0x5c3e46,'elementSubType':_0x32aeb9,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x41688d(0xfe)](_0x150a88,_0x59bd39);const _0x4bc496=await NTQQFileApi['getFileSize'](_0x150a88);return{'md5':_0x5ec0d1,'fileName':_0xfec204,'path':_0x59bd39,'fileSize':_0x4bc496,'ext':_0x5913b0};}static async[_0x5296ff(0xd0)](_0x1f9ac2,_0x292af6,_0x187083,_0x4f49ce,_0x1dc122,_0x3a9ec9,_0x5d3cc7=0x3e8*0x3c*0x2,_0x4f6b46=![]){const _0x15c292=_0x5296ff,_0x318a38={'vJpcG':_0x15c292(0xe8),'hLTXa':function(_0x1bfa07,_0x180cd4){return _0x1bfa07===_0x180cd4;},'lvlae':function(_0x6e21bf,_0x4e11b3){return _0x6e21bf(_0x4e11b3);},'TWHoE':function(_0x48827e){return _0x48827e();},'YZkGN':function(_0x5cd0d1,_0x4b1859,_0x45e83e){return _0x5cd0d1(_0x4b1859,_0x45e83e);}};if(_0x3a9ec9&&_0x57e56d[_0x15c292(0xc4)](_0x3a9ec9)){if(_0x4f6b46)try{await _0x19efc1[_0x15c292(0xd2)](_0x3a9ec9);}catch(_0x52e2c1){}else return _0x3a9ec9;}return new Promise((_0xd1862b,_0x21b80c)=>{const _0x12cc16=_0x15c292,_0xfeac29={'KFEUC':function(_0x432c83,_0x4da84b){const _0x42900a=_0x32a2;return _0x318a38[_0x42900a(0xf2)](_0x432c83,_0x4da84b);},'OTzjI':function(_0x368f2e,_0x539b3b){const _0x8a47e7=_0x32a2;return _0x318a38[_0x8a47e7(0xfd)](_0x368f2e,_0x539b3b);}};let _0x5399c1=![];const _0x265efb=_0x51113f=>{const _0x4e6d77=_0x32a2;if(_0xfeac29[_0x4e6d77(0xea)](_0x51113f[_0x4e6d77(0xc1)],_0x1f9ac2)){_0x5399c1=!![];let _0x2b386f=_0x51113f[_0x4e6d77(0xcd)];if(_0x2b386f[_0x4e6d77(0xd7)]('\x5c')){const _0x3346f9=sessionConfig[_0x4e6d77(0x100)];_0x2b386f=_0x2e915c[_0x4e6d77(0xee)](_0x3346f9,_0x2b386f);}_0xfeac29[_0x4e6d77(0xbe)](_0xd1862b,_0x2b386f);}};downloadMediaTasks[_0x12cc16(0xd1)](_0x318a38['TWHoE'](randomUUID),_0x265efb),_0x318a38[_0x12cc16(0xf6)](setTimeout,()=>{const _0x12f5f0=_0x12cc16;!_0x5399c1&&_0x21b80c(_0x318a38[_0x12f5f0(0xf1)]);},_0x5d3cc7),napCatCore[_0x12cc16(0xe9)][_0x12cc16(0xbd)]()[_0x12cc16(0xe7)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x1f9ac2,'chatType':_0x292af6,'peerUid':_0x187083,'elementId':_0x4f49ce,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1dc122});});}static async[_0x5296ff(0xe0)](_0x44e525){const _0x3e7384={'nsKbs':function(_0x22640d,_0x52d6a7){return _0x22640d(_0x52d6a7);},'LktTo':function(_0x440f55,_0x18ec94,_0x47e263){return _0x440f55(_0x18ec94,_0x47e263);}};return new Promise((_0x4832f9,_0x4bf112)=>{const _0x17fba5=_0x32a2;_0x3e7384[_0x17fba5(0xc9)](_0x6a80cc,_0x44e525,(_0x2d4aa9,_0x1a8b55)=>{const _0x25542c=_0x17fba5;_0x2d4aa9?_0x4bf112(_0x2d4aa9):_0x3e7384[_0x25542c(0xe2)](_0x4832f9,_0x1a8b55);});});}static async[_0x5296ff(0xf8)](_0x4ac6b1,_0x112c20){const _0x44bfa8=_0x5296ff,_0xded42b={'nkKuA':_0x44bfa8(0xcf),'kBAYU':function(_0x4157b4,_0x157d0b){return _0x4157b4+_0x157d0b;},'JZSvy':function(_0x34e3af,_0x5e75ea){return _0x34e3af+_0x5e75ea;},'OtYrh':function(_0x46c447,_0x50b43c){return _0x46c447+_0x50b43c;},'nLYbV':function(_0x370706,_0x1aa36b){return _0x370706+_0x1aa36b;},'yybkq':function(_0x511551,_0xa55743){return _0x511551||_0xa55743;},'jNSGH':function(_0xfec297,_0x14d19f,_0x839cfa){return _0xfec297(_0x14d19f,_0x839cfa);},'IznvL':'图片url获取失败'};if(!_0x4ac6b1)return'';const _0x5ba6a7=_0x4ac6b1['originImageUrl'],_0x52b038=_0x4ac6b1[_0x44bfa8(0xe6)],_0x5a91eb=_0x4ac6b1[_0x44bfa8(0xe6)],_0x37c710=_0x4ac6b1[_0x44bfa8(0xc8)];if(_0x5ba6a7){if(_0x5ba6a7['startsWith'](_0xded42b[_0x44bfa8(0xf7)])){if(_0x5ba6a7[_0x44bfa8(0xca)]('&rkey='))return _0xded42b[_0x44bfa8(0xf3)](IMAGE_HTTP_HOST_NT,_0x5ba6a7);const _0x564806=await rkeyManager[_0x44bfa8(0xdf)](),_0x3505b0=_0x112c20?_0x564806[_0x44bfa8(0xbc)]:_0x564806['group_rkey'];return _0xded42b['JZSvy'](_0xded42b[_0x44bfa8(0xeb)](IMAGE_HTTP_HOST_NT,_0x5ba6a7),''+_0x3505b0);}else return _0xded42b[_0x44bfa8(0xc0)](IMAGE_HTTP_HOST,_0x5ba6a7);}else{if(_0x5a91eb||_0x52b038)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0xded42b['yybkq'](_0x5a91eb,_0x52b038)[_0x44bfa8(0xc5)]()+'/0';}return _0xded42b[_0x44bfa8(0xce)](logDebug,_0xded42b[_0x44bfa8(0xd6)],_0x4ac6b1),'';}}function _0x32a2(_0x9be6a9,_0x586f63){const _0x496b6f=_0x496b();return _0x32a2=function(_0x32a2e4,_0x36fdde){_0x32a2e4=_0x32a2e4-0xbb;let _0x15ae52=_0x496b6f[_0x32a2e4];return _0x15ae52;},_0x32a2(_0x9be6a9,_0x586f63);}export class NTQQFileCacheApi{static async[_0x5296ff(0xf9)](_0x1f592d=!![]){return'';}static[_0x5296ff(0xcc)](){return'';}static[_0x5296ff(0xf0)](_0x236731=[_0x5296ff(0xfa),_0x5296ff(0xc6)]){const _0x2f2abe=_0x5296ff;return napCatCore[_0x2f2abe(0xe9)]['getStorageCleanService']()[_0x2f2abe(0xef)](_0x236731);}static['addCacheScannedPaths'](_0x43da65={}){const _0x3616a7=_0x5296ff;return napCatCore[_0x3616a7(0xe9)][_0x3616a7(0xd8)]()[_0x3616a7(0xc2)](_0x43da65);}static[_0x5296ff(0xd4)](){const _0x5edcb6=_0x5296ff;return napCatCore[_0x5edcb6(0xe9)][_0x5edcb6(0xd8)]()[_0x5edcb6(0xd4)]();}static['getHotUpdateCachePath'](){return'';}static[_0x5296ff(0xd3)](){return'';}static['getChatCacheList'](_0x2566e7,_0x539ea2=0x3e8,_0x1e1f77=0x0){const _0x39b1cd=_0x5296ff;return napCatCore[_0x39b1cd(0xe9)][_0x39b1cd(0xd8)]()[_0x39b1cd(0x101)](_0x2566e7,_0x539ea2,0x1,_0x1e1f77);}static[_0x5296ff(0x103)](_0x34227b,_0x4eb01c=0x3e8,_0x58c91f){const _0x4b4ce4=_0x58c91f?_0x58c91f:{'fileType':_0x34227b};}static async[_0x5296ff(0xe5)](_0x3173a4=[],_0xccf75f=[]){const _0x4ef475=_0x5296ff;return napCatCore[_0x4ef475(0xe9)][_0x4ef475(0xd8)]()[_0x4ef475(0xe1)](_0x3173a4,_0xccf75f);}}