const _0x8c558e=_0x48ab;function _0x48ab(_0x1a09a5,_0x430727){const _0x533390=_0x5333();return _0x48ab=function(_0x48abf0,_0x54426f){_0x48abf0=_0x48abf0-0x168;let _0x7af6da=_0x533390[_0x48abf0];return _0x7af6da;},_0x48ab(_0x1a09a5,_0x430727);}function _0x5333(){const _0x3f3177=['addListener','开始调用moeHook获取rkey','/gchatpic_new/0/0-0-','rkey过期或着未获取,\x20url:','basename','getMsgService','TTRFz','FsikE','获取图片rkey...','jhqJZ','wKDFg','SQVQq','util','getFileType','md5HexStr','msgId','copyFile','BLETk','getRKey','BwvVq','statusCode','473LNGywf','iAQZb','CPAbr','689460yKhrtL','now','getImageSize','sourcePath','filePath','fukoG','clearCache','picElement','图片rkey有效','euSeL','getFileSize','AsHVI',',\x20rkey:','addTask','start\x20downloadMedia','JIsAz','toUpperCase','检查rkey是否有效','getFileCacheInfo','733624QLjdVv','VQwqC','2TeoQSq','onRichMediaDownloadComplete','chatType','dCKri','scanCache','isAvailable','catch','PIC','downloadPath','CyVyh','getRichMediaFilePathForGuild','jyxFd','downloadMedia\x20complete','QeQXO','gDiGH','YAkhB','delete','Fykec','3852stlBry','getChatCacheInfo','35NkiNdj','then','clearCacheDataByKeys','lzBbo','join','onLoginSuccess','DFtKj','ISGtk','getStorageCleanService','PzewY','error','tTCMz','图片rkey有误','fileUuid','jFnyY','defaultFileDownloadPath','4115976HtUIxB','JPXcz','tkQXN','receive\x20downloadMedia\x20task','unlink','originImageUrl','hookApi\x20is\x20not\x20available','getImageUrl','xTUHF','set','MHylG','jkIyZ','Uuleo','existsSync','&rkey=','下载超时','Swjez','elements','图片rkey获取失败','3470eDbFSm','uploadFile','XNrlE','EOLHs','3717882mQNlxE','2476ygerOr','peerUid','session','downloadRichMedia','getCacheSessionPathList','DPtOo','43522VPexNN','get','fmlLw','addCacheScannedPaths','setCacheSilentScan','fileTypeFromFile','7510RDIOqE'];_0x5333=function(){return _0x3f3177;};return _0x5333();}(function(_0x389eee,_0x20a1e4){const _0x952542=_0x48ab,_0x5bb17f=_0x389eee();while(!![]){try{const _0x193b9d=-parseInt(_0x952542(0x195))/0x1*(-parseInt(_0x952542(0x1d7))/0x2)+-parseInt(_0x952542(0x1b9))/0x3+-parseInt(_0x952542(0x1d1))/0x4*(-parseInt(_0x952542(0x1dd))/0x5)+-parseInt(_0x952542(0x1d0))/0x6+-parseInt(_0x952542(0x1a9))/0x7*(parseInt(_0x952542(0x193))/0x8)+parseInt(_0x952542(0x1a7))/0x9*(-parseInt(_0x952542(0x1cc))/0xa)+-parseInt(_0x952542(0x17d))/0xb*(-parseInt(_0x952542(0x180))/0xc);if(_0x193b9d===_0x20a1e4)break;else _0x5bb17f['push'](_0x5bb17f['shift']());}catch(_0x3bd9a5){_0x5bb17f['push'](_0x5bb17f['shift']());}}}(_0x5333,0xce563));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x39c108 from'path';import _0x2cd04b from'fs';import _0x4e0d18 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x10830d from'file-type';import{MsgListener}from'@/core/listeners';import _0x5a1fbb from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0x1f6dcf from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x8c558e(0x196)]=_0x5d8266=>{const _0x33e24d=_0x8c558e,_0x9171b={'iiRsb':function(_0x4a9ea7,_0x4a9ff3){return _0x4a9ea7(_0x4a9ff3);}};for(const [_0x2c7f14,_0x5214ae]of downloadMediaTasks){_0x9171b['iiRsb'](_0x5214ae,_0x5d8266),downloadMediaTasks[_0x33e24d(0x1a5)](_0x2c7f14);}},setTimeout(()=>{const _0x4c3c2c=_0x8c558e;napCatCore[_0x4c3c2c(0x1ae)](()=>{const _0x5dd5e7=_0x4c3c2c;napCatCore[_0x5dd5e7(0x168)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x8c558e(0x175)](_0x4f4409){const _0x5b0869=_0x8c558e;return _0x10830d[_0x5b0869(0x1dc)](_0x4f4409);}static async['copyFile'](_0x25bf8b,_0x19dbe6){const _0x7f3c55=_0x8c558e;await napCatCore[_0x7f3c55(0x174)][_0x7f3c55(0x178)](_0x25bf8b,_0x19dbe6);}static async['getFileSize'](_0x1d9a58){const _0x19fd0e=_0x8c558e;return await napCatCore['util'][_0x19fd0e(0x18a)](_0x1d9a58);}static async[_0x8c558e(0x1cd)](_0x42cdef,_0x514ab1=ElementType[_0x8c558e(0x19c)],_0x252770=0x0){const _0x5cebac=_0x8c558e,_0x3a1ed6={'tkQXN':function(_0xbda7e1,_0x3605a9){return _0xbda7e1(_0x3605a9);},'BwvVq':function(_0x58b616,_0x19be07){return _0x58b616===_0x19be07;}},_0x1c3724=await _0x3a1ed6[_0x5cebac(0x1bb)](calculateFileMD5,_0x42cdef);let _0x1ff65e=(await NTQQFileApi['getFileType'](_0x42cdef))?.['ext']||'';_0x1ff65e&&(_0x1ff65e='.'+_0x1ff65e);let _0x2f985b=''+_0x39c108[_0x5cebac(0x16c)](_0x42cdef);_0x3a1ed6[_0x5cebac(0x17b)](_0x2f985b['indexOf']('.'),-0x1)&&(_0x2f985b+=_0x1ff65e);const _0x2b661a=napCatCore[_0x5cebac(0x1d3)]['getMsgService']()[_0x5cebac(0x19f)]({'md5HexStr':_0x1c3724,'fileName':_0x2f985b,'elementType':_0x514ab1,'elementSubType':_0x252770,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x5cebac(0x178)](_0x42cdef,_0x2b661a);const _0x337177=await NTQQFileApi[_0x5cebac(0x18a)](_0x42cdef);return{'md5':_0x1c3724,'fileName':_0x2f985b,'path':_0x2b661a,'fileSize':_0x337177,'ext':_0x1ff65e};}static async['downloadMedia'](_0x4ad0c7,_0x2bea1d,_0xbb271e,_0x1190ee,_0x339937,_0x155917,_0x188d40=0x3e8*0x3c*0x2,_0x44de27=![]){const _0x5335dd=_0x8c558e,_0x4dc4b9={'wKDFg':_0x5335dd(0x1a1),'CPAbr':function(_0x16a63b,_0x3991db){return _0x16a63b===_0x3991db;},'SQVQq':function(_0x5041aa,_0x25cab3,_0x4ce105){return _0x5041aa(_0x25cab3,_0x4ce105);},'VQwqC':_0x5335dd(0x19d),'jhqJZ':function(_0x423306){return _0x423306();},'DFtKj':function(_0x1d275b,_0x2ffb31,_0x3e7899,_0x10fb6c,_0x4ecbf3,_0x5dd21b,_0x1fef61,_0x4401a3,_0xce20a9,_0x586538){return _0x1d275b(_0x2ffb31,_0x3e7899,_0x10fb6c,_0x4ecbf3,_0x5dd21b,_0x1fef61,_0x4401a3,_0xce20a9,_0x586538);}};_0x4dc4b9[_0x5335dd(0x1af)](logDebug,_0x5335dd(0x1bc),_0x4ad0c7,_0x2bea1d,_0xbb271e,_0x1190ee,_0x339937,_0x155917,_0x188d40,_0x44de27);if(_0x155917&&_0x2cd04b[_0x5335dd(0x1c6)](_0x155917)){if(_0x44de27)try{await _0x4e0d18[_0x5335dd(0x1bd)](_0x155917);}catch(_0x456c38){}else return _0x155917;}return logDebug(_0x5335dd(0x18e),_0x4ad0c7,_0x2bea1d,_0xbb271e,_0x1190ee,_0x339937,_0x155917,_0x188d40,_0x44de27),new Promise((_0x131619,_0x2eb7a3)=>{const _0x5b7956=_0x5335dd,_0x4d426a={'BLETk':function(_0x2757d0,_0x2c3e8a,_0x3a159c,_0x3f03b6){return _0x2757d0(_0x2c3e8a,_0x3a159c,_0x3f03b6);},'JIsAz':_0x4dc4b9[_0x5b7956(0x172)],'gDiGH':function(_0x28c087,_0x434fc1){const _0x426f94=_0x5b7956;return _0x4dc4b9[_0x426f94(0x17f)](_0x28c087,_0x434fc1);},'oilBF':function(_0x32812c,_0x3a7502,_0x4936d8){const _0x4bcf40=_0x5b7956;return _0x4dc4b9[_0x4bcf40(0x173)](_0x32812c,_0x3a7502,_0x4936d8);},'DPtOo':_0x4dc4b9[_0x5b7956(0x194)],'TTRFz':function(_0x5cc10d,_0x4324fd){return _0x5cc10d(_0x4324fd);},'EOLHs':_0x5b7956(0x1c8)};let _0x415ff8=![];const _0x505aae=_0x50c4ad=>{const _0x75fa8f=_0x5b7956;_0x4d426a[_0x75fa8f(0x179)](logDebug,_0x4d426a[_0x75fa8f(0x18f)],_0x50c4ad,_0x4ad0c7);if(_0x4d426a[_0x75fa8f(0x1a3)](_0x50c4ad[_0x75fa8f(0x177)],_0x4ad0c7)){_0x415ff8=!![];let _0x24b4e8=_0x50c4ad[_0x75fa8f(0x184)];if(_0x24b4e8['startsWith']('\x5c')){const _0x5369d0=sessionConfig[_0x75fa8f(0x1b8)];_0x4d426a['oilBF'](logDebug,_0x4d426a[_0x75fa8f(0x1d6)],_0x5369d0),_0x24b4e8=_0x39c108[_0x75fa8f(0x1ad)](_0x5369d0,_0x24b4e8);}_0x4d426a['TTRFz'](_0x131619,_0x24b4e8);}};downloadMediaTasks[_0x5b7956(0x1c2)](_0x4dc4b9[_0x5b7956(0x171)](randomUUID),_0x505aae),_0x4dc4b9['SQVQq'](setTimeout,()=>{const _0x5553d3=_0x5b7956;!_0x415ff8&&_0x4d426a[_0x5553d3(0x16e)](_0x2eb7a3,_0x4d426a[_0x5553d3(0x1cf)]);},_0x188d40),napCatCore['session'][_0x5b7956(0x16d)]()[_0x5b7956(0x1d4)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x4ad0c7,'chatType':_0x2bea1d,'peerUid':_0xbb271e,'elementId':_0x1190ee,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x339937});});}static async[_0x8c558e(0x182)](_0x9d23e3){const _0x53eef6={'JPXcz':function(_0x2b8f4a,_0x16beee){return _0x2b8f4a(_0x16beee);},'jyxFd':function(_0x3e870b,_0x3bcf59,_0x270b28){return _0x3e870b(_0x3bcf59,_0x270b28);}};return new Promise((_0x128d7c,_0x1227fd)=>{const _0x160710=_0x48ab;_0x53eef6[_0x160710(0x1a0)](_0x5a1fbb,_0x9d23e3,(_0x3e12fb,_0x167183)=>{const _0x539102=_0x160710;_0x3e12fb?_0x53eef6[_0x539102(0x1ba)](_0x1227fd,_0x3e12fb):_0x53eef6['JPXcz'](_0x128d7c,_0x167183);});});}static async[_0x8c558e(0x1c0)](_0x7fb70a){const _0xbbb78a=_0x8c558e,_0x282ecc={'jkIyZ':function(_0x2c8e4b,_0x3194cb){return _0x2c8e4b(_0x3194cb);},'Uuleo':_0xbbb78a(0x1cb),'fmlLw':_0xbbb78a(0x170),'SBlmq':function(_0x36eb99,_0x5f05a0){return _0x36eb99*_0x5f05a0;},'AsHVI':function(_0x1b615f,_0x5d78f3){return _0x1b615f(_0x5d78f3);},'jFnyY':function(_0x4759c0,_0x5d4630){return _0x4759c0+_0x5d4630;},'Swjez':function(_0x44d6a0,_0xb16146,_0x1d0bd6){return _0x44d6a0(_0xb16146,_0x1d0bd6);},'ISGtk':_0xbbb78a(0x191),'fukoG':function(_0x1d9c06,_0x2ac551,_0xbb5375){return _0x1d9c06(_0x2ac551,_0xbb5375);},'dCKri':function(_0x3fee7b,_0x8a3f6f,_0x2ae486,_0x3179ad){return _0x3fee7b(_0x8a3f6f,_0x2ae486,_0x3179ad);},'MHylG':_0xbbb78a(0x1b5),'NBtnn':function(_0x2d08af){return _0x2d08af();},'lzBbo':function(_0x49c08b,_0x364325){return _0x49c08b(_0x364325);},'iAQZb':function(_0x1510e6,_0x16865e){return _0x1510e6!==_0x16865e;},'xTUHF':'/download','tTCMz':_0xbbb78a(0x1c7),'CyVyh':_0xbbb78a(0x1bf),'QeQXO':function(_0x3fe721,_0x5f3864){return _0x3fe721>_0x5f3864;},'PzewY':function(_0x3175db,_0xa185cc){return _0x3175db-_0xa185cc;},'FsikE':function(_0x25b60e){return _0x25b60e();},'XNrlE':function(_0x48846a,_0x20572d){return _0x48846a+_0x20572d;},'aenSN':function(_0x3c6920,_0xdba623){return _0x3c6920+_0xdba623;},'Fykec':function(_0x3c71bf,_0x1b8dfd){return _0x3c71bf||_0x1b8dfd;}},_0x1ae9ab=_0x282ecc[_0xbbb78a(0x17e)](_0x7fb70a[_0xbbb78a(0x197)],ChatType['group']),_0x1bb6bb=_0x7fb70a[_0xbbb78a(0x1ca)]['find'](_0x603fcb=>!!_0x603fcb[_0xbbb78a(0x187)]);if(!_0x1bb6bb)return'';const _0x445aff=_0x1bb6bb[_0xbbb78a(0x187)][_0xbbb78a(0x1be)],_0x161fd2=_0x1bb6bb[_0xbbb78a(0x187)][_0xbbb78a(0x176)],_0x466215=_0x1bb6bb['picElement'][_0xbbb78a(0x176)],_0x45472c=_0x1bb6bb[_0xbbb78a(0x187)][_0xbbb78a(0x1b6)],_0x3a2af2=_0x43b360=>{const _0x19b861=_0xbbb78a;_0x1ae9ab?(privateImageRKey=_0x43b360,lastGetPrivateRKeyTime=Date[_0x19b861(0x181)]()):(groupImageRKey=_0x43b360,lastGetGroupRKeyTime=Date[_0x19b861(0x181)]());};if(_0x445aff){if(_0x445aff['startsWith'](_0x282ecc[_0xbbb78a(0x1c1)])){if(_0x445aff['includes'](_0x282ecc[_0xbbb78a(0x1b4)]))return IMAGE_HTTP_HOST_NT+_0x445aff;if(!hookApi[_0xbbb78a(0x19a)]())return _0x282ecc['AsHVI'](logDebug,_0x282ecc[_0xbbb78a(0x19e)]),'';const _0x420a50=async()=>{const _0x447561=_0xbbb78a;_0x282ecc[_0x447561(0x1c4)](logDebug,_0x282ecc[_0x447561(0x1d9)]),NTQQFileApi['downloadMedia'](_0x7fb70a['msgId'],_0x7fb70a[_0x447561(0x197)],_0x7fb70a[_0x447561(0x1d2)],_0x1bb6bb['elementId'],'',_0x1bb6bb['picElement'][_0x447561(0x183)],_0x282ecc['SBlmq'](0x3e8,0x1e),!![])[_0x447561(0x1aa)](_0x8827ca=>{})[_0x447561(0x19b)](logError),await _0x282ecc[_0x447561(0x1c4)](sleep,0x3e8),_0x282ecc[_0x447561(0x18b)](logDebug,_0x447561(0x169));const _0x2861a8=hookApi[_0x447561(0x17a)]()||'',_0x364489=_0x282ecc['jFnyY'](IMAGE_HTTP_HOST_NT,_0x445aff)+_0x2861a8;if(_0x2861a8)try{_0x282ecc[_0x447561(0x1c9)](logDebug,_0x282ecc[_0x447561(0x1b0)],_0x364489),await new Promise((_0x1298a1,_0x5b549c)=>{const _0x5096b1=_0x447561,_0x5f12d7={'YAkhB':function(_0x35a102,_0x8e6b5c){const _0x2d6c8c=_0x48ab;return _0x282ecc[_0x2d6c8c(0x1c4)](_0x35a102,_0x8e6b5c);},'euSeL':_0x282ecc[_0x5096b1(0x1c5)]};_0x1f6dcf[_0x5096b1(0x1d8)](_0x364489,_0x48218c=>{const _0x1f5ec0=_0x5096b1;_0x48218c[_0x1f5ec0(0x17c)]!==0xc8?_0x5f12d7[_0x1f5ec0(0x1a4)](_0x5b549c,_0x5f12d7[_0x1f5ec0(0x189)]):_0x1298a1(_0x48218c);})['on'](_0x5096b1(0x1b3),_0x4a537d=>{const _0x304af9=_0x5096b1;_0x5f12d7[_0x304af9(0x1a4)](_0x5b549c,_0x4a537d);});}),_0x282ecc[_0x447561(0x185)](logDebug,_0x447561(0x188),_0x364489),_0x282ecc[_0x447561(0x1c4)](_0x3a2af2,_0x2861a8);}catch(_0x2a04f8){return _0x282ecc[_0x447561(0x198)](logError,_0x282ecc[_0x447561(0x1c3)],_0x364489,_0x2a04f8),'';}return _0x2861a8;},_0xcd6bea=()=>new Promise((_0x5b6d91,_0x522604)=>{const _0xad33b5=_0xbbb78a;getRKeyTaskQueue[_0xad33b5(0x18d)](async()=>{const _0x425c1c=_0xad33b5,_0x25b1ff=await _0x282ecc['NBtnn'](_0x420a50);_0x282ecc[_0x425c1c(0x1ac)](_0x5b6d91,_0x25b1ff);});}),_0x57293b=_0x1ae9ab?privateImageRKey:groupImageRKey,_0x48dbb5=_0x1ae9ab?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x282ecc[_0xbbb78a(0x1a2)](_0x282ecc[_0xbbb78a(0x1b2)](Date[_0xbbb78a(0x181)](),_0x48dbb5),rkeyExpireTime)||!_0x57293b){_0x282ecc[_0xbbb78a(0x1c4)](logDebug,_0xbbb78a(0x16b)+_0x445aff+_0xbbb78a(0x18c)+_0x57293b);const _0x3d2de4=await _0x282ecc[_0xbbb78a(0x16f)](_0xcd6bea);if(_0x3d2de4)return _0x282ecc[_0xbbb78a(0x1ce)](IMAGE_HTTP_HOST_NT,_0x445aff)+(''+_0x3d2de4);else _0x282ecc[_0xbbb78a(0x185)](logError,_0x282ecc[_0xbbb78a(0x1c5)],_0x445aff);}if(_0x57293b)return _0x282ecc['jFnyY'](_0x282ecc[_0xbbb78a(0x1b7)](IMAGE_HTTP_HOST_NT,_0x445aff),''+_0x57293b);return'';}else return _0x282ecc['aenSN'](IMAGE_HTTP_HOST,_0x445aff);}else{if(_0x282ecc[_0xbbb78a(0x1a6)](_0x466215,_0x161fd2))return IMAGE_HTTP_HOST+_0xbbb78a(0x16a)+_0x282ecc[_0xbbb78a(0x1a6)](_0x466215,_0x161fd2)[_0xbbb78a(0x190)]()+'/0';}return _0x282ecc[_0xbbb78a(0x1c9)](logDebug,'图片url获取失败',_0x7fb70a),'';}}export class NTQQFileCacheApi{static async[_0x8c558e(0x1db)](_0x1dcc17=!![]){return'';}static[_0x8c558e(0x1d5)](){return'';}static[_0x8c558e(0x186)](_0xed05e4=['tmp','hotUpdate']){const _0x36b948=_0x8c558e;return napCatCore['session'][_0x36b948(0x1b1)]()[_0x36b948(0x1ab)](_0xed05e4);}static[_0x8c558e(0x1da)](_0xe130c7={}){const _0x142e19=_0x8c558e;return napCatCore[_0x142e19(0x1d3)][_0x142e19(0x1b1)]()['addCacheScanedPaths'](_0xe130c7);}static[_0x8c558e(0x199)](){const _0x21618f=_0x8c558e;return napCatCore[_0x21618f(0x1d3)]['getStorageCleanService']()[_0x21618f(0x199)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static['getChatCacheList'](_0x2e7a15,_0x228451=0x3e8,_0x598aa9=0x0){const _0x113c01=_0x8c558e;return napCatCore[_0x113c01(0x1d3)]['getStorageCleanService']()[_0x113c01(0x1a8)](_0x2e7a15,_0x228451,0x1,_0x598aa9);}static[_0x8c558e(0x192)](_0x3907ff,_0x47f94c=0x3e8,_0x1ba187){const _0x188205=_0x1ba187?_0x1ba187:{'fileType':_0x3907ff};}static async['clearChatCache'](_0x5b9371=[],_0x4772d4=[]){return napCatCore['session']['getStorageCleanService']()['clearChatCacheInfo'](_0x5b9371,_0x4772d4);}}