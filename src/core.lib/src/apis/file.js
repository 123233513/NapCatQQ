const _0x255482=_0x5cf8;(function(_0xe3d568,_0x5e60bc){const _0x5b78b7=_0x5cf8,_0x222530=_0xe3d568();while(!![]){try{const _0x1cfc50=parseInt(_0x5b78b7(0x1cc))/0x1*(parseInt(_0x5b78b7(0x1ba))/0x2)+-parseInt(_0x5b78b7(0x197))/0x3*(parseInt(_0x5b78b7(0x19b))/0x4)+parseInt(_0x5b78b7(0x1bc))/0x5+-parseInt(_0x5b78b7(0x1a1))/0x6+-parseInt(_0x5b78b7(0x1a0))/0x7*(-parseInt(_0x5b78b7(0x18d))/0x8)+parseInt(_0x5b78b7(0x1af))/0x9+parseInt(_0x5b78b7(0x1ce))/0xa*(-parseInt(_0x5b78b7(0x1be))/0xb);if(_0x1cfc50===_0x5e60bc)break;else _0x222530['push'](_0x222530['shift']());}catch(_0x49d012){_0x222530['push'](_0x222530['shift']());}}}(_0x526d,0x23e9c));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x130807 from'path';import _0x34b53d from'fs';function _0x526d(){const _0x3d2f35=['715500RqYgoC','getChatCacheInfo','getImageSize','originImageUrl','private_rkey','downloadMedia\x20complete','EEshK','getStorageCleanService','图片url获取失败','fileUuid','existsSync','addCacheScanedPaths','下载超时','downloadRichMedia','1050003hvzuNe','bnPxE','filePath','setCacheSilentScan','unlink','bjTmZ','scanCache','includes','eGbFs','hotUpdate','FGlcu','371974WpAKJQ','Oxgtf','1375285tUzPri','/download','3806usjOGq','tmp','receive\x20downloadMedia\x20task','addCacheScannedPaths','session','downloadMedia','util','startsWith','pXMUW','join','qImDn','indexOf','getFileType','ext','1NBrlft','copyFile','15650SFdXXU','msgId','ZUKVM','getRichMediaFilePathForGuild','getMsgService','RZwDA','md5HexStr','YXXSq','clearChatCacheInfo','KuhyO','423680crEGWb','fileTypeFromFile','clearCache','toUpperCase','getRkey','getCacheSessionPathList','onRichMediaDownloadComplete','getFileSize','keSUj','onLoginSuccess','14859YKfnJU','oZAEk','clearCacheDataByKeys','uploadFile','28cfOIso','/gchatpic_new/0/0-0-','group_rkey','getChatCacheList','start\x20downloadMedia','35PZonCw'];_0x526d=function(){return _0x3d2f35;};return _0x526d();}import _0x5aedef from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x53c751 from'file-type';import{MsgListener}from'@/core/listeners';import _0x372d7a from'image-size';function _0x5cf8(_0x589414,_0x1e774){const _0x526d2f=_0x526d();return _0x5cf8=function(_0x5cf8d3,_0x346dac){_0x5cf8d3=_0x5cf8d3-0x189;let _0x4b663e=_0x526d2f[_0x5cf8d3];return _0x4b663e;},_0x5cf8(_0x589414,_0x1e774);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x255482(0x193)]=_0x228817=>{const _0x198305=_0x255482,_0x15d430={'oZAEk':function(_0x6a4a5e,_0x29751d){return _0x6a4a5e(_0x29751d);}};for(const [_0x17c28d,_0xf1bbda]of downloadMediaTasks){_0x15d430[_0x198305(0x198)](_0xf1bbda,_0x228817),downloadMediaTasks['delete'](_0x17c28d);}},setTimeout(()=>{const _0x21ff73=_0x255482;napCatCore[_0x21ff73(0x196)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x255482(0x1ca)](_0x56f9f8){const _0x2ee46e=_0x255482;return _0x53c751[_0x2ee46e(0x18e)](_0x56f9f8);}static async[_0x255482(0x1cd)](_0x58d88b,_0x2b4afb){const _0xed0ac5=_0x255482;await napCatCore['util'][_0xed0ac5(0x1cd)](_0x58d88b,_0x2b4afb);}static async['getFileSize'](_0x4f4167){const _0x1df051=_0x255482;return await napCatCore[_0x1df051(0x1c4)][_0x1df051(0x194)](_0x4f4167);}static async[_0x255482(0x19a)](_0x3b4ecc,_0x37a2c3=ElementType['PIC'],_0x3d1e66=0x0){const _0x3ecd66=_0x255482,_0xbaad0b={'KuhyO':function(_0x5e5b4e,_0x4bdde2){return _0x5e5b4e(_0x4bdde2);},'YXXSq':function(_0x58ed1a,_0x104d70){return _0x58ed1a===_0x104d70;}},_0x29b4c6=await _0xbaad0b[_0x3ecd66(0x18c)](calculateFileMD5,_0x3b4ecc);let _0x24d4ab=(await NTQQFileApi['getFileType'](_0x3b4ecc))?.[_0x3ecd66(0x1cb)]||'';_0x24d4ab&&(_0x24d4ab='.'+_0x24d4ab);let _0x1feb28=''+_0x130807['basename'](_0x3b4ecc);_0xbaad0b[_0x3ecd66(0x18a)](_0x1feb28[_0x3ecd66(0x1c9)]('.'),-0x1)&&(_0x1feb28+=_0x24d4ab);const _0x4a2a70=napCatCore[_0x3ecd66(0x1c2)][_0x3ecd66(0x1d2)]()[_0x3ecd66(0x1d1)]({'md5HexStr':_0x29b4c6,'fileName':_0x1feb28,'elementType':_0x37a2c3,'elementSubType':_0x3d1e66,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x3ecd66(0x1cd)](_0x3b4ecc,_0x4a2a70);const _0x44d243=await NTQQFileApi[_0x3ecd66(0x194)](_0x3b4ecc);return{'md5':_0x29b4c6,'fileName':_0x1feb28,'path':_0x4a2a70,'fileSize':_0x44d243,'ext':_0x24d4ab};}static async[_0x255482(0x1c3)](_0x2aa868,_0x566dc6,_0x47f6f0,_0x909994,_0x7935a5,_0x5db3e7,_0x2c3f07=0x3e8*0x3c*0x2,_0x51cb5a=![]){const _0x3edcf8=_0x255482,_0x354206={'RZwDA':function(_0x1f412d,_0x33956f,_0x1b04ea,_0x34cc48){return _0x1f412d(_0x33956f,_0x1b04ea,_0x34cc48);},'Oxgtf':_0x3edcf8(0x1a6),'EEshK':'downloadPath','tGTLE':function(_0x3f9088,_0x3bf960){return _0x3f9088(_0x3bf960);},'FGlcu':_0x3edcf8(0x1ad),'OdjBG':function(_0x122dd2,_0x2f01c1,_0x58da5f){return _0x122dd2(_0x2f01c1,_0x58da5f);},'vjRRv':function(_0x1b1928,_0x4310c5,_0x4a0f91,_0x525dd3,_0x7f4f29,_0x1ec498,_0x282b68,_0xb58a75,_0x126b37,_0x760907){return _0x1b1928(_0x4310c5,_0x4a0f91,_0x525dd3,_0x7f4f29,_0x1ec498,_0x282b68,_0xb58a75,_0x126b37,_0x760907);},'TVfIX':_0x3edcf8(0x1c0),'qImDn':function(_0x4ae9c5,_0x24c33c,_0x2d438f,_0x317f67,_0x483812,_0x2b4bec,_0x285769,_0x13d30f,_0x2e468c,_0x3685e2){return _0x4ae9c5(_0x24c33c,_0x2d438f,_0x317f67,_0x483812,_0x2b4bec,_0x285769,_0x13d30f,_0x2e468c,_0x3685e2);}};_0x354206['vjRRv'](logDebug,_0x354206['TVfIX'],_0x2aa868,_0x566dc6,_0x47f6f0,_0x909994,_0x7935a5,_0x5db3e7,_0x2c3f07,_0x51cb5a);if(_0x5db3e7&&_0x34b53d[_0x3edcf8(0x1ab)](_0x5db3e7)){if(_0x51cb5a)try{await _0x5aedef[_0x3edcf8(0x1b3)](_0x5db3e7);}catch(_0x202334){}else return _0x5db3e7;}return _0x354206[_0x3edcf8(0x1c8)](logDebug,_0x3edcf8(0x19f),_0x2aa868,_0x566dc6,_0x47f6f0,_0x909994,_0x7935a5,_0x5db3e7,_0x2c3f07,_0x51cb5a),new Promise((_0x377a0d,_0x1cf5c7)=>{const _0x387a8b=_0x3edcf8,_0x235214={'bnPxE':function(_0x2d855d,_0x5e1a95){return _0x354206['tGTLE'](_0x2d855d,_0x5e1a95);},'snuEj':_0x354206[_0x387a8b(0x1b9)]};let _0x1ad272=![];const _0x34dce4=_0x22d04a=>{const _0xd57856=_0x387a8b;_0x354206[_0xd57856(0x1d3)](logDebug,_0x354206[_0xd57856(0x1bb)],_0x22d04a,_0x2aa868);if(_0x22d04a[_0xd57856(0x1cf)]===_0x2aa868){_0x1ad272=!![];let _0x2bc743=_0x22d04a[_0xd57856(0x1b1)];if(_0x2bc743['startsWith']('\x5c')){const _0x419dff=sessionConfig['defaultFileDownloadPath'];logDebug(_0x354206[_0xd57856(0x1a7)],_0x419dff),_0x2bc743=_0x130807[_0xd57856(0x1c7)](_0x419dff,_0x2bc743);}_0x377a0d(_0x2bc743);}};downloadMediaTasks['set'](randomUUID(),_0x34dce4),_0x354206['OdjBG'](setTimeout,()=>{const _0x2624af=_0x387a8b;!_0x1ad272&&_0x235214[_0x2624af(0x1b0)](_0x1cf5c7,_0x235214['snuEj']);},_0x2c3f07),napCatCore[_0x387a8b(0x1c2)][_0x387a8b(0x1d2)]()[_0x387a8b(0x1ae)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x2aa868,'chatType':_0x566dc6,'peerUid':_0x47f6f0,'elementId':_0x909994,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x7935a5});});}static async[_0x255482(0x1a3)](_0x4be2fb){const _0x4d78e1={'keSUj':function(_0x53322a,_0x3f583a,_0x45ea25){return _0x53322a(_0x3f583a,_0x45ea25);}};return new Promise((_0x37734c,_0x128264)=>{const _0x54d302=_0x5cf8,_0x28a24d={'pXMUW':function(_0x28ab40,_0x289683){return _0x28ab40(_0x289683);}};_0x4d78e1[_0x54d302(0x195)](_0x372d7a,_0x4be2fb,(_0x1be2e3,_0x433228)=>{const _0x42e3b5=_0x54d302;_0x1be2e3?_0x128264(_0x1be2e3):_0x28a24d[_0x42e3b5(0x1c6)](_0x37734c,_0x433228);});});}static async['getImageUrl'](_0x5e8803,_0x17ac0a){const _0x4176e0=_0x255482,_0x1f9a03={'mGizu':_0x4176e0(0x1bd),'eGbFs':'&rkey=','bjTmZ':function(_0x2ed4ef,_0x120327){return _0x2ed4ef+_0x120327;},'ZUKVM':function(_0x48c2d2,_0x4a7534){return _0x48c2d2||_0x4a7534;},'THdik':function(_0x7bbfbc,_0x297ed9,_0x5eef20){return _0x7bbfbc(_0x297ed9,_0x5eef20);},'TbTVk':_0x4176e0(0x1a9)};if(!_0x5e8803)return'';const _0x1f4731=_0x5e8803[_0x4176e0(0x1a4)],_0x221a12=_0x5e8803[_0x4176e0(0x189)],_0x99e209=_0x5e8803['md5HexStr'],_0x506945=_0x5e8803[_0x4176e0(0x1aa)];if(_0x1f4731){if(_0x1f4731[_0x4176e0(0x1c5)](_0x1f9a03['mGizu'])){if(_0x1f4731[_0x4176e0(0x1b6)](_0x1f9a03[_0x4176e0(0x1b7)]))return _0x1f9a03['bjTmZ'](IMAGE_HTTP_HOST_NT,_0x1f4731);const _0x33e366=await rkeyManager[_0x4176e0(0x191)](),_0x55fcf0=_0x17ac0a?_0x33e366[_0x4176e0(0x1a5)]:_0x33e366[_0x4176e0(0x19d)];return _0x1f9a03[_0x4176e0(0x1b4)](IMAGE_HTTP_HOST_NT,_0x1f4731)+(''+_0x55fcf0);}else return _0x1f9a03[_0x4176e0(0x1b4)](IMAGE_HTTP_HOST,_0x1f4731);}else{if(_0x1f9a03[_0x4176e0(0x1d0)](_0x99e209,_0x221a12))return IMAGE_HTTP_HOST+_0x4176e0(0x19c)+_0x1f9a03[_0x4176e0(0x1d0)](_0x99e209,_0x221a12)[_0x4176e0(0x190)]()+'/0';}return _0x1f9a03['THdik'](logDebug,_0x1f9a03['TbTVk'],_0x5e8803),'';}}export class NTQQFileCacheApi{static async[_0x255482(0x1b2)](_0x32b8d2=!![]){return'';}static[_0x255482(0x192)](){return'';}static[_0x255482(0x18f)](_0x2fcf02=[_0x255482(0x1bf),_0x255482(0x1b8)]){const _0xe64061=_0x255482;return napCatCore[_0xe64061(0x1c2)][_0xe64061(0x1a8)]()[_0xe64061(0x199)](_0x2fcf02);}static[_0x255482(0x1c1)](_0x2dddbb={}){const _0x165a10=_0x255482;return napCatCore[_0x165a10(0x1c2)][_0x165a10(0x1a8)]()[_0x165a10(0x1ac)](_0x2dddbb);}static['scanCache'](){const _0x3677a1=_0x255482;return napCatCore[_0x3677a1(0x1c2)][_0x3677a1(0x1a8)]()[_0x3677a1(0x1b5)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x255482(0x19e)](_0x22c68a,_0x3a191d=0x3e8,_0x5f220d=0x0){const _0x148f12=_0x255482;return napCatCore[_0x148f12(0x1c2)][_0x148f12(0x1a8)]()[_0x148f12(0x1a2)](_0x22c68a,_0x3a191d,0x1,_0x5f220d);}static['getFileCacheInfo'](_0x22b367,_0x3e185c=0x3e8,_0x25f713){const _0xded256=_0x25f713?_0x25f713:{'fileType':_0x22b367};}static async['clearChatCache'](_0x12f5b9=[],_0x2975e7=[]){const _0x3b8d03=_0x255482;return napCatCore[_0x3b8d03(0x1c2)][_0x3b8d03(0x1a8)]()[_0x3b8d03(0x18b)](_0x12f5b9,_0x2975e7);}}