const _0x10d0a2=_0x2160;(function(_0x52efba,_0x15d809){const _0x2fc501=_0x2160,_0x36b5ce=_0x52efba();while(!![]){try{const _0x3c0aef=-parseInt(_0x2fc501(0xe8))/0x1*(parseInt(_0x2fc501(0xdb))/0x2)+parseInt(_0x2fc501(0xd5))/0x3+-parseInt(_0x2fc501(0xb0))/0x4+parseInt(_0x2fc501(0xaa))/0x5*(-parseInt(_0x2fc501(0xa9))/0x6)+parseInt(_0x2fc501(0xca))/0x7*(-parseInt(_0x2fc501(0xbd))/0x8)+-parseInt(_0x2fc501(0xde))/0x9+parseInt(_0x2fc501(0xc4))/0xa*(parseInt(_0x2fc501(0xc3))/0xb);if(_0x3c0aef===_0x15d809)break;else _0x36b5ce['push'](_0x36b5ce['shift']());}catch(_0x5d9fcf){_0x36b5ce['push'](_0x36b5ce['shift']());}}}(_0x4884,0x6d61a));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x30ca5b from'path';import _0x401046 from'fs';import _0x33599c from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x315668 from'file-type';import{MsgListener}from'@/core/listeners';import _0xa23eea from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x2160(_0x41fa7f,_0x2b7794){const _0x4884d1=_0x4884();return _0x2160=function(_0x216081,_0x235986){_0x216081=_0x216081-0xa9;let _0x47fde4=_0x4884d1[_0x216081];return _0x47fde4;},_0x2160(_0x41fa7f,_0x2b7794);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x4884(){const _0x238fa0=['addListener','LrIqK','setCacheSilentScan','67698wNdMBR','340BbEGJO','UAyep','clearCache','HobHr','getHotUpdateCachePath','getImageSize','2457608SIGVPj','fileUuid','addCacheScanedPaths','defaultFileDownloadPath','ext','aOMbV','uMrsN','filePath','toUpperCase','YLvEq','SOFUS','getFileSize','fileTypeFromFile','8GujZDy','group_rkey','getChatCacheInfo','existsSync','md5HexStr','msgId','33935pEjguN','7710ZdjwZI','UfOpA','onRichMediaDownloadComplete','includes','startsWith','下载超时','1401337amRfxp','&rkey=','downloadRichMedia','getFileType','lHAGH','/download','downloadMedia','/gchatpic_new/0/0-0-','originImageUrl','copyFile','scanCache','430179vdTEpm','onLoginSuccess','cywqk','PIC','getImageUrl','addCacheScannedPaths','71102wyNstT','getRkey','session','269118AumBiq','getMsgService','clearChatCache','basename','private_rkey','util','indexOf','PrQzJ','getRichMediaFilePathForGuild','clearCacheDataByKeys','13GQejcR','olZzK','getStorageCleanService','图片url获取失败','unlink'];_0x4884=function(){return _0x238fa0;};return _0x4884();}const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x10d0a2(0xc6)]=_0x45e171=>{for(const [_0x53939e,_0x55f9bb]of downloadMediaTasks){_0x55f9bb(_0x45e171),downloadMediaTasks['delete'](_0x53939e);}},setTimeout(()=>{const _0x5b27d2=_0x10d0a2;napCatCore[_0x5b27d2(0xd6)](()=>{const _0x173528=_0x5b27d2;napCatCore[_0x173528(0xed)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x10d0a2(0xcd)](_0x4227c2){const _0x320f6a=_0x10d0a2;return _0x315668[_0x320f6a(0xbc)](_0x4227c2);}static async[_0x10d0a2(0xd3)](_0x3d1330,_0x48d95a){const _0x2ac8a8=_0x10d0a2;await napCatCore[_0x2ac8a8(0xe3)][_0x2ac8a8(0xd3)](_0x3d1330,_0x48d95a);}static async[_0x10d0a2(0xbb)](_0x359336){const _0x5e64b9=_0x10d0a2;return await napCatCore[_0x5e64b9(0xe3)][_0x5e64b9(0xbb)](_0x359336);}static async['uploadFile'](_0x2ca777,_0x14d6bc=ElementType[_0x10d0a2(0xd8)],_0x13d62d=0x0){const _0x3b826d=_0x10d0a2,_0x47f17e={'YLvEq':function(_0x5c95dc,_0x165487){return _0x5c95dc(_0x165487);},'SOFUS':function(_0x1cd79e,_0x2009f4){return _0x1cd79e+_0x2009f4;}},_0x4a5676=await _0x47f17e[_0x3b826d(0xb9)](calculateFileMD5,_0x2ca777);let _0x5bad74=(await NTQQFileApi[_0x3b826d(0xcd)](_0x2ca777))?.[_0x3b826d(0xb4)]||'';_0x5bad74&&(_0x5bad74=_0x47f17e[_0x3b826d(0xba)]('.',_0x5bad74));let _0x1463c5=''+_0x30ca5b[_0x3b826d(0xe1)](_0x2ca777);_0x1463c5[_0x3b826d(0xe4)]('.')===-0x1&&(_0x1463c5+=_0x5bad74);const _0x53ef7e=napCatCore['session'][_0x3b826d(0xdf)]()[_0x3b826d(0xe6)]({'md5HexStr':_0x4a5676,'fileName':_0x1463c5,'elementType':_0x14d6bc,'elementSubType':_0x13d62d,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x3b826d(0xd3)](_0x2ca777,_0x53ef7e);const _0x593a00=await NTQQFileApi[_0x3b826d(0xbb)](_0x2ca777);return{'md5':_0x4a5676,'fileName':_0x1463c5,'path':_0x53ef7e,'fileSize':_0x593a00,'ext':_0x5bad74};}static async[_0x10d0a2(0xd0)](_0x11cef1,_0x10d93f,_0x2efc10,_0xa1756b,_0x15f300,_0x129ef5,_0xe53396=0x3e8*0x3c*0x2,_0x4d6e61=![]){const _0x50a8be=_0x10d0a2,_0x471ff4={'uMrsN':function(_0x4222ea,_0x4c3042){return _0x4222ea===_0x4c3042;},'olZzK':function(_0x3c83a5,_0x30bb13){return _0x3c83a5(_0x30bb13);},'lHAGH':function(_0x3f4139){return _0x3f4139();},'xgpCL':function(_0x348787,_0x297f71,_0x9e12){return _0x348787(_0x297f71,_0x9e12);}};if(_0x129ef5&&_0x401046[_0x50a8be(0xc0)](_0x129ef5)){if(_0x4d6e61)try{await _0x33599c[_0x50a8be(0xec)](_0x129ef5);}catch(_0x547aa7){}else return _0x129ef5;}return new Promise((_0x59b93e,_0x437c80)=>{const _0x41f0c8=_0x50a8be,_0x596013={'HobHr':function(_0x367886,_0x5e0b84){const _0x595491=_0x2160;return _0x471ff4[_0x595491(0xb6)](_0x367886,_0x5e0b84);},'cywqk':function(_0x511d29,_0x24dd19){const _0x51fb6a=_0x2160;return _0x471ff4[_0x51fb6a(0xe9)](_0x511d29,_0x24dd19);},'UAyep':function(_0x46511a,_0x480e9c){return _0x471ff4['olZzK'](_0x46511a,_0x480e9c);},'UfOpA':_0x41f0c8(0xc9)};let _0x308c65=![];const _0x1f2e2b=_0x554794=>{const _0x254553=_0x41f0c8;if(_0x596013[_0x254553(0xad)](_0x554794[_0x254553(0xc2)],_0x11cef1)){_0x308c65=!![];let _0x411d0b=_0x554794[_0x254553(0xb7)];if(_0x411d0b[_0x254553(0xc8)]('\x5c')){const _0x51793b=sessionConfig[_0x254553(0xb3)];_0x411d0b=_0x30ca5b['join'](_0x51793b,_0x411d0b);}_0x596013[_0x254553(0xd7)](_0x59b93e,_0x411d0b);}};downloadMediaTasks['set'](_0x471ff4[_0x41f0c8(0xce)](randomUUID),_0x1f2e2b),_0x471ff4['xgpCL'](setTimeout,()=>{const _0x2f94d2=_0x41f0c8;!_0x308c65&&_0x596013[_0x2f94d2(0xab)](_0x437c80,_0x596013[_0x2f94d2(0xc5)]);},_0xe53396),napCatCore[_0x41f0c8(0xdd)][_0x41f0c8(0xdf)]()[_0x41f0c8(0xcc)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x11cef1,'chatType':_0x10d93f,'peerUid':_0x2efc10,'elementId':_0xa1756b,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x15f300});});}static async[_0x10d0a2(0xaf)](_0x36c2ef){return new Promise((_0x480ecc,_0x4ef6f)=>{_0xa23eea(_0x36c2ef,(_0x28b60b,_0x28a07a)=>{_0x28b60b?_0x4ef6f(_0x28b60b):_0x480ecc(_0x28a07a);});});}static async[_0x10d0a2(0xd9)](_0x4e3e07,_0x2d20c0){const _0x1f97d7=_0x10d0a2,_0x356fd0={'aOMbV':_0x1f97d7(0xcf),'PrQzJ':_0x1f97d7(0xcb),'SzOHk':function(_0x4e7053,_0x11ee0e){return _0x4e7053+_0x11ee0e;},'bqpWw':function(_0x2e304c,_0x2cc308){return _0x2e304c+_0x2cc308;},'LrIqK':_0x1f97d7(0xeb)};if(!_0x4e3e07)return'';const _0xfeaaa1=_0x4e3e07[_0x1f97d7(0xd2)],_0x536b41=_0x4e3e07[_0x1f97d7(0xc1)],_0x177b2c=_0x4e3e07[_0x1f97d7(0xc1)],_0x15207f=_0x4e3e07[_0x1f97d7(0xb1)];if(_0xfeaaa1){if(_0xfeaaa1[_0x1f97d7(0xc8)](_0x356fd0[_0x1f97d7(0xb5)])){if(_0xfeaaa1[_0x1f97d7(0xc7)](_0x356fd0[_0x1f97d7(0xe5)]))return IMAGE_HTTP_HOST_NT+_0xfeaaa1;const _0x33c0ae=await rkeyManager[_0x1f97d7(0xdc)](),_0x5deaf6=_0x2d20c0?_0x33c0ae[_0x1f97d7(0xe2)]:_0x33c0ae[_0x1f97d7(0xbe)];return _0x356fd0['SzOHk'](IMAGE_HTTP_HOST_NT,_0xfeaaa1)+(''+_0x5deaf6);}else return _0x356fd0['bqpWw'](IMAGE_HTTP_HOST,_0xfeaaa1);}else{if(_0x177b2c||_0x536b41)return IMAGE_HTTP_HOST+_0x1f97d7(0xd1)+(_0x177b2c||_0x536b41)[_0x1f97d7(0xb8)]()+'/0';}return logDebug(_0x356fd0[_0x1f97d7(0xee)],_0x4e3e07),'';}}export class NTQQFileCacheApi{static async[_0x10d0a2(0xef)](_0x1134b9=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x10d0a2(0xac)](_0x137b3e=['tmp','hotUpdate']){const _0x25a90b=_0x10d0a2;return napCatCore['session'][_0x25a90b(0xea)]()[_0x25a90b(0xe7)](_0x137b3e);}static[_0x10d0a2(0xda)](_0x1266e4={}){const _0x45b0c8=_0x10d0a2;return napCatCore['session']['getStorageCleanService']()[_0x45b0c8(0xb2)](_0x1266e4);}static['scanCache'](){const _0x106907=_0x10d0a2;return napCatCore[_0x106907(0xdd)]['getStorageCleanService']()[_0x106907(0xd4)]();}static[_0x10d0a2(0xae)](){return'';}static['getDesktopTmpPath'](){return'';}static['getChatCacheList'](_0x3022b1,_0x22f444=0x3e8,_0x2f1389=0x0){const _0x5ad011=_0x10d0a2;return napCatCore[_0x5ad011(0xdd)][_0x5ad011(0xea)]()[_0x5ad011(0xbf)](_0x3022b1,_0x22f444,0x1,_0x2f1389);}static['getFileCacheInfo'](_0x2d57da,_0xe85952=0x3e8,_0x1eaffb){const _0x226174=_0x1eaffb?_0x1eaffb:{'fileType':_0x2d57da};}static async[_0x10d0a2(0xe0)](_0x174761=[],_0x147bdd=[]){const _0x24df1d=_0x10d0a2;return napCatCore[_0x24df1d(0xdd)]['getStorageCleanService']()['clearChatCacheInfo'](_0x174761,_0x147bdd);}}