const _0x19f735=_0x3e7e;function _0x6f54(){const _0x34ef1c=['QLhaq','图片url获取失败','uEbsJ','getHotUpdateCachePath','LeWYu','下载超时','hookApi\x20is\x20not\x20available','ext','getFileType','nOxuj','20490VNLzPS','setCacheSilentScan','342uDamlp','chatType','clearCacheDataByKeys','existsSync','cSgyT','25798FtKGso','clearChatCache','PIC','qSYDr','getStorageCleanService','4uvSqKW','MHsia','basename','getChatCacheInfo','clearChatCacheInfo','peerUid','session','copyFile','tvdzS','util','dEEBj','fileTypeFromFile','wMmRU','Ceggj','开始调用moeHook获取rkey','getImageSize','hotUpdate','receive\x20downloadMedia\x20task','OIzSF','6FluXOy','dBjmf','PcEYD','then','sourcePath','1771777HgCPLT','defaultFileDownloadPath','nQzJx','heojl','start\x20downloadMedia','13FmHOUG','group','1771328clYIai','LpEzz','mGvYZ','rkey过期或着未获取,\x20url:','getFileSize','OjrJI','unlink','getRKey','RWxOT','onRichMediaDownloadComplete','XyDWQ','usjPm','tqwWO','getMsgService',',\x20rkey:','ubnbu','1367245cUyUJX','177711iwwufg','bpIDj','图片rkey有误','oTYfq','set','downloadPath','join','2302960BfudES','find','图片rkey有效','BKoDW','YRXYH','tQRNh','fileUuid','now','md5HexStr','图片rkey获取失败','get','hMitz','KwyyX','12SVNZuz','msgId','TnJZT','获取图片rkey...','clearCache','isAvailable','getChatCacheList','startsWith','indexOf','bydmN','statusCode','pHele','downloadMedia','qOpkV','picElement','/download','MGEgZ','addCacheScannedPaths','toUpperCase'];_0x6f54=function(){return _0x34ef1c;};return _0x6f54();}(function(_0x25af31,_0x4da732){const _0x270ec2=_0x3e7e,_0x570ce7=_0x25af31();while(!![]){try{const _0x5ec5cc=-parseInt(_0x270ec2(0x236))/0x1*(-parseInt(_0x270ec2(0x214))/0x2)+parseInt(_0x270ec2(0x1dc))/0x3*(-parseInt(_0x270ec2(0x219))/0x4)+-parseInt(_0x270ec2(0x1e3))/0x5+-parseInt(_0x270ec2(0x22c))/0x6*(-parseInt(_0x270ec2(0x231))/0x7)+parseInt(_0x270ec2(0x238))/0x8+parseInt(_0x270ec2(0x20f))/0x9*(parseInt(_0x270ec2(0x20d))/0xa)+parseInt(_0x270ec2(0x1db))/0xb*(parseInt(_0x270ec2(0x1f0))/0xc);if(_0x5ec5cc===_0x4da732)break;else _0x570ce7['push'](_0x570ce7['shift']());}catch(_0x5f246c){_0x570ce7['push'](_0x570ce7['shift']());}}}(_0x6f54,0x4f3be));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x127dac from'path';import _0x4b880a from'fs';import _0x2a9177 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x48d2d1 from'file-type';import{MsgListener}from'@/core/listeners';import _0x44901f from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0xee6306 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;function _0x3e7e(_0x3c9e7a,_0x4d0e1a){const _0x6f548c=_0x6f54();return _0x3e7e=function(_0x3e7e90,_0x5aeb2c){_0x3e7e90=_0x3e7e90-0x1d7;let _0x1e158d=_0x6f548c[_0x3e7e90];return _0x1e158d;},_0x3e7e(_0x3c9e7a,_0x4d0e1a);}const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x19f735(0x241)]=_0x883817=>{const _0x44ebfd=_0x19f735,_0x4173b4={'mGvYZ':function(_0xfb91ac,_0x2fea7f){return _0xfb91ac(_0x2fea7f);}};for(const [_0x5ad17d,_0x684851]of downloadMediaTasks){_0x4173b4[_0x44ebfd(0x23a)](_0x684851,_0x883817),downloadMediaTasks['delete'](_0x5ad17d);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x437fe5){const _0x22e4cd=_0x19f735;return _0x48d2d1[_0x22e4cd(0x224)](_0x437fe5);}static async[_0x19f735(0x220)](_0x4227c0,_0x1a2da2){const _0x119447=_0x19f735;await napCatCore[_0x119447(0x222)][_0x119447(0x220)](_0x4227c0,_0x1a2da2);}static async[_0x19f735(0x23c)](_0x24d1de){const _0x484cac=_0x19f735;return await napCatCore[_0x484cac(0x222)][_0x484cac(0x23c)](_0x24d1de);}static async['uploadFile'](_0x1f32a4,_0x5b6e46=ElementType[_0x19f735(0x216)],_0x282f7b=0x0){const _0x5c7aec=_0x19f735,_0x30d2d6={'INHfg':function(_0x5397d2,_0x58cdc2){return _0x5397d2(_0x58cdc2);},'cSgyT':function(_0x22e3d2,_0x2d05f6){return _0x22e3d2+_0x2d05f6;},'MGEgZ':function(_0x29c5a1,_0x54d2bd){return _0x29c5a1===_0x54d2bd;}},_0x5b90d2=await _0x30d2d6['INHfg'](calculateFileMD5,_0x1f32a4);let _0x456073=(await NTQQFileApi[_0x5c7aec(0x20b)](_0x1f32a4))?.[_0x5c7aec(0x20a)]||'';_0x456073&&(_0x456073=_0x30d2d6[_0x5c7aec(0x213)]('.',_0x456073));let _0x26d64f=''+_0x127dac[_0x5c7aec(0x21b)](_0x1f32a4);_0x30d2d6[_0x5c7aec(0x200)](_0x26d64f[_0x5c7aec(0x1f8)]('.'),-0x1)&&(_0x26d64f+=_0x456073);const _0x18f12c=napCatCore['session']['getMsgService']()['getRichMediaFilePathForGuild']({'md5HexStr':_0x5b90d2,'fileName':_0x26d64f,'elementType':_0x5b6e46,'elementSubType':_0x282f7b,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x1f32a4,_0x18f12c);const _0x529054=await NTQQFileApi['getFileSize'](_0x1f32a4);return{'md5':_0x5b90d2,'fileName':_0x26d64f,'path':_0x18f12c,'fileSize':_0x529054,'ext':_0x456073};}static async[_0x19f735(0x1fc)](_0x4d18bb,_0x24d434,_0x21aeba,_0xb42446,_0x5342b8,_0x1b7184,_0x25328b=0x3e8*0x3c*0x2,_0x3d05ca=![]){const _0x23ac63=_0x19f735,_0x9a5452={'wMmRU':function(_0x5741a3,_0x429dd9,_0x15e3c9,_0x3073f4){return _0x5741a3(_0x429dd9,_0x15e3c9,_0x3073f4);},'nOxuj':function(_0x52a77c,_0x23fa9c){return _0x52a77c===_0x23fa9c;},'TnJZT':function(_0x1857d7,_0x592c96,_0x22accc){return _0x1857d7(_0x592c96,_0x22accc);},'qOpkV':function(_0x4851d9,_0x30a9e5){return _0x4851d9(_0x30a9e5);},'GdFpz':_0x23ac63(0x208),'LeWYu':function(_0x42f302,_0xe6e872,_0x2f6f90,_0x3399b0,_0x3d7f6e,_0x4871f5,_0x724a92,_0x105a5c,_0x1613df,_0x320030){return _0x42f302(_0xe6e872,_0x2f6f90,_0x3399b0,_0x3d7f6e,_0x4871f5,_0x724a92,_0x105a5c,_0x1613df,_0x320030);},'qSYDr':_0x23ac63(0x235)};logDebug(_0x23ac63(0x22a),_0x4d18bb,_0x24d434,_0x21aeba,_0xb42446,_0x5342b8,_0x1b7184,_0x25328b,_0x3d05ca);if(_0x1b7184&&_0x4b880a[_0x23ac63(0x212)](_0x1b7184)){if(_0x3d05ca)try{await _0x2a9177[_0x23ac63(0x23e)](_0x1b7184);}catch(_0x152ca9){}else return _0x1b7184;}return _0x9a5452[_0x23ac63(0x207)](logDebug,_0x9a5452[_0x23ac63(0x217)],_0x4d18bb,_0x24d434,_0x21aeba,_0xb42446,_0x5342b8,_0x1b7184,_0x25328b,_0x3d05ca),new Promise((_0x5a7761,_0x5829ab)=>{const _0x12340d=_0x23ac63,_0x198110={'dBjmf':function(_0x10c50b,_0x28d13e,_0x2c2ec4,_0x211242){const _0x11a5dc=_0x3e7e;return _0x9a5452[_0x11a5dc(0x225)](_0x10c50b,_0x28d13e,_0x2c2ec4,_0x211242);},'YRXYH':'downloadMedia\x20complete','ZVogk':function(_0x688897,_0x2f95b7){const _0x4cf572=_0x3e7e;return _0x9a5452[_0x4cf572(0x20c)](_0x688897,_0x2f95b7);},'dEEBj':function(_0x1ea666,_0x120226,_0x8ea1ac){const _0xeee501=_0x3e7e;return _0x9a5452[_0xeee501(0x1f2)](_0x1ea666,_0x120226,_0x8ea1ac);},'PcEYD':function(_0x179646,_0x2e639f){const _0x418722=_0x3e7e;return _0x9a5452[_0x418722(0x1fd)](_0x179646,_0x2e639f);},'XyDWQ':_0x9a5452['GdFpz']};let _0x4b793b=![];const _0x56c489=_0x23a448=>{const _0x294d33=_0x3e7e;_0x198110[_0x294d33(0x22d)](logDebug,_0x198110[_0x294d33(0x1e7)],_0x23a448,_0x4d18bb);if(_0x198110['ZVogk'](_0x23a448[_0x294d33(0x1f1)],_0x4d18bb)){_0x4b793b=!![];let _0x3154a9=_0x23a448['filePath'];if(_0x3154a9[_0x294d33(0x1f7)]('\x5c')){const _0x31daef=sessionConfig[_0x294d33(0x232)];_0x198110[_0x294d33(0x223)](logDebug,_0x294d33(0x1e1),_0x31daef),_0x3154a9=_0x127dac[_0x294d33(0x1e2)](_0x31daef,_0x3154a9);}_0x198110[_0x294d33(0x22e)](_0x5a7761,_0x3154a9);}};downloadMediaTasks[_0x12340d(0x1e0)](randomUUID(),_0x56c489),_0x9a5452[_0x12340d(0x1f2)](setTimeout,()=>{const _0x284e15=_0x12340d;!_0x4b793b&&_0x5829ab(_0x198110[_0x284e15(0x242)]);},_0x25328b),napCatCore[_0x12340d(0x21f)][_0x12340d(0x1d8)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x4d18bb,'chatType':_0x24d434,'peerUid':_0x21aeba,'elementId':_0xb42446,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x5342b8});});}static async[_0x19f735(0x228)](_0x179aa8){const _0x237699={'MHsia':function(_0x14ca65,_0x168830,_0xc00978){return _0x14ca65(_0x168830,_0xc00978);}};return new Promise((_0x5ccdb9,_0x584e83)=>{const _0x3fff9f=_0x3e7e;_0x237699[_0x3fff9f(0x21a)](_0x44901f,_0x179aa8,(_0x324e91,_0xc888fd)=>{_0x324e91?_0x584e83(_0x324e91):_0x5ccdb9(_0xc888fd);});});}static async['getImageUrl'](_0x2de459){const _0x33ee58=_0x19f735,_0x2947d9={'uEbsJ':function(_0x450c95,_0x1ba2d6){return _0x450c95(_0x1ba2d6);},'CdNpH':_0x33ee58(0x1f3),'BKoDW':function(_0x49dc57,_0x3a6fee){return _0x49dc57*_0x3a6fee;},'ubnbu':_0x33ee58(0x227),'KwyyX':function(_0x1a353d,_0x2c0ba2){return _0x1a353d+_0x2c0ba2;},'OjrJI':function(_0x429633,_0x153c30){return _0x429633+_0x153c30;},'yMAwH':function(_0x40e78e,_0x11dbda,_0x29286f){return _0x40e78e(_0x11dbda,_0x29286f);},'OIzSF':'检查rkey是否有效','RWxOT':function(_0x287f60,_0x45ce78,_0x5dca72,_0x3bb6d7){return _0x287f60(_0x45ce78,_0x5dca72,_0x3bb6d7);},'eoiCv':_0x33ee58(0x1de),'btucf':function(_0x176615){return _0x176615();},'oTYfq':function(_0x28c322,_0x242727){return _0x28c322(_0x242727);},'pHele':_0x33ee58(0x1ff),'usjPm':function(_0x44b79d,_0x2b701d){return _0x44b79d(_0x2b701d);},'VLIWD':_0x33ee58(0x209),'tQRNh':function(_0x5f5056,_0x4bb175){return _0x5f5056>_0x4bb175;},'Ceggj':function(_0x21fa30,_0x2e7e96){return _0x21fa30-_0x2e7e96;},'tqwWO':function(_0x5b81d8,_0x2c1661){return _0x5b81d8+_0x2c1661;},'QLhaq':_0x33ee58(0x1ec),'gVIDZ':function(_0x50fcc3,_0x45dea4){return _0x50fcc3+_0x45dea4;},'tLVKW':function(_0x41f8c8,_0x12f695){return _0x41f8c8+_0x12f695;},'tvdzS':function(_0x295874,_0x30e6c7){return _0x295874+_0x30e6c7;},'hMitz':function(_0x4864e5,_0x5ccc1d){return _0x4864e5||_0x5ccc1d;},'Pzteq':function(_0x1e28b9,_0x8aaae3){return _0x1e28b9||_0x8aaae3;}},_0x3fe94a=_0x2de459['chatType']!==ChatType[_0x33ee58(0x237)],_0x6a69eb=_0x2de459['elements'][_0x33ee58(0x1e4)](_0x360d87=>!!_0x360d87[_0x33ee58(0x1fe)]);if(!_0x6a69eb)return'';const _0xb3672e=_0x6a69eb['picElement']['originImageUrl'],_0x3b66a3=_0x6a69eb['picElement']['md5HexStr'],_0x3063a4=_0x6a69eb[_0x33ee58(0x1fe)][_0x33ee58(0x1eb)],_0x4964b0=_0x6a69eb[_0x33ee58(0x1fe)][_0x33ee58(0x1e9)],_0x4ab856=_0x37bff3=>{_0x3fe94a?(privateImageRKey=_0x37bff3,lastGetPrivateRKeyTime=Date['now']()):(groupImageRKey=_0x37bff3,lastGetGroupRKeyTime=Date['now']());};if(_0xb3672e){if(_0xb3672e[_0x33ee58(0x1f7)](_0x2947d9[_0x33ee58(0x1fb)])){if(_0xb3672e['includes']('&rkey='))return _0x2947d9[_0x33ee58(0x23d)](IMAGE_HTTP_HOST_NT,_0xb3672e);if(!hookApi[_0x33ee58(0x1f5)]())return _0x2947d9[_0x33ee58(0x243)](logDebug,_0x2947d9['VLIWD']),'';const _0x288f81=async()=>{const _0x5af6c1=_0x33ee58,_0x4cd145={'bpIDj':function(_0x475e52,_0x1e7c6a){const _0x1714ba=_0x3e7e;return _0x2947d9[_0x1714ba(0x205)](_0x475e52,_0x1e7c6a);},'LpEzz':'error'};_0x2947d9[_0x5af6c1(0x205)](logDebug,_0x2947d9['CdNpH']),NTQQFileApi[_0x5af6c1(0x1fc)](_0x2de459[_0x5af6c1(0x1f1)],_0x2de459[_0x5af6c1(0x210)],_0x2de459[_0x5af6c1(0x21e)],_0x6a69eb['elementId'],'',_0x6a69eb[_0x5af6c1(0x1fe)][_0x5af6c1(0x230)],_0x2947d9[_0x5af6c1(0x1e6)](0x3e8,0x1e),!![])[_0x5af6c1(0x22f)](_0x1f2a34=>{})['catch'](logError),await _0x2947d9[_0x5af6c1(0x205)](sleep,0x3e8),_0x2947d9[_0x5af6c1(0x205)](logDebug,_0x2947d9[_0x5af6c1(0x1da)]);const _0x1f49dc=hookApi[_0x5af6c1(0x23f)]()||'',_0x8207=_0x2947d9[_0x5af6c1(0x1ef)](_0x2947d9['OjrJI'](IMAGE_HTTP_HOST_NT,_0xb3672e),_0x1f49dc);if(_0x1f49dc)try{_0x2947d9['yMAwH'](logDebug,_0x2947d9[_0x5af6c1(0x22b)],_0x8207),await new Promise((_0x21ca16,_0xa919e0)=>{const _0x290f06=_0x5af6c1,_0x5ad92d={'bydmN':function(_0x4ec0ab,_0x9ccdff){const _0x4aa1c1=_0x3e7e;return _0x4cd145[_0x4aa1c1(0x1dd)](_0x4ec0ab,_0x9ccdff);}};_0xee6306[_0x290f06(0x1ed)](_0x8207,_0x546385=>{const _0x20ba0a=_0x290f06;_0x546385[_0x20ba0a(0x1fa)]!==0xc8?_0xa919e0(_0x20ba0a(0x1ec)):_0x5ad92d[_0x20ba0a(0x1f9)](_0x21ca16,_0x546385);})['on'](_0x4cd145[_0x290f06(0x239)],_0x1d7a8d=>{_0xa919e0(_0x1d7a8d);});}),_0x2947d9['yMAwH'](logDebug,_0x5af6c1(0x1e5),_0x8207),_0x4ab856(_0x1f49dc);}catch(_0x4dc96b){return _0x2947d9[_0x5af6c1(0x240)](logError,_0x2947d9['eoiCv'],_0x8207,_0x4dc96b),'';}return _0x1f49dc;},_0x3d8f92=()=>new Promise((_0x65c021,_0x867003)=>{const _0x194f79={'nQzJx':function(_0x3ff29a){return _0x2947d9['btucf'](_0x3ff29a);},'heojl':function(_0x36da10,_0x2973b7){const _0x2e0d59=_0x3e7e;return _0x2947d9[_0x2e0d59(0x1df)](_0x36da10,_0x2973b7);}};getRKeyTaskQueue['addTask'](async()=>{const _0x4a3c89=_0x3e7e,_0x3f35f2=await _0x194f79[_0x4a3c89(0x233)](_0x288f81);_0x194f79[_0x4a3c89(0x234)](_0x65c021,_0x3f35f2);});}),_0x4a0cb6=_0x3fe94a?privateImageRKey:groupImageRKey,_0x59434c=_0x3fe94a?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x2947d9[_0x33ee58(0x1e8)](_0x2947d9[_0x33ee58(0x226)](Date[_0x33ee58(0x1ea)](),_0x59434c),rkeyExpireTime)||!_0x4a0cb6){_0x2947d9[_0x33ee58(0x205)](logDebug,_0x33ee58(0x23b)+_0xb3672e+_0x33ee58(0x1d9)+_0x4a0cb6);const _0x2382e2=await _0x3d8f92();if(_0x2382e2)return _0x2947d9[_0x33ee58(0x1d7)](IMAGE_HTTP_HOST_NT+_0xb3672e,''+_0x2382e2);else _0x2947d9['yMAwH'](logError,_0x2947d9[_0x33ee58(0x203)],_0xb3672e);}if(_0x4a0cb6)return _0x2947d9['gVIDZ'](_0x2947d9['tLVKW'](IMAGE_HTTP_HOST_NT,_0xb3672e),''+_0x4a0cb6);return'';}else return _0x2947d9[_0x33ee58(0x221)](IMAGE_HTTP_HOST,_0xb3672e);}else{if(_0x2947d9[_0x33ee58(0x1ee)](_0x3063a4,_0x3b66a3))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x2947d9['Pzteq'](_0x3063a4,_0x3b66a3)[_0x33ee58(0x202)]()+'/0';}return _0x2947d9['yMAwH'](logDebug,_0x33ee58(0x204),_0x2de459),'';}}export class NTQQFileCacheApi{static async[_0x19f735(0x20e)](_0x336677=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x19f735(0x1f4)](_0x50ebba=['tmp',_0x19f735(0x229)]){const _0x52279d=_0x19f735;return napCatCore['session'][_0x52279d(0x218)]()[_0x52279d(0x211)](_0x50ebba);}static[_0x19f735(0x201)](_0x2a47bc={}){const _0x53e22f=_0x19f735;return napCatCore[_0x53e22f(0x21f)]['getStorageCleanService']()['addCacheScanedPaths'](_0x2a47bc);}static['scanCache'](){const _0x51bdef=_0x19f735;return napCatCore[_0x51bdef(0x21f)][_0x51bdef(0x218)]()['scanCache']();}static[_0x19f735(0x206)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x19f735(0x1f6)](_0x1430af,_0x27528a=0x3e8,_0x53c5a1=0x0){const _0xfa538a=_0x19f735;return napCatCore[_0xfa538a(0x21f)][_0xfa538a(0x218)]()[_0xfa538a(0x21c)](_0x1430af,_0x27528a,0x1,_0x53c5a1);}static['getFileCacheInfo'](_0x341886,_0x108031=0x3e8,_0x443254){const _0xf9eda1=_0x443254?_0x443254:{'fileType':_0x341886};}static async[_0x19f735(0x215)](_0x4c4468=[],_0x180477=[]){const _0x269f1f=_0x19f735;return napCatCore[_0x269f1f(0x21f)][_0x269f1f(0x218)]()[_0x269f1f(0x21d)](_0x4c4468,_0x180477);}}