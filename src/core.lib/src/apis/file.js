const _0x1e0da9=_0x2ced;(function(_0x6d05a0,_0x89ffc0){const _0x4c552b=_0x2ced,_0x1e4bce=_0x6d05a0();while(!![]){try{const _0x320214=parseInt(_0x4c552b(0x1b6))/0x1+-parseInt(_0x4c552b(0x1ab))/0x2*(-parseInt(_0x4c552b(0x1a8))/0x3)+parseInt(_0x4c552b(0x1c8))/0x4+parseInt(_0x4c552b(0x1cd))/0x5+-parseInt(_0x4c552b(0x1c0))/0x6*(-parseInt(_0x4c552b(0x1cb))/0x7)+parseInt(_0x4c552b(0x1a0))/0x8*(-parseInt(_0x4c552b(0x1a6))/0x9)+-parseInt(_0x4c552b(0x1bd))/0xa*(parseInt(_0x4c552b(0x1d4))/0xb);if(_0x320214===_0x89ffc0)break;else _0x1e4bce['push'](_0x1e4bce['shift']());}catch(_0x549661){_0x1e4bce['push'](_0x1e4bce['shift']());}}}(_0x275d,0xb16a0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x275d(){const _0x477ab9=['getRkey','&rkey=','getMsgService','/download','729EnVdKM','getRichMediaFilePathForGuild','219WkEXPQ','iHoKU','indexOf','514BWBaPP','Ukrwq','getStorageCleanService','includes','set','KdvIR','PIC','md5HexStr','clearChatCacheInfo','getFileSize','filePath','189487oqtbYz','下载超时','getFileType','private_rkey','onLoginSuccess','getFileCacheInfo','lhuwO','50jVqhsj','startsWith','jXOtN','18QdwZLn','toUpperCase','addCacheScannedPaths','existsSync','downloadRichMedia','/gchatpic_new/0/0-0-','msgId','UEonW','3362076DNmTVo','scanCache','copyFile','2070341wtTphn','getChatCacheInfo','3029250WsuHNE','lBIxH','setCacheSilentScan','getChatCacheList','getCacheSessionPathList','basename','addCacheScanedPaths','2377562BjGBLk','group_rkey','LHQoH','defaultFileDownloadPath','uploadFile','session','join','72544vhelTU','clearChatCache'];_0x275d=function(){return _0x477ab9;};return _0x275d();}import _0x42ad16 from'path';import _0x249557 from'fs';import _0xd40143 from'fs/promises';function _0x2ced(_0x563d46,_0x42c9e1){const _0x275d4f=_0x275d();return _0x2ced=function(_0x2ced78,_0x133912){_0x2ced78=_0x2ced78-0x19a;let _0x3564e1=_0x275d4f[_0x2ced78];return _0x3564e1;},_0x2ced(_0x563d46,_0x42c9e1);}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x31ed7c from'file-type';import{MsgListener}from'@/core/listeners';import _0x1f40e4 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x28bc61=>{for(const [_0x356a49,_0x26800d]of downloadMediaTasks){_0x26800d(_0x28bc61),downloadMediaTasks['delete'](_0x356a49);}},setTimeout(()=>{const _0x4713ac=_0x2ced;napCatCore[_0x4713ac(0x1ba)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x1e0da9(0x1b8)](_0x3de202){return _0x31ed7c['fileTypeFromFile'](_0x3de202);}static async[_0x1e0da9(0x1ca)](_0xfdbdf8,_0x345767){const _0x5ed788=_0x1e0da9;await napCatCore['util'][_0x5ed788(0x1ca)](_0xfdbdf8,_0x345767);}static async[_0x1e0da9(0x1b4)](_0x1c1647){const _0x7e9e1f=_0x1e0da9;return await napCatCore['util'][_0x7e9e1f(0x1b4)](_0x1c1647);}static async[_0x1e0da9(0x19d)](_0x4e5b69,_0x195503=ElementType[_0x1e0da9(0x1b1)],_0x1758de=0x0){const _0xe93516=_0x1e0da9,_0x3edb2f={'APjDi':function(_0x219a1d,_0x2ed707){return _0x219a1d(_0x2ed707);},'jXOtN':function(_0xdd3dff,_0x449046){return _0xdd3dff+_0x449046;},'hyuYW':function(_0x5b00ea,_0x10e995){return _0x5b00ea===_0x10e995;}},_0x6ba3fc=await _0x3edb2f['APjDi'](calculateFileMD5,_0x4e5b69);let _0xb12f28=(await NTQQFileApi[_0xe93516(0x1b8)](_0x4e5b69))?.['ext']||'';_0xb12f28&&(_0xb12f28=_0x3edb2f[_0xe93516(0x1bf)]('.',_0xb12f28));let _0xf2e2=''+_0x42ad16[_0xe93516(0x1d2)](_0x4e5b69);_0x3edb2f['hyuYW'](_0xf2e2[_0xe93516(0x1aa)]('.'),-0x1)&&(_0xf2e2+=_0xb12f28);const _0x1de1b7=napCatCore[_0xe93516(0x19e)][_0xe93516(0x1a4)]()[_0xe93516(0x1a7)]({'md5HexStr':_0x6ba3fc,'fileName':_0xf2e2,'elementType':_0x195503,'elementSubType':_0x1758de,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0xe93516(0x1ca)](_0x4e5b69,_0x1de1b7);const _0x18c15f=await NTQQFileApi[_0xe93516(0x1b4)](_0x4e5b69);return{'md5':_0x6ba3fc,'fileName':_0xf2e2,'path':_0x1de1b7,'fileSize':_0x18c15f,'ext':_0xb12f28};}static async['downloadMedia'](_0x4ac64e,_0x4ba3d6,_0x3dde59,_0x4315e3,_0x4973ac,_0x2b07c3,_0xa18bd9=0x3e8*0x3c*0x2,_0x50b229=![]){const _0xf42596=_0x1e0da9,_0x202161={'KdvIR':function(_0x47438f,_0x5ac6a8){return _0x47438f===_0x5ac6a8;},'lhuwO':function(_0x36fae3,_0x2ab3db){return _0x36fae3(_0x2ab3db);},'iHoKU':_0xf42596(0x1b7),'cvWEF':function(_0x39159a,_0xc8639,_0x266923){return _0x39159a(_0xc8639,_0x266923);}};if(_0x2b07c3&&_0x249557[_0xf42596(0x1c3)](_0x2b07c3)){if(_0x50b229)try{await _0xd40143['unlink'](_0x2b07c3);}catch(_0x5658ad){}else return _0x2b07c3;}return new Promise((_0x57ba29,_0x3f8ce0)=>{const _0xfcd27=_0xf42596;let _0x6cae2a=![];const _0x525432=_0x4ce162=>{const _0xf177a5=_0x2ced;if(_0x202161[_0xf177a5(0x1b0)](_0x4ce162[_0xf177a5(0x1c6)],_0x4ac64e)){_0x6cae2a=!![];let _0x547e75=_0x4ce162[_0xf177a5(0x1b5)];if(_0x547e75[_0xf177a5(0x1be)]('\x5c')){const _0x4d1f2f=sessionConfig[_0xf177a5(0x19c)];_0x547e75=_0x42ad16[_0xf177a5(0x19f)](_0x4d1f2f,_0x547e75);}_0x202161[_0xf177a5(0x1bc)](_0x57ba29,_0x547e75);}};downloadMediaTasks[_0xfcd27(0x1af)](randomUUID(),_0x525432),_0x202161['cvWEF'](setTimeout,()=>{const _0x5c03ca=_0xfcd27;!_0x6cae2a&&_0x3f8ce0(_0x202161[_0x5c03ca(0x1a9)]);},_0xa18bd9),napCatCore[_0xfcd27(0x19e)]['getMsgService']()[_0xfcd27(0x1c4)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x4ac64e,'chatType':_0x4ba3d6,'peerUid':_0x3dde59,'elementId':_0x4315e3,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4973ac});});}static async['getImageSize'](_0x28f0eb){const _0x5f2f8e={'dXEax':function(_0x4008a4,_0x49d6c9){return _0x4008a4(_0x49d6c9);},'Ukrwq':function(_0x10f9ed,_0x1a52a2,_0x4bf93d){return _0x10f9ed(_0x1a52a2,_0x4bf93d);}};return new Promise((_0x56a5c7,_0x2ed590)=>{const _0x4f60cc=_0x2ced,_0x5987cf={'lBIxH':function(_0x240869,_0x2b3593){return _0x5f2f8e['dXEax'](_0x240869,_0x2b3593);}};_0x5f2f8e[_0x4f60cc(0x1ac)](_0x1f40e4,_0x28f0eb,(_0xe3a289,_0x1a5faf)=>{const _0x4c21dd=_0x4f60cc;_0xe3a289?_0x5987cf[_0x4c21dd(0x1ce)](_0x2ed590,_0xe3a289):_0x5987cf[_0x4c21dd(0x1ce)](_0x56a5c7,_0x1a5faf);});});}static async['getImageUrl'](_0x28306a,_0x34de79){const _0x38919b=_0x1e0da9,_0x57a0a1={'hjQyz':_0x38919b(0x1a5),'UEonW':_0x38919b(0x1a3),'LHQoH':function(_0x5f53f4,_0x8f151){return _0x5f53f4+_0x8f151;},'HctlI':function(_0x2eb649,_0x29c6bb){return _0x2eb649||_0x29c6bb;},'Ueboc':function(_0x3248e1,_0x30ff30){return _0x3248e1||_0x30ff30;},'cHbgS':function(_0x679be4,_0x4a075c,_0x27253f){return _0x679be4(_0x4a075c,_0x27253f);},'uIQEC':'图片url获取失败'};if(!_0x28306a)return'';const _0x546aea=_0x28306a['originImageUrl'],_0x24f8fe=_0x28306a[_0x38919b(0x1b2)],_0x4c36e6=_0x28306a['md5HexStr'],_0xbd4d55=_0x28306a['fileUuid'];if(_0x546aea){if(_0x546aea[_0x38919b(0x1be)](_0x57a0a1['hjQyz'])){if(_0x546aea[_0x38919b(0x1ae)](_0x57a0a1[_0x38919b(0x1c7)]))return IMAGE_HTTP_HOST_NT+_0x546aea;const _0x5a073a=await rkeyManager[_0x38919b(0x1a2)](),_0x1757c9=_0x34de79?_0x5a073a[_0x38919b(0x1b9)]:_0x5a073a[_0x38919b(0x19a)];return _0x57a0a1[_0x38919b(0x19b)](IMAGE_HTTP_HOST_NT,_0x546aea)+(''+_0x1757c9);}else return IMAGE_HTTP_HOST+_0x546aea;}else{if(_0x57a0a1['HctlI'](_0x4c36e6,_0x24f8fe))return IMAGE_HTTP_HOST+_0x38919b(0x1c5)+_0x57a0a1['Ueboc'](_0x4c36e6,_0x24f8fe)[_0x38919b(0x1c1)]()+'/0';}return _0x57a0a1['cHbgS'](logDebug,_0x57a0a1['uIQEC'],_0x28306a),'';}}export class NTQQFileCacheApi{static async[_0x1e0da9(0x1cf)](_0x3eeda5=!![]){return'';}static[_0x1e0da9(0x1d1)](){return'';}static['clearCache'](_0x293225=['tmp','hotUpdate']){const _0xbb2382=_0x1e0da9;return napCatCore[_0xbb2382(0x19e)]['getStorageCleanService']()['clearCacheDataByKeys'](_0x293225);}static[_0x1e0da9(0x1c2)](_0x46ff82={}){const _0x96fed7=_0x1e0da9;return napCatCore['session'][_0x96fed7(0x1ad)]()[_0x96fed7(0x1d3)](_0x46ff82);}static[_0x1e0da9(0x1c9)](){const _0x469dac=_0x1e0da9;return napCatCore[_0x469dac(0x19e)][_0x469dac(0x1ad)]()[_0x469dac(0x1c9)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x1e0da9(0x1d0)](_0x239eef,_0xaab901=0x3e8,_0x39adef=0x0){const _0x459702=_0x1e0da9;return napCatCore['session']['getStorageCleanService']()[_0x459702(0x1cc)](_0x239eef,_0xaab901,0x1,_0x39adef);}static[_0x1e0da9(0x1bb)](_0x2a0a91,_0x1e5184=0x3e8,_0x4d3b69){const _0x562294=_0x4d3b69?_0x4d3b69:{'fileType':_0x2a0a91};}static async[_0x1e0da9(0x1a1)](_0x3cbafe=[],_0x5a3df3=[]){const _0x279fa8=_0x1e0da9;return napCatCore[_0x279fa8(0x19e)][_0x279fa8(0x1ad)]()[_0x279fa8(0x1b3)](_0x3cbafe,_0x5a3df3);}}