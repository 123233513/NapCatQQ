function _0x1348(_0x32cb29,_0x3ca141){const _0x5bb146=_0x5bb1();return _0x1348=function(_0x134892,_0x518056){_0x134892=_0x134892-0x77;let _0x5ce945=_0x5bb146[_0x134892];return _0x5ce945;},_0x1348(_0x32cb29,_0x3ca141);}const _0x3ed193=_0x1348;(function(_0x25344b,_0x773571){const _0x1807c8=_0x1348,_0x20243b=_0x25344b();while(!![]){try{const _0x5c74d2=parseInt(_0x1807c8(0xbd))/0x1+-parseInt(_0x1807c8(0xba))/0x2+-parseInt(_0x1807c8(0x83))/0x3*(-parseInt(_0x1807c8(0xaa))/0x4)+parseInt(_0x1807c8(0x97))/0x5*(parseInt(_0x1807c8(0x7a))/0x6)+parseInt(_0x1807c8(0xaf))/0x7*(-parseInt(_0x1807c8(0xbe))/0x8)+parseInt(_0x1807c8(0xa5))/0x9+-parseInt(_0x1807c8(0xab))/0xa;if(_0x5c74d2===_0x773571)break;else _0x20243b['push'](_0x20243b['shift']());}catch(_0x1cdf43){_0x20243b['push'](_0x20243b['shift']());}}}(_0x5bb1,0x54e68));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x59a858 from'path';import _0x24b35b from'fs';import _0x22a432 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x5ae143 from'file-type';import{MsgListener}from'@/core/listeners';import _0x1a2594 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';function _0x5bb1(){const _0x263502=['MVuzJ','join','5496579PgdIAc','mTesp','downloadMedia','tmp','ext','1052WagpNU','4722410VFYuci','addListener','eTPFo','eOnhj','7IFvqEV','defaultFileDownloadPath','downloadMedia\x20complete','addCacheScannedPaths','YeBpb','OpBuL','aZTiU','originImageUrl','md5HexStr','filePath','PIC','302634zHRCXw','uploadFile','clearCacheDataByKeys','213692YqIQHd','5036856ODaohO','fileUuid','getImageSize','BUBLn','下载超时','getDesktopTmpPath','unlink','fIyXj','existsSync','getFileType','util','BndEZ','KWZyc','360546FeQpAS','receive\x20downloadMedia\x20task','getRkey','start\x20downloadMedia','dQiNU','getStorageCleanService','fileTypeFromFile','yVbVv','scanCache','6801xiVInI','getFileCacheInfo','hxjkt','onRichMediaDownloadComplete','LuNkD','getImageUrl','getFileSize','nIbjm','getChatCacheList','clearChatCache','msgId','ZBasR','getChatCacheInfo','hotUpdate','tONHK','JKvqf','session','JgSRt','oEeUT','addCacheScanedPaths','15VFFsLT','group_rkey','/gchatpic_new/0/0-0-','Znuea','/download','图片url获取失败','getRichMediaFilePathForGuild','getMsgService','IlWCq','startsWith','clearCache','includes'];_0x5bb1=function(){return _0x263502;};return _0x5bb1();}import{AsyncQueue}from'@/common/utils/asyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x3ed193(0x86)]=_0x390eb6=>{const _0x42ecd6={'ZRsZL':function(_0x102a98,_0x1fe88f){return _0x102a98(_0x1fe88f);}};for(const [_0x3a8e83,_0x43ca83]of downloadMediaTasks){_0x42ecd6['ZRsZL'](_0x43ca83,_0x390eb6),downloadMediaTasks['delete'](_0x3a8e83);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x3823e6=_0x1348;napCatCore[_0x3823e6(0xac)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x3ed193(0xc7)](_0x55362f){const _0x1ecf90=_0x3ed193;return _0x5ae143[_0x1ecf90(0x80)](_0x55362f);}static async['copyFile'](_0x242be3,_0x5db6b6){await napCatCore['util']['copyFile'](_0x242be3,_0x5db6b6);}static async[_0x3ed193(0x89)](_0x10907a){const _0x2e5c24=_0x3ed193;return await napCatCore[_0x2e5c24(0x77)][_0x2e5c24(0x89)](_0x10907a);}static async[_0x3ed193(0xbb)](_0x3856cb,_0x3892f9=ElementType[_0x3ed193(0xb9)],_0x14626c=0x0){const _0x281a52=_0x3ed193,_0x4fdd84={'fIyXj':function(_0x4f8dc4,_0x3d7ac0){return _0x4f8dc4+_0x3d7ac0;}},_0x8c0d2a=await calculateFileMD5(_0x3856cb);let _0x1791a8=(await NTQQFileApi[_0x281a52(0xc7)](_0x3856cb))?.[_0x281a52(0xa9)]||'';_0x1791a8&&(_0x1791a8=_0x4fdd84[_0x281a52(0xc5)]('.',_0x1791a8));let _0x21d01b=''+_0x59a858['basename'](_0x3856cb);_0x21d01b['indexOf']('.')===-0x1&&(_0x21d01b+=_0x1791a8);const _0x4948d9=napCatCore[_0x281a52(0x93)][_0x281a52(0x9e)]()[_0x281a52(0x9d)]({'md5HexStr':_0x8c0d2a,'fileName':_0x21d01b,'elementType':_0x3892f9,'elementSubType':_0x14626c,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x3856cb,_0x4948d9);const _0x136e42=await NTQQFileApi['getFileSize'](_0x3856cb);return{'md5':_0x8c0d2a,'fileName':_0x21d01b,'path':_0x4948d9,'fileSize':_0x136e42,'ext':_0x1791a8};}static async[_0x3ed193(0xa7)](_0x902efc,_0x1f26c2,_0x46dc93,_0x29c584,_0x31bb38,_0x41e7f3,_0x394fc0=0x3e8*0x3c*0x2,_0x4b2dea=![]){const _0x44820b=_0x3ed193,_0x2d0a8b={'OpBuL':function(_0x2e4fe6,_0x3f256a,_0x2795b6,_0x296d80){return _0x2e4fe6(_0x3f256a,_0x2795b6,_0x296d80);},'aZTiU':function(_0x4698d3,_0x2eceaf,_0x65304c){return _0x4698d3(_0x2eceaf,_0x65304c);},'ZBasR':'downloadPath','nIbjm':function(_0x98a93e,_0x348ee6){return _0x98a93e(_0x348ee6);},'YeBpb':_0x44820b(0xc2),'tONHK':function(_0x25a8d1){return _0x25a8d1();},'KWZyc':function(_0x290bbb,_0x5ec986,_0x51034a,_0xab0490,_0x4f00d5,_0x43ceb4,_0x7b9d11,_0x150a66,_0x359c7e,_0xafbd0c){return _0x290bbb(_0x5ec986,_0x51034a,_0xab0490,_0x4f00d5,_0x43ceb4,_0x7b9d11,_0x150a66,_0x359c7e,_0xafbd0c);},'JgSRt':_0x44820b(0x7b),'MKnGC':_0x44820b(0x7d)};_0x2d0a8b[_0x44820b(0x79)](logDebug,_0x2d0a8b[_0x44820b(0x94)],_0x902efc,_0x1f26c2,_0x46dc93,_0x29c584,_0x31bb38,_0x41e7f3,_0x394fc0,_0x4b2dea);if(_0x41e7f3&&_0x24b35b[_0x44820b(0xc6)](_0x41e7f3)){if(_0x4b2dea)try{await _0x22a432[_0x44820b(0xc4)](_0x41e7f3);}catch(_0x2d24a5){}else return _0x41e7f3;}return _0x2d0a8b[_0x44820b(0x79)](logDebug,_0x2d0a8b['MKnGC'],_0x902efc,_0x1f26c2,_0x46dc93,_0x29c584,_0x31bb38,_0x41e7f3,_0x394fc0,_0x4b2dea),new Promise((_0x1459b8,_0x5b95fd)=>{const _0x278905=_0x44820b,_0x455181={'oAlHC':function(_0x4b4069,_0x414d2b,_0x562493,_0x29d291){const _0x28094a=_0x1348;return _0x2d0a8b[_0x28094a(0xb4)](_0x4b4069,_0x414d2b,_0x562493,_0x29d291);},'EKPau':_0x278905(0xb1),'oEeUT':function(_0x38aedf,_0x35adc5,_0x341a86){const _0x55fef4=_0x278905;return _0x2d0a8b[_0x55fef4(0xb5)](_0x38aedf,_0x35adc5,_0x341a86);},'MVuzJ':_0x2d0a8b[_0x278905(0x8e)],'IlWCq':function(_0x447397,_0x3bad8c){const _0x2178da=_0x278905;return _0x2d0a8b[_0x2178da(0x8a)](_0x447397,_0x3bad8c);},'BUBLn':function(_0x38c432,_0xbae6ed){return _0x2d0a8b['nIbjm'](_0x38c432,_0xbae6ed);},'eOnhj':_0x2d0a8b[_0x278905(0xb3)]};let _0x120aa7=![];const _0x3af552=_0x4ba076=>{const _0x4ac027=_0x278905;_0x455181['oAlHC'](logDebug,_0x455181['EKPau'],_0x4ba076,_0x902efc);if(_0x4ba076[_0x4ac027(0x8d)]===_0x902efc){_0x120aa7=!![];let _0x5045a9=_0x4ba076[_0x4ac027(0xb8)];if(_0x5045a9[_0x4ac027(0xa0)]('\x5c')){const _0xbe6bcc=sessionConfig[_0x4ac027(0xb0)];_0x455181[_0x4ac027(0x95)](logDebug,_0x455181[_0x4ac027(0xa3)],_0xbe6bcc),_0x5045a9=_0x59a858[_0x4ac027(0xa4)](_0xbe6bcc,_0x5045a9);}_0x455181[_0x4ac027(0x9f)](_0x1459b8,_0x5045a9);}};downloadMediaTasks['set'](_0x2d0a8b[_0x278905(0x91)](randomUUID),_0x3af552),_0x2d0a8b['aZTiU'](setTimeout,()=>{const _0x5d48c5=_0x278905;!_0x120aa7&&_0x455181[_0x5d48c5(0xc1)](_0x5b95fd,_0x455181[_0x5d48c5(0xae)]);},_0x394fc0),napCatCore['session'][_0x278905(0x9e)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x902efc,'chatType':_0x1f26c2,'peerUid':_0x46dc93,'elementId':_0x29c584,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x31bb38});});}static async[_0x3ed193(0xc0)](_0x1b920a){const _0x51934d={'mTesp':function(_0x773e70,_0x30210a){return _0x773e70(_0x30210a);},'eTPFo':function(_0x56a357,_0x24f60d,_0x11d057){return _0x56a357(_0x24f60d,_0x11d057);}};return new Promise((_0x27150f,_0x1c4743)=>{const _0x27fe86=_0x1348,_0x457306={'dQiNU':function(_0x3181f7,_0x2c259a){const _0x12fef1=_0x1348;return _0x51934d[_0x12fef1(0xa6)](_0x3181f7,_0x2c259a);}};_0x51934d[_0x27fe86(0xad)](_0x1a2594,_0x1b920a,(_0x502324,_0x271717)=>{const _0x270514=_0x27fe86;_0x502324?_0x457306[_0x270514(0x7e)](_0x1c4743,_0x502324):_0x457306[_0x270514(0x7e)](_0x27150f,_0x271717);});});}static async[_0x3ed193(0x88)](_0x5f52b4,_0xbe20b5){const _0x4e9c1b=_0x3ed193,_0x3a098e={'fgCFB':_0x4e9c1b(0x9b),'hxjkt':'&rkey=','BndEZ':function(_0x1c76ec,_0x47e0c7){return _0x1c76ec+_0x47e0c7;},'GugPp':function(_0x17960a,_0x126602){return _0x17960a+_0x126602;},'Znuea':function(_0x4a0c51,_0x3dd9ce){return _0x4a0c51+_0x3dd9ce;},'LuNkD':function(_0x2d7e46,_0x53c27a){return _0x2d7e46||_0x53c27a;},'yVbVv':function(_0xf1d85a,_0x14e355,_0x2993e2){return _0xf1d85a(_0x14e355,_0x2993e2);},'JKvqf':_0x4e9c1b(0x9c)};if(!_0x5f52b4)return'';const _0x31e079=_0x5f52b4[_0x4e9c1b(0xb6)],_0x47390c=_0x5f52b4['md5HexStr'],_0x3513bc=_0x5f52b4[_0x4e9c1b(0xb7)],_0x38be27=_0x5f52b4[_0x4e9c1b(0xbf)];if(_0x31e079){if(_0x31e079[_0x4e9c1b(0xa0)](_0x3a098e['fgCFB'])){if(_0x31e079[_0x4e9c1b(0xa2)](_0x3a098e[_0x4e9c1b(0x85)]))return _0x3a098e['BndEZ'](IMAGE_HTTP_HOST_NT,_0x31e079);const _0x51ec55=await rkeyManager[_0x4e9c1b(0x7c)](),_0x300858=_0xbe20b5?_0x51ec55['private_rkey']:_0x51ec55[_0x4e9c1b(0x98)];return _0x3a098e[_0x4e9c1b(0x78)](_0x3a098e['GugPp'](IMAGE_HTTP_HOST_NT,_0x31e079),''+_0x300858);}else return _0x3a098e[_0x4e9c1b(0x9a)](IMAGE_HTTP_HOST,_0x31e079);}else{if(_0x3a098e[_0x4e9c1b(0x87)](_0x3513bc,_0x47390c))return IMAGE_HTTP_HOST+_0x4e9c1b(0x99)+(_0x3513bc||_0x47390c)['toUpperCase']()+'/0';}return _0x3a098e[_0x4e9c1b(0x81)](logDebug,_0x3a098e[_0x4e9c1b(0x92)],_0x5f52b4),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x325139=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x3ed193(0xa1)](_0x11c598=[_0x3ed193(0xa8),_0x3ed193(0x90)]){const _0x487dfc=_0x3ed193;return napCatCore[_0x487dfc(0x93)][_0x487dfc(0x7f)]()[_0x487dfc(0xbc)](_0x11c598);}static[_0x3ed193(0xb2)](_0x46f4e9={}){const _0x527795=_0x3ed193;return napCatCore[_0x527795(0x93)][_0x527795(0x7f)]()[_0x527795(0x96)](_0x46f4e9);}static[_0x3ed193(0x82)](){const _0x6585d1=_0x3ed193;return napCatCore['session'][_0x6585d1(0x7f)]()[_0x6585d1(0x82)]();}static['getHotUpdateCachePath'](){return'';}static[_0x3ed193(0xc3)](){return'';}static[_0x3ed193(0x8b)](_0x22eb7a,_0x3c44af=0x3e8,_0x2a0749=0x0){const _0x28887c=_0x3ed193;return napCatCore[_0x28887c(0x93)][_0x28887c(0x7f)]()[_0x28887c(0x8f)](_0x22eb7a,_0x3c44af,0x1,_0x2a0749);}static[_0x3ed193(0x84)](_0x211360,_0x46a045=0x3e8,_0x172f03){const _0x5e986f=_0x172f03?_0x172f03:{'fileType':_0x211360};}static async[_0x3ed193(0x8c)](_0x856cf9=[],_0x314910=[]){return napCatCore['session']['getStorageCleanService']()['clearChatCacheInfo'](_0x856cf9,_0x314910);}}