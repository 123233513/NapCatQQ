const _0x179571=_0x2e79;(function(_0x457e07,_0x5ba9f7){const _0x5eda17=_0x2e79,_0x42a7f4=_0x457e07();while(!![]){try{const _0x16ea6c=-parseInt(_0x5eda17(0x102))/0x1*(-parseInt(_0x5eda17(0x107))/0x2)+-parseInt(_0x5eda17(0xd8))/0x3+parseInt(_0x5eda17(0x101))/0x4+parseInt(_0x5eda17(0xf8))/0x5+parseInt(_0x5eda17(0xfb))/0x6+parseInt(_0x5eda17(0xe0))/0x7+-parseInt(_0x5eda17(0xd6))/0x8;if(_0x16ea6c===_0x5ba9f7)break;else _0x42a7f4['push'](_0x42a7f4['shift']());}catch(_0x4bcee5){_0x42a7f4['push'](_0x42a7f4['shift']());}}}(_0x3c7d,0x84b52));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x3c7d(){const _0x2bef81=['md5HexStr','4249536rmmQmT','23671BpkMyv','&rkey=','getHotUpdateCachePath','session','util','14GdZMAa','onRichMediaDownloadComplete','PIC','msgId','yNsfc','nQAmE','DhSJB','addCacheScanedPaths','includes','downloadRichMedia','addCacheScannedPaths','getFileType','fileUuid','copyFile','ojMge','下载超时','图片url获取失败','EaRKs','TPzXy','getChatCacheInfo','3838960bkAexS','/download','3033579vPLgOA','clearCache','set','startsWith','getRichMediaFilePathForGuild','fileTypeFromFile','defaultFileDownloadPath','getFileSize','4625089dPXTCw','getRkey','uploadFile','onLoginSuccess','indexOf','getDesktopTmpPath','Omcrh','lhiSs','getChatCacheList','getImageSize','qovxo','tmp','setCacheSilentScan','ext','addListener','qOopy','toUpperCase','unlink','hotUpdate','AngFY','getMsgService','clearCacheDataByKeys','getStorageCleanService','GtzPZ','24520DUDvuj','clearChatCache','basename','845526qGoDlW','existsSync','MnlST','downloadMedia','getCacheSessionPathList'];_0x3c7d=function(){return _0x2bef81;};return _0x3c7d();}import _0x42f039 from'path';import _0x1acb0e from'fs';import _0x25845f from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x120548 from'file-type';import{MsgListener}from'@/core/listeners';import _0x3e0c0a from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x2e79(_0x16e87d,_0x142e1e){const _0x3c7dcb=_0x3c7d();return _0x2e79=function(_0x2e7997,_0x148c9f){_0x2e7997=_0x2e7997-0xc5;let _0x231ea=_0x3c7dcb[_0x2e7997];return _0x231ea;},_0x2e79(_0x16e87d,_0x142e1e);}const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x179571(0x108)]=_0x3bf99e=>{const _0x532445={'pWMmX':function(_0x56cb44,_0x273cef){return _0x56cb44(_0x273cef);}};for(const [_0xd29f6c,_0x497297]of downloadMediaTasks){_0x532445['pWMmX'](_0x497297,_0x3bf99e),downloadMediaTasks['delete'](_0xd29f6c);}},setTimeout(()=>{const _0x404e09=_0x179571;napCatCore[_0x404e09(0xe3)](()=>{const _0x19f583=_0x404e09;napCatCore[_0x19f583(0xee)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x179571(0xcd)](_0x344fe9){const _0x22cd48=_0x179571;return _0x120548[_0x22cd48(0xdd)](_0x344fe9);}static async[_0x179571(0xcf)](_0x57d0f8,_0x1593a4){const _0x113924=_0x179571;await napCatCore[_0x113924(0x106)]['copyFile'](_0x57d0f8,_0x1593a4);}static async[_0x179571(0xdf)](_0x2f51b2){const _0x244d75=_0x179571;return await napCatCore[_0x244d75(0x106)][_0x244d75(0xdf)](_0x2f51b2);}static async[_0x179571(0xe2)](_0x5e9c47,_0x2ca2bc=ElementType[_0x179571(0x109)],_0x3069b4=0x0){const _0x392aa4=_0x179571,_0x29c6ed={'MnlST':function(_0x2e2994,_0x5260e8){return _0x2e2994(_0x5260e8);},'lhiSs':function(_0x2bbcc1,_0x5276c6){return _0x2bbcc1+_0x5276c6;},'TfqqN':function(_0x3ef672,_0x1b6e15){return _0x3ef672===_0x1b6e15;}},_0x477970=await _0x29c6ed[_0x392aa4(0xfd)](calculateFileMD5,_0x5e9c47);let _0x49c290=(await NTQQFileApi[_0x392aa4(0xcd)](_0x5e9c47))?.[_0x392aa4(0xed)]||'';_0x49c290&&(_0x49c290=_0x29c6ed[_0x392aa4(0xe7)]('.',_0x49c290));let _0x415c07=''+_0x42f039[_0x392aa4(0xfa)](_0x5e9c47);_0x29c6ed['TfqqN'](_0x415c07[_0x392aa4(0xe4)]('.'),-0x1)&&(_0x415c07+=_0x49c290);const _0x434296=napCatCore['session'][_0x392aa4(0xf4)]()[_0x392aa4(0xdc)]({'md5HexStr':_0x477970,'fileName':_0x415c07,'elementType':_0x2ca2bc,'elementSubType':_0x3069b4,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x392aa4(0xcf)](_0x5e9c47,_0x434296);const _0x4219ff=await NTQQFileApi[_0x392aa4(0xdf)](_0x5e9c47);return{'md5':_0x477970,'fileName':_0x415c07,'path':_0x434296,'fileSize':_0x4219ff,'ext':_0x49c290};}static async[_0x179571(0xfe)](_0x26265e,_0x2f4198,_0x12cf70,_0x5e0d04,_0x2850ff,_0x86b086,_0x36b685=0x3e8*0x3c*0x2,_0x7325e2=![]){const _0x2e71ee=_0x179571,_0x223992={'EaRKs':function(_0x5222a3,_0x1508ec){return _0x5222a3(_0x1508ec);},'nQAmE':_0x2e71ee(0xd1),'goIks':function(_0x47abc3,_0x578ff4){return _0x47abc3===_0x578ff4;},'Omcrh':function(_0x54eb7f,_0x2dbb92){return _0x54eb7f(_0x2dbb92);},'AngFY':function(_0x321842,_0x5aef2d,_0x4811b3){return _0x321842(_0x5aef2d,_0x4811b3);}};if(_0x86b086&&_0x1acb0e[_0x2e71ee(0xfc)](_0x86b086)){if(_0x7325e2)try{await _0x25845f[_0x2e71ee(0xf1)](_0x86b086);}catch(_0x3687e7){}else return _0x86b086;}return new Promise((_0x4c5639,_0x42af82)=>{const _0x100e5d=_0x2e71ee,_0x5dfb9d={'grZar':function(_0x38e9c1,_0x47cb68){return _0x223992['goIks'](_0x38e9c1,_0x47cb68);},'dcRJh':function(_0x4e3725,_0xa0e9c1){const _0x3d4778=_0x2e79;return _0x223992[_0x3d4778(0xe6)](_0x4e3725,_0xa0e9c1);}};let _0x3b567b=![];const _0x38952b=_0x528538=>{const _0x4d2bf6=_0x2e79;if(_0x5dfb9d['grZar'](_0x528538[_0x4d2bf6(0xc5)],_0x26265e)){_0x3b567b=!![];let _0x50c186=_0x528538['filePath'];if(_0x50c186[_0x4d2bf6(0xdb)]('\x5c')){const _0x1554c4=sessionConfig[_0x4d2bf6(0xde)];_0x50c186=_0x42f039['join'](_0x1554c4,_0x50c186);}_0x5dfb9d['dcRJh'](_0x4c5639,_0x50c186);}};downloadMediaTasks[_0x100e5d(0xda)](randomUUID(),_0x38952b),_0x223992[_0x100e5d(0xf3)](setTimeout,()=>{const _0x3b7ba3=_0x100e5d;!_0x3b567b&&_0x223992[_0x3b7ba3(0xd3)](_0x42af82,_0x223992[_0x3b7ba3(0xc7)]);},_0x36b685),napCatCore['session']['getMsgService']()[_0x100e5d(0xcb)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x26265e,'chatType':_0x2f4198,'peerUid':_0x12cf70,'elementId':_0x5e0d04,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2850ff});});}static async[_0x179571(0xe9)](_0x105575){const _0x39497a={'gerLz':function(_0x9b32e,_0x4f1f76,_0x49543a){return _0x9b32e(_0x4f1f76,_0x49543a);}};return new Promise((_0x26de94,_0x3c46bb)=>{_0x39497a['gerLz'](_0x3e0c0a,_0x105575,(_0x294a91,_0x546f57)=>{_0x294a91?_0x3c46bb(_0x294a91):_0x26de94(_0x546f57);});});}static async['getImageUrl'](_0x11ce59,_0x51bde6){const _0x515e84=_0x179571,_0x5e2e25={'DhSJB':_0x515e84(0xd7),'GtzPZ':_0x515e84(0x103),'qovxo':function(_0x5022e1,_0x2c6979){return _0x5022e1+_0x2c6979;},'qFdrm':function(_0x78acde,_0x292c11){return _0x78acde+_0x292c11;},'qOopy':function(_0x26bfef,_0x30fe33){return _0x26bfef+_0x30fe33;},'ojMge':function(_0x59143b,_0xa03045){return _0x59143b||_0xa03045;},'TPzXy':function(_0x11fe9b,_0x78146d){return _0x11fe9b||_0x78146d;},'yNsfc':function(_0x576382,_0x1a9af0,_0x5d6413){return _0x576382(_0x1a9af0,_0x5d6413);}};if(!_0x11ce59)return'';const _0x210af6=_0x11ce59['originImageUrl'],_0x2c0145=_0x11ce59[_0x515e84(0x100)],_0x42265e=_0x11ce59['md5HexStr'],_0x50e521=_0x11ce59[_0x515e84(0xce)];if(_0x210af6){if(_0x210af6['startsWith'](_0x5e2e25[_0x515e84(0xc8)])){if(_0x210af6[_0x515e84(0xca)](_0x5e2e25[_0x515e84(0xf7)]))return _0x5e2e25[_0x515e84(0xea)](IMAGE_HTTP_HOST_NT,_0x210af6);const _0x500d20=await rkeyManager[_0x515e84(0xe1)](),_0x4c333a=_0x51bde6?_0x500d20['private_rkey']:_0x500d20['group_rkey'];return _0x5e2e25['qFdrm'](_0x5e2e25[_0x515e84(0xea)](IMAGE_HTTP_HOST_NT,_0x210af6),''+_0x4c333a);}else return _0x5e2e25[_0x515e84(0xef)](IMAGE_HTTP_HOST,_0x210af6);}else{if(_0x5e2e25[_0x515e84(0xd0)](_0x42265e,_0x2c0145))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x5e2e25[_0x515e84(0xd4)](_0x42265e,_0x2c0145)[_0x515e84(0xf0)]()+'/0';}return _0x5e2e25[_0x515e84(0xc6)](logDebug,_0x515e84(0xd2),_0x11ce59),'';}}export class NTQQFileCacheApi{static async[_0x179571(0xec)](_0x54e330=!![]){return'';}static[_0x179571(0xff)](){return'';}static[_0x179571(0xd9)](_0x178c45=[_0x179571(0xeb),_0x179571(0xf2)]){const _0x514b3f=_0x179571;return napCatCore['session'][_0x514b3f(0xf6)]()[_0x514b3f(0xf5)](_0x178c45);}static[_0x179571(0xcc)](_0x54b5cf={}){const _0x3c7367=_0x179571;return napCatCore[_0x3c7367(0x105)][_0x3c7367(0xf6)]()[_0x3c7367(0xc9)](_0x54b5cf);}static['scanCache'](){const _0x23768e=_0x179571;return napCatCore[_0x23768e(0x105)]['getStorageCleanService']()['scanCache']();}static[_0x179571(0x104)](){return'';}static[_0x179571(0xe5)](){return'';}static[_0x179571(0xe8)](_0x263373,_0x505a9d=0x3e8,_0x124075=0x0){const _0x199546=_0x179571;return napCatCore[_0x199546(0x105)][_0x199546(0xf6)]()[_0x199546(0xd5)](_0x263373,_0x505a9d,0x1,_0x124075);}static['getFileCacheInfo'](_0x361a0e,_0x5eecf8=0x3e8,_0x27f368){const _0x584a7e=_0x27f368?_0x27f368:{'fileType':_0x361a0e};}static async[_0x179571(0xf9)](_0x3f42bd=[],_0x137493=[]){const _0x5b39d2=_0x179571;return napCatCore[_0x5b39d2(0x105)][_0x5b39d2(0xf6)]()['clearChatCacheInfo'](_0x3f42bd,_0x137493);}}