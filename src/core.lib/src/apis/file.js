const _0x463730=_0x5bc9;function _0x254f(){const _0x47b692=['4160886tdRMIQ','getHotUpdateCachePath','addCacheScanedPaths','util','getFileType','clearCache','10419054UZBPSp','toUpperCase','clearChatCache','msgId','getRichMediaFilePathForGuild','includes','Doqxo','clearCacheDataByKeys','set','图片url获取失败','filePath','getChatCacheInfo','startsWith','tmp','6qymWGq','getImageUrl','mZfNp','join','onRichMediaDownloadComplete','defaultFileDownloadPath','rGBdj','4ZFZipf','611389GBLsTq','getImageSize','mySeY','fileUuid','getCacheSessionPathList','uploadFile','md5HexStr','PIC','copyFile','getStorageCleanService','getChatCacheList','getDesktopTmpPath','/download','getFileSize','getRkey','originImageUrl','56prqgRx','hvSBn','ext','CtNoa','scanCache','ZCEmf','getMsgService','addCacheScannedPaths','tFgbc','9187920KFmfbB','AfzMo','fileTypeFromFile','uKGEO','1072184BSaXpe','downloadRichMedia','unlink','JVZWR','7419130AZVHwe','oPlAg','onLoginSuccess','1083699HjXmiZ','getFileCacheInfo','clearChatCacheInfo','session'];_0x254f=function(){return _0x47b692;};return _0x254f();}(function(_0x57cad8,_0x4b2039){const _0x466adf=_0x5bc9,_0x116eef=_0x57cad8();while(!![]){try{const _0x1021a7=parseInt(_0x466adf(0x11f))/0x1*(parseInt(_0x466adf(0x117))/0x2)+-parseInt(_0x466adf(0x103))/0x3+-parseInt(_0x466adf(0x11e))/0x4*(parseInt(_0x466adf(0xfc))/0x5)+parseInt(_0x466adf(0x109))/0x6+-parseInt(_0x466adf(0x12f))/0x7*(-parseInt(_0x466adf(0xf8))/0x8)+parseInt(_0x466adf(0xff))/0x9+-parseInt(_0x466adf(0xf4))/0xa;if(_0x1021a7===_0x4b2039)break;else _0x116eef['push'](_0x116eef['shift']());}catch(_0xbdf136){_0x116eef['push'](_0x116eef['shift']());}}}(_0x254f,0xedb7b));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x30d104 from'path';import _0x14504e from'fs';function _0x5bc9(_0x297afb,_0x1d2ee6){const _0x254fdc=_0x254f();return _0x5bc9=function(_0x5bc915,_0x458799){_0x5bc915=_0x5bc915-0xf4;let _0x407e7b=_0x254fdc[_0x5bc915];return _0x407e7b;},_0x5bc9(_0x297afb,_0x1d2ee6);}import _0x14714a from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x32b25f from'file-type';import{MsgListener}from'@/core/listeners';import _0x418758 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x463730(0x11b)]=_0x1d9b5a=>{for(const [_0x1ed655,_0x4688c5]of downloadMediaTasks){_0x4688c5(_0x1d9b5a),downloadMediaTasks['delete'](_0x1ed655);}},setTimeout(()=>{const _0x52f133=_0x463730;napCatCore[_0x52f133(0xfe)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x463730(0x107)](_0x25f05e){const _0x3466c7=_0x463730;return _0x32b25f[_0x3466c7(0xf6)](_0x25f05e);}static async[_0x463730(0x127)](_0x506a76,_0x2a9a5c){const _0x3559f9=_0x463730;await napCatCore['util'][_0x3559f9(0x127)](_0x506a76,_0x2a9a5c);}static async[_0x463730(0x12c)](_0x1d0f14){const _0x1af303=_0x463730;return await napCatCore[_0x1af303(0x106)][_0x1af303(0x12c)](_0x1d0f14);}static async[_0x463730(0x124)](_0x25f818,_0x509700=ElementType[_0x463730(0x126)],_0x4b6e1c=0x0){const _0x3d7323=_0x463730,_0x4675d4={'Doqxo':function(_0x103348,_0xa39f79){return _0x103348(_0xa39f79);},'tFgbc':function(_0x26d66c,_0x21f5b9){return _0x26d66c+_0x21f5b9;},'mZfNp':function(_0x5cea31,_0x195db9){return _0x5cea31===_0x195db9;}},_0x20a680=await _0x4675d4[_0x3d7323(0x10f)](calculateFileMD5,_0x25f818);let _0x537682=(await NTQQFileApi['getFileType'](_0x25f818))?.[_0x3d7323(0x131)]||'';_0x537682&&(_0x537682=_0x4675d4[_0x3d7323(0x137)]('.',_0x537682));let _0x3d2b3e=''+_0x30d104['basename'](_0x25f818);_0x4675d4[_0x3d7323(0x119)](_0x3d2b3e['indexOf']('.'),-0x1)&&(_0x3d2b3e+=_0x537682);const _0x6687b8=napCatCore['session'][_0x3d7323(0x135)]()[_0x3d7323(0x10d)]({'md5HexStr':_0x20a680,'fileName':_0x3d2b3e,'elementType':_0x509700,'elementSubType':_0x4b6e1c,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x25f818,_0x6687b8);const _0x24c82b=await NTQQFileApi[_0x3d7323(0x12c)](_0x25f818);return{'md5':_0x20a680,'fileName':_0x3d2b3e,'path':_0x6687b8,'fileSize':_0x24c82b,'ext':_0x537682};}static async['downloadMedia'](_0x3ae782,_0x261335,_0x10f5d9,_0x22117f,_0x2b4208,_0x59926a,_0x294f03=0x3e8*0x3c*0x2,_0x3d73ec=![]){const _0x3103af=_0x463730,_0x9ece03={'AfzMo':function(_0x1128a1,_0x33775e){return _0x1128a1===_0x33775e;},'mySeY':function(_0x3293e7,_0x184022){return _0x3293e7(_0x184022);},'bCRXj':function(_0x21fc0c,_0x330d21,_0x48c136){return _0x21fc0c(_0x330d21,_0x48c136);}};if(_0x59926a&&_0x14504e['existsSync'](_0x59926a)){if(_0x3d73ec)try{await _0x14714a[_0x3103af(0xfa)](_0x59926a);}catch(_0x217101){}else return _0x59926a;}return new Promise((_0xd5ee0a,_0x217f6f)=>{const _0x321c8f=_0x3103af,_0x1ed068={'qdIxd':function(_0x102830,_0x150f59){return _0x9ece03['mySeY'](_0x102830,_0x150f59);}};let _0xf63f2e=![];const _0x17fc77=_0x4449b6=>{const _0x2ca264=_0x5bc9;if(_0x9ece03[_0x2ca264(0xf5)](_0x4449b6[_0x2ca264(0x10c)],_0x3ae782)){_0xf63f2e=!![];let _0x1a4b52=_0x4449b6[_0x2ca264(0x113)];if(_0x1a4b52[_0x2ca264(0x115)]('\x5c')){const _0x5465a5=sessionConfig[_0x2ca264(0x11c)];_0x1a4b52=_0x30d104[_0x2ca264(0x11a)](_0x5465a5,_0x1a4b52);}_0x9ece03[_0x2ca264(0x121)](_0xd5ee0a,_0x1a4b52);}};downloadMediaTasks[_0x321c8f(0x111)](randomUUID(),_0x17fc77),_0x9ece03['bCRXj'](setTimeout,()=>{!_0xf63f2e&&_0x1ed068['qdIxd'](_0x217f6f,'下载超时');},_0x294f03),napCatCore[_0x321c8f(0x102)][_0x321c8f(0x135)]()[_0x321c8f(0xf9)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3ae782,'chatType':_0x261335,'peerUid':_0x10f5d9,'elementId':_0x22117f,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2b4208});});}static async[_0x463730(0x120)](_0x4321b0){const _0x13ffd8={'rGBdj':function(_0x46f889,_0x51d483,_0xe96eb){return _0x46f889(_0x51d483,_0xe96eb);}};return new Promise((_0x414124,_0x3e2a95)=>{const _0x149279=_0x5bc9,_0x5a94af={'oPlAg':function(_0x460fc1,_0x453eac){return _0x460fc1(_0x453eac);}};_0x13ffd8[_0x149279(0x11d)](_0x418758,_0x4321b0,(_0x196f32,_0x30db80)=>{const _0x19e203=_0x149279;_0x196f32?_0x5a94af[_0x19e203(0xfd)](_0x3e2a95,_0x196f32):_0x5a94af[_0x19e203(0xfd)](_0x414124,_0x30db80);});});}static async[_0x463730(0x118)](_0x3ca838,_0x30fbaf){const _0x2e56e4=_0x463730,_0x6d30c1={'ZCEmf':'&rkey=','uKGEO':function(_0x697460,_0x26d739){return _0x697460+_0x26d739;},'JVZWR':function(_0x2458b3,_0x1612dd){return _0x2458b3+_0x1612dd;},'CtNoa':function(_0x358fa9,_0x41e522){return _0x358fa9+_0x41e522;},'SKnnn':function(_0x5ea937,_0x102083,_0x5e7629){return _0x5ea937(_0x102083,_0x5e7629);},'hvSBn':_0x2e56e4(0x112)};if(!_0x3ca838)return'';const _0x27a4db=_0x3ca838[_0x2e56e4(0x12e)],_0x41ebeb=_0x3ca838[_0x2e56e4(0x125)],_0x443a4a=_0x3ca838['md5HexStr'],_0x4d9fad=_0x3ca838[_0x2e56e4(0x122)];if(_0x27a4db){if(_0x27a4db['startsWith'](_0x2e56e4(0x12b))){if(_0x27a4db[_0x2e56e4(0x10e)](_0x6d30c1[_0x2e56e4(0x134)]))return _0x6d30c1[_0x2e56e4(0xf7)](IMAGE_HTTP_HOST_NT,_0x27a4db);const _0x20f6a0=await rkeyManager[_0x2e56e4(0x12d)](),_0x1f9ae0=_0x30fbaf?_0x20f6a0['private_rkey']:_0x20f6a0['group_rkey'];return _0x6d30c1[_0x2e56e4(0xf7)](_0x6d30c1[_0x2e56e4(0xfb)](IMAGE_HTTP_HOST_NT,_0x27a4db),''+_0x1f9ae0);}else return _0x6d30c1[_0x2e56e4(0x132)](IMAGE_HTTP_HOST,_0x27a4db);}else{if(_0x443a4a||_0x41ebeb)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+(_0x443a4a||_0x41ebeb)[_0x2e56e4(0x10a)]()+'/0';}return _0x6d30c1['SKnnn'](logDebug,_0x6d30c1[_0x2e56e4(0x130)],_0x3ca838),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x5bc609=!![]){return'';}static[_0x463730(0x123)](){return'';}static[_0x463730(0x108)](_0xa79f9b=[_0x463730(0x116),'hotUpdate']){const _0x5659e4=_0x463730;return napCatCore[_0x5659e4(0x102)][_0x5659e4(0x128)]()[_0x5659e4(0x110)](_0xa79f9b);}static[_0x463730(0x136)](_0xae050e={}){const _0x109227=_0x463730;return napCatCore[_0x109227(0x102)]['getStorageCleanService']()[_0x109227(0x105)](_0xae050e);}static[_0x463730(0x133)](){const _0x3105a5=_0x463730;return napCatCore[_0x3105a5(0x102)]['getStorageCleanService']()[_0x3105a5(0x133)]();}static[_0x463730(0x104)](){return'';}static[_0x463730(0x12a)](){return'';}static[_0x463730(0x129)](_0x4c0dd1,_0x10c3d6=0x3e8,_0x27f7e=0x0){const _0x5302ae=_0x463730;return napCatCore[_0x5302ae(0x102)][_0x5302ae(0x128)]()[_0x5302ae(0x114)](_0x4c0dd1,_0x10c3d6,0x1,_0x27f7e);}static[_0x463730(0x100)](_0x4d2490,_0x5aa851=0x3e8,_0x3e00b0){const _0x5543e5=_0x3e00b0?_0x3e00b0:{'fileType':_0x4d2490};}static async[_0x463730(0x10b)](_0x50db51=[],_0x526c55=[]){const _0x5bf969=_0x463730;return napCatCore[_0x5bf969(0x102)][_0x5bf969(0x128)]()[_0x5bf969(0x101)](_0x50db51,_0x526c55);}}