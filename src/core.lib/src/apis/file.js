const _0x394aac=_0x2018;(function(_0x14ff8d,_0x19d1a5){const _0x8061a9=_0x2018,_0x41fa8b=_0x14ff8d();while(!![]){try{const _0x123ad5=parseInt(_0x8061a9(0x1e4))/0x1+parseInt(_0x8061a9(0x1e9))/0x2+parseInt(_0x8061a9(0x214))/0x3*(-parseInt(_0x8061a9(0x1e3))/0x4)+parseInt(_0x8061a9(0x1e8))/0x5+-parseInt(_0x8061a9(0x1ff))/0x6+parseInt(_0x8061a9(0x1f5))/0x7*(-parseInt(_0x8061a9(0x1f8))/0x8)+-parseInt(_0x8061a9(0x1f7))/0x9*(parseInt(_0x8061a9(0x1df))/0xa);if(_0x123ad5===_0x19d1a5)break;else _0x41fa8b['push'](_0x41fa8b['shift']());}catch(_0x2cfc69){_0x41fa8b['push'](_0x41fa8b['shift']());}}}(_0x1ed1,0x18960));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x35c56e from'path';import _0x31230d from'fs';import _0x379e89 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x472367 from'file-type';import{MsgListener}from'@/core/listeners';import _0x4ae0ef from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';function _0x2018(_0x379536,_0x30367d){const _0x1ed10a=_0x1ed1();return _0x2018=function(_0x2018ab,_0xc77c25){_0x2018ab=_0x2018ab-0x1d6;let _0x4dc9c3=_0x1ed10a[_0x2018ab];return _0x4dc9c3;},_0x2018(_0x379536,_0x30367d);}import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x24f55a=>{for(const [_0x46cc83,_0x1c93b4]of downloadMediaTasks){_0x1c93b4(_0x24f55a),downloadMediaTasks['delete'](_0x46cc83);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x14db21=_0x2018;napCatCore[_0x14db21(0x1ec)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x394aac(0x216)](_0x4a0f44){const _0x5a5fef=_0x394aac;return _0x472367[_0x5a5fef(0x1d6)](_0x4a0f44);}static async[_0x394aac(0x219)](_0x1ef9de,_0x3eedbb){const _0x517654=_0x394aac;await napCatCore['util'][_0x517654(0x219)](_0x1ef9de,_0x3eedbb);}static async[_0x394aac(0x201)](_0x508f2e){const _0x528a7a=_0x394aac;return await napCatCore[_0x528a7a(0x206)][_0x528a7a(0x201)](_0x508f2e);}static async[_0x394aac(0x204)](_0x18ae07,_0x34c6bf=ElementType['PIC'],_0x26b9a2=0x0){const _0x5280e3=_0x394aac,_0xaf1db1={'tSoVA':function(_0x5c1747,_0x32878c){return _0x5c1747(_0x32878c);},'ZXnci':function(_0x4bc4cb,_0x48be50){return _0x4bc4cb+_0x48be50;},'CINES':function(_0xf18603,_0x3b58a0){return _0xf18603===_0x3b58a0;}},_0x2b6962=await _0xaf1db1[_0x5280e3(0x1fb)](calculateFileMD5,_0x18ae07);let _0x1ba7a3=(await NTQQFileApi[_0x5280e3(0x216)](_0x18ae07))?.[_0x5280e3(0x224)]||'';_0x1ba7a3&&(_0x1ba7a3=_0xaf1db1[_0x5280e3(0x1e0)]('.',_0x1ba7a3));let _0x5ba0c0=''+_0x35c56e[_0x5280e3(0x200)](_0x18ae07);_0xaf1db1['CINES'](_0x5ba0c0[_0x5280e3(0x1db)]('.'),-0x1)&&(_0x5ba0c0+=_0x1ba7a3);const _0x441f71=napCatCore[_0x5280e3(0x209)][_0x5280e3(0x21d)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x2b6962,'fileName':_0x5ba0c0,'elementType':_0x34c6bf,'elementSubType':_0x26b9a2,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x5280e3(0x219)](_0x18ae07,_0x441f71);const _0x3cb7fc=await NTQQFileApi[_0x5280e3(0x201)](_0x18ae07);return{'md5':_0x2b6962,'fileName':_0x5ba0c0,'path':_0x441f71,'fileSize':_0x3cb7fc,'ext':_0x1ba7a3};}static async['downloadMedia'](_0x3a9fd8,_0x5b031b,_0x106ccb,_0x1d94f7,_0x563d36,_0x26c66d,_0x240d14=0x3e8*0x3c*0x2,_0x50c0cf=![]){const _0x3ab05f=_0x394aac,_0x239864={'wRBVA':function(_0x3eff9b,_0x35002e){return _0x3eff9b(_0x35002e);},'ZVDjN':_0x3ab05f(0x1d9),'Outbi':_0x3ab05f(0x1d7),'ETfLn':function(_0x5682f8,_0x4a175c){return _0x5682f8===_0x4a175c;},'Wcehp':function(_0x3d789a,_0x522f9d,_0xf07614){return _0x3d789a(_0x522f9d,_0xf07614);},'dRAyE':_0x3ab05f(0x1fa),'ctSpk':function(_0x184886,_0x3d82d2,_0x4d0281,_0x9589aa,_0xe26981,_0x425a35,_0x172100,_0x299931,_0x5d3ffe,_0x13cf27){return _0x184886(_0x3d82d2,_0x4d0281,_0x9589aa,_0xe26981,_0x425a35,_0x172100,_0x299931,_0x5d3ffe,_0x13cf27);},'IOmNZ':function(_0x3d217b,_0x545483,_0x460f14,_0x4bae7c,_0x2caf6b,_0x37af5f,_0x75483f,_0x5d5981,_0x2ad0d2,_0x202b6d){return _0x3d217b(_0x545483,_0x460f14,_0x4bae7c,_0x2caf6b,_0x37af5f,_0x75483f,_0x5d5981,_0x2ad0d2,_0x202b6d);},'DSVvE':_0x3ab05f(0x20a)};_0x239864[_0x3ab05f(0x203)](logDebug,_0x3ab05f(0x21f),_0x3a9fd8,_0x5b031b,_0x106ccb,_0x1d94f7,_0x563d36,_0x26c66d,_0x240d14,_0x50c0cf);if(_0x26c66d&&_0x31230d[_0x3ab05f(0x21a)](_0x26c66d)){if(_0x50c0cf)try{await _0x379e89[_0x3ab05f(0x1de)](_0x26c66d);}catch(_0x1b0209){}else return _0x26c66d;}return _0x239864[_0x3ab05f(0x1f9)](logDebug,_0x239864['DSVvE'],_0x3a9fd8,_0x5b031b,_0x106ccb,_0x1d94f7,_0x563d36,_0x26c66d,_0x240d14,_0x50c0cf),new Promise((_0x298ed6,_0x46ea49)=>{const _0x1a7068=_0x3ab05f,_0x28485e={'PFUTl':function(_0x1a9695,_0x4ce925,_0x3c7b49,_0xef3c3d){return _0x1a9695(_0x4ce925,_0x3c7b49,_0xef3c3d);},'XOIAs':_0x239864[_0x1a7068(0x1fe)],'ncjTE':function(_0x45e778,_0x42d897){const _0x4220ed=_0x1a7068;return _0x239864[_0x4220ed(0x1ee)](_0x45e778,_0x42d897);},'syJkI':function(_0x1bb188,_0x50bf57,_0x59b308){const _0x9b9a94=_0x1a7068;return _0x239864[_0x9b9a94(0x21e)](_0x1bb188,_0x50bf57,_0x59b308);},'BcoKr':_0x239864[_0x1a7068(0x220)]};let _0x40d736=![];const _0x523ff5=_0xc7407=>{const _0x223e84=_0x1a7068;_0x28485e[_0x223e84(0x202)](logDebug,_0x28485e[_0x223e84(0x1e2)],_0xc7407,_0x3a9fd8);if(_0x28485e[_0x223e84(0x225)](_0xc7407[_0x223e84(0x1f3)],_0x3a9fd8)){_0x40d736=!![];let _0x557bd5=_0xc7407[_0x223e84(0x1e6)];if(_0x557bd5[_0x223e84(0x20b)]('\x5c')){const _0x1602f2=sessionConfig[_0x223e84(0x212)];_0x28485e[_0x223e84(0x1d8)](logDebug,_0x28485e[_0x223e84(0x1eb)],_0x1602f2),_0x557bd5=_0x35c56e[_0x223e84(0x215)](_0x1602f2,_0x557bd5);}_0x298ed6(_0x557bd5);}};downloadMediaTasks[_0x1a7068(0x1ea)](randomUUID(),_0x523ff5),_0x239864[_0x1a7068(0x21e)](setTimeout,()=>{const _0x4adcdb=_0x1a7068;!_0x40d736&&_0x239864['wRBVA'](_0x46ea49,_0x239864[_0x4adcdb(0x205)]);},_0x240d14),napCatCore[_0x1a7068(0x209)][_0x1a7068(0x21d)]()[_0x1a7068(0x1ed)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3a9fd8,'chatType':_0x5b031b,'peerUid':_0x106ccb,'elementId':_0x1d94f7,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x563d36});});}static async['getImageSize'](_0x5cb7fa){const _0x1b89ee={'hhXfo':function(_0x1db512,_0x13034b){return _0x1db512(_0x13034b);},'mvIAd':function(_0x2e25b9,_0x4a02b7,_0x2fd6b1){return _0x2e25b9(_0x4a02b7,_0x2fd6b1);}};return new Promise((_0x20896a,_0x49f068)=>{const _0x5516bc=_0x2018;_0x1b89ee[_0x5516bc(0x1e1)](_0x4ae0ef,_0x5cb7fa,(_0x34527d,_0x4e0ed7)=>{const _0x1e34ef=_0x5516bc;_0x34527d?_0x49f068(_0x34527d):_0x1b89ee[_0x1e34ef(0x1ef)](_0x20896a,_0x4e0ed7);});});}static async[_0x394aac(0x1f1)](_0x20a980,_0x1a00c3){const _0xe1125f=_0x394aac,_0x39f448={'QAiZp':_0xe1125f(0x1da),'zwfvX':_0xe1125f(0x21b),'ytjSn':function(_0x1a4ba0,_0x5d625d){return _0x1a4ba0+_0x5d625d;},'IWdzC':function(_0x33eb27,_0x1f6153){return _0x33eb27||_0x1f6153;},'AbZqz':_0xe1125f(0x207)};if(!_0x20a980)return'';const _0x11cf02=_0x20a980[_0xe1125f(0x1e7)],_0x4b9dd2=_0x20a980['md5HexStr'],_0x5f0e11=_0x20a980['md5HexStr'],_0x5518cb=_0x20a980['fileUuid'];if(_0x11cf02){if(_0x11cf02[_0xe1125f(0x20b)](_0x39f448[_0xe1125f(0x20d)])){if(_0x11cf02[_0xe1125f(0x208)](_0x39f448[_0xe1125f(0x20f)]))return _0x39f448[_0xe1125f(0x1dd)](IMAGE_HTTP_HOST_NT,_0x11cf02);const _0x55437d=await rkeyManager['getRkey'](),_0x46d58e=_0x1a00c3?_0x55437d[_0xe1125f(0x1fd)]:_0x55437d[_0xe1125f(0x1f6)];return _0x39f448[_0xe1125f(0x1dd)](_0x39f448[_0xe1125f(0x1dd)](IMAGE_HTTP_HOST_NT,_0x11cf02),''+_0x46d58e);}else return IMAGE_HTTP_HOST+_0x11cf02;}else{if(_0x5f0e11||_0x4b9dd2)return IMAGE_HTTP_HOST+_0xe1125f(0x1dc)+_0x39f448['IWdzC'](_0x5f0e11,_0x4b9dd2)[_0xe1125f(0x1f4)]()+'/0';}return logDebug(_0x39f448[_0xe1125f(0x210)],_0x20a980),'';}}export class NTQQFileCacheApi{static async[_0x394aac(0x221)](_0x4a5347=!![]){return'';}static[_0x394aac(0x222)](){return'';}static[_0x394aac(0x217)](_0x25922b=[_0x394aac(0x21c),_0x394aac(0x1f2)]){const _0x286376=_0x394aac;return napCatCore[_0x286376(0x209)][_0x286376(0x20e)]()['clearCacheDataByKeys'](_0x25922b);}static[_0x394aac(0x218)](_0x12489b={}){const _0x791da9=_0x394aac;return napCatCore[_0x791da9(0x209)][_0x791da9(0x20e)]()[_0x791da9(0x1fc)](_0x12489b);}static[_0x394aac(0x213)](){const _0x9debc5=_0x394aac;return napCatCore[_0x9debc5(0x209)][_0x9debc5(0x20e)]()[_0x9debc5(0x213)]();}static[_0x394aac(0x1f0)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x394aac(0x20c)](_0x5f044d,_0x563d31=0x3e8,_0x4f2706=0x0){const _0x16642a=_0x394aac;return napCatCore[_0x16642a(0x209)][_0x16642a(0x20e)]()['getChatCacheInfo'](_0x5f044d,_0x563d31,0x1,_0x4f2706);}static[_0x394aac(0x1e5)](_0x3029bc,_0x108858=0x3e8,_0x5bf7b4){const _0x2470d0=_0x5bf7b4?_0x5bf7b4:{'fileType':_0x3029bc};}static async[_0x394aac(0x211)](_0xb7fdb2=[],_0x88388e=[]){const _0x54cdef=_0x394aac;return napCatCore[_0x54cdef(0x209)][_0x54cdef(0x20e)]()[_0x54cdef(0x223)](_0xb7fdb2,_0x88388e);}}function _0x1ed1(){const _0x36172d=['418090zAwsQC','ZXnci','mvIAd','XOIAs','5292WSlEBD','196030jEdjwX','getFileCacheInfo','filePath','originImageUrl','965020VvUGXj','299148xACWXe','set','BcoKr','addListener','downloadRichMedia','ETfLn','hhXfo','getHotUpdateCachePath','getImageUrl','hotUpdate','msgId','toUpperCase','413spFZGg','group_rkey','9TmcQcT','20360SzZQiN','IOmNZ','downloadPath','tSoVA','addCacheScanedPaths','private_rkey','Outbi','1150182YHzpTG','basename','getFileSize','PFUTl','ctSpk','uploadFile','ZVDjN','util','图片url获取失败','includes','session','start\x20downloadMedia','startsWith','getChatCacheList','QAiZp','getStorageCleanService','zwfvX','AbZqz','clearChatCache','defaultFileDownloadPath','scanCache','123pmbghc','join','getFileType','clearCache','addCacheScannedPaths','copyFile','existsSync','&rkey=','tmp','getMsgService','Wcehp','receive\x20downloadMedia\x20task','dRAyE','setCacheSilentScan','getCacheSessionPathList','clearChatCacheInfo','ext','ncjTE','fileTypeFromFile','downloadMedia\x20complete','syJkI','下载超时','/download','indexOf','/gchatpic_new/0/0-0-','ytjSn','unlink'];_0x1ed1=function(){return _0x36172d;};return _0x1ed1();}