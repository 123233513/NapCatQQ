const _0x3ba260=_0x379c;(function(_0x97b5be,_0x57b75c){const _0x16b5cb=_0x379c,_0xa2fbfb=_0x97b5be();while(!![]){try{const _0x6d8eb0=-parseInt(_0x16b5cb(0x16a))/0x1+parseInt(_0x16b5cb(0x159))/0x2+parseInt(_0x16b5cb(0x177))/0x3+-parseInt(_0x16b5cb(0x16f))/0x4+-parseInt(_0x16b5cb(0x185))/0x5*(-parseInt(_0x16b5cb(0x172))/0x6)+-parseInt(_0x16b5cb(0x151))/0x7+parseInt(_0x16b5cb(0x162))/0x8;if(_0x6d8eb0===_0x57b75c)break;else _0xa2fbfb['push'](_0xa2fbfb['shift']());}catch(_0x581e74){_0xa2fbfb['push'](_0xa2fbfb['shift']());}}}(_0x2b08,0xa4134));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x3a515d from'path';import _0x39324e from'fs';import _0x222f67 from'fs/promises';function _0x2b08(){const _0x2d3812=['fileTypeFromFile','5BfyzQT','FflMf','BMdVK','ObZun','scanCache','downloadPath','session','zVmxW','clearCache','defaultFileDownloadPath','join','getFileSize','group_rkey','set','hDFfV','5389013FizsLh','onRichMediaDownloadComplete','fileUuid','downloadMedia\x20complete','witZb','util','FPVvU','clearCacheDataByKeys','1400302xldZfs','addCacheScanedPaths','copyFile','PIC','图片url获取失败','ext','sTnHs','nzEct','unlink','3462136zPUDYH','getMsgService','getFileType','clearChatCacheInfo','originImageUrl','getChatCacheInfo','uploadFile','startsWith','426217SExyxM','filePath','JUKCX','下载超时','/gchatpic_new/0/0-0-','2683812eFNoQr','OhxCh','basename','742176SSjbqD','getDesktopTmpPath','includes','msgId','wreha','3847401eyAuDw','indexOf','md5HexStr','existsSync','getImageUrl','delete','onLoginSuccess','clearChatCache','getRkey','getChatCacheList','getStorageCleanService','addCacheScannedPaths','private_rkey'];_0x2b08=function(){return _0x2d3812;};return _0x2b08();}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0xb4cf3e from'file-type';import{MsgListener}from'@/core/listeners';import _0x50b3a3 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x3ba260(0x152)]=_0x504696=>{const _0x40cad5=_0x3ba260,_0xb50986={'HfUHQ':function(_0x152ea4,_0x284821){return _0x152ea4(_0x284821);}};for(const [_0xcba5f0,_0x269090]of downloadMediaTasks){_0xb50986['HfUHQ'](_0x269090,_0x504696),downloadMediaTasks[_0x40cad5(0x17c)](_0xcba5f0);}},setTimeout(()=>{const _0x38f20c=_0x3ba260;napCatCore[_0x38f20c(0x17d)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x3ba260(0x164)](_0xa294a1){const _0x3653a0=_0x3ba260;return _0xb4cf3e[_0x3653a0(0x184)](_0xa294a1);}static async[_0x3ba260(0x15b)](_0x57485c,_0x1f2e57){await napCatCore['util']['copyFile'](_0x57485c,_0x1f2e57);}static async[_0x3ba260(0x14d)](_0x5beda4){const _0x54cf25=_0x3ba260;return await napCatCore[_0x54cf25(0x156)][_0x54cf25(0x14d)](_0x5beda4);}static async[_0x3ba260(0x168)](_0xab444b,_0x88ac40=ElementType[_0x3ba260(0x15c)],_0x5b1006=0x0){const _0x5ec729=_0x3ba260,_0x312f26={'IPTXG':function(_0x3eefdf,_0x484c6c){return _0x3eefdf+_0x484c6c;},'ObZun':function(_0x6f08ec,_0xf22c7b){return _0x6f08ec===_0xf22c7b;}},_0x250645=await calculateFileMD5(_0xab444b);let _0x1c6c43=(await NTQQFileApi[_0x5ec729(0x164)](_0xab444b))?.[_0x5ec729(0x15e)]||'';_0x1c6c43&&(_0x1c6c43=_0x312f26['IPTXG']('.',_0x1c6c43));let _0x21fd39=''+_0x3a515d[_0x5ec729(0x171)](_0xab444b);_0x312f26[_0x5ec729(0x188)](_0x21fd39[_0x5ec729(0x178)]('.'),-0x1)&&(_0x21fd39+=_0x1c6c43);const _0x5781d7=napCatCore[_0x5ec729(0x18b)][_0x5ec729(0x163)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x250645,'fileName':_0x21fd39,'elementType':_0x88ac40,'elementSubType':_0x5b1006,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x5ec729(0x15b)](_0xab444b,_0x5781d7);const _0x1fd31c=await NTQQFileApi[_0x5ec729(0x14d)](_0xab444b);return{'md5':_0x250645,'fileName':_0x21fd39,'path':_0x5781d7,'fileSize':_0x1fd31c,'ext':_0x1c6c43};}static async['downloadMedia'](_0x227df9,_0x4ba7f8,_0x368827,_0x3b1f85,_0x2347a8,_0x188b95,_0x4e4605=0x3e8*0x3c*0x2,_0x48ebef=![]){const _0x4bc237=_0x3ba260,_0x135711={'FflMf':function(_0x1e7bbf,_0x4232ca){return _0x1e7bbf===_0x4232ca;},'IdSRI':_0x4bc237(0x16d),'JUKCX':function(_0x240043){return _0x240043();},'PnlxV':function(_0x4c62da,_0xeaf08f,_0x41bfac,_0x3b99ca,_0x3fc2fe,_0x57e280,_0x376f27,_0x198d97,_0x781f43,_0x171287){return _0x4c62da(_0xeaf08f,_0x41bfac,_0x3b99ca,_0x3fc2fe,_0x57e280,_0x376f27,_0x198d97,_0x781f43,_0x171287);}};_0x135711['PnlxV'](logDebug,'receive\x20downloadMedia\x20task',_0x227df9,_0x4ba7f8,_0x368827,_0x3b1f85,_0x2347a8,_0x188b95,_0x4e4605,_0x48ebef);if(_0x188b95&&_0x39324e[_0x4bc237(0x17a)](_0x188b95)){if(_0x48ebef)try{await _0x222f67[_0x4bc237(0x161)](_0x188b95);}catch(_0x4327bd){}else return _0x188b95;}return logDebug('start\x20downloadMedia',_0x227df9,_0x4ba7f8,_0x368827,_0x3b1f85,_0x2347a8,_0x188b95,_0x4e4605,_0x48ebef),new Promise((_0x5355a2,_0x409567)=>{const _0x3d4230=_0x4bc237,_0x38d26f={'zVmxW':function(_0x5c2265,_0x481f0b){const _0x1e71d4=_0x379c;return _0x135711[_0x1e71d4(0x186)](_0x5c2265,_0x481f0b);},'OhxCh':_0x3d4230(0x18a),'BMdVK':function(_0x3bf499,_0x4df246){return _0x3bf499(_0x4df246);},'mYuZv':_0x135711['IdSRI']};let _0x2df45a=![];const _0x5b71da=_0x11180a=>{const _0x11fc84=_0x3d4230;logDebug(_0x11fc84(0x154),_0x11180a,_0x227df9);if(_0x38d26f[_0x11fc84(0x18c)](_0x11180a[_0x11fc84(0x175)],_0x227df9)){_0x2df45a=!![];let _0x28a50c=_0x11180a[_0x11fc84(0x16b)];if(_0x28a50c[_0x11fc84(0x169)]('\x5c')){const _0x10baf7=sessionConfig[_0x11fc84(0x18e)];logDebug(_0x38d26f[_0x11fc84(0x170)],_0x10baf7),_0x28a50c=_0x3a515d[_0x11fc84(0x14c)](_0x10baf7,_0x28a50c);}_0x38d26f[_0x11fc84(0x187)](_0x5355a2,_0x28a50c);}};downloadMediaTasks[_0x3d4230(0x14f)](_0x135711[_0x3d4230(0x16c)](randomUUID),_0x5b71da),setTimeout(()=>{const _0x54ffa7=_0x3d4230;!_0x2df45a&&_0x38d26f[_0x54ffa7(0x187)](_0x409567,_0x38d26f['mYuZv']);},_0x4e4605),napCatCore[_0x3d4230(0x18b)][_0x3d4230(0x163)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x227df9,'chatType':_0x4ba7f8,'peerUid':_0x368827,'elementId':_0x3b1f85,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2347a8});});}static async['getImageSize'](_0x22da65){const _0x155a8c={'nzEct':function(_0x341864,_0x29bcb4){return _0x341864(_0x29bcb4);},'xpqhB':function(_0x51ef61,_0x36a709,_0xf96900){return _0x51ef61(_0x36a709,_0xf96900);}};return new Promise((_0x34f659,_0x8bf5a8)=>{const _0x2efd36={'zNsKK':function(_0x329368,_0x18d34d){const _0x4ee48a=_0x379c;return _0x155a8c[_0x4ee48a(0x160)](_0x329368,_0x18d34d);}};_0x155a8c['xpqhB'](_0x50b3a3,_0x22da65,(_0x393253,_0x87f34e)=>{_0x393253?_0x2efd36['zNsKK'](_0x8bf5a8,_0x393253):_0x34f659(_0x87f34e);});});}static async[_0x3ba260(0x17b)](_0x308164,_0x9ea34f){const _0x1ca2be=_0x3ba260,_0x57ead8={'FPVvU':'/download','wreha':'&rkey=','sTnHs':function(_0x595d0c,_0x296761){return _0x595d0c+_0x296761;},'witZb':function(_0x239e34,_0x5394cd,_0x79f03d){return _0x239e34(_0x5394cd,_0x79f03d);},'hDFfV':_0x1ca2be(0x15d)};if(!_0x308164)return'';const _0x54bf38=_0x308164[_0x1ca2be(0x166)],_0x78f7d8=_0x308164[_0x1ca2be(0x179)],_0x2559b2=_0x308164['md5HexStr'],_0x494a3d=_0x308164[_0x1ca2be(0x153)];if(_0x54bf38){if(_0x54bf38[_0x1ca2be(0x169)](_0x57ead8[_0x1ca2be(0x157)])){if(_0x54bf38[_0x1ca2be(0x174)](_0x57ead8[_0x1ca2be(0x176)]))return IMAGE_HTTP_HOST_NT+_0x54bf38;const _0x30c95c=await rkeyManager[_0x1ca2be(0x17f)](),_0xfc907=_0x9ea34f?_0x30c95c[_0x1ca2be(0x183)]:_0x30c95c[_0x1ca2be(0x14e)];return _0x57ead8[_0x1ca2be(0x15f)](_0x57ead8[_0x1ca2be(0x15f)](IMAGE_HTTP_HOST_NT,_0x54bf38),''+_0xfc907);}else return IMAGE_HTTP_HOST+_0x54bf38;}else{if(_0x2559b2||_0x78f7d8)return IMAGE_HTTP_HOST+_0x1ca2be(0x16e)+(_0x2559b2||_0x78f7d8)['toUpperCase']()+'/0';}return _0x57ead8[_0x1ca2be(0x155)](logDebug,_0x57ead8[_0x1ca2be(0x150)],_0x308164),'';}}function _0x379c(_0x34a045,_0x4ca09f){const _0x2b08d3=_0x2b08();return _0x379c=function(_0x379cf7,_0x2e2e22){_0x379cf7=_0x379cf7-0x14c;let _0x1bc935=_0x2b08d3[_0x379cf7];return _0x1bc935;},_0x379c(_0x34a045,_0x4ca09f);}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x4d6ed3=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x3ba260(0x18d)](_0x22f0a0=['tmp','hotUpdate']){const _0x178ffa=_0x3ba260;return napCatCore['session'][_0x178ffa(0x181)]()[_0x178ffa(0x158)](_0x22f0a0);}static[_0x3ba260(0x182)](_0x742029={}){const _0x4ddaec=_0x3ba260;return napCatCore[_0x4ddaec(0x18b)]['getStorageCleanService']()[_0x4ddaec(0x15a)](_0x742029);}static[_0x3ba260(0x189)](){const _0x3d3302=_0x3ba260;return napCatCore[_0x3d3302(0x18b)][_0x3d3302(0x181)]()['scanCache']();}static['getHotUpdateCachePath'](){return'';}static[_0x3ba260(0x173)](){return'';}static[_0x3ba260(0x180)](_0x47ab58,_0xb5da98=0x3e8,_0x22b073=0x0){const _0x11e878=_0x3ba260;return napCatCore[_0x11e878(0x18b)][_0x11e878(0x181)]()[_0x11e878(0x167)](_0x47ab58,_0xb5da98,0x1,_0x22b073);}static['getFileCacheInfo'](_0x525f9b,_0x576873=0x3e8,_0x341acf){const _0x5b32db=_0x341acf?_0x341acf:{'fileType':_0x525f9b};}static async[_0x3ba260(0x17e)](_0xa350a3=[],_0x28d06c=[]){const _0xfdb6e9=_0x3ba260;return napCatCore[_0xfdb6e9(0x18b)][_0xfdb6e9(0x181)]()[_0xfdb6e9(0x165)](_0xa350a3,_0x28d06c);}}