const _0x2d2469=_0x7077;(function(_0x29acf2,_0x2e5e0b){const _0x20e2af=_0x7077,_0x26d222=_0x29acf2();while(!![]){try{const _0x11fb27=parseInt(_0x20e2af(0xd2))/0x1+-parseInt(_0x20e2af(0xab))/0x2+parseInt(_0x20e2af(0xdb))/0x3+parseInt(_0x20e2af(0xa4))/0x4*(-parseInt(_0x20e2af(0xae))/0x5)+parseInt(_0x20e2af(0xde))/0x6*(parseInt(_0x20e2af(0x9c))/0x7)+parseInt(_0x20e2af(0xb7))/0x8*(-parseInt(_0x20e2af(0xa5))/0x9)+-parseInt(_0x20e2af(0xd7))/0xa*(-parseInt(_0x20e2af(0x9f))/0xb);if(_0x11fb27===_0x2e5e0b)break;else _0x26d222['push'](_0x26d222['shift']());}catch(_0x11b3ca){_0x26d222['push'](_0x26d222['shift']());}}}(_0x81f9,0xa0d18));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x5d0363 from'path';import _0x575994 from'fs';import _0x2bc589 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x5d5aa1 from'file-type';import{MsgListener}from'@/core/listeners';import _0x743ee7 from'image-size';function _0x7077(_0x4315dc,_0xc43aa2){const _0x81f9ff=_0x81f9();return _0x7077=function(_0x707799,_0x5e59b5){_0x707799=_0x707799-0x99;let _0x4d8c53=_0x81f9ff[_0x707799];return _0x4d8c53;},_0x7077(_0x4315dc,_0xc43aa2);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x2d2469(0x9a)]=_0x3f5ea1=>{const _0x25a71f=_0x2d2469,_0x3af15d={'cQuqh':function(_0x19e174,_0x43e5d){return _0x19e174(_0x43e5d);}};for(const [_0x118e89,_0x2d023f]of downloadMediaTasks){_0x3af15d[_0x25a71f(0xb4)](_0x2d023f,_0x3f5ea1),downloadMediaTasks['delete'](_0x118e89);}},setTimeout(()=>{const _0x5ce57a=_0x2d2469;napCatCore[_0x5ce57a(0xe0)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x2d2469(0xe1)](_0x326f10){const _0x1e4bd7=_0x2d2469;return _0x5d5aa1[_0x1e4bd7(0xbf)](_0x326f10);}static async[_0x2d2469(0xc9)](_0x381f5,_0x12e39c){const _0x12d161=_0x2d2469;await napCatCore[_0x12d161(0xdc)]['copyFile'](_0x381f5,_0x12e39c);}static async['getFileSize'](_0x33c9bf){const _0x1c5b9b=_0x2d2469;return await napCatCore[_0x1c5b9b(0xdc)][_0x1c5b9b(0xdf)](_0x33c9bf);}static async['uploadFile'](_0x4c04fb,_0x47db6e=ElementType[_0x2d2469(0x9b)],_0x49b405=0x0){const _0x5a0f62=_0x2d2469,_0x58fc9d={'Vssbk':function(_0x44185e,_0x200dd7){return _0x44185e(_0x200dd7);}},_0x597329=await _0x58fc9d[_0x5a0f62(0xe5)](calculateFileMD5,_0x4c04fb);let _0x54e4b1=(await NTQQFileApi[_0x5a0f62(0xe1)](_0x4c04fb))?.[_0x5a0f62(0xb1)]||'';_0x54e4b1&&(_0x54e4b1='.'+_0x54e4b1);let _0x2bf9e6=''+_0x5d0363[_0x5a0f62(0xcd)](_0x4c04fb);_0x2bf9e6[_0x5a0f62(0xdd)]('.')===-0x1&&(_0x2bf9e6+=_0x54e4b1);const _0x49dd68=napCatCore['session'][_0x5a0f62(0x9e)]()[_0x5a0f62(0x9d)]({'md5HexStr':_0x597329,'fileName':_0x2bf9e6,'elementType':_0x47db6e,'elementSubType':_0x49b405,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x5a0f62(0xc9)](_0x4c04fb,_0x49dd68);const _0x50ea4a=await NTQQFileApi[_0x5a0f62(0xdf)](_0x4c04fb);return{'md5':_0x597329,'fileName':_0x2bf9e6,'path':_0x49dd68,'fileSize':_0x50ea4a,'ext':_0x54e4b1};}static async['downloadMedia'](_0x2bc0c5,_0x22cdae,_0x20d3a0,_0x202555,_0xaa676b,_0x4bab31,_0x144842=0x3e8*0x3c*0x2,_0x3d5d97=![]){const _0x29f4db=_0x2d2469,_0x4963b6={'SeJmh':function(_0x499df3,_0x251f9a){return _0x499df3(_0x251f9a);},'oqHfN':function(_0x100d80){return _0x100d80();},'Kmlus':function(_0x3e5ad1,_0x55af90,_0x5dca5b){return _0x3e5ad1(_0x55af90,_0x5dca5b);},'UDdrN':function(_0x62c2bc,_0x3265cb,_0x312d54,_0x1afa6a,_0x53dee8,_0x4fad9a,_0x5d4bcf,_0x5aee38,_0x1ca809,_0x25b345){return _0x62c2bc(_0x3265cb,_0x312d54,_0x1afa6a,_0x53dee8,_0x4fad9a,_0x5d4bcf,_0x5aee38,_0x1ca809,_0x25b345);},'DUDwY':_0x29f4db(0xe3),'jagAy':function(_0x436a84,_0x113ae9,_0x3c35f4,_0x1a77b8,_0x225023,_0x227f72,_0x17ab91,_0x11142e,_0x555308,_0x5e3fc5){return _0x436a84(_0x113ae9,_0x3c35f4,_0x1a77b8,_0x225023,_0x227f72,_0x17ab91,_0x11142e,_0x555308,_0x5e3fc5);},'qqdqI':_0x29f4db(0xb9)};_0x4963b6[_0x29f4db(0xa1)](logDebug,_0x4963b6[_0x29f4db(0xc1)],_0x2bc0c5,_0x22cdae,_0x20d3a0,_0x202555,_0xaa676b,_0x4bab31,_0x144842,_0x3d5d97);if(_0x4bab31&&_0x575994[_0x29f4db(0xce)](_0x4bab31)){if(_0x3d5d97)try{await _0x2bc589[_0x29f4db(0xad)](_0x4bab31);}catch(_0xa6f1bb){}else return _0x4bab31;}return _0x4963b6[_0x29f4db(0xb3)](logDebug,_0x4963b6[_0x29f4db(0xa7)],_0x2bc0c5,_0x22cdae,_0x20d3a0,_0x202555,_0xaa676b,_0x4bab31,_0x144842,_0x3d5d97),new Promise((_0x536c46,_0x57584f)=>{const _0x418941=_0x29f4db,_0x98384={'rWbbq':function(_0x30b1e5,_0x329028,_0x482378,_0x37e211){return _0x30b1e5(_0x329028,_0x482378,_0x37e211);},'eWQEf':_0x418941(0xc4),'IHJsC':function(_0x558362,_0x12e7c8){const _0x1b3ded=_0x418941;return _0x4963b6[_0x1b3ded(0xc0)](_0x558362,_0x12e7c8);}};let _0x2af6d7=![];const _0x40f516=_0x548c60=>{const _0x4438d8=_0x418941;_0x98384[_0x4438d8(0xbd)](logDebug,_0x4438d8(0xb0),_0x548c60,_0x2bc0c5);if(_0x548c60[_0x4438d8(0xa0)]===_0x2bc0c5){_0x2af6d7=!![];let _0x5afba8=_0x548c60['filePath'];if(_0x5afba8[_0x4438d8(0xcb)]('\x5c')){const _0x22e050=sessionConfig[_0x4438d8(0xaa)];logDebug(_0x98384[_0x4438d8(0xd3)],_0x22e050),_0x5afba8=_0x5d0363[_0x4438d8(0xc3)](_0x22e050,_0x5afba8);}_0x98384[_0x4438d8(0xbb)](_0x536c46,_0x5afba8);}};downloadMediaTasks[_0x418941(0xca)](_0x4963b6[_0x418941(0xc2)](randomUUID),_0x40f516),_0x4963b6[_0x418941(0xbe)](setTimeout,()=>{const _0x318978=_0x418941;!_0x2af6d7&&_0x4963b6[_0x318978(0xc0)](_0x57584f,_0x318978(0xa9));},_0x144842),napCatCore['session']['getMsgService']()[_0x418941(0xd0)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x2bc0c5,'chatType':_0x22cdae,'peerUid':_0x20d3a0,'elementId':_0x202555,'thumbSize':0x0,'downloadType':0x1,'filePath':_0xaa676b});});}static async[_0x2d2469(0xd1)](_0x47d5d6){const _0x4b5256={'vfMqM':function(_0x2cd3cf,_0xa453ff){return _0x2cd3cf(_0xa453ff);}};return new Promise((_0xa530c4,_0x120b9f)=>{const _0x3374a4={'gjrFL':function(_0xc99474,_0x2029ae){const _0x1c6c9d=_0x7077;return _0x4b5256[_0x1c6c9d(0xaf)](_0xc99474,_0x2029ae);}};_0x743ee7(_0x47d5d6,(_0x9566be,_0x5959d5)=>{_0x9566be?_0x120b9f(_0x9566be):_0x3374a4['gjrFL'](_0xa530c4,_0x5959d5);});});}static async[_0x2d2469(0xc5)](_0x1f7660,_0x534435){const _0x578601=_0x2d2469,_0x23f333={'zOaQl':function(_0x94d910,_0x3e2561){return _0x94d910+_0x3e2561;},'gEFkq':function(_0x52935c,_0x4cf30a){return _0x52935c||_0x4cf30a;},'LTlsA':function(_0x2ac2e8,_0x5f53d0,_0x12086f){return _0x2ac2e8(_0x5f53d0,_0x12086f);}};if(!_0x1f7660)return'';const _0x16d442=_0x1f7660[_0x578601(0xb8)],_0x78440=_0x1f7660[_0x578601(0xc6)],_0x37fba9=_0x1f7660[_0x578601(0xc6)],_0x221c93=_0x1f7660[_0x578601(0xac)];if(_0x16d442){if(_0x16d442[_0x578601(0xcb)](_0x578601(0xb5))){if(_0x16d442[_0x578601(0xcc)]('&rkey='))return _0x23f333[_0x578601(0xa6)](IMAGE_HTTP_HOST_NT,_0x16d442);const _0x32ce1b=await rkeyManager[_0x578601(0xe2)](),_0x3a16cf=_0x534435?_0x32ce1b['private_rkey']:_0x32ce1b[_0x578601(0xa3)];return IMAGE_HTTP_HOST_NT+_0x16d442+(''+_0x3a16cf);}else return IMAGE_HTTP_HOST+_0x16d442;}else{if(_0x23f333[_0x578601(0xc8)](_0x37fba9,_0x78440))return IMAGE_HTTP_HOST+_0x578601(0xa8)+_0x23f333[_0x578601(0xc8)](_0x37fba9,_0x78440)[_0x578601(0xd4)]()+'/0';}return _0x23f333[_0x578601(0xb2)](logDebug,'图片url获取失败',_0x1f7660),'';}}function _0x81f9(){const _0x54069b=['session','gEFkq','copyFile','set','startsWith','includes','basename','existsSync','clearChatCacheInfo','downloadRichMedia','getImageSize','675595OuvHjJ','eWQEf','toUpperCase','getChatCacheInfo','getDesktopTmpPath','10UjdNYZ','clearCacheDataByKeys','scanCache','getHotUpdateCachePath','1938483Qshffw','util','indexOf','1126056SpvqMN','getFileSize','onLoginSuccess','getFileType','getRkey','receive\x20downloadMedia\x20task','getCacheSessionPathList','Vssbk','getChatCacheList','onRichMediaDownloadComplete','PIC','35SoXOFP','getRichMediaFilePathForGuild','getMsgService','10093292GrvrNV','msgId','UDdrN','getStorageCleanService','group_rkey','8108upCxux','333rKVctW','zOaQl','qqdqI','/gchatpic_new/0/0-0-','下载超时','defaultFileDownloadPath','1280520ItfEWn','fileUuid','unlink','1835dqdwQX','vfMqM','downloadMedia\x20complete','ext','LTlsA','jagAy','cQuqh','/download','clearCache','245368Lfcztz','originImageUrl','start\x20downloadMedia','addCacheScannedPaths','IHJsC','tmp','rWbbq','Kmlus','fileTypeFromFile','SeJmh','DUDwY','oqHfN','join','downloadPath','getImageUrl','md5HexStr'];_0x81f9=function(){return _0x54069b;};return _0x81f9();}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x59df8a=!![]){return'';}static[_0x2d2469(0xe4)](){return'';}static[_0x2d2469(0xb6)](_0xdd001f=[_0x2d2469(0xbc),'hotUpdate']){const _0x411e47=_0x2d2469;return napCatCore['session'][_0x411e47(0xa2)]()[_0x411e47(0xd8)](_0xdd001f);}static[_0x2d2469(0xba)](_0x40e734={}){const _0x3e46bc=_0x2d2469;return napCatCore['session'][_0x3e46bc(0xa2)]()['addCacheScanedPaths'](_0x40e734);}static[_0x2d2469(0xd9)](){const _0x40912f=_0x2d2469;return napCatCore['session'][_0x40912f(0xa2)]()['scanCache']();}static[_0x2d2469(0xda)](){return'';}static[_0x2d2469(0xd6)](){return'';}static[_0x2d2469(0x99)](_0x31f3bb,_0x4a6391=0x3e8,_0x25f13b=0x0){const _0x11e55f=_0x2d2469;return napCatCore['session']['getStorageCleanService']()[_0x11e55f(0xd5)](_0x31f3bb,_0x4a6391,0x1,_0x25f13b);}static['getFileCacheInfo'](_0x1bf80b,_0x712333=0x3e8,_0x520564){const _0x35d146=_0x520564?_0x520564:{'fileType':_0x1bf80b};}static async['clearChatCache'](_0x5d465c=[],_0x2f556a=[]){const _0x53197a=_0x2d2469;return napCatCore[_0x53197a(0xc7)][_0x53197a(0xa2)]()[_0x53197a(0xcf)](_0x5d465c,_0x2f556a);}}