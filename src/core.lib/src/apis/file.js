const _0x4d584c=_0x41d6;function _0x2d61(){const _0x499528=['cEpUJ','getHotUpdateCachePath','GalDU','originImageUrl','delete','14qkJpTR','downloadMedia','existsSync','getChatCacheList','session','copyFile','XORDx','124270wwQssU','filePath','getRkey','&rkey=','scanCache','/gchatpic_new/0/0-0-','fileTypeFromFile','1340488KLKnnt','getMsgService','ZMYFQ','tmp','vqjmG','hotUpdate','util','FCyik','msgId','2931KuFPCH','getFileCacheInfo','uploadFile','352480qqrNCp','getCacheSessionPathList','clearChatCache','md5HexStr','下载超时','addListener','onRichMediaDownloadComplete','includes','indexOf','startsWith','getStorageCleanService','getDesktopTmpPath','getImageUrl','/download','ZfQtM','clearCacheDataByKeys','join','setCacheSilentScan','1858176rieqSe','368RtHPfy','cZLtl','defaultFileDownloadPath','GXRBp','unlink','13397IVPLDX','basename','group_rkey','getFileSize','1767577iTjlVz','图片url获取失败','clearChatCacheInfo','ext','addCacheScanedPaths','PIC','6mBHRiL','toUpperCase','jEnfV','getFileType'];_0x2d61=function(){return _0x499528;};return _0x2d61();}(function(_0x25595e,_0x4d4cbf){const _0x1644a3=_0x41d6,_0x5bfdc0=_0x25595e();while(!![]){try{const _0x3e7683=parseInt(_0x1644a3(0x110))/0x1*(-parseInt(_0x1644a3(0xde))/0x2)+-parseInt(_0x1644a3(0xf5))/0x3*(parseInt(_0x1644a3(0x10b))/0x4)+parseInt(_0x1644a3(0xf8))/0x5+-parseInt(_0x1644a3(0xd5))/0x6*(-parseInt(_0x1644a3(0xcf))/0x7)+-parseInt(_0x1644a3(0xec))/0x8+parseInt(_0x1644a3(0x10a))/0x9+parseInt(_0x1644a3(0xe5))/0xa;if(_0x3e7683===_0x4d4cbf)break;else _0x5bfdc0['push'](_0x5bfdc0['shift']());}catch(_0x5d3eb6){_0x5bfdc0['push'](_0x5bfdc0['shift']());}}}(_0x2d61,0x2e8d2));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x31728a from'path';import _0x1fd82a from'fs';import _0x1109e6 from'fs/promises';import{logDebug}from'@/common/utils/log';function _0x41d6(_0x456ec7,_0x3efae5){const _0x2d6150=_0x2d61();return _0x41d6=function(_0x41d6f8,_0x55cc9b){_0x41d6f8=_0x41d6f8-0xcc;let _0x781b23=_0x2d6150[_0x41d6f8];return _0x781b23;},_0x41d6(_0x456ec7,_0x3efae5);}import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x1d6fae from'file-type';import{MsgListener}from'@/core/listeners';import _0x326100 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x4d584c(0xfe)]=_0x1c4e94=>{const _0x2fcb93=_0x4d584c,_0x3440fb={'pEetE':function(_0x3be4ea,_0x50a159){return _0x3be4ea(_0x50a159);}};for(const [_0x3fa22f,_0x32ec43]of downloadMediaTasks){_0x3440fb['pEetE'](_0x32ec43,_0x1c4e94),downloadMediaTasks[_0x2fcb93(0xdd)](_0x3fa22f);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x23a341=_0x41d6;napCatCore[_0x23a341(0xfd)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x4d584c(0xd8)](_0x3ba7b9){const _0x1bfa05=_0x4d584c;return _0x1d6fae[_0x1bfa05(0xeb)](_0x3ba7b9);}static async['copyFile'](_0x5efa7b,_0x557ae3){const _0x16c651=_0x4d584c;await napCatCore[_0x16c651(0xf2)][_0x16c651(0xe3)](_0x5efa7b,_0x557ae3);}static async[_0x4d584c(0xce)](_0x1745d6){const _0x1ec57b=_0x4d584c;return await napCatCore[_0x1ec57b(0xf2)]['getFileSize'](_0x1745d6);}static async[_0x4d584c(0xf7)](_0x5a73e9,_0x409da2=ElementType[_0x4d584c(0xd4)],_0x1b5ede=0x0){const _0x2e272a=_0x4d584c,_0x29aced={'XORDx':function(_0x4d6791,_0x26ae8f){return _0x4d6791(_0x26ae8f);},'CtLYn':function(_0x136da7,_0x1eeced){return _0x136da7+_0x1eeced;},'nsfWr':function(_0x497c1d,_0x200bbf){return _0x497c1d===_0x200bbf;}},_0x4f2453=await _0x29aced[_0x2e272a(0xe4)](calculateFileMD5,_0x5a73e9);let _0x416d21=(await NTQQFileApi[_0x2e272a(0xd8)](_0x5a73e9))?.[_0x2e272a(0xd2)]||'';_0x416d21&&(_0x416d21=_0x29aced['CtLYn']('.',_0x416d21));let _0xf4beea=''+_0x31728a[_0x2e272a(0xcc)](_0x5a73e9);_0x29aced['nsfWr'](_0xf4beea[_0x2e272a(0x100)]('.'),-0x1)&&(_0xf4beea+=_0x416d21);const _0x6445b4=napCatCore['session'][_0x2e272a(0xed)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x4f2453,'fileName':_0xf4beea,'elementType':_0x409da2,'elementSubType':_0x1b5ede,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x2e272a(0xe3)](_0x5a73e9,_0x6445b4);const _0x514baa=await NTQQFileApi[_0x2e272a(0xce)](_0x5a73e9);return{'md5':_0x4f2453,'fileName':_0xf4beea,'path':_0x6445b4,'fileSize':_0x514baa,'ext':_0x416d21};}static async[_0x4d584c(0xdf)](_0x360300,_0x1a63ce,_0x2ee342,_0x1c06e7,_0x1cc349,_0x45f2d9,_0xf29ac8=0x3e8*0x3c*0x2,_0x197065=![]){const _0x174fef=_0x4d584c,_0x2a1dc1={'GXRBp':function(_0xf3ab81,_0x43d422){return _0xf3ab81(_0x43d422);},'cZLtl':function(_0x4ec102,_0x297668){return _0x4ec102===_0x297668;},'vqjmG':function(_0x30f225){return _0x30f225();}};if(_0x45f2d9&&_0x1fd82a[_0x174fef(0xe0)](_0x45f2d9)){if(_0x197065)try{await _0x1109e6[_0x174fef(0x10f)](_0x45f2d9);}catch(_0x2a7b1d){}else return _0x45f2d9;}return new Promise((_0x3166db,_0x548215)=>{const _0x54c50c=_0x174fef,_0xb170fa={'jEnfV':function(_0x30ec62,_0x566175){const _0xf6dd50=_0x41d6;return _0x2a1dc1[_0xf6dd50(0x10c)](_0x30ec62,_0x566175);},'MkOOw':function(_0x1a2114,_0x4aabf2){return _0x1a2114(_0x4aabf2);}};let _0x466dd3=![];const _0x16900e=_0x358023=>{const _0x142043=_0x41d6;if(_0xb170fa[_0x142043(0xd7)](_0x358023[_0x142043(0xf4)],_0x360300)){_0x466dd3=!![];let _0x3ed79c=_0x358023[_0x142043(0xe6)];if(_0x3ed79c[_0x142043(0x101)]('\x5c')){const _0x274923=sessionConfig[_0x142043(0x10d)];_0x3ed79c=_0x31728a[_0x142043(0x108)](_0x274923,_0x3ed79c);}_0xb170fa['MkOOw'](_0x3166db,_0x3ed79c);}};downloadMediaTasks['set'](_0x2a1dc1[_0x54c50c(0xf0)](randomUUID),_0x16900e),setTimeout(()=>{const _0x127fca=_0x54c50c;!_0x466dd3&&_0x2a1dc1[_0x127fca(0x10e)](_0x548215,_0x127fca(0xfc));},_0xf29ac8),napCatCore['session'][_0x54c50c(0xed)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x360300,'chatType':_0x1a63ce,'peerUid':_0x2ee342,'elementId':_0x1c06e7,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1cc349});});}static async['getImageSize'](_0x3c8bd6){return new Promise((_0x2380b7,_0x4f2f23)=>{const _0x36b591={'FCyik':function(_0x1f5829,_0x427917){return _0x1f5829(_0x427917);}};_0x326100(_0x3c8bd6,(_0x1279ad,_0x4735d6)=>{const _0x466fbe=_0x41d6;_0x1279ad?_0x36b591['FCyik'](_0x4f2f23,_0x1279ad):_0x36b591[_0x466fbe(0xf3)](_0x2380b7,_0x4735d6);});});}static async[_0x4d584c(0x104)](_0x3a773a,_0x473321){const _0x303c66=_0x4d584c,_0x3f1b59={'GalDU':_0x303c66(0xe8),'wiYxm':function(_0x48f1da,_0x2858ab){return _0x48f1da+_0x2858ab;},'YqHYP':function(_0x340939,_0x4d42f1){return _0x340939+_0x4d42f1;},'wDquo':function(_0x5cf3a4,_0x5b0026){return _0x5cf3a4+_0x5b0026;},'ZfQtM':function(_0x539495,_0x27f606){return _0x539495||_0x27f606;},'cEpUJ':function(_0x862220,_0x24e66c){return _0x862220||_0x24e66c;},'ZMYFQ':function(_0x453202,_0x356e64,_0x2aaac1){return _0x453202(_0x356e64,_0x2aaac1);},'TFBwg':_0x303c66(0xd0)};if(!_0x3a773a)return'';const _0x1f0099=_0x3a773a[_0x303c66(0xdc)],_0xcae2ea=_0x3a773a[_0x303c66(0xfb)],_0x216662=_0x3a773a[_0x303c66(0xfb)],_0x2f050c=_0x3a773a['fileUuid'];if(_0x1f0099){if(_0x1f0099['startsWith'](_0x303c66(0x105))){if(_0x1f0099[_0x303c66(0xff)](_0x3f1b59[_0x303c66(0xdb)]))return IMAGE_HTTP_HOST_NT+_0x1f0099;const _0x382898=await rkeyManager[_0x303c66(0xe7)](),_0x5f680b=_0x473321?_0x382898['private_rkey']:_0x382898[_0x303c66(0xcd)];return _0x3f1b59['wiYxm'](_0x3f1b59['YqHYP'](IMAGE_HTTP_HOST_NT,_0x1f0099),''+_0x5f680b);}else return _0x3f1b59['wDquo'](IMAGE_HTTP_HOST,_0x1f0099);}else{if(_0x3f1b59[_0x303c66(0x106)](_0x216662,_0xcae2ea))return IMAGE_HTTP_HOST+_0x303c66(0xea)+_0x3f1b59[_0x303c66(0xd9)](_0x216662,_0xcae2ea)[_0x303c66(0xd6)]()+'/0';}return _0x3f1b59[_0x303c66(0xee)](logDebug,_0x3f1b59['TFBwg'],_0x3a773a),'';}}export class NTQQFileCacheApi{static async[_0x4d584c(0x109)](_0x15d231=!![]){return'';}static[_0x4d584c(0xf9)](){return'';}static['clearCache'](_0x106d85=[_0x4d584c(0xef),_0x4d584c(0xf1)]){const _0x15f625=_0x4d584c;return napCatCore['session']['getStorageCleanService']()[_0x15f625(0x107)](_0x106d85);}static['addCacheScannedPaths'](_0x3962af={}){const _0xcf1261=_0x4d584c;return napCatCore['session'][_0xcf1261(0x102)]()[_0xcf1261(0xd3)](_0x3962af);}static[_0x4d584c(0xe9)](){const _0x2b1b17=_0x4d584c;return napCatCore[_0x2b1b17(0xe2)][_0x2b1b17(0x102)]()[_0x2b1b17(0xe9)]();}static[_0x4d584c(0xda)](){return'';}static[_0x4d584c(0x103)](){return'';}static[_0x4d584c(0xe1)](_0x37ca86,_0x35ab5a=0x3e8,_0x57afa7=0x0){const _0x54196e=_0x4d584c;return napCatCore[_0x54196e(0xe2)]['getStorageCleanService']()['getChatCacheInfo'](_0x37ca86,_0x35ab5a,0x1,_0x57afa7);}static[_0x4d584c(0xf6)](_0x22a176,_0x2f63b6=0x3e8,_0x22935c){const _0xbb4799=_0x22935c?_0x22935c:{'fileType':_0x22a176};}static async[_0x4d584c(0xfa)](_0x5bd2ac=[],_0x2867ae=[]){const _0x17d0bd=_0x4d584c;return napCatCore[_0x17d0bd(0xe2)][_0x17d0bd(0x102)]()[_0x17d0bd(0xd1)](_0x5bd2ac,_0x2867ae);}}