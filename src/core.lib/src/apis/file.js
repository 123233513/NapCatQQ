const _0x2a1718=_0x2285;(function(_0x5e7c43,_0xfc0ee9){const _0x5f1989=_0x2285,_0x47897b=_0x5e7c43();while(!![]){try{const _0x32613e=-parseInt(_0x5f1989(0x222))/0x1+-parseInt(_0x5f1989(0x25e))/0x2*(parseInt(_0x5f1989(0x257))/0x3)+parseInt(_0x5f1989(0x21e))/0x4+parseInt(_0x5f1989(0x1fb))/0x5*(-parseInt(_0x5f1989(0x240))/0x6)+-parseInt(_0x5f1989(0x256))/0x7*(parseInt(_0x5f1989(0x21a))/0x8)+parseInt(_0x5f1989(0x243))/0x9*(parseInt(_0x5f1989(0x224))/0xa)+parseInt(_0x5f1989(0x24e))/0xb;if(_0x32613e===_0xfc0ee9)break;else _0x47897b['push'](_0x47897b['shift']());}catch(_0x42b1f9){_0x47897b['push'](_0x47897b['shift']());}}}(_0x90d1,0x7d3de));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x90d1(){const _0x19cdc4=['chatType','AWACr','hookApi\x20is\x20not\x20available','getChatCacheInfo','GlGZi','KiXjI','416082DTfBnc','YwSfu','indexOf','7749QEGjRp','tnAUA','/download','existsSync','isAvailable','includes','PIC','检查rkey是否有效','jiUGn','fileUuid','basename','15696329VrGDtK','FxkBt','LcWFi','addTask','elementId','clearCacheDataByKeys','getHotUpdateCachePath','set','7fLpcTo','6735AKPriA','session','eeHui','picElement','then','getMsgService','catch','202NCziNH','SDyNY','Popcv','JWmDz','scanCache','vJUfB','utcRw','now','getFileType','图片rkey有误','DMNdn','getFileCacheInfo','图片url获取失败','getImageSize','35sHKrvL','uTwNr','toUpperCase','&rkey=','uploadFile','addListener','wiFMk','onLoginSuccess','获取图片rkey...','下载超时','nepgK','bszVY','error','sourcePath','fxmfA','downloadRichMedia','yOhpA','getRKey','startsWith','hhKpJ','hotUpdate','unlink','msgId','copyFile','ySHlf','downloadMedia','get','IgDGW','group','fCHlQ','util','139992iDfAkF','setCacheSilentScan','filePath','getFileSize','629492IMLajY','图片rkey获取失败','onRichMediaDownloadComplete','getRichMediaFilePathForGuild','729960MxBjPs','getStorageCleanService','4510PhLIuu','clearCache','originImageUrl','vHRgz','peerUid','图片rkey有效','md5HexStr','downloadPath','statusCode','find','kQrPX','eKkOM','downloadMedia\x20complete','iFwiT','elements','VYPLr','ekQVq','OAFFx','csMye','clearChatCacheInfo','tmp','start\x20downloadMedia'];_0x90d1=function(){return _0x19cdc4;};return _0x90d1();}import _0x4320b2 from'path';import _0x2194b4 from'fs';import _0x2d0c56 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x431d03 from'file-type';import{MsgListener}from'@/core/listeners';import _0x50837e from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';function _0x2285(_0x3f6a8b,_0x5570c4){const _0x90d1f8=_0x90d1();return _0x2285=function(_0x2285b2,_0x41dbbf){_0x2285b2=_0x2285b2-0x1f4;let _0x353c4f=_0x90d1f8[_0x2285b2];return _0x353c4f;},_0x2285(_0x3f6a8b,_0x5570c4);}import _0x43386d from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x2a1718(0x220)]=_0x52dba7=>{const _0x5917ae=_0x2a1718,_0x4e9225={'eeHui':function(_0x174a62,_0x283a52){return _0x174a62(_0x283a52);}};for(const [_0x41edb8,_0xc292d3]of downloadMediaTasks){_0x4e9225[_0x5917ae(0x259)](_0xc292d3,_0x52dba7),downloadMediaTasks['delete'](_0x41edb8);}},setTimeout(()=>{const _0xbb15b9=_0x2a1718;napCatCore[_0xbb15b9(0x202)](()=>{const _0x45a9ed=_0xbb15b9;napCatCore[_0x45a9ed(0x200)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x2a1718(0x1f5)](_0x40bc02){return _0x431d03['fileTypeFromFile'](_0x40bc02);}static async[_0x2a1718(0x212)](_0x233ec1,_0x5a9163){const _0x26b37d=_0x2a1718;await napCatCore[_0x26b37d(0x219)][_0x26b37d(0x212)](_0x233ec1,_0x5a9163);}static async[_0x2a1718(0x21d)](_0x1dec7e){const _0x5b4986=_0x2a1718;return await napCatCore[_0x5b4986(0x219)][_0x5b4986(0x21d)](_0x1dec7e);}static async[_0x2a1718(0x1ff)](_0xdab82e,_0x13ea50=ElementType[_0x2a1718(0x249)],_0x2e0b1d=0x0){const _0x584919=_0x2a1718,_0x5dbf59={'yOhpA':function(_0x16baa7,_0x50b5fb){return _0x16baa7(_0x50b5fb);},'ekQVq':function(_0x117160,_0x24953e){return _0x117160+_0x24953e;},'DIrXo':function(_0x44e8c6,_0x1e9d47){return _0x44e8c6===_0x1e9d47;}},_0x334790=await _0x5dbf59[_0x584919(0x20b)](calculateFileMD5,_0xdab82e);let _0x19b236=(await NTQQFileApi[_0x584919(0x1f5)](_0xdab82e))?.['ext']||'';_0x19b236&&(_0x19b236=_0x5dbf59[_0x584919(0x234)]('.',_0x19b236));let _0x46f7e3=''+_0x4320b2[_0x584919(0x24d)](_0xdab82e);_0x5dbf59['DIrXo'](_0x46f7e3[_0x584919(0x242)]('.'),-0x1)&&(_0x46f7e3+=_0x19b236);const _0x362989=napCatCore['session'][_0x584919(0x25c)]()[_0x584919(0x221)]({'md5HexStr':_0x334790,'fileName':_0x46f7e3,'elementType':_0x13ea50,'elementSubType':_0x2e0b1d,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x584919(0x212)](_0xdab82e,_0x362989);const _0xd1a54c=await NTQQFileApi['getFileSize'](_0xdab82e);return{'md5':_0x334790,'fileName':_0x46f7e3,'path':_0x362989,'fileSize':_0xd1a54c,'ext':_0x19b236};}static async[_0x2a1718(0x214)](_0x107d86,_0x2be89e,_0x125cb9,_0x44caa2,_0x161cdc,_0x370fd4,_0x584ff7=0x3e8*0x3c*0x2,_0x138295=![]){const _0x56a62d=_0x2a1718,_0x450258={'jiUGn':_0x56a62d(0x22b),'AWACr':function(_0x12a2fd,_0x2dff66){return _0x12a2fd(_0x2dff66);},'gxVPt':function(_0xbc4d6f,_0x3d19a4){return _0xbc4d6f(_0x3d19a4);},'tnAUA':function(_0x37059a){return _0x37059a();},'iFwiT':function(_0x5ee109,_0x754020,_0x223fb9){return _0x5ee109(_0x754020,_0x223fb9);},'FxkBt':function(_0x3aae8a,_0x2cf0d4,_0x3600b7,_0xde4a70,_0x18b929,_0x121730,_0x1bb26f,_0x530b07,_0x1e43a6,_0x2b7fe5){return _0x3aae8a(_0x2cf0d4,_0x3600b7,_0xde4a70,_0x18b929,_0x121730,_0x1bb26f,_0x530b07,_0x1e43a6,_0x2b7fe5);},'hhKpJ':'receive\x20downloadMedia\x20task','fxmfA':_0x56a62d(0x239)};_0x450258[_0x56a62d(0x24f)](logDebug,_0x450258[_0x56a62d(0x20e)],_0x107d86,_0x2be89e,_0x125cb9,_0x44caa2,_0x161cdc,_0x370fd4,_0x584ff7,_0x138295);if(_0x370fd4&&_0x2194b4[_0x56a62d(0x246)](_0x370fd4)){if(_0x138295)try{await _0x2d0c56[_0x56a62d(0x210)](_0x370fd4);}catch(_0x4e8e86){}else return _0x370fd4;}return _0x450258[_0x56a62d(0x24f)](logDebug,_0x450258[_0x56a62d(0x209)],_0x107d86,_0x2be89e,_0x125cb9,_0x44caa2,_0x161cdc,_0x370fd4,_0x584ff7,_0x138295),new Promise((_0x3fa19a,_0x12271f)=>{const _0x5d219f=_0x56a62d,_0x58d8fb={'OAFFx':function(_0x4b6714,_0x565bef){return _0x4b6714===_0x565bef;},'wiFMk':_0x450258[_0x5d219f(0x24b)],'JWmDz':function(_0x2c60f7,_0x3f05fd){const _0x1e95e4=_0x5d219f;return _0x450258[_0x1e95e4(0x23b)](_0x2c60f7,_0x3f05fd);},'pHJnT':function(_0x414103,_0x5a216b){return _0x450258['gxVPt'](_0x414103,_0x5a216b);}};let _0x44aea8=![];const _0x3d1084=_0xcce7d9=>{const _0x2d43b2=_0x5d219f;logDebug(_0x2d43b2(0x230),_0xcce7d9,_0x107d86);if(_0x58d8fb[_0x2d43b2(0x235)](_0xcce7d9[_0x2d43b2(0x211)],_0x107d86)){_0x44aea8=!![];let _0x2b6d28=_0xcce7d9[_0x2d43b2(0x21c)];if(_0x2b6d28['startsWith']('\x5c')){const _0x3ce622=sessionConfig['defaultFileDownloadPath'];logDebug(_0x58d8fb[_0x2d43b2(0x201)],_0x3ce622),_0x2b6d28=_0x4320b2['join'](_0x3ce622,_0x2b6d28);}_0x58d8fb[_0x2d43b2(0x261)](_0x3fa19a,_0x2b6d28);}};downloadMediaTasks[_0x5d219f(0x255)](_0x450258[_0x5d219f(0x244)](randomUUID),_0x3d1084),_0x450258[_0x5d219f(0x231)](setTimeout,()=>{const _0x275b62=_0x5d219f;!_0x44aea8&&_0x58d8fb['pHJnT'](_0x12271f,_0x275b62(0x204));},_0x584ff7),napCatCore['session'][_0x5d219f(0x25c)]()[_0x5d219f(0x20a)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x107d86,'chatType':_0x2be89e,'peerUid':_0x125cb9,'elementId':_0x44caa2,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x161cdc});});}static async[_0x2a1718(0x1fa)](_0x2f720b){const _0x375d4f={'YwSfu':function(_0x276d52,_0x1597f4){return _0x276d52(_0x1597f4);},'uTwNr':function(_0x88a1cd,_0x75a9fd,_0x5ee469){return _0x88a1cd(_0x75a9fd,_0x5ee469);}};return new Promise((_0x5056d8,_0x446590)=>{const _0x5bf495=_0x2285;_0x375d4f[_0x5bf495(0x1fc)](_0x50837e,_0x2f720b,(_0x10a164,_0x5e731c)=>{const _0x558f3e=_0x5bf495;_0x10a164?_0x446590(_0x10a164):_0x375d4f[_0x558f3e(0x241)](_0x5056d8,_0x5e731c);});});}static async['getImageUrl'](_0x5cc172){const _0x483984=_0x2a1718,_0x246e7c={'bszVY':function(_0x191a49,_0x3a217c){return _0x191a49(_0x3a217c);},'nepgK':_0x483984(0x21f),'EgaOK':_0x483984(0x203),'ySHlf':function(_0x5248e7,_0x5d5da9){return _0x5248e7*_0x5d5da9;},'BFBBq':'开始调用moeHook获取rkey','csMye':function(_0xc493b3,_0x18fc65){return _0xc493b3+_0x18fc65;},'DMNdn':function(_0x409a9a,_0x164f13){return _0x409a9a+_0x164f13;},'RjaWH':function(_0x5af818,_0x4c5515,_0x448f0f){return _0x5af818(_0x4c5515,_0x448f0f);},'IgDGW':_0x483984(0x24a),'GlGZi':_0x483984(0x229),'utcRw':function(_0x4c96e0,_0x120168,_0x2e04ce,_0x162266){return _0x4c96e0(_0x120168,_0x2e04ce,_0x162266);},'ozcgA':_0x483984(0x1f6),'lTazS':function(_0xa510d2){return _0xa510d2();},'vJUfB':function(_0x29eeae,_0x41fed4){return _0x29eeae!==_0x41fed4;},'fpsQf':_0x483984(0x245),'ScIWV':function(_0x2cdb0d,_0x52afaa){return _0x2cdb0d(_0x52afaa);},'SDyNY':_0x483984(0x23c),'VYPLr':function(_0x3eb822,_0x2b6df7){return _0x3eb822-_0x2b6df7;},'vHRgz':function(_0x23a2bd,_0x266173){return _0x23a2bd+_0x266173;},'Bjshq':function(_0x3b612b,_0xbf2317,_0x4e5aaa){return _0x3b612b(_0xbf2317,_0x4e5aaa);},'eKkOM':function(_0x2df501,_0x25a15c){return _0x2df501+_0x25a15c;},'KiXjI':function(_0xcdd65d,_0x305ce7){return _0xcdd65d||_0x305ce7;},'LcWFi':_0x483984(0x1f9)},_0x5ccace=_0x246e7c[_0x483984(0x263)](_0x5cc172['chatType'],ChatType[_0x483984(0x217)]),_0x4a7529=_0x5cc172[_0x483984(0x232)][_0x483984(0x22d)](_0x17d5cb=>!!_0x17d5cb['picElement']);if(!_0x4a7529)return'';const _0x125558=_0x4a7529['picElement'][_0x483984(0x226)],_0x3aae5d=_0x4a7529[_0x483984(0x25a)][_0x483984(0x22a)],_0x201070=_0x4a7529[_0x483984(0x25a)][_0x483984(0x22a)],_0x41d766=_0x4a7529[_0x483984(0x25a)][_0x483984(0x24c)],_0x120313=_0x1cb2bb=>{const _0x32e2b9=_0x483984;_0x5ccace?(privateImageRKey=_0x1cb2bb,lastGetPrivateRKeyTime=Date[_0x32e2b9(0x1f4)]()):(groupImageRKey=_0x1cb2bb,lastGetGroupRKeyTime=Date[_0x32e2b9(0x1f4)]());};if(_0x125558){if(_0x125558[_0x483984(0x20d)](_0x246e7c['fpsQf'])){if(_0x125558[_0x483984(0x248)](_0x483984(0x1fe)))return _0x246e7c['DMNdn'](IMAGE_HTTP_HOST_NT,_0x125558);if(!hookApi[_0x483984(0x247)]())return _0x246e7c['ScIWV'](logDebug,_0x246e7c[_0x483984(0x25f)]),'';const _0x491dd2=async()=>{const _0x30337f=_0x483984,_0x505068={'kQrPX':function(_0x402a9f,_0x182da3){return _0x402a9f(_0x182da3);}};_0x246e7c['bszVY'](logDebug,_0x246e7c['EgaOK']),NTQQFileApi[_0x30337f(0x214)](_0x5cc172[_0x30337f(0x211)],_0x5cc172[_0x30337f(0x23a)],_0x5cc172[_0x30337f(0x228)],_0x4a7529[_0x30337f(0x252)],'',_0x4a7529[_0x30337f(0x25a)][_0x30337f(0x208)],_0x246e7c[_0x30337f(0x213)](0x3e8,0x1e),![])[_0x30337f(0x25b)](_0x509009=>{})[_0x30337f(0x25d)](logError),await sleep(0x3e8),_0x246e7c[_0x30337f(0x206)](logDebug,_0x246e7c['BFBBq']);const _0x362a39=hookApi[_0x30337f(0x20c)]()||'',_0xeaaac=_0x246e7c[_0x30337f(0x236)](_0x246e7c['DMNdn'](IMAGE_HTTP_HOST_NT,_0x125558),_0x362a39);if(_0x362a39)try{_0x246e7c['RjaWH'](logDebug,_0x246e7c[_0x30337f(0x216)],_0xeaaac),await new Promise((_0x6a8f31,_0x30bcac)=>{const _0x16cefd=_0x30337f,_0x1f959a={'GrWpm':function(_0x28838a,_0x159b02){return _0x28838a!==_0x159b02;},'fCHlQ':function(_0x4241b1,_0x21b9e9){const _0x744ec8=_0x2285;return _0x246e7c[_0x744ec8(0x206)](_0x4241b1,_0x21b9e9);},'Popcv':_0x246e7c[_0x16cefd(0x205)]};_0x43386d[_0x16cefd(0x215)](_0xeaaac,_0xfc98ea=>{const _0x5d9a7d=_0x16cefd;_0x1f959a['GrWpm'](_0xfc98ea[_0x5d9a7d(0x22c)],0xc8)?_0x1f959a[_0x5d9a7d(0x218)](_0x30bcac,_0x1f959a[_0x5d9a7d(0x260)]):_0x6a8f31(_0xfc98ea);})['on'](_0x16cefd(0x207),_0x12de1b=>{const _0x3afb30=_0x16cefd;_0x505068[_0x3afb30(0x22e)](_0x30bcac,_0x12de1b);});}),logDebug(_0x246e7c[_0x30337f(0x23e)],_0xeaaac),_0x246e7c['bszVY'](_0x120313,_0x362a39);}catch(_0x28dc63){return _0x246e7c[_0x30337f(0x264)](logError,_0x246e7c['ozcgA'],_0xeaaac,_0x28dc63),'';}return _0x362a39;},_0x29c515=new Promise((_0x3d8909,_0x22699e)=>{const _0x2d3775=_0x483984;getRKeyTaskQueue[_0x2d3775(0x251)](async()=>{const _0x5b2153=_0x2d3775,_0x2bebbf=await _0x246e7c['lTazS'](_0x491dd2);_0x246e7c[_0x5b2153(0x206)](_0x3d8909,_0x2bebbf);});}),_0x36c593=_0x5ccace?privateImageRKey:groupImageRKey,_0x25410a=_0x5ccace?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x246e7c[_0x483984(0x233)](Date['now'](),_0x25410a)>rkeyExpireTime||!_0x36c593){const _0x156857=await _0x29c515;if(_0x156857)return _0x246e7c[_0x483984(0x227)](_0x246e7c[_0x483984(0x1f7)](IMAGE_HTTP_HOST_NT,_0x125558),''+_0x156857);else _0x246e7c['Bjshq'](logError,_0x246e7c['nepgK'],_0x125558);}if(_0x36c593)return _0x246e7c[_0x483984(0x22f)](IMAGE_HTTP_HOST_NT+_0x125558,''+_0x36c593);return'';}else return _0x246e7c[_0x483984(0x236)](IMAGE_HTTP_HOST,_0x125558);}else{if(_0x246e7c[_0x483984(0x23f)](_0x201070,_0x3aae5d))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x246e7c[_0x483984(0x23f)](_0x201070,_0x3aae5d)[_0x483984(0x1fd)]()+'/0';}return logDebug(_0x246e7c[_0x483984(0x250)],_0x5cc172),'';}}export class NTQQFileCacheApi{static async[_0x2a1718(0x21b)](_0x5392fe=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x2a1718(0x225)](_0x503ee7=[_0x2a1718(0x238),_0x2a1718(0x20f)]){const _0x48a876=_0x2a1718;return napCatCore['session'][_0x48a876(0x223)]()[_0x48a876(0x253)](_0x503ee7);}static['addCacheScannedPaths'](_0x7d5509={}){const _0x4fead3=_0x2a1718;return napCatCore[_0x4fead3(0x258)][_0x4fead3(0x223)]()['addCacheScanedPaths'](_0x7d5509);}static[_0x2a1718(0x262)](){const _0x5816c4=_0x2a1718;return napCatCore[_0x5816c4(0x258)][_0x5816c4(0x223)]()['scanCache']();}static[_0x2a1718(0x254)](){return'';}static['getDesktopTmpPath'](){return'';}static['getChatCacheList'](_0x4e3a22,_0x248033=0x3e8,_0x3bbf8b=0x0){const _0x516e25=_0x2a1718;return napCatCore['session'][_0x516e25(0x223)]()[_0x516e25(0x23d)](_0x4e3a22,_0x248033,0x1,_0x3bbf8b);}static[_0x2a1718(0x1f8)](_0x329df9,_0x233fd6=0x3e8,_0x3b4d22){const _0xd1104d=_0x3b4d22?_0x3b4d22:{'fileType':_0x329df9};}static async['clearChatCache'](_0x511194=[],_0x8b88c0=[]){const _0x29187a=_0x2a1718;return napCatCore[_0x29187a(0x258)][_0x29187a(0x223)]()[_0x29187a(0x237)](_0x511194,_0x8b88c0);}}