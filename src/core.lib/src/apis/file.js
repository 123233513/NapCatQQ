const _0x1d4bc2=_0x4599;(function(_0x3953db,_0x5719de){const _0x5494f8=_0x4599,_0x4bbb30=_0x3953db();while(!![]){try{const _0x3d6072=-parseInt(_0x5494f8(0xba))/0x1+-parseInt(_0x5494f8(0xaf))/0x2*(parseInt(_0x5494f8(0x84))/0x3)+parseInt(_0x5494f8(0x8e))/0x4+parseInt(_0x5494f8(0xb9))/0x5+parseInt(_0x5494f8(0x9a))/0x6+-parseInt(_0x5494f8(0x94))/0x7*(-parseInt(_0x5494f8(0xa8))/0x8)+-parseInt(_0x5494f8(0xb7))/0x9;if(_0x3d6072===_0x5719de)break;else _0x4bbb30['push'](_0x4bbb30['shift']());}catch(_0x39de5e){_0x4bbb30['push'](_0x4bbb30['shift']());}}}(_0x27d2,0x63914));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0xa12886 from'path';import _0x11173d from'fs';import _0x27abdf from'fs/promises';function _0x27d2(){const _0x9a21f8=['990424bXUkIu','existsSync','defaultFileDownloadPath','fileUuid','getChatCacheList','getDesktopTmpPath','copyFile','17522GnqKgD','下载超时','filePath','scanCache','downloadRichMedia','indexOf','nSZTS','unlink','5429880spYxry','KEaKa','1959695WSubTE','754488WcSKAj','gcjpa','getRichMediaFilePathForGuild','clearChatCache','start\x20downloadMedia','PIC','UxATD','getRkey','MhUoz','setCacheSilentScan','set','join','getStorageCleanService','/download','BjBPv','getCacheSessionPathList','msgId','ZEyRf','getFileType','NjpuP','getFileSize','clearCache','DsjSO','getMsgService','downloadMedia','图片url获取失败','XKEtC','md5HexStr','ext','6tjpzdN','getFileCacheInfo','tkosO','uKWYt','getImageSize','startsWith','Bcoze','private_rkey','XbegS','Fyzgb','1770028mKDptt','RkciC','onLoginSuccess','clearChatCacheInfo','originImageUrl','toUpperCase','14JiskYe','clearCacheDataByKeys','tmp','getHotUpdateCachePath','vjpmW','util','4206636hqnWsr','TtoZT','session','uploadFile','downloadPath','&rkey=','basename','NfphF','receive\x20downloadMedia\x20task','fileTypeFromFile','onRichMediaDownloadComplete','hkPjN','addCacheScanedPaths','fpHEm'];_0x27d2=function(){return _0x9a21f8;};return _0x27d2();}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x33dd56 from'file-type';import{MsgListener}from'@/core/listeners';import _0x1656b9 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();function _0x4599(_0x1e5cb8,_0x27e73c){const _0x27d281=_0x27d2();return _0x4599=function(_0x459954,_0x5d79e2){_0x459954=_0x459954-0x68;let _0x95a08c=_0x27d281[_0x459954];return _0x95a08c;},_0x4599(_0x1e5cb8,_0x27e73c);}downloadMediaListener[_0x1d4bc2(0xa4)]=_0x182c9e=>{const _0x3dbb26=_0x1d4bc2,_0x365e72={'Bcoze':function(_0x3af7a9,_0x7299af){return _0x3af7a9(_0x7299af);}};for(const [_0x14ae96,_0x299a13]of downloadMediaTasks){_0x365e72[_0x3dbb26(0x8a)](_0x299a13,_0x182c9e),downloadMediaTasks['delete'](_0x14ae96);}},setTimeout(()=>{const _0x1863f0=_0x1d4bc2;napCatCore[_0x1863f0(0x90)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x1d4bc2(0x79)](_0x420f4d){const _0x59c31a=_0x1d4bc2;return _0x33dd56[_0x59c31a(0xa3)](_0x420f4d);}static async['copyFile'](_0x5d1933,_0x2cb5d2){const _0x11ed58=_0x1d4bc2;await napCatCore[_0x11ed58(0x99)][_0x11ed58(0xae)](_0x5d1933,_0x2cb5d2);}static async[_0x1d4bc2(0x7b)](_0x4d1dfa){const _0x87e3fc=_0x1d4bc2;return await napCatCore[_0x87e3fc(0x99)][_0x87e3fc(0x7b)](_0x4d1dfa);}static async[_0x1d4bc2(0x9d)](_0x52b717,_0xfb3bfd=ElementType[_0x1d4bc2(0x6c)],_0x4f70e2=0x0){const _0x24fd4c=_0x1d4bc2,_0x5bcc5f={'DsjSO':function(_0x368faf,_0x5a82f3){return _0x368faf(_0x5a82f3);},'gcjpa':function(_0x5d82a7,_0x5d5010){return _0x5d82a7+_0x5d5010;},'eULXD':function(_0xa34892,_0x103405){return _0xa34892===_0x103405;}},_0x18ee38=await _0x5bcc5f[_0x24fd4c(0x7d)](calculateFileMD5,_0x52b717);let _0x1561ea=(await NTQQFileApi[_0x24fd4c(0x79)](_0x52b717))?.[_0x24fd4c(0x83)]||'';_0x1561ea&&(_0x1561ea=_0x5bcc5f[_0x24fd4c(0x68)]('.',_0x1561ea));let _0x4b20c2=''+_0xa12886[_0x24fd4c(0xa0)](_0x52b717);_0x5bcc5f['eULXD'](_0x4b20c2[_0x24fd4c(0xb4)]('.'),-0x1)&&(_0x4b20c2+=_0x1561ea);const _0x45e14e=napCatCore[_0x24fd4c(0x9c)][_0x24fd4c(0x7e)]()[_0x24fd4c(0x69)]({'md5HexStr':_0x18ee38,'fileName':_0x4b20c2,'elementType':_0xfb3bfd,'elementSubType':_0x4f70e2,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x52b717,_0x45e14e);const _0xd54c85=await NTQQFileApi[_0x24fd4c(0x7b)](_0x52b717);return{'md5':_0x18ee38,'fileName':_0x4b20c2,'path':_0x45e14e,'fileSize':_0xd54c85,'ext':_0x1561ea};}static async[_0x1d4bc2(0x7f)](_0x22f1f9,_0x43a49d,_0x155b85,_0x25171b,_0x4ea75e,_0x2e8915,_0x366138=0x3e8*0x3c*0x2,_0x375bc7=![]){const _0x51761f=_0x1d4bc2,_0xe25e44={'RkciC':function(_0x1cd6ea,_0x36fd6f,_0x479ae4,_0xe54ce8){return _0x1cd6ea(_0x36fd6f,_0x479ae4,_0xe54ce8);},'KEaKa':'downloadMedia\x20complete','MhUoz':function(_0x4b23e2,_0x5e8f08){return _0x4b23e2===_0x5e8f08;},'pZRAE':function(_0x1a6064,_0x7e91a8,_0x2059c7){return _0x1a6064(_0x7e91a8,_0x2059c7);},'hkPjN':_0x51761f(0x9e),'XbegS':function(_0x23d066,_0x4cf471){return _0x23d066(_0x4cf471);},'ZEyRf':function(_0x1b7165,_0x4293ae){return _0x1b7165(_0x4293ae);},'uKWYt':_0x51761f(0xb0),'NfphF':function(_0x136915){return _0x136915();},'nSZTS':function(_0x3d0a92,_0x3b0830,_0x346784){return _0x3d0a92(_0x3b0830,_0x346784);},'UxATD':function(_0x252fe9,_0x4f98f7,_0x2eaff5,_0x492814,_0x123214,_0x27caa7,_0x4b832f,_0x420fa6,_0x2bd28a,_0x3d7b30){return _0x252fe9(_0x4f98f7,_0x2eaff5,_0x492814,_0x123214,_0x27caa7,_0x4b832f,_0x420fa6,_0x2bd28a,_0x3d7b30);},'fpHEm':_0x51761f(0xa2),'BjBPv':_0x51761f(0x6b)};_0xe25e44[_0x51761f(0x6d)](logDebug,_0xe25e44[_0x51761f(0xa7)],_0x22f1f9,_0x43a49d,_0x155b85,_0x25171b,_0x4ea75e,_0x2e8915,_0x366138,_0x375bc7);if(_0x2e8915&&_0x11173d[_0x51761f(0xa9)](_0x2e8915)){if(_0x375bc7)try{await _0x27abdf[_0x51761f(0xb6)](_0x2e8915);}catch(_0x3d4f33){}else return _0x2e8915;}return logDebug(_0xe25e44[_0x51761f(0x75)],_0x22f1f9,_0x43a49d,_0x155b85,_0x25171b,_0x4ea75e,_0x2e8915,_0x366138,_0x375bc7),new Promise((_0x1fedcd,_0x64bdb5)=>{const _0x68a7f9=_0x51761f;let _0x255199=![];const _0x14366f=_0x506b12=>{const _0x1deb47=_0x4599;_0xe25e44[_0x1deb47(0x8f)](logDebug,_0xe25e44[_0x1deb47(0xb8)],_0x506b12,_0x22f1f9);if(_0xe25e44[_0x1deb47(0x6f)](_0x506b12[_0x1deb47(0x77)],_0x22f1f9)){_0x255199=!![];let _0xf2548f=_0x506b12[_0x1deb47(0xb1)];if(_0xf2548f[_0x1deb47(0x89)]('\x5c')){const _0x4f7f0a=sessionConfig[_0x1deb47(0xaa)];_0xe25e44['pZRAE'](logDebug,_0xe25e44[_0x1deb47(0xa5)],_0x4f7f0a),_0xf2548f=_0xa12886[_0x1deb47(0x72)](_0x4f7f0a,_0xf2548f);}_0xe25e44[_0x1deb47(0x8c)](_0x1fedcd,_0xf2548f);}};downloadMediaTasks[_0x68a7f9(0x71)](_0xe25e44[_0x68a7f9(0xa1)](randomUUID),_0x14366f),_0xe25e44[_0x68a7f9(0xb5)](setTimeout,()=>{const _0x475484=_0x68a7f9;!_0x255199&&_0xe25e44[_0x475484(0x78)](_0x64bdb5,_0xe25e44[_0x475484(0x87)]);},_0x366138),napCatCore['session'][_0x68a7f9(0x7e)]()[_0x68a7f9(0xb3)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x22f1f9,'chatType':_0x43a49d,'peerUid':_0x155b85,'elementId':_0x25171b,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4ea75e});});}static async[_0x1d4bc2(0x88)](_0x227881){const _0x556174={'tkosO':function(_0x501bf8,_0x5c2ecc){return _0x501bf8(_0x5c2ecc);}};return new Promise((_0x15eef8,_0x3db8c3)=>{_0x1656b9(_0x227881,(_0x38f3d2,_0x3182c1)=>{const _0x4009a2=_0x4599;_0x38f3d2?_0x556174[_0x4009a2(0x86)](_0x3db8c3,_0x38f3d2):_0x556174[_0x4009a2(0x86)](_0x15eef8,_0x3182c1);});});}static async['getImageUrl'](_0x2fa8c1,_0x9b8259){const _0x4254a0=_0x1d4bc2,_0x586e14={'XKEtC':_0x4254a0(0x9f),'vjpmW':function(_0x5d7d3e,_0x1add89){return _0x5d7d3e+_0x1add89;},'NjpuP':function(_0x240a51,_0x236299){return _0x240a51+_0x236299;},'Fyzgb':function(_0x44c3a5,_0x228ff2){return _0x44c3a5||_0x228ff2;},'VcXxR':function(_0x43364f,_0x3a7268){return _0x43364f||_0x3a7268;},'wwmNY':function(_0xf422d2,_0x14b407,_0x58c461){return _0xf422d2(_0x14b407,_0x58c461);},'TtoZT':_0x4254a0(0x80)};if(!_0x2fa8c1)return'';const _0x10e964=_0x2fa8c1[_0x4254a0(0x92)],_0x2b5e89=_0x2fa8c1[_0x4254a0(0x82)],_0x4df669=_0x2fa8c1['md5HexStr'],_0x2f1577=_0x2fa8c1[_0x4254a0(0xab)];if(_0x10e964){if(_0x10e964['startsWith'](_0x4254a0(0x74))){if(_0x10e964['includes'](_0x586e14[_0x4254a0(0x81)]))return _0x586e14[_0x4254a0(0x98)](IMAGE_HTTP_HOST_NT,_0x10e964);const _0x37575a=await rkeyManager[_0x4254a0(0x6e)](),_0x2a80f5=_0x9b8259?_0x37575a[_0x4254a0(0x8b)]:_0x37575a['group_rkey'];return _0x586e14[_0x4254a0(0x7a)](_0x586e14[_0x4254a0(0x98)](IMAGE_HTTP_HOST_NT,_0x10e964),''+_0x2a80f5);}else return IMAGE_HTTP_HOST+_0x10e964;}else{if(_0x586e14[_0x4254a0(0x8d)](_0x4df669,_0x2b5e89))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x586e14['VcXxR'](_0x4df669,_0x2b5e89)[_0x4254a0(0x93)]()+'/0';}return _0x586e14['wwmNY'](logDebug,_0x586e14[_0x4254a0(0x9b)],_0x2fa8c1),'';}}export class NTQQFileCacheApi{static async[_0x1d4bc2(0x70)](_0x17fde0=!![]){return'';}static[_0x1d4bc2(0x76)](){return'';}static[_0x1d4bc2(0x7c)](_0x3925af=[_0x1d4bc2(0x96),'hotUpdate']){const _0x357be4=_0x1d4bc2;return napCatCore[_0x357be4(0x9c)][_0x357be4(0x73)]()[_0x357be4(0x95)](_0x3925af);}static['addCacheScannedPaths'](_0x2efd84={}){const _0xfb7994=_0x1d4bc2;return napCatCore['session'][_0xfb7994(0x73)]()[_0xfb7994(0xa6)](_0x2efd84);}static[_0x1d4bc2(0xb2)](){const _0x3e7841=_0x1d4bc2;return napCatCore['session'][_0x3e7841(0x73)]()[_0x3e7841(0xb2)]();}static[_0x1d4bc2(0x97)](){return'';}static[_0x1d4bc2(0xad)](){return'';}static[_0x1d4bc2(0xac)](_0x3c51a9,_0x5f026d=0x3e8,_0x2639f2=0x0){const _0x42c330=_0x1d4bc2;return napCatCore[_0x42c330(0x9c)][_0x42c330(0x73)]()['getChatCacheInfo'](_0x3c51a9,_0x5f026d,0x1,_0x2639f2);}static[_0x1d4bc2(0x85)](_0x1425de,_0xd38cae=0x3e8,_0x80d36){const _0x18c4fa=_0x80d36?_0x80d36:{'fileType':_0x1425de};}static async[_0x1d4bc2(0x6a)](_0x1e248f=[],_0x590bf2=[]){const _0x43d175=_0x1d4bc2;return napCatCore[_0x43d175(0x9c)]['getStorageCleanService']()[_0x43d175(0x91)](_0x1e248f,_0x590bf2);}}