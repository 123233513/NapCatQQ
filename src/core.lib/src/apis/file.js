const _0xefb9f=_0x9cdc;function _0x3e5b(){const _0x52ce17=['PIC','20845MmwoBo','getImageSize','clearCacheDataByKeys','setCacheSilentScan','7XpqCSM','getChatCacheInfo','indexOf','rqcoZ','uploadFile','delete','60woxOvD','copyFile','BWLXw','/gchatpic_new/0/0-0-','defaultFileDownloadPath','scanCache','unlink','util','getRichMediaFilePathForGuild','getFileType','getStorageCleanService','1107504qmeIPZ','hotUpdate','getFileCacheInfo','filePath','private_rkey','onLoginSuccess','toUpperCase','addCacheScannedPaths','fileUuid','basename','9434800yRXyKk','&rkey=','downloadRichMedia','51444RPzWvE','ext','5955uAtONj','startsWith','set','5246329QwdPcb','zCFGk','addCacheScanedPaths','WUxwF','/download','getCacheSessionPathList','onRichMediaDownloadComplete','jnwqk','wdwze','RTfJu','408FDqeil','getDesktopTmpPath','6996RVlTSM','downloadMedia','图片url获取失败','tmp','zQFaH','getChatCacheList','includes','originImageUrl','clearChatCacheInfo','fileTypeFromFile','clearCache','msgId','addListener','getFileSize','getMsgService','existsSync','174WrvKFC','下载超时','session'];_0x3e5b=function(){return _0x52ce17;};return _0x3e5b();}(function(_0x2dcd5a,_0x12e06d){const _0x597f5b=_0x9cdc,_0x259a55=_0x2dcd5a();while(!![]){try{const _0x1d7969=-parseInt(_0x597f5b(0x110))/0x1*(parseInt(_0x597f5b(0xe7))/0x2)+-parseInt(_0x597f5b(0x101))/0x3*(parseInt(_0x597f5b(0x10e))/0x4)+parseInt(_0x597f5b(0xdd))/0x5*(-parseInt(_0x597f5b(0xd9))/0x6)+parseInt(_0x597f5b(0xe1))/0x7*(-parseInt(_0x597f5b(0xf2))/0x8)+-parseInt(_0x597f5b(0xff))/0x9+parseInt(_0x597f5b(0xfc))/0xa+parseInt(_0x597f5b(0x104))/0xb;if(_0x1d7969===_0x12e06d)break;else _0x259a55['push'](_0x259a55['shift']());}catch(_0x236163){_0x259a55['push'](_0x259a55['shift']());}}}(_0x3e5b,0xb5666));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1a379c from'path';import _0x21feb7 from'fs';import _0x5e0fb7 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0x9cdc(_0x170654,_0x5e5e81){const _0x3e5b47=_0x3e5b();return _0x9cdc=function(_0x9cdc25,_0x3258b5){_0x9cdc25=_0x9cdc25-0xcd;let _0x5d98dc=_0x3e5b47[_0x9cdc25];return _0x5d98dc;},_0x9cdc(_0x170654,_0x5e5e81);}import*as _0x3e18c4 from'file-type';import{MsgListener}from'@/core/listeners';import _0x1b62e3 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0xefb9f(0x10a)]=_0x841eef=>{const _0x47a8ca=_0xefb9f,_0x5d3baf={'fdaWP':function(_0x5516d2,_0x548842){return _0x5516d2(_0x548842);}};for(const [_0x5f1f18,_0x6b0f7d]of downloadMediaTasks){_0x5d3baf['fdaWP'](_0x6b0f7d,_0x841eef),downloadMediaTasks[_0x47a8ca(0xe6)](_0x5f1f18);}},setTimeout(()=>{const _0x3eb4e2=_0xefb9f;napCatCore[_0x3eb4e2(0xf7)](()=>{const _0x148e6b=_0x3eb4e2;napCatCore[_0x148e6b(0xd5)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0xefb9f(0xf0)](_0x576661){const _0x364338=_0xefb9f;return _0x3e18c4[_0x364338(0xd2)](_0x576661);}static async[_0xefb9f(0xe8)](_0xf621ac,_0x22cbac){const _0xafa5c3=_0xefb9f;await napCatCore[_0xafa5c3(0xee)][_0xafa5c3(0xe8)](_0xf621ac,_0x22cbac);}static async[_0xefb9f(0xd6)](_0x32b751){const _0x5b8f95=_0xefb9f;return await napCatCore[_0x5b8f95(0xee)][_0x5b8f95(0xd6)](_0x32b751);}static async[_0xefb9f(0xe5)](_0x21c523,_0x57151f=ElementType[_0xefb9f(0xdc)],_0x48ab6f=0x0){const _0x233faf=_0xefb9f,_0x1e97a5={'zQFaH':function(_0x1ae054,_0x43bbf8){return _0x1ae054+_0x43bbf8;},'UVhjE':function(_0x480245,_0x561078){return _0x480245===_0x561078;}},_0x55f518=await calculateFileMD5(_0x21c523);let _0x2e767c=(await NTQQFileApi[_0x233faf(0xf0)](_0x21c523))?.[_0x233faf(0x100)]||'';_0x2e767c&&(_0x2e767c=_0x1e97a5[_0x233faf(0xcd)]('.',_0x2e767c));let _0x5af73a=''+_0x1a379c[_0x233faf(0xfb)](_0x21c523);_0x1e97a5['UVhjE'](_0x5af73a[_0x233faf(0xe3)]('.'),-0x1)&&(_0x5af73a+=_0x2e767c);const _0x1a8521=napCatCore[_0x233faf(0xdb)][_0x233faf(0xd7)]()[_0x233faf(0xef)]({'md5HexStr':_0x55f518,'fileName':_0x5af73a,'elementType':_0x57151f,'elementSubType':_0x48ab6f,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x233faf(0xe8)](_0x21c523,_0x1a8521);const _0x239c4d=await NTQQFileApi[_0x233faf(0xd6)](_0x21c523);return{'md5':_0x55f518,'fileName':_0x5af73a,'path':_0x1a8521,'fileSize':_0x239c4d,'ext':_0x2e767c};}static async[_0xefb9f(0x111)](_0x2e8345,_0x1fdc92,_0x31b4dd,_0x95e704,_0x49bf69,_0x4dc626,_0x4d37eb=0x3e8*0x3c*0x2,_0x314460=![]){const _0x55e7e4=_0xefb9f,_0x29426b={'cZfUC':function(_0x71238e,_0x2777f3){return _0x71238e===_0x2777f3;},'WUxwF':function(_0x135636,_0x1edb61){return _0x135636(_0x1edb61);},'jsRqB':_0x55e7e4(0xda)};if(_0x4dc626&&_0x21feb7[_0x55e7e4(0xd8)](_0x4dc626)){if(_0x314460)try{await _0x5e0fb7[_0x55e7e4(0xed)](_0x4dc626);}catch(_0x4b7e90){}else return _0x4dc626;}return new Promise((_0x4f6a2a,_0x2c21c4)=>{const _0x371a4a=_0x55e7e4;let _0x4fbf95=![];const _0x9755de=_0x3bce1e=>{const _0x3e7e6d=_0x9cdc;if(_0x29426b['cZfUC'](_0x3bce1e[_0x3e7e6d(0xd4)],_0x2e8345)){_0x4fbf95=!![];let _0x831049=_0x3bce1e[_0x3e7e6d(0xf5)];if(_0x831049[_0x3e7e6d(0x102)]('\x5c')){const _0x28717e=sessionConfig[_0x3e7e6d(0xeb)];_0x831049=_0x1a379c['join'](_0x28717e,_0x831049);}_0x29426b[_0x3e7e6d(0x107)](_0x4f6a2a,_0x831049);}};downloadMediaTasks[_0x371a4a(0x103)](randomUUID(),_0x9755de),setTimeout(()=>{const _0x395755=_0x371a4a;!_0x4fbf95&&_0x29426b[_0x395755(0x107)](_0x2c21c4,_0x29426b['jsRqB']);},_0x4d37eb),napCatCore[_0x371a4a(0xdb)]['getMsgService']()[_0x371a4a(0xfe)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x2e8345,'chatType':_0x1fdc92,'peerUid':_0x31b4dd,'elementId':_0x95e704,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x49bf69});});}static async[_0xefb9f(0xde)](_0x3cc4e5){const _0x327147={'RTfJu':function(_0x3a2ff4,_0x4e484a,_0x3016bf){return _0x3a2ff4(_0x4e484a,_0x3016bf);}};return new Promise((_0x4b0bfd,_0x180d67)=>{const _0x15a6c9=_0x9cdc;_0x327147[_0x15a6c9(0x10d)](_0x1b62e3,_0x3cc4e5,(_0x2ee95d,_0x1fe98f)=>{_0x2ee95d?_0x180d67(_0x2ee95d):_0x4b0bfd(_0x1fe98f);});});}static async['getImageUrl'](_0x4c0579,_0x2fd0d7){const _0x509cde=_0xefb9f,_0x3ca071={'Oxjkk':_0x509cde(0x108),'qMkii':_0x509cde(0xfd),'wdwze':function(_0x2b7645,_0x317a3d){return _0x2b7645+_0x317a3d;},'BWLXw':function(_0x171909,_0x360e98){return _0x171909+_0x360e98;},'zCFGk':function(_0x86b49c,_0x4fd0cd){return _0x86b49c+_0x4fd0cd;},'jnwqk':function(_0xac2480,_0x47624d){return _0xac2480||_0x47624d;},'rqcoZ':function(_0x20fef7,_0x15cd4e,_0x1c3417){return _0x20fef7(_0x15cd4e,_0x1c3417);},'NGRgw':_0x509cde(0x112)};if(!_0x4c0579)return'';const _0x4679cb=_0x4c0579[_0x509cde(0xd0)],_0x5d73c6=_0x4c0579['md5HexStr'],_0x9cd402=_0x4c0579['md5HexStr'],_0x5c2ec5=_0x4c0579[_0x509cde(0xfa)];if(_0x4679cb){if(_0x4679cb[_0x509cde(0x102)](_0x3ca071['Oxjkk'])){if(_0x4679cb[_0x509cde(0xcf)](_0x3ca071['qMkii']))return _0x3ca071[_0x509cde(0x10c)](IMAGE_HTTP_HOST_NT,_0x4679cb);const _0x11e3d2=await rkeyManager['getRkey'](),_0x2118d1=_0x2fd0d7?_0x11e3d2[_0x509cde(0xf6)]:_0x11e3d2['group_rkey'];return _0x3ca071[_0x509cde(0xe9)](IMAGE_HTTP_HOST_NT,_0x4679cb)+(''+_0x2118d1);}else return _0x3ca071[_0x509cde(0x105)](IMAGE_HTTP_HOST,_0x4679cb);}else{if(_0x9cd402||_0x5d73c6)return IMAGE_HTTP_HOST+_0x509cde(0xea)+_0x3ca071[_0x509cde(0x10b)](_0x9cd402,_0x5d73c6)[_0x509cde(0xf8)]()+'/0';}return _0x3ca071[_0x509cde(0xe4)](logDebug,_0x3ca071['NGRgw'],_0x4c0579),'';}}export class NTQQFileCacheApi{static async[_0xefb9f(0xe0)](_0x45659d=!![]){return'';}static[_0xefb9f(0x109)](){return'';}static[_0xefb9f(0xd3)](_0x4c7a14=[_0xefb9f(0x113),_0xefb9f(0xf3)]){const _0x3ea12b=_0xefb9f;return napCatCore['session'][_0x3ea12b(0xf1)]()[_0x3ea12b(0xdf)](_0x4c7a14);}static[_0xefb9f(0xf9)](_0x277d0e={}){const _0x2f260e=_0xefb9f;return napCatCore[_0x2f260e(0xdb)][_0x2f260e(0xf1)]()[_0x2f260e(0x106)](_0x277d0e);}static[_0xefb9f(0xec)](){const _0x104177=_0xefb9f;return napCatCore[_0x104177(0xdb)][_0x104177(0xf1)]()[_0x104177(0xec)]();}static['getHotUpdateCachePath'](){return'';}static[_0xefb9f(0x10f)](){return'';}static[_0xefb9f(0xce)](_0x3f16cc,_0x4f05e9=0x3e8,_0xb5e2f9=0x0){const _0x1f2463=_0xefb9f;return napCatCore[_0x1f2463(0xdb)][_0x1f2463(0xf1)]()[_0x1f2463(0xe2)](_0x3f16cc,_0x4f05e9,0x1,_0xb5e2f9);}static[_0xefb9f(0xf4)](_0x1c156a,_0x33bdc4=0x3e8,_0x2decd2){const _0x6be3b7=_0x2decd2?_0x2decd2:{'fileType':_0x1c156a};}static async['clearChatCache'](_0x5597da=[],_0x417a2f=[]){const _0x1a09c8=_0xefb9f;return napCatCore[_0x1a09c8(0xdb)][_0x1a09c8(0xf1)]()[_0x1a09c8(0xd1)](_0x5597da,_0x417a2f);}}