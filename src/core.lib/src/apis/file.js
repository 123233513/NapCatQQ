const _0xc92868=_0x58c6;(function(_0x5eba76,_0x4dc5dc){const _0x4896d9=_0x58c6,_0x25d6f6=_0x5eba76();while(!![]){try{const _0x5f4a58=-parseInt(_0x4896d9(0x80))/0x1*(-parseInt(_0x4896d9(0xb8))/0x2)+-parseInt(_0x4896d9(0xdb))/0x3*(parseInt(_0x4896d9(0xde))/0x4)+parseInt(_0x4896d9(0xa6))/0x5+parseInt(_0x4896d9(0xe4))/0x6+-parseInt(_0x4896d9(0xd8))/0x7*(parseInt(_0x4896d9(0xc0))/0x8)+-parseInt(_0x4896d9(0xbe))/0x9+-parseInt(_0x4896d9(0x92))/0xa*(-parseInt(_0x4896d9(0x88))/0xb);if(_0x5f4a58===_0x4dc5dc)break;else _0x25d6f6['push'](_0x25d6f6['shift']());}catch(_0x4f9d2b){_0x25d6f6['push'](_0x25d6f6['shift']());}}}(_0x3ef6,0xa182c));function _0x58c6(_0x3b87b1,_0x327657){const _0x3ef67c=_0x3ef6();return _0x58c6=function(_0x58c662,_0x390bf3){_0x58c662=_0x58c662-0x76;let _0x16c1ef=_0x3ef67c[_0x58c662];return _0x16c1ef;},_0x58c6(_0x3b87b1,_0x327657);}import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1586bd from'path';import _0x23e3a0 from'fs';import _0x411272 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x3b7740 from'file-type';import{MsgListener}from'@/core/listeners';import _0xface3 from'image-size';function _0x3ef6(){const _0x58e7d5=['kWKpm','hookApi\x20is\x20not\x20available','lXgXj','tmp','4828645UBSHCZ','bViTu','图片rkey获取失败','getFileType','MUTHH','KPvcI','catch','elements','Ibnjb','join','addTask','bsiSc','FAtmv','addListener','fSiPS','PIC','myFsp','图片url获取失败','2Whpiwx','originImageUrl','IQnWK','basename','group','then','4178880smSHzX','getImageSize','9547336CksHhd','/download','isAvailable','setCacheSilentScan','session','jntxw','scanCache','clearChatCache','downloadPath','aVVuR','QzmeQ','CUskj','getDesktopTmpPath','clearCacheDataByKeys','getStorageCleanService','CzkfJ','onLoginSuccess','set','MsMKp','includes','开始调用moeHook获取rkey','hotUpdate','UKBqw','startsWith','7SJaLAH','downloadMedia','getFileCacheInfo','496464KCTrJR','GenKq','kecGz','20OPBmOw','getRichMediaFilePathForGuild','onRichMediaDownloadComplete','getMsgService','statusCode','DQuCU','4865046ediyky','UFzBS','md5HexStr','start\x20downloadMedia','DOZBF','getChatCacheList','ElZaS','elementId','getFileSize','bNhwG','检查rkey是否有效','549638oWCnCi','sourcePath','hbsua','mHkhh','下载超时','FhPsY','ugxdV','bkkVm','1529cOZFFs','unlink','uploadFile','chatType','msgId','图片rkey有效','vsCrR','mciIJ','downloadMedia\x20complete','getCacheSessionPathList','59030YDzlVr','picElement','copyFile','uKHMc','filePath','/gchatpic_new/0/0-0-','indexOf','xqbhU','now','util','ZrkvM','pXmDs','javVZ','error','addCacheScannedPaths','getImageUrl'];_0x3ef6=function(){return _0x58e7d5;};return _0x3ef6();}import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0x2c9409 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0xc92868(0xe0)]=_0x16f03a=>{const _0x5be2a3=_0xc92868,_0x175548={'ZrkvM':function(_0x2d5611,_0x1c42f3){return _0x2d5611(_0x1c42f3);}};for(const [_0x32014d,_0x3ebd8d]of downloadMediaTasks){_0x175548[_0x5be2a3(0x9c)](_0x3ebd8d,_0x16f03a),downloadMediaTasks['delete'](_0x32014d);}},setTimeout(()=>{const _0x3c7877=_0xc92868;napCatCore[_0x3c7877(0xd0)](()=>{const _0x4e159c=_0x3c7877;napCatCore[_0x4e159c(0xb3)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0xc92868(0xa9)](_0x524c80){return _0x3b7740['fileTypeFromFile'](_0x524c80);}static async[_0xc92868(0x94)](_0xf85d6c,_0x1c5609){const _0x273ee7=_0xc92868;await napCatCore[_0x273ee7(0x9b)][_0x273ee7(0x94)](_0xf85d6c,_0x1c5609);}static async[_0xc92868(0x7d)](_0x1d3ae0){const _0x5ef5d2=_0xc92868;return await napCatCore[_0x5ef5d2(0x9b)][_0x5ef5d2(0x7d)](_0x1d3ae0);}static async[_0xc92868(0x8a)](_0x5a16f6,_0x15231d=ElementType[_0xc92868(0xb5)],_0x4b6a6c=0x0){const _0x1fc4f0=_0xc92868,_0x52f541={'FhPsY':function(_0x388ab1,_0x29b51d){return _0x388ab1+_0x29b51d;},'jntxw':function(_0x5702d7,_0xbdebbd){return _0x5702d7===_0xbdebbd;}},_0x1cf268=await calculateFileMD5(_0x5a16f6);let _0x32db73=(await NTQQFileApi[_0x1fc4f0(0xa9)](_0x5a16f6))?.['ext']||'';_0x32db73&&(_0x32db73=_0x52f541[_0x1fc4f0(0x85)]('.',_0x32db73));let _0x576a5e=''+_0x1586bd[_0x1fc4f0(0xbb)](_0x5a16f6);_0x52f541[_0x1fc4f0(0xc5)](_0x576a5e[_0x1fc4f0(0x98)]('.'),-0x1)&&(_0x576a5e+=_0x32db73);const _0x33b755=napCatCore[_0x1fc4f0(0xc4)][_0x1fc4f0(0xe1)]()[_0x1fc4f0(0xdf)]({'md5HexStr':_0x1cf268,'fileName':_0x576a5e,'elementType':_0x15231d,'elementSubType':_0x4b6a6c,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x1fc4f0(0x94)](_0x5a16f6,_0x33b755);const _0x14a4f1=await NTQQFileApi[_0x1fc4f0(0x7d)](_0x5a16f6);return{'md5':_0x1cf268,'fileName':_0x576a5e,'path':_0x33b755,'fileSize':_0x14a4f1,'ext':_0x32db73};}static async[_0xc92868(0xd9)](_0x465ffd,_0x534c15,_0x2a8d7e,_0x40ec1d,_0x477ba6,_0x5c0e97,_0x542c25=0x3e8*0x3c*0x2,_0x45a395=![]){const _0x17738e=_0xc92868,_0x443168={'mHkhh':_0x17738e(0x84),'Ibnjb':function(_0x53fdef,_0x29bee0,_0x571f71,_0x29b08d){return _0x53fdef(_0x29bee0,_0x571f71,_0x29b08d);},'bViTu':function(_0x17434c,_0x52d8d2,_0x205b90){return _0x17434c(_0x52d8d2,_0x205b90);},'ElZaS':function(_0x5c4c9e,_0x524da4){return _0x5c4c9e(_0x524da4);},'BxMUw':function(_0x28aaba){return _0x28aaba();},'UKBqw':function(_0x1604a6,_0x428167,_0x143a89,_0x5871bb,_0x14ddde,_0x8ac1d9,_0x21be45,_0x224957,_0x4bdcb4,_0xf00384){return _0x1604a6(_0x428167,_0x143a89,_0x5871bb,_0x14ddde,_0x8ac1d9,_0x21be45,_0x224957,_0x4bdcb4,_0xf00384);},'IQnWK':'receive\x20downloadMedia\x20task','kWKpm':function(_0x413fbd,_0x2ca87e,_0x44fe34,_0x109ea4,_0x572940,_0x557236,_0x4f757f,_0x2ce15f,_0x5808aa,_0x5a05cb){return _0x413fbd(_0x2ca87e,_0x44fe34,_0x109ea4,_0x572940,_0x557236,_0x4f757f,_0x2ce15f,_0x5808aa,_0x5a05cb);},'aVVuR':_0x17738e(0x78)};_0x443168[_0x17738e(0xd6)](logDebug,_0x443168[_0x17738e(0xba)],_0x465ffd,_0x534c15,_0x2a8d7e,_0x40ec1d,_0x477ba6,_0x5c0e97,_0x542c25,_0x45a395);if(_0x5c0e97&&_0x23e3a0['existsSync'](_0x5c0e97)){if(_0x45a395)try{await _0x411272[_0x17738e(0x89)](_0x5c0e97);}catch(_0x4affd7){}else return _0x5c0e97;}return _0x443168[_0x17738e(0xa2)](logDebug,_0x443168[_0x17738e(0xc9)],_0x465ffd,_0x534c15,_0x2a8d7e,_0x40ec1d,_0x477ba6,_0x5c0e97,_0x542c25,_0x45a395),new Promise((_0x25712d,_0x5ee221)=>{const _0xf2ddae=_0x17738e,_0x1f36cc={'lXgXj':function(_0x398871,_0x1015c2,_0x1809d9,_0x4e6b6b){const _0x52fc99=_0x58c6;return _0x443168[_0x52fc99(0xae)](_0x398871,_0x1015c2,_0x1809d9,_0x4e6b6b);},'MUTHH':_0xf2ddae(0x90),'eVEIb':function(_0x50dfd6,_0x170dd2,_0x2488f8){return _0x443168['bViTu'](_0x50dfd6,_0x170dd2,_0x2488f8);},'UFzBS':function(_0x2a4d4b,_0x5554de){const _0x96cc6e=_0xf2ddae;return _0x443168[_0x96cc6e(0x7b)](_0x2a4d4b,_0x5554de);}};let _0x2d91b8=![];const _0x24f2a4=_0x3be5fa=>{const _0x35f6b3=_0xf2ddae;_0x1f36cc[_0x35f6b3(0xa4)](logDebug,_0x1f36cc[_0x35f6b3(0xaa)],_0x3be5fa,_0x465ffd);if(_0x3be5fa[_0x35f6b3(0x8c)]===_0x465ffd){_0x2d91b8=!![];let _0x4eb763=_0x3be5fa[_0x35f6b3(0x96)];if(_0x4eb763['startsWith']('\x5c')){const _0x3ee043=sessionConfig['defaultFileDownloadPath'];_0x1f36cc['eVEIb'](logDebug,_0x35f6b3(0xc8),_0x3ee043),_0x4eb763=_0x1586bd[_0x35f6b3(0xaf)](_0x3ee043,_0x4eb763);}_0x1f36cc[_0x35f6b3(0x76)](_0x25712d,_0x4eb763);}};downloadMediaTasks[_0xf2ddae(0xd1)](_0x443168['BxMUw'](randomUUID),_0x24f2a4),_0x443168[_0xf2ddae(0xa7)](setTimeout,()=>{const _0x2d966c=_0xf2ddae;!_0x2d91b8&&_0x5ee221(_0x443168[_0x2d966c(0x83)]);},_0x542c25),napCatCore[_0xf2ddae(0xc4)][_0xf2ddae(0xe1)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x465ffd,'chatType':_0x534c15,'peerUid':_0x2a8d7e,'elementId':_0x40ec1d,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x477ba6});});}static async[_0xc92868(0xbf)](_0x1a7f0e){const _0x4ea815={'bNhwG':function(_0x2889e8,_0x5c6d4a){return _0x2889e8(_0x5c6d4a);},'bsiSc':function(_0x35d069,_0x14a6c1,_0x2e75b4){return _0x35d069(_0x14a6c1,_0x2e75b4);}};return new Promise((_0x1a6af8,_0x249a5e)=>{const _0x2caeb9=_0x58c6;_0x4ea815[_0x2caeb9(0xb1)](_0xface3,_0x1a7f0e,(_0x47a2f4,_0x383e2d)=>{const _0xa02eba=_0x2caeb9;_0x47a2f4?_0x249a5e(_0x47a2f4):_0x4ea815[_0xa02eba(0x7e)](_0x1a6af8,_0x383e2d);});});}static async[_0xc92868(0xa1)](_0x284378){const _0x545403=_0xc92868,_0x35e186={'javVZ':_0x545403(0x9f),'MsMKp':function(_0xc2b434,_0x5e8428){return _0xc2b434!==_0x5e8428;},'myFsp':function(_0x18a5b4,_0xc3bc6b){return _0x18a5b4(_0xc3bc6b);},'uKHMc':'获取图片rkey...','bkkVm':function(_0x247833,_0x1ef88c){return _0x247833(_0x1ef88c);},'pXmDs':_0x545403(0xd4),'CzkfJ':function(_0x6d568,_0x457a7e){return _0x6d568+_0x457a7e;},'FAtmv':_0x545403(0x7f),'CUskj':function(_0x4a3c80,_0x392b99,_0x3e289e){return _0x4a3c80(_0x392b99,_0x3e289e);},'xqbhU':_0x545403(0x8d),'PkLBg':function(_0x598f35,_0x1eba24){return _0x598f35(_0x1eba24);},'kecGz':function(_0x21434e,_0xa08508,_0x2bb236,_0x4ff0c5){return _0x21434e(_0xa08508,_0x2bb236,_0x4ff0c5);},'WZWcG':'图片rkey有误','Uamtg':_0x545403(0xc1),'KPvcI':'&rkey=','GenKq':function(_0x1e4f5a,_0x22969d){return _0x1e4f5a(_0x22969d);},'ugxdV':_0x545403(0xa3),'QzmeQ':function(_0x88394a,_0x16910d){return _0x88394a>_0x16910d;},'mciIJ':function(_0x6d48a3,_0x2f6371){return _0x6d48a3-_0x2f6371;},'fSiPS':function(_0xa993de,_0x51ab26){return _0xa993de+_0x51ab26;},'cZmwI':_0x545403(0xa8),'vsCrR':function(_0x3c8c44,_0x35e55b){return _0x3c8c44+_0x35e55b;},'hbsua':function(_0x34361b,_0x546f87){return _0x34361b||_0x546f87;},'adlpJ':_0x545403(0xb7)},_0x4feb62=_0x35e186[_0x545403(0xd2)](_0x284378[_0x545403(0x8b)],ChatType[_0x545403(0xbc)]),_0x3bb15f=_0x284378[_0x545403(0xad)]['find'](_0x2fce58=>!!_0x2fce58[_0x545403(0x93)]);if(!_0x3bb15f)return'';const _0x28e869=_0x3bb15f[_0x545403(0x93)][_0x545403(0xb9)],_0x284906=_0x3bb15f[_0x545403(0x93)][_0x545403(0x77)],_0x292cd8=_0x3bb15f[_0x545403(0x93)][_0x545403(0x77)],_0x15c435=_0x3bb15f['picElement']['fileUuid'],_0x3ecbf9=_0xb3e18=>{const _0x117b5b=_0x545403;_0x4feb62?(privateImageRKey=_0xb3e18,lastGetPrivateRKeyTime=Date['now']()):(groupImageRKey=_0xb3e18,lastGetGroupRKeyTime=Date[_0x117b5b(0x9a)]());};if(_0x28e869){if(_0x28e869[_0x545403(0xd7)](_0x35e186['Uamtg'])){if(_0x28e869[_0x545403(0xd3)](_0x35e186[_0x545403(0xab)]))return _0x35e186[_0x545403(0xcf)](IMAGE_HTTP_HOST_NT,_0x28e869);if(!hookApi[_0x545403(0xc2)]())return _0x35e186[_0x545403(0xdc)](logDebug,_0x35e186[_0x545403(0x86)]),'';const _0x1393d5=async()=>{const _0x2867fe=_0x545403,_0xe58866={'MANXz':function(_0x6c4762,_0x534c22){return _0x35e186['MsMKp'](_0x6c4762,_0x534c22);},'DOZBF':function(_0x55a5e8,_0x56ea0c){const _0x1fa92b=_0x58c6;return _0x35e186[_0x1fa92b(0xb6)](_0x55a5e8,_0x56ea0c);}};_0x35e186['myFsp'](logDebug,_0x35e186[_0x2867fe(0x95)]),NTQQFileApi['downloadMedia'](_0x284378[_0x2867fe(0x8c)],_0x284378[_0x2867fe(0x8b)],_0x284378['peerUid'],_0x3bb15f[_0x2867fe(0x7c)],'',_0x3bb15f[_0x2867fe(0x93)][_0x2867fe(0x81)],0x3e8*0x1e,![])[_0x2867fe(0xbd)](_0x4171ae=>{})[_0x2867fe(0xac)](logError),await _0x35e186['myFsp'](sleep,0x3e8),_0x35e186['bkkVm'](logDebug,_0x35e186[_0x2867fe(0x9d)]);const _0x40f2bb=hookApi['getRKey']()||'',_0x34d4d7=_0x35e186['CzkfJ'](_0x35e186[_0x2867fe(0xcf)](IMAGE_HTTP_HOST_NT,_0x28e869),_0x40f2bb);if(_0x40f2bb)try{logDebug(_0x35e186[_0x2867fe(0xb2)],_0x34d4d7),await new Promise((_0x56fb24,_0x2eca4d)=>{const _0x28f245=_0x2867fe;_0x2c9409['get'](_0x34d4d7,_0xc18814=>{const _0x5eeaa=_0x58c6;_0xe58866['MANXz'](_0xc18814[_0x5eeaa(0xe2)],0xc8)?_0xe58866[_0x5eeaa(0x79)](_0x2eca4d,_0x5eeaa(0xa8)):_0xe58866[_0x5eeaa(0x79)](_0x56fb24,_0xc18814);})['on'](_0x35e186[_0x28f245(0x9e)],_0x220a9e=>{_0x2eca4d(_0x220a9e);});}),_0x35e186[_0x2867fe(0xcb)](logDebug,_0x35e186[_0x2867fe(0x99)],_0x34d4d7),_0x35e186['PkLBg'](_0x3ecbf9,_0x40f2bb);}catch(_0x15576b){return _0x35e186[_0x2867fe(0xdd)](logError,_0x35e186['WZWcG'],_0x34d4d7,_0x15576b),'';}return _0x40f2bb;},_0x12add3=new Promise((_0x2a0e02,_0x2b5f15)=>{const _0x287428=_0x545403,_0x1cabb9={'DQuCU':function(_0x5bf93a,_0x14e76f){const _0x170b48=_0x58c6;return _0x35e186[_0x170b48(0x87)](_0x5bf93a,_0x14e76f);}};getRKeyTaskQueue[_0x287428(0xb0)](async()=>{const _0x2401c4=_0x287428,_0x4da0d7=await _0x1393d5();_0x1cabb9[_0x2401c4(0xe3)](_0x2a0e02,_0x4da0d7);});}),_0x1fa0fc=_0x4feb62?privateImageRKey:groupImageRKey,_0x3fcc95=_0x4feb62?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x35e186[_0x545403(0xca)](_0x35e186[_0x545403(0x8f)](Date[_0x545403(0x9a)](),_0x3fcc95),rkeyExpireTime)||!_0x1fa0fc){const _0x6e876a=await _0x12add3;if(_0x6e876a)return _0x35e186[_0x545403(0xb4)](_0x35e186[_0x545403(0xb4)](IMAGE_HTTP_HOST_NT,_0x28e869),''+_0x6e876a);else _0x35e186[_0x545403(0xcb)](logError,_0x35e186['cZmwI'],_0x28e869);}if(_0x1fa0fc)return _0x35e186[_0x545403(0x8e)](IMAGE_HTTP_HOST_NT+_0x28e869,''+_0x1fa0fc);return'';}else return _0x35e186[_0x545403(0x8e)](IMAGE_HTTP_HOST,_0x28e869);}else{if(_0x35e186[_0x545403(0x82)](_0x292cd8,_0x284906))return IMAGE_HTTP_HOST+_0x545403(0x97)+_0x35e186[_0x545403(0x82)](_0x292cd8,_0x284906)['toUpperCase']()+'/0';}return _0x35e186[_0x545403(0xcb)](logDebug,_0x35e186['adlpJ'],_0x284378),'';}}export class NTQQFileCacheApi{static async[_0xc92868(0xc3)](_0x24eef3=!![]){return'';}static[_0xc92868(0x91)](){return'';}static['clearCache'](_0x44f1c3=[_0xc92868(0xa5),_0xc92868(0xd5)]){const _0x5d5bc0=_0xc92868;return napCatCore[_0x5d5bc0(0xc4)]['getStorageCleanService']()[_0x5d5bc0(0xcd)](_0x44f1c3);}static[_0xc92868(0xa0)](_0x27101c={}){const _0xa87003=_0xc92868;return napCatCore[_0xa87003(0xc4)]['getStorageCleanService']()['addCacheScanedPaths'](_0x27101c);}static[_0xc92868(0xc6)](){const _0x116459=_0xc92868;return napCatCore['session'][_0x116459(0xce)]()[_0x116459(0xc6)]();}static['getHotUpdateCachePath'](){return'';}static[_0xc92868(0xcc)](){return'';}static[_0xc92868(0x7a)](_0x444a1f,_0x11c775=0x3e8,_0x9c57b3=0x0){const _0x4840c3=_0xc92868;return napCatCore['session'][_0x4840c3(0xce)]()['getChatCacheInfo'](_0x444a1f,_0x11c775,0x1,_0x9c57b3);}static[_0xc92868(0xda)](_0x1f286e,_0x5e30d2=0x3e8,_0x5b7812){const _0x355fe0=_0x5b7812?_0x5b7812:{'fileType':_0x1f286e};}static async[_0xc92868(0xc7)](_0x305934=[],_0x53597a=[]){const _0x37aea4=_0xc92868;return napCatCore[_0x37aea4(0xc4)][_0x37aea4(0xce)]()['clearChatCacheInfo'](_0x305934,_0x53597a);}}