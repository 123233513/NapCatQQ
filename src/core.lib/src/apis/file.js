const _0xe61f85=_0x4898;(function(_0x468494,_0xdb37b7){const _0x19470e=_0x4898,_0x103ed3=_0x468494();while(!![]){try{const _0x2bb927=-parseInt(_0x19470e(0x122))/0x1*(-parseInt(_0x19470e(0x120))/0x2)+parseInt(_0x19470e(0x10f))/0x3*(parseInt(_0x19470e(0x130))/0x4)+parseInt(_0x19470e(0x13e))/0x5*(parseInt(_0x19470e(0x103))/0x6)+-parseInt(_0x19470e(0x127))/0x7*(parseInt(_0x19470e(0x10a))/0x8)+parseInt(_0x19470e(0x10d))/0x9+-parseInt(_0x19470e(0x110))/0xa+-parseInt(_0x19470e(0x117))/0xb;if(_0x2bb927===_0xdb37b7)break;else _0x103ed3['push'](_0x103ed3['shift']());}catch(_0xe389e9){_0x103ed3['push'](_0x103ed3['shift']());}}}(_0x36ec,0xb23ea));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x37048c from'path';import _0x5f4fe0 from'fs';import _0x3e7440 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';function _0x36ec(){const _0x3777a4=['clearChatCache','copyFile','30783412XPrIZW','elementId','getFileCacheInfo','DPoCg','图片rkey获取失败','/download','util','ebjBY','unlink','217762jGgzVl','downloadMedia','8mhMMnn','tmp','join','下载超时','getHotUpdateCachePath','33509ypfnVR','addCacheScannedPaths','md5HexStr','InycN','fileTypeFromFile','getStorageCleanService','find','VLfDd','sourcePath','4wtAiPp','chatType','elements','QrNjA','uploadFile','RFgVj','getImageUrl','获取图片rkey...','indexOf','UQDac','toUpperCase','getMsgService','ext','removeKernelMsgListener','110UPoSww','now','clearCacheDataByKeys','&rkey=','getChatCacheList','CGEWG','getRichMediaFilePathForGuild','BKYDG','fileUuid','includes','startsWith','getFileType','elcZK','kPOUw','/gchatpic_new/0/0-0-','JSJkc','session','HDAfW','TLnKr','clearCache','getChatCacheInfo','RWcnP','msgId','existsSync','then','getFileSize','图片url获取失败','originImageUrl','yvOlF','ipPmR','194124OhSSQX','ELSlw','group','hookApi\x20is\x20not\x20available','LNSpo','PIC','getImageSize','488vBozzk','kwYQN','qhhNE','10639233VmnMGN','scanCache','3166923lIKyBb','250wbgHOu','hotUpdate','addCacheScanedPaths','addListener','picElement'];_0x36ec=function(){return _0x3777a4;};return _0x36ec();}import{calculateFileMD5}from'@/common/utils/file';import*as _0x42ea2c from'file-type';function _0x4898(_0x1e8cb5,_0x3fb8d9){const _0x36ec7d=_0x36ec();return _0x4898=function(_0x4898f9,_0x52131b){_0x4898f9=_0x4898f9-0xfc;let _0x3fc978=_0x36ec7d[_0x4898f9];return _0x3fc978;},_0x4898(_0x1e8cb5,_0x3fb8d9);}import{MsgListener}from'@/core/listeners';import _0x307d0b from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{sleep}from'@/common/utils/helper';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e;export class NTQQFileApi{static async[_0xe61f85(0x149)](_0x22d1c5){const _0x321252=_0xe61f85;return _0x42ea2c[_0x321252(0x12b)](_0x22d1c5);}static async[_0xe61f85(0x116)](_0x4c4ee6,_0x28376d){const _0x4cad7f=_0xe61f85;await napCatCore['util'][_0x4cad7f(0x116)](_0x4c4ee6,_0x28376d);}static async['getFileSize'](_0x37e288){const _0x543bc4=_0xe61f85;return await napCatCore[_0x543bc4(0x11d)][_0x543bc4(0xfe)](_0x37e288);}static async[_0xe61f85(0x134)](_0x1de61e,_0x32d5d=ElementType[_0xe61f85(0x108)],_0x5394f4=0x0){const _0x3dacd0=_0xe61f85,_0x33c9f0={'qdfHF':function(_0x5e48f0,_0x5dd74f){return _0x5e48f0(_0x5dd74f);},'InycN':function(_0x2e812d,_0x1c8ac7){return _0x2e812d+_0x1c8ac7;},'vjjYT':function(_0x2e5b9e,_0x4ab3ce){return _0x2e5b9e===_0x4ab3ce;}},_0x363276=await _0x33c9f0['qdfHF'](calculateFileMD5,_0x1de61e);let _0x30e866=(await NTQQFileApi[_0x3dacd0(0x149)](_0x1de61e))?.[_0x3dacd0(0x13c)]||'';_0x30e866&&(_0x30e866=_0x33c9f0[_0x3dacd0(0x12a)]('.',_0x30e866));let _0x56ac2a=''+_0x37048c['basename'](_0x1de61e);_0x33c9f0['vjjYT'](_0x56ac2a[_0x3dacd0(0x138)]('.'),-0x1)&&(_0x56ac2a+=_0x30e866);const _0x48e664=napCatCore[_0x3dacd0(0x14e)][_0x3dacd0(0x13b)]()[_0x3dacd0(0x144)]({'md5HexStr':_0x363276,'fileName':_0x56ac2a,'elementType':_0x32d5d,'elementSubType':_0x5394f4,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x1de61e,_0x48e664);const _0x11e7c2=await NTQQFileApi[_0x3dacd0(0xfe)](_0x1de61e);return{'md5':_0x363276,'fileName':_0x56ac2a,'path':_0x48e664,'fileSize':_0x11e7c2,'ext':_0x30e866};}static async[_0xe61f85(0x121)](_0x1236f7,_0x5188dd,_0x52e9c0,_0x311666,_0x2d90e4,_0x515d76,_0x3f6fd=0x3e8*0x3c*0x2,_0x37d61a=![]){const _0x49937f=_0xe61f85,_0x5cbda9={'RFgVj':_0x49937f(0x125),'LNSpo':function(_0x2258e8,_0x7e68af){return _0x2258e8(_0x7e68af);},'QrNjA':function(_0xe0d1fc,_0x4c1b6c,_0x4c9fb8){return _0xe0d1fc(_0x4c1b6c,_0x4c9fb8);}};if(_0x515d76&&_0x5f4fe0[_0x49937f(0xfc)](_0x515d76)){if(_0x37d61a)try{await _0x3e7440[_0x49937f(0x11f)](_0x515d76);}catch(_0x3191aa){}else return _0x515d76;}const _0x2ef781=new MsgListener();return new Promise((_0x484535,_0x6e3d0c)=>{const _0x1e46f6=_0x49937f,_0x4075cb={'DPoCg':function(_0x5cea58,_0x37125b){const _0x169456=_0x4898;return _0x5cbda9[_0x169456(0x107)](_0x5cea58,_0x37125b);}};let _0x3b5b71=![];_0x2ef781['onRichMediaDownloadComplete']=_0x37c0ce=>{const _0x9d21ed=_0x4898;if(_0x37c0ce[_0x9d21ed(0x154)]===_0x1236f7){_0x3b5b71=!![];let _0x53b7f9=_0x37c0ce['filePath'];if(_0x53b7f9[_0x9d21ed(0x148)]('\x5c')){const _0x1bb3f0=sessionConfig?.['defaultFileDownloadPath'];_0x53b7f9=_0x37048c[_0x9d21ed(0x124)](_0x1bb3f0,_0x53b7f9);}_0x4075cb[_0x9d21ed(0x11a)](_0x484535,_0x53b7f9),napCatCore['session'][_0x9d21ed(0x13b)]()[_0x9d21ed(0x13d)](_0xb5a69a);}};const _0xb5a69a=napCatCore[_0x1e46f6(0x113)](_0x2ef781);_0x5cbda9[_0x1e46f6(0x133)](setTimeout,()=>{const _0x2940f7=_0x1e46f6;!_0x3b5b71&&(_0x6e3d0c(new Error(_0x5cbda9[_0x2940f7(0x135)])),napCatCore[_0x2940f7(0x14e)][_0x2940f7(0x13b)]()['removeKernelMsgListener'](_0xb5a69a));},_0x3f6fd),napCatCore['session'][_0x1e46f6(0x13b)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x1236f7,'chatType':_0x5188dd,'peerUid':_0x52e9c0,'elementId':_0x311666,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2d90e4});});}static async[_0xe61f85(0x109)](_0x3fee37){const _0x85fa62={'ipPmR':function(_0x645b96,_0x2bb339){return _0x645b96(_0x2bb339);},'HBsvd':function(_0x362f28,_0x43a0ea,_0x5c9892){return _0x362f28(_0x43a0ea,_0x5c9892);}};return new Promise((_0xa4d801,_0x8f6bd8)=>{const _0x473944={'HDAfW':function(_0x1fcac6,_0x4ba6ce){const _0x2a3850=_0x4898;return _0x85fa62[_0x2a3850(0x102)](_0x1fcac6,_0x4ba6ce);},'elcZK':function(_0x1fb9cf,_0x1ce9a5){return _0x1fb9cf(_0x1ce9a5);}};_0x85fa62['HBsvd'](_0x307d0b,_0x3fee37,(_0x4e8c40,_0x370455)=>{const _0x48624b=_0x4898;_0x4e8c40?_0x473944[_0x48624b(0x14f)](_0x8f6bd8,_0x4e8c40):_0x473944[_0x48624b(0x14a)](_0xa4d801,_0x370455);});});}static async[_0xe61f85(0x136)](_0x5e68d6){const _0x363ba3=_0xe61f85,_0x1b6374={'RWcnP':function(_0x56d232,_0x577ef9){return _0x56d232(_0x577ef9);},'kPOUw':_0x363ba3(0x137),'JSJkc':function(_0x41f761,_0xa4c0f7){return _0x41f761(_0xa4c0f7);},'TLnKr':function(_0x1727a7,_0x9f884e,_0x3e6937){return _0x1727a7(_0x9f884e,_0x3e6937);},'qhhNE':function(_0xffca1c,_0x33f4fa){return _0xffca1c(_0x33f4fa);},'ebjBY':function(_0x3e3eda,_0x1f852c){return _0x3e3eda!==_0x1f852c;},'UQDac':_0x363ba3(0x11c),'ELSlw':function(_0x265138,_0x45a9d1){return _0x265138+_0x45a9d1;},'STyFi':_0x363ba3(0x106),'kwYQN':function(_0xec3650,_0x2a2fd3){return _0xec3650>_0x2a2fd3;},'BKYDG':function(_0x5d2759,_0x167b4c){return _0x5d2759-_0x167b4c;},'bJsSf':function(_0x43d2ee){return _0x43d2ee();},'yvOlF':_0x363ba3(0x11b),'VLfDd':function(_0x516d9e,_0x1af854){return _0x516d9e+_0x1af854;},'WfewU':function(_0x1676da,_0x3801af){return _0x1676da||_0x3801af;},'CGEWG':_0x363ba3(0xff)},_0x52e886=_0x1b6374[_0x363ba3(0x11e)](_0x5e68d6[_0x363ba3(0x131)],ChatType[_0x363ba3(0x105)]),_0x17a180=_0x5e68d6[_0x363ba3(0x132)][_0x363ba3(0x12d)](_0x599124=>!!_0x599124[_0x363ba3(0x114)]);if(!_0x17a180)return'';const _0x4af94a=_0x17a180[_0x363ba3(0x114)][_0x363ba3(0x100)],_0x38802e=_0x17a180[_0x363ba3(0x114)][_0x363ba3(0x129)],_0xc58592=_0x17a180[_0x363ba3(0x114)][_0x363ba3(0x129)],_0x4c5173=_0x17a180[_0x363ba3(0x114)][_0x363ba3(0x146)],_0x13898e=_0x426bac=>{const _0x45cec1=_0x363ba3;_0x52e886?(privateImageRKey=_0x426bac,lastGetPrivateRKeyTime=Date[_0x45cec1(0x13f)]()):(groupImageRKey=_0x426bac,lastGetGroupRKeyTime=Date['now']());};if(_0x4af94a){if(_0x4af94a[_0x363ba3(0x148)](_0x1b6374[_0x363ba3(0x139)])){if(_0x4af94a[_0x363ba3(0x147)](_0x363ba3(0x141)))return _0x1b6374[_0x363ba3(0x104)](IMAGE_HTTP_HOST_NT,_0x4af94a);if(!hookApi['isAvailable']())return logDebug(_0x1b6374['STyFi']),'';const _0x328ab7=async()=>{const _0x177179=_0x363ba3;_0x1b6374[_0x177179(0x153)](logDebug,_0x1b6374[_0x177179(0x14b)]),NTQQFileApi[_0x177179(0x121)](_0x5e68d6[_0x177179(0x154)],_0x5e68d6[_0x177179(0x131)],_0x5e68d6['peerUid'],_0x17a180[_0x177179(0x118)],'',_0x17a180[_0x177179(0x114)][_0x177179(0x12f)],0x3e8,!![])[_0x177179(0xfd)]()['catch'](()=>{}),await _0x1b6374[_0x177179(0x14d)](sleep,0x3e8);const _0x1bfc96=hookApi['getRKey']();if(_0x1bfc96)return _0x1b6374[_0x177179(0x150)](logDebug,'图片rkey获取成功',_0x1bfc96),_0x1b6374[_0x177179(0x10c)](_0x13898e,_0x1bfc96),_0x1bfc96;},_0x5b492c=_0x52e886?privateImageRKey:groupImageRKey,_0x5bacda=_0x52e886?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x1b6374[_0x363ba3(0x10b)](_0x1b6374[_0x363ba3(0x145)](Date[_0x363ba3(0x13f)](),_0x5bacda),rkeyExpireTime)||!_0x5b492c){const _0x40b4c9=await _0x1b6374['bJsSf'](_0x328ab7);return _0x40b4c9?IMAGE_HTTP_HOST_NT+_0x4af94a+(''+_0x40b4c9):(logError(_0x1b6374[_0x363ba3(0x101)],_0x4af94a),'');}if(_0x5b492c)return _0x1b6374[_0x363ba3(0x104)](IMAGE_HTTP_HOST_NT+_0x4af94a,''+_0x5b492c);}else return _0x1b6374[_0x363ba3(0x12e)](IMAGE_HTTP_HOST,_0x4af94a);}else{if(_0x1b6374['WfewU'](_0xc58592,_0x38802e))return IMAGE_HTTP_HOST+_0x363ba3(0x14c)+(_0xc58592||_0x38802e)[_0x363ba3(0x13a)]()+'/0';}return _0x1b6374[_0x363ba3(0x150)](logDebug,_0x1b6374[_0x363ba3(0x143)],_0x5e68d6),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x156d65=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0xe61f85(0x151)](_0x5b5dc6=[_0xe61f85(0x123),_0xe61f85(0x111)]){const _0x1c212c=_0xe61f85;return napCatCore[_0x1c212c(0x14e)][_0x1c212c(0x12c)]()[_0x1c212c(0x140)](_0x5b5dc6);}static[_0xe61f85(0x128)](_0x59ab3f={}){const _0x1c2408=_0xe61f85;return napCatCore['session'][_0x1c2408(0x12c)]()[_0x1c2408(0x112)](_0x59ab3f);}static[_0xe61f85(0x10e)](){const _0x1bda0e=_0xe61f85;return napCatCore['session'][_0x1bda0e(0x12c)]()[_0x1bda0e(0x10e)]();}static[_0xe61f85(0x126)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0xe61f85(0x142)](_0x44b24f,_0x36be34=0x3e8,_0x586060=0x0){const _0x3d7175=_0xe61f85;return napCatCore[_0x3d7175(0x14e)][_0x3d7175(0x12c)]()[_0x3d7175(0x152)](_0x44b24f,_0x36be34,0x1,_0x586060);}static[_0xe61f85(0x119)](_0x3e9384,_0x4f2a76=0x3e8,_0x392b49){const _0x8f2f3b=_0x392b49?_0x392b49:{'fileType':_0x3e9384};}static async[_0xe61f85(0x115)](_0x58bdc2=[],_0x150364=[]){const _0x49eb1d=_0xe61f85;return napCatCore['session'][_0x49eb1d(0x12c)]()['clearChatCacheInfo'](_0x58bdc2,_0x150364);}}