const _0x13d265=_0x476b;(function(_0x39ca06,_0x584da5){const _0x434280=_0x476b,_0x15bdc5=_0x39ca06();while(!![]){try{const _0x45f2bc=parseInt(_0x434280(0x107))/0x1+parseInt(_0x434280(0x140))/0x2+parseInt(_0x434280(0x100))/0x3+-parseInt(_0x434280(0x118))/0x4*(-parseInt(_0x434280(0x13b))/0x5)+parseInt(_0x434280(0x116))/0x6+parseInt(_0x434280(0xff))/0x7*(-parseInt(_0x434280(0x103))/0x8)+-parseInt(_0x434280(0x12c))/0x9;if(_0x45f2bc===_0x584da5)break;else _0x15bdc5['push'](_0x15bdc5['shift']());}catch(_0x7dc01a){_0x15bdc5['push'](_0x15bdc5['shift']());}}}(_0x5286,0x5c3f7));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x2a4948 from'path';import _0x7391f3 from'fs';import _0x4ae4d3 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0x5286(){const _0x243c94=['clearChatCache','hNvfY','msgId','indexOf','toUpperCase','getDesktopTmpPath','basename','getImageUrl','downloadRichMedia','group_rkey','11779065bRIUjN','set','ext','copyFile','hotUpdate','Xbzuw','CkgRV','fileUuid','session','wFvhS','getFileType','getChatCacheList','tmp','setCacheSilentScan','getRkey','142315szHtaF','getFileSize','getMsgService','scanCache','PnlJp','850386NOBauw','originImageUrl','VGJaD','PIC','CPHjX','Hbkuf','unlink','66402LALnFs','1713009neMFrp','onLoginSuccess','includes','232QnAmJB','private_rkey','getStorageCleanService','getCacheSessionPathList','633706QyfGuD','JuaVF','md5HexStr','下载超时','uploadFile','downloadMedia','/gchatpic_new/0/0-0-','addCacheScanedPaths','getRichMediaFilePathForGuild','mSKWR','defaultFileDownloadPath','qvqQL','util','getHotUpdateCachePath','NMkFA','1137054tirrBx','pXVnB','20WpxOYz','图片url获取失败','existsSync','addListener','fileTypeFromFile','filePath','clearCache','join','startsWith','XajVF'];_0x5286=function(){return _0x243c94;};return _0x5286();}import*as _0x5426b0 from'file-type';import{MsgListener}from'@/core/listeners';import _0x10cabb from'image-size';function _0x476b(_0x52c07e,_0x490d0a){const _0x5286a9=_0x5286();return _0x476b=function(_0x476b01,_0x518fe7){_0x476b01=_0x476b01-0xfb;let _0x27f2d4=_0x5286a9[_0x476b01];return _0x27f2d4;},_0x476b(_0x52c07e,_0x490d0a);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x8b3e3c=>{const _0x4519a4={'ZghID':function(_0x709300,_0x4768e1){return _0x709300(_0x4768e1);}};for(const [_0x563fde,_0x445c81]of downloadMediaTasks){_0x4519a4['ZghID'](_0x445c81,_0x8b3e3c),downloadMediaTasks['delete'](_0x563fde);}},setTimeout(()=>{const _0x1d70ee=_0x476b;napCatCore[_0x1d70ee(0x101)](()=>{const _0x25e56a=_0x1d70ee;napCatCore[_0x25e56a(0x11b)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x13d265(0x136)](_0x50adf1){const _0x15dbe2=_0x13d265;return _0x5426b0[_0x15dbe2(0x11c)](_0x50adf1);}static async[_0x13d265(0x12f)](_0x170da5,_0x49eb05){const _0xcba571=_0x13d265;await napCatCore[_0xcba571(0x113)][_0xcba571(0x12f)](_0x170da5,_0x49eb05);}static async[_0x13d265(0x13c)](_0x2e2e82){const _0x23a7b3=_0x13d265;return await napCatCore['util'][_0x23a7b3(0x13c)](_0x2e2e82);}static async[_0x13d265(0x10b)](_0x41f21b,_0x68f6e9=ElementType[_0x13d265(0xfb)],_0x5c28a4=0x0){const _0x257d43=_0x13d265,_0x497d36={'dmZKt':function(_0x37e15c,_0x315a8c){return _0x37e15c(_0x315a8c);},'JuaVF':function(_0x2b6b57,_0x3f95b7){return _0x2b6b57+_0x3f95b7;},'CkgRV':function(_0x3a97d7,_0x4c4083){return _0x3a97d7===_0x4c4083;}},_0x5328bd=await _0x497d36['dmZKt'](calculateFileMD5,_0x41f21b);let _0x114b1f=(await NTQQFileApi[_0x257d43(0x136)](_0x41f21b))?.[_0x257d43(0x12e)]||'';_0x114b1f&&(_0x114b1f=_0x497d36[_0x257d43(0x108)]('.',_0x114b1f));let _0x2d56b7=''+_0x2a4948[_0x257d43(0x128)](_0x41f21b);_0x497d36[_0x257d43(0x132)](_0x2d56b7[_0x257d43(0x125)]('.'),-0x1)&&(_0x2d56b7+=_0x114b1f);const _0x4cfbb5=napCatCore[_0x257d43(0x134)][_0x257d43(0x13d)]()[_0x257d43(0x10f)]({'md5HexStr':_0x5328bd,'fileName':_0x2d56b7,'elementType':_0x68f6e9,'elementSubType':_0x5c28a4,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x257d43(0x12f)](_0x41f21b,_0x4cfbb5);const _0x31316d=await NTQQFileApi['getFileSize'](_0x41f21b);return{'md5':_0x5328bd,'fileName':_0x2d56b7,'path':_0x4cfbb5,'fileSize':_0x31316d,'ext':_0x114b1f};}static async[_0x13d265(0x10c)](_0x447f91,_0x218371,_0x2c3182,_0x26d494,_0x146d00,_0x323a3b,_0x5c50ad=0x3e8*0x3c*0x2,_0x10a123=![]){const _0x41928c=_0x13d265,_0x4d6a64={'wFvhS':function(_0x133a40,_0x154df2){return _0x133a40===_0x154df2;},'mSKWR':function(_0x24fa1d){return _0x24fa1d();},'rqkDm':function(_0x43374e,_0x1e1805,_0x4bc9b6){return _0x43374e(_0x1e1805,_0x4bc9b6);}};if(_0x323a3b&&_0x7391f3[_0x41928c(0x11a)](_0x323a3b)){if(_0x10a123)try{await _0x4ae4d3[_0x41928c(0xfe)](_0x323a3b);}catch(_0xb62c22){}else return _0x323a3b;}return new Promise((_0x3bbb5b,_0x26b9c7)=>{const _0x44dc9f=_0x41928c,_0x83110a={'qvqQL':function(_0x52e1bc,_0x10acb2){const _0x1c0d03=_0x476b;return _0x4d6a64[_0x1c0d03(0x135)](_0x52e1bc,_0x10acb2);},'XajVF':function(_0x101fd0,_0x5a0c46){return _0x101fd0(_0x5a0c46);}};let _0x4f55d1=![];const _0x1a8782=_0x20fdd4=>{const _0xe3ad48=_0x476b;if(_0x83110a[_0xe3ad48(0x112)](_0x20fdd4[_0xe3ad48(0x124)],_0x447f91)){_0x4f55d1=!![];let _0x2833b0=_0x20fdd4[_0xe3ad48(0x11d)];if(_0x2833b0[_0xe3ad48(0x120)]('\x5c')){const _0x4f1d4a=sessionConfig[_0xe3ad48(0x111)];_0x2833b0=_0x2a4948[_0xe3ad48(0x11f)](_0x4f1d4a,_0x2833b0);}_0x83110a['XajVF'](_0x3bbb5b,_0x2833b0);}};downloadMediaTasks[_0x44dc9f(0x12d)](_0x4d6a64[_0x44dc9f(0x110)](randomUUID),_0x1a8782),_0x4d6a64['rqkDm'](setTimeout,()=>{const _0x25d90d=_0x44dc9f;!_0x4f55d1&&_0x83110a[_0x25d90d(0x121)](_0x26b9c7,_0x25d90d(0x10a));},_0x5c50ad),napCatCore['session']['getMsgService']()[_0x44dc9f(0x12a)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x447f91,'chatType':_0x218371,'peerUid':_0x2c3182,'elementId':_0x26d494,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x146d00});});}static async['getImageSize'](_0x4e0fa){const _0x41cc5e={'VGJaD':function(_0x162481,_0x589f0d){return _0x162481(_0x589f0d);},'Xbzuw':function(_0x215b69,_0x387943,_0x5b374c){return _0x215b69(_0x387943,_0x5b374c);}};return new Promise((_0x27298d,_0x16a9e3)=>{const _0x3223be=_0x476b;_0x41cc5e[_0x3223be(0x131)](_0x10cabb,_0x4e0fa,(_0x1c44fb,_0x540964)=>{const _0x16a713=_0x3223be;_0x1c44fb?_0x16a9e3(_0x1c44fb):_0x41cc5e[_0x16a713(0x142)](_0x27298d,_0x540964);});});}static async[_0x13d265(0x129)](_0x38ff07,_0xbffb1a){const _0xb3049f=_0x13d265,_0x383a09={'pXVnB':'/download','CzpVV':'&rkey=','Hbkuf':function(_0x57581f,_0x448d03){return _0x57581f+_0x448d03;},'hNvfY':function(_0x31e2ee,_0x37aa49){return _0x31e2ee+_0x37aa49;},'PnlJp':function(_0x2ad662,_0x3f1440){return _0x2ad662||_0x3f1440;},'NMkFA':function(_0x1c0963,_0x28895b,_0x45530d){return _0x1c0963(_0x28895b,_0x45530d);},'CPHjX':_0xb3049f(0x119)};if(!_0x38ff07)return'';const _0x110a8e=_0x38ff07[_0xb3049f(0x141)],_0x3f719e=_0x38ff07['md5HexStr'],_0x29b77a=_0x38ff07[_0xb3049f(0x109)],_0x4968b6=_0x38ff07[_0xb3049f(0x133)];if(_0x110a8e){if(_0x110a8e['startsWith'](_0x383a09[_0xb3049f(0x117)])){if(_0x110a8e[_0xb3049f(0x102)](_0x383a09['CzpVV']))return _0x383a09[_0xb3049f(0xfd)](IMAGE_HTTP_HOST_NT,_0x110a8e);const _0x41ed23=await rkeyManager[_0xb3049f(0x13a)](),_0x1f2da0=_0xbffb1a?_0x41ed23[_0xb3049f(0x104)]:_0x41ed23[_0xb3049f(0x12b)];return _0x383a09[_0xb3049f(0x123)](_0x383a09[_0xb3049f(0x123)](IMAGE_HTTP_HOST_NT,_0x110a8e),''+_0x1f2da0);}else return _0x383a09[_0xb3049f(0x123)](IMAGE_HTTP_HOST,_0x110a8e);}else{if(_0x29b77a||_0x3f719e)return IMAGE_HTTP_HOST+_0xb3049f(0x10d)+_0x383a09[_0xb3049f(0x13f)](_0x29b77a,_0x3f719e)[_0xb3049f(0x126)]()+'/0';}return _0x383a09[_0xb3049f(0x115)](logDebug,_0x383a09[_0xb3049f(0xfc)],_0x38ff07),'';}}export class NTQQFileCacheApi{static async[_0x13d265(0x139)](_0x8a9962=!![]){return'';}static[_0x13d265(0x106)](){return'';}static[_0x13d265(0x11e)](_0x95c34f=[_0x13d265(0x138),_0x13d265(0x130)]){const _0x141ce5=_0x13d265;return napCatCore[_0x141ce5(0x134)][_0x141ce5(0x105)]()['clearCacheDataByKeys'](_0x95c34f);}static['addCacheScannedPaths'](_0x590692={}){const _0x1e45ff=_0x13d265;return napCatCore[_0x1e45ff(0x134)][_0x1e45ff(0x105)]()[_0x1e45ff(0x10e)](_0x590692);}static[_0x13d265(0x13e)](){const _0x280e9b=_0x13d265;return napCatCore[_0x280e9b(0x134)][_0x280e9b(0x105)]()['scanCache']();}static[_0x13d265(0x114)](){return'';}static[_0x13d265(0x127)](){return'';}static[_0x13d265(0x137)](_0x3096ea,_0x33b513=0x3e8,_0x1ae037=0x0){const _0x460061=_0x13d265;return napCatCore[_0x460061(0x134)]['getStorageCleanService']()['getChatCacheInfo'](_0x3096ea,_0x33b513,0x1,_0x1ae037);}static['getFileCacheInfo'](_0xa32801,_0xc30459=0x3e8,_0x3015f9){const _0x354b1e=_0x3015f9?_0x3015f9:{'fileType':_0xa32801};}static async[_0x13d265(0x122)](_0x322ee8=[],_0x3a5d55=[]){const _0x604cf7=_0x13d265;return napCatCore['session'][_0x604cf7(0x105)]()['clearChatCacheInfo'](_0x322ee8,_0x3a5d55);}}