const _0x1d6ea8=_0x388c;(function(_0x4b5450,_0x6bf315){const _0x123847=_0x388c,_0x377bb8=_0x4b5450();while(!![]){try{const _0x49c1e1=-parseInt(_0x123847(0xb4))/0x1*(parseInt(_0x123847(0x95))/0x2)+-parseInt(_0x123847(0x80))/0x3+-parseInt(_0x123847(0x7f))/0x4+parseInt(_0x123847(0x9e))/0x5*(parseInt(_0x123847(0x83))/0x6)+-parseInt(_0x123847(0xa9))/0x7+parseInt(_0x123847(0x98))/0x8*(-parseInt(_0x123847(0x85))/0x9)+parseInt(_0x123847(0xb9))/0xa*(parseInt(_0x123847(0xb7))/0xb);if(_0x49c1e1===_0x6bf315)break;else _0x377bb8['push'](_0x377bb8['shift']());}catch(_0x8afef4){_0x377bb8['push'](_0x377bb8['shift']());}}}(_0x2be8,0x8041a));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x14738e from'path';import _0x390ea6 from'fs';import _0x4e49fd from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x4f7022 from'file-type';import{MsgListener}from'@/core/listeners';import _0x270f1d from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x388c(_0x79dcb,_0x27a1c2){const _0x2be8f6=_0x2be8();return _0x388c=function(_0x388cc8,_0x5de01c){_0x388cc8=_0x388cc8-0x70;let _0x1328d6=_0x2be8f6[_0x388cc8];return _0x1328d6;},_0x388c(_0x79dcb,_0x27a1c2);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x1d6ea8(0x8a)]=_0x222d06=>{const _0x59b0be=_0x1d6ea8,_0x251c27={'VJdzh':function(_0x2355b8,_0x11c101){return _0x2355b8(_0x11c101);}};for(const [_0x16b8a2,_0x1491ae]of downloadMediaTasks){_0x251c27[_0x59b0be(0x7b)](_0x1491ae,_0x222d06),downloadMediaTasks[_0x59b0be(0xa8)](_0x16b8a2);}},setTimeout(()=>{const _0x1d6e5c=_0x1d6ea8;napCatCore[_0x1d6e5c(0x88)](()=>{const _0x1fafaa=_0x1d6e5c;napCatCore[_0x1fafaa(0x74)](downloadMediaListener);});},0x64);function _0x2be8(){const _0x4680e8=['indexOf','join','qizWq','set','setCacheSilentScan','pnLSZ','xQHHS','addListener','getFileCacheInfo','clearChatCacheInfo','startsWith','&rkey=','unlink','dwpsr','VJdzh','getCacheSessionPathList','defaultFileDownloadPath','图片url获取失败','2007208gmlNrp','1572291gUTzqP','group_rkey','includes','3584616CxHzJU','qzjvo','4183038Piycbu','downloadMedia\x20complete','CktSD','onLoginSuccess','getHotUpdateCachePath','onRichMediaDownloadComplete','downloadPath','downloadMedia','qCpIf','start\x20downloadMedia','private_rkey','copyFile','toUpperCase','util','getChatCacheInfo','addCacheScanedPaths','6026YeJeNQ','getFileSize','receive\x20downloadMedia\x20task','16PqSLhV','fileUuid','tXBih','IXZKG','jdvAZ','tmp','5pjrqNL','clearCacheDataByKeys','LhXur','basename','uploadFile','session','wvsFv','getStorageCleanService','msgId','aeBIQ','delete','1601131AOppDj','getFileType','hfgEb','scanCache','getMsgService','getRkey','fdzDz','getDesktopTmpPath','wKnsL','clearCache','originImageUrl','46iOfrZH','existsSync','getChatCacheList','308QBXXUc','clearChatCache','803820iMhfeo','downloadRichMedia','hotUpdate','Djzsh','fileTypeFromFile'];_0x2be8=function(){return _0x4680e8;};return _0x2be8();}export class NTQQFileApi{static async[_0x1d6ea8(0xaa)](_0x46f667){const _0x6a8e69=_0x1d6ea8;return _0x4f7022[_0x6a8e69(0xbd)](_0x46f667);}static async[_0x1d6ea8(0x90)](_0x733998,_0x2faca5){const _0x1b3bf3=_0x1d6ea8;await napCatCore[_0x1b3bf3(0x92)][_0x1b3bf3(0x90)](_0x733998,_0x2faca5);}static async[_0x1d6ea8(0x96)](_0x5b4770){const _0x41e4b5=_0x1d6ea8;return await napCatCore[_0x41e4b5(0x92)][_0x41e4b5(0x96)](_0x5b4770);}static async[_0x1d6ea8(0xa2)](_0x284f1b,_0x3e0022=ElementType['PIC'],_0x51f588=0x0){const _0x522c3b=_0x1d6ea8,_0x25732e={'Djzsh':function(_0x59f0cd,_0x44534d){return _0x59f0cd(_0x44534d);},'LhXur':function(_0x33cb93,_0x2be39d){return _0x33cb93+_0x2be39d;},'jdvAZ':function(_0xd2a9e2,_0x261e53){return _0xd2a9e2===_0x261e53;}},_0x526f04=await _0x25732e[_0x522c3b(0xbc)](calculateFileMD5,_0x284f1b);let _0x22c8ed=(await NTQQFileApi[_0x522c3b(0xaa)](_0x284f1b))?.['ext']||'';_0x22c8ed&&(_0x22c8ed=_0x25732e[_0x522c3b(0xa0)]('.',_0x22c8ed));let _0x2b7cbd=''+_0x14738e[_0x522c3b(0xa1)](_0x284f1b);_0x25732e[_0x522c3b(0x9c)](_0x2b7cbd[_0x522c3b(0xbe)]('.'),-0x1)&&(_0x2b7cbd+=_0x22c8ed);const _0x52032c=napCatCore[_0x522c3b(0xa3)]['getMsgService']()['getRichMediaFilePathForGuild']({'md5HexStr':_0x526f04,'fileName':_0x2b7cbd,'elementType':_0x3e0022,'elementSubType':_0x51f588,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x284f1b,_0x52032c);const _0x20d235=await NTQQFileApi[_0x522c3b(0x96)](_0x284f1b);return{'md5':_0x526f04,'fileName':_0x2b7cbd,'path':_0x52032c,'fileSize':_0x20d235,'ext':_0x22c8ed};}static async[_0x1d6ea8(0x8c)](_0x341bfa,_0x21ced9,_0x1d34ae,_0x1198ad,_0x9f353c,_0x130157,_0x145ce4=0x3e8*0x3c*0x2,_0x31203b=![]){const _0x33759a=_0x1d6ea8,_0x2ea01a={'hfgEb':function(_0x131f8c,_0x34f511,_0x47fa0e,_0x3107c3){return _0x131f8c(_0x34f511,_0x47fa0e,_0x3107c3);},'aeBIQ':function(_0x3e513c,_0x3df53d,_0xbaba04){return _0x3e513c(_0x3df53d,_0xbaba04);},'qzjvo':function(_0x485b5c,_0x2c71e1){return _0x485b5c(_0x2c71e1);},'tXBih':'下载超时','kpwmF':function(_0x38ca02,_0x354407,_0x3533d3,_0x2d81b0,_0x476b68,_0x51ad59,_0x199d70,_0x552d2d,_0x35ecdc,_0x2a67fa){return _0x38ca02(_0x354407,_0x3533d3,_0x2d81b0,_0x476b68,_0x51ad59,_0x199d70,_0x552d2d,_0x35ecdc,_0x2a67fa);},'IXZKG':_0x33759a(0x97),'fdzDz':_0x33759a(0x8e)};_0x2ea01a['kpwmF'](logDebug,_0x2ea01a[_0x33759a(0x9b)],_0x341bfa,_0x21ced9,_0x1d34ae,_0x1198ad,_0x9f353c,_0x130157,_0x145ce4,_0x31203b);if(_0x130157&&_0x390ea6[_0x33759a(0xb5)](_0x130157)){if(_0x31203b)try{await _0x4e49fd[_0x33759a(0x79)](_0x130157);}catch(_0x1bcf4d){}else return _0x130157;}return logDebug(_0x2ea01a[_0x33759a(0xaf)],_0x341bfa,_0x21ced9,_0x1d34ae,_0x1198ad,_0x9f353c,_0x130157,_0x145ce4,_0x31203b),new Promise((_0x131b7b,_0x568f51)=>{const _0x5ca829=_0x33759a;let _0x707cca=![];const _0x8837dc=_0x5223d6=>{const _0x3a8f00=_0x388c;_0x2ea01a[_0x3a8f00(0xab)](logDebug,_0x3a8f00(0x86),_0x5223d6,_0x341bfa);if(_0x5223d6[_0x3a8f00(0xa6)]===_0x341bfa){_0x707cca=!![];let _0x593af1=_0x5223d6['filePath'];if(_0x593af1['startsWith']('\x5c')){const _0x1de0bf=sessionConfig[_0x3a8f00(0x7d)];_0x2ea01a[_0x3a8f00(0xa7)](logDebug,_0x3a8f00(0x8b),_0x1de0bf),_0x593af1=_0x14738e[_0x3a8f00(0xbf)](_0x1de0bf,_0x593af1);}_0x2ea01a[_0x3a8f00(0x84)](_0x131b7b,_0x593af1);}};downloadMediaTasks[_0x5ca829(0x70)](randomUUID(),_0x8837dc),_0x2ea01a[_0x5ca829(0xa7)](setTimeout,()=>{const _0xd29162=_0x5ca829;!_0x707cca&&_0x2ea01a['qzjvo'](_0x568f51,_0x2ea01a[_0xd29162(0x9a)]);},_0x145ce4),napCatCore[_0x5ca829(0xa3)][_0x5ca829(0xad)]()[_0x5ca829(0xba)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x341bfa,'chatType':_0x21ced9,'peerUid':_0x1d34ae,'elementId':_0x1198ad,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x9f353c});});}static async['getImageSize'](_0x3d78cd){const _0x421099={'PmuCj':function(_0x1950a9,_0x552ffa){return _0x1950a9(_0x552ffa);},'qizWq':function(_0x3eb8de,_0x1c486f,_0x2cc241){return _0x3eb8de(_0x1c486f,_0x2cc241);}};return new Promise((_0x4465af,_0x3bf9ba)=>{const _0x4e744e=_0x388c,_0x2d6a41={'xQHHS':function(_0x40e7ce,_0x5e9862){return _0x421099['PmuCj'](_0x40e7ce,_0x5e9862);},'wvsFv':function(_0xd1da06,_0x4f5e44){return _0xd1da06(_0x4f5e44);}};_0x421099[_0x4e744e(0xc0)](_0x270f1d,_0x3d78cd,(_0x4384b5,_0x6b00a0)=>{const _0x1606b7=_0x4e744e;_0x4384b5?_0x2d6a41[_0x1606b7(0x73)](_0x3bf9ba,_0x4384b5):_0x2d6a41[_0x1606b7(0xa4)](_0x4465af,_0x6b00a0);});});}static async['getImageUrl'](_0x44734a,_0xbd25d0){const _0x59bba4=_0x1d6ea8,_0x13ba8e={'kRKYM':'/download','dwpsr':_0x59bba4(0x78),'wKnsL':function(_0x3398a6,_0x5a339a){return _0x3398a6+_0x5a339a;},'qCpIf':function(_0x2179af,_0x34de6b){return _0x2179af+_0x34de6b;},'pnLSZ':function(_0x5041ff,_0x5604fd){return _0x5041ff||_0x5604fd;},'STjii':function(_0x494199,_0x33c755,_0x509645){return _0x494199(_0x33c755,_0x509645);},'CktSD':_0x59bba4(0x7e)};if(!_0x44734a)return'';const _0x388bab=_0x44734a[_0x59bba4(0xb3)],_0x3dbe0d=_0x44734a['md5HexStr'],_0x4ecd3f=_0x44734a['md5HexStr'],_0x219e98=_0x44734a[_0x59bba4(0x99)];if(_0x388bab){if(_0x388bab[_0x59bba4(0x77)](_0x13ba8e['kRKYM'])){if(_0x388bab[_0x59bba4(0x82)](_0x13ba8e[_0x59bba4(0x7a)]))return _0x13ba8e[_0x59bba4(0xb1)](IMAGE_HTTP_HOST_NT,_0x388bab);const _0x22792b=await rkeyManager[_0x59bba4(0xae)](),_0x3b0a24=_0xbd25d0?_0x22792b[_0x59bba4(0x8f)]:_0x22792b[_0x59bba4(0x81)];return _0x13ba8e[_0x59bba4(0xb1)](_0x13ba8e[_0x59bba4(0x8d)](IMAGE_HTTP_HOST_NT,_0x388bab),''+_0x3b0a24);}else return _0x13ba8e[_0x59bba4(0xb1)](IMAGE_HTTP_HOST,_0x388bab);}else{if(_0x13ba8e[_0x59bba4(0x72)](_0x4ecd3f,_0x3dbe0d))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x13ba8e[_0x59bba4(0x72)](_0x4ecd3f,_0x3dbe0d)[_0x59bba4(0x91)]()+'/0';}return _0x13ba8e['STjii'](logDebug,_0x13ba8e[_0x59bba4(0x87)],_0x44734a),'';}}export class NTQQFileCacheApi{static async[_0x1d6ea8(0x71)](_0x286564=!![]){return'';}static[_0x1d6ea8(0x7c)](){return'';}static[_0x1d6ea8(0xb2)](_0x43e21c=[_0x1d6ea8(0x9d),_0x1d6ea8(0xbb)]){const _0x29f11c=_0x1d6ea8;return napCatCore['session'][_0x29f11c(0xa5)]()[_0x29f11c(0x9f)](_0x43e21c);}static['addCacheScannedPaths'](_0x23c3d1={}){const _0x55483e=_0x1d6ea8;return napCatCore['session'][_0x55483e(0xa5)]()[_0x55483e(0x94)](_0x23c3d1);}static[_0x1d6ea8(0xac)](){const _0x22669a=_0x1d6ea8;return napCatCore[_0x22669a(0xa3)][_0x22669a(0xa5)]()[_0x22669a(0xac)]();}static[_0x1d6ea8(0x89)](){return'';}static[_0x1d6ea8(0xb0)](){return'';}static[_0x1d6ea8(0xb6)](_0x77eaa8,_0x4163a1=0x3e8,_0xfc8bc1=0x0){const _0xc732b5=_0x1d6ea8;return napCatCore[_0xc732b5(0xa3)][_0xc732b5(0xa5)]()[_0xc732b5(0x93)](_0x77eaa8,_0x4163a1,0x1,_0xfc8bc1);}static[_0x1d6ea8(0x75)](_0x12e5a5,_0x48af06=0x3e8,_0x1a9849){const _0x4cc92d=_0x1a9849?_0x1a9849:{'fileType':_0x12e5a5};}static async[_0x1d6ea8(0xb8)](_0x33337f=[],_0x164f91=[]){const _0x2fa186=_0x1d6ea8;return napCatCore['session'][_0x2fa186(0xa5)]()[_0x2fa186(0x76)](_0x33337f,_0x164f91);}}