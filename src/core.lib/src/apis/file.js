const _0x362676=_0x2c99;(function(_0x1c871f,_0x15b337){const _0x4593f3=_0x2c99,_0x3e989c=_0x1c871f();while(!![]){try{const _0x507edf=-parseInt(_0x4593f3(0xb6))/0x1*(parseInt(_0x4593f3(0x7e))/0x2)+-parseInt(_0x4593f3(0xa1))/0x3*(-parseInt(_0x4593f3(0x83))/0x4)+-parseInt(_0x4593f3(0x89))/0x5+-parseInt(_0x4593f3(0x84))/0x6*(-parseInt(_0x4593f3(0x9a))/0x7)+-parseInt(_0x4593f3(0x7b))/0x8+parseInt(_0x4593f3(0xb9))/0x9+parseInt(_0x4593f3(0xb0))/0xa;if(_0x507edf===_0x15b337)break;else _0x3e989c['push'](_0x3e989c['shift']());}catch(_0x4f8e0c){_0x3e989c['push'](_0x3e989c['shift']());}}}(_0x6141,0x51fd2));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x437193 from'path';import _0x3c74a2 from'fs';import _0x1a5fbc from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0xf83725 from'file-type';function _0x6141(){const _0x28f1d2=['msgId','delete','getFileSize','150437FChBqr','getHotUpdateCachePath','getRichMediaFilePathForGuild','PIC','clearCache','existsSync','WZcYF','69GZkEMb','gXAbb','&rkey=','startsWith','tmp','clearCacheDataByKeys','bODnM','YRdru','clearChatCache','ghhvK','basename','addCacheScanedPaths','set','addListener','onLoginSuccess','9029110wKxdfl','lyqhm','defaultFileDownloadPath','addCacheScannedPaths','includes','SRFnG','543541lCRViM','onRichMediaDownloadComplete','downloadMedia','3896982uJZFSp','getDesktopTmpPath','getChatCacheList','5266416WFQMEN','cMdmc','md5HexStr','2jhNvTe','gHEVu','unlink','getChatCacheInfo','session','42708uxvxjD','6mQCqHj','/download','join','QEElK','gWWHx','326510ndgkkF','group_rkey','copyFile','getFileCacheInfo','setCacheSilentScan','mNWGK','downloadRichMedia','zQdYm','getFileType','toUpperCase','下载超时','getMsgService','ext','getStorageCleanService'];_0x6141=function(){return _0x28f1d2;};return _0x6141();}function _0x2c99(_0x29224e,_0x1969a0){const _0x61412c=_0x6141();return _0x2c99=function(_0x2c99b7,_0x9511b3){_0x2c99b7=_0x2c99b7-0x7b;let _0x4d9227=_0x61412c[_0x2c99b7];return _0x4d9227;},_0x2c99(_0x29224e,_0x1969a0);}import{MsgListener}from'@/core/listeners';import _0x5d9c57 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x362676(0xb7)]=_0x56629a=>{const _0x528de7=_0x362676;for(const [_0x5b9e33,_0x89d8c4]of downloadMediaTasks){_0x89d8c4(_0x56629a),downloadMediaTasks[_0x528de7(0x98)](_0x5b9e33);}},setTimeout(()=>{const _0x566a09=_0x362676;napCatCore[_0x566a09(0xaf)](()=>{const _0x49fd1d=_0x566a09;napCatCore[_0x49fd1d(0xae)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x362676(0x91)](_0x235b6b){return _0xf83725['fileTypeFromFile'](_0x235b6b);}static async[_0x362676(0x8b)](_0x443a1,_0x26029d){const _0x5e3a43=_0x362676;await napCatCore['util'][_0x5e3a43(0x8b)](_0x443a1,_0x26029d);}static async['getFileSize'](_0x5279c4){const _0x858579=_0x362676;return await napCatCore['util'][_0x858579(0x99)](_0x5279c4);}static async['uploadFile'](_0x1d0b0c,_0x58892a=ElementType[_0x362676(0x9d)],_0x407258=0x0){const _0x4b5c35=_0x362676,_0x5356ac={'sxunL':function(_0x298f2c,_0x5294a6){return _0x298f2c(_0x5294a6);},'gXAbb':function(_0x15b7b1,_0x266c96){return _0x15b7b1+_0x266c96;}},_0x34b1cd=await _0x5356ac['sxunL'](calculateFileMD5,_0x1d0b0c);let _0x119107=(await NTQQFileApi[_0x4b5c35(0x91)](_0x1d0b0c))?.[_0x4b5c35(0x95)]||'';_0x119107&&(_0x119107=_0x5356ac[_0x4b5c35(0xa2)]('.',_0x119107));let _0x5eb07f=''+_0x437193[_0x4b5c35(0xab)](_0x1d0b0c);_0x5eb07f['indexOf']('.')===-0x1&&(_0x5eb07f+=_0x119107);const _0x415be5=napCatCore[_0x4b5c35(0x82)][_0x4b5c35(0x94)]()[_0x4b5c35(0x9c)]({'md5HexStr':_0x34b1cd,'fileName':_0x5eb07f,'elementType':_0x58892a,'elementSubType':_0x407258,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x4b5c35(0x8b)](_0x1d0b0c,_0x415be5);const _0x545626=await NTQQFileApi[_0x4b5c35(0x99)](_0x1d0b0c);return{'md5':_0x34b1cd,'fileName':_0x5eb07f,'path':_0x415be5,'fileSize':_0x545626,'ext':_0x119107};}static async[_0x362676(0xb8)](_0x241f2e,_0x34a0a4,_0x5bf85b,_0x2ea169,_0x4d5b9b,_0x39686a,_0x116b6e=0x3e8*0x3c*0x2,_0x4648aa=![]){const _0x1cbe73=_0x362676,_0x338468={'WZcYF':function(_0x19f0ff,_0x5ed53c){return _0x19f0ff===_0x5ed53c;},'YRdru':function(_0x2b2fea,_0x21655f){return _0x2b2fea(_0x21655f);},'SRFnG':_0x1cbe73(0x93),'cMdmc':function(_0x4b1f97){return _0x4b1f97();},'ghhvK':function(_0x11a7e6,_0x4ad01e,_0xf3257e){return _0x11a7e6(_0x4ad01e,_0xf3257e);}};if(_0x39686a&&_0x3c74a2[_0x1cbe73(0x9f)](_0x39686a)){if(_0x4648aa)try{await _0x1a5fbc[_0x1cbe73(0x80)](_0x39686a);}catch(_0x33e03f){}else return _0x39686a;}return new Promise((_0x5b50a6,_0x4031b5)=>{const _0x21cfcc=_0x1cbe73,_0x28b20b={'zQdYm':function(_0x91a1cd,_0x5406d1){return _0x91a1cd(_0x5406d1);},'mNWGK':_0x338468[_0x21cfcc(0xb5)]};let _0x4c8fa3=![];const _0xd72d5f=_0x21d683=>{const _0x8021ac=_0x21cfcc;if(_0x338468[_0x8021ac(0xa0)](_0x21d683[_0x8021ac(0x97)],_0x241f2e)){_0x4c8fa3=!![];let _0xe15b84=_0x21d683['filePath'];if(_0xe15b84[_0x8021ac(0xa4)]('\x5c')){const _0x23cfae=sessionConfig[_0x8021ac(0xb2)];_0xe15b84=_0x437193[_0x8021ac(0x86)](_0x23cfae,_0xe15b84);}_0x338468[_0x8021ac(0xa8)](_0x5b50a6,_0xe15b84);}};downloadMediaTasks[_0x21cfcc(0xad)](_0x338468[_0x21cfcc(0x7c)](randomUUID),_0xd72d5f),_0x338468[_0x21cfcc(0xaa)](setTimeout,()=>{const _0x475509=_0x21cfcc;!_0x4c8fa3&&_0x28b20b[_0x475509(0x90)](_0x4031b5,_0x28b20b[_0x475509(0x8e)]);},_0x116b6e),napCatCore[_0x21cfcc(0x82)]['getMsgService']()[_0x21cfcc(0x8f)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x241f2e,'chatType':_0x34a0a4,'peerUid':_0x5bf85b,'elementId':_0x2ea169,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4d5b9b});});}static async['getImageSize'](_0x12087a){const _0x428942={'gWWHx':function(_0x2e11fa,_0x39f629){return _0x2e11fa(_0x39f629);},'XptGv':function(_0x3d785d,_0x12ba57,_0xec9fb5){return _0x3d785d(_0x12ba57,_0xec9fb5);}};return new Promise((_0x2f305d,_0x30d812)=>{_0x428942['XptGv'](_0x5d9c57,_0x12087a,(_0x3d8a2a,_0x60b142)=>{const _0x3c2421=_0x2c99;_0x3d8a2a?_0x428942[_0x3c2421(0x88)](_0x30d812,_0x3d8a2a):_0x2f305d(_0x60b142);});});}static async['getImageUrl'](_0x4de49a,_0x1e6780){const _0x3c5758=_0x362676,_0x4181d5={'gHEVu':_0x3c5758(0xa3),'QEElK':function(_0x3e5397,_0x361aaa){return _0x3e5397+_0x361aaa;},'lyqhm':function(_0x21f9af,_0x2e700c){return _0x21f9af+_0x2e700c;},'SbhIv':function(_0x3cf066,_0x3cdb71){return _0x3cf066+_0x3cdb71;},'bODnM':function(_0x389a60,_0x58d69b){return _0x389a60||_0x58d69b;},'CddtA':function(_0x27afd2,_0xda9e42){return _0x27afd2||_0xda9e42;},'HPFra':function(_0x18ecfd,_0xdabc97,_0x162191){return _0x18ecfd(_0xdabc97,_0x162191);},'NLyHI':'图片url获取失败'};if(!_0x4de49a)return'';const _0x281d15=_0x4de49a['originImageUrl'],_0xb446f2=_0x4de49a[_0x3c5758(0x7d)],_0x4a3ed5=_0x4de49a['md5HexStr'],_0x47ff6f=_0x4de49a['fileUuid'];if(_0x281d15){if(_0x281d15[_0x3c5758(0xa4)](_0x3c5758(0x85))){if(_0x281d15[_0x3c5758(0xb4)](_0x4181d5[_0x3c5758(0x7f)]))return _0x4181d5[_0x3c5758(0x87)](IMAGE_HTTP_HOST_NT,_0x281d15);const _0x18bcbb=await rkeyManager['getRkey'](),_0x55d06f=_0x1e6780?_0x18bcbb['private_rkey']:_0x18bcbb[_0x3c5758(0x8a)];return _0x4181d5[_0x3c5758(0x87)](_0x4181d5[_0x3c5758(0xb1)](IMAGE_HTTP_HOST_NT,_0x281d15),''+_0x55d06f);}else return _0x4181d5['SbhIv'](IMAGE_HTTP_HOST,_0x281d15);}else{if(_0x4181d5[_0x3c5758(0xa7)](_0x4a3ed5,_0xb446f2))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x4181d5['CddtA'](_0x4a3ed5,_0xb446f2)[_0x3c5758(0x92)]()+'/0';}return _0x4181d5['HPFra'](logDebug,_0x4181d5['NLyHI'],_0x4de49a),'';}}export class NTQQFileCacheApi{static async[_0x362676(0x8d)](_0x1867c7=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x362676(0x9e)](_0x33911a=[_0x362676(0xa5),'hotUpdate']){const _0x148ea7=_0x362676;return napCatCore[_0x148ea7(0x82)][_0x148ea7(0x96)]()[_0x148ea7(0xa6)](_0x33911a);}static[_0x362676(0xb3)](_0x397695={}){const _0x56e3c1=_0x362676;return napCatCore[_0x56e3c1(0x82)][_0x56e3c1(0x96)]()[_0x56e3c1(0xac)](_0x397695);}static['scanCache'](){const _0x29f0cd=_0x362676;return napCatCore[_0x29f0cd(0x82)]['getStorageCleanService']()['scanCache']();}static[_0x362676(0x9b)](){return'';}static[_0x362676(0xba)](){return'';}static[_0x362676(0xbb)](_0x13285f,_0x3dcd49=0x3e8,_0x54cf95=0x0){const _0x4e1ef6=_0x362676;return napCatCore['session'][_0x4e1ef6(0x96)]()[_0x4e1ef6(0x81)](_0x13285f,_0x3dcd49,0x1,_0x54cf95);}static[_0x362676(0x8c)](_0x35409a,_0x7b23dd=0x3e8,_0x41f28c){const _0x2f4cce=_0x41f28c?_0x41f28c:{'fileType':_0x35409a};}static async[_0x362676(0xa9)](_0x291d3f=[],_0x4e50e8=[]){const _0x4ac532=_0x362676;return napCatCore[_0x4ac532(0x82)][_0x4ac532(0x96)]()['clearChatCacheInfo'](_0x291d3f,_0x4e50e8);}}