const _0x571c3a=_0x396d;(function(_0x1a4956,_0x4e7c8c){const _0x227694=_0x396d,_0x107e4e=_0x1a4956();while(!![]){try{const _0x53ac00=-parseInt(_0x227694(0xf8))/0x1+parseInt(_0x227694(0xe3))/0x2*(parseInt(_0x227694(0x10f))/0x3)+parseInt(_0x227694(0x124))/0x4+-parseInt(_0x227694(0xe4))/0x5+parseInt(_0x227694(0x10a))/0x6+-parseInt(_0x227694(0x105))/0x7+parseInt(_0x227694(0xeb))/0x8;if(_0x53ac00===_0x4e7c8c)break;else _0x107e4e['push'](_0x107e4e['shift']());}catch(_0x543add){_0x107e4e['push'](_0x107e4e['shift']());}}}(_0x5a00,0xb90c4));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x4a7068 from'path';import _0x215c2a from'fs';import _0x33d805 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x37496c from'file-type';import{MsgListener}from'@/core/listeners';import _0x3480bf from'image-size';function _0x396d(_0x53da89,_0x77d5c5){const _0x5a0082=_0x5a00();return _0x396d=function(_0x396da8,_0x4b6591){_0x396da8=_0x396da8-0xd9;let _0x218462=_0x5a0082[_0x396da8];return _0x218462;},_0x396d(_0x53da89,_0x77d5c5);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x6c284f=>{const _0x2cd374=_0x396d,_0x54775f={'XErbg':function(_0x132603,_0x23fef1){return _0x132603(_0x23fef1);}};for(const [_0x28c8c7,_0x28d82e]of downloadMediaTasks){_0x54775f[_0x2cd374(0xe6)](_0x28d82e,_0x6c284f),downloadMediaTasks[_0x2cd374(0x123)](_0x28c8c7);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x3bf7d2=_0x396d;napCatCore[_0x3bf7d2(0xed)](downloadMediaListener);});},0x64);function _0x5a00(){const _0x136130=['getFileSize','WNQlx','clearChatCache','cWnyk','AAORJ','indexOf','getRkey','downloadMedia\x20complete','getRichMediaFilePathForGuild','getImageSize','scanCache','wiqII','unlink','owxpp','/download','join','delete','2190392WEvxni','md5HexStr','hotUpdate','/gchatpic_new/0/0-0-','KcpKz','set','getCacheSessionPathList','rlWTb','existsSync','includes','getChatCacheList','msgId','HVuld','getStorageCleanService','CvPtV','PIC','getFileType','73838qfmFga','744005FqftfY','addCacheScanedPaths','XErbg','GVejO','util','group_rkey','ydcXK','4777784jKIXUv','filePath','addListener','DuWhr','wxQBz','JSjwV','LECKs','clearCacheDataByKeys','clearCache','图片url获取失败','qKpWZ','addCacheScannedPaths','defaultFileDownloadPath','989078hwJnGj','receive\x20downloadMedia\x20task','start\x20downloadMedia','eTgLY','session','downloadPath','下载超时','downloadRichMedia','downloadMedia','startsWith','mvTSz','lMuse','ext','5854149PyNrtw','boomZ','basename','copyFile','danWV','4650618kMqyCu','HcDAn','fileUuid','getChatCacheInfo','tmp','66SlOxGq','kdZGE','EYNPp','clearChatCacheInfo'];_0x5a00=function(){return _0x136130;};return _0x5a00();}export class NTQQFileApi{static async['getFileType'](_0x1c6a73){return _0x37496c['fileTypeFromFile'](_0x1c6a73);}static async[_0x571c3a(0x108)](_0x419a49,_0x38478a){const _0x6ebb46=_0x571c3a;await napCatCore['util'][_0x6ebb46(0x108)](_0x419a49,_0x38478a);}static async[_0x571c3a(0x113)](_0x425be0){const _0xaf8752=_0x571c3a;return await napCatCore[_0xaf8752(0xe8)][_0xaf8752(0x113)](_0x425be0);}static async['uploadFile'](_0x2e6c5c,_0x4648ae=ElementType[_0x571c3a(0xe1)],_0x456874=0x0){const _0x41219f=_0x571c3a,_0x503161={'mGAoI':function(_0x462788,_0x427b6e){return _0x462788(_0x427b6e);},'mvTSz':function(_0x54754a,_0x2ebc37){return _0x54754a+_0x2ebc37;},'ydcXK':function(_0x46cfa4,_0x114e05){return _0x46cfa4===_0x114e05;}},_0x321adb=await _0x503161['mGAoI'](calculateFileMD5,_0x2e6c5c);let _0x417845=(await NTQQFileApi[_0x41219f(0xe2)](_0x2e6c5c))?.[_0x41219f(0x104)]||'';_0x417845&&(_0x417845=_0x503161[_0x41219f(0x102)]('.',_0x417845));let _0x770bae=''+_0x4a7068[_0x41219f(0x107)](_0x2e6c5c);_0x503161[_0x41219f(0xea)](_0x770bae[_0x41219f(0x118)]('.'),-0x1)&&(_0x770bae+=_0x417845);const _0xa6e4a8=napCatCore[_0x41219f(0xfc)]['getMsgService']()[_0x41219f(0x11b)]({'md5HexStr':_0x321adb,'fileName':_0x770bae,'elementType':_0x4648ae,'elementSubType':_0x456874,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x41219f(0x108)](_0x2e6c5c,_0xa6e4a8);const _0x115ca1=await NTQQFileApi['getFileSize'](_0x2e6c5c);return{'md5':_0x321adb,'fileName':_0x770bae,'path':_0xa6e4a8,'fileSize':_0x115ca1,'ext':_0x417845};}static async[_0x571c3a(0x100)](_0x2bc1c9,_0x15d4e5,_0x3ad967,_0x32dc81,_0x2bcb71,_0x42815d,_0x57707a=0x3e8*0x3c*0x2,_0x2a2006=![]){const _0x568ec4=_0x571c3a,_0x565373={'GVejO':_0x568ec4(0xfe),'danWV':_0x568ec4(0x11a),'wiqII':function(_0x5dc351,_0x545ecf){return _0x5dc351===_0x545ecf;},'cWnyk':function(_0x58cf5f,_0x316026,_0x2f23ac){return _0x58cf5f(_0x316026,_0x2f23ac);},'wxQBz':_0x568ec4(0xfd),'qKpWZ':function(_0x17de1d,_0x7a8bcc){return _0x17de1d(_0x7a8bcc);},'CvPtV':function(_0x297d53){return _0x297d53();},'HVuld':function(_0x1e44a0,_0xeb24fd,_0x150ec3,_0x5541a9,_0x4ea394,_0x189554,_0x3d8c9e,_0x26679b,_0x569937,_0x131444){return _0x1e44a0(_0xeb24fd,_0x150ec3,_0x5541a9,_0x4ea394,_0x189554,_0x3d8c9e,_0x26679b,_0x569937,_0x131444);},'AAORJ':_0x568ec4(0xf9),'KcpKz':_0x568ec4(0xfa)};_0x565373['HVuld'](logDebug,_0x565373[_0x568ec4(0x117)],_0x2bc1c9,_0x15d4e5,_0x3ad967,_0x32dc81,_0x2bcb71,_0x42815d,_0x57707a,_0x2a2006);if(_0x42815d&&_0x215c2a[_0x568ec4(0xda)](_0x42815d)){if(_0x2a2006)try{await _0x33d805[_0x568ec4(0x11f)](_0x42815d);}catch(_0x5e3115){}else return _0x42815d;}return _0x565373[_0x568ec4(0xde)](logDebug,_0x565373[_0x568ec4(0x128)],_0x2bc1c9,_0x15d4e5,_0x3ad967,_0x32dc81,_0x2bcb71,_0x42815d,_0x57707a,_0x2a2006),new Promise((_0x2bb46d,_0x3b9458)=>{const _0x47ae9c=_0x568ec4,_0x319020={'kdZGE':_0x565373[_0x47ae9c(0x109)],'DuWhr':function(_0x23c31e,_0x110dd9){const _0xbbce74=_0x47ae9c;return _0x565373[_0xbbce74(0x11e)](_0x23c31e,_0x110dd9);},'boomZ':function(_0x384c7d,_0x32e759,_0x24de9c){const _0x139903=_0x47ae9c;return _0x565373[_0x139903(0x116)](_0x384c7d,_0x32e759,_0x24de9c);},'BvZYF':_0x565373[_0x47ae9c(0xef)],'rlWTb':function(_0x2a6531,_0x1234be){const _0x1a2245=_0x47ae9c;return _0x565373[_0x1a2245(0xf5)](_0x2a6531,_0x1234be);}};let _0x48fc28=![];const _0xe551e4=_0x5cfd34=>{const _0x21a09f=_0x47ae9c;logDebug(_0x319020[_0x21a09f(0x110)],_0x5cfd34,_0x2bc1c9);if(_0x319020[_0x21a09f(0xee)](_0x5cfd34[_0x21a09f(0xdd)],_0x2bc1c9)){_0x48fc28=!![];let _0xaf38ec=_0x5cfd34[_0x21a09f(0xec)];if(_0xaf38ec[_0x21a09f(0x101)]('\x5c')){const _0x22e974=sessionConfig[_0x21a09f(0xf7)];_0x319020[_0x21a09f(0x106)](logDebug,_0x319020['BvZYF'],_0x22e974),_0xaf38ec=_0x4a7068[_0x21a09f(0x122)](_0x22e974,_0xaf38ec);}_0x319020[_0x21a09f(0xd9)](_0x2bb46d,_0xaf38ec);}};downloadMediaTasks[_0x47ae9c(0x129)](_0x565373[_0x47ae9c(0xe0)](randomUUID),_0xe551e4),_0x565373[_0x47ae9c(0x116)](setTimeout,()=>{const _0x164843=_0x47ae9c;!_0x48fc28&&_0x3b9458(_0x565373[_0x164843(0xe7)]);},_0x57707a),napCatCore[_0x47ae9c(0xfc)]['getMsgService']()[_0x47ae9c(0xff)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x2bc1c9,'chatType':_0x15d4e5,'peerUid':_0x3ad967,'elementId':_0x32dc81,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2bcb71});});}static async[_0x571c3a(0x11c)](_0x32a93a){const _0x5da6a1={'HcDAn':function(_0x33fed3,_0x193f40){return _0x33fed3(_0x193f40);},'rerhn':function(_0x24cbe7,_0x533c90){return _0x24cbe7(_0x533c90);},'LECKs':function(_0x2d8920,_0x2902b4,_0x2fc523){return _0x2d8920(_0x2902b4,_0x2fc523);}};return new Promise((_0x4afd25,_0x19ce17)=>{const _0x1ec619=_0x396d;_0x5da6a1[_0x1ec619(0xf1)](_0x3480bf,_0x32a93a,(_0x5d71ee,_0x54e88b)=>{const _0x328911=_0x1ec619;_0x5d71ee?_0x5da6a1[_0x328911(0x10b)](_0x19ce17,_0x5d71ee):_0x5da6a1['rerhn'](_0x4afd25,_0x54e88b);});});}static async['getImageUrl'](_0x21db65,_0x41abe1){const _0x1d88a7=_0x571c3a,_0x20b000={'WNQlx':'&rkey=','EYNPp':function(_0x948ddd,_0x4f2cc9){return _0x948ddd+_0x4f2cc9;},'lMuse':function(_0x3e7a91,_0x31067d){return _0x3e7a91+_0x31067d;},'owxpp':function(_0x28074c,_0x155256){return _0x28074c||_0x155256;},'JSjwV':function(_0x4d0ddc,_0x10192a,_0x1990dd){return _0x4d0ddc(_0x10192a,_0x1990dd);},'eTgLY':_0x1d88a7(0xf4)};if(!_0x21db65)return'';const _0x2251ed=_0x21db65['originImageUrl'],_0x3acee8=_0x21db65['md5HexStr'],_0x5709cc=_0x21db65[_0x1d88a7(0x125)],_0x92cde0=_0x21db65[_0x1d88a7(0x10c)];if(_0x2251ed){if(_0x2251ed[_0x1d88a7(0x101)](_0x1d88a7(0x121))){if(_0x2251ed[_0x1d88a7(0xdb)](_0x20b000[_0x1d88a7(0x114)]))return _0x20b000[_0x1d88a7(0x111)](IMAGE_HTTP_HOST_NT,_0x2251ed);const _0x3ece6a=await rkeyManager[_0x1d88a7(0x119)](),_0x282d8a=_0x41abe1?_0x3ece6a['private_rkey']:_0x3ece6a[_0x1d88a7(0xe9)];return _0x20b000[_0x1d88a7(0x103)](IMAGE_HTTP_HOST_NT+_0x2251ed,''+_0x282d8a);}else return _0x20b000[_0x1d88a7(0x111)](IMAGE_HTTP_HOST,_0x2251ed);}else{if(_0x20b000[_0x1d88a7(0x120)](_0x5709cc,_0x3acee8))return IMAGE_HTTP_HOST+_0x1d88a7(0x127)+_0x20b000[_0x1d88a7(0x120)](_0x5709cc,_0x3acee8)['toUpperCase']()+'/0';}return _0x20b000[_0x1d88a7(0xf0)](logDebug,_0x20b000[_0x1d88a7(0xfb)],_0x21db65),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x1a2356=!![]){return'';}static[_0x571c3a(0x12a)](){return'';}static[_0x571c3a(0xf3)](_0x8ecdd2=[_0x571c3a(0x10e),_0x571c3a(0x126)]){const _0x168639=_0x571c3a;return napCatCore[_0x168639(0xfc)]['getStorageCleanService']()[_0x168639(0xf2)](_0x8ecdd2);}static[_0x571c3a(0xf6)](_0x306deb={}){const _0x23c97e=_0x571c3a;return napCatCore['session'][_0x23c97e(0xdf)]()[_0x23c97e(0xe5)](_0x306deb);}static['scanCache'](){const _0x3b2c51=_0x571c3a;return napCatCore[_0x3b2c51(0xfc)][_0x3b2c51(0xdf)]()[_0x3b2c51(0x11d)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x571c3a(0xdc)](_0x11f113,_0x445ccc=0x3e8,_0x31f780=0x0){const _0x3016e3=_0x571c3a;return napCatCore[_0x3016e3(0xfc)]['getStorageCleanService']()[_0x3016e3(0x10d)](_0x11f113,_0x445ccc,0x1,_0x31f780);}static['getFileCacheInfo'](_0x121665,_0x3862ac=0x3e8,_0x3b8f15){const _0x524a38=_0x3b8f15?_0x3b8f15:{'fileType':_0x121665};}static async[_0x571c3a(0x115)](_0x215b08=[],_0x2c1548=[]){const _0x21f6ad=_0x571c3a;return napCatCore['session']['getStorageCleanService']()[_0x21f6ad(0x112)](_0x215b08,_0x2c1548);}}