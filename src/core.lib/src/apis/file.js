const _0x1bac3d=_0x2e3f;(function(_0x30446a,_0x459cf5){const _0x29ae95=_0x2e3f,_0x59e176=_0x30446a();while(!![]){try{const _0x16fa24=parseInt(_0x29ae95(0x157))/0x1*(-parseInt(_0x29ae95(0x14e))/0x2)+parseInt(_0x29ae95(0x169))/0x3+parseInt(_0x29ae95(0x15d))/0x4+parseInt(_0x29ae95(0x173))/0x5+-parseInt(_0x29ae95(0x14f))/0x6*(parseInt(_0x29ae95(0x163))/0x7)+-parseInt(_0x29ae95(0x141))/0x8+parseInt(_0x29ae95(0x13a))/0x9;if(_0x16fa24===_0x459cf5)break;else _0x59e176['push'](_0x59e176['shift']());}catch(_0x45485f){_0x59e176['push'](_0x59e176['shift']());}}}(_0x375c,0x24390));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x34ab25 from'path';import _0x5df45b from'fs';function _0x2e3f(_0x45c473,_0x423523){const _0x375c73=_0x375c();return _0x2e3f=function(_0x2e3f0f,_0x3b3577){_0x2e3f0f=_0x2e3f0f-0x138;let _0x4a5dd7=_0x375c73[_0x2e3f0f];return _0x4a5dd7;},_0x2e3f(_0x45c473,_0x423523);}import _0x2f3a04 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x3d90aa from'file-type';import{MsgListener}from'@/core/listeners';import _0x3bbb32 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x1bac3d(0x17f)]=_0x4f08b4=>{const _0x5a62ea=_0x1bac3d,_0x474b74={'xDthn':function(_0x368939,_0x52eb1b){return _0x368939(_0x52eb1b);}};for(const [_0x546bd6,_0x333cb3]of downloadMediaTasks){_0x474b74[_0x5a62ea(0x145)](_0x333cb3,_0x4f08b4),downloadMediaTasks[_0x5a62ea(0x13c)](_0x546bd6);}},setTimeout(()=>{const _0x370539=_0x1bac3d;napCatCore[_0x370539(0x16d)](()=>{const _0x52962d=_0x370539;napCatCore[_0x52962d(0x14b)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x15a009){const _0x39ec35=_0x1bac3d;return _0x3d90aa[_0x39ec35(0x17b)](_0x15a009);}static async[_0x1bac3d(0x17a)](_0x23d1ad,_0x5e565b){const _0x50e801=_0x1bac3d;await napCatCore[_0x50e801(0x13e)][_0x50e801(0x17a)](_0x23d1ad,_0x5e565b);}static async[_0x1bac3d(0x15a)](_0x52856d){const _0x449f03=_0x1bac3d;return await napCatCore[_0x449f03(0x13e)]['getFileSize'](_0x52856d);}static async[_0x1bac3d(0x176)](_0x1c9724,_0x19514c=ElementType[_0x1bac3d(0x158)],_0x3af730=0x0){const _0x1a1cee=_0x1bac3d,_0x4ef510={'ClxOt':function(_0x489343,_0xbff6e5){return _0x489343(_0xbff6e5);},'RROql':function(_0x290e29,_0x5297bf){return _0x290e29+_0x5297bf;},'yfCfn':function(_0x151808,_0x204e9b){return _0x151808===_0x204e9b;}},_0x309436=await _0x4ef510['ClxOt'](calculateFileMD5,_0x1c9724);let _0x14a748=(await NTQQFileApi[_0x1a1cee(0x177)](_0x1c9724))?.['ext']||'';_0x14a748&&(_0x14a748=_0x4ef510[_0x1a1cee(0x139)]('.',_0x14a748));let _0x71c202=''+_0x34ab25['basename'](_0x1c9724);_0x4ef510[_0x1a1cee(0x17c)](_0x71c202[_0x1a1cee(0x15f)]('.'),-0x1)&&(_0x71c202+=_0x14a748);const _0x2e3fac=napCatCore[_0x1a1cee(0x149)][_0x1a1cee(0x166)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x309436,'fileName':_0x71c202,'elementType':_0x19514c,'elementSubType':_0x3af730,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x1a1cee(0x17a)](_0x1c9724,_0x2e3fac);const _0x4abe47=await NTQQFileApi['getFileSize'](_0x1c9724);return{'md5':_0x309436,'fileName':_0x71c202,'path':_0x2e3fac,'fileSize':_0x4abe47,'ext':_0x14a748};}static async['downloadMedia'](_0x51bd5e,_0x4570d8,_0x1c76db,_0x42f130,_0x1659b5,_0x52fabc,_0xba7112=0x3e8*0x3c*0x2,_0x53c628=![]){const _0x2afc44=_0x1bac3d,_0x3be8e3={'Htwgd':_0x2afc44(0x151),'nVNiE':function(_0x3abc4c,_0x407637){return _0x3abc4c===_0x407637;},'HKEij':function(_0x146be3,_0x491645,_0x3fa935){return _0x146be3(_0x491645,_0x3fa935);},'lVDyd':_0x2afc44(0x154),'Jlsic':function(_0x40c07a,_0x421dad){return _0x40c07a(_0x421dad);},'tKyYB':function(_0x9d9205,_0x3c57fc,_0x5487be){return _0x9d9205(_0x3c57fc,_0x5487be);},'CuYEK':function(_0x296f78,_0x20185c,_0x4627d6,_0x50dd31,_0x5c83cf,_0x485959,_0x566330,_0x2d0720,_0x63398,_0x566653){return _0x296f78(_0x20185c,_0x4627d6,_0x50dd31,_0x5c83cf,_0x485959,_0x566330,_0x2d0720,_0x63398,_0x566653);},'McROc':_0x2afc44(0x144),'IJFku':function(_0x5c9d0b,_0xa9895d,_0x50e5ee,_0x339bf0,_0x1fc4c2,_0x2d3814,_0x11c1c2,_0x498ff6,_0x3f3442,_0xf8c71d){return _0x5c9d0b(_0xa9895d,_0x50e5ee,_0x339bf0,_0x1fc4c2,_0x2d3814,_0x11c1c2,_0x498ff6,_0x3f3442,_0xf8c71d);},'sCYMf':_0x2afc44(0x164)};_0x3be8e3[_0x2afc44(0x16a)](logDebug,_0x3be8e3[_0x2afc44(0x142)],_0x51bd5e,_0x4570d8,_0x1c76db,_0x42f130,_0x1659b5,_0x52fabc,_0xba7112,_0x53c628);if(_0x52fabc&&_0x5df45b['existsSync'](_0x52fabc)){if(_0x53c628)try{await _0x2f3a04['unlink'](_0x52fabc);}catch(_0x7d02e4){}else return _0x52fabc;}return _0x3be8e3[_0x2afc44(0x175)](logDebug,_0x3be8e3['sCYMf'],_0x51bd5e,_0x4570d8,_0x1c76db,_0x42f130,_0x1659b5,_0x52fabc,_0xba7112,_0x53c628),new Promise((_0xf3b6bd,_0x384409)=>{const _0x16882a=_0x2afc44,_0x1b0c6c={'jsOoS':_0x3be8e3['Htwgd'],'YClHD':function(_0x18f425,_0x28618a){const _0x2181a8=_0x2e3f;return _0x3be8e3[_0x2181a8(0x167)](_0x18f425,_0x28618a);},'KZUAQ':function(_0x4933f1,_0x21ea40,_0x376b37){const _0x759783=_0x2e3f;return _0x3be8e3[_0x759783(0x160)](_0x4933f1,_0x21ea40,_0x376b37);},'yAGnY':_0x3be8e3[_0x16882a(0x178)],'LcCGg':function(_0x2b4aee,_0xd8a4a3){const _0x23069d=_0x16882a;return _0x3be8e3[_0x23069d(0x16f)](_0x2b4aee,_0xd8a4a3);},'adCYr':'下载超时'};let _0x534ae2=![];const _0x51d978=_0x1c09d4=>{const _0x2d2d11=_0x16882a;logDebug(_0x1b0c6c['jsOoS'],_0x1c09d4,_0x51bd5e);if(_0x1b0c6c[_0x2d2d11(0x147)](_0x1c09d4[_0x2d2d11(0x168)],_0x51bd5e)){_0x534ae2=!![];let _0x1da7e8=_0x1c09d4['filePath'];if(_0x1da7e8[_0x2d2d11(0x138)]('\x5c')){const _0x333798=sessionConfig['defaultFileDownloadPath'];_0x1b0c6c[_0x2d2d11(0x13f)](logDebug,_0x1b0c6c[_0x2d2d11(0x162)],_0x333798),_0x1da7e8=_0x34ab25[_0x2d2d11(0x159)](_0x333798,_0x1da7e8);}_0x1b0c6c[_0x2d2d11(0x17d)](_0xf3b6bd,_0x1da7e8);}};downloadMediaTasks[_0x16882a(0x150)](randomUUID(),_0x51d978),_0x3be8e3[_0x16882a(0x161)](setTimeout,()=>{!_0x534ae2&&_0x384409(_0x1b0c6c['adCYr']);},_0xba7112),napCatCore['session']['getMsgService']()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x51bd5e,'chatType':_0x4570d8,'peerUid':_0x1c76db,'elementId':_0x42f130,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1659b5});});}static async['getImageSize'](_0x1dae7f){const _0x10282d={'gEHhW':function(_0x125c4f,_0x325f14){return _0x125c4f(_0x325f14);},'SySfA':function(_0x1296ad,_0x2e93ff,_0x35e076){return _0x1296ad(_0x2e93ff,_0x35e076);}};return new Promise((_0xa837d2,_0x52a72a)=>{const _0x1d1b06=_0x2e3f;_0x10282d[_0x1d1b06(0x156)](_0x3bbb32,_0x1dae7f,(_0x140127,_0x16b734)=>{const _0x2ac65f=_0x1d1b06;_0x140127?_0x52a72a(_0x140127):_0x10282d[_0x2ac65f(0x170)](_0xa837d2,_0x16b734);});});}static async[_0x1bac3d(0x148)](_0x480f71,_0x231894){const _0x1bdef8=_0x1bac3d,_0xcab87c={'bEpHP':'/download','jOGPE':_0x1bdef8(0x172),'DbCWd':function(_0xd60ace,_0x43100e){return _0xd60ace+_0x43100e;},'TMVWz':function(_0x5abd13,_0x2ce746){return _0x5abd13||_0x2ce746;},'HRBwJ':_0x1bdef8(0x143)};if(!_0x480f71)return'';const _0x5b70ea=_0x480f71[_0x1bdef8(0x14d)],_0x2691c3=_0x480f71[_0x1bdef8(0x155)],_0x3d6963=_0x480f71[_0x1bdef8(0x155)],_0x5c970e=_0x480f71['fileUuid'];if(_0x5b70ea){if(_0x5b70ea['startsWith'](_0xcab87c[_0x1bdef8(0x15c)])){if(_0x5b70ea[_0x1bdef8(0x152)](_0xcab87c[_0x1bdef8(0x17e)]))return IMAGE_HTTP_HOST_NT+_0x5b70ea;const _0x4c2c18=await rkeyManager[_0x1bdef8(0x165)](),_0x182c64=_0x231894?_0x4c2c18[_0x1bdef8(0x16e)]:_0x4c2c18[_0x1bdef8(0x180)];return _0xcab87c[_0x1bdef8(0x171)](_0xcab87c[_0x1bdef8(0x171)](IMAGE_HTTP_HOST_NT,_0x5b70ea),''+_0x182c64);}else return _0xcab87c[_0x1bdef8(0x171)](IMAGE_HTTP_HOST,_0x5b70ea);}else{if(_0xcab87c[_0x1bdef8(0x13d)](_0x3d6963,_0x2691c3))return IMAGE_HTTP_HOST+_0x1bdef8(0x15b)+(_0x3d6963||_0x2691c3)['toUpperCase']()+'/0';}return logDebug(_0xcab87c[_0x1bdef8(0x13b)],_0x480f71),'';}}function _0x375c(){const _0x2344a1=['getFileSize','/gchatpic_new/0/0-0-','bEpHP','518980mdlGUY','clearCache','indexOf','HKEij','tKyYB','yAGnY','256991ZUhBgH','start\x20downloadMedia','getRkey','getMsgService','nVNiE','msgId','286707CpORHP','CuYEK','hotUpdate','scanCache','onLoginSuccess','private_rkey','Jlsic','gEHhW','DbCWd','&rkey=','552005hTATyd','getChatCacheList','IJFku','uploadFile','getFileType','lVDyd','addCacheScanedPaths','copyFile','fileTypeFromFile','yfCfn','LcCGg','jOGPE','onRichMediaDownloadComplete','group_rkey','getStorageCleanService','startsWith','RROql','4412250WsGpPP','HRBwJ','delete','TMVWz','util','KZUAQ','tmp','2364248poXvcT','McROc','图片url获取失败','receive\x20downloadMedia\x20task','xDthn','getChatCacheInfo','YClHD','getImageUrl','session','addCacheScannedPaths','addListener','getFileCacheInfo','originImageUrl','4UKcyJI','36ioONvB','set','downloadMedia\x20complete','includes','getCacheSessionPathList','downloadPath','md5HexStr','SySfA','80894EEfEdL','PIC','join'];_0x375c=function(){return _0x2344a1;};return _0x375c();}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x2d6685=!![]){return'';}static[_0x1bac3d(0x153)](){return'';}static[_0x1bac3d(0x15e)](_0x4795a5=[_0x1bac3d(0x140),_0x1bac3d(0x16b)]){const _0x15b1d9=_0x1bac3d;return napCatCore[_0x15b1d9(0x149)][_0x15b1d9(0x181)]()['clearCacheDataByKeys'](_0x4795a5);}static[_0x1bac3d(0x14a)](_0x5dfd02={}){const _0x3d7984=_0x1bac3d;return napCatCore['session'][_0x3d7984(0x181)]()[_0x3d7984(0x179)](_0x5dfd02);}static['scanCache'](){const _0x59de38=_0x1bac3d;return napCatCore[_0x59de38(0x149)][_0x59de38(0x181)]()[_0x59de38(0x16c)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x1bac3d(0x174)](_0x39b7fe,_0x39856b=0x3e8,_0x34e346=0x0){const _0x543bec=_0x1bac3d;return napCatCore['session']['getStorageCleanService']()[_0x543bec(0x146)](_0x39b7fe,_0x39856b,0x1,_0x34e346);}static[_0x1bac3d(0x14c)](_0x12ec89,_0x1da9c8=0x3e8,_0x515164){const _0x359f45=_0x515164?_0x515164:{'fileType':_0x12ec89};}static async['clearChatCache'](_0x5e49b7=[],_0x2eb162=[]){const _0x471d4e=_0x1bac3d;return napCatCore['session'][_0x471d4e(0x181)]()['clearChatCacheInfo'](_0x5e49b7,_0x2eb162);}}