const _0x17f239=_0x1d55;(function(_0xac84fc,_0x25d7e4){const _0x47c8b3=_0x1d55,_0x1827a7=_0xac84fc();while(!![]){try{const _0xfa315=parseInt(_0x47c8b3(0x156))/0x1*(-parseInt(_0x47c8b3(0x15a))/0x2)+parseInt(_0x47c8b3(0x146))/0x3+parseInt(_0x47c8b3(0x14b))/0x4+parseInt(_0x47c8b3(0x15c))/0x5*(-parseInt(_0x47c8b3(0x158))/0x6)+parseInt(_0x47c8b3(0x165))/0x7*(-parseInt(_0x47c8b3(0x139))/0x8)+-parseInt(_0x47c8b3(0x14e))/0x9+parseInt(_0x47c8b3(0x13a))/0xa*(parseInt(_0x47c8b3(0x131))/0xb);if(_0xfa315===_0x25d7e4)break;else _0x1827a7['push'](_0x1827a7['shift']());}catch(_0x5f4761){_0x1827a7['push'](_0x1827a7['shift']());}}}(_0x3b9a,0xdc9e8));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x59a87d from'path';import _0x376b1d from'fs';import _0x4d5fd5 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x349954 from'file-type';import{MsgListener}from'@/core/listeners';import _0xe191aa from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';function _0x1d55(_0xd13aae,_0x48b60e){const _0x3b9a17=_0x3b9a();return _0x1d55=function(_0x1d5507,_0x30d390){_0x1d5507=_0x1d5507-0x127;let _0x56b3f0=_0x3b9a17[_0x1d5507];return _0x56b3f0;},_0x1d55(_0xd13aae,_0x48b60e);}import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x17f239(0x145)]=_0x3e662f=>{const _0x274c0e=_0x17f239,_0xf5b143={'eEvLU':function(_0xa32d40,_0x428beb){return _0xa32d40(_0x428beb);}};for(const [_0xb91458,_0x5a3b0f]of downloadMediaTasks){_0xf5b143[_0x274c0e(0x163)](_0x5a3b0f,_0x3e662f),downloadMediaTasks['delete'](_0xb91458);}},setTimeout(()=>{const _0x30d390=_0x17f239;napCatCore[_0x30d390(0x147)](()=>{const _0x339fe9=_0x30d390;napCatCore[_0x339fe9(0x129)](downloadMediaListener);});},0x64);function _0x3b9a(){const _0x14f83b=['defaultFileDownloadPath','getChatCacheList','fileUuid','5767692EHGrlO','getRkey','oHBPC','9652743pMcilI','session','addCacheScannedPaths','msgId','getDesktopTmpPath','getMsgService','toUpperCase','getFileSize','338549vVFAtM','getRichMediaFilePathForGuild','260334DuSPEs','getImageSize','8xTkhzW','group_rkey','45xpuCIz','getImageUrl','FkVSb','TVptC','getCacheSessionPathList','clearChatCache','downloadRichMedia','eEvLU','startsWith','21fyYner','umwIP','originImageUrl','tmp','getStorageCleanService','hotUpdate','uploadFile','fileTypeFromFile','addListener','YuTQs','&rkey=','trVQN','copyFile','clearCacheDataByKeys','downloadMedia','md5HexStr','12989042UYFkvp','addCacheScanedPaths','scanCache','unlink','Zvcue','PIC','setCacheSilentScan','bWZcQ','2482824INVjSb','20EVAwlV','/download','set','下载超时','getFileType','WmKTo','PTOze','util','ExGfp','UJWiA','raWoP','onRichMediaDownloadComplete','2545116KgkPVT','onLoginSuccess'];_0x3b9a=function(){return _0x14f83b;};return _0x3b9a();}export class NTQQFileApi{static async[_0x17f239(0x13e)](_0x53b1ee){const _0x4ae3fe=_0x17f239;return _0x349954[_0x4ae3fe(0x128)](_0x53b1ee);}static async[_0x17f239(0x12d)](_0x5372ea,_0x47ed4a){const _0x2eec95=_0x17f239;await napCatCore[_0x2eec95(0x141)][_0x2eec95(0x12d)](_0x5372ea,_0x47ed4a);}static async[_0x17f239(0x155)](_0x3a032c){const _0x5e7af5=_0x17f239;return await napCatCore['util'][_0x5e7af5(0x155)](_0x3a032c);}static async[_0x17f239(0x127)](_0x5d3224,_0x1a1238=ElementType[_0x17f239(0x136)],_0x3adc00=0x0){const _0x38ed29=_0x17f239,_0x4c74aa={'raWoP':function(_0x2f2318,_0x52e9ce){return _0x2f2318+_0x52e9ce;}},_0x10a611=await calculateFileMD5(_0x5d3224);let _0x3150d0=(await NTQQFileApi[_0x38ed29(0x13e)](_0x5d3224))?.['ext']||'';_0x3150d0&&(_0x3150d0=_0x4c74aa[_0x38ed29(0x144)]('.',_0x3150d0));let _0x56e01b=''+_0x59a87d['basename'](_0x5d3224);_0x56e01b['indexOf']('.')===-0x1&&(_0x56e01b+=_0x3150d0);const _0x5c4ae0=napCatCore[_0x38ed29(0x14f)][_0x38ed29(0x153)]()[_0x38ed29(0x157)]({'md5HexStr':_0x10a611,'fileName':_0x56e01b,'elementType':_0x1a1238,'elementSubType':_0x3adc00,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x38ed29(0x12d)](_0x5d3224,_0x5c4ae0);const _0x425ebe=await NTQQFileApi['getFileSize'](_0x5d3224);return{'md5':_0x10a611,'fileName':_0x56e01b,'path':_0x5c4ae0,'fileSize':_0x425ebe,'ext':_0x3150d0};}static async[_0x17f239(0x12f)](_0x3d5afa,_0x40c54d,_0x4ca2cc,_0x3f2e0a,_0x110772,_0x471bee,_0x1f68fb=0x3e8*0x3c*0x2,_0x30a0b0=![]){const _0xa45622=_0x17f239,_0x5a0602={'WmKTo':function(_0x561a36,_0x58fc61){return _0x561a36===_0x58fc61;},'TVptC':function(_0x5a6754,_0x3ae947){return _0x5a6754(_0x3ae947);},'oHBPC':function(_0x4ec32b,_0x444f5a){return _0x4ec32b(_0x444f5a);},'umwIP':_0xa45622(0x13d),'BFvIb':function(_0x150f67){return _0x150f67();},'trVQN':function(_0x480287,_0x2190a2,_0x47924d){return _0x480287(_0x2190a2,_0x47924d);}};if(_0x471bee&&_0x376b1d['existsSync'](_0x471bee)){if(_0x30a0b0)try{await _0x4d5fd5[_0xa45622(0x134)](_0x471bee);}catch(_0x3cc536){}else return _0x471bee;}return new Promise((_0x55b2ac,_0x33f441)=>{const _0x55d28f=_0xa45622;let _0x432a93=![];const _0xccdad5=_0x265b16=>{const _0x52411b=_0x1d55;if(_0x5a0602[_0x52411b(0x13f)](_0x265b16[_0x52411b(0x151)],_0x3d5afa)){_0x432a93=!![];let _0x506b0a=_0x265b16['filePath'];if(_0x506b0a['startsWith']('\x5c')){const _0x2b1b5d=sessionConfig[_0x52411b(0x148)];_0x506b0a=_0x59a87d['join'](_0x2b1b5d,_0x506b0a);}_0x5a0602[_0x52411b(0x15f)](_0x55b2ac,_0x506b0a);}};downloadMediaTasks[_0x55d28f(0x13c)](_0x5a0602['BFvIb'](randomUUID),_0xccdad5),_0x5a0602[_0x55d28f(0x12c)](setTimeout,()=>{const _0x3805f5=_0x55d28f;!_0x432a93&&_0x5a0602[_0x3805f5(0x14d)](_0x33f441,_0x5a0602[_0x3805f5(0x166)]);},_0x1f68fb),napCatCore[_0x55d28f(0x14f)][_0x55d28f(0x153)]()[_0x55d28f(0x162)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3d5afa,'chatType':_0x40c54d,'peerUid':_0x4ca2cc,'elementId':_0x3f2e0a,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x110772});});}static async[_0x17f239(0x159)](_0x2b17bc){const _0x46ae53={'UJWiA':function(_0x4888c2,_0x3c335f,_0x1ee9ec){return _0x4888c2(_0x3c335f,_0x1ee9ec);}};return new Promise((_0x13846b,_0xa9551b)=>{const _0x70c4dd=_0x1d55,_0x6addfd={'ExGfp':function(_0x5c6709,_0x290980){return _0x5c6709(_0x290980);}};_0x46ae53[_0x70c4dd(0x143)](_0xe191aa,_0x2b17bc,(_0x55c170,_0x309a27)=>{const _0x214df9=_0x70c4dd;_0x55c170?_0xa9551b(_0x55c170):_0x6addfd[_0x214df9(0x142)](_0x13846b,_0x309a27);});});}static async[_0x17f239(0x15d)](_0x2f4af8,_0x4375ce){const _0x47c4ee=_0x17f239,_0x176055={'VktpK':_0x47c4ee(0x12b),'PTOze':function(_0x410db9,_0x222fa4){return _0x410db9+_0x222fa4;},'bWZcQ':function(_0x2b3ccb,_0x20b0ff){return _0x2b3ccb||_0x20b0ff;},'YuTQs':function(_0xc073ab,_0x108f9d){return _0xc073ab||_0x108f9d;},'Zvcue':function(_0x3bfa53,_0x2ec6f1,_0x54c3d9){return _0x3bfa53(_0x2ec6f1,_0x54c3d9);},'FkVSb':'图片url获取失败'};if(!_0x2f4af8)return'';const _0x5aed42=_0x2f4af8[_0x47c4ee(0x167)],_0x1f55b7=_0x2f4af8['md5HexStr'],_0x40eb10=_0x2f4af8[_0x47c4ee(0x130)],_0x58691f=_0x2f4af8[_0x47c4ee(0x14a)];if(_0x5aed42){if(_0x5aed42[_0x47c4ee(0x164)](_0x47c4ee(0x13b))){if(_0x5aed42['includes'](_0x176055['VktpK']))return IMAGE_HTTP_HOST_NT+_0x5aed42;const _0x471050=await rkeyManager[_0x47c4ee(0x14c)](),_0x2bbdbb=_0x4375ce?_0x471050['private_rkey']:_0x471050[_0x47c4ee(0x15b)];return _0x176055[_0x47c4ee(0x140)](_0x176055['PTOze'](IMAGE_HTTP_HOST_NT,_0x5aed42),''+_0x2bbdbb);}else return _0x176055[_0x47c4ee(0x140)](IMAGE_HTTP_HOST,_0x5aed42);}else{if(_0x176055[_0x47c4ee(0x138)](_0x40eb10,_0x1f55b7))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x176055[_0x47c4ee(0x12a)](_0x40eb10,_0x1f55b7)[_0x47c4ee(0x154)]()+'/0';}return _0x176055[_0x47c4ee(0x135)](logDebug,_0x176055[_0x47c4ee(0x15e)],_0x2f4af8),'';}}export class NTQQFileCacheApi{static async[_0x17f239(0x137)](_0x54da30=!![]){return'';}static[_0x17f239(0x160)](){return'';}static['clearCache'](_0x405035=[_0x17f239(0x168),_0x17f239(0x16a)]){const _0x247785=_0x17f239;return napCatCore[_0x247785(0x14f)][_0x247785(0x169)]()[_0x247785(0x12e)](_0x405035);}static[_0x17f239(0x150)](_0x4aa7ec={}){const _0x1591e5=_0x17f239;return napCatCore[_0x1591e5(0x14f)]['getStorageCleanService']()[_0x1591e5(0x132)](_0x4aa7ec);}static[_0x17f239(0x133)](){const _0x3ae545=_0x17f239;return napCatCore['session'][_0x3ae545(0x169)]()[_0x3ae545(0x133)]();}static['getHotUpdateCachePath'](){return'';}static[_0x17f239(0x152)](){return'';}static[_0x17f239(0x149)](_0x59d675,_0x38b8ea=0x3e8,_0x5c55a9=0x0){const _0x42cdd9=_0x17f239;return napCatCore[_0x42cdd9(0x14f)][_0x42cdd9(0x169)]()['getChatCacheInfo'](_0x59d675,_0x38b8ea,0x1,_0x5c55a9);}static['getFileCacheInfo'](_0x30719e,_0x26c5f6=0x3e8,_0x1e96fd){const _0x591463=_0x1e96fd?_0x1e96fd:{'fileType':_0x30719e};}static async[_0x17f239(0x161)](_0x1601b2=[],_0x5906b0=[]){return napCatCore['session']['getStorageCleanService']()['clearChatCacheInfo'](_0x1601b2,_0x5906b0);}}