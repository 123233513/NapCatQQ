const _0x49c3d3=_0x330f;(function(_0x479592,_0x3447cc){const _0x3c49a2=_0x330f,_0x3db9a4=_0x479592();while(!![]){try{const _0x515868=parseInt(_0x3c49a2(0x1d2))/0x1+-parseInt(_0x3c49a2(0x1b4))/0x2*(parseInt(_0x3c49a2(0x1ad))/0x3)+-parseInt(_0x3c49a2(0x1bc))/0x4+-parseInt(_0x3c49a2(0x1c2))/0x5*(parseInt(_0x3c49a2(0x1b9))/0x6)+parseInt(_0x3c49a2(0x19a))/0x7*(parseInt(_0x3c49a2(0x1ae))/0x8)+-parseInt(_0x3c49a2(0x193))/0x9*(parseInt(_0x3c49a2(0x1ca))/0xa)+parseInt(_0x3c49a2(0x1b5))/0xb;if(_0x515868===_0x3447cc)break;else _0x3db9a4['push'](_0x3db9a4['shift']());}catch(_0x742bad){_0x3db9a4['push'](_0x3db9a4['shift']());}}}(_0x55f1,0x6568e));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x55f1(){const _0x262769=['util','XbgRf','xtaNN','iroZe','getCacheSessionPathList','fShIj','getRichMediaFilePathForGuild','addListener','copyFile','basename','group_rkey','getFileType','sWTOZ','getFileCacheInfo','existsSync','/gchatpic_new/0/0-0-','includes','EBWeh','3LAUwED','336520KutzHw','getHotUpdateCachePath','getImageSize','getStorageCleanService','clearCacheDataByKeys','xynvC','1230838SRBqyI','6715676lPXwbZ','toUpperCase','downloadRichMedia','dFZEJ','42CMFkkv','addCacheScannedPaths','xAXpD','616440HwsTOK','wFBcF','getFileSize','PIC','md5HexStr','private_rkey','460495yBHFXA','join','HhvSw','addCacheScanedPaths','defaultFileDownloadPath','startsWith','getMsgService','ext','30rPkPcR','GQLcX','FxpAZ','getChatCacheInfo','KIqfm','hotUpdate','onLoginSuccess','DNJwL','790348jKajXS','originImageUrl','uploadFile','start\x20downloadMedia','downloadPath','下载超时','fileTypeFromFile','session','receive\x20downloadMedia\x20task','clearChatCache','set','DbelI','354339ITduoP','clearChatCacheInfo','clearCache','delete','NMrUn','getDesktopTmpPath','unlink','91Oomaij'];_0x55f1=function(){return _0x262769;};return _0x55f1();}import _0x43590d from'path';import _0x52a175 from'fs';import _0x23065d from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x22be0b from'file-type';import{MsgListener}from'@/core/listeners';import _0x407272 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x216038=>{const _0x3478f2=_0x330f,_0x2b842a={'EBWeh':function(_0x362798,_0x5d917b){return _0x362798(_0x5d917b);}};for(const [_0x31ee23,_0x3e89cb]of downloadMediaTasks){_0x2b842a[_0x3478f2(0x1ac)](_0x3e89cb,_0x216038),downloadMediaTasks[_0x3478f2(0x196)](_0x31ee23);}},setTimeout(()=>{const _0x25266a=_0x330f;napCatCore[_0x25266a(0x1d0)](()=>{const _0x29080d=_0x25266a;napCatCore[_0x29080d(0x1a2)](downloadMediaListener);});},0x64);function _0x330f(_0x567c59,_0x3c17c2){const _0x55f180=_0x55f1();return _0x330f=function(_0x330f11,_0x21d465){_0x330f11=_0x330f11-0x18f;let _0x4e721a=_0x55f180[_0x330f11];return _0x4e721a;},_0x330f(_0x567c59,_0x3c17c2);}export class NTQQFileApi{static async['getFileType'](_0x11c961){const _0x96e708=_0x330f;return _0x22be0b[_0x96e708(0x1d8)](_0x11c961);}static async[_0x49c3d3(0x1a3)](_0x31ea96,_0x4e85c0){const _0x15f476=_0x49c3d3;await napCatCore['util'][_0x15f476(0x1a3)](_0x31ea96,_0x4e85c0);}static async[_0x49c3d3(0x1be)](_0x31248c){const _0x2bf17d=_0x49c3d3;return await napCatCore[_0x2bf17d(0x19b)][_0x2bf17d(0x1be)](_0x31248c);}static async[_0x49c3d3(0x1d4)](_0x5bee9f,_0x18a334=ElementType[_0x49c3d3(0x1bf)],_0x4085d6=0x0){const _0x321773=_0x49c3d3,_0x102b15={'XbgRf':function(_0x2bac23,_0x388347){return _0x2bac23(_0x388347);},'bVCVw':function(_0xf60068,_0x2ca9b5){return _0xf60068+_0x2ca9b5;},'xynvC':function(_0x313b5e,_0x5a1bf3){return _0x313b5e===_0x5a1bf3;}},_0x3c5fb3=await _0x102b15[_0x321773(0x19c)](calculateFileMD5,_0x5bee9f);let _0x582919=(await NTQQFileApi[_0x321773(0x1a6)](_0x5bee9f))?.[_0x321773(0x1c9)]||'';_0x582919&&(_0x582919=_0x102b15['bVCVw']('.',_0x582919));let _0x3a120d=''+_0x43590d[_0x321773(0x1a4)](_0x5bee9f);_0x102b15[_0x321773(0x1b3)](_0x3a120d['indexOf']('.'),-0x1)&&(_0x3a120d+=_0x582919);const _0x5dc9ac=napCatCore['session']['getMsgService']()[_0x321773(0x1a1)]({'md5HexStr':_0x3c5fb3,'fileName':_0x3a120d,'elementType':_0x18a334,'elementSubType':_0x4085d6,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x321773(0x1a3)](_0x5bee9f,_0x5dc9ac);const _0x4ed8d4=await NTQQFileApi['getFileSize'](_0x5bee9f);return{'md5':_0x3c5fb3,'fileName':_0x3a120d,'path':_0x5dc9ac,'fileSize':_0x4ed8d4,'ext':_0x582919};}static async['downloadMedia'](_0x57300d,_0x11c77b,_0x7f12de,_0x4ceea7,_0x5ba6e1,_0x31136d,_0x452bfb=0x3e8*0x3c*0x2,_0x12ca44=![]){const _0x18ac36=_0x49c3d3,_0x44ff85={'dFZEJ':'downloadMedia\x20complete','sWTOZ':function(_0x3bcb8e,_0x3ca2a0,_0x59a553){return _0x3bcb8e(_0x3ca2a0,_0x59a553);},'HhvSw':function(_0x1ceb58,_0x4ee753){return _0x1ceb58(_0x4ee753);},'DNJwL':_0x18ac36(0x1d7),'fShIj':function(_0x59f42f){return _0x59f42f();},'wFBcF':function(_0x94a17f,_0x5e7641,_0x5c6dfa){return _0x94a17f(_0x5e7641,_0x5c6dfa);},'FxpAZ':_0x18ac36(0x18f),'dbgmv':function(_0x22caa6,_0x2a5714,_0x2626a7,_0x54edc3,_0x6e91b,_0x1f1a28,_0x250089,_0x190998,_0x61b2de,_0x3eab6c){return _0x22caa6(_0x2a5714,_0x2626a7,_0x54edc3,_0x6e91b,_0x1f1a28,_0x250089,_0x190998,_0x61b2de,_0x3eab6c);},'NMrUn':_0x18ac36(0x1d5)};logDebug(_0x44ff85[_0x18ac36(0x1cc)],_0x57300d,_0x11c77b,_0x7f12de,_0x4ceea7,_0x5ba6e1,_0x31136d,_0x452bfb,_0x12ca44);if(_0x31136d&&_0x52a175[_0x18ac36(0x1a9)](_0x31136d)){if(_0x12ca44)try{await _0x23065d[_0x18ac36(0x199)](_0x31136d);}catch(_0x2d873a){}else return _0x31136d;}return _0x44ff85['dbgmv'](logDebug,_0x44ff85[_0x18ac36(0x197)],_0x57300d,_0x11c77b,_0x7f12de,_0x4ceea7,_0x5ba6e1,_0x31136d,_0x452bfb,_0x12ca44),new Promise((_0x21ef63,_0x365892)=>{const _0x557b40=_0x18ac36;let _0x39b237=![];const _0x405a4e=_0x4a30a5=>{const _0x435244=_0x330f;logDebug(_0x44ff85[_0x435244(0x1b8)],_0x4a30a5,_0x57300d);if(_0x4a30a5['msgId']===_0x57300d){_0x39b237=!![];let _0x230f47=_0x4a30a5['filePath'];if(_0x230f47[_0x435244(0x1c7)]('\x5c')){const _0x24e67f=sessionConfig[_0x435244(0x1c6)];_0x44ff85[_0x435244(0x1a7)](logDebug,_0x435244(0x1d6),_0x24e67f),_0x230f47=_0x43590d[_0x435244(0x1c3)](_0x24e67f,_0x230f47);}_0x44ff85[_0x435244(0x1c4)](_0x21ef63,_0x230f47);}};downloadMediaTasks[_0x557b40(0x191)](_0x44ff85[_0x557b40(0x1a0)](randomUUID),_0x405a4e),_0x44ff85[_0x557b40(0x1bd)](setTimeout,()=>{const _0x152d4e=_0x557b40;!_0x39b237&&_0x44ff85['HhvSw'](_0x365892,_0x44ff85[_0x152d4e(0x1d1)]);},_0x452bfb),napCatCore['session'][_0x557b40(0x1c8)]()[_0x557b40(0x1b7)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x57300d,'chatType':_0x11c77b,'peerUid':_0x7f12de,'elementId':_0x4ceea7,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x5ba6e1});});}static async[_0x49c3d3(0x1b0)](_0x1aa019){const _0x398bf3={'cWXYU':function(_0xa658b5,_0x1221ad){return _0xa658b5(_0x1221ad);},'xtaNN':function(_0xa85c55,_0x2a9abd){return _0xa85c55(_0x2a9abd);},'GQLcX':function(_0x10b19c,_0x7e695e,_0x528825){return _0x10b19c(_0x7e695e,_0x528825);}};return new Promise((_0xa6827,_0x5aa513)=>{const _0x331073=_0x330f;_0x398bf3[_0x331073(0x1cb)](_0x407272,_0x1aa019,(_0x5a4c64,_0x4d1704)=>{const _0x290a80=_0x331073;_0x5a4c64?_0x398bf3['cWXYU'](_0x5aa513,_0x5a4c64):_0x398bf3[_0x290a80(0x19d)](_0xa6827,_0x4d1704);});});}static async['getImageUrl'](_0x2a67e1,_0x2f846a){const _0x46b7fe=_0x49c3d3,_0x349cec={'jhfhQ':'/download','KIqfm':function(_0x56a372,_0x278c39){return _0x56a372+_0x278c39;},'xAXpD':function(_0x2b1f8a,_0x37e6d0){return _0x2b1f8a+_0x37e6d0;},'DxHfI':function(_0x18c8ab,_0x228def){return _0x18c8ab+_0x228def;},'RYlND':function(_0x2c426c,_0x1819a4){return _0x2c426c||_0x1819a4;},'DbelI':function(_0x5c8842,_0xb75663,_0x5660e0){return _0x5c8842(_0xb75663,_0x5660e0);},'iroZe':'图片url获取失败'};if(!_0x2a67e1)return'';const _0x10a27f=_0x2a67e1[_0x46b7fe(0x1d3)],_0x137477=_0x2a67e1[_0x46b7fe(0x1c0)],_0x2a67ce=_0x2a67e1[_0x46b7fe(0x1c0)],_0x3473ee=_0x2a67e1['fileUuid'];if(_0x10a27f){if(_0x10a27f[_0x46b7fe(0x1c7)](_0x349cec['jhfhQ'])){if(_0x10a27f[_0x46b7fe(0x1ab)]('&rkey='))return _0x349cec[_0x46b7fe(0x1ce)](IMAGE_HTTP_HOST_NT,_0x10a27f);const _0x17b91e=await rkeyManager['getRkey'](),_0x1afc3f=_0x2f846a?_0x17b91e[_0x46b7fe(0x1c1)]:_0x17b91e[_0x46b7fe(0x1a5)];return _0x349cec['KIqfm'](_0x349cec[_0x46b7fe(0x1bb)](IMAGE_HTTP_HOST_NT,_0x10a27f),''+_0x1afc3f);}else return _0x349cec['DxHfI'](IMAGE_HTTP_HOST,_0x10a27f);}else{if(_0x349cec['RYlND'](_0x2a67ce,_0x137477))return IMAGE_HTTP_HOST+_0x46b7fe(0x1aa)+(_0x2a67ce||_0x137477)[_0x46b7fe(0x1b6)]()+'/0';}return _0x349cec[_0x46b7fe(0x192)](logDebug,_0x349cec[_0x46b7fe(0x19e)],_0x2a67e1),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x2c9a0c=!![]){return'';}static[_0x49c3d3(0x19f)](){return'';}static[_0x49c3d3(0x195)](_0x49bc23=['tmp',_0x49c3d3(0x1cf)]){const _0x4e5483=_0x49c3d3;return napCatCore[_0x4e5483(0x1d9)]['getStorageCleanService']()[_0x4e5483(0x1b2)](_0x49bc23);}static[_0x49c3d3(0x1ba)](_0x38f6bd={}){const _0x374512=_0x49c3d3;return napCatCore[_0x374512(0x1d9)][_0x374512(0x1b1)]()[_0x374512(0x1c5)](_0x38f6bd);}static['scanCache'](){const _0x586e9f=_0x49c3d3;return napCatCore['session'][_0x586e9f(0x1b1)]()['scanCache']();}static[_0x49c3d3(0x1af)](){return'';}static[_0x49c3d3(0x198)](){return'';}static['getChatCacheList'](_0x4b47b0,_0x203ba4=0x3e8,_0x562ebd=0x0){const _0x5174dd=_0x49c3d3;return napCatCore[_0x5174dd(0x1d9)]['getStorageCleanService']()[_0x5174dd(0x1cd)](_0x4b47b0,_0x203ba4,0x1,_0x562ebd);}static[_0x49c3d3(0x1a8)](_0x48d6e7,_0x48af02=0x3e8,_0x47ca56){const _0x979566=_0x47ca56?_0x47ca56:{'fileType':_0x48d6e7};}static async[_0x49c3d3(0x190)](_0x406e93=[],_0x473de6=[]){const _0x195d93=_0x49c3d3;return napCatCore[_0x195d93(0x1d9)][_0x195d93(0x1b1)]()[_0x195d93(0x194)](_0x406e93,_0x473de6);}}