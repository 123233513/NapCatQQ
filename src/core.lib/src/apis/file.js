const _0x485245=_0x5dd2;(function(_0x450d7e,_0x2a2ac2){const _0x5230af=_0x5dd2,_0x502e71=_0x450d7e();while(!![]){try{const _0x258860=parseInt(_0x5230af(0xfc))/0x1*(-parseInt(_0x5230af(0xc3))/0x2)+-parseInt(_0x5230af(0xd0))/0x3*(parseInt(_0x5230af(0xeb))/0x4)+parseInt(_0x5230af(0xc4))/0x5+-parseInt(_0x5230af(0xfe))/0x6+parseInt(_0x5230af(0xfb))/0x7*(-parseInt(_0x5230af(0xee))/0x8)+parseInt(_0x5230af(0x102))/0x9+parseInt(_0x5230af(0xbf))/0xa;if(_0x258860===_0x2a2ac2)break;else _0x502e71['push'](_0x502e71['shift']());}catch(_0x5c6d80){_0x502e71['push'](_0x502e71['shift']());}}}(_0x33f4,0x374de));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x573963 from'path';import _0x333305 from'fs';import _0x50007b from'fs/promises';function _0x5dd2(_0x4f6fda,_0x5dc308){const _0x33f433=_0x33f4();return _0x5dd2=function(_0x5dd2ae,_0x19920b){_0x5dd2ae=_0x5dd2ae-0xb4;let _0x2078f0=_0x33f433[_0x5dd2ae];return _0x2078f0;},_0x5dd2(_0x4f6fda,_0x5dc308);}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x5c3972 from'file-type';import{MsgListener}from'@/core/listeners';import _0x12b478 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x5bab31=>{const _0x30cc80={'KTdIw':function(_0x16467d,_0x1929fa){return _0x16467d(_0x1929fa);}};for(const [_0x2fd353,_0x14d8a2]of downloadMediaTasks){_0x30cc80['KTdIw'](_0x14d8a2,_0x5bab31),downloadMediaTasks['delete'](_0x2fd353);}},setTimeout(()=>{const _0x37436b=_0x5dd2;napCatCore[_0x37436b(0xcb)](()=>{const _0x580d6f=_0x37436b;napCatCore[_0x580d6f(0xdc)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x485245(0xef)](_0x496a16){const _0x155bc2=_0x485245;return _0x5c3972[_0x155bc2(0xce)](_0x496a16);}static async['copyFile'](_0x11d2a6,_0x1fb488){const _0x1b8806=_0x485245;await napCatCore[_0x1b8806(0xe5)][_0x1b8806(0xe6)](_0x11d2a6,_0x1fb488);}static async[_0x485245(0xd4)](_0x2bd69){const _0x40a789=_0x485245;return await napCatCore[_0x40a789(0xe5)][_0x40a789(0xd4)](_0x2bd69);}static async[_0x485245(0xbb)](_0x556287,_0x35df78=ElementType['PIC'],_0x36f520=0x0){const _0x17e835=_0x485245,_0x214b4f={'AMJyx':function(_0x20de6a,_0x4847a9){return _0x20de6a(_0x4847a9);},'EGeQK':function(_0x52e001,_0x4cf0ed){return _0x52e001===_0x4cf0ed;}},_0x58519c=await _0x214b4f[_0x17e835(0xcf)](calculateFileMD5,_0x556287);let _0x35e10f=(await NTQQFileApi[_0x17e835(0xef)](_0x556287))?.[_0x17e835(0xc5)]||'';_0x35e10f&&(_0x35e10f='.'+_0x35e10f);let _0x56da9e=''+_0x573963[_0x17e835(0xc1)](_0x556287);_0x214b4f[_0x17e835(0xd3)](_0x56da9e['indexOf']('.'),-0x1)&&(_0x56da9e+=_0x35e10f);const _0x51fe3=napCatCore[_0x17e835(0xe2)][_0x17e835(0xc8)]()[_0x17e835(0xf0)]({'md5HexStr':_0x58519c,'fileName':_0x56da9e,'elementType':_0x35df78,'elementSubType':_0x36f520,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x17e835(0xe6)](_0x556287,_0x51fe3);const _0x166fe4=await NTQQFileApi['getFileSize'](_0x556287);return{'md5':_0x58519c,'fileName':_0x56da9e,'path':_0x51fe3,'fileSize':_0x166fe4,'ext':_0x35e10f};}static async[_0x485245(0x101)](_0x1d3986,_0x1ffa66,_0x87bc88,_0x491213,_0x409d94,_0x169e70,_0x11a211=0x3e8*0x3c*0x2,_0x287236=![]){const _0x53b22a=_0x485245,_0xe2b77c={'SjpPl':function(_0x40c8ba,_0x170033,_0x43865c,_0x3fdabb){return _0x40c8ba(_0x170033,_0x43865c,_0x3fdabb);},'dGJni':_0x53b22a(0xdf),'iQJBm':'downloadPath','Sthaq':function(_0x142997,_0x1006e7){return _0x142997(_0x1006e7);},'DdFjy':function(_0x4e1197){return _0x4e1197();},'amRnc':function(_0x1ff505,_0x591e5f,_0x326f65){return _0x1ff505(_0x591e5f,_0x326f65);},'sXMqy':function(_0x360fc8,_0x594954,_0x1d1875,_0x19a7d1,_0x4c63ff,_0x3adf44,_0x273258,_0x48fc1d,_0x53fb11,_0x4985ec){return _0x360fc8(_0x594954,_0x1d1875,_0x19a7d1,_0x4c63ff,_0x3adf44,_0x273258,_0x48fc1d,_0x53fb11,_0x4985ec);},'cxTwX':_0x53b22a(0xd8),'YmenS':_0x53b22a(0xbd)};_0xe2b77c[_0x53b22a(0xba)](logDebug,_0xe2b77c[_0x53b22a(0xf7)],_0x1d3986,_0x1ffa66,_0x87bc88,_0x491213,_0x409d94,_0x169e70,_0x11a211,_0x287236);if(_0x169e70&&_0x333305['existsSync'](_0x169e70)){if(_0x287236)try{await _0x50007b[_0x53b22a(0xd2)](_0x169e70);}catch(_0x5b8a38){}else return _0x169e70;}return _0xe2b77c[_0x53b22a(0xba)](logDebug,_0xe2b77c['YmenS'],_0x1d3986,_0x1ffa66,_0x87bc88,_0x491213,_0x409d94,_0x169e70,_0x11a211,_0x287236),new Promise((_0x1e2179,_0x3097b1)=>{const _0x36614e=_0x53b22a,_0x403504={'epopb':function(_0x4b1f49,_0x37968c,_0x366fa4,_0x47c055){return _0xe2b77c['SjpPl'](_0x4b1f49,_0x37968c,_0x366fa4,_0x47c055);},'eJTEr':_0xe2b77c[_0x36614e(0xd7)],'vmOFr':function(_0x20a4e3,_0x41c712,_0x130b74){return _0x20a4e3(_0x41c712,_0x130b74);},'MHgSB':_0xe2b77c[_0x36614e(0xcd)],'shZMy':function(_0x2e7555,_0x1303cd){return _0xe2b77c['Sthaq'](_0x2e7555,_0x1303cd);}};let _0x2816de=![];const _0x2e447a=_0xc5248a=>{const _0x5a08e2=_0x36614e;_0x403504[_0x5a08e2(0xbe)](logDebug,_0x403504[_0x5a08e2(0xd1)],_0xc5248a,_0x1d3986);if(_0xc5248a['msgId']===_0x1d3986){_0x2816de=!![];let _0x11802e=_0xc5248a['filePath'];if(_0x11802e['startsWith']('\x5c')){const _0x5f5b6f=sessionConfig[_0x5a08e2(0xf2)];_0x403504[_0x5a08e2(0xff)](logDebug,_0x403504[_0x5a08e2(0xd5)],_0x5f5b6f),_0x11802e=_0x573963[_0x5a08e2(0xec)](_0x5f5b6f,_0x11802e);}_0x403504[_0x5a08e2(0xb8)](_0x1e2179,_0x11802e);}};downloadMediaTasks[_0x36614e(0xb9)](_0xe2b77c[_0x36614e(0xe3)](randomUUID),_0x2e447a),_0xe2b77c['amRnc'](setTimeout,()=>{const _0x7582a7=_0x36614e;!_0x2816de&&_0x3097b1(_0x7582a7(0xe0));},_0x11a211),napCatCore[_0x36614e(0xe2)]['getMsgService']()[_0x36614e(0xf6)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x1d3986,'chatType':_0x1ffa66,'peerUid':_0x87bc88,'elementId':_0x491213,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x409d94});});}static async[_0x485245(0xfa)](_0x41bf9a){const _0x28f14b={'dsQPx':function(_0x21039e,_0x281a77){return _0x21039e(_0x281a77);},'ONCdk':function(_0x41cfad,_0x42d531,_0x5b0076){return _0x41cfad(_0x42d531,_0x5b0076);}};return new Promise((_0xa1cf1d,_0x493dd5)=>{const _0x3dc8f4=_0x5dd2,_0x2e2391={'GOWPx':function(_0x9d4dc1,_0x4f5a53){const _0x36c0c4=_0x5dd2;return _0x28f14b[_0x36c0c4(0xc0)](_0x9d4dc1,_0x4f5a53);}};_0x28f14b[_0x3dc8f4(0xe7)](_0x12b478,_0x41bf9a,(_0x286ba0,_0x513f18)=>{const _0x38aafb=_0x3dc8f4;_0x286ba0?_0x2e2391['GOWPx'](_0x493dd5,_0x286ba0):_0x2e2391[_0x38aafb(0xe4)](_0xa1cf1d,_0x513f18);});});}static async[_0x485245(0xf9)](_0x528ecb,_0x5cb292){const _0x211523=_0x485245,_0x5c9459={'hbWGS':'/download','YfdqI':function(_0x17bbbc,_0x2c95d5){return _0x17bbbc+_0x2c95d5;},'aMBGL':function(_0x7a348e,_0x459a15){return _0x7a348e+_0x459a15;},'KAqjP':function(_0x5d75fb,_0x23cab0){return _0x5d75fb+_0x23cab0;},'dXoGX':function(_0x4c172d,_0x514e06){return _0x4c172d||_0x514e06;},'psOmQ':function(_0x4a8249,_0x2f46be){return _0x4a8249||_0x2f46be;},'twLsc':function(_0x585d92,_0x1896f1,_0x335c71){return _0x585d92(_0x1896f1,_0x335c71);},'sCCZv':_0x211523(0xd6)};if(!_0x528ecb)return'';const _0x50973a=_0x528ecb[_0x211523(0xe9)],_0x4cde5e=_0x528ecb[_0x211523(0xbc)],_0x2a7302=_0x528ecb[_0x211523(0xbc)],_0x2ad789=_0x528ecb[_0x211523(0xd9)];if(_0x50973a){if(_0x50973a['startsWith'](_0x5c9459[_0x211523(0xc7)])){if(_0x50973a[_0x211523(0xdb)](_0x211523(0x100)))return _0x5c9459['YfdqI'](IMAGE_HTTP_HOST_NT,_0x50973a);const _0x564633=await rkeyManager[_0x211523(0xb6)](),_0x286582=_0x5cb292?_0x564633[_0x211523(0xe8)]:_0x564633[_0x211523(0xb7)];return _0x5c9459[_0x211523(0xca)](_0x5c9459['KAqjP'](IMAGE_HTTP_HOST_NT,_0x50973a),''+_0x286582);}else return _0x5c9459[_0x211523(0xca)](IMAGE_HTTP_HOST,_0x50973a);}else{if(_0x5c9459[_0x211523(0xc9)](_0x2a7302,_0x4cde5e))return IMAGE_HTTP_HOST+_0x211523(0xf3)+_0x5c9459[_0x211523(0xed)](_0x2a7302,_0x4cde5e)[_0x211523(0xea)]()+'/0';}return _0x5c9459[_0x211523(0xb4)](logDebug,_0x5c9459[_0x211523(0xf8)],_0x528ecb),'';}}export class NTQQFileCacheApi{static async[_0x485245(0xdd)](_0x3716c9=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x485245(0xf4)](_0x3de5d4=[_0x485245(0xcc),_0x485245(0xb5)]){const _0x89846d=_0x485245;return napCatCore['session']['getStorageCleanService']()[_0x89846d(0xc6)](_0x3de5d4);}static['addCacheScannedPaths'](_0x30ac98={}){const _0x93dace=_0x485245;return napCatCore[_0x93dace(0xe2)][_0x93dace(0xf5)]()[_0x93dace(0xda)](_0x30ac98);}static['scanCache'](){const _0xabe120=_0x485245;return napCatCore[_0xabe120(0xe2)][_0xabe120(0xf5)]()[_0xabe120(0xfd)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x485245(0xde)](_0x43f171,_0x3923e9=0x3e8,_0x4a10e2=0x0){const _0xcf50f6=_0x485245;return napCatCore['session'][_0xcf50f6(0xf5)]()[_0xcf50f6(0xe1)](_0x43f171,_0x3923e9,0x1,_0x4a10e2);}static[_0x485245(0xf1)](_0x184e6b,_0xf756e5=0x3e8,_0x425cb0){const _0x21d784=_0x425cb0?_0x425cb0:{'fileType':_0x184e6b};}static async['clearChatCache'](_0x491433=[],_0x1d44e0=[]){const _0x226e6c=_0x485245;return napCatCore['session']['getStorageCleanService']()[_0x226e6c(0xc2)](_0x491433,_0x1d44e0);}}function _0x33f4(){const _0x500ec9=['receive\x20downloadMedia\x20task','fileUuid','addCacheScanedPaths','includes','addListener','setCacheSilentScan','getChatCacheList','downloadMedia\x20complete','下载超时','getChatCacheInfo','session','DdFjy','GOWPx','util','copyFile','ONCdk','private_rkey','originImageUrl','toUpperCase','12jrLHga','join','psOmQ','8ChFldq','getFileType','getRichMediaFilePathForGuild','getFileCacheInfo','defaultFileDownloadPath','/gchatpic_new/0/0-0-','clearCache','getStorageCleanService','downloadRichMedia','cxTwX','sCCZv','getImageUrl','getImageSize','2911993uNagyM','14SPnGmw','scanCache','383076gLJttr','vmOFr','&rkey=','downloadMedia','2008917yBVbgS','twLsc','hotUpdate','getRkey','group_rkey','shZMy','set','sXMqy','uploadFile','md5HexStr','start\x20downloadMedia','epopb','5152460pmTsky','dsQPx','basename','clearChatCacheInfo','5878ChzgMZ','217715RdqLXm','ext','clearCacheDataByKeys','hbWGS','getMsgService','dXoGX','aMBGL','onLoginSuccess','tmp','iQJBm','fileTypeFromFile','AMJyx','34485qzPEPu','eJTEr','unlink','EGeQK','getFileSize','MHgSB','图片url获取失败','dGJni'];_0x33f4=function(){return _0x500ec9;};return _0x33f4();}