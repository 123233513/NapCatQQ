const _0x53bf98=_0x48b9;(function(_0x52e775,_0x4743a2){const _0x26bb6d=_0x48b9,_0x163bca=_0x52e775();while(!![]){try{const _0x26d610=-parseInt(_0x26bb6d(0x149))/0x1+parseInt(_0x26bb6d(0x115))/0x2+-parseInt(_0x26bb6d(0x140))/0x3+-parseInt(_0x26bb6d(0x13a))/0x4+parseInt(_0x26bb6d(0x13c))/0x5+-parseInt(_0x26bb6d(0x116))/0x6*(parseInt(_0x26bb6d(0x133))/0x7)+-parseInt(_0x26bb6d(0x142))/0x8*(-parseInt(_0x26bb6d(0x14f))/0x9);if(_0x26d610===_0x4743a2)break;else _0x163bca['push'](_0x163bca['shift']());}catch(_0x1150b2){_0x163bca['push'](_0x163bca['shift']());}}}(_0x1142,0xb3b1f));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x34d15a from'path';function _0x48b9(_0x10182f,_0x1565df){const _0x114219=_0x1142();return _0x48b9=function(_0x48b9f2,_0x422a2a){_0x48b9f2=_0x48b9f2-0x105;let _0x32639a=_0x114219[_0x48b9f2];return _0x32639a;},_0x48b9(_0x10182f,_0x1565df);}import _0x2eae9a from'fs';import _0x5f0d6b from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x35720e from'file-type';import{MsgListener}from'@/core/listeners';function _0x1142(){const _0x363c39=['group_rkey','XaCiU','getMsgService','GwXeS','792113sDWUxl','addCacheScanedPaths','downloadMedia\x20complete','SAMoP','clearCacheDataByKeys','PIC','12015xpTLwj','FEmLm','existsSync','scanCache','defaultFileDownloadPath','ZojWW','getRkey','dsvLn','delete','ZHMPS','nHCSy','session','getHotUpdateCachePath','set','/download','tmp','clearChatCache','getImageSize','fileUuid','setCacheSilentScan','toUpperCase','1270360DQUJgj','203334zahphE','UpdDj','util','fileTypeFromFile','图片url获取失败','farJf','addCacheScannedPaths','pzcWV','getStorageCleanService','tAbwP','/gchatpic_new/0/0-0-','onLoginSuccess','getFileType','getDesktopTmpPath','&rkey=','getRichMediaFilePathForGuild','getChatCacheList','zjLGv','start\x20downloadMedia','kGxlc','receive\x20downloadMedia\x20task','zYPcX','pVTHX','startsWith','getFileCacheInfo','BtCXg','onRichMediaDownloadComplete','下载超时','hotUpdate','56GTJHSP','copyFile','private_rkey','getChatCacheInfo','md5HexStr','getFileSize','msgId','4600764owQqpd','downloadMedia','4344810ugGuSK','pKITC','mtkvv','chpKf','1679595KbxzxI','filePath','12016KCXjvk','CNCSb','bJupT'];_0x1142=function(){return _0x363c39;};return _0x1142();}import _0x5088b3 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x53bf98(0x130)]=_0x14ac39=>{const _0x1661a3=_0x53bf98,_0x294631={'pVTHX':function(_0x46057b,_0x34711b){return _0x46057b(_0x34711b);}};for(const [_0x2704c0,_0x51609a]of downloadMediaTasks){_0x294631[_0x1661a3(0x12c)](_0x51609a,_0x14ac39),downloadMediaTasks[_0x1661a3(0x108)](_0x2704c0);}},setTimeout(()=>{const _0x339b48=_0x53bf98;napCatCore[_0x339b48(0x121)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x53bf98(0x122)](_0xb3167f){const _0x3f1bed=_0x53bf98;return _0x35720e[_0x3f1bed(0x119)](_0xb3167f);}static async[_0x53bf98(0x134)](_0x9c52e5,_0x5b42c4){const _0x39c43f=_0x53bf98;await napCatCore[_0x39c43f(0x118)][_0x39c43f(0x134)](_0x9c52e5,_0x5b42c4);}static async[_0x53bf98(0x138)](_0x456970){const _0x331c7b=_0x53bf98;return await napCatCore[_0x331c7b(0x118)]['getFileSize'](_0x456970);}static async['uploadFile'](_0xc06c13,_0xb9d412=ElementType[_0x53bf98(0x14e)],_0x21befa=0x0){const _0x19daf2=_0x53bf98,_0x186874={'pzcWV':function(_0x24c668,_0x5aa855){return _0x24c668(_0x5aa855);},'nHCSy':function(_0x5e65a2,_0x5745e8){return _0x5e65a2===_0x5745e8;}},_0x5634d6=await _0x186874[_0x19daf2(0x11d)](calculateFileMD5,_0xc06c13);let _0x3878e0=(await NTQQFileApi['getFileType'](_0xc06c13))?.['ext']||'';_0x3878e0&&(_0x3878e0='.'+_0x3878e0);let _0x585767=''+_0x34d15a['basename'](_0xc06c13);_0x186874[_0x19daf2(0x10a)](_0x585767['indexOf']('.'),-0x1)&&(_0x585767+=_0x3878e0);const _0x4507f2=napCatCore[_0x19daf2(0x10b)][_0x19daf2(0x147)]()[_0x19daf2(0x125)]({'md5HexStr':_0x5634d6,'fileName':_0x585767,'elementType':_0xb9d412,'elementSubType':_0x21befa,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0xc06c13,_0x4507f2);const _0x54a0fb=await NTQQFileApi[_0x19daf2(0x138)](_0xc06c13);return{'md5':_0x5634d6,'fileName':_0x585767,'path':_0x4507f2,'fileSize':_0x54a0fb,'ext':_0x3878e0};}static async[_0x53bf98(0x13b)](_0x8b3e7f,_0x88638c,_0x3c7515,_0x4df3cf,_0x47be7b,_0x27527c,_0x53824a=0x3e8*0x3c*0x2,_0x45fb6a=![]){const _0x13a0dd=_0x53bf98,_0x5f5c04={'mtkvv':function(_0x3e43f7,_0x25c411,_0x497bb3,_0x20fc60){return _0x3e43f7(_0x25c411,_0x497bb3,_0x20fc60);},'pKITC':function(_0xe0ab72,_0x28d874){return _0xe0ab72===_0x28d874;},'ZHMPS':function(_0xc0aec0,_0x4b50ad,_0x45a247){return _0xc0aec0(_0x4b50ad,_0x45a247);},'GwXeS':'downloadPath','chpKf':function(_0x515ace,_0x14cb26){return _0x515ace(_0x14cb26);},'UpdDj':_0x13a0dd(0x131),'aWMNW':function(_0x1bf8c3){return _0x1bf8c3();},'bJupT':function(_0x4226e2,_0x25662e,_0x5cfe4b){return _0x4226e2(_0x25662e,_0x5cfe4b);},'farJf':function(_0x1a9bb4,_0x40792a,_0x13eb47,_0x4faa40,_0x5aaebe,_0x371f6e,_0x524335,_0x384b96,_0x4e27ee,_0x4989af){return _0x1a9bb4(_0x40792a,_0x13eb47,_0x4faa40,_0x5aaebe,_0x371f6e,_0x524335,_0x384b96,_0x4e27ee,_0x4989af);},'ZojWW':_0x13a0dd(0x128)};_0x5f5c04[_0x13a0dd(0x11b)](logDebug,_0x13a0dd(0x12a),_0x8b3e7f,_0x88638c,_0x3c7515,_0x4df3cf,_0x47be7b,_0x27527c,_0x53824a,_0x45fb6a);if(_0x27527c&&_0x2eae9a[_0x13a0dd(0x151)](_0x27527c)){if(_0x45fb6a)try{await _0x5f0d6b['unlink'](_0x27527c);}catch(_0x4c38c5){}else return _0x27527c;}return _0x5f5c04[_0x13a0dd(0x11b)](logDebug,_0x5f5c04[_0x13a0dd(0x105)],_0x8b3e7f,_0x88638c,_0x3c7515,_0x4df3cf,_0x47be7b,_0x27527c,_0x53824a,_0x45fb6a),new Promise((_0x3b3cde,_0xade860)=>{const _0x5ad7d1=_0x13a0dd,_0x2b130a={'dsvLn':function(_0x1377f5,_0x1286cb){const _0xa091d5=_0x48b9;return _0x5f5c04[_0xa091d5(0x13f)](_0x1377f5,_0x1286cb);},'zjLGv':_0x5f5c04[_0x5ad7d1(0x117)]};let _0x4ed57e=![];const _0x272ac6=_0x52ec45=>{const _0x46e985=_0x5ad7d1;_0x5f5c04[_0x46e985(0x13e)](logDebug,_0x46e985(0x14b),_0x52ec45,_0x8b3e7f);if(_0x5f5c04[_0x46e985(0x13d)](_0x52ec45[_0x46e985(0x139)],_0x8b3e7f)){_0x4ed57e=!![];let _0x1c0bf8=_0x52ec45[_0x46e985(0x141)];if(_0x1c0bf8[_0x46e985(0x12d)]('\x5c')){const _0x3dcf36=sessionConfig[_0x46e985(0x153)];_0x5f5c04[_0x46e985(0x109)](logDebug,_0x5f5c04[_0x46e985(0x148)],_0x3dcf36),_0x1c0bf8=_0x34d15a['join'](_0x3dcf36,_0x1c0bf8);}_0x5f5c04[_0x46e985(0x13f)](_0x3b3cde,_0x1c0bf8);}};downloadMediaTasks[_0x5ad7d1(0x10d)](_0x5f5c04['aWMNW'](randomUUID),_0x272ac6),_0x5f5c04[_0x5ad7d1(0x144)](setTimeout,()=>{const _0x2b1b09=_0x5ad7d1;!_0x4ed57e&&_0x2b130a[_0x2b1b09(0x107)](_0xade860,_0x2b130a[_0x2b1b09(0x127)]);},_0x53824a),napCatCore[_0x5ad7d1(0x10b)]['getMsgService']()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x8b3e7f,'chatType':_0x88638c,'peerUid':_0x3c7515,'elementId':_0x4df3cf,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x47be7b});});}static async[_0x53bf98(0x111)](_0x30b408){const _0x14540b={'EUOUs':function(_0xcadd34,_0x28b649){return _0xcadd34(_0x28b649);}};return new Promise((_0xbb4405,_0x19f662)=>{const _0x5a861d={'zYPcX':function(_0x13d268,_0x15f3d5){return _0x14540b['EUOUs'](_0x13d268,_0x15f3d5);}};_0x5088b3(_0x30b408,(_0x1a7764,_0x4991bc)=>{const _0x199912=_0x48b9;_0x1a7764?_0x19f662(_0x1a7764):_0x5a861d[_0x199912(0x12b)](_0xbb4405,_0x4991bc);});});}static async['getImageUrl'](_0x1750c3,_0x172f6a){const _0x2c4f7f=_0x53bf98,_0x57ea84={'nupUx':_0x2c4f7f(0x124),'tAbwP':function(_0x2cf9cb,_0x477735){return _0x2cf9cb+_0x477735;},'SAMoP':function(_0x43a974,_0x1c9803){return _0x43a974+_0x1c9803;},'CNCSb':function(_0x4baa3a,_0x1fbc78){return _0x4baa3a+_0x1fbc78;},'kGxlc':function(_0x4deb47,_0x1eac39){return _0x4deb47||_0x1eac39;},'FEmLm':function(_0x520616,_0x4aa1d8){return _0x520616||_0x4aa1d8;},'BtCXg':function(_0x300861,_0x37ff78,_0x4235ad){return _0x300861(_0x37ff78,_0x4235ad);},'XaCiU':_0x2c4f7f(0x11a)};if(!_0x1750c3)return'';const _0x2fc877=_0x1750c3['originImageUrl'],_0x43fb4e=_0x1750c3[_0x2c4f7f(0x137)],_0x3e2384=_0x1750c3[_0x2c4f7f(0x137)],_0x8c9b45=_0x1750c3[_0x2c4f7f(0x112)];if(_0x2fc877){if(_0x2fc877[_0x2c4f7f(0x12d)](_0x2c4f7f(0x10e))){if(_0x2fc877['includes'](_0x57ea84['nupUx']))return _0x57ea84[_0x2c4f7f(0x11f)](IMAGE_HTTP_HOST_NT,_0x2fc877);const _0x3bf842=await rkeyManager[_0x2c4f7f(0x106)](),_0x486e85=_0x172f6a?_0x3bf842[_0x2c4f7f(0x135)]:_0x3bf842[_0x2c4f7f(0x145)];return _0x57ea84['tAbwP'](_0x57ea84[_0x2c4f7f(0x14c)](IMAGE_HTTP_HOST_NT,_0x2fc877),''+_0x486e85);}else return _0x57ea84[_0x2c4f7f(0x143)](IMAGE_HTTP_HOST,_0x2fc877);}else{if(_0x57ea84[_0x2c4f7f(0x129)](_0x3e2384,_0x43fb4e))return IMAGE_HTTP_HOST+_0x2c4f7f(0x120)+_0x57ea84[_0x2c4f7f(0x150)](_0x3e2384,_0x43fb4e)[_0x2c4f7f(0x114)]()+'/0';}return _0x57ea84[_0x2c4f7f(0x12f)](logDebug,_0x57ea84[_0x2c4f7f(0x146)],_0x1750c3),'';}}export class NTQQFileCacheApi{static async[_0x53bf98(0x113)](_0x1b1f5b=!![]){return'';}static['getCacheSessionPathList'](){return'';}static['clearCache'](_0x1e6583=[_0x53bf98(0x10f),_0x53bf98(0x132)]){const _0x4e63c9=_0x53bf98;return napCatCore['session'][_0x4e63c9(0x11e)]()[_0x4e63c9(0x14d)](_0x1e6583);}static[_0x53bf98(0x11c)](_0x560c0c={}){const _0xc5be7=_0x53bf98;return napCatCore[_0xc5be7(0x10b)]['getStorageCleanService']()[_0xc5be7(0x14a)](_0x560c0c);}static[_0x53bf98(0x152)](){const _0x356b83=_0x53bf98;return napCatCore[_0x356b83(0x10b)][_0x356b83(0x11e)]()[_0x356b83(0x152)]();}static[_0x53bf98(0x10c)](){return'';}static[_0x53bf98(0x123)](){return'';}static[_0x53bf98(0x126)](_0x2781ce,_0x69ab35=0x3e8,_0x251afc=0x0){const _0x3ee77f=_0x53bf98;return napCatCore[_0x3ee77f(0x10b)][_0x3ee77f(0x11e)]()[_0x3ee77f(0x136)](_0x2781ce,_0x69ab35,0x1,_0x251afc);}static[_0x53bf98(0x12e)](_0x5b01a4,_0x2c3ea1=0x3e8,_0x22d792){const _0x58f003=_0x22d792?_0x22d792:{'fileType':_0x5b01a4};}static async[_0x53bf98(0x110)](_0x3f2422=[],_0x43edb7=[]){const _0x19be36=_0x53bf98;return napCatCore[_0x19be36(0x10b)][_0x19be36(0x11e)]()['clearChatCacheInfo'](_0x3f2422,_0x43edb7);}}