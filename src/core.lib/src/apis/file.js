const _0x382dbd=_0x1eae;(function(_0x223dcd,_0x24dcc8){const _0x6084b=_0x1eae,_0x2c54b9=_0x223dcd();while(!![]){try{const _0x52e920=-parseInt(_0x6084b(0xde))/0x1+-parseInt(_0x6084b(0x110))/0x2*(parseInt(_0x6084b(0x11e))/0x3)+parseInt(_0x6084b(0xdc))/0x4+-parseInt(_0x6084b(0xed))/0x5*(-parseInt(_0x6084b(0xe6))/0x6)+parseInt(_0x6084b(0xf1))/0x7*(parseInt(_0x6084b(0xfc))/0x8)+-parseInt(_0x6084b(0xe2))/0x9+parseInt(_0x6084b(0xea))/0xa*(parseInt(_0x6084b(0xdf))/0xb);if(_0x52e920===_0x24dcc8)break;else _0x2c54b9['push'](_0x2c54b9['shift']());}catch(_0x26ec9b){_0x2c54b9['push'](_0x2c54b9['shift']());}}}(_0x2d6c,0x4aa99));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x2d6c(){const _0x3676f9=['clearChatCacheInfo','getImageUrl','indexOf','图片url获取失败','66018aipjEB','ext','util','qCPpj','horwe','originImageUrl','fileTypeFromFile','addCacheScanedPaths','WcJCW','copyFile','PIC','getDesktopTmpPath','getFileType','md5HexStr','54xJTkyi','private_rkey','eaUJh','uploadFile','1736004NSHMfF','/gchatpic_new/0/0-0-','547429ezWqej','11308xuBmEP','addCacheScannedPaths','getFileSize','4968657hPZAGI','tmp','zwMfb','getStorageCleanService','19698hYCYtM','mPQIg','filePath','clearCache','8540AQlrrg','basename','DXMvw','845tQuoBg','&rkey=','clearChatCache','setCacheSilentScan','301VKLzUU','getRkey','join','defaultFileDownloadPath','getImageSize','set','RQAjn','QWkAG','downloadRichMedia','fileUuid','getChatCacheList','24696lqRltO','includes','toUpperCase','addListener','session','delete','startsWith','getHotUpdateCachePath','getRichMediaFilePathForGuild','lwUeD','getCacheSessionPathList','/download','scanCache','OIIIR','QkJag','hotUpdate'];_0x2d6c=function(){return _0x3676f9;};return _0x2d6c();}import _0x5d28e4 from'path';import _0x3c762f from'fs';import _0x1950a5 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x4e0ff from'file-type';import{MsgListener}from'@/core/listeners';import _0x10df56 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x1eae(_0x36f998,_0x56cd42){const _0x2d6c34=_0x2d6c();return _0x1eae=function(_0x1eae9f,_0x46028b){_0x1eae9f=_0x1eae9f-0xda;let _0x125cbf=_0x2d6c34[_0x1eae9f];return _0x125cbf;},_0x1eae(_0x36f998,_0x56cd42);}const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x350c21=>{const _0x3147bc=_0x1eae,_0x17c6c7={'HXoUd':function(_0x55116,_0x2b8b69){return _0x55116(_0x2b8b69);}};for(const [_0x2e65ef,_0x52b334]of downloadMediaTasks){_0x17c6c7['HXoUd'](_0x52b334,_0x350c21),downloadMediaTasks[_0x3147bc(0x101)](_0x2e65ef);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x409477=_0x1eae;napCatCore[_0x409477(0xff)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x382dbd(0x11c)](_0x1527e8){const _0x56a713=_0x382dbd;return _0x4e0ff[_0x56a713(0x116)](_0x1527e8);}static async[_0x382dbd(0x119)](_0x425be2,_0xf75185){const _0x3566bb=_0x382dbd;await napCatCore[_0x3566bb(0x112)][_0x3566bb(0x119)](_0x425be2,_0xf75185);}static async[_0x382dbd(0xe1)](_0x38c7fc){const _0x4d7bba=_0x382dbd;return await napCatCore['util'][_0x4d7bba(0xe1)](_0x38c7fc);}static async[_0x382dbd(0xdb)](_0x535a35,_0x1e7318=ElementType[_0x382dbd(0x11a)],_0x4486b5=0x0){const _0x337548=_0x382dbd,_0x381fed={'jpxUt':function(_0x524810,_0x34a60b){return _0x524810(_0x34a60b);},'iarze':function(_0x2d45b1,_0x1dbc76){return _0x2d45b1+_0x1dbc76;}},_0x3abf2a=await _0x381fed['jpxUt'](calculateFileMD5,_0x535a35);let _0x227004=(await NTQQFileApi['getFileType'](_0x535a35))?.[_0x337548(0x111)]||'';_0x227004&&(_0x227004=_0x381fed['iarze']('.',_0x227004));let _0x5d8819=''+_0x5d28e4[_0x337548(0xeb)](_0x535a35);_0x5d8819[_0x337548(0x10e)]('.')===-0x1&&(_0x5d8819+=_0x227004);const _0x268926=napCatCore['session']['getMsgService']()[_0x337548(0x104)]({'md5HexStr':_0x3abf2a,'fileName':_0x5d8819,'elementType':_0x1e7318,'elementSubType':_0x4486b5,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x535a35,_0x268926);const _0x11c30f=await NTQQFileApi[_0x337548(0xe1)](_0x535a35);return{'md5':_0x3abf2a,'fileName':_0x5d8819,'path':_0x268926,'fileSize':_0x11c30f,'ext':_0x227004};}static async['downloadMedia'](_0x12c6b4,_0x34422c,_0x224058,_0x41ae43,_0x4728c1,_0x2ffdea,_0x16cccf=0x3e8*0x3c*0x2,_0x2bb33c=![]){const _0x465da1={'NtRYT':function(_0x3e03e8,_0x1ba109){return _0x3e03e8===_0x1ba109;},'horwe':function(_0x481fdd,_0x57bf17){return _0x481fdd(_0x57bf17);},'lwUeD':function(_0x2170d0,_0x378e32){return _0x2170d0(_0x378e32);},'mPQIg':'下载超时','DXMvw':function(_0x107431){return _0x107431();},'WcJCW':function(_0x43767e,_0x4acf83,_0x26a1aa){return _0x43767e(_0x4acf83,_0x26a1aa);}};if(_0x2ffdea&&_0x3c762f['existsSync'](_0x2ffdea)){if(_0x2bb33c)try{await _0x1950a5['unlink'](_0x2ffdea);}catch(_0x42f4cb){}else return _0x2ffdea;}return new Promise((_0x4b0f60,_0x278100)=>{const _0x20572e=_0x1eae;let _0x4600fd=![];const _0x426088=_0x1b1885=>{const _0x1e65e2=_0x1eae;if(_0x465da1['NtRYT'](_0x1b1885['msgId'],_0x12c6b4)){_0x4600fd=!![];let _0x35a2ad=_0x1b1885[_0x1e65e2(0xe8)];if(_0x35a2ad[_0x1e65e2(0x102)]('\x5c')){const _0x38a06a=sessionConfig[_0x1e65e2(0xf4)];_0x35a2ad=_0x5d28e4[_0x1e65e2(0xf3)](_0x38a06a,_0x35a2ad);}_0x465da1[_0x1e65e2(0x114)](_0x4b0f60,_0x35a2ad);}};downloadMediaTasks[_0x20572e(0xf6)](_0x465da1[_0x20572e(0xec)](randomUUID),_0x426088),_0x465da1[_0x20572e(0x118)](setTimeout,()=>{const _0x245104=_0x20572e;!_0x4600fd&&_0x465da1[_0x245104(0x105)](_0x278100,_0x465da1[_0x245104(0xe7)]);},_0x16cccf),napCatCore['session']['getMsgService']()[_0x20572e(0xf9)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x12c6b4,'chatType':_0x34422c,'peerUid':_0x224058,'elementId':_0x41ae43,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4728c1});});}static async[_0x382dbd(0xf5)](_0x576dab){const _0x5dee74={'OIIIR':function(_0x1810c8,_0x1401e0){return _0x1810c8(_0x1401e0);},'RQAjn':function(_0x104da7,_0x284736,_0x381476){return _0x104da7(_0x284736,_0x381476);}};return new Promise((_0x17a5a7,_0x5ec162)=>{const _0x4253f5=_0x1eae;_0x5dee74[_0x4253f5(0xf7)](_0x10df56,_0x576dab,(_0x39bc74,_0x5bdc28)=>{const _0x52a096=_0x4253f5;_0x39bc74?_0x5dee74[_0x52a096(0x109)](_0x5ec162,_0x39bc74):_0x5dee74[_0x52a096(0x109)](_0x17a5a7,_0x5bdc28);});});}static async[_0x382dbd(0x10d)](_0x2074ba,_0x11ec40){const _0x554ba6=_0x382dbd,_0x466391={'QWkAG':_0x554ba6(0x107),'qCPpj':_0x554ba6(0xee),'zwMfb':function(_0xeb5fc0,_0x3aef44){return _0xeb5fc0+_0x3aef44;},'eaUJh':function(_0x41bbeb,_0x4ddf9e){return _0x41bbeb+_0x4ddf9e;},'hFoOV':function(_0x303111,_0xda928){return _0x303111||_0xda928;},'QkJag':function(_0x358ffa,_0x443b78,_0x966a){return _0x358ffa(_0x443b78,_0x966a);}};if(!_0x2074ba)return'';const _0x39faff=_0x2074ba[_0x554ba6(0x115)],_0x117db9=_0x2074ba[_0x554ba6(0x11d)],_0x2d277b=_0x2074ba[_0x554ba6(0x11d)],_0x37c4f6=_0x2074ba[_0x554ba6(0xfa)];if(_0x39faff){if(_0x39faff[_0x554ba6(0x102)](_0x466391[_0x554ba6(0xf8)])){if(_0x39faff[_0x554ba6(0xfd)](_0x466391[_0x554ba6(0x113)]))return _0x466391[_0x554ba6(0xe4)](IMAGE_HTTP_HOST_NT,_0x39faff);const _0x4fd705=await rkeyManager[_0x554ba6(0xf2)](),_0x2c1320=_0x11ec40?_0x4fd705[_0x554ba6(0x11f)]:_0x4fd705['group_rkey'];return IMAGE_HTTP_HOST_NT+_0x39faff+(''+_0x2c1320);}else return _0x466391[_0x554ba6(0xda)](IMAGE_HTTP_HOST,_0x39faff);}else{if(_0x2d277b||_0x117db9)return IMAGE_HTTP_HOST+_0x554ba6(0xdd)+_0x466391['hFoOV'](_0x2d277b,_0x117db9)[_0x554ba6(0xfe)]()+'/0';}return _0x466391[_0x554ba6(0x10a)](logDebug,_0x554ba6(0x10f),_0x2074ba),'';}}export class NTQQFileCacheApi{static async[_0x382dbd(0xf0)](_0x557a6c=!![]){return'';}static[_0x382dbd(0x106)](){return'';}static[_0x382dbd(0xe9)](_0x16de93=[_0x382dbd(0xe3),_0x382dbd(0x10b)]){const _0x2fe4ea=_0x382dbd;return napCatCore[_0x2fe4ea(0x100)][_0x2fe4ea(0xe5)]()['clearCacheDataByKeys'](_0x16de93);}static[_0x382dbd(0xe0)](_0x21f8ab={}){const _0x4d128d=_0x382dbd;return napCatCore[_0x4d128d(0x100)]['getStorageCleanService']()[_0x4d128d(0x117)](_0x21f8ab);}static[_0x382dbd(0x108)](){const _0x49dfc3=_0x382dbd;return napCatCore[_0x49dfc3(0x100)][_0x49dfc3(0xe5)]()[_0x49dfc3(0x108)]();}static[_0x382dbd(0x103)](){return'';}static[_0x382dbd(0x11b)](){return'';}static[_0x382dbd(0xfb)](_0x435831,_0x1b5fa9=0x3e8,_0x373f39=0x0){const _0x517c87=_0x382dbd;return napCatCore[_0x517c87(0x100)][_0x517c87(0xe5)]()['getChatCacheInfo'](_0x435831,_0x1b5fa9,0x1,_0x373f39);}static['getFileCacheInfo'](_0x26e5e4,_0x4ff271=0x3e8,_0x48436b){const _0xecac10=_0x48436b?_0x48436b:{'fileType':_0x26e5e4};}static async[_0x382dbd(0xef)](_0x746b74=[],_0xe05fb0=[]){const _0x361633=_0x382dbd;return napCatCore[_0x361633(0x100)][_0x361633(0xe5)]()[_0x361633(0x10c)](_0x746b74,_0xe05fb0);}}