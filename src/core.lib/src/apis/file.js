const _0x5f31e8=_0x2945;(function(_0x24a8a0,_0x4f1a6c){const _0x40c1cc=_0x2945,_0x490a69=_0x24a8a0();while(!![]){try{const _0x27e068=parseInt(_0x40c1cc(0x1af))/0x1*(-parseInt(_0x40c1cc(0x1ba))/0x2)+-parseInt(_0x40c1cc(0x1b4))/0x3+parseInt(_0x40c1cc(0x1cc))/0x4+-parseInt(_0x40c1cc(0x1dd))/0x5*(parseInt(_0x40c1cc(0x1d1))/0x6)+-parseInt(_0x40c1cc(0x1d0))/0x7+-parseInt(_0x40c1cc(0x1e4))/0x8+parseInt(_0x40c1cc(0x1ea))/0x9;if(_0x27e068===_0x4f1a6c)break;else _0x490a69['push'](_0x490a69['shift']());}catch(_0x2d3368){_0x490a69['push'](_0x490a69['shift']());}}}(_0x3dfe,0x51180));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x47d357 from'path';function _0x3dfe(){const _0x5f198b=['uploadFile','copyFile','chatType','getRkey','clearChatCache','getFileSize','getFileType','PIC','addListener','256671ziyKsl','UlMnQ','clearCache','onRichMediaDownloadComplete','teZsq','937461MJFlot','getDesktopTmpPath','getImageUrl','startsWith','&rkey=','owrHO','4DZhiPP','getHotUpdateCachePath','join','图片url获取失败','getFileCacheInfo','qRRML','defaultFileDownloadPath','EfLPL','urlResult','scanCache','tmp','setCacheSilentScan','basename','toUpperCase','hotUpdate','XmMLG','filePath','onLoginSuccess','91108MVsNfw','addCacheScanedPaths','getStorageCleanService','XPIUW','2568279AtsHLl','222WejWNK','clearChatCacheInfo','indexOf','getImageSize','includes','domainUrl','downloadRichMedia','getChatCacheInfo','下载超时','ATxLr','util','existsSync','70855yILHFK','session','getChatCacheList','private_rkey','/download','delete','getMsgService','2541656gDssQL','url','getRichMediaService','msgId','group_rkey','zCwbJ','21097287mCrDqF','md5HexStr','GUsmd','getCacheSessionPathList','CoVUC'];_0x3dfe=function(){return _0x5f198b;};return _0x3dfe();}import _0x4a9276 from'fs';import _0x183612 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x3eacab from'file-type';import{MsgListener}from'@/core/listeners';import _0x573164 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x2945(_0x4b1964,_0x39e938){const _0x3dfe97=_0x3dfe();return _0x2945=function(_0x29456a,_0x4986fd){_0x29456a=_0x29456a-0x1a4;let _0x33de03=_0x3dfe97[_0x29456a];return _0x33de03;},_0x2945(_0x4b1964,_0x39e938);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x5f31e8(0x1b2)]=_0x4fd112=>{const _0xb5d384=_0x5f31e8;for(const [_0x75bdc8,_0x1f0142]of downloadMediaTasks){_0x1f0142(_0x4fd112),downloadMediaTasks[_0xb5d384(0x1e2)](_0x75bdc8);}},setTimeout(()=>{const _0x20fccc=_0x5f31e8;napCatCore[_0x20fccc(0x1cb)](()=>{const _0x6f7c16=_0x20fccc;napCatCore[_0x6f7c16(0x1ae)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x5f31e8(0x1ac)](_0x4e27dd){return _0x3eacab['fileTypeFromFile'](_0x4e27dd);}static async[_0x5f31e8(0x1a7)](_0x25965d,_0xab7a20){const _0x3c0b1d=_0x5f31e8;await napCatCore[_0x3c0b1d(0x1db)]['copyFile'](_0x25965d,_0xab7a20);}static async[_0x5f31e8(0x1ab)](_0x52099a){const _0x870713=_0x5f31e8;return await napCatCore['util'][_0x870713(0x1ab)](_0x52099a);}static async['getVideoUrl'](_0x438231,_0x57db59){const _0x75e63e=_0x5f31e8;return(await napCatCore[_0x75e63e(0x1de)][_0x75e63e(0x1e6)]()['getVideoPlayUrlV2']({'chatType':_0x438231[_0x75e63e(0x1a8)],'peerUid':_0x438231['peerUid'],'guildId':'0'},_0x438231[_0x75e63e(0x1e7)],_0x57db59['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x75e63e(0x1c2)][_0x75e63e(0x1d6)][0x0][_0x75e63e(0x1e5)];}static async[_0x5f31e8(0x1a6)](_0x379023,_0x4c2130=ElementType[_0x5f31e8(0x1ad)],_0x30d6ed=0x0){const _0x1b7bf4=_0x5f31e8,_0xb54f55={'EfLPL':function(_0x3cdbe5,_0x48709d){return _0x3cdbe5(_0x48709d);},'UlMnQ':function(_0x349604,_0x113145){return _0x349604+_0x113145;},'GUsmd':function(_0x2fd0d5,_0x425e1e){return _0x2fd0d5===_0x425e1e;}},_0x3cabd7=await _0xb54f55[_0x1b7bf4(0x1c1)](calculateFileMD5,_0x379023);let _0x13682e=(await NTQQFileApi[_0x1b7bf4(0x1ac)](_0x379023))?.['ext']||'';_0x13682e&&(_0x13682e=_0xb54f55[_0x1b7bf4(0x1b0)]('.',_0x13682e));let _0xd7dd55=''+_0x47d357[_0x1b7bf4(0x1c6)](_0x379023);_0xb54f55[_0x1b7bf4(0x1ec)](_0xd7dd55[_0x1b7bf4(0x1d3)]('.'),-0x1)&&(_0xd7dd55+=_0x13682e);const _0x2bc320=napCatCore[_0x1b7bf4(0x1de)][_0x1b7bf4(0x1e3)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x3cabd7,'fileName':_0xd7dd55,'elementType':_0x4c2130,'elementSubType':_0x30d6ed,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x379023,_0x2bc320);const _0xf8ba39=await NTQQFileApi[_0x1b7bf4(0x1ab)](_0x379023);return{'md5':_0x3cabd7,'fileName':_0xd7dd55,'path':_0x2bc320,'fileSize':_0xf8ba39,'ext':_0x13682e};}static async['downloadMedia'](_0x4cdcf3,_0x2d3098,_0x2a0351,_0x1f1eb7,_0x1ba077,_0x284986,_0x1a6344=0x3e8*0x3c*0x2,_0x312c5b=![]){const _0x4cacb4=_0x5f31e8,_0x52cbeb={'kXagC':function(_0xfb917f,_0xe7c579){return _0xfb917f===_0xe7c579;},'owrHO':function(_0x30b4a3){return _0x30b4a3();},'XPIUW':function(_0x4c6e14,_0x512b67,_0xc4729f){return _0x4c6e14(_0x512b67,_0xc4729f);}};if(_0x284986&&_0x4a9276[_0x4cacb4(0x1dc)](_0x284986)){if(_0x312c5b)try{await _0x183612['unlink'](_0x284986);}catch(_0x22c16f){}else return _0x284986;}return new Promise((_0x3d2e1a,_0x1c5121)=>{const _0x104428=_0x4cacb4,_0xa5c5a2={'aeHjH':function(_0x16e14e,_0xe8970d){return _0x52cbeb['kXagC'](_0x16e14e,_0xe8970d);},'hmQxu':function(_0x460b6f,_0x420ed9){return _0x460b6f(_0x420ed9);},'zCwbJ':_0x104428(0x1d9)};let _0x5420e3=![];const _0x2c5a3b=_0x28212f=>{const _0x5a849c=_0x104428;if(_0xa5c5a2['aeHjH'](_0x28212f['msgId'],_0x4cdcf3)){_0x5420e3=!![];let _0x55dc87=_0x28212f[_0x5a849c(0x1ca)];if(_0x55dc87['startsWith']('\x5c')){const _0x2a9027=sessionConfig[_0x5a849c(0x1c0)];_0x55dc87=_0x47d357[_0x5a849c(0x1bc)](_0x2a9027,_0x55dc87);}_0xa5c5a2['hmQxu'](_0x3d2e1a,_0x55dc87);}};downloadMediaTasks['set'](_0x52cbeb[_0x104428(0x1b9)](randomUUID),_0x2c5a3b),_0x52cbeb[_0x104428(0x1cf)](setTimeout,()=>{const _0x5e6545=_0x104428;!_0x5420e3&&_0x1c5121(_0xa5c5a2[_0x5e6545(0x1e9)]);},_0x1a6344),napCatCore[_0x104428(0x1de)]['getMsgService']()[_0x104428(0x1d7)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x4cdcf3,'chatType':_0x2d3098,'peerUid':_0x2a0351,'elementId':_0x1f1eb7,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1ba077});});}static async[_0x5f31e8(0x1d4)](_0x327aab){const _0x51ba4c={'aibPD':function(_0x23c199,_0x2381e5){return _0x23c199(_0x2381e5);},'JcwDd':function(_0x19fb55,_0x5cc9f7,_0x442637){return _0x19fb55(_0x5cc9f7,_0x442637);}};return new Promise((_0x34d1f1,_0x4ab2ce)=>{_0x51ba4c['JcwDd'](_0x573164,_0x327aab,(_0x123503,_0xc66f82)=>{_0x123503?_0x51ba4c['aibPD'](_0x4ab2ce,_0x123503):_0x51ba4c['aibPD'](_0x34d1f1,_0xc66f82);});});}static async[_0x5f31e8(0x1b6)](_0x54290a,_0x4fc595){const _0x4ddbf4=_0x5f31e8,_0x16a3d0={'XmMLG':_0x4ddbf4(0x1e1),'ATxLr':function(_0x3ccb92,_0x22fe29){return _0x3ccb92+_0x22fe29;},'CoVUC':function(_0x2bda60,_0xf77fa8){return _0x2bda60+_0xf77fa8;},'teZsq':function(_0x1b91dd,_0x4194a5){return _0x1b91dd||_0x4194a5;},'uozKF':function(_0x27c7a3,_0x1bfea8,_0x571cfd){return _0x27c7a3(_0x1bfea8,_0x571cfd);},'qRRML':_0x4ddbf4(0x1bd)};if(!_0x54290a)return'';const _0x332f41=_0x54290a['originImageUrl'],_0x403c3c=_0x54290a[_0x4ddbf4(0x1eb)],_0x5c4278=_0x54290a[_0x4ddbf4(0x1eb)],_0x56df5c=_0x54290a['fileUuid'];if(_0x332f41){if(_0x332f41[_0x4ddbf4(0x1b7)](_0x16a3d0[_0x4ddbf4(0x1c9)])){if(_0x332f41[_0x4ddbf4(0x1d5)](_0x4ddbf4(0x1b8)))return IMAGE_HTTP_HOST_NT+_0x332f41;const _0x3a2f08=await rkeyManager[_0x4ddbf4(0x1a9)](),_0x51e676=_0x4fc595?_0x3a2f08[_0x4ddbf4(0x1e0)]:_0x3a2f08[_0x4ddbf4(0x1e8)];return _0x16a3d0[_0x4ddbf4(0x1da)](_0x16a3d0[_0x4ddbf4(0x1a5)](IMAGE_HTTP_HOST_NT,_0x332f41),''+_0x51e676);}else return IMAGE_HTTP_HOST+_0x332f41;}else{if(_0x16a3d0[_0x4ddbf4(0x1b3)](_0x5c4278,_0x403c3c))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x16a3d0['teZsq'](_0x5c4278,_0x403c3c)[_0x4ddbf4(0x1c7)]()+'/0';}return _0x16a3d0['uozKF'](logDebug,_0x16a3d0[_0x4ddbf4(0x1bf)],_0x54290a),'';}}export class NTQQFileCacheApi{static async[_0x5f31e8(0x1c5)](_0x5b7614=!![]){return'';}static[_0x5f31e8(0x1a4)](){return'';}static[_0x5f31e8(0x1b1)](_0x376088=[_0x5f31e8(0x1c4),_0x5f31e8(0x1c8)]){const _0x2cc35d=_0x5f31e8;return napCatCore['session'][_0x2cc35d(0x1ce)]()['clearCacheDataByKeys'](_0x376088);}static['addCacheScannedPaths'](_0x1d2334={}){const _0x3088cf=_0x5f31e8;return napCatCore[_0x3088cf(0x1de)][_0x3088cf(0x1ce)]()[_0x3088cf(0x1cd)](_0x1d2334);}static['scanCache'](){const _0x3d5565=_0x5f31e8;return napCatCore['session'][_0x3d5565(0x1ce)]()[_0x3d5565(0x1c3)]();}static[_0x5f31e8(0x1bb)](){return'';}static[_0x5f31e8(0x1b5)](){return'';}static[_0x5f31e8(0x1df)](_0xcd4fc1,_0x457aa6=0x3e8,_0x3a6c7b=0x0){const _0x3f4f7f=_0x5f31e8;return napCatCore[_0x3f4f7f(0x1de)]['getStorageCleanService']()[_0x3f4f7f(0x1d8)](_0xcd4fc1,_0x457aa6,0x1,_0x3a6c7b);}static[_0x5f31e8(0x1be)](_0x203d6b,_0x2c91b6=0x3e8,_0x4fc79a){const _0x34265b=_0x4fc79a?_0x4fc79a:{'fileType':_0x203d6b};}static async[_0x5f31e8(0x1aa)](_0x3d5f7c=[],_0x5e6a98=[]){const _0x52a826=_0x5f31e8;return napCatCore['session'][_0x52a826(0x1ce)]()[_0x52a826(0x1d2)](_0x3d5f7c,_0x5e6a98);}}