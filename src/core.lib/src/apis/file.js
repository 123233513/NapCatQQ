const _0x56e080=_0x1d7b;(function(_0x408399,_0x26f80d){const _0xc4a18a=_0x1d7b,_0x520ad8=_0x408399();while(!![]){try{const _0xd14ccb=parseInt(_0xc4a18a(0x120))/0x1+-parseInt(_0xc4a18a(0x110))/0x2*(parseInt(_0xc4a18a(0x102))/0x3)+parseInt(_0xc4a18a(0xf2))/0x4+parseInt(_0xc4a18a(0x135))/0x5*(-parseInt(_0xc4a18a(0x106))/0x6)+-parseInt(_0xc4a18a(0x137))/0x7*(parseInt(_0xc4a18a(0xee))/0x8)+-parseInt(_0xc4a18a(0x136))/0x9*(parseInt(_0xc4a18a(0x113))/0xa)+-parseInt(_0xc4a18a(0x10a))/0xb*(-parseInt(_0xc4a18a(0xfd))/0xc);if(_0xd14ccb===_0x26f80d)break;else _0x520ad8['push'](_0x520ad8['shift']());}catch(_0x3efebf){_0x520ad8['push'](_0x520ad8['shift']());}}}(_0x1712,0x2abee));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x11ce3f from'path';import _0x4e37dd from'fs';function _0x1d7b(_0xe4c278,_0x402c37){const _0x171203=_0x1712();return _0x1d7b=function(_0x1d7b08,_0x2f210a){_0x1d7b08=_0x1d7b08-0xe9;let _0x27b45c=_0x171203[_0x1d7b08];return _0x27b45c;},_0x1d7b(_0xe4c278,_0x402c37);}import _0x202f75 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x2f6c3e from'file-type';import{MsgListener}from'@/core/listeners';import _0x2d784c from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';function _0x1712(){const _0x51c942=['hotUpdate','GWGxu','downloadRichMedia','set','util','onLoginSuccess','fiNtG','getRichMediaFilePathForGuild','clearCacheDataByKeys','getFileCacheInfo','pNPcB','LZdwE','图片url获取失败','18904hCtUML','XDZBe','md5HexStr','downloadMedia','1393076VUzukb','copyFile','szaMH','addCacheScannedPaths','startsWith','group_rkey','getStorageCleanService','getHotUpdateCachePath','PIC','tmp','getRkey','3816bsUIBO','onRichMediaDownloadComplete','/gchatpic_new/0/0-0-','slzwG','jbKBh','21VyRrWU','getImageUrl','session','getChatCacheInfo','10350QfgAod','uploadFile','fileUuid','defaultFileDownloadPath','11143hsBtqy','ext','getFileType','LjprO','uIqpO','nazyL','71944KvFEvf','getImageSize','BhrsT','50dfqfgB','downloadPath','fileTypeFromFile','aggaR','oaBbW','includes','filePath','basename','下载超时','nJMgW','cFZrw','&rkey=','delete','315946FiotTK','Wneag','originImageUrl','scanCache','join','ZBqYJ','downloadMedia\x20complete','private_rkey','WBZtT','receive\x20downloadMedia\x20task','unlink','clearChatCacheInfo','yoIcB','/download','indexOf','getMsgService','QAmFE','toUpperCase','ZvzXb','getFileSize','XhDtV','865HIXqZK','31761qrWylX','721bEwIXD','clearCache','msgId'];_0x1712=function(){return _0x51c942;};return _0x1712();}import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x56e080(0xfe)]=_0x5b3aaf=>{const _0xdbbc96=_0x56e080;for(const [_0x3a71f0,_0x55f9a5]of downloadMediaTasks){_0x55f9a5(_0x5b3aaf),downloadMediaTasks[_0xdbbc96(0x11f)](_0x3a71f0);}},setTimeout(()=>{const _0x48ddd6=_0x56e080;napCatCore[_0x48ddd6(0x13f)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x56e080(0x10c)](_0x3a0b7d){const _0x1e5b4b=_0x56e080;return _0x2f6c3e[_0x1e5b4b(0x115)](_0x3a0b7d);}static async[_0x56e080(0xf3)](_0x24b426,_0x428aa0){const _0x278810=_0x56e080;await napCatCore['util'][_0x278810(0xf3)](_0x24b426,_0x428aa0);}static async[_0x56e080(0x133)](_0xdf93fc){const _0x22e783=_0x56e080;return await napCatCore[_0x22e783(0x13e)][_0x22e783(0x133)](_0xdf93fc);}static async[_0x56e080(0x107)](_0x3fdca9,_0x5ca4e6=ElementType[_0x56e080(0xfa)],_0x2a8c76=0x0){const _0x2827db=_0x56e080,_0x5d1eb5={'XhDtV':function(_0x2b82f8,_0x447ee1){return _0x2b82f8(_0x447ee1);},'LjprO':function(_0x4511b2,_0x4016bd){return _0x4511b2+_0x4016bd;},'XDZBe':function(_0x5be371,_0x2fc2d6){return _0x5be371===_0x2fc2d6;}},_0x5b5a82=await _0x5d1eb5[_0x2827db(0x134)](calculateFileMD5,_0x3fdca9);let _0x2d21f1=(await NTQQFileApi[_0x2827db(0x10c)](_0x3fdca9))?.[_0x2827db(0x10b)]||'';_0x2d21f1&&(_0x2d21f1=_0x5d1eb5[_0x2827db(0x10d)]('.',_0x2d21f1));let _0x38ce54=''+_0x11ce3f[_0x2827db(0x11a)](_0x3fdca9);_0x5d1eb5[_0x2827db(0xef)](_0x38ce54[_0x2827db(0x12e)]('.'),-0x1)&&(_0x38ce54+=_0x2d21f1);const _0x12cddc=napCatCore['session'][_0x2827db(0x12f)]()[_0x2827db(0x141)]({'md5HexStr':_0x5b5a82,'fileName':_0x38ce54,'elementType':_0x5ca4e6,'elementSubType':_0x2a8c76,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x2827db(0xf3)](_0x3fdca9,_0x12cddc);const _0x960dc3=await NTQQFileApi[_0x2827db(0x133)](_0x3fdca9);return{'md5':_0x5b5a82,'fileName':_0x38ce54,'path':_0x12cddc,'fileSize':_0x960dc3,'ext':_0x2d21f1};}static async[_0x56e080(0xf1)](_0x24291f,_0xb7f8c9,_0x699113,_0x14a0f5,_0x40aecb,_0x195bc4,_0x10b1f4=0x3e8*0x3c*0x2,_0x2ced63=![]){const _0x110fa2=_0x56e080,_0x4c84a0={'cFZrw':function(_0x54d28d,_0x3b6070,_0x2c93db,_0x1df284){return _0x54d28d(_0x3b6070,_0x2c93db,_0x1df284);},'szaMH':_0x110fa2(0x126),'Wneag':function(_0x34d68f,_0x222445){return _0x34d68f(_0x222445);},'BhrsT':function(_0x33d6dd,_0x503069){return _0x33d6dd(_0x503069);},'SQtOZ':_0x110fa2(0x11b),'nJMgW':function(_0x55cb32){return _0x55cb32();},'uIqpO':function(_0x5b279b,_0x29c876,_0x2311c8){return _0x5b279b(_0x29c876,_0x2311c8);},'jbKBh':function(_0x3f5181,_0x33e655,_0x9439b7,_0x56603d,_0x2f540c,_0x569743,_0xbf6c42,_0x157730,_0x488b8c,_0x40bec3){return _0x3f5181(_0x33e655,_0x9439b7,_0x56603d,_0x2f540c,_0x569743,_0xbf6c42,_0x157730,_0x488b8c,_0x40bec3);},'QAmFE':_0x110fa2(0x129),'hoDsU':'start\x20downloadMedia'};_0x4c84a0[_0x110fa2(0x101)](logDebug,_0x4c84a0[_0x110fa2(0x130)],_0x24291f,_0xb7f8c9,_0x699113,_0x14a0f5,_0x40aecb,_0x195bc4,_0x10b1f4,_0x2ced63);if(_0x195bc4&&_0x4e37dd['existsSync'](_0x195bc4)){if(_0x2ced63)try{await _0x202f75[_0x110fa2(0x12a)](_0x195bc4);}catch(_0x17a58f){}else return _0x195bc4;}return _0x4c84a0['jbKBh'](logDebug,_0x4c84a0['hoDsU'],_0x24291f,_0xb7f8c9,_0x699113,_0x14a0f5,_0x40aecb,_0x195bc4,_0x10b1f4,_0x2ced63),new Promise((_0x109c96,_0x328910)=>{const _0x342072=_0x110fa2,_0x2af77f={'LZdwE':function(_0x129580,_0x5c63fd,_0x27ce5d,_0x45939f){const _0x35be3e=_0x1d7b;return _0x4c84a0[_0x35be3e(0x11d)](_0x129580,_0x5c63fd,_0x27ce5d,_0x45939f);},'nazyL':_0x4c84a0[_0x342072(0xf4)],'aggaR':function(_0x30c1dd,_0x242c2e,_0x54af4f){return _0x30c1dd(_0x242c2e,_0x54af4f);},'GWGxu':function(_0x56b6cb,_0x3d7116){const _0x477751=_0x342072;return _0x4c84a0[_0x477751(0x121)](_0x56b6cb,_0x3d7116);},'slzwG':function(_0x3d2f61,_0x168d4c){const _0x3c0799=_0x342072;return _0x4c84a0[_0x3c0799(0x112)](_0x3d2f61,_0x168d4c);},'MzSPi':_0x4c84a0['SQtOZ']};let _0x1ba263=![];const _0x5dbfcf=_0x48cd1c=>{const _0x19a2ec=_0x342072;_0x2af77f[_0x19a2ec(0xec)](logDebug,_0x2af77f[_0x19a2ec(0x10f)],_0x48cd1c,_0x24291f);if(_0x48cd1c[_0x19a2ec(0x139)]===_0x24291f){_0x1ba263=!![];let _0x46aa66=_0x48cd1c[_0x19a2ec(0x119)];if(_0x46aa66[_0x19a2ec(0xf6)]('\x5c')){const _0x35f1aa=sessionConfig[_0x19a2ec(0x109)];_0x2af77f[_0x19a2ec(0x116)](logDebug,_0x19a2ec(0x114),_0x35f1aa),_0x46aa66=_0x11ce3f[_0x19a2ec(0x124)](_0x35f1aa,_0x46aa66);}_0x2af77f[_0x19a2ec(0x13b)](_0x109c96,_0x46aa66);}};downloadMediaTasks[_0x342072(0x13d)](_0x4c84a0[_0x342072(0x11c)](randomUUID),_0x5dbfcf),_0x4c84a0[_0x342072(0x10e)](setTimeout,()=>{const _0x32c0fa=_0x342072;!_0x1ba263&&_0x2af77f[_0x32c0fa(0x100)](_0x328910,_0x2af77f['MzSPi']);},_0x10b1f4),napCatCore[_0x342072(0x104)][_0x342072(0x12f)]()[_0x342072(0x13c)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x24291f,'chatType':_0xb7f8c9,'peerUid':_0x699113,'elementId':_0x14a0f5,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x40aecb});});}static async[_0x56e080(0x111)](_0x83bdbc){const _0x59773e={'oaBbW':function(_0x47fc52,_0x349202){return _0x47fc52(_0x349202);},'WBZtT':function(_0xa8e0f2,_0x5aad44,_0x180b25){return _0xa8e0f2(_0x5aad44,_0x180b25);}};return new Promise((_0x115ceb,_0x5d6a7e)=>{const _0x4fbbc8=_0x1d7b,_0x4898be={'XbIJq':function(_0x1a7916,_0x20f78a){return _0x1a7916(_0x20f78a);},'fiNtG':function(_0x1e58e9,_0x397d9e){const _0x47b1a8=_0x1d7b;return _0x59773e[_0x47b1a8(0x117)](_0x1e58e9,_0x397d9e);}};_0x59773e[_0x4fbbc8(0x128)](_0x2d784c,_0x83bdbc,(_0x3ef81b,_0xf93a8)=>{const _0x28b452=_0x4fbbc8;_0x3ef81b?_0x4898be['XbIJq'](_0x5d6a7e,_0x3ef81b):_0x4898be[_0x28b452(0x140)](_0x115ceb,_0xf93a8);});});}static async[_0x56e080(0x103)](_0x2c121d,_0x565f19){const _0x1b7d7d=_0x56e080,_0x463ea7={'yoIcB':_0x1b7d7d(0x12d),'ZBqYJ':function(_0xaa909,_0x19579b){return _0xaa909+_0x19579b;},'ZvzXb':function(_0x1a88ec,_0x28e6ca){return _0x1a88ec+_0x28e6ca;},'VqWfx':function(_0x12fabb,_0x1880a1){return _0x12fabb||_0x1880a1;},'pNPcB':function(_0x4e65f3,_0x458d13,_0x347283){return _0x4e65f3(_0x458d13,_0x347283);},'RrGMm':_0x1b7d7d(0xed)};if(!_0x2c121d)return'';const _0x3c2c8f=_0x2c121d[_0x1b7d7d(0x122)],_0x529c3f=_0x2c121d['md5HexStr'],_0x3ba282=_0x2c121d[_0x1b7d7d(0xf0)],_0x2501b9=_0x2c121d[_0x1b7d7d(0x108)];if(_0x3c2c8f){if(_0x3c2c8f['startsWith'](_0x463ea7[_0x1b7d7d(0x12c)])){if(_0x3c2c8f[_0x1b7d7d(0x118)](_0x1b7d7d(0x11e)))return IMAGE_HTTP_HOST_NT+_0x3c2c8f;const _0x3fb8dd=await rkeyManager[_0x1b7d7d(0xfc)](),_0x44a0b1=_0x565f19?_0x3fb8dd[_0x1b7d7d(0x127)]:_0x3fb8dd[_0x1b7d7d(0xf7)];return _0x463ea7[_0x1b7d7d(0x125)](IMAGE_HTTP_HOST_NT,_0x3c2c8f)+(''+_0x44a0b1);}else return _0x463ea7[_0x1b7d7d(0x132)](IMAGE_HTTP_HOST,_0x3c2c8f);}else{if(_0x463ea7['VqWfx'](_0x3ba282,_0x529c3f))return IMAGE_HTTP_HOST+_0x1b7d7d(0xff)+(_0x3ba282||_0x529c3f)[_0x1b7d7d(0x131)]()+'/0';}return _0x463ea7[_0x1b7d7d(0xeb)](logDebug,_0x463ea7['RrGMm'],_0x2c121d),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x4ee507=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x56e080(0x138)](_0x162ef6=[_0x56e080(0xfb),_0x56e080(0x13a)]){const _0x14d6bd=_0x56e080;return napCatCore[_0x14d6bd(0x104)][_0x14d6bd(0xf8)]()[_0x14d6bd(0xe9)](_0x162ef6);}static[_0x56e080(0xf5)](_0x6f6e79={}){return napCatCore['session']['getStorageCleanService']()['addCacheScanedPaths'](_0x6f6e79);}static[_0x56e080(0x123)](){const _0x16feae=_0x56e080;return napCatCore[_0x16feae(0x104)]['getStorageCleanService']()[_0x16feae(0x123)]();}static[_0x56e080(0xf9)](){return'';}static['getDesktopTmpPath'](){return'';}static['getChatCacheList'](_0x183768,_0x368b7b=0x3e8,_0x575d3f=0x0){const _0x4e0985=_0x56e080;return napCatCore[_0x4e0985(0x104)][_0x4e0985(0xf8)]()[_0x4e0985(0x105)](_0x183768,_0x368b7b,0x1,_0x575d3f);}static[_0x56e080(0xea)](_0x394daa,_0x251ba7=0x3e8,_0x158161){const _0x8dccd9=_0x158161?_0x158161:{'fileType':_0x394daa};}static async['clearChatCache'](_0x51debc=[],_0x1c92fd=[]){const _0x3a72e7=_0x56e080;return napCatCore[_0x3a72e7(0x104)][_0x3a72e7(0xf8)]()[_0x3a72e7(0x12b)](_0x51debc,_0x1c92fd);}}