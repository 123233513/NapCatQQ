const _0x2256cb=_0x550a;(function(_0x4552e2,_0x521831){const _0x24b51b=_0x550a,_0x1f6110=_0x4552e2();while(!![]){try{const _0x2d0101=-parseInt(_0x24b51b(0x1f6))/0x1*(-parseInt(_0x24b51b(0x1dc))/0x2)+parseInt(_0x24b51b(0x200))/0x3+-parseInt(_0x24b51b(0x207))/0x4*(-parseInt(_0x24b51b(0x204))/0x5)+-parseInt(_0x24b51b(0x1fd))/0x6+parseInt(_0x24b51b(0x1e2))/0x7*(parseInt(_0x24b51b(0x1d0))/0x8)+parseInt(_0x24b51b(0x205))/0x9*(parseInt(_0x24b51b(0x1fe))/0xa)+parseInt(_0x24b51b(0x1f4))/0xb*(-parseInt(_0x24b51b(0x1fb))/0xc);if(_0x2d0101===_0x521831)break;else _0x1f6110['push'](_0x1f6110['shift']());}catch(_0x3934d2){_0x1f6110['push'](_0x1f6110['shift']());}}}(_0x58e1,0x544f0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x55b9df from'path';function _0x550a(_0x1c26a6,_0x2a8444){const _0x58e113=_0x58e1();return _0x550a=function(_0x550ac9,_0x4b9cb4){_0x550ac9=_0x550ac9-0x1cb;let _0x26ec90=_0x58e113[_0x550ac9];return _0x26ec90;},_0x550a(_0x1c26a6,_0x2a8444);}import _0xcedb19 from'fs';import _0x58dd5d from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x4a6abd from'file-type';import{MsgListener}from'@/core/listeners';import _0x464146 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x109f2f=>{const _0x249527={'ZNWGr':function(_0x1d5f1f,_0x2a39e7){return _0x1d5f1f(_0x2a39e7);}};for(const [_0x12df8d,_0x1e5551]of downloadMediaTasks){_0x249527['ZNWGr'](_0x1e5551,_0x109f2f),downloadMediaTasks['delete'](_0x12df8d);}},setTimeout(()=>{const _0x2105f5=_0x550a;napCatCore[_0x2105f5(0x1cf)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x344eeb){const _0x5a08b9=_0x550a;return _0x4a6abd[_0x5a08b9(0x206)](_0x344eeb);}static async[_0x2256cb(0x1ce)](_0x3c5eab,_0xe9767e){await napCatCore['util']['copyFile'](_0x3c5eab,_0xe9767e);}static async[_0x2256cb(0x1ec)](_0x28af40){const _0x252d09=_0x2256cb;return await napCatCore['util'][_0x252d09(0x1ec)](_0x28af40);}static async[_0x2256cb(0x1f0)](_0x366906,_0x1c75ab=ElementType['PIC'],_0x2b5235=0x0){const _0x488798=_0x2256cb,_0x34d1e9={'ZZULs':function(_0x55dda4,_0x14d6d4){return _0x55dda4(_0x14d6d4);},'fIKzK':function(_0x1f54b2,_0x16bf12){return _0x1f54b2===_0x16bf12;}},_0x5e8169=await _0x34d1e9[_0x488798(0x1e3)](calculateFileMD5,_0x366906);let _0x41b2e6=(await NTQQFileApi[_0x488798(0x1fc)](_0x366906))?.[_0x488798(0x1cb)]||'';_0x41b2e6&&(_0x41b2e6='.'+_0x41b2e6);let _0x150def=''+_0x55b9df['basename'](_0x366906);_0x34d1e9[_0x488798(0x1e9)](_0x150def[_0x488798(0x1da)]('.'),-0x1)&&(_0x150def+=_0x41b2e6);const _0x588f21=napCatCore[_0x488798(0x1d8)][_0x488798(0x1ea)]()[_0x488798(0x211)]({'md5HexStr':_0x5e8169,'fileName':_0x150def,'elementType':_0x1c75ab,'elementSubType':_0x2b5235,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x488798(0x1ce)](_0x366906,_0x588f21);const _0x4c3de3=await NTQQFileApi[_0x488798(0x1ec)](_0x366906);return{'md5':_0x5e8169,'fileName':_0x150def,'path':_0x588f21,'fileSize':_0x4c3de3,'ext':_0x41b2e6};}static async[_0x2256cb(0x1e7)](_0x55b274,_0x4f286c,_0x4af92a,_0xd5836a,_0x58e5d2,_0x155a5f,_0x228c37=0x3e8*0x3c*0x2,_0x1088a5=![]){const _0x1d4978=_0x2256cb,_0x481e01={'FdTUJ':function(_0x4d406c,_0x14f5b8){return _0x4d406c(_0x14f5b8);},'UkOlJ':'下载超时','GlXaF':function(_0x5e4e50,_0x2dd712){return _0x5e4e50===_0x2dd712;},'UtqFj':function(_0x20f71f,_0x5d3943){return _0x20f71f(_0x5d3943);},'rZclE':function(_0x3b6c4e){return _0x3b6c4e();},'xDYiM':function(_0x396458,_0x3dab2d,_0x4fc670){return _0x396458(_0x3dab2d,_0x4fc670);}};if(_0x155a5f&&_0xcedb19[_0x1d4978(0x1f7)](_0x155a5f)){if(_0x1088a5)try{await _0x58dd5d[_0x1d4978(0x1f3)](_0x155a5f);}catch(_0x5c335a){}else return _0x155a5f;}return new Promise((_0x41ec57,_0x61080c)=>{const _0x5a2d48=_0x1d4978,_0x17b527={'QvVjT':function(_0x4fca3f,_0x102d5c){return _0x481e01['GlXaF'](_0x4fca3f,_0x102d5c);},'nfRju':function(_0x33ea14,_0x42b8ad){const _0x16fb6a=_0x550a;return _0x481e01[_0x16fb6a(0x1dd)](_0x33ea14,_0x42b8ad);}};let _0x17a9b6=![];const _0x8780cd=_0x1c21d1=>{const _0x23fbca=_0x550a;if(_0x17b527['QvVjT'](_0x1c21d1[_0x23fbca(0x201)],_0x55b274)){_0x17a9b6=!![];let _0x22dabc=_0x1c21d1['filePath'];if(_0x22dabc[_0x23fbca(0x1d6)]('\x5c')){const _0x33659d=sessionConfig[_0x23fbca(0x1cc)];_0x22dabc=_0x55b9df[_0x23fbca(0x1f5)](_0x33659d,_0x22dabc);}_0x17b527[_0x23fbca(0x1ef)](_0x41ec57,_0x22dabc);}};downloadMediaTasks[_0x5a2d48(0x1ff)](_0x481e01[_0x5a2d48(0x1d1)](randomUUID),_0x8780cd),_0x481e01[_0x5a2d48(0x1e4)](setTimeout,()=>{const _0x1877c6=_0x5a2d48;!_0x17a9b6&&_0x481e01[_0x1877c6(0x1d4)](_0x61080c,_0x481e01[_0x1877c6(0x20c)]);},_0x228c37),napCatCore['session'][_0x5a2d48(0x1ea)]()[_0x5a2d48(0x1df)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x55b274,'chatType':_0x4f286c,'peerUid':_0x4af92a,'elementId':_0xd5836a,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x58e5d2});});}static async[_0x2256cb(0x1f8)](_0x57dfdd){const _0x215154={'gdmLn':function(_0x3f7f3e,_0x32b21d){return _0x3f7f3e(_0x32b21d);},'OFRNw':function(_0x1054a7,_0x29bd1f,_0x23f472){return _0x1054a7(_0x29bd1f,_0x23f472);}};return new Promise((_0x35f778,_0x5888e8)=>{const _0x2aaaca=_0x550a,_0x5ed6b2={'EKfAQ':function(_0x2e5b0c,_0x218785){const _0x30f451=_0x550a;return _0x215154[_0x30f451(0x1de)](_0x2e5b0c,_0x218785);}};_0x215154[_0x2aaaca(0x20a)](_0x464146,_0x57dfdd,(_0x50b205,_0xb10d24)=>{const _0x4e0072=_0x2aaaca;_0x50b205?_0x5888e8(_0x50b205):_0x5ed6b2[_0x4e0072(0x1eb)](_0x35f778,_0xb10d24);});});}static async[_0x2256cb(0x1fa)](_0x42102b,_0x418a93){const _0x16d1c4=_0x2256cb,_0x5931da={'UdzTH':_0x16d1c4(0x202),'BYiCh':_0x16d1c4(0x20e),'lqsmk':function(_0x62fb58,_0x4fbdd6){return _0x62fb58+_0x4fbdd6;},'cbnbs':function(_0x21fc5d,_0x22cfd4){return _0x21fc5d||_0x22cfd4;},'nzprv':function(_0x288fca,_0x253006,_0x5f2522){return _0x288fca(_0x253006,_0x5f2522);},'GUeXJ':'图片url获取失败'};if(!_0x42102b)return'';const _0x55b344=_0x42102b[_0x16d1c4(0x1db)],_0x1c8eb5=_0x42102b[_0x16d1c4(0x1d9)],_0x2965d0=_0x42102b[_0x16d1c4(0x1d9)],_0x405f87=_0x42102b[_0x16d1c4(0x1f9)];if(_0x55b344){if(_0x55b344[_0x16d1c4(0x1d6)](_0x5931da['UdzTH'])){if(_0x55b344[_0x16d1c4(0x1d3)](_0x5931da[_0x16d1c4(0x1d2)]))return _0x5931da['lqsmk'](IMAGE_HTTP_HOST_NT,_0x55b344);const _0x502165=await rkeyManager[_0x16d1c4(0x1e6)](),_0x47080e=_0x418a93?_0x502165['private_rkey']:_0x502165[_0x16d1c4(0x1ee)];return _0x5931da['lqsmk'](_0x5931da[_0x16d1c4(0x20d)](IMAGE_HTTP_HOST_NT,_0x55b344),''+_0x47080e);}else return _0x5931da['lqsmk'](IMAGE_HTTP_HOST,_0x55b344);}else{if(_0x2965d0||_0x1c8eb5)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x5931da[_0x16d1c4(0x1d5)](_0x2965d0,_0x1c8eb5)[_0x16d1c4(0x1f1)]()+'/0';}return _0x5931da[_0x16d1c4(0x1e1)](logDebug,_0x5931da[_0x16d1c4(0x1d7)],_0x42102b),'';}}function _0x58e1(){const _0x468aff=['2mWzuEG','UtqFj','gdmLn','downloadRichMedia','hotUpdate','nzprv','17843IHsuzQ','ZZULs','xDYiM','clearChatCache','getRkey','downloadMedia','getFileCacheInfo','fIKzK','getMsgService','EKfAQ','getFileSize','getChatCacheList','group_rkey','nfRju','uploadFile','toUpperCase','getHotUpdateCachePath','unlink','55IHcyEy','join','218317bZwzRy','existsSync','getImageSize','fileUuid','getImageUrl','1683228sGUEAG','getFileType','2487336mvlsnp','10YVrjcq','set','201648QOjumF','msgId','/download','clearChatCacheInfo','23535bswZAT','5674869ETIzIP','fileTypeFromFile','212mtttqr','getChatCacheInfo','addCacheScannedPaths','OFRNw','getCacheSessionPathList','UkOlJ','lqsmk','&rkey=','getStorageCleanService','tmp','getRichMediaFilePathForGuild','scanCache','ext','defaultFileDownloadPath','clearCache','copyFile','onLoginSuccess','928TMMtrs','rZclE','BYiCh','includes','FdTUJ','cbnbs','startsWith','GUeXJ','session','md5HexStr','indexOf','originImageUrl'];_0x58e1=function(){return _0x468aff;};return _0x58e1();}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x79532b=!![]){return'';}static[_0x2256cb(0x20b)](){return'';}static[_0x2256cb(0x1cd)](_0x5b96b2=[_0x2256cb(0x210),_0x2256cb(0x1e0)]){return napCatCore['session']['getStorageCleanService']()['clearCacheDataByKeys'](_0x5b96b2);}static[_0x2256cb(0x209)](_0x2630b7={}){const _0x2a0546=_0x2256cb;return napCatCore[_0x2a0546(0x1d8)]['getStorageCleanService']()['addCacheScanedPaths'](_0x2630b7);}static[_0x2256cb(0x212)](){const _0x3bc675=_0x2256cb;return napCatCore[_0x3bc675(0x1d8)][_0x3bc675(0x20f)]()[_0x3bc675(0x212)]();}static[_0x2256cb(0x1f2)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x2256cb(0x1ed)](_0x335344,_0x305e52=0x3e8,_0x1ce455=0x0){const _0x4feb34=_0x2256cb;return napCatCore[_0x4feb34(0x1d8)]['getStorageCleanService']()[_0x4feb34(0x208)](_0x335344,_0x305e52,0x1,_0x1ce455);}static[_0x2256cb(0x1e8)](_0x2060d3,_0x35fbc5=0x3e8,_0xfcc94a){const _0x3ffcd8=_0xfcc94a?_0xfcc94a:{'fileType':_0x2060d3};}static async[_0x2256cb(0x1e5)](_0xd571dd=[],_0xfaebf7=[]){const _0x2e5be8=_0x2256cb;return napCatCore['session'][_0x2e5be8(0x20f)]()[_0x2e5be8(0x203)](_0xd571dd,_0xfaebf7);}}