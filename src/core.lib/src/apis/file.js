const _0x109239=_0x3e6a;(function(_0x2838a3,_0x2a716a){const _0x41e0f3=_0x3e6a,_0x5596f9=_0x2838a3();while(!![]){try{const _0x46fda6=parseInt(_0x41e0f3(0x1f7))/0x1*(parseInt(_0x41e0f3(0x1cf))/0x2)+-parseInt(_0x41e0f3(0x1c2))/0x3+-parseInt(_0x41e0f3(0x1b9))/0x4+-parseInt(_0x41e0f3(0x1ca))/0x5*(-parseInt(_0x41e0f3(0x1c0))/0x6)+-parseInt(_0x41e0f3(0x1ec))/0x7*(parseInt(_0x41e0f3(0x1db))/0x8)+parseInt(_0x41e0f3(0x1fa))/0x9*(-parseInt(_0x41e0f3(0x1d0))/0xa)+-parseInt(_0x41e0f3(0x1f5))/0xb*(-parseInt(_0x41e0f3(0x1b8))/0xc);if(_0x46fda6===_0x2a716a)break;else _0x5596f9['push'](_0x5596f9['shift']());}catch(_0x4ffe34){_0x5596f9['push'](_0x5596f9['shift']());}}}(_0x5d32,0x7fe41));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x524eb5 from'path';import _0x2a1894 from'fs';import _0x1ac1f7 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x201476 from'file-type';import{MsgListener}from'@/core/listeners';import _0x3b0564 from'image-size';function _0x5d32(){const _0x61d37f=['173200QOIMPN','getImageSize','RxhMo','getCacheSessionPathList','addCacheScanedPaths','startsWith','private_rkey','join','HLuDT','SMACq','setCacheSilentScan','toUpperCase','util','msgId','downloadMedia','图片url获取失败','existsSync','35KPYliG','delete','set','ext','/gchatpic_new/0/0-0-','eJbQI','xAptl','hotUpdate','XobtL','11GyGoin','getFileType','482KVesgq','qYbxe','indexOf','18gwRmdx','session','nclyB','getFileSize','gHuTT','20175852LQXQTh','440044NnWuXF','copyFile','fileTypeFromFile','getStorageCleanService','scanCache','/download','lspmz','2046NOkopx','EsvKn','1246017xWPjKq','getRkey','getChatCacheInfo','downloadRichMedia','getChatCacheList','unlink','vnsEJ','tmp','1450uCwqsz','uploadFile','fileUuid','bzLxv','addListener','1324bRelys','4709270mVncwZ','PIC','basename','getDesktopTmpPath','isbGg','IMZJW','originImageUrl','clearChatCacheInfo','clearCache','addCacheScannedPaths','getImageUrl'];_0x5d32=function(){return _0x61d37f;};return _0x5d32();}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();function _0x3e6a(_0x4ebd15,_0x5d5a4a){const _0x5d329c=_0x5d32();return _0x3e6a=function(_0x3e6aa3,_0x72e993){_0x3e6aa3=_0x3e6aa3-0x1b6;let _0x3d1c58=_0x5d329c[_0x3e6aa3];return _0x3d1c58;},_0x3e6a(_0x4ebd15,_0x5d5a4a);}downloadMediaListener['onRichMediaDownloadComplete']=_0x393f9a=>{const _0x666590=_0x3e6a,_0x10d00a={'RxhMo':function(_0x15ebcb,_0x3a7ccf){return _0x15ebcb(_0x3a7ccf);}};for(const [_0x3f3c76,_0x474a73]of downloadMediaTasks){_0x10d00a[_0x666590(0x1dd)](_0x474a73,_0x393f9a),downloadMediaTasks[_0x666590(0x1ed)](_0x3f3c76);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x3879a9=_0x3e6a;napCatCore[_0x3879a9(0x1ce)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x109239(0x1f6)](_0x5beead){const _0x52e871=_0x109239;return _0x201476[_0x52e871(0x1bb)](_0x5beead);}static async[_0x109239(0x1ba)](_0x12424c,_0x20725f){const _0x2d1bf4=_0x109239;await napCatCore['util'][_0x2d1bf4(0x1ba)](_0x12424c,_0x20725f);}static async['getFileSize'](_0x3e0f4b){const _0x3edae4=_0x109239;return await napCatCore[_0x3edae4(0x1e7)][_0x3edae4(0x1b6)](_0x3e0f4b);}static async[_0x109239(0x1cb)](_0x36cb62,_0x345e4e=ElementType[_0x109239(0x1d1)],_0x277ca3=0x0){const _0x4a6b07=_0x109239,_0x541399={'isbGg':function(_0x2798f9,_0x19e1e3){return _0x2798f9+_0x19e1e3;},'eJbQI':function(_0x23c6fe,_0x5ae3e5){return _0x23c6fe===_0x5ae3e5;}},_0x27f1b2=await calculateFileMD5(_0x36cb62);let _0x343698=(await NTQQFileApi['getFileType'](_0x36cb62))?.[_0x4a6b07(0x1ef)]||'';_0x343698&&(_0x343698=_0x541399[_0x4a6b07(0x1d4)]('.',_0x343698));let _0x999ee4=''+_0x524eb5[_0x4a6b07(0x1d2)](_0x36cb62);_0x541399[_0x4a6b07(0x1f1)](_0x999ee4[_0x4a6b07(0x1f9)]('.'),-0x1)&&(_0x999ee4+=_0x343698);const _0x374963=napCatCore['session']['getMsgService']()['getRichMediaFilePathForGuild']({'md5HexStr':_0x27f1b2,'fileName':_0x999ee4,'elementType':_0x345e4e,'elementSubType':_0x277ca3,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x36cb62,_0x374963);const _0x31a363=await NTQQFileApi[_0x4a6b07(0x1b6)](_0x36cb62);return{'md5':_0x27f1b2,'fileName':_0x999ee4,'path':_0x374963,'fileSize':_0x31a363,'ext':_0x343698};}static async[_0x109239(0x1e9)](_0x3ecaec,_0x259421,_0x2eb17f,_0x13c267,_0x4d25ad,_0x1ea968,_0x518657=0x3e8*0x3c*0x2,_0x2756f9=![]){const _0x5448f0=_0x109239,_0x53498f={'qYbxe':function(_0xac8a48,_0x2bb002){return _0xac8a48===_0x2bb002;},'nclyB':function(_0x2d03f2,_0x1dbaaf){return _0x2d03f2(_0x1dbaaf);},'EsvKn':'下载超时','HLuDT':function(_0x59cc8a){return _0x59cc8a();},'igLuD':function(_0x5c814b,_0x149fac,_0x40b596){return _0x5c814b(_0x149fac,_0x40b596);}};if(_0x1ea968&&_0x2a1894[_0x5448f0(0x1eb)](_0x1ea968)){if(_0x2756f9)try{await _0x1ac1f7[_0x5448f0(0x1c7)](_0x1ea968);}catch(_0x19b794){}else return _0x1ea968;}return new Promise((_0x27bb08,_0x3833b7)=>{const _0x25bcb6=_0x5448f0;let _0x79b9e1=![];const _0x5dd12e=_0x37692e=>{const _0x4a215a=_0x3e6a;if(_0x53498f[_0x4a215a(0x1f8)](_0x37692e[_0x4a215a(0x1e8)],_0x3ecaec)){_0x79b9e1=!![];let _0x258d46=_0x37692e['filePath'];if(_0x258d46[_0x4a215a(0x1e0)]('\x5c')){const _0xbb05bc=sessionConfig['defaultFileDownloadPath'];_0x258d46=_0x524eb5[_0x4a215a(0x1e2)](_0xbb05bc,_0x258d46);}_0x53498f[_0x4a215a(0x1fc)](_0x27bb08,_0x258d46);}};downloadMediaTasks[_0x25bcb6(0x1ee)](_0x53498f[_0x25bcb6(0x1e3)](randomUUID),_0x5dd12e),_0x53498f['igLuD'](setTimeout,()=>{const _0x44888f=_0x25bcb6;!_0x79b9e1&&_0x53498f[_0x44888f(0x1fc)](_0x3833b7,_0x53498f[_0x44888f(0x1c1)]);},_0x518657),napCatCore[_0x25bcb6(0x1fb)]['getMsgService']()[_0x25bcb6(0x1c5)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3ecaec,'chatType':_0x259421,'peerUid':_0x2eb17f,'elementId':_0x13c267,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4d25ad});});}static async[_0x109239(0x1dc)](_0x3b42ce){const _0x2e68f4={'bzLxv':function(_0x5e9a6e,_0x3ba793){return _0x5e9a6e(_0x3ba793);},'UNxPL':function(_0x2d82ea,_0x478c17,_0xebc9a5){return _0x2d82ea(_0x478c17,_0xebc9a5);}};return new Promise((_0x492090,_0x2ac25e)=>{const _0x474011={'uyoro':function(_0x2dbcf0,_0x53b65a){return _0x2dbcf0(_0x53b65a);},'SMACq':function(_0xdc3ac2,_0x42bd95){const _0xd34593=_0x3e6a;return _0x2e68f4[_0xd34593(0x1cd)](_0xdc3ac2,_0x42bd95);}};_0x2e68f4['UNxPL'](_0x3b0564,_0x3b42ce,(_0x1dadfa,_0x5f33c8)=>{const _0x57bb48=_0x3e6a;_0x1dadfa?_0x474011['uyoro'](_0x2ac25e,_0x1dadfa):_0x474011[_0x57bb48(0x1e4)](_0x492090,_0x5f33c8);});});}static async[_0x109239(0x1da)](_0x1f7e74,_0x29e639){const _0x19753f=_0x109239,_0x45d12d={'lspmz':_0x19753f(0x1be),'IMZJW':'&rkey=','vnsEJ':function(_0x1dabd7,_0x47aa81){return _0x1dabd7+_0x47aa81;},'gHuTT':function(_0x4ad7e6,_0x4fa67b){return _0x4ad7e6||_0x4fa67b;},'xAptl':function(_0x70f201,_0x13d548,_0x16d895){return _0x70f201(_0x13d548,_0x16d895);},'XobtL':_0x19753f(0x1ea)};if(!_0x1f7e74)return'';const _0x1cc06c=_0x1f7e74[_0x19753f(0x1d6)],_0x3a67ce=_0x1f7e74['md5HexStr'],_0x23e802=_0x1f7e74['md5HexStr'],_0x2ca5b8=_0x1f7e74[_0x19753f(0x1cc)];if(_0x1cc06c){if(_0x1cc06c[_0x19753f(0x1e0)](_0x45d12d[_0x19753f(0x1bf)])){if(_0x1cc06c['includes'](_0x45d12d[_0x19753f(0x1d5)]))return _0x45d12d[_0x19753f(0x1c8)](IMAGE_HTTP_HOST_NT,_0x1cc06c);const _0x11e3c6=await rkeyManager[_0x19753f(0x1c3)](),_0x4d4b41=_0x29e639?_0x11e3c6[_0x19753f(0x1e1)]:_0x11e3c6['group_rkey'];return _0x45d12d[_0x19753f(0x1c8)](_0x45d12d[_0x19753f(0x1c8)](IMAGE_HTTP_HOST_NT,_0x1cc06c),''+_0x4d4b41);}else return _0x45d12d[_0x19753f(0x1c8)](IMAGE_HTTP_HOST,_0x1cc06c);}else{if(_0x45d12d[_0x19753f(0x1b7)](_0x23e802,_0x3a67ce))return IMAGE_HTTP_HOST+_0x19753f(0x1f0)+(_0x23e802||_0x3a67ce)[_0x19753f(0x1e6)]()+'/0';}return _0x45d12d[_0x19753f(0x1f2)](logDebug,_0x45d12d[_0x19753f(0x1f4)],_0x1f7e74),'';}}export class NTQQFileCacheApi{static async[_0x109239(0x1e5)](_0x1b85ec=!![]){return'';}static[_0x109239(0x1de)](){return'';}static[_0x109239(0x1d8)](_0x28dbd8=[_0x109239(0x1c9),_0x109239(0x1f3)]){const _0x1aac39=_0x109239;return napCatCore[_0x1aac39(0x1fb)][_0x1aac39(0x1bc)]()['clearCacheDataByKeys'](_0x28dbd8);}static[_0x109239(0x1d9)](_0x1e5d59={}){const _0x6e860c=_0x109239;return napCatCore[_0x6e860c(0x1fb)][_0x6e860c(0x1bc)]()[_0x6e860c(0x1df)](_0x1e5d59);}static[_0x109239(0x1bd)](){const _0x3362ee=_0x109239;return napCatCore['session'][_0x3362ee(0x1bc)]()['scanCache']();}static['getHotUpdateCachePath'](){return'';}static[_0x109239(0x1d3)](){return'';}static[_0x109239(0x1c6)](_0x2b6493,_0x45be62=0x3e8,_0x1b4d2d=0x0){const _0x2f479c=_0x109239;return napCatCore[_0x2f479c(0x1fb)][_0x2f479c(0x1bc)]()[_0x2f479c(0x1c4)](_0x2b6493,_0x45be62,0x1,_0x1b4d2d);}static['getFileCacheInfo'](_0x113ca7,_0x559067=0x3e8,_0x25f334){const _0x87010=_0x25f334?_0x25f334:{'fileType':_0x113ca7};}static async['clearChatCache'](_0x5c9e26=[],_0x256640=[]){const _0x39858f=_0x109239;return napCatCore[_0x39858f(0x1fb)][_0x39858f(0x1bc)]()[_0x39858f(0x1d7)](_0x5c9e26,_0x256640);}}