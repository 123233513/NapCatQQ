const _0x1cf072=_0x74a7;(function(_0x580612,_0x3228fe){const _0x2423e5=_0x74a7,_0x299fd=_0x580612();while(!![]){try{const _0x2a4480=-parseInt(_0x2423e5(0x7c))/0x1+parseInt(_0x2423e5(0x7a))/0x2*(parseInt(_0x2423e5(0x93))/0x3)+-parseInt(_0x2423e5(0xaf))/0x4*(-parseInt(_0x2423e5(0xab))/0x5)+-parseInt(_0x2423e5(0x8b))/0x6+-parseInt(_0x2423e5(0x8c))/0x7*(-parseInt(_0x2423e5(0xb6))/0x8)+parseInt(_0x2423e5(0xbc))/0x9*(-parseInt(_0x2423e5(0x98))/0xa)+-parseInt(_0x2423e5(0xba))/0xb;if(_0x2a4480===_0x3228fe)break;else _0x299fd['push'](_0x299fd['shift']());}catch(_0x358616){_0x299fd['push'](_0x299fd['shift']());}}}(_0x2be8,0x45029));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x4dc024 from'path';import _0x2aa5c4 from'fs';import _0x4fd7f8 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0x2be8(){const _0x357db5=['ext','clearChatCache','existsSync','addCacheScanedPaths','getImageUrl','filePath','2259690oPlmsq','868uYshzk','sHZmF','urlResult','hotUpdate','cvhhi','msgId','getDesktopTmpPath','16293RhXDXe','tUfZp','&rkey=','copyFile','XbGbF','2330TLXtkB','getFileType','PPiXF','getFileCacheInfo','getVideoPlayUrlV2','ZQQIa','defaultFileDownloadPath','getHotUpdateCachePath','getRkey','getRichMediaFilePathForGuild','getStorageCleanService','peerUid','includes','indexOf','fileUuid','originImageUrl','addListener','downloadMedia','startsWith','5LsDLIf','clearChatCacheInfo','XNxwC','rCjRN','825748HrBJVU','session','set','unlink','Aljxx','uaMDU','md5HexStr','28264oXNaUo','图片url获取失败','chatType','scanCache','2288FbDGsF','join','4491HRXObJ','getMsgService','下载超时','getFileSize','YJDse','getCacheSessionPathList','getChatCacheList','downloadRichMedia','pdtQU','122JitRKQ','BrcyT','200065BgaUhY','onRichMediaDownloadComplete','setCacheSilentScan','util','basename','getChatCacheInfo','url','onLoginSuccess','getVideoUrl'];_0x2be8=function(){return _0x357db5;};return _0x2be8();}function _0x74a7(_0xf41a58,_0x2e1f6f){const _0x2be83c=_0x2be8();return _0x74a7=function(_0x74a71b,_0x186e73){_0x74a71b=_0x74a71b-0x77;let _0x2ff8b4=_0x2be83c[_0x74a71b];return _0x2ff8b4;},_0x74a7(_0xf41a58,_0x2e1f6f);}import*as _0x51eb2d from'file-type';import{MsgListener}from'@/core/listeners';import _0x496007 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x1cf072(0x7d)]=_0x3cbb7b=>{for(const [_0x38ef9b,_0x46086d]of downloadMediaTasks){_0x46086d(_0x3cbb7b),downloadMediaTasks['delete'](_0x38ef9b);}},setTimeout(()=>{const _0x2eb851=_0x1cf072;napCatCore[_0x2eb851(0x83)](()=>{const _0x3b0bfd=_0x2eb851;napCatCore[_0x3b0bfd(0xa8)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x1cf072(0x99)](_0xa1ba10){return _0x51eb2d['fileTypeFromFile'](_0xa1ba10);}static async[_0x1cf072(0x96)](_0x541ba7,_0x97ccc){const _0x5c404f=_0x1cf072;await napCatCore[_0x5c404f(0x7f)]['copyFile'](_0x541ba7,_0x97ccc);}static async[_0x1cf072(0xbf)](_0x12873c){const _0x33179a=_0x1cf072;return await napCatCore[_0x33179a(0x7f)][_0x33179a(0xbf)](_0x12873c);}static async[_0x1cf072(0x84)](_0x24c00f,_0x55413e){const _0x5303e7=_0x1cf072;return(await napCatCore[_0x5303e7(0xb0)]['getRichMediaService']()[_0x5303e7(0x9c)]({'chatType':_0x24c00f[_0x5303e7(0xb8)],'peerUid':_0x24c00f[_0x5303e7(0xa3)],'guildId':'0'},_0x24c00f[_0x5303e7(0x91)],_0x55413e['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x5303e7(0x8e)]['domainUrl'][0x0][_0x5303e7(0x82)];}static async['uploadFile'](_0x440860,_0x5e0c91=ElementType['PIC'],_0x432014=0x0){const _0x283785=_0x1cf072,_0x53d495={'dHmqf':function(_0xb95b56,_0x59a169){return _0xb95b56(_0x59a169);},'bFNlB':function(_0xcede37,_0x598f36){return _0xcede37+_0x598f36;},'XtHJY':function(_0xebb48f,_0xce0c19){return _0xebb48f===_0xce0c19;}},_0x222f51=await _0x53d495['dHmqf'](calculateFileMD5,_0x440860);let _0x45fd4d=(await NTQQFileApi[_0x283785(0x99)](_0x440860))?.[_0x283785(0x85)]||'';_0x45fd4d&&(_0x45fd4d=_0x53d495['bFNlB']('.',_0x45fd4d));let _0x5739bb=''+_0x4dc024[_0x283785(0x80)](_0x440860);_0x53d495['XtHJY'](_0x5739bb[_0x283785(0xa5)]('.'),-0x1)&&(_0x5739bb+=_0x45fd4d);const _0x500f35=napCatCore[_0x283785(0xb0)][_0x283785(0xbd)]()[_0x283785(0xa1)]({'md5HexStr':_0x222f51,'fileName':_0x5739bb,'elementType':_0x5e0c91,'elementSubType':_0x432014,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x283785(0x96)](_0x440860,_0x500f35);const _0x21f48b=await NTQQFileApi['getFileSize'](_0x440860);return{'md5':_0x222f51,'fileName':_0x5739bb,'path':_0x500f35,'fileSize':_0x21f48b,'ext':_0x45fd4d};}static async[_0x1cf072(0xa9)](_0x34541a,_0x10bdbb,_0x2f063e,_0x1f9626,_0x2ab3fb,_0x18809f,_0x1ba036=0x3e8*0x3c*0x2,_0x3e1f9d=![]){const _0x25024b=_0x1cf072,_0x31445b={'XbGbF':function(_0x239c15,_0x1e89dc){return _0x239c15(_0x1e89dc);},'XNxwC':_0x25024b(0xbe),'YJDse':function(_0x241328){return _0x241328();},'JOBYT':function(_0x4de03a,_0x5b7672,_0x59742c){return _0x4de03a(_0x5b7672,_0x59742c);}};if(_0x18809f&&_0x2aa5c4[_0x25024b(0x87)](_0x18809f)){if(_0x3e1f9d)try{await _0x4fd7f8[_0x25024b(0xb2)](_0x18809f);}catch(_0x1f18c3){}else return _0x18809f;}return new Promise((_0x2036fe,_0x4909d6)=>{const _0x3c1d11=_0x25024b,_0x243189={'Aljxx':function(_0x523684,_0x5d842e){const _0x3aecbd=_0x74a7;return _0x31445b[_0x3aecbd(0x97)](_0x523684,_0x5d842e);}};let _0x2d1233=![];const _0x4a459b=_0x3c0b79=>{const _0x4a6bbd=_0x74a7;if(_0x3c0b79['msgId']===_0x34541a){_0x2d1233=!![];let _0x3edcc1=_0x3c0b79[_0x4a6bbd(0x8a)];if(_0x3edcc1[_0x4a6bbd(0xaa)]('\x5c')){const _0x3b7b4f=sessionConfig[_0x4a6bbd(0x9e)];_0x3edcc1=_0x4dc024[_0x4a6bbd(0xbb)](_0x3b7b4f,_0x3edcc1);}_0x243189[_0x4a6bbd(0xb3)](_0x2036fe,_0x3edcc1);}};downloadMediaTasks[_0x3c1d11(0xb1)](_0x31445b[_0x3c1d11(0xc0)](randomUUID),_0x4a459b),_0x31445b['JOBYT'](setTimeout,()=>{const _0x562f71=_0x3c1d11;!_0x2d1233&&_0x31445b[_0x562f71(0x97)](_0x4909d6,_0x31445b[_0x562f71(0xad)]);},_0x1ba036),napCatCore[_0x3c1d11(0xb0)]['getMsgService']()[_0x3c1d11(0x78)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x34541a,'chatType':_0x10bdbb,'peerUid':_0x2f063e,'elementId':_0x1f9626,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2ab3fb});});}static async['getImageSize'](_0x19d2a6){const _0x5a4f17={'uaMDU':function(_0x3226d3,_0x2e06ba){return _0x3226d3(_0x2e06ba);},'rCjRN':function(_0x522f58,_0x49cce2,_0x4dbfb7){return _0x522f58(_0x49cce2,_0x4dbfb7);}};return new Promise((_0x13bea8,_0x5bdd0a)=>{const _0x3b453d=_0x74a7;_0x5a4f17[_0x3b453d(0xae)](_0x496007,_0x19d2a6,(_0x48f2de,_0x19e8f7)=>{const _0x26d827=_0x3b453d;_0x48f2de?_0x5bdd0a(_0x48f2de):_0x5a4f17[_0x26d827(0xb4)](_0x13bea8,_0x19e8f7);});});}static async[_0x1cf072(0x89)](_0x3fb69d,_0x50667f){const _0x1e1777=_0x1cf072,_0x502c26={'cvhhi':'/download','tUfZp':_0x1e1777(0x95),'sHZmF':function(_0x11a036,_0x402912){return _0x11a036+_0x402912;},'pdtQU':function(_0x7d1a02,_0x39eaf2){return _0x7d1a02+_0x39eaf2;},'PPiXF':function(_0x4df9a7,_0xb7b061){return _0x4df9a7+_0xb7b061;},'BrcyT':function(_0x5f89cd,_0x2f9991){return _0x5f89cd||_0x2f9991;},'ZQQIa':function(_0x5a799f,_0x5aafe0,_0x1bf966){return _0x5a799f(_0x5aafe0,_0x1bf966);},'HxBCe':_0x1e1777(0xb7)};if(!_0x3fb69d)return'';const _0x2439b2=_0x3fb69d[_0x1e1777(0xa7)],_0xc45994=_0x3fb69d['md5HexStr'],_0x493489=_0x3fb69d[_0x1e1777(0xb5)],_0x48737b=_0x3fb69d[_0x1e1777(0xa6)];if(_0x2439b2){if(_0x2439b2['startsWith'](_0x502c26[_0x1e1777(0x90)])){if(_0x2439b2[_0x1e1777(0xa4)](_0x502c26[_0x1e1777(0x94)]))return _0x502c26[_0x1e1777(0x8d)](IMAGE_HTTP_HOST_NT,_0x2439b2);const _0x210460=await rkeyManager[_0x1e1777(0xa0)](),_0x144412=_0x50667f?_0x210460['private_rkey']:_0x210460['group_rkey'];return _0x502c26[_0x1e1777(0x79)](_0x502c26[_0x1e1777(0x8d)](IMAGE_HTTP_HOST_NT,_0x2439b2),''+_0x144412);}else return _0x502c26[_0x1e1777(0x9a)](IMAGE_HTTP_HOST,_0x2439b2);}else{if(_0x502c26[_0x1e1777(0x7b)](_0x493489,_0xc45994))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+(_0x493489||_0xc45994)['toUpperCase']()+'/0';}return _0x502c26[_0x1e1777(0x9d)](logDebug,_0x502c26['HxBCe'],_0x3fb69d),'';}}export class NTQQFileCacheApi{static async[_0x1cf072(0x7e)](_0x1ef85b=!![]){return'';}static[_0x1cf072(0xc1)](){return'';}static['clearCache'](_0x317158=['tmp',_0x1cf072(0x8f)]){const _0x16fcc3=_0x1cf072;return napCatCore['session'][_0x16fcc3(0xa2)]()['clearCacheDataByKeys'](_0x317158);}static['addCacheScannedPaths'](_0x298fab={}){const _0x19c88a=_0x1cf072;return napCatCore[_0x19c88a(0xb0)][_0x19c88a(0xa2)]()[_0x19c88a(0x88)](_0x298fab);}static[_0x1cf072(0xb9)](){const _0x4f6c6a=_0x1cf072;return napCatCore['session'][_0x4f6c6a(0xa2)]()['scanCache']();}static[_0x1cf072(0x9f)](){return'';}static[_0x1cf072(0x92)](){return'';}static[_0x1cf072(0x77)](_0x622ee8,_0x2982ec=0x3e8,_0x5611b0=0x0){const _0x1e2fa6=_0x1cf072;return napCatCore[_0x1e2fa6(0xb0)][_0x1e2fa6(0xa2)]()[_0x1e2fa6(0x81)](_0x622ee8,_0x2982ec,0x1,_0x5611b0);}static[_0x1cf072(0x9b)](_0x543718,_0x56a041=0x3e8,_0x929c4e){const _0x4363b5=_0x929c4e?_0x929c4e:{'fileType':_0x543718};}static async[_0x1cf072(0x86)](_0x1a6f38=[],_0x396bd8=[]){const _0x1216cf=_0x1cf072;return napCatCore[_0x1216cf(0xb0)][_0x1216cf(0xa2)]()[_0x1216cf(0xac)](_0x1a6f38,_0x396bd8);}}