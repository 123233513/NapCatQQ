const _0x56e6f8=_0x1032;(function(_0xc33b8d,_0x395f12){const _0x28d316=_0x1032,_0x573fee=_0xc33b8d();while(!![]){try{const _0x4391b1=-parseInt(_0x28d316(0x108))/0x1*(-parseInt(_0x28d316(0x10b))/0x2)+parseInt(_0x28d316(0xea))/0x3*(parseInt(_0x28d316(0x117))/0x4)+-parseInt(_0x28d316(0xe5))/0x5+parseInt(_0x28d316(0xda))/0x6+-parseInt(_0x28d316(0xf6))/0x7+parseInt(_0x28d316(0x120))/0x8*(parseInt(_0x28d316(0x106))/0x9)+-parseInt(_0x28d316(0x12c))/0xa*(parseInt(_0x28d316(0x127))/0xb);if(_0x4391b1===_0x395f12)break;else _0x573fee['push'](_0x573fee['shift']());}catch(_0xa1e215){_0x573fee['push'](_0x573fee['shift']());}}}(_0x2ddb,0x95a16));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0xb8832b from'path';function _0x2ddb(){const _0x5e547b=['34644oQpkuY','yZBjS','PIC','/gchatpic_new/0/0-0-','hotUpdate','ZlmEz','getRichMediaFilePathForGuild','toUpperCase','delete','clearCacheDataByKeys','tmp','LxIoP','4240698hFIpCK','CkDWq','getHotUpdateCachePath','getFileType','indexOf','clearChatCache','getImageSize','getFileSize','elementId','apGSe','uhwUc','getMsgService','RKojW','defaultFileDownloadPath','downloadRichMedia','/download','1035FjwsIW','startsWith','1egezhT','addCacheScanedPaths','addCacheScannedPaths','532186UKWHEY','scanCache','getFileCacheInfo','chatType','getVideoPlayUrlV2','clearCache','getChatCacheList','downloadMedia','msgId','existsSync','ext','onRichMediaDownloadComplete','324ZmlBoR','qGSEK','CvjtC','EPHAr','md5HexStr','filePath','uOuNx','private_rkey','dZnZo','13784KkODpW','GBIqf','join','includes','VXkMa','fileTypeFromFile','getImageUrl','1232chcmdz','HQWKE','urlResult','url','getCacheSessionPathList','19970FNnCDY','getVideoUrl','hCuOI','下载超时','uploadFile','5461620vcQFyD','COeSL','session','IDNCu','domainUrl','getStorageCleanService','getRkey','addListener','图片url获取失败','sgiNM','peerUid','4337660SkAxNk','unlink','util','copyFile','&rkey='];_0x2ddb=function(){return _0x5e547b;};return _0x2ddb();}import _0x18b381 from'fs';import _0x54e42d from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x4e5834 from'file-type';import{MsgListener}from'@/core/listeners';import _0x5a6a0c from'image-size';function _0x1032(_0x81f995,_0x11dec6){const _0x2ddbcb=_0x2ddb();return _0x1032=function(_0x1032e5,_0x215741){_0x1032e5=_0x1032e5-0xd9;let _0x5a1709=_0x2ddbcb[_0x1032e5];return _0x5a1709;},_0x1032(_0x81f995,_0x11dec6);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x56e6f8(0x116)]=_0x530020=>{const _0x1dba36=_0x56e6f8;for(const [_0x4f422b,_0x26d573]of downloadMediaTasks){_0x26d573(_0x530020),downloadMediaTasks[_0x1dba36(0xf2)](_0x4f422b);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x3d05c6=_0x1032;napCatCore[_0x3d05c6(0xe1)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x56e6f8(0xf9)](_0x17efb0){const _0x4ad483=_0x56e6f8;return _0x4e5834[_0x4ad483(0x125)](_0x17efb0);}static async[_0x56e6f8(0xe8)](_0x49d9eb,_0x4ef503){const _0x19b68c=_0x56e6f8;await napCatCore[_0x19b68c(0xe7)][_0x19b68c(0xe8)](_0x49d9eb,_0x4ef503);}static async[_0x56e6f8(0xfd)](_0x3ce019){const _0x48df96=_0x56e6f8;return await napCatCore[_0x48df96(0xe7)][_0x48df96(0xfd)](_0x3ce019);}static async[_0x56e6f8(0x12d)](_0x226910,_0x959e4c){const _0x1558a0=_0x56e6f8;return(await napCatCore[_0x1558a0(0xdc)]['getRichMediaService']()[_0x1558a0(0x10f)]({'chatType':_0x226910[_0x1558a0(0x10e)],'peerUid':_0x226910[_0x1558a0(0xe4)],'guildId':'0'},_0x226910['msgId'],_0x959e4c[_0x1558a0(0xfe)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x1558a0(0x129)][_0x1558a0(0xde)][0x0][_0x1558a0(0x12a)];}static async[_0x56e6f8(0xd9)](_0x4ebf46,_0xe937b7=ElementType[_0x56e6f8(0xec)],_0x11fbe9=0x0){const _0x433c44=_0x56e6f8,_0x1ed585={'VXkMa':function(_0x53f998,_0x43461a){return _0x53f998+_0x43461a;},'LxIoP':function(_0x4342bb,_0x1e77c4){return _0x4342bb===_0x1e77c4;}},_0x3383c6=await calculateFileMD5(_0x4ebf46);let _0x3c70ee=(await NTQQFileApi[_0x433c44(0xf9)](_0x4ebf46))?.[_0x433c44(0x115)]||'';_0x3c70ee&&(_0x3c70ee=_0x1ed585[_0x433c44(0x124)]('.',_0x3c70ee));let _0x2f06ff=''+_0xb8832b['basename'](_0x4ebf46);_0x1ed585[_0x433c44(0xf5)](_0x2f06ff[_0x433c44(0xfa)]('.'),-0x1)&&(_0x2f06ff+=_0x3c70ee);const _0xb20029=napCatCore[_0x433c44(0xdc)][_0x433c44(0x101)]()[_0x433c44(0xf0)]({'md5HexStr':_0x3383c6,'fileName':_0x2f06ff,'elementType':_0xe937b7,'elementSubType':_0x11fbe9,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x433c44(0xe8)](_0x4ebf46,_0xb20029);const _0x340e05=await NTQQFileApi[_0x433c44(0xfd)](_0x4ebf46);return{'md5':_0x3383c6,'fileName':_0x2f06ff,'path':_0xb20029,'fileSize':_0x340e05,'ext':_0x3c70ee};}static async[_0x56e6f8(0x112)](_0x3f3013,_0xec317d,_0x163428,_0x111b4e,_0x143ee9,_0x274ed8,_0x27277f=0x3e8*0x3c*0x2,_0x3113b1=![]){const _0xe9339=_0x56e6f8,_0x3408af={'dZnZo':function(_0x24b0bd,_0x18a58b){return _0x24b0bd(_0x18a58b);},'uOuNx':_0xe9339(0x12f),'mtxkc':function(_0x10af7b,_0x54ed3a){return _0x10af7b===_0x54ed3a;},'RKojW':function(_0x392189){return _0x392189();},'EPHAr':function(_0x3b1a1f,_0x27a0bd,_0x4cba9e){return _0x3b1a1f(_0x27a0bd,_0x4cba9e);}};if(_0x274ed8&&_0x18b381[_0xe9339(0x114)](_0x274ed8)){if(_0x3113b1)try{await _0x54e42d[_0xe9339(0xe6)](_0x274ed8);}catch(_0x51931b){}else return _0x274ed8;}return new Promise((_0xac1281,_0xc4ec2a)=>{const _0x290d2b=_0xe9339,_0x50a001={'uhwUc':function(_0x3e8637,_0x178cfa){return _0x3408af['mtxkc'](_0x3e8637,_0x178cfa);},'yZBjS':function(_0x540399,_0x43891b){return _0x540399(_0x43891b);}};let _0x5c081a=![];const _0x398771=_0x1576e6=>{const _0x3506e3=_0x1032;if(_0x50a001[_0x3506e3(0x100)](_0x1576e6[_0x3506e3(0x113)],_0x3f3013)){_0x5c081a=!![];let _0x15527b=_0x1576e6[_0x3506e3(0x11c)];if(_0x15527b[_0x3506e3(0x107)]('\x5c')){const _0x588647=sessionConfig[_0x3506e3(0x103)];_0x15527b=_0xb8832b[_0x3506e3(0x122)](_0x588647,_0x15527b);}_0x50a001[_0x3506e3(0xeb)](_0xac1281,_0x15527b);}};downloadMediaTasks['set'](_0x3408af[_0x290d2b(0x102)](randomUUID),_0x398771),_0x3408af[_0x290d2b(0x11a)](setTimeout,()=>{const _0x57bf9b=_0x290d2b;!_0x5c081a&&_0x3408af[_0x57bf9b(0x11f)](_0xc4ec2a,_0x3408af[_0x57bf9b(0x11d)]);},_0x27277f),napCatCore[_0x290d2b(0xdc)]['getMsgService']()[_0x290d2b(0x104)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3f3013,'chatType':_0xec317d,'peerUid':_0x163428,'elementId':_0x111b4e,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x143ee9});});}static async[_0x56e6f8(0xfc)](_0x47e242){const _0x234002={'fKWqF':function(_0x32746b,_0x53b2f2){return _0x32746b(_0x53b2f2);},'ZlmEz':function(_0x1ca258,_0x18e26e,_0x1cc60d){return _0x1ca258(_0x18e26e,_0x1cc60d);}};return new Promise((_0x175a58,_0x4f4f41)=>{const _0x3004ab=_0x1032,_0x3db546={'GBIqf':function(_0x3bd7b7,_0x419682){return _0x3bd7b7(_0x419682);},'apGSe':function(_0x47b1ad,_0x2540ef){return _0x234002['fKWqF'](_0x47b1ad,_0x2540ef);}};_0x234002[_0x3004ab(0xef)](_0x5a6a0c,_0x47e242,(_0x492515,_0x3ba4d1)=>{const _0x50cdd1=_0x3004ab;_0x492515?_0x3db546[_0x50cdd1(0x121)](_0x4f4f41,_0x492515):_0x3db546[_0x50cdd1(0xff)](_0x175a58,_0x3ba4d1);});});}static async[_0x56e6f8(0x126)](_0x38a2e1,_0x404458){const _0x54488d=_0x56e6f8,_0x46549b={'hCuOI':_0x54488d(0x105),'IDNCu':_0x54488d(0xe9),'CkDWq':function(_0x206c6e,_0x2859cc){return _0x206c6e+_0x2859cc;},'sgiNM':function(_0x15ad99,_0x45d6c2){return _0x15ad99+_0x45d6c2;},'COeSL':function(_0x48012d,_0x5e29bd){return _0x48012d+_0x5e29bd;},'CvjtC':function(_0x22c814,_0x4635c5){return _0x22c814+_0x4635c5;},'HQWKE':function(_0x2745b8,_0x4b4982){return _0x2745b8||_0x4b4982;},'qGSEK':function(_0x3dd6f5,_0x29a5be,_0x239787){return _0x3dd6f5(_0x29a5be,_0x239787);},'iGBvg':_0x54488d(0xe2)};if(!_0x38a2e1)return'';const _0x55391c=_0x38a2e1['originImageUrl'],_0x187951=_0x38a2e1[_0x54488d(0x11b)],_0x271900=_0x38a2e1['md5HexStr'],_0x55a5d1=_0x38a2e1['fileUuid'];if(_0x55391c){if(_0x55391c['startsWith'](_0x46549b[_0x54488d(0x12e)])){if(_0x55391c[_0x54488d(0x123)](_0x46549b[_0x54488d(0xdd)]))return _0x46549b[_0x54488d(0xf7)](IMAGE_HTTP_HOST_NT,_0x55391c);const _0x2d3e97=await rkeyManager[_0x54488d(0xe0)](),_0xf265e5=_0x404458?_0x2d3e97[_0x54488d(0x11e)]:_0x2d3e97['group_rkey'];return _0x46549b[_0x54488d(0xe3)](_0x46549b[_0x54488d(0xdb)](IMAGE_HTTP_HOST_NT,_0x55391c),''+_0xf265e5);}else return _0x46549b[_0x54488d(0x119)](IMAGE_HTTP_HOST,_0x55391c);}else{if(_0x271900||_0x187951)return IMAGE_HTTP_HOST+_0x54488d(0xed)+_0x46549b[_0x54488d(0x128)](_0x271900,_0x187951)[_0x54488d(0xf1)]()+'/0';}return _0x46549b[_0x54488d(0x118)](logDebug,_0x46549b['iGBvg'],_0x38a2e1),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x54c9c7=!![]){return'';}static[_0x56e6f8(0x12b)](){return'';}static[_0x56e6f8(0x110)](_0x1d81cc=[_0x56e6f8(0xf4),_0x56e6f8(0xee)]){const _0x5289c5=_0x56e6f8;return napCatCore['session']['getStorageCleanService']()[_0x5289c5(0xf3)](_0x1d81cc);}static[_0x56e6f8(0x10a)](_0x4997fc={}){const _0x2895f8=_0x56e6f8;return napCatCore[_0x2895f8(0xdc)]['getStorageCleanService']()[_0x2895f8(0x109)](_0x4997fc);}static[_0x56e6f8(0x10c)](){const _0xc45f6=_0x56e6f8;return napCatCore[_0xc45f6(0xdc)][_0xc45f6(0xdf)]()[_0xc45f6(0x10c)]();}static[_0x56e6f8(0xf8)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x56e6f8(0x111)](_0x2ef1e9,_0x34a9c5=0x3e8,_0x5d9c2f=0x0){const _0x5f0111=_0x56e6f8;return napCatCore[_0x5f0111(0xdc)]['getStorageCleanService']()['getChatCacheInfo'](_0x2ef1e9,_0x34a9c5,0x1,_0x5d9c2f);}static[_0x56e6f8(0x10d)](_0x330249,_0x4ae0f7=0x3e8,_0x14e958){const _0xfca345=_0x14e958?_0x14e958:{'fileType':_0x330249};}static async[_0x56e6f8(0xfb)](_0x29a50d=[],_0x2a808d=[]){const _0x5b1430=_0x56e6f8;return napCatCore['session'][_0x5b1430(0xdf)]()['clearChatCacheInfo'](_0x29a50d,_0x2a808d);}}