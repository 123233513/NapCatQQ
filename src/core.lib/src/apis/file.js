function _0x1d1e(_0x35b432,_0x259839){const _0x456c0a=_0x456c();return _0x1d1e=function(_0x1d1e49,_0x1cee59){_0x1d1e49=_0x1d1e49-0x9a;let _0x29e4d4=_0x456c0a[_0x1d1e49];return _0x29e4d4;},_0x1d1e(_0x35b432,_0x259839);}const _0x27f6e4=_0x1d1e;(function(_0x157853,_0x423560){const _0x21f7a9=_0x1d1e,_0x2c5b9c=_0x157853();while(!![]){try{const _0x5a855c=-parseInt(_0x21f7a9(0xd4))/0x1*(-parseInt(_0x21f7a9(0xa3))/0x2)+parseInt(_0x21f7a9(0xc8))/0x3+-parseInt(_0x21f7a9(0xbd))/0x4+parseInt(_0x21f7a9(0xd3))/0x5*(-parseInt(_0x21f7a9(0xbe))/0x6)+-parseInt(_0x21f7a9(0xa0))/0x7*(-parseInt(_0x21f7a9(0xab))/0x8)+-parseInt(_0x21f7a9(0xae))/0x9+-parseInt(_0x21f7a9(0xd7))/0xa;if(_0x5a855c===_0x423560)break;else _0x2c5b9c['push'](_0x2c5b9c['shift']());}catch(_0x23c919){_0x2c5b9c['push'](_0x2c5b9c['shift']());}}}(_0x456c,0xf05c0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x55cd7e from'path';import _0x49086d from'fs';import _0x10d05e from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x40040e from'file-type';import{MsgListener}from'@/core/listeners';function _0x456c(){const _0x132d61=['util','getVideoUrl','13573168DQpEGC','downloadRichMedia','clearCacheDataByKeys','1549174MfYyeo','scanCache','/gchatpic_new/0/0-0-','/download','PIC','set','ext','group_rkey','8kkTsnz','filePath','toUpperCase','8461359UxrbuY','图片url获取失败','startsWith','getRichMediaFilePathForGuild','getDesktopTmpPath','basename','getChatCacheList','getImageUrl','getFileSize','elementId','getHotUpdateCachePath','addCacheScannedPaths','msgId','getVideoPlayUrlV2','copyFile','3506528MjtUbb','6wyddfY','domainUrl','onLoginSuccess','getFileType','addCacheScanedPaths','setCacheSilentScan','nnnJa','delete','urlResult','tmp','4914312PLIjeb','getStorageCleanService','下载超时','mtrZU','existsSync','ykGlN','WutwN','getImageSize','VMkhI','hotUpdate','clearChatCacheInfo','1826155mKRFWT','1EUgyba','downloadMedia','CpvVx','11851890nTdHMO','md5HexStr','getMsgService','session','defaultFileDownloadPath','fileUuid','KiaOP','addListener','getRichMediaService','join','includes','qExhT','clearChatCache','FxGdN','private_rkey','uploadFile','fileTypeFromFile','&rkey='];_0x456c=function(){return _0x132d61;};return _0x456c();}import _0x58dcdd from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x3a39cc=>{const _0x2ad0f9=_0x1d1e,_0x2c00cc={'CpvVx':function(_0x3e9ef9,_0x52dc2c){return _0x3e9ef9(_0x52dc2c);}};for(const [_0xeac528,_0x2f247e]of downloadMediaTasks){_0x2c00cc[_0x2ad0f9(0xd6)](_0x2f247e,_0x3a39cc),downloadMediaTasks[_0x2ad0f9(0xc5)](_0xeac528);}},setTimeout(()=>{const _0x3aca35=_0x1d1e;napCatCore[_0x3aca35(0xc0)](()=>{const _0xf0c73b=_0x3aca35;napCatCore[_0xf0c73b(0xde)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x27f6e4(0xc1)](_0xc3254d){const _0x229174=_0x27f6e4;return _0x40040e[_0x229174(0x9c)](_0xc3254d);}static async['copyFile'](_0x540b8f,_0x4a5b81){const _0x2aa70d=_0x27f6e4;await napCatCore[_0x2aa70d(0x9e)][_0x2aa70d(0xbc)](_0x540b8f,_0x4a5b81);}static async['getFileSize'](_0x2f4a66){const _0x506cb0=_0x27f6e4;return await napCatCore['util'][_0x506cb0(0xb6)](_0x2f4a66);}static async[_0x27f6e4(0x9f)](_0x43d509,_0x20f3da){const _0x22fdee=_0x27f6e4;return(await napCatCore[_0x22fdee(0xda)][_0x22fdee(0xdf)]()[_0x22fdee(0xbb)]({'chatType':_0x43d509['chatType'],'peerUid':_0x43d509['peerUid'],'guildId':'0'},_0x43d509[_0x22fdee(0xba)],_0x20f3da[_0x22fdee(0xb7)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x22fdee(0xc6)][_0x22fdee(0xbf)][0x0]['url'];}static async[_0x27f6e4(0x9b)](_0x4886ce,_0x3b19e1=ElementType[_0x27f6e4(0xa7)],_0x2030d9=0x0){const _0x2502b0=_0x27f6e4,_0x219535={'ykGlN':function(_0x50b2b4,_0x5c09c0){return _0x50b2b4(_0x5c09c0);},'FxGdN':function(_0x295ddb,_0x512d22){return _0x295ddb+_0x512d22;},'IAptz':function(_0x1e9ed7,_0x54d664){return _0x1e9ed7===_0x54d664;}},_0x23be88=await _0x219535[_0x2502b0(0xcd)](calculateFileMD5,_0x4886ce);let _0x2acb59=(await NTQQFileApi[_0x2502b0(0xc1)](_0x4886ce))?.[_0x2502b0(0xa9)]||'';_0x2acb59&&(_0x2acb59=_0x219535[_0x2502b0(0xe4)]('.',_0x2acb59));let _0x3480a6=''+_0x55cd7e[_0x2502b0(0xb3)](_0x4886ce);_0x219535['IAptz'](_0x3480a6['indexOf']('.'),-0x1)&&(_0x3480a6+=_0x2acb59);const _0x308add=napCatCore[_0x2502b0(0xda)][_0x2502b0(0xd9)]()[_0x2502b0(0xb1)]({'md5HexStr':_0x23be88,'fileName':_0x3480a6,'elementType':_0x3b19e1,'elementSubType':_0x2030d9,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x4886ce,_0x308add);const _0x31bb72=await NTQQFileApi['getFileSize'](_0x4886ce);return{'md5':_0x23be88,'fileName':_0x3480a6,'path':_0x308add,'fileSize':_0x31bb72,'ext':_0x2acb59};}static async[_0x27f6e4(0xd5)](_0x5a89a1,_0x2658ec,_0x25dea7,_0x37534b,_0x4e8b37,_0x26fb8d,_0xbd5580=0x3e8*0x3c*0x2,_0x36455c=![]){const _0x6b7b1d=_0x27f6e4,_0xcf1f76={'dERkc':function(_0x3f5722,_0x1d1ccb){return _0x3f5722===_0x1d1ccb;},'VMkhI':function(_0x45a487){return _0x45a487();}};if(_0x26fb8d&&_0x49086d[_0x6b7b1d(0xcc)](_0x26fb8d)){if(_0x36455c)try{await _0x10d05e['unlink'](_0x26fb8d);}catch(_0x294dd9){}else return _0x26fb8d;}return new Promise((_0x4ce84a,_0x33d3b5)=>{const _0xcdaf33=_0x6b7b1d,_0x2d5929={'LLPRJ':function(_0x2ed9bb,_0x5d08d9){return _0xcf1f76['dERkc'](_0x2ed9bb,_0x5d08d9);},'qExhT':function(_0x8115e3,_0x1e595a){return _0x8115e3(_0x1e595a);}};let _0x166bac=![];const _0xd04bce=_0x12d3ab=>{const _0x43ef6a=_0x1d1e;if(_0x2d5929['LLPRJ'](_0x12d3ab[_0x43ef6a(0xba)],_0x5a89a1)){_0x166bac=!![];let _0x14aaa0=_0x12d3ab[_0x43ef6a(0xac)];if(_0x14aaa0['startsWith']('\x5c')){const _0x2fe0bb=sessionConfig[_0x43ef6a(0xdb)];_0x14aaa0=_0x55cd7e[_0x43ef6a(0xe0)](_0x2fe0bb,_0x14aaa0);}_0x2d5929[_0x43ef6a(0xe2)](_0x4ce84a,_0x14aaa0);}};downloadMediaTasks[_0xcdaf33(0xa8)](_0xcf1f76[_0xcdaf33(0xd0)](randomUUID),_0xd04bce),setTimeout(()=>{const _0x4535d8=_0xcdaf33;!_0x166bac&&_0x33d3b5(_0x4535d8(0xca));},_0xbd5580),napCatCore[_0xcdaf33(0xda)][_0xcdaf33(0xd9)]()[_0xcdaf33(0xa1)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x5a89a1,'chatType':_0x2658ec,'peerUid':_0x25dea7,'elementId':_0x37534b,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4e8b37});});}static async[_0x27f6e4(0xcf)](_0x3a86fa){const _0x1c35d3={'mNktO':function(_0x3a0e96,_0x5884b6){return _0x3a0e96(_0x5884b6);},'hIJBV':function(_0xb96c42,_0x1462fc,_0x3c8c6c){return _0xb96c42(_0x1462fc,_0x3c8c6c);}};return new Promise((_0x5f0808,_0x2c98f9)=>{_0x1c35d3['hIJBV'](_0x58dcdd,_0x3a86fa,(_0x56f9c3,_0x1276b5)=>{_0x56f9c3?_0x2c98f9(_0x56f9c3):_0x1c35d3['mNktO'](_0x5f0808,_0x1276b5);});});}static async[_0x27f6e4(0xb5)](_0x5e0fd0,_0x12b217){const _0x5cf37a=_0x27f6e4,_0x236c16={'KiaOP':_0x5cf37a(0xa6),'LqYzM':_0x5cf37a(0x9d),'WutwN':function(_0x41454a,_0x23d7c9){return _0x41454a+_0x23d7c9;},'Wgdtd':function(_0x1bac27,_0x7415de){return _0x1bac27||_0x7415de;},'mtrZU':function(_0x582346,_0x2fe47b){return _0x582346||_0x2fe47b;},'nnnJa':function(_0x445945,_0x136c47,_0x4c9670){return _0x445945(_0x136c47,_0x4c9670);}};if(!_0x5e0fd0)return'';const _0x3e300b=_0x5e0fd0['originImageUrl'],_0x18f746=_0x5e0fd0[_0x5cf37a(0xd8)],_0x5b2ee9=_0x5e0fd0[_0x5cf37a(0xd8)],_0x4f034e=_0x5e0fd0[_0x5cf37a(0xdc)];if(_0x3e300b){if(_0x3e300b[_0x5cf37a(0xb0)](_0x236c16[_0x5cf37a(0xdd)])){if(_0x3e300b[_0x5cf37a(0xe1)](_0x236c16['LqYzM']))return _0x236c16[_0x5cf37a(0xce)](IMAGE_HTTP_HOST_NT,_0x3e300b);const _0x445378=await rkeyManager['getRkey'](),_0x18b5f1=_0x12b217?_0x445378[_0x5cf37a(0x9a)]:_0x445378[_0x5cf37a(0xaa)];return _0x236c16[_0x5cf37a(0xce)](IMAGE_HTTP_HOST_NT,_0x3e300b)+(''+_0x18b5f1);}else return IMAGE_HTTP_HOST+_0x3e300b;}else{if(_0x236c16['Wgdtd'](_0x5b2ee9,_0x18f746))return IMAGE_HTTP_HOST+_0x5cf37a(0xa5)+_0x236c16[_0x5cf37a(0xcb)](_0x5b2ee9,_0x18f746)[_0x5cf37a(0xad)]()+'/0';}return _0x236c16[_0x5cf37a(0xc4)](logDebug,_0x5cf37a(0xaf),_0x5e0fd0),'';}}export class NTQQFileCacheApi{static async[_0x27f6e4(0xc3)](_0x1e6270=!![]){return'';}static['getCacheSessionPathList'](){return'';}static['clearCache'](_0x4fb8f9=[_0x27f6e4(0xc7),_0x27f6e4(0xd1)]){const _0x57be38=_0x27f6e4;return napCatCore['session'][_0x57be38(0xc9)]()[_0x57be38(0xa2)](_0x4fb8f9);}static[_0x27f6e4(0xb9)](_0x1ce39c={}){const _0x17b814=_0x27f6e4;return napCatCore[_0x17b814(0xda)][_0x17b814(0xc9)]()[_0x17b814(0xc2)](_0x1ce39c);}static[_0x27f6e4(0xa4)](){const _0x390903=_0x27f6e4;return napCatCore[_0x390903(0xda)][_0x390903(0xc9)]()[_0x390903(0xa4)]();}static[_0x27f6e4(0xb8)](){return'';}static[_0x27f6e4(0xb2)](){return'';}static[_0x27f6e4(0xb4)](_0x3a7a75,_0x220764=0x3e8,_0x2e7a64=0x0){const _0x84e4a6=_0x27f6e4;return napCatCore[_0x84e4a6(0xda)][_0x84e4a6(0xc9)]()['getChatCacheInfo'](_0x3a7a75,_0x220764,0x1,_0x2e7a64);}static['getFileCacheInfo'](_0x54413b,_0x2687b9=0x3e8,_0x368837){const _0x4131e4=_0x368837?_0x368837:{'fileType':_0x54413b};}static async[_0x27f6e4(0xe3)](_0x5e5717=[],_0x27fa76=[]){const _0x415fe8=_0x27f6e4;return napCatCore['session'][_0x415fe8(0xc9)]()[_0x415fe8(0xd2)](_0x5e5717,_0x27fa76);}}