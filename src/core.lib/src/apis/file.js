const _0x3eee21=_0x1ed3;(function(_0x17577,_0x3e1e44){const _0x22a0cf=_0x1ed3,_0x3c7808=_0x17577();while(!![]){try{const _0x17c464=-parseInt(_0x22a0cf(0x194))/0x1*(parseInt(_0x22a0cf(0x185))/0x2)+-parseInt(_0x22a0cf(0x199))/0x3*(parseInt(_0x22a0cf(0x19a))/0x4)+-parseInt(_0x22a0cf(0x1af))/0x5+parseInt(_0x22a0cf(0x18c))/0x6+parseInt(_0x22a0cf(0x1ae))/0x7*(-parseInt(_0x22a0cf(0x1a5))/0x8)+-parseInt(_0x22a0cf(0x17c))/0x9*(-parseInt(_0x22a0cf(0x1b6))/0xa)+parseInt(_0x22a0cf(0x1b3))/0xb*(parseInt(_0x22a0cf(0x189))/0xc);if(_0x17c464===_0x3e1e44)break;else _0x3c7808['push'](_0x3c7808['shift']());}catch(_0x2e7a19){_0x3c7808['push'](_0x3c7808['shift']());}}}(_0x48e3,0x5cc58));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x4f51af from'path';import _0x3b66f2 from'fs';import _0x8c4ff3 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x161918 from'file-type';import{MsgListener}from'@/core/listeners';import _0x1cbabd from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';function _0x1ed3(_0x42eb35,_0x2e3688){const _0x48e378=_0x48e3();return _0x1ed3=function(_0x1ed396,_0x45b1ae){_0x1ed396=_0x1ed396-0x17b;let _0x4121c2=_0x48e378[_0x1ed396];return _0x4121c2;},_0x1ed3(_0x42eb35,_0x2e3688);}function _0x48e3(){const _0x16ee31=['set','243308opexOV','PIC','XYsVP','dLBLJ','getFileCacheInfo','15ziDbBo','276028WLWiev','/download','copyFile','ext','getDesktopTmpPath','tmp','onLoginSuccess','VVRBk','clearChatCache','getHotUpdateCachePath','setCacheSilentScan','640pjwmLu','indexOf','getStorageCleanService','defaultFileDownloadPath','basename','getFileSize','downloadMedia','fileTypeFromFile','addCacheScannedPaths','40600xUlVfO','1106840jgPjoO','unlink','session','IJjmA','6636839miDprI','lvSBs','downloadRichMedia','1203200SucaWP','private_rkey','getMsgService','includes','util','wLdpK','toUpperCase','qZhFM','onRichMediaDownloadComplete','uploadFile','getRichMediaFilePathForGuild','getImageUrl','18tPFpzV','imFpH','图片url获取失败','join','getImageSize','ilnTD','NjLUA','getFileType','scanCache','2BOMowe','wQbXi','filePath','&rkey=','24LiqLWm','gjkIy','ImnJT','1238190UasYfQ','startsWith','delete','SSZvz','clearCache','group_rkey','clearChatCacheInfo'];_0x48e3=function(){return _0x16ee31;};return _0x48e3();}import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x3eee21(0x1be)]=_0x3bf32e=>{const _0x3fd97d=_0x3eee21,_0x2287a2={'icgBn':function(_0x10aca4,_0x3c96bb){return _0x10aca4(_0x3c96bb);}};for(const [_0x158b8a,_0x1d448b]of downloadMediaTasks){_0x2287a2['icgBn'](_0x1d448b,_0x3bf32e),downloadMediaTasks[_0x3fd97d(0x18e)](_0x158b8a);}},setTimeout(()=>{const _0x582c9f=_0x3eee21;napCatCore[_0x582c9f(0x1a0)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x3eee21(0x183)](_0x3b1146){const _0x25bd8e=_0x3eee21;return _0x161918[_0x25bd8e(0x1ac)](_0x3b1146);}static async[_0x3eee21(0x19c)](_0x2ffcbb,_0xdc4e56){const _0x4878e2=_0x3eee21;await napCatCore[_0x4878e2(0x1ba)][_0x4878e2(0x19c)](_0x2ffcbb,_0xdc4e56);}static async['getFileSize'](_0x61c96f){return await napCatCore['util']['getFileSize'](_0x61c96f);}static async[_0x3eee21(0x1bf)](_0x34579e,_0x3109d2=ElementType[_0x3eee21(0x195)],_0x4805a7=0x0){const _0x811afb=_0x3eee21,_0x4f982a={'wLdpK':function(_0x2e3372,_0x2b7df4){return _0x2e3372(_0x2b7df4);},'imFpH':function(_0x2b0954,_0x5e85a1){return _0x2b0954+_0x5e85a1;},'dLBLJ':function(_0x3cd727,_0x3e60e2){return _0x3cd727===_0x3e60e2;}},_0x44f702=await _0x4f982a[_0x811afb(0x1bb)](calculateFileMD5,_0x34579e);let _0x31268e=(await NTQQFileApi['getFileType'](_0x34579e))?.[_0x811afb(0x19d)]||'';_0x31268e&&(_0x31268e=_0x4f982a[_0x811afb(0x17d)]('.',_0x31268e));let _0x3e4578=''+_0x4f51af[_0x811afb(0x1a9)](_0x34579e);_0x4f982a[_0x811afb(0x197)](_0x3e4578[_0x811afb(0x1a6)]('.'),-0x1)&&(_0x3e4578+=_0x31268e);const _0x4e8316=napCatCore['session'][_0x811afb(0x1b8)]()[_0x811afb(0x1c0)]({'md5HexStr':_0x44f702,'fileName':_0x3e4578,'elementType':_0x3109d2,'elementSubType':_0x4805a7,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x811afb(0x19c)](_0x34579e,_0x4e8316);const _0x314f26=await NTQQFileApi[_0x811afb(0x1aa)](_0x34579e);return{'md5':_0x44f702,'fileName':_0x3e4578,'path':_0x4e8316,'fileSize':_0x314f26,'ext':_0x31268e};}static async[_0x3eee21(0x1ab)](_0x2f1a1e,_0x4f584d,_0x34ee7a,_0x5c98e4,_0x3bc78b,_0x339386,_0x19fb7b=0x3e8*0x3c*0x2,_0x5da9e3=![]){const _0x128757=_0x3eee21,_0x4610cb={'qZhFM':function(_0x2f1ac7,_0x5f5bf6){return _0x2f1ac7(_0x5f5bf6);},'gjkIy':'下载超时','SSZvz':function(_0x475331){return _0x475331();},'iTrDg':function(_0x476194,_0x4b3284,_0x267ac3){return _0x476194(_0x4b3284,_0x267ac3);}};if(_0x339386&&_0x3b66f2['existsSync'](_0x339386)){if(_0x5da9e3)try{await _0x8c4ff3[_0x128757(0x1b0)](_0x339386);}catch(_0x3b7a3b){}else return _0x339386;}return new Promise((_0x38d086,_0xd29b9d)=>{const _0x6a3317=_0x128757;let _0x591858=![];const _0x13f285=_0x41ac5d=>{const _0x43ee85=_0x1ed3;if(_0x41ac5d['msgId']===_0x2f1a1e){_0x591858=!![];let _0x379834=_0x41ac5d[_0x43ee85(0x187)];if(_0x379834[_0x43ee85(0x18d)]('\x5c')){const _0x1dd1c2=sessionConfig[_0x43ee85(0x1a8)];_0x379834=_0x4f51af[_0x43ee85(0x17f)](_0x1dd1c2,_0x379834);}_0x38d086(_0x379834);}};downloadMediaTasks[_0x6a3317(0x193)](_0x4610cb[_0x6a3317(0x18f)](randomUUID),_0x13f285),_0x4610cb['iTrDg'](setTimeout,()=>{const _0x193511=_0x6a3317;!_0x591858&&_0x4610cb[_0x193511(0x1bd)](_0xd29b9d,_0x4610cb[_0x193511(0x18a)]);},_0x19fb7b),napCatCore[_0x6a3317(0x1b1)][_0x6a3317(0x1b8)]()[_0x6a3317(0x1b5)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x2f1a1e,'chatType':_0x4f584d,'peerUid':_0x34ee7a,'elementId':_0x5c98e4,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3bc78b});});}static async[_0x3eee21(0x180)](_0x23f6ef){const _0x4e766b={'ImnJT':function(_0x34ae83,_0x1e0b31){return _0x34ae83(_0x1e0b31);},'VVRBk':function(_0x1c1f97,_0x1c50d7,_0x4cbc9e){return _0x1c1f97(_0x1c50d7,_0x4cbc9e);}};return new Promise((_0x32f7a4,_0x107375)=>{const _0x70ab2a=_0x1ed3,_0x478e1c={'mygVi':function(_0x7b9e69,_0x11a4a8){const _0x1b5247=_0x1ed3;return _0x4e766b[_0x1b5247(0x18b)](_0x7b9e69,_0x11a4a8);},'wQbXi':function(_0x5248e9,_0x385dea){const _0x4bc748=_0x1ed3;return _0x4e766b[_0x4bc748(0x18b)](_0x5248e9,_0x385dea);}};_0x4e766b[_0x70ab2a(0x1a1)](_0x1cbabd,_0x23f6ef,(_0x4b1d37,_0xe4c8a6)=>{const _0x2268bd=_0x70ab2a;_0x4b1d37?_0x478e1c['mygVi'](_0x107375,_0x4b1d37):_0x478e1c[_0x2268bd(0x186)](_0x32f7a4,_0xe4c8a6);});});}static async[_0x3eee21(0x17b)](_0x15c975,_0x538628){const _0x47c7a=_0x3eee21,_0x314f03={'lvSBs':_0x47c7a(0x188),'NjLUA':function(_0x6a5d2a,_0x5215e0){return _0x6a5d2a+_0x5215e0;},'XYsVP':function(_0x5efd6d,_0x4eb794){return _0x5efd6d+_0x4eb794;},'ilnTD':function(_0x65d47c,_0x5752ae){return _0x65d47c+_0x5752ae;},'IJjmA':function(_0x9d5dfa,_0x405ea9){return _0x9d5dfa||_0x405ea9;},'Koczx':_0x47c7a(0x17e)};if(!_0x15c975)return'';const _0x495f02=_0x15c975['originImageUrl'],_0x1b1989=_0x15c975['md5HexStr'],_0x2849a3=_0x15c975['md5HexStr'],_0x5a4e75=_0x15c975['fileUuid'];if(_0x495f02){if(_0x495f02['startsWith'](_0x47c7a(0x19b))){if(_0x495f02[_0x47c7a(0x1b9)](_0x314f03[_0x47c7a(0x1b4)]))return _0x314f03[_0x47c7a(0x182)](IMAGE_HTTP_HOST_NT,_0x495f02);const _0x5cb186=await rkeyManager['getRkey'](),_0x130366=_0x538628?_0x5cb186[_0x47c7a(0x1b7)]:_0x5cb186[_0x47c7a(0x191)];return _0x314f03[_0x47c7a(0x196)](_0x314f03[_0x47c7a(0x181)](IMAGE_HTTP_HOST_NT,_0x495f02),''+_0x130366);}else return _0x314f03[_0x47c7a(0x182)](IMAGE_HTTP_HOST,_0x495f02);}else{if(_0x314f03[_0x47c7a(0x1b2)](_0x2849a3,_0x1b1989))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+(_0x2849a3||_0x1b1989)[_0x47c7a(0x1bc)]()+'/0';}return logDebug(_0x314f03['Koczx'],_0x15c975),'';}}export class NTQQFileCacheApi{static async[_0x3eee21(0x1a4)](_0x25c57f=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x3eee21(0x190)](_0x21b93c=[_0x3eee21(0x19f),'hotUpdate']){const _0x326774=_0x3eee21;return napCatCore['session'][_0x326774(0x1a7)]()['clearCacheDataByKeys'](_0x21b93c);}static[_0x3eee21(0x1ad)](_0x143718={}){const _0x255d91=_0x3eee21;return napCatCore['session'][_0x255d91(0x1a7)]()['addCacheScanedPaths'](_0x143718);}static[_0x3eee21(0x184)](){const _0x4cc55c=_0x3eee21;return napCatCore['session'][_0x4cc55c(0x1a7)]()[_0x4cc55c(0x184)]();}static[_0x3eee21(0x1a3)](){return'';}static[_0x3eee21(0x19e)](){return'';}static['getChatCacheList'](_0x3f2fb4,_0x2f684c=0x3e8,_0x1cea15=0x0){const _0x12632d=_0x3eee21;return napCatCore[_0x12632d(0x1b1)][_0x12632d(0x1a7)]()['getChatCacheInfo'](_0x3f2fb4,_0x2f684c,0x1,_0x1cea15);}static[_0x3eee21(0x198)](_0x25eeb4,_0x50245d=0x3e8,_0x16fbf7){const _0x9fda77=_0x16fbf7?_0x16fbf7:{'fileType':_0x25eeb4};}static async[_0x3eee21(0x1a2)](_0x249e99=[],_0x3ec88a=[]){const _0x5dd1f3=_0x3eee21;return napCatCore[_0x5dd1f3(0x1b1)][_0x5dd1f3(0x1a7)]()[_0x5dd1f3(0x192)](_0x249e99,_0x3ec88a);}}