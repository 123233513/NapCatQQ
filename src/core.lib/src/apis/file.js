const _0x32b2f7=_0x1fd2;(function(_0xee0515,_0x240b66){const _0x328ae7=_0x1fd2,_0x18e3f4=_0xee0515();while(!![]){try{const _0x4db58a=-parseInt(_0x328ae7(0x123))/0x1*(-parseInt(_0x328ae7(0x14a))/0x2)+-parseInt(_0x328ae7(0x163))/0x3+parseInt(_0x328ae7(0x13c))/0x4*(parseInt(_0x328ae7(0x131))/0x5)+parseInt(_0x328ae7(0x12e))/0x6*(parseInt(_0x328ae7(0x13a))/0x7)+-parseInt(_0x328ae7(0x134))/0x8*(parseInt(_0x328ae7(0x156))/0x9)+parseInt(_0x328ae7(0x15f))/0xa*(-parseInt(_0x328ae7(0x162))/0xb)+-parseInt(_0x328ae7(0x167))/0xc;if(_0x4db58a===_0x240b66)break;else _0x18e3f4['push'](_0x18e3f4['shift']());}catch(_0x42c51e){_0x18e3f4['push'](_0x18e3f4['shift']());}}}(_0x3c0c,0x253b0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x5f2bd2 from'path';import _0x367e4d from'fs';import _0x238df6 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0x3c0c(){const _0x44904b=['md5HexStr','wlGZU','getCacheSessionPathList','getFileType','getStorageCleanService','includes','120070GXPhjS','getRkey','kzQvd','88Htlqom','312039vtJNQi','lxmje','下载超时','downloadPath','1208148Xqnakk','nspXO','/download','&rkey=','util','XXsgn','getRichMediaFilePathForGuild','clearCacheDataByKeys','xZrxQ','addListener','downloadRichMedia','receive\x20downloadMedia\x20task','session','fileUuid','14QxXVZE','getFileSize','originImageUrl','addCacheScanedPaths','addCacheScannedPaths','LKXts','ruLbI','prmkp','copyFile','getImageSize','getChatCacheList','10338aObGCJ','aDmlP','wiWWB','67680OmevTR','tmp','PbOpp','129240AuYKLy','/gchatpic_new/0/0-0-','ext','gIbwG','defaultFileDownloadPath','lTFGT','105QZmGkJ','mmszx','80VIAItS','srWLw','hotUpdate','toUpperCase','getMsgService','fileTypeFromFile','delete','YwcBX','indexOf','图片url获取失败','set','PIC','private_rkey','join','33922VqWZng','scanCache','existsSync','clearChatCache','clearCache','basename','msgId','getChatCacheInfo','startsWith','onRichMediaDownloadComplete','start\x20downloadMedia','mYDQz','45cjlkDt','setCacheSilentScan','getDesktopTmpPath'];_0x3c0c=function(){return _0x44904b;};return _0x3c0c();}import*as _0x1cbe1a from'file-type';import{MsgListener}from'@/core/listeners';import _0x4927b9 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x1fd2(_0x48a4eb,_0x3faf4b){const _0x3c0cb7=_0x3c0c();return _0x1fd2=function(_0x1fd22c,_0x451348){_0x1fd22c=_0x1fd22c-0x11a;let _0x1b2266=_0x3c0cb7[_0x1fd22c];return _0x1b2266;},_0x1fd2(_0x48a4eb,_0x3faf4b);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x32b2f7(0x153)]=_0x1b3bd4=>{const _0x2a1c4e=_0x32b2f7,_0x17958c={'wiWWB':function(_0x4a50ab,_0x2cd841){return _0x4a50ab(_0x2cd841);}};for(const [_0x3d7e00,_0x393a5c]of downloadMediaTasks){_0x17958c[_0x2a1c4e(0x130)](_0x393a5c,_0x1b3bd4),downloadMediaTasks[_0x2a1c4e(0x142)](_0x3d7e00);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0xb93150=_0x1fd2;napCatCore[_0xb93150(0x11e)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x411497){const _0x378a3c=_0x32b2f7;return _0x1cbe1a[_0x378a3c(0x141)](_0x411497);}static async[_0x32b2f7(0x12b)](_0x4175a9,_0x27a3fd){const _0x599067=_0x32b2f7;await napCatCore[_0x599067(0x16b)][_0x599067(0x12b)](_0x4175a9,_0x27a3fd);}static async['getFileSize'](_0x3b5f56){const _0xc0cb34=_0x32b2f7;return await napCatCore[_0xc0cb34(0x16b)][_0xc0cb34(0x124)](_0x3b5f56);}static async['uploadFile'](_0x46fc17,_0x41cc8d=ElementType[_0x32b2f7(0x147)],_0xaa54bd=0x0){const _0x413cb9=_0x32b2f7,_0x428794={'aDmlP':function(_0x306a04,_0x2e0926){return _0x306a04(_0x2e0926);},'gIbwG':function(_0x35b8db,_0x5e2f84){return _0x35b8db+_0x5e2f84;},'YwcBX':function(_0x1b8331,_0x37412c){return _0x1b8331===_0x37412c;}},_0x315861=await _0x428794[_0x413cb9(0x12f)](calculateFileMD5,_0x46fc17);let _0x200e1d=(await NTQQFileApi[_0x413cb9(0x15c)](_0x46fc17))?.[_0x413cb9(0x136)]||'';_0x200e1d&&(_0x200e1d=_0x428794[_0x413cb9(0x137)]('.',_0x200e1d));let _0x18020f=''+_0x5f2bd2[_0x413cb9(0x14f)](_0x46fc17);_0x428794[_0x413cb9(0x143)](_0x18020f[_0x413cb9(0x144)]('.'),-0x1)&&(_0x18020f+=_0x200e1d);const _0x4c4509=napCatCore[_0x413cb9(0x121)][_0x413cb9(0x140)]()[_0x413cb9(0x11b)]({'md5HexStr':_0x315861,'fileName':_0x18020f,'elementType':_0x41cc8d,'elementSubType':_0xaa54bd,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x46fc17,_0x4c4509);const _0x383df0=await NTQQFileApi[_0x413cb9(0x124)](_0x46fc17);return{'md5':_0x315861,'fileName':_0x18020f,'path':_0x4c4509,'fileSize':_0x383df0,'ext':_0x200e1d};}static async['downloadMedia'](_0x158ca8,_0xb59034,_0x1f1f2a,_0x5586b3,_0x3d69f1,_0x47e3c0,_0x522d8d=0x3e8*0x3c*0x2,_0x4ae54a=![]){const _0x1dc1af=_0x32b2f7,_0x11623e={'lTFGT':function(_0x5523ca,_0x31ac82,_0x448e85,_0x2a1f1e){return _0x5523ca(_0x31ac82,_0x448e85,_0x2a1f1e);},'ruLbI':'downloadMedia\x20complete','WXogS':function(_0x39d7b1,_0xab223b){return _0x39d7b1===_0xab223b;},'XXsgn':_0x1dc1af(0x166),'xZrxQ':function(_0x3c6ce7,_0x13ff42){return _0x3c6ce7(_0x13ff42);},'LKXts':function(_0x5a58ba,_0x3f9e01){return _0x5a58ba(_0x3f9e01);},'kzQvd':_0x1dc1af(0x165),'srWLw':function(_0x2b495a){return _0x2b495a();},'MSioF':function(_0x48edd5,_0x49718b,_0xad2012){return _0x48edd5(_0x49718b,_0xad2012);},'lxmje':function(_0x2ba989,_0x161efa,_0x2c2ad7,_0x518ecb,_0xde7849,_0x59c034,_0x4ad64d,_0x10e0a9,_0x248bb7,_0x946f53){return _0x2ba989(_0x161efa,_0x2c2ad7,_0x518ecb,_0xde7849,_0x59c034,_0x4ad64d,_0x10e0a9,_0x248bb7,_0x946f53);},'mmszx':_0x1dc1af(0x120),'gUfiI':_0x1dc1af(0x154)};_0x11623e[_0x1dc1af(0x164)](logDebug,_0x11623e[_0x1dc1af(0x13b)],_0x158ca8,_0xb59034,_0x1f1f2a,_0x5586b3,_0x3d69f1,_0x47e3c0,_0x522d8d,_0x4ae54a);if(_0x47e3c0&&_0x367e4d[_0x1dc1af(0x14c)](_0x47e3c0)){if(_0x4ae54a)try{await _0x238df6['unlink'](_0x47e3c0);}catch(_0xc8097){}else return _0x47e3c0;}return logDebug(_0x11623e['gUfiI'],_0x158ca8,_0xb59034,_0x1f1f2a,_0x5586b3,_0x3d69f1,_0x47e3c0,_0x522d8d,_0x4ae54a),new Promise((_0x43550a,_0x2495d1)=>{const _0x4c328c=_0x1dc1af;let _0x5cc997=![];const _0x12bd35=_0x14b253=>{const _0x56d8dd=_0x1fd2;_0x11623e[_0x56d8dd(0x139)](logDebug,_0x11623e[_0x56d8dd(0x129)],_0x14b253,_0x158ca8);if(_0x11623e['WXogS'](_0x14b253[_0x56d8dd(0x150)],_0x158ca8)){_0x5cc997=!![];let _0x1d9b72=_0x14b253['filePath'];if(_0x1d9b72[_0x56d8dd(0x152)]('\x5c')){const _0x58e135=sessionConfig[_0x56d8dd(0x138)];logDebug(_0x11623e[_0x56d8dd(0x11a)],_0x58e135),_0x1d9b72=_0x5f2bd2[_0x56d8dd(0x149)](_0x58e135,_0x1d9b72);}_0x11623e[_0x56d8dd(0x11d)](_0x43550a,_0x1d9b72);}};downloadMediaTasks[_0x4c328c(0x146)](_0x11623e[_0x4c328c(0x13d)](randomUUID),_0x12bd35),_0x11623e['MSioF'](setTimeout,()=>{const _0x2c87c2=_0x4c328c;!_0x5cc997&&_0x11623e[_0x2c87c2(0x128)](_0x2495d1,_0x11623e[_0x2c87c2(0x161)]);},_0x522d8d),napCatCore[_0x4c328c(0x121)][_0x4c328c(0x140)]()[_0x4c328c(0x11f)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x158ca8,'chatType':_0xb59034,'peerUid':_0x1f1f2a,'elementId':_0x5586b3,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3d69f1});});}static async[_0x32b2f7(0x12c)](_0x1a7e9f){const _0x20aff9={'mYDQz':function(_0x47aab5,_0x32a70e,_0x270a89){return _0x47aab5(_0x32a70e,_0x270a89);}};return new Promise((_0x8fea43,_0x51e555)=>{const _0x4e094b=_0x1fd2,_0x3884e3={'SBNlq':function(_0x57cefc,_0x57734c){return _0x57cefc(_0x57734c);}};_0x20aff9[_0x4e094b(0x155)](_0x4927b9,_0x1a7e9f,(_0x2e2dd2,_0x405c8c)=>{_0x2e2dd2?_0x3884e3['SBNlq'](_0x51e555,_0x2e2dd2):_0x8fea43(_0x405c8c);});});}static async['getImageUrl'](_0x3b81a0,_0xfb8681){const _0x186dca=_0x32b2f7,_0x1e7a5d={'prmkp':_0x186dca(0x169),'PbOpp':function(_0x30e618,_0xa827df){return _0x30e618+_0xa827df;},'vxIex':function(_0x202c51,_0x1a06f4){return _0x202c51+_0x1a06f4;},'QgDys':function(_0x15c4ee,_0x5c17c9){return _0x15c4ee||_0x5c17c9;},'qzXea':function(_0x26d6fd,_0x57cbcb){return _0x26d6fd||_0x57cbcb;},'wlGZU':function(_0x355d57,_0x323b18,_0x29fcf9){return _0x355d57(_0x323b18,_0x29fcf9);},'nspXO':_0x186dca(0x145)};if(!_0x3b81a0)return'';const _0x5275af=_0x3b81a0[_0x186dca(0x125)],_0xfaa584=_0x3b81a0[_0x186dca(0x159)],_0x90f0b6=_0x3b81a0[_0x186dca(0x159)],_0x5a153c=_0x3b81a0[_0x186dca(0x122)];if(_0x5275af){if(_0x5275af[_0x186dca(0x152)](_0x1e7a5d[_0x186dca(0x12a)])){if(_0x5275af[_0x186dca(0x15e)](_0x186dca(0x16a)))return IMAGE_HTTP_HOST_NT+_0x5275af;const _0x38c2c4=await rkeyManager[_0x186dca(0x160)](),_0x128d57=_0xfb8681?_0x38c2c4[_0x186dca(0x148)]:_0x38c2c4['group_rkey'];return _0x1e7a5d[_0x186dca(0x133)](IMAGE_HTTP_HOST_NT+_0x5275af,''+_0x128d57);}else return _0x1e7a5d['vxIex'](IMAGE_HTTP_HOST,_0x5275af);}else{if(_0x1e7a5d['QgDys'](_0x90f0b6,_0xfaa584))return IMAGE_HTTP_HOST+_0x186dca(0x135)+_0x1e7a5d['qzXea'](_0x90f0b6,_0xfaa584)[_0x186dca(0x13f)]()+'/0';}return _0x1e7a5d[_0x186dca(0x15a)](logDebug,_0x1e7a5d[_0x186dca(0x168)],_0x3b81a0),'';}}export class NTQQFileCacheApi{static async[_0x32b2f7(0x157)](_0x47e121=!![]){return'';}static[_0x32b2f7(0x15b)](){return'';}static[_0x32b2f7(0x14e)](_0xc79b83=[_0x32b2f7(0x132),_0x32b2f7(0x13e)]){const _0xb07012=_0x32b2f7;return napCatCore[_0xb07012(0x121)][_0xb07012(0x15d)]()[_0xb07012(0x11c)](_0xc79b83);}static[_0x32b2f7(0x127)](_0xee6b20={}){const _0x4cb24f=_0x32b2f7;return napCatCore[_0x4cb24f(0x121)]['getStorageCleanService']()[_0x4cb24f(0x126)](_0xee6b20);}static[_0x32b2f7(0x14b)](){const _0x29e30e=_0x32b2f7;return napCatCore[_0x29e30e(0x121)][_0x29e30e(0x15d)]()[_0x29e30e(0x14b)]();}static['getHotUpdateCachePath'](){return'';}static[_0x32b2f7(0x158)](){return'';}static[_0x32b2f7(0x12d)](_0x56ea87,_0x5eb607=0x3e8,_0x144e18=0x0){const _0x13a754=_0x32b2f7;return napCatCore[_0x13a754(0x121)]['getStorageCleanService']()[_0x13a754(0x151)](_0x56ea87,_0x5eb607,0x1,_0x144e18);}static['getFileCacheInfo'](_0x1ba69c,_0x5bb0c0=0x3e8,_0x5a178f){const _0x9d1c71=_0x5a178f?_0x5a178f:{'fileType':_0x1ba69c};}static async[_0x32b2f7(0x14d)](_0x5ccb0f=[],_0x51d124=[]){const _0x4f16d4=_0x32b2f7;return napCatCore['session'][_0x4f16d4(0x15d)]()['clearChatCacheInfo'](_0x5ccb0f,_0x51d124);}}