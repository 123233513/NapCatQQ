const _0x338cc2=_0x4cbf;function _0x4a10(){const _0x50b43f=['delete','BEukc','join','getFileCacheInfo','mKhjt','2296383HWdJOV','private_rkey','existsSync','copyFile','clearChatCache','getDesktopTmpPath','ext','2743454sQhPGK','NuFEc','GFLAQ','PIC','getMsgService','set','getRichMediaFilePathForGuild','下载超时','util','indexOf','fileTypeFromFile','/gchatpic_new/0/0-0-','session','wMxXJ','图片url获取失败','getRkey','&rkey=','EtoRZ','unlink','toUpperCase','2561746bFXsdD','548711JeGIqB','yXoPG','8dOhtvL','includes','msgId','getHotUpdateCachePath','addCacheScanedPaths','5512870byXzVO','filePath','group_rkey','7385712ixDXNi','getStorageCleanService','addCacheScannedPaths','downloadRichMedia','clearCache','addListener','getFileSize','kTlvs','Itiwi','defaultFileDownloadPath','fileUuid','clearCacheDataByKeys','getChatCacheList','hotUpdate','scanCache','originImageUrl','oDOrH','fGtOS','9834376HmZsbu','uploadFile','setCacheSilentScan','getChatCacheInfo','getImageSize','downloadMedia'];_0x4a10=function(){return _0x50b43f;};return _0x4a10();}(function(_0x339db4,_0x1000c6){const _0x378487=_0x4cbf,_0x3d56b5=_0x339db4();while(!![]){try{const _0x5a4a44=parseInt(_0x378487(0x18f))/0x1+-parseInt(_0x378487(0x18e))/0x2+-parseInt(_0x378487(0x173))/0x3*(parseInt(_0x378487(0x191))/0x4)+parseInt(_0x378487(0x196))/0x5+parseInt(_0x378487(0x199))/0x6+-parseInt(_0x378487(0x17a))/0x7+parseInt(_0x378487(0x168))/0x8;if(_0x5a4a44===_0x1000c6)break;else _0x3d56b5['push'](_0x3d56b5['shift']());}catch(_0x2246e6){_0x3d56b5['push'](_0x3d56b5['shift']());}}}(_0x4a10,0xdda29));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x2836a8 from'path';import _0x59f0e2 from'fs';import _0x5398ee from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x6e576f from'file-type';function _0x4cbf(_0x47feab,_0x54f40c){const _0x4a10f4=_0x4a10();return _0x4cbf=function(_0x4cbffe,_0x1b9827){_0x4cbffe=_0x4cbffe-0x164;let _0x35d29b=_0x4a10f4[_0x4cbffe];return _0x35d29b;},_0x4cbf(_0x47feab,_0x54f40c);}import{MsgListener}from'@/core/listeners';import _0x549715 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x288a63=>{const _0x2f7430=_0x4cbf;for(const [_0x2ea97e,_0x1ac338]of downloadMediaTasks){_0x1ac338(_0x288a63),downloadMediaTasks[_0x2f7430(0x16e)](_0x2ea97e);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x336bca=_0x4cbf;napCatCore[_0x336bca(0x19e)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x1983a3){const _0x2062ef=_0x4cbf;return _0x6e576f[_0x2062ef(0x184)](_0x1983a3);}static async['copyFile'](_0x4dcb63,_0x33c8dd){const _0x5552d4=_0x4cbf;await napCatCore[_0x5552d4(0x182)][_0x5552d4(0x176)](_0x4dcb63,_0x33c8dd);}static async[_0x338cc2(0x19f)](_0x4eea60){const _0x1fa70a=_0x338cc2;return await napCatCore[_0x1fa70a(0x182)][_0x1fa70a(0x19f)](_0x4eea60);}static async[_0x338cc2(0x169)](_0x5ce74b,_0x4b1fd5=ElementType[_0x338cc2(0x17d)],_0x36945d=0x0){const _0x111599=_0x338cc2,_0x4ab97d={'EtoRZ':function(_0x4e3070,_0x162888){return _0x4e3070(_0x162888);},'NuFEc':function(_0x5caeaa,_0x3f3b05){return _0x5caeaa+_0x3f3b05;},'HsXcu':function(_0x217754,_0x307f36){return _0x217754===_0x307f36;}},_0x4abdf6=await _0x4ab97d[_0x111599(0x18b)](calculateFileMD5,_0x5ce74b);let _0x577e20=(await NTQQFileApi['getFileType'](_0x5ce74b))?.[_0x111599(0x179)]||'';_0x577e20&&(_0x577e20=_0x4ab97d[_0x111599(0x17b)]('.',_0x577e20));let _0x3c01a5=''+_0x2836a8['basename'](_0x5ce74b);_0x4ab97d['HsXcu'](_0x3c01a5[_0x111599(0x183)]('.'),-0x1)&&(_0x3c01a5+=_0x577e20);const _0x3ebdaa=napCatCore['session']['getMsgService']()[_0x111599(0x180)]({'md5HexStr':_0x4abdf6,'fileName':_0x3c01a5,'elementType':_0x4b1fd5,'elementSubType':_0x36945d,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x111599(0x176)](_0x5ce74b,_0x3ebdaa);const _0x3a9646=await NTQQFileApi['getFileSize'](_0x5ce74b);return{'md5':_0x4abdf6,'fileName':_0x3c01a5,'path':_0x3ebdaa,'fileSize':_0x3a9646,'ext':_0x577e20};}static async[_0x338cc2(0x16d)](_0x4b8bde,_0x2dbb65,_0x619437,_0x404c60,_0x2308f4,_0xad9021,_0x29a58b=0x3e8*0x3c*0x2,_0x554b62=![]){const _0x3fcfcd=_0x338cc2,_0xdb2ea7={'mlAwl':function(_0x598d52,_0x3a2e9f){return _0x598d52===_0x3a2e9f;},'kTlvs':function(_0x42ca72,_0x35c41e){return _0x42ca72(_0x35c41e);}};if(_0xad9021&&_0x59f0e2[_0x3fcfcd(0x175)](_0xad9021)){if(_0x554b62)try{await _0x5398ee[_0x3fcfcd(0x18c)](_0xad9021);}catch(_0x415eda){}else return _0xad9021;}return new Promise((_0x4ef1dd,_0x2df638)=>{const _0x1412cd=_0x3fcfcd,_0x1246bc={'yXoPG':function(_0x1274a5,_0x5af7f6){return _0x1274a5(_0x5af7f6);}};let _0x1b00c9=![];const _0x54c530=_0x1b25d3=>{const _0x65477f=_0x4cbf;if(_0xdb2ea7['mlAwl'](_0x1b25d3[_0x65477f(0x193)],_0x4b8bde)){_0x1b00c9=!![];let _0x15dc16=_0x1b25d3[_0x65477f(0x197)];if(_0x15dc16['startsWith']('\x5c')){const _0x142f1a=sessionConfig[_0x65477f(0x1a2)];_0x15dc16=_0x2836a8[_0x65477f(0x170)](_0x142f1a,_0x15dc16);}_0xdb2ea7[_0x65477f(0x1a0)](_0x4ef1dd,_0x15dc16);}};downloadMediaTasks[_0x1412cd(0x17f)](randomUUID(),_0x54c530),setTimeout(()=>{const _0x1634d9=_0x1412cd;!_0x1b00c9&&_0x1246bc[_0x1634d9(0x190)](_0x2df638,_0x1634d9(0x181));},_0x29a58b),napCatCore[_0x1412cd(0x186)][_0x1412cd(0x17e)]()[_0x1412cd(0x19c)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x4b8bde,'chatType':_0x2dbb65,'peerUid':_0x619437,'elementId':_0x404c60,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2308f4});});}static async[_0x338cc2(0x16c)](_0x1b7247){const _0xabc669={'BEukc':function(_0x4759ae,_0x341d8f){return _0x4759ae(_0x341d8f);}};return new Promise((_0x54a25a,_0x264808)=>{const _0x225b95={'wMxXJ':function(_0x429daf,_0xf766da){return _0x429daf(_0xf766da);},'fGtOS':function(_0x48283e,_0x2d8946){const _0x370227=_0x4cbf;return _0xabc669[_0x370227(0x16f)](_0x48283e,_0x2d8946);}};_0x549715(_0x1b7247,(_0x594c92,_0x242557)=>{const _0x3af19e=_0x4cbf;_0x594c92?_0x225b95[_0x3af19e(0x187)](_0x264808,_0x594c92):_0x225b95[_0x3af19e(0x167)](_0x54a25a,_0x242557);});});}static async['getImageUrl'](_0x44163a,_0x543bdd){const _0x23e4fb=_0x338cc2,_0x5a271a={'mKhjt':'/download','GFLAQ':function(_0x48c028,_0x2cff5d){return _0x48c028+_0x2cff5d;},'oDOrH':function(_0x9cb6f8,_0x39f00c){return _0x9cb6f8||_0x39f00c;},'sRMmz':function(_0x15b737,_0xd4d997){return _0x15b737||_0xd4d997;},'qLDXc':function(_0x438912,_0x4e379d,_0xf67286){return _0x438912(_0x4e379d,_0xf67286);},'Itiwi':_0x23e4fb(0x188)};if(!_0x44163a)return'';const _0x3e8bd1=_0x44163a[_0x23e4fb(0x165)],_0x373d1f=_0x44163a['md5HexStr'],_0x4d69dc=_0x44163a['md5HexStr'],_0x19c106=_0x44163a[_0x23e4fb(0x1a3)];if(_0x3e8bd1){if(_0x3e8bd1['startsWith'](_0x5a271a[_0x23e4fb(0x172)])){if(_0x3e8bd1[_0x23e4fb(0x192)](_0x23e4fb(0x18a)))return _0x5a271a['GFLAQ'](IMAGE_HTTP_HOST_NT,_0x3e8bd1);const _0x260075=await rkeyManager[_0x23e4fb(0x189)](),_0x244608=_0x543bdd?_0x260075[_0x23e4fb(0x174)]:_0x260075[_0x23e4fb(0x198)];return _0x5a271a[_0x23e4fb(0x17c)](_0x5a271a[_0x23e4fb(0x17c)](IMAGE_HTTP_HOST_NT,_0x3e8bd1),''+_0x244608);}else return IMAGE_HTTP_HOST+_0x3e8bd1;}else{if(_0x5a271a[_0x23e4fb(0x166)](_0x4d69dc,_0x373d1f))return IMAGE_HTTP_HOST+_0x23e4fb(0x185)+_0x5a271a['sRMmz'](_0x4d69dc,_0x373d1f)[_0x23e4fb(0x18d)]()+'/0';}return _0x5a271a['qLDXc'](logDebug,_0x5a271a[_0x23e4fb(0x1a1)],_0x44163a),'';}}export class NTQQFileCacheApi{static async[_0x338cc2(0x16a)](_0x51b768=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x338cc2(0x19d)](_0x5891ec=['tmp',_0x338cc2(0x1a6)]){const _0x1c54eb=_0x338cc2;return napCatCore[_0x1c54eb(0x186)][_0x1c54eb(0x19a)]()[_0x1c54eb(0x1a4)](_0x5891ec);}static[_0x338cc2(0x19b)](_0x2bf53c={}){const _0x2322a0=_0x338cc2;return napCatCore[_0x2322a0(0x186)]['getStorageCleanService']()[_0x2322a0(0x195)](_0x2bf53c);}static[_0x338cc2(0x164)](){const _0x52e2fd=_0x338cc2;return napCatCore[_0x52e2fd(0x186)][_0x52e2fd(0x19a)]()['scanCache']();}static[_0x338cc2(0x194)](){return'';}static[_0x338cc2(0x178)](){return'';}static[_0x338cc2(0x1a5)](_0x450dbd,_0x587ee8=0x3e8,_0x6fd0be=0x0){const _0x367f74=_0x338cc2;return napCatCore[_0x367f74(0x186)][_0x367f74(0x19a)]()[_0x367f74(0x16b)](_0x450dbd,_0x587ee8,0x1,_0x6fd0be);}static[_0x338cc2(0x171)](_0x1c9b2f,_0x284fd8=0x3e8,_0x2c03f7){const _0x4f67db=_0x2c03f7?_0x2c03f7:{'fileType':_0x1c9b2f};}static async[_0x338cc2(0x177)](_0x3cb814=[],_0x22998a=[]){const _0x5dcee7=_0x338cc2;return napCatCore['session'][_0x5dcee7(0x19a)]()['clearChatCacheInfo'](_0x3cb814,_0x22998a);}}