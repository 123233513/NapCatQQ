const _0x46f519=_0x375b;(function(_0x4058f0,_0x16ebeb){const _0x47abbc=_0x375b,_0x500807=_0x4058f0();while(!![]){try{const _0x37d83e=parseInt(_0x47abbc(0xfd))/0x1*(-parseInt(_0x47abbc(0xe0))/0x2)+parseInt(_0x47abbc(0xff))/0x3*(-parseInt(_0x47abbc(0xe2))/0x4)+parseInt(_0x47abbc(0xe7))/0x5+-parseInt(_0x47abbc(0x113))/0x6*(parseInt(_0x47abbc(0xdc))/0x7)+parseInt(_0x47abbc(0xcc))/0x8+-parseInt(_0x47abbc(0xde))/0x9*(-parseInt(_0x47abbc(0xdd))/0xa)+parseInt(_0x47abbc(0xea))/0xb;if(_0x37d83e===_0x16ebeb)break;else _0x500807['push'](_0x500807['shift']());}catch(_0x200e76){_0x500807['push'](_0x500807['shift']());}}}(_0x4526,0x1f4f0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x3e62f9 from'path';import _0x1e1312 from'fs';import _0x1c32af from'fs/promises';import{logDebug}from'@/common/utils/log';function _0x375b(_0x2b29c1,_0x1bfdf2){const _0x4526e4=_0x4526();return _0x375b=function(_0x375b16,_0x3bdde1){_0x375b16=_0x375b16-0xcc;let _0x46ab49=_0x4526e4[_0x375b16];return _0x46ab49;},_0x375b(_0x2b29c1,_0x1bfdf2);}import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x2219ad from'file-type';import{MsgListener}from'@/core/listeners';import _0x44eb97 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x46f519(0xd7)]=_0x15c3ad=>{const _0x57b543=_0x46f519,_0x198c41={'amfDA':function(_0x55c537,_0x3d81e2){return _0x55c537(_0x3d81e2);}};for(const [_0x2494a4,_0x19dbfa]of downloadMediaTasks){_0x198c41[_0x57b543(0x101)](_0x19dbfa,_0x15c3ad),downloadMediaTasks['delete'](_0x2494a4);}},setTimeout(()=>{const _0x16a324=_0x46f519;napCatCore[_0x16a324(0xf6)](()=>{const _0x448293=_0x16a324;napCatCore[_0x448293(0xf1)](downloadMediaListener);});},0x64);function _0x4526(){const _0x411809=['437526qQYTmm','/gchatpic_new/0/0-0-','540168JQnjsd','addCacheScannedPaths','tmp','join','getImageSize','getChatCacheList','getCacheSessionPathList','clearChatCacheInfo','PifxL','hotUpdate','md5HexStr','onRichMediaDownloadComplete','defaultFileDownloadPath','getDesktopTmpPath','getHotUpdateCachePath','fileTypeFromFile','14ebeOsj','340SGegLH','30753SDdBTX','startsWith','125148QEghKO','originImageUrl','4DeBkUr','DSkoB','unlink','getChatCacheInfo','group_rkey','55425cdeOfq','getMsgService','indexOf','3394325wSyuOP','msgId','图片url获取失败','KFeWo','clearCache','LbuGx','private_rkey','addListener','下载超时','getFileType','copyFile','gsrtp','onLoginSuccess','downloadRichMedia','Upgez','getRichMediaFilePathForGuild','jxcWf','session','clearChatCache','2wViHXb','UBjxd','312387CQqFfr','existsSync','amfDA','getStorageCleanService','scanCache','PIC','getRkey','riZMd','XnQYe','downloadMedia','basename','util','aYvfu','includes','getFileSize','TKONu','&rkey=','QcjlX','toUpperCase','fileUuid'];_0x4526=function(){return _0x411809;};return _0x4526();}export class NTQQFileApi{static async[_0x46f519(0xf3)](_0xa974a3){const _0x202b53=_0x46f519;return _0x2219ad[_0x202b53(0xdb)](_0xa974a3);}static async[_0x46f519(0xf4)](_0x14bf58,_0x1d12ff){const _0x32b8ae=_0x46f519;await napCatCore[_0x32b8ae(0x10a)][_0x32b8ae(0xf4)](_0x14bf58,_0x1d12ff);}static async['getFileSize'](_0x28dff4){const _0x70d0b8=_0x46f519;return await napCatCore[_0x70d0b8(0x10a)]['getFileSize'](_0x28dff4);}static async['uploadFile'](_0x3890ec,_0x440084=ElementType[_0x46f519(0x104)],_0x480368=0x0){const _0x1ca3b7=_0x46f519,_0x2db39f={'kVYBy':function(_0x51f2f0,_0x2b808b){return _0x51f2f0(_0x2b808b);},'gsrtp':function(_0x37b308,_0x3fefc9){return _0x37b308+_0x3fefc9;}},_0x2e7189=await _0x2db39f['kVYBy'](calculateFileMD5,_0x3890ec);let _0x552d3b=(await NTQQFileApi[_0x1ca3b7(0xf3)](_0x3890ec))?.['ext']||'';_0x552d3b&&(_0x552d3b=_0x2db39f[_0x1ca3b7(0xf5)]('.',_0x552d3b));let _0x205dee=''+_0x3e62f9[_0x1ca3b7(0x109)](_0x3890ec);_0x205dee[_0x1ca3b7(0xe9)]('.')===-0x1&&(_0x205dee+=_0x552d3b);const _0x2e4b4b=napCatCore[_0x1ca3b7(0xfb)][_0x1ca3b7(0xe8)]()[_0x1ca3b7(0xf9)]({'md5HexStr':_0x2e7189,'fileName':_0x205dee,'elementType':_0x440084,'elementSubType':_0x480368,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x1ca3b7(0xf4)](_0x3890ec,_0x2e4b4b);const _0x149dd4=await NTQQFileApi[_0x1ca3b7(0x10d)](_0x3890ec);return{'md5':_0x2e7189,'fileName':_0x205dee,'path':_0x2e4b4b,'fileSize':_0x149dd4,'ext':_0x552d3b};}static async[_0x46f519(0x108)](_0xb360ea,_0x4f5e85,_0x4ce1ee,_0x4fa795,_0x8ba753,_0x3c4a93,_0x422dee=0x3e8*0x3c*0x2,_0x401903=![]){const _0x338210=_0x46f519,_0x1bf8d1={'QcjlX':function(_0xf08170,_0x3c7975){return _0xf08170===_0x3c7975;},'jxcWf':_0x338210(0xf2),'ppzUJ':function(_0xed2c49){return _0xed2c49();},'KFeWo':function(_0x83e63c,_0x186fa2,_0x4f0cba){return _0x83e63c(_0x186fa2,_0x4f0cba);}};if(_0x3c4a93&&_0x1e1312[_0x338210(0x100)](_0x3c4a93)){if(_0x401903)try{await _0x1c32af[_0x338210(0xe4)](_0x3c4a93);}catch(_0x9f8259){}else return _0x3c4a93;}return new Promise((_0x4177ef,_0xdc295f)=>{const _0x2aa24b=_0x338210;let _0x3d8379=![];const _0x245008=_0x3f0a92=>{const _0x8a4262=_0x375b;if(_0x1bf8d1[_0x8a4262(0x110)](_0x3f0a92[_0x8a4262(0xeb)],_0xb360ea)){_0x3d8379=!![];let _0x27256c=_0x3f0a92['filePath'];if(_0x27256c[_0x8a4262(0xdf)]('\x5c')){const _0x181392=sessionConfig[_0x8a4262(0xd8)];_0x27256c=_0x3e62f9[_0x8a4262(0xcf)](_0x181392,_0x27256c);}_0x4177ef(_0x27256c);}};downloadMediaTasks['set'](_0x1bf8d1['ppzUJ'](randomUUID),_0x245008),_0x1bf8d1[_0x2aa24b(0xed)](setTimeout,()=>{const _0x3cc860=_0x2aa24b;!_0x3d8379&&_0xdc295f(_0x1bf8d1[_0x3cc860(0xfa)]);},_0x422dee),napCatCore['session'][_0x2aa24b(0xe8)]()[_0x2aa24b(0xf7)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0xb360ea,'chatType':_0x4f5e85,'peerUid':_0x4ce1ee,'elementId':_0x4fa795,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x8ba753});});}static async[_0x46f519(0xd0)](_0xb87e8){const _0x5ecf9e={'TKONu':function(_0x5ce5bf,_0x29f95e){return _0x5ce5bf(_0x29f95e);},'DSkoB':function(_0x137f2b,_0x5a56d7,_0x1d05f3){return _0x137f2b(_0x5a56d7,_0x1d05f3);}};return new Promise((_0x2ccf23,_0x25b7f4)=>{const _0x44f2ad=_0x375b;_0x5ecf9e[_0x44f2ad(0xe3)](_0x44eb97,_0xb87e8,(_0x3480ca,_0x17e5c9)=>{const _0x400a87=_0x44f2ad;_0x3480ca?_0x5ecf9e[_0x400a87(0x10e)](_0x25b7f4,_0x3480ca):_0x2ccf23(_0x17e5c9);});});}static async['getImageUrl'](_0x55d3b9,_0x4eaf56){const _0x1cd135=_0x46f519,_0x19098e={'PifxL':'/download','XnQYe':_0x1cd135(0x10f),'OzcRH':function(_0x5abd68,_0x41540d){return _0x5abd68+_0x41540d;},'UBjxd':function(_0x380dea,_0x28b158){return _0x380dea+_0x28b158;},'aYvfu':function(_0x2c6d4e,_0x560a02){return _0x2c6d4e+_0x560a02;},'riZMd':function(_0x5ace3b,_0x13fdc9){return _0x5ace3b+_0x13fdc9;},'Upgez':function(_0x363796,_0x234a5f){return _0x363796||_0x234a5f;},'LbuGx':_0x1cd135(0xec)};if(!_0x55d3b9)return'';const _0x2932a0=_0x55d3b9[_0x1cd135(0xe1)],_0x1f9873=_0x55d3b9[_0x1cd135(0xd6)],_0x3e87e1=_0x55d3b9[_0x1cd135(0xd6)],_0x22c26f=_0x55d3b9[_0x1cd135(0x112)];if(_0x2932a0){if(_0x2932a0[_0x1cd135(0xdf)](_0x19098e[_0x1cd135(0xd4)])){if(_0x2932a0[_0x1cd135(0x10c)](_0x19098e[_0x1cd135(0x107)]))return _0x19098e['OzcRH'](IMAGE_HTTP_HOST_NT,_0x2932a0);const _0x4ac4b6=await rkeyManager[_0x1cd135(0x105)](),_0x2eae8d=_0x4eaf56?_0x4ac4b6[_0x1cd135(0xf0)]:_0x4ac4b6[_0x1cd135(0xe6)];return _0x19098e[_0x1cd135(0xfe)](_0x19098e[_0x1cd135(0x10b)](IMAGE_HTTP_HOST_NT,_0x2932a0),''+_0x2eae8d);}else return _0x19098e[_0x1cd135(0x106)](IMAGE_HTTP_HOST,_0x2932a0);}else{if(_0x19098e[_0x1cd135(0xf8)](_0x3e87e1,_0x1f9873))return IMAGE_HTTP_HOST+_0x1cd135(0x114)+(_0x3e87e1||_0x1f9873)[_0x1cd135(0x111)]()+'/0';}return logDebug(_0x19098e[_0x1cd135(0xef)],_0x55d3b9),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0xeaf75e=!![]){return'';}static[_0x46f519(0xd2)](){return'';}static[_0x46f519(0xee)](_0x132db9=[_0x46f519(0xce),_0x46f519(0xd5)]){const _0x2fc703=_0x46f519;return napCatCore[_0x2fc703(0xfb)][_0x2fc703(0x102)]()['clearCacheDataByKeys'](_0x132db9);}static[_0x46f519(0xcd)](_0x174bbe={}){const _0x2ffbc5=_0x46f519;return napCatCore[_0x2ffbc5(0xfb)][_0x2ffbc5(0x102)]()['addCacheScanedPaths'](_0x174bbe);}static[_0x46f519(0x103)](){const _0xb01b47=_0x46f519;return napCatCore[_0xb01b47(0xfb)][_0xb01b47(0x102)]()[_0xb01b47(0x103)]();}static[_0x46f519(0xda)](){return'';}static[_0x46f519(0xd9)](){return'';}static[_0x46f519(0xd1)](_0x2cf330,_0x1bfd06=0x3e8,_0x5f512e=0x0){const _0x14e11d=_0x46f519;return napCatCore[_0x14e11d(0xfb)][_0x14e11d(0x102)]()[_0x14e11d(0xe5)](_0x2cf330,_0x1bfd06,0x1,_0x5f512e);}static['getFileCacheInfo'](_0x12948a,_0x37de75=0x3e8,_0x55aa66){const _0x55b855=_0x55aa66?_0x55aa66:{'fileType':_0x12948a};}static async[_0x46f519(0xfc)](_0x26ae58=[],_0x3ba7f7=[]){const _0x262e89=_0x46f519;return napCatCore[_0x262e89(0xfb)][_0x262e89(0x102)]()[_0x262e89(0xd3)](_0x26ae58,_0x3ba7f7);}}