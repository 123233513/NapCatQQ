function _0x2e51(_0x4f9904,_0x502d2a){const _0x5abf7c=_0x5abf();return _0x2e51=function(_0x2e5144,_0x30ac83){_0x2e5144=_0x2e5144-0x137;let _0x382a83=_0x5abf7c[_0x2e5144];return _0x382a83;},_0x2e51(_0x4f9904,_0x502d2a);}const _0x4a3b4f=_0x2e51;function _0x5abf(){const _0x29ba54=['loAHD','msgId','getFileCacheInfo','getRichMediaFilePathForGuild','ajDlW','clearCache','NKIYR','getFileSize','join','chatType','statusCode','startsWith','图片url获取失败','group','882119dNVaCi','md5HexStr','nHDfp','195QkzUAa','delete','ext','addTask','41864SDaMEP','getFileType','djMAj','179mGrFWb','picElement','EaMuK','2510022nfPumU','clearCacheDataByKeys','indexOf','MbqKQ','util','prosD','Owhdb','XvTqa','setCacheSilentScan','/gchatpic_new/0/0-0-','xAfzI','GBbit','peerUid','NBqfo','isAvailable','getStorageCleanService','basename','toUpperCase','start\x20downloadMedia','session','PIC','16hPpncW','458712IHAbWF','IAjbG','LXaoP','getMsgService','clearChatCacheInfo','downloadMedia','hookApi\x20is\x20not\x20available','414GoiMva','includes','uSUam','getCacheSessionPathList','onLoginSuccess','then','MdyVo','tmp','JYZcK','fileUuid','ICyGb','wtxjd','onRichMediaDownloadComplete','unlink','find','图片rkey有误','clearChatCache','getDesktopTmpPath','/download','开始调用moeHook获取rkey','图片rkey获取失败','getChatCacheInfo','80720LfYkXP','getChatCacheList','scanCache','get','HKdEy','addCacheScanedPaths','3206005aeckFS','existsSync','fileTypeFromFile','BjRym','elements','now','3214yCccZo','getImageSize','addCacheScannedPaths','elementId','getImageUrl','downloadPath'];_0x5abf=function(){return _0x29ba54;};return _0x5abf();}(function(_0x3bff14,_0x57bd6c){const _0x28738f=_0x2e51,_0x3dde9f=_0x3bff14();while(!![]){try{const _0x8cc264=-parseInt(_0x28738f(0x16c))/0x1*(parseInt(_0x28738f(0x14e))/0x2)+-parseInt(_0x28738f(0x185))/0x3+-parseInt(_0x28738f(0x169))/0x4*(-parseInt(_0x28738f(0x165))/0x5)+parseInt(_0x28738f(0x16f))/0x6+parseInt(_0x28738f(0x162))/0x7*(-parseInt(_0x28738f(0x184))/0x8)+-parseInt(_0x28738f(0x18c))/0x9*(-parseInt(_0x28738f(0x142))/0xa)+-parseInt(_0x28738f(0x148))/0xb;if(_0x8cc264===_0x57bd6c)break;else _0x3dde9f['push'](_0x3dde9f['shift']());}catch(_0x54bcf7){_0x3dde9f['push'](_0x3dde9f['shift']());}}}(_0x5abf,0x34311));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1ef4de from'path';import _0x12bc2a from'fs';import _0x488e10 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x567521 from'file-type';import{MsgListener}from'@/core/listeners';import _0x216dde from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0xcf9096 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x4a3b4f(0x138)]=_0x5cd9f0=>{const _0x49d7b1=_0x4a3b4f;for(const [_0x384c87,_0x49d7a2]of downloadMediaTasks){_0x49d7a2(_0x5cd9f0),downloadMediaTasks[_0x49d7b1(0x166)](_0x384c87);}},setTimeout(()=>{const _0x1f56af=_0x4a3b4f;napCatCore[_0x1f56af(0x190)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x4a3b4f(0x16a)](_0x54b95b){const _0x1149d7=_0x4a3b4f;return _0x567521[_0x1149d7(0x14a)](_0x54b95b);}static async['copyFile'](_0x1d59e2,_0x4f7467){await napCatCore['util']['copyFile'](_0x1d59e2,_0x4f7467);}static async['getFileSize'](_0x3aac8f){const _0x3e5240=_0x4a3b4f;return await napCatCore[_0x3e5240(0x173)]['getFileSize'](_0x3aac8f);}static async['uploadFile'](_0x38555b,_0x4f6f9c=ElementType[_0x4a3b4f(0x183)],_0x2e47e4=0x0){const _0x283564=_0x4a3b4f,_0x1af03a={'NBqfo':function(_0x5935d8,_0x308311){return _0x5935d8(_0x308311);},'XYhYq':function(_0x47bbab,_0x3261e4){return _0x47bbab+_0x3261e4;},'JYZcK':function(_0x53f3bf,_0xccbfda){return _0x53f3bf===_0xccbfda;}},_0xf7e452=await _0x1af03a[_0x283564(0x17c)](calculateFileMD5,_0x38555b);let _0x56c257=(await NTQQFileApi[_0x283564(0x16a)](_0x38555b))?.[_0x283564(0x167)]||'';_0x56c257&&(_0x56c257=_0x1af03a['XYhYq']('.',_0x56c257));let _0x1791a6=''+_0x1ef4de[_0x283564(0x17f)](_0x38555b);_0x1af03a[_0x283564(0x194)](_0x1791a6[_0x283564(0x171)]('.'),-0x1)&&(_0x1791a6+=_0x56c257);const _0x5b11ae=napCatCore[_0x283564(0x182)][_0x283564(0x188)]()[_0x283564(0x157)]({'md5HexStr':_0xf7e452,'fileName':_0x1791a6,'elementType':_0x4f6f9c,'elementSubType':_0x2e47e4,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x38555b,_0x5b11ae);const _0x1221b7=await NTQQFileApi[_0x283564(0x15b)](_0x38555b);return{'md5':_0xf7e452,'fileName':_0x1791a6,'path':_0x5b11ae,'fileSize':_0x1221b7,'ext':_0x56c257};}static async[_0x4a3b4f(0x18a)](_0x47c606,_0xe7efce,_0x4bbe68,_0xe83f30,_0x3278df,_0x4ea02d,_0x43e128=0x3e8*0x3c*0x2,_0x361f66=![]){const _0x4ce4e0=_0x4a3b4f,_0x4d9f0a={'prosD':function(_0x591389,_0x58b181,_0x1a5d61,_0x19282e){return _0x591389(_0x58b181,_0x1a5d61,_0x19282e);},'EzXUj':'downloadMedia\x20complete','BjRym':function(_0x2e2f62,_0x1bcd8b,_0x4f9638){return _0x2e2f62(_0x1bcd8b,_0x4f9638);},'EaMuK':_0x4ce4e0(0x153),'uSUam':function(_0x47c2df,_0xed7446){return _0x47c2df(_0xed7446);},'AzCiu':function(_0x70efba){return _0x70efba();},'xAfzI':function(_0x58b8aa,_0x190a7c,_0x47d5e3){return _0x58b8aa(_0x190a7c,_0x47d5e3);},'Owhdb':function(_0x30cbe4,_0x15817b,_0x3172a3,_0x5d1094,_0x3e0bce,_0x32f13a,_0x17633e,_0x498cef,_0x5dc526,_0x4075bf){return _0x30cbe4(_0x15817b,_0x3172a3,_0x5d1094,_0x3e0bce,_0x32f13a,_0x17633e,_0x498cef,_0x5dc526,_0x4075bf);},'ICyGb':_0x4ce4e0(0x181)};_0x4d9f0a[_0x4ce4e0(0x175)](logDebug,'receive\x20downloadMedia\x20task',_0x47c606,_0xe7efce,_0x4bbe68,_0xe83f30,_0x3278df,_0x4ea02d,_0x43e128,_0x361f66);if(_0x4ea02d&&_0x12bc2a[_0x4ce4e0(0x149)](_0x4ea02d)){if(_0x361f66)try{await _0x488e10[_0x4ce4e0(0x139)](_0x4ea02d);}catch(_0x228153){}else return _0x4ea02d;}return logDebug(_0x4d9f0a[_0x4ce4e0(0x196)],_0x47c606,_0xe7efce,_0x4bbe68,_0xe83f30,_0x3278df,_0x4ea02d,_0x43e128,_0x361f66),new Promise((_0x5b1c94,_0x537470)=>{const _0x4cf363=_0x4ce4e0;let _0x114c57=![];const _0x2056fa=_0x44e8af=>{const _0x1bf1e3=_0x2e51;_0x4d9f0a[_0x1bf1e3(0x174)](logDebug,_0x4d9f0a['EzXUj'],_0x44e8af,_0x47c606);if(_0x44e8af[_0x1bf1e3(0x155)]===_0x47c606){_0x114c57=!![];let _0x1e230e=_0x44e8af['filePath'];if(_0x1e230e[_0x1bf1e3(0x15f)]('\x5c')){const _0xa16d33=sessionConfig['defaultFileDownloadPath'];_0x4d9f0a[_0x1bf1e3(0x14b)](logDebug,_0x4d9f0a[_0x1bf1e3(0x16e)],_0xa16d33),_0x1e230e=_0x1ef4de[_0x1bf1e3(0x15c)](_0xa16d33,_0x1e230e);}_0x4d9f0a[_0x1bf1e3(0x18e)](_0x5b1c94,_0x1e230e);}};downloadMediaTasks['set'](_0x4d9f0a['AzCiu'](randomUUID),_0x2056fa),_0x4d9f0a[_0x4cf363(0x179)](setTimeout,()=>{!_0x114c57&&_0x537470('下载超时');},_0x43e128),napCatCore[_0x4cf363(0x182)][_0x4cf363(0x188)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x47c606,'chatType':_0xe7efce,'peerUid':_0x4bbe68,'elementId':_0xe83f30,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3278df});});}static async[_0x4a3b4f(0x14f)](_0x171658){const _0x584b7f={'GBbit':function(_0x4905cc,_0x1397e7){return _0x4905cc(_0x1397e7);}};return new Promise((_0x913739,_0x33cab1)=>{const _0x20fa51={'Zvqkp':function(_0x2b6e8a,_0x18830e){const _0x5dbb6d=_0x2e51;return _0x584b7f[_0x5dbb6d(0x17a)](_0x2b6e8a,_0x18830e);}};_0x216dde(_0x171658,(_0x599f80,_0x3ceeb4)=>{_0x599f80?_0x20fa51['Zvqkp'](_0x33cab1,_0x599f80):_0x913739(_0x3ceeb4);});});}static async[_0x4a3b4f(0x152)](_0x424a87){const _0x107352=_0x4a3b4f,_0x50d3e4={'ajDlW':'error','MdyVo':function(_0x3839c5,_0x3a0a8a){return _0x3839c5(_0x3a0a8a);},'djMAj':function(_0x4d7dc0,_0x5221a0){return _0x4d7dc0*_0x5221a0;},'YLsvK':function(_0xd74347,_0x48701d){return _0xd74347(_0x48701d);},'nHDfp':function(_0x3a377f,_0xae8c3c){return _0x3a377f+_0xae8c3c;},'BIaFV':function(_0x520291,_0xd714da,_0x543ea2){return _0x520291(_0xd714da,_0x543ea2);},'wtxjd':'检查rkey是否有效','uofOy':'图片rkey有效','NqwXQ':function(_0x42b091,_0xb82ff7){return _0x42b091(_0xb82ff7);},'rJdpA':function(_0x461c8b,_0x2b6cbd){return _0x461c8b(_0x2b6cbd);},'loAHD':_0x107352(0x13e),'rJGyQ':function(_0x403544,_0x4ecaf0){return _0x403544>_0x4ecaf0;},'tLMkK':function(_0x173485,_0x3823ce){return _0x173485-_0x3823ce;},'IAjbG':function(_0x214635,_0xb93e78){return _0x214635+_0xb93e78;},'LXaoP':_0x107352(0x140),'HKdEy':function(_0x22e8b5,_0xa4bd35){return _0x22e8b5+_0xa4bd35;},'NKIYR':function(_0x1a57e3,_0x465d81,_0x37a647){return _0x1a57e3(_0x465d81,_0x37a647);}},_0x586e57=_0x424a87[_0x107352(0x15d)]!==ChatType[_0x107352(0x161)],_0x13beca=_0x424a87[_0x107352(0x14c)][_0x107352(0x13a)](_0x5a5060=>!!_0x5a5060[_0x107352(0x16d)]);if(!_0x13beca)return'';const _0x2fbfd7=_0x13beca[_0x107352(0x16d)]['originImageUrl'],_0x1d2c60=_0x13beca[_0x107352(0x16d)][_0x107352(0x163)],_0xd5719d=_0x13beca[_0x107352(0x16d)][_0x107352(0x163)],_0x3b010d=_0x13beca[_0x107352(0x16d)][_0x107352(0x195)],_0x1aa4ef=_0x1bb73d=>{const _0x5b501f=_0x107352;_0x586e57?(privateImageRKey=_0x1bb73d,lastGetPrivateRKeyTime=Date[_0x5b501f(0x14d)]()):(groupImageRKey=_0x1bb73d,lastGetGroupRKeyTime=Date[_0x5b501f(0x14d)]());};if(_0x2fbfd7){if(_0x2fbfd7['startsWith'](_0x50d3e4[_0x107352(0x154)])){if(_0x2fbfd7[_0x107352(0x18d)]('&rkey='))return _0x50d3e4[_0x107352(0x164)](IMAGE_HTTP_HOST_NT,_0x2fbfd7);if(!hookApi[_0x107352(0x17d)]())return _0x50d3e4['NqwXQ'](logDebug,_0x107352(0x18b)),'';const _0x49b143=async()=>{const _0x260b3c=_0x107352,_0x216ef8={'pSojK':function(_0x6f9c0b,_0x4d9960){return _0x6f9c0b(_0x4d9960);},'XvTqa':_0x50d3e4[_0x260b3c(0x158)]};_0x50d3e4[_0x260b3c(0x192)](logDebug,'获取图片rkey...'),NTQQFileApi['downloadMedia'](_0x424a87[_0x260b3c(0x155)],_0x424a87[_0x260b3c(0x15d)],_0x424a87[_0x260b3c(0x17b)],_0x13beca[_0x260b3c(0x151)],'',_0x13beca['picElement']['sourcePath'],_0x50d3e4[_0x260b3c(0x16b)](0x3e8,0x1e),![])[_0x260b3c(0x191)](_0x44ff88=>{})['catch'](logError),await _0x50d3e4['YLsvK'](sleep,0x3e8),logDebug(_0x260b3c(0x13f));const _0xfb9313=hookApi['getRKey']()||'',_0x52d036=_0x50d3e4['nHDfp'](IMAGE_HTTP_HOST_NT+_0x2fbfd7,_0xfb9313);if(_0xfb9313)try{_0x50d3e4['BIaFV'](logDebug,_0x50d3e4[_0x260b3c(0x137)],_0x52d036),await new Promise((_0x8f2e2d,_0x51b754)=>{const _0xff5bdc=_0x260b3c;_0xcf9096[_0xff5bdc(0x145)](_0x52d036,_0x5c518e=>{const _0x2587eb=_0xff5bdc;_0x5c518e[_0x2587eb(0x15e)]!==0xc8?_0x216ef8['pSojK'](_0x51b754,_0x2587eb(0x140)):_0x216ef8['pSojK'](_0x8f2e2d,_0x5c518e);})['on'](_0x216ef8[_0xff5bdc(0x176)],_0x240942=>{_0x51b754(_0x240942);});}),logDebug(_0x50d3e4['uofOy'],_0x52d036),_0x50d3e4['NqwXQ'](_0x1aa4ef,_0xfb9313);}catch(_0x3ce1f0){return logError(_0x260b3c(0x13b),_0x52d036,_0x3ce1f0),'';}return _0xfb9313;},_0x507b65=new Promise((_0x482ae8,_0x443c57)=>{const _0x4b2932=_0x107352,_0x276779={'MbqKQ':function(_0x5756ad){return _0x5756ad();},'dAXFs':function(_0x30067f,_0x58d5a6){return _0x50d3e4['rJdpA'](_0x30067f,_0x58d5a6);}};getRKeyTaskQueue[_0x4b2932(0x168)](async()=>{const _0x25fca3=_0x4b2932,_0x821cef=await _0x276779[_0x25fca3(0x172)](_0x49b143);_0x276779['dAXFs'](_0x482ae8,_0x821cef);});}),_0x2ec28e=_0x586e57?privateImageRKey:groupImageRKey,_0x3f4955=_0x586e57?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x50d3e4['rJGyQ'](_0x50d3e4['tLMkK'](Date['now'](),_0x3f4955),rkeyExpireTime)||!_0x2ec28e){const _0x23e3d7=await _0x507b65;if(_0x23e3d7)return _0x50d3e4[_0x107352(0x186)](IMAGE_HTTP_HOST_NT+_0x2fbfd7,''+_0x23e3d7);else logError(_0x50d3e4[_0x107352(0x187)],_0x2fbfd7);}if(_0x2ec28e)return IMAGE_HTTP_HOST_NT+_0x2fbfd7+(''+_0x2ec28e);return'';}else return _0x50d3e4[_0x107352(0x146)](IMAGE_HTTP_HOST,_0x2fbfd7);}else{if(_0xd5719d||_0x1d2c60)return IMAGE_HTTP_HOST+_0x107352(0x178)+(_0xd5719d||_0x1d2c60)[_0x107352(0x180)]()+'/0';}return _0x50d3e4[_0x107352(0x15a)](logDebug,_0x107352(0x160),_0x424a87),'';}}export class NTQQFileCacheApi{static async[_0x4a3b4f(0x177)](_0x26c09b=!![]){return'';}static[_0x4a3b4f(0x18f)](){return'';}static[_0x4a3b4f(0x159)](_0x4c3ee0=[_0x4a3b4f(0x193),'hotUpdate']){const _0x1b64a1=_0x4a3b4f;return napCatCore[_0x1b64a1(0x182)][_0x1b64a1(0x17e)]()[_0x1b64a1(0x170)](_0x4c3ee0);}static[_0x4a3b4f(0x150)](_0x31eda6={}){const _0x211bc3=_0x4a3b4f;return napCatCore[_0x211bc3(0x182)][_0x211bc3(0x17e)]()[_0x211bc3(0x147)](_0x31eda6);}static[_0x4a3b4f(0x144)](){const _0x1be467=_0x4a3b4f;return napCatCore[_0x1be467(0x182)]['getStorageCleanService']()[_0x1be467(0x144)]();}static['getHotUpdateCachePath'](){return'';}static[_0x4a3b4f(0x13d)](){return'';}static[_0x4a3b4f(0x143)](_0x59623b,_0x10b19b=0x3e8,_0x38c01=0x0){const _0x61019a=_0x4a3b4f;return napCatCore[_0x61019a(0x182)]['getStorageCleanService']()[_0x61019a(0x141)](_0x59623b,_0x10b19b,0x1,_0x38c01);}static[_0x4a3b4f(0x156)](_0xec8fc6,_0xaea49a=0x3e8,_0x206c73){const _0x807580=_0x206c73?_0x206c73:{'fileType':_0xec8fc6};}static async[_0x4a3b4f(0x13c)](_0x1d6038=[],_0xb24d9f=[]){const _0x596364=_0x4a3b4f;return napCatCore[_0x596364(0x182)][_0x596364(0x17e)]()[_0x596364(0x189)](_0x1d6038,_0xb24d9f);}}