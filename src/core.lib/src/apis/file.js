const _0x1e5772=_0x1b14;(function(_0x222e52,_0x5b0d6a){const _0x5a6ca8=_0x1b14,_0x32c37f=_0x222e52();while(!![]){try{const _0x3759ea=-parseInt(_0x5a6ca8(0x184))/0x1*(parseInt(_0x5a6ca8(0x192))/0x2)+parseInt(_0x5a6ca8(0x182))/0x3+-parseInt(_0x5a6ca8(0x198))/0x4+-parseInt(_0x5a6ca8(0x190))/0x5*(parseInt(_0x5a6ca8(0x16f))/0x6)+parseInt(_0x5a6ca8(0x17e))/0x7+parseInt(_0x5a6ca8(0x194))/0x8+-parseInt(_0x5a6ca8(0x158))/0x9*(-parseInt(_0x5a6ca8(0x162))/0xa);if(_0x3759ea===_0x5b0d6a)break;else _0x32c37f['push'](_0x32c37f['shift']());}catch(_0x5d985c){_0x32c37f['push'](_0x32c37f['shift']());}}}(_0x6aa9,0xb5f98));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x3f2bc9 from'path';import _0x4e3ae1 from'fs';import _0x3f8494 from'fs/promises';function _0x6aa9(){const _0x2252c5=['&rkey=','8498063LEMmzd','ext','hotUpdate','oWmEP','1789326Hppmdu','getDesktopTmpPath','1389lZuewn','hVTsn','clearChatCache','getChatCacheList','dwhsY','DsVIm','clearChatCacheInfo','getCacheSessionPathList','defaultFileDownloadPath','AnfkM','KBQNg','fileTypeFromFile','266885jwIMbJ','uploadFile','1200UMDwyM','downloadRichMedia','307512bssvMM','unlink','util','set','2778016eSYWTl','filePath','clearCache','/gchatpic_new/0/0-0-','setCacheSilentScan','group_rkey','getFileSize','downloadMedia','75321Vwapim','tDXkm','图片url获取失败','getStorageCleanService','originImageUrl','/download','getFileCacheInfo','WwsTX','下载超时','rqEPf','1400XcbDUe','getFileType','onLoginSuccess','clearCacheDataByKeys','tmp','basename','copyFile','session','getHotUpdateCachePath','apDIy','jFQJe','eOZNV','scanCache','84kTtXGo','msgId','startsWith','getRichMediaFilePathForGuild','MWFDq','addListener','addCacheScanedPaths','PIC','getMsgService','md5HexStr','getImageUrl','includes','indexOf','getChatCacheInfo'];_0x6aa9=function(){return _0x2252c5;};return _0x6aa9();}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x373f31 from'file-type';import{MsgListener}from'@/core/listeners';import _0x40f49d from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x1b14(_0x49743a,_0x320ce7){const _0x6aa936=_0x6aa9();return _0x1b14=function(_0x1b1430,_0x344e91){_0x1b1430=_0x1b1430-0x155;let _0x4332e1=_0x6aa936[_0x1b1430];return _0x4332e1;},_0x1b14(_0x49743a,_0x320ce7);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x40139b=>{const _0x17a051=_0x1b14,_0x27640b={'AnfkM':function(_0x1e55ce,_0x3f3115){return _0x1e55ce(_0x3f3115);}};for(const [_0x3c26c7,_0x51654c]of downloadMediaTasks){_0x27640b[_0x17a051(0x18d)](_0x51654c,_0x40139b),downloadMediaTasks['delete'](_0x3c26c7);}},setTimeout(()=>{const _0x52197d=_0x1b14;napCatCore[_0x52197d(0x164)](()=>{const _0x2e4c48=_0x52197d;napCatCore[_0x2e4c48(0x174)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x1e5772(0x163)](_0x550d98){const _0x17f066=_0x1e5772;return _0x373f31[_0x17f066(0x18f)](_0x550d98);}static async[_0x1e5772(0x168)](_0x595efe,_0x4b2ff0){const _0x232fad=_0x1e5772;await napCatCore[_0x232fad(0x196)][_0x232fad(0x168)](_0x595efe,_0x4b2ff0);}static async[_0x1e5772(0x156)](_0x2683ce){const _0x5223f7=_0x1e5772;return await napCatCore[_0x5223f7(0x196)]['getFileSize'](_0x2683ce);}static async[_0x1e5772(0x191)](_0x20d64c,_0x2bbbe9=ElementType[_0x1e5772(0x176)],_0x1ab51b=0x0){const _0x11336c=_0x1e5772,_0x14c53e={'kClMV':function(_0x40dc25,_0x388a39){return _0x40dc25+_0x388a39;},'tDXkm':function(_0x3e90f0,_0x304bf0){return _0x3e90f0===_0x304bf0;}},_0x50b2b7=await calculateFileMD5(_0x20d64c);let _0x369ccc=(await NTQQFileApi[_0x11336c(0x163)](_0x20d64c))?.[_0x11336c(0x17f)]||'';_0x369ccc&&(_0x369ccc=_0x14c53e['kClMV']('.',_0x369ccc));let _0x2cfcef=''+_0x3f2bc9[_0x11336c(0x167)](_0x20d64c);_0x14c53e[_0x11336c(0x159)](_0x2cfcef[_0x11336c(0x17b)]('.'),-0x1)&&(_0x2cfcef+=_0x369ccc);const _0xc8a946=napCatCore[_0x11336c(0x169)]['getMsgService']()[_0x11336c(0x172)]({'md5HexStr':_0x50b2b7,'fileName':_0x2cfcef,'elementType':_0x2bbbe9,'elementSubType':_0x1ab51b,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x11336c(0x168)](_0x20d64c,_0xc8a946);const _0x1a8632=await NTQQFileApi[_0x11336c(0x156)](_0x20d64c);return{'md5':_0x50b2b7,'fileName':_0x2cfcef,'path':_0xc8a946,'fileSize':_0x1a8632,'ext':_0x369ccc};}static async[_0x1e5772(0x157)](_0xd9a88e,_0x305cbc,_0x586106,_0x461fda,_0x2bf00b,_0x5c598f,_0x262895=0x3e8*0x3c*0x2,_0x308cf4=![]){const _0x4f275d=_0x1e5772,_0x3a1fbe={'apDIy':_0x4f275d(0x160),'dwhsY':function(_0x14f403){return _0x14f403();},'jFQJe':function(_0x5d6e8c,_0x54241b,_0x4f166d){return _0x5d6e8c(_0x54241b,_0x4f166d);}};if(_0x5c598f&&_0x4e3ae1['existsSync'](_0x5c598f)){if(_0x308cf4)try{await _0x3f8494[_0x4f275d(0x195)](_0x5c598f);}catch(_0x212de7){}else return _0x5c598f;}return new Promise((_0x5caecc,_0xcb7a0a)=>{const _0x3cb81c=_0x4f275d,_0x2d0762={'hVTsn':function(_0x6de315,_0x43ccca){return _0x6de315===_0x43ccca;},'eOZNV':_0x3a1fbe[_0x3cb81c(0x16b)]};let _0x481bff=![];const _0x53eb5a=_0x3eabe9=>{const _0x4948ca=_0x3cb81c;if(_0x2d0762[_0x4948ca(0x185)](_0x3eabe9[_0x4948ca(0x170)],_0xd9a88e)){_0x481bff=!![];let _0x1c0799=_0x3eabe9[_0x4948ca(0x199)];if(_0x1c0799[_0x4948ca(0x171)]('\x5c')){const _0x22cc61=sessionConfig[_0x4948ca(0x18c)];_0x1c0799=_0x3f2bc9['join'](_0x22cc61,_0x1c0799);}_0x5caecc(_0x1c0799);}};downloadMediaTasks[_0x3cb81c(0x197)](_0x3a1fbe[_0x3cb81c(0x188)](randomUUID),_0x53eb5a),_0x3a1fbe[_0x3cb81c(0x16c)](setTimeout,()=>{const _0x1a7cec=_0x3cb81c;!_0x481bff&&_0xcb7a0a(_0x2d0762[_0x1a7cec(0x16d)]);},_0x262895),napCatCore[_0x3cb81c(0x169)][_0x3cb81c(0x177)]()[_0x3cb81c(0x193)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0xd9a88e,'chatType':_0x305cbc,'peerUid':_0x586106,'elementId':_0x461fda,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2bf00b});});}static async['getImageSize'](_0x29b790){const _0x576537={'WwsTX':function(_0x5d751d,_0x17e439,_0xa101a6){return _0x5d751d(_0x17e439,_0xa101a6);}};return new Promise((_0x5794ef,_0x359821)=>{const _0x38aa84=_0x1b14;_0x576537[_0x38aa84(0x15f)](_0x40f49d,_0x29b790,(_0x2ca4fa,_0x3011bb)=>{_0x2ca4fa?_0x359821(_0x2ca4fa):_0x5794ef(_0x3011bb);});});}static async[_0x1e5772(0x179)](_0x3ffb53,_0x313452){const _0x555e04=_0x1e5772,_0x1656be={'KBQNg':_0x555e04(0x15d),'DsVIm':_0x555e04(0x17d),'LrbZb':function(_0x39757f,_0x4c5da2){return _0x39757f+_0x4c5da2;},'KMzym':function(_0x412964,_0x2d0cd9){return _0x412964+_0x2d0cd9;},'MWFDq':function(_0x8bcfdc,_0x4eefcf){return _0x8bcfdc+_0x4eefcf;},'oWmEP':function(_0x2feb1f,_0xc134a7){return _0x2feb1f+_0xc134a7;},'eTwFm':function(_0x390e1d,_0xcc03ec){return _0x390e1d||_0xcc03ec;},'ZzHXG':function(_0x1cf537,_0x2073da){return _0x1cf537||_0x2073da;},'rqEPf':function(_0x25e021,_0x18ae43,_0x23127e){return _0x25e021(_0x18ae43,_0x23127e);},'lJmkV':_0x555e04(0x15a)};if(!_0x3ffb53)return'';const _0x2bd4eb=_0x3ffb53[_0x555e04(0x15c)],_0x206164=_0x3ffb53[_0x555e04(0x178)],_0x367be3=_0x3ffb53['md5HexStr'],_0x540a33=_0x3ffb53['fileUuid'];if(_0x2bd4eb){if(_0x2bd4eb['startsWith'](_0x1656be[_0x555e04(0x18e)])){if(_0x2bd4eb[_0x555e04(0x17a)](_0x1656be[_0x555e04(0x189)]))return _0x1656be['LrbZb'](IMAGE_HTTP_HOST_NT,_0x2bd4eb);const _0x46322b=await rkeyManager['getRkey'](),_0x5326a5=_0x313452?_0x46322b['private_rkey']:_0x46322b[_0x555e04(0x155)];return _0x1656be['KMzym'](_0x1656be[_0x555e04(0x173)](IMAGE_HTTP_HOST_NT,_0x2bd4eb),''+_0x5326a5);}else return _0x1656be[_0x555e04(0x181)](IMAGE_HTTP_HOST,_0x2bd4eb);}else{if(_0x1656be['eTwFm'](_0x367be3,_0x206164))return IMAGE_HTTP_HOST+_0x555e04(0x19b)+_0x1656be['ZzHXG'](_0x367be3,_0x206164)['toUpperCase']()+'/0';}return _0x1656be[_0x555e04(0x161)](logDebug,_0x1656be['lJmkV'],_0x3ffb53),'';}}export class NTQQFileCacheApi{static async[_0x1e5772(0x19c)](_0x481c8f=!![]){return'';}static[_0x1e5772(0x18b)](){return'';}static[_0x1e5772(0x19a)](_0x4b60f5=[_0x1e5772(0x166),_0x1e5772(0x180)]){const _0x13f622=_0x1e5772;return napCatCore[_0x13f622(0x169)]['getStorageCleanService']()[_0x13f622(0x165)](_0x4b60f5);}static['addCacheScannedPaths'](_0x479c61={}){const _0x463dd7=_0x1e5772;return napCatCore[_0x463dd7(0x169)]['getStorageCleanService']()[_0x463dd7(0x175)](_0x479c61);}static[_0x1e5772(0x16e)](){const _0x5a4808=_0x1e5772;return napCatCore[_0x5a4808(0x169)][_0x5a4808(0x15b)]()[_0x5a4808(0x16e)]();}static[_0x1e5772(0x16a)](){return'';}static[_0x1e5772(0x183)](){return'';}static[_0x1e5772(0x187)](_0x5cfe11,_0x3bded8=0x3e8,_0x5ce2c6=0x0){const _0x48788b=_0x1e5772;return napCatCore[_0x48788b(0x169)]['getStorageCleanService']()[_0x48788b(0x17c)](_0x5cfe11,_0x3bded8,0x1,_0x5ce2c6);}static[_0x1e5772(0x15e)](_0x21cf8c,_0x56891c=0x3e8,_0x44d9ad){const _0x1bb14a=_0x44d9ad?_0x44d9ad:{'fileType':_0x21cf8c};}static async[_0x1e5772(0x186)](_0x2840ac=[],_0x4d8213=[]){const _0x5b862d=_0x1e5772;return napCatCore[_0x5b862d(0x169)]['getStorageCleanService']()[_0x5b862d(0x18a)](_0x2840ac,_0x4d8213);}}