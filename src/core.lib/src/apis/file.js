const _0x270329=_0x5c82;(function(_0x206602,_0x33d757){const _0x233923=_0x5c82,_0x5aac5e=_0x206602();while(!![]){try{const _0x335bff=-parseInt(_0x233923(0xda))/0x1*(-parseInt(_0x233923(0xce))/0x2)+parseInt(_0x233923(0xbf))/0x3+-parseInt(_0x233923(0xc0))/0x4*(parseInt(_0x233923(0xc4))/0x5)+parseInt(_0x233923(0xb2))/0x6*(-parseInt(_0x233923(0xc7))/0x7)+-parseInt(_0x233923(0xb0))/0x8*(parseInt(_0x233923(0xd5))/0x9)+parseInt(_0x233923(0xd8))/0xa+parseInt(_0x233923(0xd3))/0xb;if(_0x335bff===_0x33d757)break;else _0x5aac5e['push'](_0x5aac5e['shift']());}catch(_0x12e161){_0x5aac5e['push'](_0x5aac5e['shift']());}}}(_0x23a9,0xe2019));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x59cf34 from'path';import _0x368875 from'fs';import _0x10e3bf from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x2322f5 from'file-type';import{MsgListener}from'@/core/listeners';function _0x23a9(){const _0x2434af=['unlink','clearChatCacheInfo','clearChatCache','getRichMediaFilePathForGuild','OIlxe','getImageUrl','urlResult','clearCacheDataByKeys','203949YcLUgl','12548cyHIkx','getHotUpdateCachePath','nBFjo','join','2270ldDyrE','addListener','private_rkey','133npClSb','boahd','QABWN','startsWith','downloadMedia','md5HexStr','/gchatpic_new/0/0-0-','3025850yJBYzg','RZCEd','fileUuid','getMsgService','HtCuM','19313063XZErjG','basename','9jymsTA','scanCache','getRichMediaService','9332360DInmfw','getFileCacheInfo','1mvTiBY','indexOf','getRkey','elementId','msgId','getFileType','getChatCacheList','delete','group_rkey','PlXZV','includes','kwoVR','getVideoUrl','existsSync','downloadRichMedia','uploadFile','copyFile','domainUrl','getStorageCleanService','addCacheScanedPaths','LgcaG','getDesktopTmpPath','ZZyta','getImageSize','filePath','Cxkpw','util','addCacheScannedPaths','clearCache','/download','url','QuSDF','12229528gFnJKD','onLoginSuccess','123558VZRQLE','&rkey=','session','getFileSize','PIC'];_0x23a9=function(){return _0x2434af;};return _0x23a9();}import _0x16ca6e from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';function _0x5c82(_0x39718a,_0x145788){const _0x23a9a8=_0x23a9();return _0x5c82=function(_0x5c82d2,_0x2bff0b){_0x5c82d2=_0x5c82d2-0x9b;let _0xae37fd=_0x23a9a8[_0x5c82d2];return _0xae37fd;},_0x5c82(_0x39718a,_0x145788);}import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x27c30f=>{const _0x47b5ce=_0x5c82,_0x573c8e={'boahd':function(_0x52ec32,_0x23569d){return _0x52ec32(_0x23569d);}};for(const [_0x2d933e,_0x97baec]of downloadMediaTasks){_0x573c8e[_0x47b5ce(0xc8)](_0x97baec,_0x27c30f),downloadMediaTasks[_0x47b5ce(0xe1)](_0x2d933e);}},setTimeout(()=>{const _0x2f6c39=_0x5c82;napCatCore[_0x2f6c39(0xb1)](()=>{const _0x2010d6=_0x2f6c39;napCatCore[_0x2010d6(0xc5)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x270329(0xdf)](_0x573002){return _0x2322f5['fileTypeFromFile'](_0x573002);}static async[_0x270329(0xa0)](_0x4f5675,_0x1f1093){const _0x5955de=_0x270329;await napCatCore[_0x5955de(0xaa)][_0x5955de(0xa0)](_0x4f5675,_0x1f1093);}static async[_0x270329(0xb5)](_0x1d15dc){const _0x54f5f0=_0x270329;return await napCatCore[_0x54f5f0(0xaa)][_0x54f5f0(0xb5)](_0x1d15dc);}static async[_0x270329(0x9c)](_0x10cccb,_0x5b0968){const _0x5e6b6b=_0x270329;return(await napCatCore[_0x5e6b6b(0xb4)][_0x5e6b6b(0xd7)]()['getVideoPlayUrlV2']({'chatType':_0x10cccb['chatType'],'peerUid':_0x10cccb['peerUid'],'guildId':'0'},_0x10cccb[_0x5e6b6b(0xde)],_0x5b0968[_0x5e6b6b(0xdd)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x5e6b6b(0xbd)][_0x5e6b6b(0xa1)][0x0][_0x5e6b6b(0xae)];}static async[_0x270329(0x9f)](_0x23816e,_0x3f22a6=ElementType[_0x270329(0xb6)],_0x445585=0x0){const _0x3f503d=_0x270329,_0x5ce286={'PlXZV':function(_0x1c0b67,_0x172ae1){return _0x1c0b67(_0x172ae1);},'Cxkpw':function(_0x5a6353,_0x215c21){return _0x5a6353===_0x215c21;}},_0x9889f0=await _0x5ce286[_0x3f503d(0xe3)](calculateFileMD5,_0x23816e);let _0xf5f6ce=(await NTQQFileApi[_0x3f503d(0xdf)](_0x23816e))?.['ext']||'';_0xf5f6ce&&(_0xf5f6ce='.'+_0xf5f6ce);let _0x54bc6f=''+_0x59cf34[_0x3f503d(0xd4)](_0x23816e);_0x5ce286[_0x3f503d(0xa9)](_0x54bc6f[_0x3f503d(0xdb)]('.'),-0x1)&&(_0x54bc6f+=_0xf5f6ce);const _0x357ee9=napCatCore[_0x3f503d(0xb4)]['getMsgService']()[_0x3f503d(0xba)]({'md5HexStr':_0x9889f0,'fileName':_0x54bc6f,'elementType':_0x3f22a6,'elementSubType':_0x445585,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x23816e,_0x357ee9);const _0x157f73=await NTQQFileApi[_0x3f503d(0xb5)](_0x23816e);return{'md5':_0x9889f0,'fileName':_0x54bc6f,'path':_0x357ee9,'fileSize':_0x157f73,'ext':_0xf5f6ce};}static async[_0x270329(0xcb)](_0x30f671,_0x5802a,_0x38a7a1,_0x57e1a2,_0x17fc64,_0x200da1,_0x3f2657=0x3e8*0x3c*0x2,_0x366acd=![]){const _0x377bc8=_0x270329,_0x5e8f04={'kwoVR':function(_0x34b88f,_0x6bddad){return _0x34b88f===_0x6bddad;},'QuSDF':function(_0x46460c,_0x190b4b){return _0x46460c(_0x190b4b);},'OIlxe':function(_0x261327){return _0x261327();},'XddGW':function(_0x2b944d,_0x499943,_0x31a407){return _0x2b944d(_0x499943,_0x31a407);}};if(_0x200da1&&_0x368875[_0x377bc8(0x9d)](_0x200da1)){if(_0x366acd)try{await _0x10e3bf[_0x377bc8(0xb7)](_0x200da1);}catch(_0x5277c9){}else return _0x200da1;}return new Promise((_0x8b8af3,_0x2993c9)=>{const _0x3229d2=_0x377bc8;let _0x30e156=![];const _0x2355a1=_0x44e840=>{const _0x26138a=_0x5c82;if(_0x5e8f04[_0x26138a(0x9b)](_0x44e840['msgId'],_0x30f671)){_0x30e156=!![];let _0x156bb6=_0x44e840[_0x26138a(0xa8)];if(_0x156bb6['startsWith']('\x5c')){const _0x17f66c=sessionConfig['defaultFileDownloadPath'];_0x156bb6=_0x59cf34[_0x26138a(0xc3)](_0x17f66c,_0x156bb6);}_0x8b8af3(_0x156bb6);}};downloadMediaTasks['set'](_0x5e8f04[_0x3229d2(0xbb)](randomUUID),_0x2355a1),_0x5e8f04['XddGW'](setTimeout,()=>{const _0x7b049c=_0x3229d2;!_0x30e156&&_0x5e8f04[_0x7b049c(0xaf)](_0x2993c9,'下载超时');},_0x3f2657),napCatCore['session'][_0x3229d2(0xd1)]()[_0x3229d2(0x9e)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x30f671,'chatType':_0x5802a,'peerUid':_0x38a7a1,'elementId':_0x57e1a2,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x17fc64});});}static async[_0x270329(0xa7)](_0x10cff9){const _0xff7fec={'RZCEd':function(_0x20b7c0,_0x486743){return _0x20b7c0(_0x486743);},'nBFjo':function(_0x1d78ff,_0x3fcfd3,_0x52f8ff){return _0x1d78ff(_0x3fcfd3,_0x52f8ff);}};return new Promise((_0x238402,_0x326800)=>{const _0x5d4c8f=_0x5c82;_0xff7fec[_0x5d4c8f(0xc2)](_0x16ca6e,_0x10cff9,(_0x233053,_0x4fca76)=>{const _0xca9f24=_0x5d4c8f;_0x233053?_0x326800(_0x233053):_0xff7fec[_0xca9f24(0xcf)](_0x238402,_0x4fca76);});});}static async[_0x270329(0xbc)](_0x31b0d5,_0x2c2e71){const _0x5e5ca2=_0x270329,_0x1368cb={'LgcaG':function(_0x215fca,_0x255776){return _0x215fca+_0x255776;},'IJEQv':function(_0x308168,_0x56d6d1){return _0x308168+_0x56d6d1;},'HtCuM':function(_0xf30e4e,_0x18e370){return _0xf30e4e||_0x18e370;},'ZZyta':function(_0x212c87,_0x4626b2){return _0x212c87||_0x4626b2;},'QABWN':function(_0x189ebe,_0x84a0a4,_0x4f355a){return _0x189ebe(_0x84a0a4,_0x4f355a);},'vMvXg':'图片url获取失败'};if(!_0x31b0d5)return'';const _0x56908f=_0x31b0d5['originImageUrl'],_0x5e6f58=_0x31b0d5['md5HexStr'],_0x581090=_0x31b0d5[_0x5e5ca2(0xcc)],_0x2f4474=_0x31b0d5[_0x5e5ca2(0xd0)];if(_0x56908f){if(_0x56908f[_0x5e5ca2(0xca)](_0x5e5ca2(0xad))){if(_0x56908f[_0x5e5ca2(0xe4)](_0x5e5ca2(0xb3)))return _0x1368cb['LgcaG'](IMAGE_HTTP_HOST_NT,_0x56908f);const _0x335eec=await rkeyManager[_0x5e5ca2(0xdc)](),_0x2aef45=_0x2c2e71?_0x335eec[_0x5e5ca2(0xc6)]:_0x335eec[_0x5e5ca2(0xe2)];return _0x1368cb[_0x5e5ca2(0xa4)](IMAGE_HTTP_HOST_NT+_0x56908f,''+_0x2aef45);}else return _0x1368cb['IJEQv'](IMAGE_HTTP_HOST,_0x56908f);}else{if(_0x1368cb[_0x5e5ca2(0xd2)](_0x581090,_0x5e6f58))return IMAGE_HTTP_HOST+_0x5e5ca2(0xcd)+_0x1368cb[_0x5e5ca2(0xa6)](_0x581090,_0x5e6f58)['toUpperCase']()+'/0';}return _0x1368cb[_0x5e5ca2(0xc9)](logDebug,_0x1368cb['vMvXg'],_0x31b0d5),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x4520db=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x270329(0xac)](_0x582198=['tmp','hotUpdate']){const _0x23563a=_0x270329;return napCatCore[_0x23563a(0xb4)]['getStorageCleanService']()[_0x23563a(0xbe)](_0x582198);}static[_0x270329(0xab)](_0x27777c={}){const _0x1deca7=_0x270329;return napCatCore[_0x1deca7(0xb4)][_0x1deca7(0xa2)]()[_0x1deca7(0xa3)](_0x27777c);}static[_0x270329(0xd6)](){const _0x52224a=_0x270329;return napCatCore[_0x52224a(0xb4)]['getStorageCleanService']()['scanCache']();}static[_0x270329(0xc1)](){return'';}static[_0x270329(0xa5)](){return'';}static[_0x270329(0xe0)](_0x4825bd,_0x41b3f4=0x3e8,_0x19a607=0x0){const _0x49dd1b=_0x270329;return napCatCore['session'][_0x49dd1b(0xa2)]()['getChatCacheInfo'](_0x4825bd,_0x41b3f4,0x1,_0x19a607);}static[_0x270329(0xd9)](_0x7cae5b,_0x47e1e1=0x3e8,_0x395a76){const _0x5cbdfd=_0x395a76?_0x395a76:{'fileType':_0x7cae5b};}static async[_0x270329(0xb9)](_0x181196=[],_0x4727ae=[]){const _0x547a5b=_0x270329;return napCatCore[_0x547a5b(0xb4)]['getStorageCleanService']()[_0x547a5b(0xb8)](_0x181196,_0x4727ae);}}