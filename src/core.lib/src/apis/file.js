const _0x40fe2c=_0x1c60;(function(_0x5d3e52,_0xec0f01){const _0x2c9009=_0x1c60,_0x4c89d5=_0x5d3e52();while(!![]){try{const _0x2b54e7=-parseInt(_0x2c9009(0xce))/0x1*(parseInt(_0x2c9009(0xab))/0x2)+parseInt(_0x2c9009(0xa3))/0x3*(parseInt(_0x2c9009(0xca))/0x4)+parseInt(_0x2c9009(0x97))/0x5*(parseInt(_0x2c9009(0xcc))/0x6)+parseInt(_0x2c9009(0x7c))/0x7+parseInt(_0x2c9009(0x88))/0x8*(-parseInt(_0x2c9009(0x99))/0x9)+parseInt(_0x2c9009(0x92))/0xa*(parseInt(_0x2c9009(0x8c))/0xb)+-parseInt(_0x2c9009(0x9a))/0xc*(parseInt(_0x2c9009(0xcb))/0xd);if(_0x2b54e7===_0xec0f01)break;else _0x4c89d5['push'](_0x4c89d5['shift']());}catch(_0x1f1fb3){_0x4c89d5['push'](_0x4c89d5['shift']());}}}(_0x5069,0xf37b3));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0xb0a541 from'path';import _0xb47686 from'fs';import _0x3721b8 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x1884a8 from'file-type';import{MsgListener}from'@/core/listeners';import _0x3d3fbc from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0x25a9f7 from'https';function _0x1c60(_0x2a7d34,_0x437ac3){const _0x50691a=_0x5069();return _0x1c60=function(_0x1c609b,_0x57313b){_0x1c609b=_0x1c609b-0x70;let _0x374aaa=_0x50691a[_0x1c609b];return _0x374aaa;},_0x1c60(_0x2a7d34,_0x437ac3);}let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();function _0x5069(){const _0x40aabc=['hookApi\x20is\x20not\x20available','join','开始调用moeHook获取rkey','RwtbG',',\x20rkey:','group','图片rkey获取失败','downloadRichMedia','10327191NyUCEP','fileTypeFromFile','cgQGy','TDumh','catch','获取图片rkey...','getFileCacheInfo','rPUXV','picElement','zVGay','existsSync','图片rkey有误','100384VEGKuv','md5HexStr','msgId','scanCache','82533IJmqNu','hotUpdate','ZqsZe','then','getChatCacheList','&rkey=','1240OcqmVa','downloadMedia\x20complete','unlink','/gchatpic_new/0/0-0-','PVLgE','2674165AekiyO','addCacheScanedPaths','459rijkIL','1233564TwHfQs','TEFxV','addCacheScannedPaths','clearCacheDataByKeys','chatType','session','BhFRI','getImageUrl','addListener','3KFjlvF','rJGaO','pMqHm','clearChatCacheInfo','yIijA','MhsLG','pDcGY','HeHaK','3637318ZEXGRg','OmZGj','downloadPath','get','KbABb','receive\x20downloadMedia\x20task','downloadMedia','knkng','delete','addTask','getCacheSessionPathList','peerUid','nevZk','clearChatCache','copyFile','uploadFile','originImageUrl','getMsgService','basename','xNVaY','PIC','kMufo','/download','getHotUpdateCachePath','getFileSize','sourcePath','TMITP','util','set','fqxIK','getStorageCleanService','2472740PHQLrj','13WoIIzI','6ggLsHK','OrXXl','1kxaHsT','startsWith','下载超时','HNikU','PhgAl','toUpperCase','includes','error','onRichMediaDownloadComplete','statusCode','now','GnOEo','bnBzR','getRKey','getFileType','vAlao','onLoginSuccess','wckba'];_0x5069=function(){return _0x40aabc;};return _0x5069();}downloadMediaListener[_0x40fe2c(0xd6)]=_0x186096=>{const _0xaa6d3b=_0x40fe2c,_0x4e3387={'xNVaY':function(_0x3311cf,_0x1c211f){return _0x3311cf(_0x1c211f);}};for(const [_0x57efe5,_0x2d4593]of downloadMediaTasks){_0x4e3387[_0xaa6d3b(0xbe)](_0x2d4593,_0x186096),downloadMediaTasks[_0xaa6d3b(0xb3)](_0x57efe5);}},setTimeout(()=>{const _0x21cba6=_0x40fe2c;napCatCore[_0x21cba6(0x72)](()=>{const _0x2d8cb8=_0x21cba6;napCatCore[_0x2d8cb8(0xa2)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x40fe2c(0x70)](_0x155c08){const _0x300552=_0x40fe2c;return _0x1884a8[_0x300552(0x7d)](_0x155c08);}static async[_0x40fe2c(0xb9)](_0x287caf,_0x18b334){const _0x49072c=_0x40fe2c;await napCatCore['util'][_0x49072c(0xb9)](_0x287caf,_0x18b334);}static async[_0x40fe2c(0xc3)](_0x5886f8){const _0x5254c3=_0x40fe2c;return await napCatCore[_0x5254c3(0xc6)][_0x5254c3(0xc3)](_0x5886f8);}static async[_0x40fe2c(0xba)](_0x4d3285,_0x26f2b7=ElementType[_0x40fe2c(0xbf)],_0x2d33a9=0x0){const _0x335a5f=_0x40fe2c,_0x29f6ab={'MiKAx':function(_0x20fac5,_0x1a7dcc){return _0x20fac5(_0x1a7dcc);},'PVLgE':function(_0x333a7d,_0x2681c7){return _0x333a7d===_0x2681c7;}},_0x149fd2=await _0x29f6ab['MiKAx'](calculateFileMD5,_0x4d3285);let _0x2c9a86=(await NTQQFileApi['getFileType'](_0x4d3285))?.['ext']||'';_0x2c9a86&&(_0x2c9a86='.'+_0x2c9a86);let _0x5613a9=''+_0xb0a541[_0x335a5f(0xbd)](_0x4d3285);_0x29f6ab[_0x335a5f(0x96)](_0x5613a9['indexOf']('.'),-0x1)&&(_0x5613a9+=_0x2c9a86);const _0x233a11=napCatCore['session']['getMsgService']()['getRichMediaFilePathForGuild']({'md5HexStr':_0x149fd2,'fileName':_0x5613a9,'elementType':_0x26f2b7,'elementSubType':_0x2d33a9,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x4d3285,_0x233a11);const _0xeaac2b=await NTQQFileApi[_0x335a5f(0xc3)](_0x4d3285);return{'md5':_0x149fd2,'fileName':_0x5613a9,'path':_0x233a11,'fileSize':_0xeaac2b,'ext':_0x2c9a86};}static async[_0x40fe2c(0xb1)](_0xec87e5,_0x401d39,_0x141407,_0x273a9d,_0x423b80,_0x449723,_0x12d66e=0x3e8*0x3c*0x2,_0x5bdb46=![]){const _0x314c38=_0x40fe2c,_0x5c2f0f={'gcFPA':function(_0x5be459,_0x2f0400,_0x1ff91c,_0x4a260a){return _0x5be459(_0x2f0400,_0x1ff91c,_0x4a260a);},'rPUXV':_0x314c38(0x93),'KbABb':function(_0x29fe90,_0x53c1ea){return _0x29fe90===_0x53c1ea;},'gRWQi':function(_0x5c8729,_0xea566d,_0xb9caa5){return _0x5c8729(_0xea566d,_0xb9caa5);},'RwtbG':function(_0xaf8c6f,_0x5a098b){return _0xaf8c6f(_0x5a098b);},'xCVrN':_0x314c38(0xd0),'OrXXl':function(_0x164154){return _0x164154();},'GnOEo':function(_0x104483,_0x3c16c0,_0x16bd81,_0x2f1e1d,_0x11afc2,_0x295e5f,_0x38168b,_0x1ba0f5,_0x2db83d,_0x3186b8){return _0x104483(_0x3c16c0,_0x16bd81,_0x2f1e1d,_0x11afc2,_0x295e5f,_0x38168b,_0x1ba0f5,_0x2db83d,_0x3186b8);},'pDcGY':_0x314c38(0xb0),'zlHyM':'start\x20downloadMedia'};_0x5c2f0f[_0x314c38(0xd9)](logDebug,_0x5c2f0f[_0x314c38(0xa9)],_0xec87e5,_0x401d39,_0x141407,_0x273a9d,_0x423b80,_0x449723,_0x12d66e,_0x5bdb46);if(_0x449723&&_0xb47686[_0x314c38(0x86)](_0x449723)){if(_0x5bdb46)try{await _0x3721b8[_0x314c38(0x94)](_0x449723);}catch(_0x853649){}else return _0x449723;}return logDebug(_0x5c2f0f['zlHyM'],_0xec87e5,_0x401d39,_0x141407,_0x273a9d,_0x423b80,_0x449723,_0x12d66e,_0x5bdb46),new Promise((_0x5bfcca,_0x312562)=>{const _0x39d7ac=_0x314c38;let _0x332c89=![];const _0x31c964=_0x324f81=>{const _0x560c57=_0x1c60;_0x5c2f0f['gcFPA'](logDebug,_0x5c2f0f[_0x560c57(0x83)],_0x324f81,_0xec87e5);if(_0x5c2f0f[_0x560c57(0xaf)](_0x324f81[_0x560c57(0x8a)],_0xec87e5)){_0x332c89=!![];let _0x29d316=_0x324f81['filePath'];if(_0x29d316['startsWith']('\x5c')){const _0x4ab5b3=sessionConfig['defaultFileDownloadPath'];_0x5c2f0f['gRWQi'](logDebug,_0x560c57(0xad),_0x4ab5b3),_0x29d316=_0xb0a541[_0x560c57(0x75)](_0x4ab5b3,_0x29d316);}_0x5c2f0f['RwtbG'](_0x5bfcca,_0x29d316);}};downloadMediaTasks[_0x39d7ac(0xc7)](_0x5c2f0f[_0x39d7ac(0xcd)](randomUUID),_0x31c964),setTimeout(()=>{const _0x580db2=_0x39d7ac;!_0x332c89&&_0x5c2f0f[_0x580db2(0x77)](_0x312562,_0x5c2f0f['xCVrN']);},_0x12d66e),napCatCore[_0x39d7ac(0x9f)][_0x39d7ac(0xbc)]()[_0x39d7ac(0x7b)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0xec87e5,'chatType':_0x401d39,'peerUid':_0x141407,'elementId':_0x273a9d,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x423b80});});}static async['getImageSize'](_0x4a655b){const _0x4a4d21={'hkTDN':function(_0x169528,_0x2eab45){return _0x169528(_0x2eab45);},'OlwcA':function(_0x690347,_0x2885a9){return _0x690347(_0x2885a9);},'bnBzR':function(_0x1b6e4d,_0x2c51bf,_0x8b4469){return _0x1b6e4d(_0x2c51bf,_0x8b4469);}};return new Promise((_0x4da50f,_0x5b0611)=>{const _0x228d56=_0x1c60,_0x397ef5={'TMITP':function(_0x52f411,_0x543d3f){return _0x4a4d21['hkTDN'](_0x52f411,_0x543d3f);},'HNikU':function(_0x3a4b12,_0x51ba7f){return _0x4a4d21['OlwcA'](_0x3a4b12,_0x51ba7f);}};_0x4a4d21[_0x228d56(0xda)](_0x3d3fbc,_0x4a655b,(_0x2a7c5f,_0x3272ae)=>{const _0x261263=_0x228d56;_0x2a7c5f?_0x397ef5[_0x261263(0xc5)](_0x5b0611,_0x2a7c5f):_0x397ef5[_0x261263(0xd1)](_0x4da50f,_0x3272ae);});});}static async[_0x40fe2c(0xa1)](_0x3babb0){const _0x545ef1=_0x40fe2c,_0x1fe82e={'MhsLG':_0x545ef1(0xd5),'MNjFs':function(_0x489475,_0xeba124){return _0x489475!==_0xeba124;},'knkng':function(_0x72562f,_0x11f389){return _0x72562f(_0x11f389);},'kMufo':function(_0x3ef98c,_0xdfe0e8){return _0x3ef98c(_0xdfe0e8);},'zVGay':function(_0x58b164,_0xfa095){return _0x58b164(_0xfa095);},'TEFxV':_0x545ef1(0x81),'ZqsZe':function(_0x3974e5,_0x103325){return _0x3974e5*_0x103325;},'yIijA':function(_0x272909,_0x3fc14e){return _0x272909(_0x3fc14e);},'MlUEt':function(_0xb658a7,_0x3fa8fc){return _0xb658a7(_0x3fa8fc);},'nevZk':function(_0x2c9657,_0x358461){return _0x2c9657+_0x358461;},'rJGaO':function(_0x3052f6,_0x4cbd69,_0x1965f){return _0x3052f6(_0x4cbd69,_0x1965f);},'HeHaK':'检查rkey是否有效','jvoNT':'图片rkey有效','XmRrE':function(_0x1c9299,_0x4e6b45,_0x18b1db,_0x306507){return _0x1c9299(_0x4e6b45,_0x18b1db,_0x306507);},'cgQGy':_0x545ef1(0x87),'hGaQI':function(_0x27bbfa){return _0x27bbfa();},'vAlao':_0x545ef1(0x91),'szRMF':function(_0x16ca0c){return _0x16ca0c();},'TDumh':_0x545ef1(0x7a),'fqxIK':function(_0x1b7286,_0xbb5e71){return _0x1b7286||_0xbb5e71;},'mhJqj':function(_0x4ba871,_0x5dfafb){return _0x4ba871||_0x5dfafb;}},_0x4e80e4=_0x3babb0[_0x545ef1(0x9e)]!==ChatType[_0x545ef1(0x79)],_0x537625=_0x3babb0['elements']['find'](_0xb046de=>!!_0xb046de['picElement']);if(!_0x537625)return'';const _0x883aa7=_0x537625[_0x545ef1(0x84)][_0x545ef1(0xbb)],_0x356a0a=_0x537625[_0x545ef1(0x84)][_0x545ef1(0x89)],_0x2e4099=_0x537625[_0x545ef1(0x84)][_0x545ef1(0x89)],_0x1a23e1=_0x537625[_0x545ef1(0x84)]['fileUuid'],_0x4f77fb=_0x76ce95=>{const _0x5e4c0d=_0x545ef1;_0x4e80e4?(privateImageRKey=_0x76ce95,lastGetPrivateRKeyTime=Date[_0x5e4c0d(0xd8)]()):(groupImageRKey=_0x76ce95,lastGetGroupRKeyTime=Date[_0x5e4c0d(0xd8)]());};if(_0x883aa7){if(_0x883aa7[_0x545ef1(0xcf)](_0x545ef1(0xc1))){if(_0x883aa7[_0x545ef1(0xd4)](_0x1fe82e[_0x545ef1(0x71)]))return IMAGE_HTTP_HOST_NT+_0x883aa7;if(!hookApi['isAvailable']())return _0x1fe82e[_0x545ef1(0xc0)](logDebug,_0x545ef1(0x74)),'';const _0x218e44=async()=>{const _0x3200b4=_0x545ef1,_0x13c12f={'wckba':function(_0x3835db,_0x5b0a0a){return _0x1fe82e['MNjFs'](_0x3835db,_0x5b0a0a);},'pMqHm':function(_0x1537f0,_0x6f2ac3){const _0x18d669=_0x1c60;return _0x1fe82e[_0x18d669(0xb2)](_0x1537f0,_0x6f2ac3);},'OmZGj':function(_0x1c8699,_0x1e1f8c){const _0x3590c5=_0x1c60;return _0x1fe82e[_0x3590c5(0xc0)](_0x1c8699,_0x1e1f8c);}};_0x1fe82e[_0x3200b4(0x85)](logDebug,_0x1fe82e[_0x3200b4(0x9b)]),NTQQFileApi[_0x3200b4(0xb1)](_0x3babb0['msgId'],_0x3babb0[_0x3200b4(0x9e)],_0x3babb0[_0x3200b4(0xb6)],_0x537625['elementId'],'',_0x537625[_0x3200b4(0x84)][_0x3200b4(0xc4)],_0x1fe82e[_0x3200b4(0x8e)](0x3e8,0x1e),!![])[_0x3200b4(0x8f)](_0x298f01=>{})[_0x3200b4(0x80)](logError),await _0x1fe82e[_0x3200b4(0xa7)](sleep,0x3e8),_0x1fe82e['MlUEt'](logDebug,_0x3200b4(0x76));const _0x12c212=hookApi[_0x3200b4(0xdb)]()||'',_0x5603bf=_0x1fe82e[_0x3200b4(0xb7)](_0x1fe82e[_0x3200b4(0xb7)](IMAGE_HTTP_HOST_NT,_0x883aa7),_0x12c212);if(_0x12c212)try{_0x1fe82e[_0x3200b4(0xa4)](logDebug,_0x1fe82e[_0x3200b4(0xaa)],_0x5603bf),await new Promise((_0x6aa8cd,_0x10ec5d)=>{const _0x328395=_0x3200b4;_0x25a9f7[_0x328395(0xae)](_0x5603bf,_0x758977=>{const _0x185479=_0x328395;_0x13c12f[_0x185479(0x73)](_0x758977[_0x185479(0xd7)],0xc8)?_0x13c12f[_0x185479(0xa5)](_0x10ec5d,_0x185479(0x7a)):_0x13c12f[_0x185479(0xac)](_0x6aa8cd,_0x758977);})['on'](_0x1fe82e[_0x328395(0xa8)],_0x2ff70e=>{_0x10ec5d(_0x2ff70e);});}),_0x1fe82e[_0x3200b4(0xa4)](logDebug,_0x1fe82e['jvoNT'],_0x5603bf),_0x4f77fb(_0x12c212);}catch(_0x54243a){return _0x1fe82e['XmRrE'](logError,_0x1fe82e[_0x3200b4(0x7e)],_0x5603bf,_0x54243a),'';}return _0x12c212;},_0x5ea699=()=>new Promise((_0x32883d,_0x4df418)=>{const _0x61f117=_0x545ef1,_0x5daab6={'BhFRI':function(_0x5b738e){return _0x1fe82e['hGaQI'](_0x5b738e);},'PhgAl':function(_0x1c627d,_0x3e72c4){return _0x1c627d(_0x3e72c4);}};getRKeyTaskQueue[_0x61f117(0xb4)](async()=>{const _0x2cb07b=_0x61f117,_0x26bc1f=await _0x5daab6[_0x2cb07b(0xa0)](_0x218e44);_0x5daab6[_0x2cb07b(0xd2)](_0x32883d,_0x26bc1f);});}),_0x187564=_0x4e80e4?privateImageRKey:groupImageRKey,_0x4cd94f=_0x4e80e4?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(Date[_0x545ef1(0xd8)]()-_0x4cd94f>rkeyExpireTime||!_0x187564){_0x1fe82e[_0x545ef1(0xb2)](logDebug,'rkey过期或着未获取,\x20url:'+_0x883aa7+_0x545ef1(0x78)+_0x187564);const _0x14832a=await _0x1fe82e['szRMF'](_0x5ea699);if(_0x14832a)return _0x1fe82e['nevZk'](IMAGE_HTTP_HOST_NT,_0x883aa7)+(''+_0x14832a);else _0x1fe82e[_0x545ef1(0xa4)](logError,_0x1fe82e[_0x545ef1(0x7f)],_0x883aa7);}if(_0x187564)return IMAGE_HTTP_HOST_NT+_0x883aa7+(''+_0x187564);return'';}else return _0x1fe82e[_0x545ef1(0xb7)](IMAGE_HTTP_HOST,_0x883aa7);}else{if(_0x1fe82e[_0x545ef1(0xc8)](_0x2e4099,_0x356a0a))return IMAGE_HTTP_HOST+_0x545ef1(0x95)+_0x1fe82e['mhJqj'](_0x2e4099,_0x356a0a)[_0x545ef1(0xd3)]()+'/0';}return _0x1fe82e['rJGaO'](logDebug,'图片url获取失败',_0x3babb0),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0xdf6a=!![]){return'';}static[_0x40fe2c(0xb5)](){return'';}static['clearCache'](_0x2f0908=['tmp',_0x40fe2c(0x8d)]){const _0x5b0a2e=_0x40fe2c;return napCatCore['session'][_0x5b0a2e(0xc9)]()[_0x5b0a2e(0x9d)](_0x2f0908);}static[_0x40fe2c(0x9c)](_0xd8acb4={}){const _0x1254d4=_0x40fe2c;return napCatCore[_0x1254d4(0x9f)][_0x1254d4(0xc9)]()[_0x1254d4(0x98)](_0xd8acb4);}static[_0x40fe2c(0x8b)](){const _0x904776=_0x40fe2c;return napCatCore[_0x904776(0x9f)][_0x904776(0xc9)]()[_0x904776(0x8b)]();}static[_0x40fe2c(0xc2)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x40fe2c(0x90)](_0xfb406,_0x12a580=0x3e8,_0x3ee5d9=0x0){const _0x160f5f=_0x40fe2c;return napCatCore[_0x160f5f(0x9f)][_0x160f5f(0xc9)]()['getChatCacheInfo'](_0xfb406,_0x12a580,0x1,_0x3ee5d9);}static[_0x40fe2c(0x82)](_0x1db825,_0x381294=0x3e8,_0x7e6d14){const _0x1be5fe=_0x7e6d14?_0x7e6d14:{'fileType':_0x1db825};}static async[_0x40fe2c(0xb8)](_0x3cf218=[],_0x3722cb=[]){const _0x1f44b4=_0x40fe2c;return napCatCore[_0x1f44b4(0x9f)][_0x1f44b4(0xc9)]()[_0x1f44b4(0xa6)](_0x3cf218,_0x3722cb);}}