const _0x4f84e1=_0x2261;(function(_0x2ff7b9,_0x120443){const _0x5a7ee8=_0x2261,_0x5981b3=_0x2ff7b9();while(!![]){try{const _0x5ad13a=-parseInt(_0x5a7ee8(0x109))/0x1*(-parseInt(_0x5a7ee8(0x106))/0x2)+-parseInt(_0x5a7ee8(0xdf))/0x3*(parseInt(_0x5a7ee8(0x117))/0x4)+-parseInt(_0x5a7ee8(0xf5))/0x5*(parseInt(_0x5a7ee8(0x11b))/0x6)+-parseInt(_0x5a7ee8(0xf3))/0x7+parseInt(_0x5a7ee8(0x11c))/0x8*(-parseInt(_0x5a7ee8(0xeb))/0x9)+-parseInt(_0x5a7ee8(0x101))/0xa+parseInt(_0x5a7ee8(0x121))/0xb;if(_0x5ad13a===_0x120443)break;else _0x5981b3['push'](_0x5981b3['shift']());}catch(_0x585716){_0x5981b3['push'](_0x5981b3['shift']());}}}(_0x20eb,0xe14d1));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x34774 from'path';import _0x3e1b39 from'fs';import _0x140e5e from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';function _0x2261(_0x13945c,_0x47b305){const _0x20eb16=_0x20eb();return _0x2261=function(_0x2261f1,_0x149b0a){_0x2261f1=_0x2261f1-0xd8;let _0x3ae41e=_0x20eb16[_0x2261f1];return _0x3ae41e;},_0x2261(_0x13945c,_0x47b305);}import{calculateFileMD5}from'@/common/utils/file';function _0x20eb(){const _0x2bd610=['clearCacheDataByKeys','downloadRichMedia','start\x20downloadMedia','158oUDLOk','ModSE','yBiRA','18353hHbNCD','group_rkey','下载超时','receive\x20downloadMedia\x20task','downloadMedia','msgId','basename','iTtss','图片url获取失败','util','/gchatpic_new/0/0-0-','private_rkey','getChatCacheList','OSQTb','2344984LoztPZ','getRkey','VwOMG','onLoginSuccess','984vUAMjd','8SfzIrC','DLSUx','md5HexStr','CaVBe','delete','46319702VfGyyX','filePath','downloadMedia\x20complete','copyFile','getImageSize','getFileType','scanCache','addCacheScannedPaths','&rkey=','includes','getStorageCleanService','9PjayXQ','getMsgService','qEgGy','eFYFo','ext','uiNFx','onRichMediaDownloadComplete','getHotUpdateCachePath','KFPOP','fileTypeFromFile','hotUpdate','tmp','2929023vGOyqf','/download','wiVxY','clearCache','fileUuid','unlink','setCacheSilentScan','HUmfB','12094012eBiqvv','getCacheSessionPathList','10405WxBGVi','getDesktopTmpPath','startsWith','downloadPath','getImageUrl','addCacheScanedPaths','izlBj','session','getChatCacheInfo','set','getFileSize','PIC','5847510ZlcmcG','existsSync'];_0x20eb=function(){return _0x2bd610;};return _0x20eb();}import*as _0xe32f95 from'file-type';import{MsgListener}from'@/core/listeners';import _0x505c5f from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x4f84e1(0xe5)]=_0x507c1e=>{const _0x77dd68=_0x4f84e1;for(const [_0x99e4e3,_0xc29a33]of downloadMediaTasks){_0xc29a33(_0x507c1e),downloadMediaTasks[_0x77dd68(0x120)](_0x99e4e3);}},setTimeout(()=>{const _0x527428=_0x4f84e1;napCatCore[_0x527428(0x11a)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x1608d5){const _0x23b7db=_0x4f84e1;return _0xe32f95[_0x23b7db(0xe8)](_0x1608d5);}static async[_0x4f84e1(0x124)](_0x240829,_0x38ed63){const _0x2f7a56=_0x4f84e1;await napCatCore[_0x2f7a56(0x112)][_0x2f7a56(0x124)](_0x240829,_0x38ed63);}static async[_0x4f84e1(0xff)](_0x3282ca){const _0xdc46b1=_0x4f84e1;return await napCatCore['util'][_0xdc46b1(0xff)](_0x3282ca);}static async['uploadFile'](_0xbbba9b,_0x212a27=ElementType[_0x4f84e1(0x100)],_0x3fc526=0x0){const _0x2baabb=_0x4f84e1,_0x26f7da={'KFPOP':function(_0x285bb5,_0xbd8264){return _0x285bb5(_0xbd8264);}},_0x9052ac=await _0x26f7da[_0x2baabb(0xe7)](calculateFileMD5,_0xbbba9b);let _0x1b5097=(await NTQQFileApi[_0x2baabb(0xd9)](_0xbbba9b))?.[_0x2baabb(0xe3)]||'';_0x1b5097&&(_0x1b5097='.'+_0x1b5097);let _0x3adc57=''+_0x34774[_0x2baabb(0x10f)](_0xbbba9b);_0x3adc57['indexOf']('.')===-0x1&&(_0x3adc57+=_0x1b5097);const _0x341c02=napCatCore[_0x2baabb(0xfc)][_0x2baabb(0xe0)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x9052ac,'fileName':_0x3adc57,'elementType':_0x212a27,'elementSubType':_0x3fc526,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x2baabb(0x124)](_0xbbba9b,_0x341c02);const _0x3b77a1=await NTQQFileApi[_0x2baabb(0xff)](_0xbbba9b);return{'md5':_0x9052ac,'fileName':_0x3adc57,'path':_0x341c02,'fileSize':_0x3b77a1,'ext':_0x1b5097};}static async[_0x4f84e1(0x10d)](_0x9d3637,_0x4ffa12,_0x479e82,_0x927a01,_0x5d49fc,_0x1a2d71,_0xdd7a3c=0x3e8*0x3c*0x2,_0x50a2c3=![]){const _0x90baf8=_0x4f84e1,_0x517b1d={'CaVBe':_0x90baf8(0x123),'eFYFo':_0x90baf8(0xf8),'OSQTb':function(_0x1b6213,_0x5c8d6e){return _0x1b6213(_0x5c8d6e);},'JInvf':function(_0xda4b23){return _0xda4b23();},'izlBj':function(_0x3804d0,_0x3213f4,_0x115f52,_0x555ca2,_0xd9d82,_0x3d1c3f,_0x32b187,_0x1651d0,_0x463d7f,_0x5f4bdf){return _0x3804d0(_0x3213f4,_0x115f52,_0x555ca2,_0xd9d82,_0x3d1c3f,_0x32b187,_0x1651d0,_0x463d7f,_0x5f4bdf);},'HUmfB':_0x90baf8(0x10c),'wiVxY':_0x90baf8(0x105)};_0x517b1d[_0x90baf8(0xfb)](logDebug,_0x517b1d[_0x90baf8(0xf2)],_0x9d3637,_0x4ffa12,_0x479e82,_0x927a01,_0x5d49fc,_0x1a2d71,_0xdd7a3c,_0x50a2c3);if(_0x1a2d71&&_0x3e1b39[_0x90baf8(0x102)](_0x1a2d71)){if(_0x50a2c3)try{await _0x140e5e[_0x90baf8(0xf0)](_0x1a2d71);}catch(_0xb653a2){}else return _0x1a2d71;}return _0x517b1d['izlBj'](logDebug,_0x517b1d[_0x90baf8(0xed)],_0x9d3637,_0x4ffa12,_0x479e82,_0x927a01,_0x5d49fc,_0x1a2d71,_0xdd7a3c,_0x50a2c3),new Promise((_0x5bb1ab,_0x4d4823)=>{const _0x563661=_0x90baf8,_0x25a14d={'uiNFx':function(_0x380267,_0x445ba2){const _0x1cd1dc=_0x2261;return _0x517b1d[_0x1cd1dc(0x116)](_0x380267,_0x445ba2);}};let _0x3a848f=![];const _0x4cb605=_0x418c25=>{const _0x28d435=_0x2261;logDebug(_0x517b1d[_0x28d435(0x11f)],_0x418c25,_0x9d3637);if(_0x418c25[_0x28d435(0x10e)]===_0x9d3637){_0x3a848f=!![];let _0x494805=_0x418c25[_0x28d435(0x122)];if(_0x494805['startsWith']('\x5c')){const _0x517cdf=sessionConfig['defaultFileDownloadPath'];logDebug(_0x517b1d[_0x28d435(0xe2)],_0x517cdf),_0x494805=_0x34774['join'](_0x517cdf,_0x494805);}_0x517b1d[_0x28d435(0x116)](_0x5bb1ab,_0x494805);}};downloadMediaTasks[_0x563661(0xfe)](_0x517b1d['JInvf'](randomUUID),_0x4cb605),setTimeout(()=>{const _0x3eba1f=_0x563661;!_0x3a848f&&_0x25a14d[_0x3eba1f(0xe4)](_0x4d4823,_0x3eba1f(0x10b));},_0xdd7a3c),napCatCore[_0x563661(0xfc)][_0x563661(0xe0)]()[_0x563661(0x104)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x9d3637,'chatType':_0x4ffa12,'peerUid':_0x479e82,'elementId':_0x927a01,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x5d49fc});});}static async[_0x4f84e1(0xd8)](_0x4d7309){const _0x100135={'VwOMG':function(_0x155637,_0x5c0b70){return _0x155637(_0x5c0b70);}};return new Promise((_0xfa3143,_0x3f5d73)=>{_0x505c5f(_0x4d7309,(_0x15b730,_0x54208b)=>{const _0x5a5020=_0x2261;_0x15b730?_0x100135[_0x5a5020(0x119)](_0x3f5d73,_0x15b730):_0x100135[_0x5a5020(0x119)](_0xfa3143,_0x54208b);});});}static async[_0x4f84e1(0xf9)](_0x4d03af,_0x6b6bb5){const _0x36a132=_0x4f84e1,_0x89201={'DLSUx':_0x36a132(0xec),'EYGLl':_0x36a132(0xdc),'yBiRA':function(_0x2b3ae4,_0x379916){return _0x2b3ae4+_0x379916;},'qEgGy':function(_0x17b9e4,_0x33a21c){return _0x17b9e4||_0x33a21c;},'iTtss':function(_0x2fe937,_0x33b697,_0x1b250d){return _0x2fe937(_0x33b697,_0x1b250d);},'ModSE':_0x36a132(0x111)};if(!_0x4d03af)return'';const _0x375a94=_0x4d03af['originImageUrl'],_0x4c3598=_0x4d03af['md5HexStr'],_0x4a12dc=_0x4d03af[_0x36a132(0x11e)],_0x2e16e5=_0x4d03af[_0x36a132(0xef)];if(_0x375a94){if(_0x375a94[_0x36a132(0xf7)](_0x89201[_0x36a132(0x11d)])){if(_0x375a94[_0x36a132(0xdd)](_0x89201['EYGLl']))return IMAGE_HTTP_HOST_NT+_0x375a94;const _0x592286=await rkeyManager[_0x36a132(0x118)](),_0x4d4015=_0x6b6bb5?_0x592286[_0x36a132(0x114)]:_0x592286[_0x36a132(0x10a)];return _0x89201[_0x36a132(0x108)](_0x89201[_0x36a132(0x108)](IMAGE_HTTP_HOST_NT,_0x375a94),''+_0x4d4015);}else return _0x89201[_0x36a132(0x108)](IMAGE_HTTP_HOST,_0x375a94);}else{if(_0x89201[_0x36a132(0xe1)](_0x4a12dc,_0x4c3598))return IMAGE_HTTP_HOST+_0x36a132(0x113)+_0x89201[_0x36a132(0xe1)](_0x4a12dc,_0x4c3598)['toUpperCase']()+'/0';}return _0x89201[_0x36a132(0x110)](logDebug,_0x89201[_0x36a132(0x107)],_0x4d03af),'';}}export class NTQQFileCacheApi{static async[_0x4f84e1(0xf1)](_0x35c2d1=!![]){return'';}static[_0x4f84e1(0xf4)](){return'';}static[_0x4f84e1(0xee)](_0x2a2db2=[_0x4f84e1(0xea),_0x4f84e1(0xe9)]){const _0x283300=_0x4f84e1;return napCatCore[_0x283300(0xfc)][_0x283300(0xde)]()[_0x283300(0x103)](_0x2a2db2);}static[_0x4f84e1(0xdb)](_0x3fcfa5={}){const _0x47b225=_0x4f84e1;return napCatCore[_0x47b225(0xfc)][_0x47b225(0xde)]()[_0x47b225(0xfa)](_0x3fcfa5);}static['scanCache'](){const _0x3bd264=_0x4f84e1;return napCatCore[_0x3bd264(0xfc)][_0x3bd264(0xde)]()[_0x3bd264(0xda)]();}static[_0x4f84e1(0xe6)](){return'';}static[_0x4f84e1(0xf6)](){return'';}static[_0x4f84e1(0x115)](_0x76f688,_0x57626f=0x3e8,_0x42437f=0x0){const _0x1cbaf1=_0x4f84e1;return napCatCore['session'][_0x1cbaf1(0xde)]()[_0x1cbaf1(0xfd)](_0x76f688,_0x57626f,0x1,_0x42437f);}static['getFileCacheInfo'](_0x1dbb65,_0x4e51f8=0x3e8,_0x2bc411){const _0x1095e4=_0x2bc411?_0x2bc411:{'fileType':_0x1dbb65};}static async['clearChatCache'](_0x54708a=[],_0x124665=[]){return napCatCore['session']['getStorageCleanService']()['clearChatCacheInfo'](_0x54708a,_0x124665);}}