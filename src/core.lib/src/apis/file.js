const _0x204330=_0x2296;(function(_0x427df8,_0x455fe9){const _0x270fe5=_0x2296,_0x2816ed=_0x427df8();while(!![]){try{const _0x40fda6=-parseInt(_0x270fe5(0x108))/0x1+parseInt(_0x270fe5(0xd6))/0x2+parseInt(_0x270fe5(0x10d))/0x3+-parseInt(_0x270fe5(0x11d))/0x4*(parseInt(_0x270fe5(0xd9))/0x5)+parseInt(_0x270fe5(0x120))/0x6*(-parseInt(_0x270fe5(0x122))/0x7)+parseInt(_0x270fe5(0xf5))/0x8*(parseInt(_0x270fe5(0xed))/0x9)+-parseInt(_0x270fe5(0x10a))/0xa*(-parseInt(_0x270fe5(0x12b))/0xb);if(_0x40fda6===_0x455fe9)break;else _0x2816ed['push'](_0x2816ed['shift']());}catch(_0x2920de){_0x2816ed['push'](_0x2816ed['shift']());}}}(_0x3ab5,0x94a69));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x43e3e5 from'path';import _0x6716c8 from'fs';import _0x3e1f15 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x379946 from'file-type';import{MsgListener}from'@/core/listeners';import _0x4c6085 from'image-size';function _0x2296(_0x4d9ae7,_0x5f4a38){const _0x3ab52a=_0x3ab5();return _0x2296=function(_0x229620,_0x209bbe){_0x229620=_0x229620-0xc4;let _0x3c5bd7=_0x3ab52a[_0x229620];return _0x3c5bd7;},_0x2296(_0x4d9ae7,_0x5f4a38);}import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';function _0x3ab5(){const _0x8ad19f=['tmp','downloadMedia\x20complete','hotUpdate','HKRPH','copyFile','addCacheScannedPaths','/gchatpic_new/0/0-0-','IxGoK','getMsgService','atiSv','ctFuL','图片rkey有误','hookApi\x20is\x20not\x20available','originImageUrl','delete','1153690xhrQUT','error','includes','169245LzEEgE','PIC','addCacheScanedPaths','getFileType','catch','toUpperCase','VxldF','getRKey','psyUx','YctpS','picElement','now','ext','cJKkj','getImageSize','getFileCacheInfo','elementId','md5HexStr','rkey过期或着未获取,\x20url:','ZsKsy','1216665nrhuEt','DXYuE','peerUid','isAvailable','sourcePath','getImageUrl','JLuLD','wpNrd','48FIvpPi','getFileSize','then','图片rkey有效','downloadRichMedia','getChatCacheList','set','fukZe','dtUTA','下载超时','kNate','addListener','clearCache','hQIHL','getDesktopTmpPath','KxbfA','clearChatCacheInfo','uploadFile','/download','717976OJLDFi',',\x20rkey:','190deJxcc','getChatCacheInfo','clearChatCache','1753494LfFrIf','fpVbs','vjKvd','scanCache','bTgkg','basename','TvNqN','ppNVH','xypsE','uuZfJ','vduqh','GdBhe','addTask','session','startsWith','msgId','16hsqETz','find','sIfSz','362148FAPlxG','MHBPR','105mCYyni','clearCacheDataByKeys','statusCode','图片rkey获取失败','downloadMedia','downloadPath','setCacheSilentScan','start\x20downloadMedia','onRichMediaDownloadComplete','228778iMLOmZ','group','existsSync','yFRBj','nLINR','检查rkey是否有效','fileTypeFromFile','获取图片rkey...','nIEVz','receive\x20downloadMedia\x20task','chatType','getStorageCleanService','开始调用moeHook获取rkey','get','getCacheSessionPathList','getRichMediaFilePathForGuild','util'];_0x3ab5=function(){return _0x8ad19f;};return _0x3ab5();}import _0x28e146 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x204330(0x12a)]=_0x5c51b8=>{const _0x4c1d07=_0x204330,_0x396ac9={'fpVbs':function(_0x178008,_0x4a693b){return _0x178008(_0x4a693b);}};for(const [_0x4a1242,_0x3162b6]of downloadMediaTasks){_0x396ac9[_0x4c1d07(0x10e)](_0x3162b6,_0x5c51b8),downloadMediaTasks[_0x4c1d07(0xd5)](_0x4a1242);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x1fcd95=_0x2296;napCatCore[_0x1fcd95(0x100)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x204330(0xdc)](_0x3041d6){const _0x30b151=_0x204330;return _0x379946[_0x30b151(0x131)](_0x3041d6);}static async['copyFile'](_0x5abff1,_0x373a0b){const _0x4265c1=_0x204330;await napCatCore[_0x4265c1(0xc6)]['copyFile'](_0x5abff1,_0x373a0b);}static async[_0x204330(0xf6)](_0x2d2bcf){return await napCatCore['util']['getFileSize'](_0x2d2bcf);}static async[_0x204330(0x106)](_0x218377,_0x4db477=ElementType[_0x204330(0xda)],_0x5b5c87=0x0){const _0x50efbf=_0x204330,_0x4d705b={'sIfSz':function(_0x32c07f,_0x293ff7){return _0x32c07f(_0x293ff7);},'JNPmL':function(_0x141e94,_0x2dfaae){return _0x141e94+_0x2dfaae;},'bTgkg':function(_0x3db901,_0xe4bf60){return _0x3db901===_0xe4bf60;}},_0x4cbd40=await _0x4d705b[_0x50efbf(0x11f)](calculateFileMD5,_0x218377);let _0x2f39e9=(await NTQQFileApi[_0x50efbf(0xdc)](_0x218377))?.[_0x50efbf(0xe5)]||'';_0x2f39e9&&(_0x2f39e9=_0x4d705b['JNPmL']('.',_0x2f39e9));let _0x449e90=''+_0x43e3e5[_0x50efbf(0x112)](_0x218377);_0x4d705b[_0x50efbf(0x111)](_0x449e90['indexOf']('.'),-0x1)&&(_0x449e90+=_0x2f39e9);const _0x2e031c=napCatCore[_0x50efbf(0x11a)]['getMsgService']()[_0x50efbf(0xc5)]({'md5HexStr':_0x4cbd40,'fileName':_0x449e90,'elementType':_0x4db477,'elementSubType':_0x5b5c87,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x50efbf(0xcb)](_0x218377,_0x2e031c);const _0x4cc435=await NTQQFileApi[_0x50efbf(0xf6)](_0x218377);return{'md5':_0x4cbd40,'fileName':_0x449e90,'path':_0x2e031c,'fileSize':_0x4cc435,'ext':_0x2f39e9};}static async['downloadMedia'](_0x23780f,_0x502d62,_0x36debc,_0x14134f,_0x3fd955,_0x43bde9,_0x53021e=0x3e8*0x3c*0x2,_0x1fc701=![]){const _0x5e7ed8=_0x204330,_0x4e6014={'ZsKsy':function(_0xd3a3e5){return _0xd3a3e5();},'YctpS':function(_0x5f239f,_0x74f3b8,_0x435135,_0x504f85,_0x7f3952,_0x13f763,_0xe1158d,_0x3f5837,_0x38e767,_0x2dc014){return _0x5f239f(_0x74f3b8,_0x435135,_0x504f85,_0x7f3952,_0x13f763,_0xe1158d,_0x3f5837,_0x38e767,_0x2dc014);},'vjKvd':_0x5e7ed8(0x134),'hQIHL':_0x5e7ed8(0x129)};_0x4e6014['YctpS'](logDebug,_0x4e6014[_0x5e7ed8(0x10f)],_0x23780f,_0x502d62,_0x36debc,_0x14134f,_0x3fd955,_0x43bde9,_0x53021e,_0x1fc701);if(_0x43bde9&&_0x6716c8[_0x5e7ed8(0x12d)](_0x43bde9)){if(_0x1fc701)try{await _0x3e1f15['unlink'](_0x43bde9);}catch(_0xeb1e24){}else return _0x43bde9;}return _0x4e6014[_0x5e7ed8(0xe2)](logDebug,_0x4e6014[_0x5e7ed8(0x102)],_0x23780f,_0x502d62,_0x36debc,_0x14134f,_0x3fd955,_0x43bde9,_0x53021e,_0x1fc701),new Promise((_0x43b4a6,_0x13be1e)=>{const _0x505e67=_0x5e7ed8,_0x37cf5={'kwoSy':_0x505e67(0xc8),'zWkKg':function(_0x6ccb2d,_0x26d7c2,_0xe546a8){return _0x6ccb2d(_0x26d7c2,_0xe546a8);},'MHBPR':_0x505e67(0x127)};let _0x168223=![];const _0xed66f2=_0xed8dda=>{const _0x4b053f=_0x505e67;logDebug(_0x37cf5['kwoSy'],_0xed8dda,_0x23780f);if(_0xed8dda[_0x4b053f(0x11c)]===_0x23780f){_0x168223=!![];let _0x5eef2f=_0xed8dda['filePath'];if(_0x5eef2f[_0x4b053f(0x11b)]('\x5c')){const _0xbd7aaa=sessionConfig['defaultFileDownloadPath'];_0x37cf5['zWkKg'](logDebug,_0x37cf5[_0x4b053f(0x121)],_0xbd7aaa),_0x5eef2f=_0x43e3e5['join'](_0xbd7aaa,_0x5eef2f);}_0x43b4a6(_0x5eef2f);}};downloadMediaTasks[_0x505e67(0xfb)](_0x4e6014[_0x505e67(0xec)](randomUUID),_0xed66f2),setTimeout(()=>{const _0x1cb45c=_0x505e67;!_0x168223&&_0x13be1e(_0x1cb45c(0xfe));},_0x53021e),napCatCore['session'][_0x505e67(0xcf)]()[_0x505e67(0xf9)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x23780f,'chatType':_0x502d62,'peerUid':_0x36debc,'elementId':_0x14134f,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3fd955});});}static async[_0x204330(0xe7)](_0x4e77ed){const _0x66ed55={'TvNqN':function(_0x46578d,_0x4dcc4e){return _0x46578d(_0x4dcc4e);}};return new Promise((_0x47be10,_0xcd1aef)=>{_0x4c6085(_0x4e77ed,(_0x36d9d7,_0x303e83)=>{const _0xdeb54a=_0x2296;_0x36d9d7?_0x66ed55[_0xdeb54a(0x113)](_0xcd1aef,_0x36d9d7):_0x47be10(_0x303e83);});});}static async[_0x204330(0xf2)](_0x2a6552){const _0x111184=_0x204330,_0x42e75c={'vduqh':function(_0x45004d,_0x50a2cf){return _0x45004d!==_0x50a2cf;},'ppNVH':function(_0x5770a2,_0x51cc7e){return _0x5770a2(_0x51cc7e);},'dtUTA':_0x111184(0x125),'JLuLD':_0x111184(0xd7),'yFRBj':function(_0x49fe3d,_0x564f7d){return _0x49fe3d(_0x564f7d);},'atiSv':_0x111184(0x132),'xypsE':_0x111184(0x137),'VxldF':function(_0x245755,_0x404b30){return _0x245755+_0x404b30;},'uuZfJ':function(_0x522b9a,_0x1a2f79,_0x1e9d60){return _0x522b9a(_0x1a2f79,_0x1e9d60);},'psyUx':function(_0x861bd8,_0x11f229){return _0x861bd8(_0x11f229);},'IHPdb':function(_0x2a7f9e,_0x34f901,_0x1eb577,_0xbf87a6){return _0x2a7f9e(_0x34f901,_0x1eb577,_0xbf87a6);},'Elybx':_0x111184(0xd2),'DXYuE':function(_0x3b09a2,_0x4c8a10){return _0x3b09a2(_0x4c8a10);},'GYHoo':_0x111184(0x107),'HKRPH':'&rkey=','kNate':function(_0x3f2d1f,_0xd4212){return _0x3f2d1f+_0xd4212;},'LMwDs':function(_0x4bb5f1,_0x17d175){return _0x4bb5f1>_0x17d175;},'GdBhe':function(_0x377a86,_0x29e492){return _0x377a86-_0x29e492;},'nIEVz':function(_0x2df07a){return _0x2df07a();},'qFobX':function(_0x48232f,_0x32d8f1){return _0x48232f+_0x32d8f1;},'nLINR':function(_0x5d6fcc,_0x5060cd){return _0x5d6fcc+_0x5060cd;},'wpNrd':function(_0x2f4654,_0x1b4bc5){return _0x2f4654||_0x1b4bc5;},'CosFE':'图片url获取失败'},_0xe50d36=_0x42e75c[_0x111184(0x117)](_0x2a6552[_0x111184(0x135)],ChatType[_0x111184(0x12c)]),_0x542dca=_0x2a6552['elements'][_0x111184(0x11e)](_0x4437c4=>!!_0x4437c4[_0x111184(0xe3)]);if(!_0x542dca)return'';const _0x24c80f=_0x542dca['picElement'][_0x111184(0xd4)],_0x176c42=_0x542dca['picElement']['md5HexStr'],_0x54915e=_0x542dca[_0x111184(0xe3)][_0x111184(0xea)],_0x35900f=_0x542dca[_0x111184(0xe3)]['fileUuid'],_0x45166e=_0x341c21=>{const _0x1f8d9c=_0x111184;_0xe50d36?(privateImageRKey=_0x341c21,lastGetPrivateRKeyTime=Date[_0x1f8d9c(0xe4)]()):(groupImageRKey=_0x341c21,lastGetGroupRKeyTime=Date[_0x1f8d9c(0xe4)]());};if(_0x24c80f){if(_0x24c80f[_0x111184(0x11b)](_0x42e75c['GYHoo'])){if(_0x24c80f[_0x111184(0xd8)](_0x42e75c[_0x111184(0xca)]))return _0x42e75c[_0x111184(0xff)](IMAGE_HTTP_HOST_NT,_0x24c80f);if(!hookApi[_0x111184(0xf0)]())return logDebug(_0x111184(0xd3)),'';const _0x3138df=async()=>{const _0x110149=_0x111184,_0x298df3={'KxbfA':function(_0x3e7601,_0x5629a9){return _0x42e75c['vduqh'](_0x3e7601,_0x5629a9);},'cJKkj':function(_0x3315cd,_0xdaf543){const _0x56dfc3=_0x2296;return _0x42e75c[_0x56dfc3(0x114)](_0x3315cd,_0xdaf543);},'IxGoK':_0x42e75c['dtUTA'],'LPpMM':_0x42e75c[_0x110149(0xf3)]};_0x42e75c[_0x110149(0x12e)](logDebug,_0x42e75c[_0x110149(0xd0)]),NTQQFileApi[_0x110149(0x126)](_0x2a6552[_0x110149(0x11c)],_0x2a6552[_0x110149(0x135)],_0x2a6552[_0x110149(0xef)],_0x542dca[_0x110149(0xe9)],'',_0x542dca[_0x110149(0xe3)][_0x110149(0xf1)],0x3e8*0x1e,!![])[_0x110149(0xf7)](_0x54d017=>{})[_0x110149(0xdd)](logError),await _0x42e75c[_0x110149(0x12e)](sleep,0x3e8),_0x42e75c[_0x110149(0x12e)](logDebug,_0x42e75c[_0x110149(0x115)]);const _0x53c311=hookApi[_0x110149(0xe0)]()||'',_0x306866=_0x42e75c[_0x110149(0xdf)](_0x42e75c['VxldF'](IMAGE_HTTP_HOST_NT,_0x24c80f),_0x53c311);if(_0x53c311)try{logDebug(_0x110149(0x130),_0x306866),await new Promise((_0xa5e09f,_0x40acc1)=>{const _0x91b6f7=_0x110149;_0x28e146[_0x91b6f7(0x138)](_0x306866,_0x18201c=>{const _0x377407=_0x91b6f7;_0x298df3[_0x377407(0x104)](_0x18201c[_0x377407(0x124)],0xc8)?_0x298df3[_0x377407(0xe6)](_0x40acc1,_0x298df3[_0x377407(0xce)]):_0xa5e09f(_0x18201c);})['on'](_0x298df3['LPpMM'],_0x199add=>{const _0x5042f1=_0x91b6f7;_0x298df3[_0x5042f1(0xe6)](_0x40acc1,_0x199add);});}),_0x42e75c[_0x110149(0x116)](logDebug,_0x110149(0xf8),_0x306866),_0x42e75c[_0x110149(0xe1)](_0x45166e,_0x53c311);}catch(_0x454a76){return _0x42e75c['IHPdb'](logError,_0x42e75c['Elybx'],_0x306866,_0x454a76),'';}return _0x53c311;},_0x4f055b=()=>new Promise((_0x4e6e5d,_0x451207)=>{const _0x36c244=_0x111184,_0x111e24={'fukZe':function(_0x15264b){return _0x15264b();},'ctFuL':function(_0x4c3e3e,_0x120b27){const _0x19dbe3=_0x2296;return _0x42e75c[_0x19dbe3(0xee)](_0x4c3e3e,_0x120b27);}};getRKeyTaskQueue[_0x36c244(0x119)](async()=>{const _0x53f7b8=_0x36c244,_0x416fe8=await _0x111e24[_0x53f7b8(0xfc)](_0x3138df);_0x111e24[_0x53f7b8(0xd1)](_0x4e6e5d,_0x416fe8);});}),_0xa32e68=_0xe50d36?privateImageRKey:groupImageRKey,_0x83eb59=_0xe50d36?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x42e75c['LMwDs'](_0x42e75c[_0x111184(0x118)](Date[_0x111184(0xe4)](),_0x83eb59),rkeyExpireTime)||!_0xa32e68){logDebug(_0x111184(0xeb)+_0x24c80f+_0x111184(0x109)+_0xa32e68);const _0x4bf29f=await _0x42e75c[_0x111184(0x133)](_0x4f055b);if(_0x4bf29f)return _0x42e75c[_0x111184(0xff)](IMAGE_HTTP_HOST_NT+_0x24c80f,''+_0x4bf29f);else logError(_0x42e75c[_0x111184(0xfd)],_0x24c80f);}if(_0xa32e68)return _0x42e75c['qFobX'](IMAGE_HTTP_HOST_NT,_0x24c80f)+(''+_0xa32e68);return'';}else return _0x42e75c[_0x111184(0x12f)](IMAGE_HTTP_HOST,_0x24c80f);}else{if(_0x42e75c[_0x111184(0xf4)](_0x54915e,_0x176c42))return IMAGE_HTTP_HOST+_0x111184(0xcd)+(_0x54915e||_0x176c42)[_0x111184(0xde)]()+'/0';}return logDebug(_0x42e75c['CosFE'],_0x2a6552),'';}}export class NTQQFileCacheApi{static async[_0x204330(0x128)](_0x2043f1=!![]){return'';}static[_0x204330(0xc4)](){return'';}static[_0x204330(0x101)](_0x446b75=[_0x204330(0xc7),_0x204330(0xc9)]){const _0x3ba314=_0x204330;return napCatCore[_0x3ba314(0x11a)]['getStorageCleanService']()[_0x3ba314(0x123)](_0x446b75);}static[_0x204330(0xcc)](_0x2bf4a8={}){const _0x455f2a=_0x204330;return napCatCore['session']['getStorageCleanService']()[_0x455f2a(0xdb)](_0x2bf4a8);}static[_0x204330(0x110)](){const _0x174495=_0x204330;return napCatCore['session']['getStorageCleanService']()[_0x174495(0x110)]();}static['getHotUpdateCachePath'](){return'';}static[_0x204330(0x103)](){return'';}static[_0x204330(0xfa)](_0x25df5d,_0x1a5bcf=0x3e8,_0x2c89f8=0x0){const _0x59a2f9=_0x204330;return napCatCore[_0x59a2f9(0x11a)][_0x59a2f9(0x136)]()[_0x59a2f9(0x10b)](_0x25df5d,_0x1a5bcf,0x1,_0x2c89f8);}static[_0x204330(0xe8)](_0x40bb08,_0x5ee84e=0x3e8,_0x1c7b21){const _0x4aef6c=_0x1c7b21?_0x1c7b21:{'fileType':_0x40bb08};}static async[_0x204330(0x10c)](_0x493a9a=[],_0x2517bd=[]){const _0x3d9a76=_0x204330;return napCatCore[_0x3d9a76(0x11a)][_0x3d9a76(0x136)]()[_0x3d9a76(0x105)](_0x493a9a,_0x2517bd);}}