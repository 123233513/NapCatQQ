const _0x1073b5=_0x32ba;(function(_0xe071e,_0x3f9343){const _0x55a381=_0x32ba,_0x6e2642=_0xe071e();while(!![]){try{const _0x5b3eab=-parseInt(_0x55a381(0x118))/0x1*(-parseInt(_0x55a381(0x10d))/0x2)+parseInt(_0x55a381(0x135))/0x3*(parseInt(_0x55a381(0xf4))/0x4)+-parseInt(_0x55a381(0x133))/0x5+parseInt(_0x55a381(0x12d))/0x6*(-parseInt(_0x55a381(0x120))/0x7)+-parseInt(_0x55a381(0x103))/0x8+parseInt(_0x55a381(0x110))/0x9+parseInt(_0x55a381(0x129))/0xa*(parseInt(_0x55a381(0x108))/0xb);if(_0x5b3eab===_0x3f9343)break;else _0x6e2642['push'](_0x6e2642['shift']());}catch(_0x57e5da){_0x6e2642['push'](_0x6e2642['shift']());}}}(_0xf0a3,0xd2df1));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x154491 from'path';import _0x1e7332 from'fs';import _0xea7a54 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x40564d from'file-type';import{MsgListener}from'@/core/listeners';import _0x503e81 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x32ba(_0x3b428c,_0x33b80f){const _0xf0a3d1=_0xf0a3();return _0x32ba=function(_0x32ba10,_0x567dc3){_0x32ba10=_0x32ba10-0xef;let _0x1809c3=_0xf0a3d1[_0x32ba10];return _0x1809c3;},_0x32ba(_0x3b428c,_0x33b80f);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';function _0xf0a3(){const _0x98e133=['下载超时','pvoGO','sjPif','toUpperCase','2HnDPcy','onRichMediaDownloadComplete','RnHrB','6542847aqwSkz','util','getDesktopTmpPath','clearCacheDataByKeys','PIC','unlink','Qhsrb','getImageSize','705032siUcny','/gchatpic_new/0/0-0-','getChatCacheList','private_rkey','qudXF','copyFile','addCacheScannedPaths','msgId','198226aierUq','md5HexStr','originImageUrl','defaultFileDownloadPath','getChatCacheInfo','fileTypeFromFile','tmp','session','clearChatCacheInfo','11149700qlOZcy','getRkey','BJvAx','addListener','150RpjQih','WYMPs','OpxQa','getCacheSessionPathList','qnUby','uploadFile','1154975rXGhVb','getStorageCleanService','466566maapWK','includes','filePath','ext','getFileSize','lWoOd','sKtgY','24NJUcpx','indexOf','bYxbn','startsWith','addCacheScanedPaths','mvjLl','getMsgService','getHotUpdateCachePath','getFileType','LTMdD','group_rkey','/download','CGYRU','clearChatCache','existsSync','13419544mmhNgk','scanCache','clearCache','fileUuid','HcLWT','11vdWGpw'];_0xf0a3=function(){return _0x98e133;};return _0xf0a3();}import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x1073b5(0x10e)]=_0x1708ce=>{for(const [_0x587321,_0x3083c2]of downloadMediaTasks){_0x3083c2(_0x1708ce),downloadMediaTasks['delete'](_0x587321);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x18e958=_0x32ba;napCatCore[_0x18e958(0x12c)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x1073b5(0xfc)](_0x22641e){const _0x4c3e7d=_0x1073b5;return _0x40564d[_0x4c3e7d(0x125)](_0x22641e);}static async['copyFile'](_0x542f2a,_0x368e3a){const _0x476906=_0x1073b5;await napCatCore[_0x476906(0x111)][_0x476906(0x11d)](_0x542f2a,_0x368e3a);}static async['getFileSize'](_0x3dcfc4){const _0x239c11=_0x1073b5;return await napCatCore[_0x239c11(0x111)]['getFileSize'](_0x3dcfc4);}static async[_0x1073b5(0x132)](_0x2afb52,_0x10f6bc=ElementType[_0x1073b5(0x114)],_0xd65b8d=0x0){const _0x301607=_0x1073b5,_0x511b4c={'LTMdD':function(_0x5062e4,_0x4ee531){return _0x5062e4(_0x4ee531);},'qudXF':function(_0x2e286b,_0x3c6e81){return _0x2e286b===_0x3c6e81;}},_0x36c9f2=await _0x511b4c[_0x301607(0xfd)](calculateFileMD5,_0x2afb52);let _0x3e252b=(await NTQQFileApi['getFileType'](_0x2afb52))?.[_0x301607(0xf0)]||'';_0x3e252b&&(_0x3e252b='.'+_0x3e252b);let _0x1b2e3b=''+_0x154491['basename'](_0x2afb52);_0x511b4c[_0x301607(0x11c)](_0x1b2e3b[_0x301607(0xf5)]('.'),-0x1)&&(_0x1b2e3b+=_0x3e252b);const _0x116dee=napCatCore[_0x301607(0x127)][_0x301607(0xfa)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x36c9f2,'fileName':_0x1b2e3b,'elementType':_0x10f6bc,'elementSubType':_0xd65b8d,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x2afb52,_0x116dee);const _0x574805=await NTQQFileApi[_0x301607(0xf1)](_0x2afb52);return{'md5':_0x36c9f2,'fileName':_0x1b2e3b,'path':_0x116dee,'fileSize':_0x574805,'ext':_0x3e252b};}static async['downloadMedia'](_0x1309f2,_0x20ac4e,_0x2451f7,_0x1cd8bc,_0x1d1f2b,_0x3abf71,_0x417daf=0x3e8*0x3c*0x2,_0x7e48a4=![]){const _0x1220e5=_0x1073b5,_0x19a7d8={'LbNRB':function(_0x201dcb,_0x1ea899){return _0x201dcb===_0x1ea899;},'HcLWT':function(_0x3abe5a,_0xce5bbc){return _0x3abe5a(_0xce5bbc);},'pvoGO':_0x1220e5(0x109),'BJvAx':function(_0xcc7e46){return _0xcc7e46();}};if(_0x3abf71&&_0x1e7332[_0x1220e5(0x102)](_0x3abf71)){if(_0x7e48a4)try{await _0xea7a54[_0x1220e5(0x115)](_0x3abf71);}catch(_0x2944a6){}else return _0x3abf71;}return new Promise((_0x434371,_0x20b9f0)=>{const _0x20cc2c=_0x1220e5,_0x4e7877={'bYxbn':function(_0xa94ae6,_0x30e81b){return _0x19a7d8['LbNRB'](_0xa94ae6,_0x30e81b);},'CGYRU':function(_0x3bfc49,_0x5d3d65){const _0x1bee3b=_0x32ba;return _0x19a7d8[_0x1bee3b(0x107)](_0x3bfc49,_0x5d3d65);},'mvjLl':_0x19a7d8[_0x20cc2c(0x10a)]};let _0xe4c209=![];const _0xf89bcc=_0x258136=>{const _0x2944ea=_0x20cc2c;if(_0x4e7877[_0x2944ea(0xf6)](_0x258136[_0x2944ea(0x11f)],_0x1309f2)){_0xe4c209=!![];let _0x288c29=_0x258136[_0x2944ea(0xef)];if(_0x288c29[_0x2944ea(0xf7)]('\x5c')){const _0x215846=sessionConfig[_0x2944ea(0x123)];_0x288c29=_0x154491['join'](_0x215846,_0x288c29);}_0x4e7877[_0x2944ea(0x100)](_0x434371,_0x288c29);}};downloadMediaTasks['set'](_0x19a7d8[_0x20cc2c(0x12b)](randomUUID),_0xf89bcc),setTimeout(()=>{const _0x28aeba=_0x20cc2c;!_0xe4c209&&_0x4e7877[_0x28aeba(0x100)](_0x20b9f0,_0x4e7877[_0x28aeba(0xf9)]);},_0x417daf),napCatCore[_0x20cc2c(0x127)][_0x20cc2c(0xfa)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x1309f2,'chatType':_0x20ac4e,'peerUid':_0x2451f7,'elementId':_0x1cd8bc,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1d1f2b});});}static async[_0x1073b5(0x117)](_0x5e0f49){const _0x2d79d9={'sjPif':function(_0x198cec,_0x2626ec){return _0x198cec(_0x2626ec);},'sKtgY':function(_0x4eaccf,_0xda0215,_0x7c1a99){return _0x4eaccf(_0xda0215,_0x7c1a99);}};return new Promise((_0x1587c2,_0xb86b38)=>{const _0x24c2ec=_0x32ba,_0x5011d1={'WYMPs':function(_0x14bf20,_0x4482d3){const _0x317264=_0x32ba;return _0x2d79d9[_0x317264(0x10b)](_0x14bf20,_0x4482d3);}};_0x2d79d9[_0x24c2ec(0xf3)](_0x503e81,_0x5e0f49,(_0x4d904d,_0x288fd6)=>{const _0x280bfb=_0x24c2ec;_0x4d904d?_0x5011d1[_0x280bfb(0x12e)](_0xb86b38,_0x4d904d):_0x5011d1[_0x280bfb(0x12e)](_0x1587c2,_0x288fd6);});});}static async['getImageUrl'](_0x3c28bb,_0x2d2f78){const _0x2a8935=_0x1073b5,_0x3a5405={'lWoOd':_0x2a8935(0xff),'RnHrB':'&rkey=','sDIwu':function(_0x406bf3,_0x56ad41){return _0x406bf3+_0x56ad41;},'Qhsrb':function(_0x2b9744,_0x240252){return _0x2b9744+_0x240252;},'qnUby':function(_0x47af7c,_0x34e026){return _0x47af7c||_0x34e026;},'OpxQa':function(_0x16dcdb,_0x348815){return _0x16dcdb||_0x348815;}};if(!_0x3c28bb)return'';const _0x8ad398=_0x3c28bb[_0x2a8935(0x122)],_0x43727b=_0x3c28bb[_0x2a8935(0x121)],_0x5a749d=_0x3c28bb['md5HexStr'],_0x31fb5e=_0x3c28bb[_0x2a8935(0x106)];if(_0x8ad398){if(_0x8ad398[_0x2a8935(0xf7)](_0x3a5405[_0x2a8935(0xf2)])){if(_0x8ad398[_0x2a8935(0x136)](_0x3a5405[_0x2a8935(0x10f)]))return _0x3a5405['sDIwu'](IMAGE_HTTP_HOST_NT,_0x8ad398);const _0x50ea66=await rkeyManager[_0x2a8935(0x12a)](),_0x81268b=_0x2d2f78?_0x50ea66[_0x2a8935(0x11b)]:_0x50ea66[_0x2a8935(0xfe)];return _0x3a5405['Qhsrb'](IMAGE_HTTP_HOST_NT,_0x8ad398)+(''+_0x81268b);}else return _0x3a5405[_0x2a8935(0x116)](IMAGE_HTTP_HOST,_0x8ad398);}else{if(_0x3a5405[_0x2a8935(0x131)](_0x5a749d,_0x43727b))return IMAGE_HTTP_HOST+_0x2a8935(0x119)+_0x3a5405[_0x2a8935(0x12f)](_0x5a749d,_0x43727b)[_0x2a8935(0x10c)]()+'/0';}return logDebug('图片url获取失败',_0x3c28bb),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x49567d=!![]){return'';}static[_0x1073b5(0x130)](){return'';}static[_0x1073b5(0x105)](_0x5a9784=[_0x1073b5(0x126),'hotUpdate']){const _0xfdc5d2=_0x1073b5;return napCatCore[_0xfdc5d2(0x127)]['getStorageCleanService']()[_0xfdc5d2(0x113)](_0x5a9784);}static[_0x1073b5(0x11e)](_0x2a3304={}){const _0x747932=_0x1073b5;return napCatCore['session']['getStorageCleanService']()[_0x747932(0xf8)](_0x2a3304);}static[_0x1073b5(0x104)](){const _0xbfdee7=_0x1073b5;return napCatCore[_0xbfdee7(0x127)][_0xbfdee7(0x134)]()[_0xbfdee7(0x104)]();}static[_0x1073b5(0xfb)](){return'';}static[_0x1073b5(0x112)](){return'';}static[_0x1073b5(0x11a)](_0x383631,_0x2ebfa6=0x3e8,_0x3b97d1=0x0){const _0x422f29=_0x1073b5;return napCatCore['session']['getStorageCleanService']()[_0x422f29(0x124)](_0x383631,_0x2ebfa6,0x1,_0x3b97d1);}static['getFileCacheInfo'](_0x30af45,_0x36c251=0x3e8,_0x34a6e1){const _0xdab6b5=_0x34a6e1?_0x34a6e1:{'fileType':_0x30af45};}static async[_0x1073b5(0x101)](_0x5ebfde=[],_0x2d178f=[]){const _0x3a7648=_0x1073b5;return napCatCore['session'][_0x3a7648(0x134)]()[_0x3a7648(0x128)](_0x5ebfde,_0x2d178f);}}