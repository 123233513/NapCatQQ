const _0x520e85=_0x28e2;function _0x28e2(_0x229965,_0x2372e8){const _0x242fb7=_0x242f();return _0x28e2=function(_0x28e215,_0x4c6105){_0x28e215=_0x28e215-0xe9;let _0x4457bd=_0x242fb7[_0x28e215];return _0x4457bd;},_0x28e2(_0x229965,_0x2372e8);}(function(_0x37b89f,_0x19980b){const _0x17915b=_0x28e2,_0x2ab1d6=_0x37b89f();while(!![]){try{const _0x2043ac=parseInt(_0x17915b(0x133))/0x1*(parseInt(_0x17915b(0x11f))/0x2)+-parseInt(_0x17915b(0x132))/0x3+-parseInt(_0x17915b(0xf8))/0x4+parseInt(_0x17915b(0xe9))/0x5+parseInt(_0x17915b(0x109))/0x6+parseInt(_0x17915b(0x108))/0x7+-parseInt(_0x17915b(0x12b))/0x8;if(_0x2043ac===_0x19980b)break;else _0x2ab1d6['push'](_0x2ab1d6['shift']());}catch(_0x17fa25){_0x2ab1d6['push'](_0x2ab1d6['shift']());}}}(_0x242f,0x6394d));function _0x242f(){const _0x330aee=['rHjeT','addListener','649935wddEeS','179dFfkXT','bytes=0-0','rUcVM','message','Check\x20rkey\x20headers:\x20','PIC','getCacheSessionPathList','getDesktopTmpPath','tmp','uploadFile','fileUuid','获取rkey失败','downloadMedia','wkXuo','isAvailable','getImageSize','clearCache','mXDQR','RmybL','getHotUpdateCachePath','onRichMediaDownloadComplete','join','catch','Problem\x20with\x20rkey\x20request:\x20','VpbBC','sourcePath','DkucJ','Check\x20rkey\x20request\x20timed\x20out','clearChatCache','originImageUrl','scanCache','clearCacheDataByKeys','msgId','indexOf','unlinkSync','existsSync','chatType','session','2991145DCBULY','zewrq','*/*','JVRJp','kKnIX','获取图片rkey失败','JnHii','LSVad','elementId','md5HexStr','Check\x20rkey\x20status:\x20','toUpperCase','nBbFN','headers','now','846488GmmKOz','appid=1406','UBdbm','removeKernelMsgListener','search','lWjex','mIYKj','addCacheScannedPaths','getFileSize','URxxZ','getRichMediaFilePathForGuild','peerUid','picElement','util','elements','/gchatpic_new/0/0-0-','3209682NQkDui','3040044gLLOPn','includes','获取图片rkey...','&rkey=','VpTzA','tqJYC','Check\x20rkey\x20request\x20time:','basename','then','setTimeout','NYuUf','downloadRichMedia','clearChatCacheInfo','lZDok','setCacheSilentScan','fxFSZ','host','getMsgService','getFileType','hookApi\x20is\x20not\x20available','stringify','图片rkey获取成功','8318YSREmR','The\x20image\x20URL\x20is\x20not\x20accessible.','statusCode','end','pKKbs','GET','error','getStorageCleanService','startsWith','filePath','defaultFileDownloadPath','find','11773904Khfvul','Mozilla/5.0\x20(Windows\x20NT\x2010.0;\x20Win64;\x20x64)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/58.0.3029.110\x20Safari/537.36','copyFile','FpYJU','tFoud'];_0x242f=function(){return _0x330aee;};return _0x242f();}import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x493590 from'path';import _0x1b0898 from'fs';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x472bb1 from'file-type';import{MsgListener}from'@/core/listeners';import _0x556f7f from'image-size';import{sessionConfig}from'@/core/sessionConfig';import _0x104892 from'http';import{hookApi}from'@/core/external/hook';import{sleep}from'@/common/utils/helper';let privateImageRKey='',groupImageRKey='';export class NTQQFileApi{static async['getFileType'](_0x518a03){return _0x472bb1['fileTypeFromFile'](_0x518a03);}static async[_0x520e85(0x12d)](_0x5ec44e,_0x1d49d1){const _0x38884c=_0x520e85;await napCatCore[_0x38884c(0x105)][_0x38884c(0x12d)](_0x5ec44e,_0x1d49d1);}static async['getFileSize'](_0x5c365c){const _0x36145b=_0x520e85;return await napCatCore['util'][_0x36145b(0x100)](_0x5c365c);}static async[_0x520e85(0x13c)](_0x4f97e3,_0xbfa80a=ElementType[_0x520e85(0x138)],_0x2330c6=0x0){const _0x4d002f=_0x520e85,_0x276334={'ojzWS':function(_0x1f9888,_0x131b70){return _0x1f9888(_0x131b70);},'lWjex':function(_0x279c43,_0x279d3e){return _0x279c43+_0x279d3e;}},_0x2c31ad=await _0x276334['ojzWS'](calculateFileMD5,_0x4f97e3);let _0x393657=(await NTQQFileApi[_0x4d002f(0x11b)](_0x4f97e3))?.['ext']||'';_0x393657&&(_0x393657=_0x276334[_0x4d002f(0xfd)]('.',_0x393657));let _0x5af0c2=''+_0x493590[_0x4d002f(0x110)](_0x4f97e3);_0x5af0c2[_0x4d002f(0x154)]('.')===-0x1&&(_0x5af0c2+=_0x393657);const _0x52c1ee=napCatCore[_0x4d002f(0x158)]['getMsgService']()[_0x4d002f(0x102)]({'md5HexStr':_0x2c31ad,'fileName':_0x5af0c2,'elementType':_0xbfa80a,'elementSubType':_0x2330c6,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x4d002f(0x12d)](_0x4f97e3,_0x52c1ee);const _0x3707ab=await NTQQFileApi[_0x4d002f(0x100)](_0x4f97e3);return{'md5':_0x2c31ad,'fileName':_0x5af0c2,'path':_0x52c1ee,'fileSize':_0x3707ab,'ext':_0x393657};}static async[_0x520e85(0x13f)](_0x145189,_0x1cd5a4,_0x45a08d,_0x5f5641,_0x1bddba,_0x45d022,_0x5d360b=0x3e8*0x3c*0x2,_0x52532e=![]){const _0x4a80c1=_0x520e85,_0x103077={'WxbDg':'下载超时','tFoud':function(_0x391f26,_0x1c4b53,_0x281605){return _0x391f26(_0x1c4b53,_0x281605);}};if(_0x45d022&&_0x1b0898[_0x4a80c1(0x156)](_0x45d022)){if(_0x52532e)_0x1b0898[_0x4a80c1(0x155)](_0x45d022);else return _0x45d022;}const _0xfc6732=new MsgListener();return new Promise((_0x4ac5a3,_0x5c2c5b)=>{const _0x2dd4d3=_0x4a80c1,_0x229cdb={'PNCCn':function(_0x41f680,_0x352ec2){return _0x41f680(_0x352ec2);}};let _0x14da25=![];_0xfc6732[_0x2dd4d3(0x147)]=_0x1cbec8=>{const _0x101cc2=_0x2dd4d3;if(_0x1cbec8[_0x101cc2(0x153)]===_0x145189){_0x14da25=!![];let _0x1147d7=_0x1cbec8[_0x101cc2(0x128)];if(_0x1147d7[_0x101cc2(0x127)]('\x5c')){const _0x2f9caa=sessionConfig?.[_0x101cc2(0x129)];_0x1147d7=_0x493590[_0x101cc2(0x148)](_0x2f9caa,_0x1147d7);}_0x229cdb['PNCCn'](_0x4ac5a3,_0x1147d7),napCatCore[_0x101cc2(0x158)][_0x101cc2(0x11a)]()['removeKernelMsgListener'](_0x785f11);}};const _0x785f11=napCatCore[_0x2dd4d3(0x131)](_0xfc6732);_0x103077[_0x2dd4d3(0x12f)](setTimeout,()=>{const _0xddb910=_0x2dd4d3;!_0x14da25&&(_0x5c2c5b(new Error(_0x103077['WxbDg'])),napCatCore['session'][_0xddb910(0x11a)]()[_0xddb910(0xfb)](_0x785f11));},_0x5d360b),napCatCore[_0x2dd4d3(0x158)]['getMsgService']()[_0x2dd4d3(0x114)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x145189,'chatType':_0x1cd5a4,'peerUid':_0x45a08d,'elementId':_0x5f5641,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1bddba});});}static async[_0x520e85(0x142)](_0x3b70f5){return new Promise((_0x31e06d,_0x3a0766)=>{const _0xe5df46={'wkXuo':function(_0x147521,_0x2609d3){return _0x147521(_0x2609d3);}};_0x556f7f(_0x3b70f5,(_0x46106e,_0x2d2500)=>{const _0x561ae4=_0x28e2;_0x46106e?_0xe5df46[_0x561ae4(0x140)](_0x3a0766,_0x46106e):_0x31e06d(_0x2d2500);});});}static async['getImageUrl'](_0x5d386f){const _0x131ae8=_0x520e85,_0x2ace05={'LSVad':function(_0x34361a,_0x444b1d){return _0x34361a(_0x444b1d);},'URxxZ':function(_0xb2d0bf,_0x34c435,_0x3ee2a5){return _0xb2d0bf(_0x34c435,_0x3ee2a5);},'mXDQR':function(_0x1dbe38,_0x32fa9f){return _0x1dbe38(_0x32fa9f);},'VpbBC':function(_0xf959fa,_0x19d5f2){return _0xf959fa===_0x19d5f2;},'UBdbm':_0x131ae8(0x120),'zewrq':_0x131ae8(0x124),'VpTzA':_0x131ae8(0x12c),'fxFSZ':_0x131ae8(0xeb),'rHjeT':_0x131ae8(0x134),'RmybL':_0x131ae8(0x125),'JnHii':'/download','nBbFN':_0x131ae8(0x11c),'CaOpk':function(_0x3c6464,_0xb292b){return _0x3c6464!==_0xb292b;},'DkucJ':_0x131ae8(0xee),'tqJYC':function(_0x3b37d3){return _0x3b37d3();},'rUcVM':function(_0x41c036,_0x2c5900,_0x6c8ac1){return _0x41c036(_0x2c5900,_0x6c8ac1);},'lZDok':_0x131ae8(0x10f),'NYuUf':function(_0x2e8066,_0x2a4424){return _0x2e8066-_0x2a4424;},'JVRJp':function(_0x57fdd4){return _0x57fdd4();},'yFTfb':function(_0x2e0efc,_0x4692bf){return _0x2e0efc+_0x4692bf;},'pKKbs':function(_0x190602,_0x4cf154){return _0x190602+_0x4cf154;}},_0x27678a=_0x5d386f[_0x131ae8(0x106)][_0x131ae8(0x12a)](_0x2c7dab=>!!_0x2c7dab['picElement']);if(!_0x27678a)return'';const _0x50a391=_0x27678a[_0x131ae8(0x104)][_0x131ae8(0x150)],_0x5e0d83=_0x27678a[_0x131ae8(0x104)][_0x131ae8(0xf2)],_0x54146f=_0x27678a['picElement'][_0x131ae8(0xf2)],_0x40138b=_0x27678a['picElement'][_0x131ae8(0x13d)];let _0x2ae79d='';if(_0x50a391){if(_0x50a391['startsWith'](_0x2ace05[_0x131ae8(0xef)])){if(_0x50a391[_0x131ae8(0x10a)](_0x131ae8(0x10c)))_0x2ae79d=IMAGE_HTTP_HOST_NT+_0x50a391;else{if(!hookApi[_0x131ae8(0x141)]())return _0x2ace05['mXDQR'](logDebug,_0x2ace05[_0x131ae8(0xf5)]),'';let _0x5bb311=![];_0x2ace05['CaOpk'](_0x50a391['indexOf'](_0x131ae8(0xf9)),-0x1)&&(_0x5bb311=!![]);let _0x18de61='';_0x5bb311?_0x18de61=privateImageRKey:_0x18de61=groupImageRKey;_0x18de61=_0x18de61||hookApi['getRKey']();const _0x38a2e5=async()=>{const _0x10d413=_0x131ae8;_0x2ace05[_0x10d413(0xf0)](logDebug,_0x10d413(0x10b)),NTQQFileApi[_0x10d413(0x13f)](_0x5d386f[_0x10d413(0x153)],_0x5d386f[_0x10d413(0x157)],_0x5d386f[_0x10d413(0x103)],_0x27678a[_0x10d413(0xf1)],'',_0x27678a[_0x10d413(0x104)][_0x10d413(0x14c)],0x3e8,!![])[_0x10d413(0x111)]()[_0x10d413(0x149)](()=>{}),await _0x2ace05[_0x10d413(0xf0)](sleep,0x12c);const _0x45fa77=hookApi['getRKey']();if(_0x45fa77)return _0x2ace05[_0x10d413(0x101)](logDebug,_0x10d413(0x11e),_0x18de61),_0x18de61=_0x45fa77,_0x18de61;},_0x2ad470=()=>{_0x5bb311?privateImageRKey=_0x18de61:groupImageRKey=_0x18de61;};if(!_0x18de61)try{await _0x38a2e5();}catch(_0x1637f3){return _0x2ace05['URxxZ'](logError,_0x2ace05[_0x131ae8(0x14d)],_0x1637f3),'';}_0x2ae79d=IMAGE_HTTP_HOST_NT+_0x50a391+(''+_0x18de61);const _0x537409=new Promise((_0x4056f9,_0x4980c9)=>{const _0x3f915a=_0x131ae8,_0x346ba9={'kKnIX':function(_0x3f4d99,_0x2defd2){const _0x463fc3=_0x28e2;return _0x2ace05[_0x463fc3(0x144)](_0x3f4d99,_0x2defd2);},'iUcmI':function(_0x21ea71,_0x97636f){return _0x21ea71==_0x97636f;},'FpYJU':function(_0x57527c,_0xb2dbe1){const _0x5ca530=_0x28e2;return _0x2ace05[_0x5ca530(0x14b)](_0x57527c,_0xb2dbe1);},'MXHJv':_0x2ace05[_0x3f915a(0xfa)],'mIYKj':_0x3f915a(0x14e)},_0x11bae6=new URL(_0x2ae79d),_0x68792d={'method':_0x2ace05[_0x3f915a(0xea)],'host':_0x11bae6[_0x3f915a(0x119)],'path':_0x11bae6['pathname']+_0x11bae6[_0x3f915a(0xfc)],'headers':{'User-Agent':_0x2ace05[_0x3f915a(0x10d)],'Accept':_0x2ace05[_0x3f915a(0x118)],'Range':_0x2ace05[_0x3f915a(0x130)]}},_0x3b3860=_0x104892['request'](_0x68792d,_0x359d12=>{const _0xefb24=_0x3f915a;_0x346ba9['kKnIX'](logDebug,_0xefb24(0xf3)+_0x359d12[_0xefb24(0x121)]),_0x346ba9[_0xefb24(0xed)](logDebug,_0xefb24(0x137)+JSON[_0xefb24(0x11d)](_0x359d12[_0xefb24(0xf6)])),_0x346ba9['iUcmI'](_0x359d12[_0xefb24(0x121)],0xc8)||_0x346ba9[_0xefb24(0x12e)](_0x359d12[_0xefb24(0x121)],0xce)?_0x346ba9['kKnIX'](_0x4056f9,'ok'):_0x4980c9(_0x346ba9['MXHJv']);});_0x3b3860[_0x3f915a(0x112)](0xbb8,()=>{const _0x2f560d=_0x3f915a;_0x3b3860['destroy'](),_0x346ba9[_0x2f560d(0xed)](_0x4980c9,_0x346ba9[_0x2f560d(0xfe)]);}),_0x3b3860['on'](_0x2ace05[_0x3f915a(0x145)],_0x1a9e51=>{const _0xf17f50=_0x3f915a;console[_0xf17f50(0x125)](_0xf17f50(0x14a)+_0x1a9e51[_0xf17f50(0x136)]),_0x346ba9[_0xf17f50(0xed)](_0x4980c9,_0x1a9e51[_0xf17f50(0x136)]);}),_0x3b3860[_0x3f915a(0x122)]();});try{const _0x543c9b=Date[_0x131ae8(0xf7)]();await _0x537409;const _0x25fd75=Date[_0x131ae8(0xf7)]();_0x2ace05[_0x131ae8(0x10e)](_0x2ad470),_0x2ace05[_0x131ae8(0x135)](logDebug,_0x2ace05[_0x131ae8(0x116)],_0x2ace05[_0x131ae8(0x113)](_0x25fd75,_0x543c9b));}catch(_0x5587f7){try{await _0x2ace05[_0x131ae8(0xec)](_0x38a2e5),_0x2ad470(),_0x2ae79d=_0x2ace05['yFTfb'](IMAGE_HTTP_HOST_NT,_0x50a391)+(''+_0x18de61);}catch(_0x530d76){logError(_0x131ae8(0x13e),_0x530d76);}}}}else _0x2ae79d=_0x2ace05[_0x131ae8(0x123)](IMAGE_HTTP_HOST,_0x50a391);}else(_0x54146f||_0x5e0d83)&&(_0x2ae79d=IMAGE_HTTP_HOST+_0x131ae8(0x107)+(_0x54146f||_0x5e0d83)[_0x131ae8(0xf4)]()+'/0');return _0x2ae79d;}}export class NTQQFileCacheApi{static async[_0x520e85(0x117)](_0x57cdc5=!![]){return'';}static[_0x520e85(0x139)](){return'';}static[_0x520e85(0x143)](_0x3a302f=[_0x520e85(0x13b),'hotUpdate']){const _0x4ce9bc=_0x520e85;return napCatCore[_0x4ce9bc(0x158)][_0x4ce9bc(0x126)]()[_0x4ce9bc(0x152)](_0x3a302f);}static[_0x520e85(0xff)](_0x30a243={}){const _0x5557be=_0x520e85;return napCatCore[_0x5557be(0x158)][_0x5557be(0x126)]()['addCacheScanedPaths'](_0x30a243);}static[_0x520e85(0x151)](){const _0x4f80d4=_0x520e85;return napCatCore[_0x4f80d4(0x158)][_0x4f80d4(0x126)]()[_0x4f80d4(0x151)]();}static[_0x520e85(0x146)](){return'';}static[_0x520e85(0x13a)](){return'';}static['getChatCacheList'](_0xcf38d8,_0x5824d2=0x3e8,_0x54c80e=0x0){const _0x17580a=_0x520e85;return napCatCore[_0x17580a(0x158)][_0x17580a(0x126)]()['getChatCacheInfo'](_0xcf38d8,_0x5824d2,0x1,_0x54c80e);}static['getFileCacheInfo'](_0x2f4ee8,_0x3e6c98=0x3e8,_0x4b9301){const _0x30909f=_0x4b9301?_0x4b9301:{'fileType':_0x2f4ee8};}static async[_0x520e85(0x14f)](_0x432ab5=[],_0x33e5ff=[]){const _0x2ebd4f=_0x520e85;return napCatCore[_0x2ebd4f(0x158)][_0x2ebd4f(0x126)]()[_0x2ebd4f(0x115)](_0x432ab5,_0x33e5ff);}}