const _0x1607d6=_0xaaa2;function _0x53c0(){const _0x6a6399=['msgId','addCacheScannedPaths','onLoginSuccess','util','downloadPath','获取图片rkey...','PIC','downloadMedia','12959782FwDvKP','picElement','uploadFile','ndSKu','42FXtfVB','addTask','EUdWn','onRichMediaDownloadComplete','elementId','getFileType','ItTUe','start\x20downloadMedia','poyJX','CgDRU','NAdVH','tmp','then','645930uqmjFE','156932nAuUGn','getMsgService','4301800AOajZo','scanCache','clearCache','LMVOM','getFileCacheInfo','getFileSize','pehQc','getRichMediaFilePathForGuild','defaultFileDownloadPath','downloadMedia\x20complete','existsSync','iEldg','receive\x20downloadMedia\x20task','VLAuJ','set','9poSoOs','join','getChatCacheInfo','图片rkey获取失败','pboiI','igjDC','session','/download','find','toUpperCase','delete','startsWith','group','peerUid','56yXdDXM','zwtbA','hDmut','basename','图片rkey获取成功','1DTpWCq','SwKeT','unlink','copyFile','6649928MHdHqL','setCacheSilentScan','chatType','图片url获取失败','catch','getStorageCleanService','qHLKS','fileUuid','/gchatpic_new/0/0-0-','TUexq','RXbxZ','787810vOeXeh','6356180YeIkbV','cLbFE','udvly','getHotUpdateCachePath','开始调用moeHook获取rkey','djuni','hookApi\x20is\x20not\x20available','getImageUrl','elements','yyqmT','getChatCacheList','addCacheScanedPaths','hotUpdate','md5HexStr'];_0x53c0=function(){return _0x6a6399;};return _0x53c0();}(function(_0x282078,_0x26be8a){const _0x29f146=_0xaaa2,_0x3878be=_0x282078();while(!![]){try{const _0xc0eb2a=-parseInt(_0x29f146(0x1af))/0x1*(parseInt(_0x29f146(0x1be))/0x2)+-parseInt(_0x29f146(0x1d9))/0x3*(-parseInt(_0x29f146(0x18b))/0x4)+parseInt(_0x29f146(0x18d))/0x5+parseInt(_0x29f146(0x18a))/0x6*(-parseInt(_0x29f146(0x1aa))/0x7)+parseInt(_0x29f146(0x1b3))/0x8+-parseInt(_0x29f146(0x19c))/0x9*(-parseInt(_0x29f146(0x1bf))/0xa)+-parseInt(_0x29f146(0x1d5))/0xb;if(_0xc0eb2a===_0x26be8a)break;else _0x3878be['push'](_0x3878be['shift']());}catch(_0x5b1acd){_0x3878be['push'](_0x3878be['shift']());}}}(_0x53c0,0x6c326));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1c1882 from'path';import _0x1ed1b5 from'fs';import _0x96fd61 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';function _0xaaa2(_0x2b1e74,_0x1c7c40){const _0x53c000=_0x53c0();return _0xaaa2=function(_0xaaa25f,_0x36a9ee){_0xaaa25f=_0xaaa25f-0x17e;let _0x44d1f2=_0x53c000[_0xaaa25f];return _0x44d1f2;},_0xaaa2(_0x2b1e74,_0x1c7c40);}import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x33e6ac from'file-type';import{MsgListener}from'@/core/listeners';import _0x2ebb28 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x1607d6(0x180)]=_0x355912=>{const _0x467387=_0x1607d6,_0x15236b={'EUdWn':function(_0xdf9d8a,_0x4fec73){return _0xdf9d8a(_0x4fec73);}};for(const [_0x103fd4,_0x2f795b]of downloadMediaTasks){_0x15236b[_0x467387(0x17f)](_0x2f795b,_0x355912),downloadMediaTasks[_0x467387(0x1a6)](_0x103fd4);}},setTimeout(()=>{const _0x5b0d96=_0x1607d6;napCatCore[_0x5b0d96(0x1cf)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x1607d6(0x182)](_0x52dc33){return _0x33e6ac['fileTypeFromFile'](_0x52dc33);}static async[_0x1607d6(0x1b2)](_0x3aea0c,_0x3f407b){const _0x222195=_0x1607d6;await napCatCore[_0x222195(0x1d0)]['copyFile'](_0x3aea0c,_0x3f407b);}static async[_0x1607d6(0x192)](_0x4a5e6b){const _0xc93f50=_0x1607d6;return await napCatCore[_0xc93f50(0x1d0)]['getFileSize'](_0x4a5e6b);}static async[_0x1607d6(0x1d7)](_0x443f04,_0x16f038=ElementType[_0x1607d6(0x1d3)],_0x3e4c41=0x0){const _0x23e8e9=_0x1607d6,_0x1f842f={'qHLKS':function(_0x2c2b50,_0x2f316c){return _0x2c2b50(_0x2f316c);}},_0x303cc8=await _0x1f842f[_0x23e8e9(0x1b9)](calculateFileMD5,_0x443f04);let _0x1a9148=(await NTQQFileApi[_0x23e8e9(0x182)](_0x443f04))?.['ext']||'';_0x1a9148&&(_0x1a9148='.'+_0x1a9148);let _0x3ff695=''+_0x1c1882[_0x23e8e9(0x1ad)](_0x443f04);_0x3ff695['indexOf']('.')===-0x1&&(_0x3ff695+=_0x1a9148);const _0x3bfef0=napCatCore['session'][_0x23e8e9(0x18c)]()[_0x23e8e9(0x194)]({'md5HexStr':_0x303cc8,'fileName':_0x3ff695,'elementType':_0x16f038,'elementSubType':_0x3e4c41,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x443f04,_0x3bfef0);const _0x2dfffd=await NTQQFileApi['getFileSize'](_0x443f04);return{'md5':_0x303cc8,'fileName':_0x3ff695,'path':_0x3bfef0,'fileSize':_0x2dfffd,'ext':_0x1a9148};}static async[_0x1607d6(0x1d4)](_0x3f4d15,_0x2a0000,_0x925469,_0x116919,_0x282b6a,_0x20a8b2,_0x2b2d5a=0x3e8*0x3c*0x2,_0x21d12f=![]){const _0x61c90=_0x1607d6,_0x192c90={'TXTBB':function(_0x15c7e0,_0x248497,_0x193df9,_0x22732){return _0x15c7e0(_0x248497,_0x193df9,_0x22732);},'poyJX':_0x61c90(0x196),'SwKeT':function(_0x258975,_0xb619b6){return _0x258975===_0xb619b6;},'CgDRU':function(_0x1cbfd7,_0x2846ce,_0x49cf0b){return _0x1cbfd7(_0x2846ce,_0x49cf0b);},'ItTUe':function(_0x1371d,_0x2e9d42){return _0x1371d(_0x2e9d42);},'hFFXH':'下载超时','pboiI':function(_0x54b43){return _0x54b43();},'TUexq':function(_0x147ccf,_0x35b4a8,_0x5f1684,_0x2c4719,_0x4f8801,_0x33ae47,_0x57f29a,_0x5d844f,_0x23e49b,_0x54afbd){return _0x147ccf(_0x35b4a8,_0x5f1684,_0x2c4719,_0x4f8801,_0x33ae47,_0x57f29a,_0x5d844f,_0x23e49b,_0x54afbd);},'pehQc':_0x61c90(0x184)};_0x192c90[_0x61c90(0x1bc)](logDebug,_0x61c90(0x199),_0x3f4d15,_0x2a0000,_0x925469,_0x116919,_0x282b6a,_0x20a8b2,_0x2b2d5a,_0x21d12f);if(_0x20a8b2&&_0x1ed1b5[_0x61c90(0x197)](_0x20a8b2)){if(_0x21d12f)try{await _0x96fd61[_0x61c90(0x1b1)](_0x20a8b2);}catch(_0x1b5cc6){}else return _0x20a8b2;}return _0x192c90[_0x61c90(0x1bc)](logDebug,_0x192c90[_0x61c90(0x193)],_0x3f4d15,_0x2a0000,_0x925469,_0x116919,_0x282b6a,_0x20a8b2,_0x2b2d5a,_0x21d12f),new Promise((_0xd96671,_0x3adb7a)=>{const _0x3f8a0f=_0x61c90;let _0x115d0e=![];const _0x26293e=_0x5291c9=>{const _0x3b7ed2=_0xaaa2;_0x192c90['TXTBB'](logDebug,_0x192c90[_0x3b7ed2(0x185)],_0x5291c9,_0x3f4d15);if(_0x192c90[_0x3b7ed2(0x1b0)](_0x5291c9[_0x3b7ed2(0x1cd)],_0x3f4d15)){_0x115d0e=!![];let _0x4769bb=_0x5291c9['filePath'];if(_0x4769bb[_0x3b7ed2(0x1a7)]('\x5c')){const _0x253a94=sessionConfig[_0x3b7ed2(0x195)];_0x192c90[_0x3b7ed2(0x186)](logDebug,_0x3b7ed2(0x1d1),_0x253a94),_0x4769bb=_0x1c1882[_0x3b7ed2(0x19d)](_0x253a94,_0x4769bb);}_0x192c90[_0x3b7ed2(0x183)](_0xd96671,_0x4769bb);}};downloadMediaTasks[_0x3f8a0f(0x19b)](_0x192c90[_0x3f8a0f(0x1a0)](randomUUID),_0x26293e),setTimeout(()=>{const _0x16cf7a=_0x3f8a0f;!_0x115d0e&&_0x192c90[_0x16cf7a(0x183)](_0x3adb7a,_0x192c90['hFFXH']);},_0x2b2d5a),napCatCore['session']['getMsgService']()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3f4d15,'chatType':_0x2a0000,'peerUid':_0x925469,'elementId':_0x116919,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x282b6a});});}static async['getImageSize'](_0x247990){const _0x30ff64={'iUhha':function(_0x5495a5,_0x5b94a0){return _0x5495a5(_0x5b94a0);},'VLAuJ':function(_0x23424a,_0x4f5368,_0x375193){return _0x23424a(_0x4f5368,_0x375193);}};return new Promise((_0x2641ab,_0x56ff96)=>{const _0x55dc82=_0xaaa2;_0x30ff64[_0x55dc82(0x19a)](_0x2ebb28,_0x247990,(_0x4b8e34,_0x4067f1)=>{_0x4b8e34?_0x30ff64['iUhha'](_0x56ff96,_0x4b8e34):_0x2641ab(_0x4067f1);});});}static async[_0x1607d6(0x1c6)](_0x3e7dbf){const _0x382a12=_0x1607d6,_0x47627c={'RXbxZ':function(_0x15dce1,_0x443798){return _0x15dce1(_0x443798);},'ndSKu':_0x382a12(0x1d2),'NAdVH':function(_0x37d151,_0x3de28b){return _0x37d151*_0x3de28b;},'bznSd':_0x382a12(0x1c3),'rifBy':function(_0x32c366,_0x258c13,_0x282814){return _0x32c366(_0x258c13,_0x282814);},'aBBJw':_0x382a12(0x1ae),'zwtbA':function(_0x35a64c){return _0x35a64c();},'cLbFE':function(_0x2cb508,_0x311bc7){return _0x2cb508!==_0x311bc7;},'JqntF':_0x382a12(0x1a3),'LMVOM':'&rkey=','yyqmT':function(_0x3784c4,_0x5ce619){return _0x3784c4+_0x5ce619;},'igjDC':_0x382a12(0x1c5),'upNWr':function(_0x37469b,_0x490035){return _0x37469b>_0x490035;},'hDmut':function(_0x55fad2,_0x537437){return _0x55fad2-_0x537437;},'iEldg':function(_0x28475e,_0x54b632){return _0x28475e+_0x54b632;},'djuni':function(_0x4a7a52,_0x41ecde,_0x1a7aaf){return _0x4a7a52(_0x41ecde,_0x1a7aaf);},'udvly':function(_0x116092,_0x3f5de2){return _0x116092||_0x3f5de2;}},_0x5440ac=_0x47627c[_0x382a12(0x1c0)](_0x3e7dbf[_0x382a12(0x1b5)],ChatType[_0x382a12(0x1a8)]),_0x34e647=_0x3e7dbf[_0x382a12(0x1c7)][_0x382a12(0x1a4)](_0x424538=>!!_0x424538[_0x382a12(0x1d6)]);if(!_0x34e647)return'';const _0x2d828d=_0x34e647[_0x382a12(0x1d6)]['originImageUrl'],_0x3d1127=_0x34e647['picElement'][_0x382a12(0x1cc)],_0x4aea7f=_0x34e647[_0x382a12(0x1d6)][_0x382a12(0x1cc)],_0x28fc92=_0x34e647[_0x382a12(0x1d6)][_0x382a12(0x1ba)],_0x5dace7=_0x4d9763=>{_0x5440ac?(privateImageRKey=_0x4d9763,lastGetPrivateRKeyTime=Date['now']()):(groupImageRKey=_0x4d9763,lastGetGroupRKeyTime=Date['now']());};if(_0x2d828d){if(_0x2d828d[_0x382a12(0x1a7)](_0x47627c['JqntF'])){if(_0x2d828d['includes'](_0x47627c[_0x382a12(0x190)]))return _0x47627c[_0x382a12(0x1c8)](IMAGE_HTTP_HOST_NT,_0x2d828d);if(!hookApi['isAvailable']())return logDebug(_0x47627c[_0x382a12(0x1a1)]),'';const _0x507765=async()=>{const _0x251c78=_0x382a12;_0x47627c['RXbxZ'](logDebug,_0x47627c[_0x251c78(0x1d8)]),NTQQFileApi['downloadMedia'](_0x3e7dbf[_0x251c78(0x1cd)],_0x3e7dbf[_0x251c78(0x1b5)],_0x3e7dbf[_0x251c78(0x1a9)],_0x34e647[_0x251c78(0x181)],'',_0x34e647[_0x251c78(0x1d6)]['sourcePath'],_0x47627c[_0x251c78(0x187)](0x3e8,0x1e),![])[_0x251c78(0x189)](_0x36ce3d=>{})[_0x251c78(0x1b7)](logError),await sleep(0x3e8),_0x47627c[_0x251c78(0x1bd)](logDebug,_0x47627c['bznSd']);const _0x306c5f=hookApi['getRKey']()||'';return _0x306c5f&&(_0x47627c['rifBy'](logDebug,_0x47627c['aBBJw'],_0x306c5f),_0x5dace7(_0x306c5f)),_0x306c5f;},_0x4aff4d=new Promise((_0x2a2b02,_0x992fe8)=>{const _0x216e19=_0x382a12;getRKeyTaskQueue[_0x216e19(0x17e)](async()=>{const _0x36edb7=_0x216e19,_0x534e6f=await _0x47627c[_0x36edb7(0x1ab)](_0x507765);_0x47627c['RXbxZ'](_0x2a2b02,_0x534e6f);});}),_0x1bf0f1=_0x5440ac?privateImageRKey:groupImageRKey,_0x1aa66f=_0x5440ac?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x47627c['upNWr'](_0x47627c[_0x382a12(0x1ac)](Date['now'](),_0x1aa66f),rkeyExpireTime)||!_0x1bf0f1){const _0x4ed104=await _0x4aff4d;if(_0x4ed104)return _0x47627c['yyqmT'](_0x47627c[_0x382a12(0x198)](IMAGE_HTTP_HOST_NT,_0x2d828d),''+_0x4ed104);else _0x47627c[_0x382a12(0x1c4)](logError,_0x382a12(0x19f),_0x2d828d);}if(_0x1bf0f1)return _0x47627c['yyqmT'](_0x47627c[_0x382a12(0x198)](IMAGE_HTTP_HOST_NT,_0x2d828d),''+_0x1bf0f1);return'';}else return _0x47627c[_0x382a12(0x198)](IMAGE_HTTP_HOST,_0x2d828d);}else{if(_0x47627c[_0x382a12(0x1c1)](_0x4aea7f,_0x3d1127))return IMAGE_HTTP_HOST+_0x382a12(0x1bb)+_0x47627c[_0x382a12(0x1c1)](_0x4aea7f,_0x3d1127)[_0x382a12(0x1a5)]()+'/0';}return logDebug(_0x382a12(0x1b6),_0x3e7dbf),'';}}export class NTQQFileCacheApi{static async[_0x1607d6(0x1b4)](_0x1b8e71=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x1607d6(0x18f)](_0x1c866=[_0x1607d6(0x188),_0x1607d6(0x1cb)]){const _0x28ba05=_0x1607d6;return napCatCore[_0x28ba05(0x1a2)][_0x28ba05(0x1b8)]()['clearCacheDataByKeys'](_0x1c866);}static[_0x1607d6(0x1ce)](_0x5b1a5b={}){const _0x3fe17b=_0x1607d6;return napCatCore[_0x3fe17b(0x1a2)][_0x3fe17b(0x1b8)]()[_0x3fe17b(0x1ca)](_0x5b1a5b);}static['scanCache'](){const _0x521a17=_0x1607d6;return napCatCore['session'][_0x521a17(0x1b8)]()[_0x521a17(0x18e)]();}static[_0x1607d6(0x1c2)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x1607d6(0x1c9)](_0x4b22e8,_0x4bee39=0x3e8,_0x471ff7=0x0){const _0x5e9019=_0x1607d6;return napCatCore[_0x5e9019(0x1a2)][_0x5e9019(0x1b8)]()[_0x5e9019(0x19e)](_0x4b22e8,_0x4bee39,0x1,_0x471ff7);}static[_0x1607d6(0x191)](_0x4a0802,_0x186537=0x3e8,_0x1fd395){const _0x3eedc9=_0x1fd395?_0x1fd395:{'fileType':_0x4a0802};}static async['clearChatCache'](_0x292c2d=[],_0x4218c8=[]){const _0x3e9615=_0x1607d6;return napCatCore[_0x3e9615(0x1a2)][_0x3e9615(0x1b8)]()['clearChatCacheInfo'](_0x292c2d,_0x4218c8);}}