const _0x143072=_0x399e;(function(_0x20298c,_0x90e803){const _0x68189f=_0x399e,_0x245bae=_0x20298c();while(!![]){try{const _0x474673=-parseInt(_0x68189f(0xc8))/0x1+-parseInt(_0x68189f(0x9d))/0x2*(-parseInt(_0x68189f(0x9b))/0x3)+-parseInt(_0x68189f(0xa7))/0x4*(parseInt(_0x68189f(0x94))/0x5)+-parseInt(_0x68189f(0x97))/0x6*(-parseInt(_0x68189f(0x95))/0x7)+parseInt(_0x68189f(0xb0))/0x8*(parseInt(_0x68189f(0xb6))/0x9)+parseInt(_0x68189f(0xb8))/0xa+-parseInt(_0x68189f(0x9e))/0xb*(parseInt(_0x68189f(0xc1))/0xc);if(_0x474673===_0x90e803)break;else _0x245bae['push'](_0x245bae['shift']());}catch(_0x19621d){_0x245bae['push'](_0x245bae['shift']());}}}(_0x2884,0x78328));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1a5965 from'path';function _0x399e(_0x5354bb,_0x39d78e){const _0x288486=_0x2884();return _0x399e=function(_0x399e2c,_0x699154){_0x399e2c=_0x399e2c-0x85;let _0x27f1a3=_0x288486[_0x399e2c];return _0x27f1a3;},_0x399e(_0x5354bb,_0x39d78e);}import _0x509b94 from'fs';import _0x1311cc from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x759ec1 from'file-type';import{MsgListener}from'@/core/listeners';import _0x23b8ac from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x2884(){const _0x460cc4=['basename','getMsgService','getRkey','fileUuid','hotUpdate','vTdiT','includes','5480KhnmmO','NDOFs','getFileType','clearChatCache','piNSS','UoCXU','2502AeYpaB','SzWXI','5790700xoKTQv','gHWBC','originImageUrl','uploadFile','toUpperCase','fileTypeFromFile','urlResult','getRichMediaService','getFileSize','192GBBoym','copyFile','scanCache','getCacheSessionPathList','iaVgj','tmp','filePath','536001fGiZJa','clearChatCacheInfo','unlink','getImageSize','clearCacheDataByKeys','clearCache','defaultFileDownloadPath','/download','indexOf','xYmsq','下载超时','VaEkg','startsWith','getStorageCleanService','session','addCacheScanedPaths','pxUbd','setCacheSilentScan','addCacheScannedPaths','890Wnrnbf','287581YLNLhk','md5HexStr','42ylunAN','getVideoUrl','group_rkey','swSfF','327moFHVC','HCrTV','18052fhrKCe','149259LUwfPj','onLoginSuccess','zitIM','domainUrl','delete','util','private_rkey','existsSync','getRichMediaFilePathForGuild','17876mvavNM','getChatCacheList'];_0x2884=function(){return _0x460cc4;};return _0x2884();}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x66399d=>{const _0x2daab8=_0x399e,_0x5197f2={'pxUbd':function(_0x3f49e0,_0x6af56c){return _0x3f49e0(_0x6af56c);}};for(const [_0x5ce279,_0x3d0420]of downloadMediaTasks){_0x5197f2[_0x2daab8(0x91)](_0x3d0420,_0x66399d),downloadMediaTasks[_0x2daab8(0xa2)](_0x5ce279);}},setTimeout(()=>{const _0x299b5d=_0x399e;napCatCore[_0x299b5d(0x9f)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x143072(0xb2)](_0x4995df){const _0x303f69=_0x143072;return _0x759ec1[_0x303f69(0xbd)](_0x4995df);}static async['copyFile'](_0x14514d,_0x4453ff){const _0x201c97=_0x143072;await napCatCore[_0x201c97(0xa3)][_0x201c97(0xc2)](_0x14514d,_0x4453ff);}static async['getFileSize'](_0x34a24c){const _0x45815f=_0x143072;return await napCatCore[_0x45815f(0xa3)][_0x45815f(0xc0)](_0x34a24c);}static async[_0x143072(0x98)](_0x5dc8b5,_0x4cb728){const _0x4523f6=_0x143072;return(await napCatCore[_0x4523f6(0x8f)][_0x4523f6(0xbf)]()['getVideoPlayUrlV2']({'chatType':_0x5dc8b5['chatType'],'peerUid':_0x5dc8b5['peerUid'],'guildId':'0'},_0x5dc8b5['msgId'],_0x4cb728['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x4523f6(0xbe)][_0x4523f6(0xa1)][0x0]['url'];}static async[_0x143072(0xbb)](_0x45a59f,_0x585d94=ElementType['PIC'],_0xa5bf3c=0x0){const _0x5083ee=_0x143072,_0x4f7567={'zitIM':function(_0x35b56e,_0x385762){return _0x35b56e(_0x385762);},'SzWXI':function(_0x74e51b,_0x40c508){return _0x74e51b+_0x40c508;},'HCrTV':function(_0x28fa1f,_0x3d9be1){return _0x28fa1f===_0x3d9be1;}},_0x487c95=await _0x4f7567[_0x5083ee(0xa0)](calculateFileMD5,_0x45a59f);let _0x2bf4ce=(await NTQQFileApi[_0x5083ee(0xb2)](_0x45a59f))?.['ext']||'';_0x2bf4ce&&(_0x2bf4ce=_0x4f7567[_0x5083ee(0xb7)]('.',_0x2bf4ce));let _0x3d8f24=''+_0x1a5965[_0x5083ee(0xa9)](_0x45a59f);_0x4f7567[_0x5083ee(0x9c)](_0x3d8f24[_0x5083ee(0x89)]('.'),-0x1)&&(_0x3d8f24+=_0x2bf4ce);const _0xf6a55b=napCatCore['session'][_0x5083ee(0xaa)]()[_0x5083ee(0xa6)]({'md5HexStr':_0x487c95,'fileName':_0x3d8f24,'elementType':_0x585d94,'elementSubType':_0xa5bf3c,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x5083ee(0xc2)](_0x45a59f,_0xf6a55b);const _0x18bb2f=await NTQQFileApi[_0x5083ee(0xc0)](_0x45a59f);return{'md5':_0x487c95,'fileName':_0x3d8f24,'path':_0xf6a55b,'fileSize':_0x18bb2f,'ext':_0x2bf4ce};}static async['downloadMedia'](_0x1cdc0c,_0x16d736,_0x1ec06b,_0x42746f,_0x3b34f2,_0x52dfeb,_0x448f93=0x3e8*0x3c*0x2,_0xe60664=![]){const _0x50de30=_0x143072,_0x3e6684={'xYmsq':function(_0x52b2e7,_0x218570){return _0x52b2e7(_0x218570);},'swSfF':_0x50de30(0x8b),'piNSS':function(_0x39285c,_0x1bcf5b){return _0x39285c===_0x1bcf5b;},'QdZlT':function(_0x4e16a8,_0x4134a5,_0x4cad87){return _0x4e16a8(_0x4134a5,_0x4cad87);}};if(_0x52dfeb&&_0x509b94[_0x50de30(0xa5)](_0x52dfeb)){if(_0xe60664)try{await _0x1311cc[_0x50de30(0xca)](_0x52dfeb);}catch(_0x5bd105){}else return _0x52dfeb;}return new Promise((_0x589b41,_0x1e76b5)=>{const _0x220923=_0x50de30,_0x1f949f={'iaVgj':function(_0x30a740,_0x322dce){const _0x46e44a=_0x399e;return _0x3e6684[_0x46e44a(0xb4)](_0x30a740,_0x322dce);},'KRYfE':function(_0x21b4c7,_0x2d5588){const _0x4dff18=_0x399e;return _0x3e6684[_0x4dff18(0x8a)](_0x21b4c7,_0x2d5588);}};let _0x5a7b62=![];const _0x3a34ad=_0x3e4dec=>{const _0x2f9581=_0x399e;if(_0x1f949f[_0x2f9581(0xc5)](_0x3e4dec['msgId'],_0x1cdc0c)){_0x5a7b62=!![];let _0xb8ee72=_0x3e4dec[_0x2f9581(0xc7)];if(_0xb8ee72[_0x2f9581(0x8d)]('\x5c')){const _0x51a9ef=sessionConfig[_0x2f9581(0x87)];_0xb8ee72=_0x1a5965['join'](_0x51a9ef,_0xb8ee72);}_0x1f949f['KRYfE'](_0x589b41,_0xb8ee72);}};downloadMediaTasks['set'](randomUUID(),_0x3a34ad),_0x3e6684['QdZlT'](setTimeout,()=>{const _0x35a2c4=_0x399e;!_0x5a7b62&&_0x3e6684['xYmsq'](_0x1e76b5,_0x3e6684[_0x35a2c4(0x9a)]);},_0x448f93),napCatCore['session'][_0x220923(0xaa)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x1cdc0c,'chatType':_0x16d736,'peerUid':_0x1ec06b,'elementId':_0x42746f,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3b34f2});});}static async[_0x143072(0xcb)](_0x5c0394){return new Promise((_0xc27925,_0x59da1b)=>{_0x23b8ac(_0x5c0394,(_0x158909,_0x3172c1)=>{_0x158909?_0x59da1b(_0x158909):_0xc27925(_0x3172c1);});});}static async['getImageUrl'](_0x25ad99,_0x554e55){const _0x1f4af7=_0x143072,_0x417cce={'UoCXU':_0x1f4af7(0x88),'gHWBC':'&rkey=','VaEkg':function(_0xeea0ba,_0x4725dd){return _0xeea0ba+_0x4725dd;},'vTdiT':function(_0x4c02d5,_0xd9283c){return _0x4c02d5+_0xd9283c;},'NDOFs':function(_0x1eb0c3,_0x545843){return _0x1eb0c3||_0x545843;},'epsJM':function(_0x2786a1,_0x35968d,_0x51ced3){return _0x2786a1(_0x35968d,_0x51ced3);},'ayZIu':'图片url获取失败'};if(!_0x25ad99)return'';const _0x2af471=_0x25ad99[_0x1f4af7(0xba)],_0x3be94a=_0x25ad99[_0x1f4af7(0x96)],_0x1fc931=_0x25ad99['md5HexStr'],_0x6b2891=_0x25ad99[_0x1f4af7(0xac)];if(_0x2af471){if(_0x2af471[_0x1f4af7(0x8d)](_0x417cce[_0x1f4af7(0xb5)])){if(_0x2af471[_0x1f4af7(0xaf)](_0x417cce[_0x1f4af7(0xb9)]))return _0x417cce[_0x1f4af7(0x8c)](IMAGE_HTTP_HOST_NT,_0x2af471);const _0x19daf2=await rkeyManager[_0x1f4af7(0xab)](),_0x23b6a0=_0x554e55?_0x19daf2[_0x1f4af7(0xa4)]:_0x19daf2[_0x1f4af7(0x99)];return _0x417cce[_0x1f4af7(0xae)](IMAGE_HTTP_HOST_NT,_0x2af471)+(''+_0x23b6a0);}else return _0x417cce[_0x1f4af7(0x8c)](IMAGE_HTTP_HOST,_0x2af471);}else{if(_0x1fc931||_0x3be94a)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x417cce[_0x1f4af7(0xb1)](_0x1fc931,_0x3be94a)[_0x1f4af7(0xbc)]()+'/0';}return _0x417cce['epsJM'](logDebug,_0x417cce['ayZIu'],_0x25ad99),'';}}export class NTQQFileCacheApi{static async[_0x143072(0x92)](_0x172058=!![]){return'';}static[_0x143072(0xc4)](){return'';}static[_0x143072(0x86)](_0x1aa93c=[_0x143072(0xc6),_0x143072(0xad)]){const _0x52c4e6=_0x143072;return napCatCore['session'][_0x52c4e6(0x8e)]()[_0x52c4e6(0x85)](_0x1aa93c);}static[_0x143072(0x93)](_0x227af7={}){const _0x4ba479=_0x143072;return napCatCore[_0x4ba479(0x8f)][_0x4ba479(0x8e)]()[_0x4ba479(0x90)](_0x227af7);}static[_0x143072(0xc3)](){const _0x5b39bd=_0x143072;return napCatCore[_0x5b39bd(0x8f)][_0x5b39bd(0x8e)]()[_0x5b39bd(0xc3)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x143072(0xa8)](_0x25a72f,_0x197c01=0x3e8,_0x4c762d=0x0){const _0x516947=_0x143072;return napCatCore[_0x516947(0x8f)]['getStorageCleanService']()['getChatCacheInfo'](_0x25a72f,_0x197c01,0x1,_0x4c762d);}static['getFileCacheInfo'](_0x24a050,_0x3a3cdd=0x3e8,_0x16455d){const _0x5e2d41=_0x16455d?_0x16455d:{'fileType':_0x24a050};}static async[_0x143072(0xb3)](_0x5d0a16=[],_0x42008b=[]){const _0x5c76af=_0x143072;return napCatCore['session'][_0x5c76af(0x8e)]()[_0x5c76af(0xc9)](_0x5d0a16,_0x42008b);}}