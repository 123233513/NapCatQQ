const _0x5cc836=_0x2753;(function(_0x325c3a,_0x104157){const _0x4dc830=_0x2753,_0x1a1d7f=_0x325c3a();while(!![]){try{const _0x36f52e=-parseInt(_0x4dc830(0x174))/0x1+-parseInt(_0x4dc830(0x177))/0x2+parseInt(_0x4dc830(0x14d))/0x3+parseInt(_0x4dc830(0x155))/0x4*(parseInt(_0x4dc830(0x145))/0x5)+-parseInt(_0x4dc830(0x16b))/0x6*(-parseInt(_0x4dc830(0x137))/0x7)+-parseInt(_0x4dc830(0x13c))/0x8+-parseInt(_0x4dc830(0x13a))/0x9;if(_0x36f52e===_0x104157)break;else _0x1a1d7f['push'](_0x1a1d7f['shift']());}catch(_0x3ccd41){_0x1a1d7f['push'](_0x1a1d7f['shift']());}}}(_0x119c,0x263fe));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x3bb556 from'path';import _0x5bf1a3 from'fs';import _0x1bedda from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x1ab883 from'file-type';import{MsgListener}from'@/core/listeners';import _0x50335f from'image-size';function _0x2753(_0x41fdd2,_0x37be4d){const _0x119c22=_0x119c();return _0x2753=function(_0x275373,_0x474705){_0x275373=_0x275373-0x129;let _0x21bbe4=_0x119c22[_0x275373];return _0x21bbe4;},_0x2753(_0x41fdd2,_0x37be4d);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x119c(){const _0x38f25e=['图片url获取失败','addCacheScanedPaths','set','fileUuid','uMVze','agSaB','WrzCu','65kmtgvv','getDesktopTmpPath','onLoginSuccess','tmp','&rkey=','FUKnC','chatType','getFileSize','61701ahfIXZ','getRkey','downloadRichMedia','addCacheScannedPaths','md5HexStr','setCacheSilentScan','clearCacheDataByKeys','getMsgService','73464ACaxJF','url','delete','session','toUpperCase','unlink','includes','clearChatCache','urlResult','copyFile','fileTypeFromFile','getImageSize','rMFIR','QoqkO','zZcGi','scanCache','getCacheSessionPathList','existsSync','JkjHw','getVideoUrl','getFileType','indexOf','272214jpuKAv','ZKxes','originImageUrl','util','filePath','private_rkey','getImageUrl','clearCache','getHotUpdateCachePath','21208sxNRme','peerUid','msgId','128032rfUfKP','join','getRichMediaService','basename','group_rkey','elementId','getRichMediaFilePathForGuild','DJGIE','addListener','Tpwfh','downloadMedia','getFileCacheInfo','clearChatCacheInfo','startsWith','/gchatpic_new/0/0-0-','14LEqUwC','getStorageCleanService','TGoff','727758YhIOmB','hotUpdate','218456NkKTwA','domainUrl'];_0x119c=function(){return _0x38f25e;};return _0x119c();}const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x43aa30=>{const _0x453894=_0x2753;for(const [_0x2d7654,_0x510cfd]of downloadMediaTasks){_0x510cfd(_0x43aa30),downloadMediaTasks[_0x453894(0x157)](_0x2d7654);}},setTimeout(()=>{const _0x1261bb=_0x2753;napCatCore[_0x1261bb(0x147)](()=>{const _0x3587c0=_0x1261bb;napCatCore[_0x3587c0(0x130)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x4bfd4c){const _0x9a74a=_0x2753;return _0x1ab883[_0x9a74a(0x15f)](_0x4bfd4c);}static async['copyFile'](_0x2a6028,_0x1aa9cd){const _0xa13bae=_0x2753;await napCatCore['util'][_0xa13bae(0x15e)](_0x2a6028,_0x1aa9cd);}static async['getFileSize'](_0x5bb7bc){const _0x3b62a4=_0x2753;return await napCatCore[_0x3b62a4(0x16e)]['getFileSize'](_0x5bb7bc);}static async[_0x5cc836(0x168)](_0x143e34,_0x2c047a){const _0x757d42=_0x5cc836;return(await napCatCore['session'][_0x757d42(0x12a)]()['getVideoPlayUrlV2']({'chatType':_0x143e34[_0x757d42(0x14b)],'peerUid':_0x143e34[_0x757d42(0x175)],'guildId':'0'},_0x143e34[_0x757d42(0x176)],_0x2c047a[_0x757d42(0x12d)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x757d42(0x15d)][_0x757d42(0x13d)][0x0][_0x757d42(0x156)];}static async['uploadFile'](_0x28be73,_0x4d6d6c=ElementType['PIC'],_0x887ed4=0x0){const _0x1e3d69=_0x5cc836,_0xbb142a={'zZcGi':function(_0x4ca907,_0x15a7fd){return _0x4ca907+_0x15a7fd;},'QoqkO':function(_0x1132f8,_0x2cf667){return _0x1132f8===_0x2cf667;}},_0x20eb82=await calculateFileMD5(_0x28be73);let _0x21ab34=(await NTQQFileApi[_0x1e3d69(0x169)](_0x28be73))?.['ext']||'';_0x21ab34&&(_0x21ab34=_0xbb142a[_0x1e3d69(0x163)]('.',_0x21ab34));let _0xa54243=''+_0x3bb556[_0x1e3d69(0x12b)](_0x28be73);_0xbb142a[_0x1e3d69(0x162)](_0xa54243[_0x1e3d69(0x16a)]('.'),-0x1)&&(_0xa54243+=_0x21ab34);const _0x2aca53=napCatCore[_0x1e3d69(0x158)][_0x1e3d69(0x154)]()[_0x1e3d69(0x12e)]({'md5HexStr':_0x20eb82,'fileName':_0xa54243,'elementType':_0x4d6d6c,'elementSubType':_0x887ed4,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x1e3d69(0x15e)](_0x28be73,_0x2aca53);const _0x457ed8=await NTQQFileApi[_0x1e3d69(0x14c)](_0x28be73);return{'md5':_0x20eb82,'fileName':_0xa54243,'path':_0x2aca53,'fileSize':_0x457ed8,'ext':_0x21ab34};}static async[_0x5cc836(0x132)](_0x5a7075,_0x342e6b,_0x50a1e3,_0x2b9fd8,_0x26fbc5,_0x2e59fd,_0x50412a=0x3e8*0x3c*0x2,_0x3be495=![]){const _0xf0a703=_0x5cc836,_0x137ad9={'eNFjE':function(_0x2ae1c5,_0x32005a){return _0x2ae1c5(_0x32005a);},'ZKxes':function(_0x2c88da,_0x380753){return _0x2c88da(_0x380753);},'Vqnbe':'下载超时','agSaB':function(_0x3d8991){return _0x3d8991();},'KdcDS':function(_0x410e1c,_0x275ddb,_0x220fe8){return _0x410e1c(_0x275ddb,_0x220fe8);}};if(_0x2e59fd&&_0x5bf1a3[_0xf0a703(0x166)](_0x2e59fd)){if(_0x3be495)try{await _0x1bedda[_0xf0a703(0x15a)](_0x2e59fd);}catch(_0x42fec1){}else return _0x2e59fd;}return new Promise((_0x43aeff,_0x59ee69)=>{const _0x530cca=_0xf0a703,_0x13226f={'FUKnC':function(_0x5d6c80,_0x5707a8){const _0x38aa81=_0x2753;return _0x137ad9[_0x38aa81(0x16c)](_0x5d6c80,_0x5707a8);},'TGoff':_0x137ad9['Vqnbe']};let _0x58c57f=![];const _0x4af187=_0x54bfd2=>{const _0x599c7a=_0x2753;if(_0x54bfd2[_0x599c7a(0x176)]===_0x5a7075){_0x58c57f=!![];let _0xc935b=_0x54bfd2[_0x599c7a(0x16f)];if(_0xc935b[_0x599c7a(0x135)]('\x5c')){const _0x4169d4=sessionConfig['defaultFileDownloadPath'];_0xc935b=_0x3bb556[_0x599c7a(0x129)](_0x4169d4,_0xc935b);}_0x137ad9['eNFjE'](_0x43aeff,_0xc935b);}};downloadMediaTasks[_0x530cca(0x140)](_0x137ad9[_0x530cca(0x143)](randomUUID),_0x4af187),_0x137ad9['KdcDS'](setTimeout,()=>{const _0xb08cf8=_0x530cca;!_0x58c57f&&_0x13226f[_0xb08cf8(0x14a)](_0x59ee69,_0x13226f[_0xb08cf8(0x139)]);},_0x50412a),napCatCore[_0x530cca(0x158)][_0x530cca(0x154)]()[_0x530cca(0x14f)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x5a7075,'chatType':_0x342e6b,'peerUid':_0x50a1e3,'elementId':_0x2b9fd8,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x26fbc5});});}static async[_0x5cc836(0x160)](_0x256a4e){const _0x92a364={'bhGvn':function(_0x8f46ce,_0x17c518){return _0x8f46ce(_0x17c518);},'rMFIR':function(_0x5d944c,_0x304fc0,_0x106c90){return _0x5d944c(_0x304fc0,_0x106c90);}};return new Promise((_0x30e6ab,_0x548022)=>{const _0x2d5105=_0x2753;_0x92a364[_0x2d5105(0x161)](_0x50335f,_0x256a4e,(_0x1019b2,_0x232d49)=>{_0x1019b2?_0x548022(_0x1019b2):_0x92a364['bhGvn'](_0x30e6ab,_0x232d49);});});}static async[_0x5cc836(0x171)](_0x2e48d5,_0xde902){const _0x4bbfa5=_0x5cc836,_0x385d3d={'JkjHw':'/download','DJGIE':_0x4bbfa5(0x149),'Tpwfh':function(_0x236756,_0x4a101d){return _0x236756+_0x4a101d;},'uMVze':function(_0x24355,_0x1fc316){return _0x24355+_0x1fc316;},'WrzCu':function(_0x30dd54,_0x4ccfc5){return _0x30dd54||_0x4ccfc5;}};if(!_0x2e48d5)return'';const _0xfe8a46=_0x2e48d5[_0x4bbfa5(0x16d)],_0x51e567=_0x2e48d5[_0x4bbfa5(0x151)],_0x55be85=_0x2e48d5[_0x4bbfa5(0x151)],_0x3b3094=_0x2e48d5[_0x4bbfa5(0x141)];if(_0xfe8a46){if(_0xfe8a46[_0x4bbfa5(0x135)](_0x385d3d[_0x4bbfa5(0x167)])){if(_0xfe8a46[_0x4bbfa5(0x15b)](_0x385d3d[_0x4bbfa5(0x12f)]))return IMAGE_HTTP_HOST_NT+_0xfe8a46;const _0x5b2af0=await rkeyManager[_0x4bbfa5(0x14e)](),_0x4e1d44=_0xde902?_0x5b2af0[_0x4bbfa5(0x170)]:_0x5b2af0[_0x4bbfa5(0x12c)];return _0x385d3d[_0x4bbfa5(0x131)](_0x385d3d[_0x4bbfa5(0x131)](IMAGE_HTTP_HOST_NT,_0xfe8a46),''+_0x4e1d44);}else return _0x385d3d[_0x4bbfa5(0x142)](IMAGE_HTTP_HOST,_0xfe8a46);}else{if(_0x55be85||_0x51e567)return IMAGE_HTTP_HOST+_0x4bbfa5(0x136)+_0x385d3d[_0x4bbfa5(0x144)](_0x55be85,_0x51e567)[_0x4bbfa5(0x159)]()+'/0';}return logDebug(_0x4bbfa5(0x13e),_0x2e48d5),'';}}export class NTQQFileCacheApi{static async[_0x5cc836(0x152)](_0x4589eb=!![]){return'';}static[_0x5cc836(0x165)](){return'';}static[_0x5cc836(0x172)](_0x386496=[_0x5cc836(0x148),_0x5cc836(0x13b)]){const _0x143ea9=_0x5cc836;return napCatCore[_0x143ea9(0x158)][_0x143ea9(0x138)]()[_0x143ea9(0x153)](_0x386496);}static[_0x5cc836(0x150)](_0x457d7b={}){const _0x4ef075=_0x5cc836;return napCatCore[_0x4ef075(0x158)][_0x4ef075(0x138)]()[_0x4ef075(0x13f)](_0x457d7b);}static[_0x5cc836(0x164)](){const _0x4d438e=_0x5cc836;return napCatCore[_0x4d438e(0x158)]['getStorageCleanService']()[_0x4d438e(0x164)]();}static[_0x5cc836(0x173)](){return'';}static[_0x5cc836(0x146)](){return'';}static['getChatCacheList'](_0xeca349,_0x492e7a=0x3e8,_0x36f7cd=0x0){const _0x52aa1a=_0x5cc836;return napCatCore[_0x52aa1a(0x158)][_0x52aa1a(0x138)]()['getChatCacheInfo'](_0xeca349,_0x492e7a,0x1,_0x36f7cd);}static[_0x5cc836(0x133)](_0x29d982,_0x396ab3=0x3e8,_0x534ecd){const _0x4a9df6=_0x534ecd?_0x534ecd:{'fileType':_0x29d982};}static async[_0x5cc836(0x15c)](_0x5b7ea5=[],_0x14902e=[]){const _0x33e331=_0x5cc836;return napCatCore['session'][_0x33e331(0x138)]()[_0x33e331(0x134)](_0x5b7ea5,_0x14902e);}}