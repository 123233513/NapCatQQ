const _0x5ba8d8=_0x32a6;(function(_0x1ae444,_0x2300ec){const _0xc23a3a=_0x32a6,_0x59d71b=_0x1ae444();while(!![]){try{const _0x9133af=-parseInt(_0xc23a3a(0x20a))/0x1*(-parseInt(_0xc23a3a(0x22a))/0x2)+parseInt(_0xc23a3a(0x21e))/0x3*(parseInt(_0xc23a3a(0x1f9))/0x4)+parseInt(_0xc23a3a(0x228))/0x5+-parseInt(_0xc23a3a(0x218))/0x6+-parseInt(_0xc23a3a(0x1f4))/0x7+-parseInt(_0xc23a3a(0x223))/0x8+-parseInt(_0xc23a3a(0x203))/0x9*(-parseInt(_0xc23a3a(0x225))/0xa);if(_0x9133af===_0x2300ec)break;else _0x59d71b['push'](_0x59d71b['shift']());}catch(_0x2f7f12){_0x59d71b['push'](_0x59d71b['shift']());}}}(_0x2c58,0xdaace));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1452ba from'path';import _0x1d08c5 from'fs';import _0x1e2e1f from'fs/promises';import{logDebug}from'@/common/utils/log';function _0x2c58(){const _0x5f37e3=['fpsmp','yrsJU','getFileType','ZwdZs','TcxgK','4000128MCsIXS','&rkey=','copyFile','unlink','downloadMedia','uoYRL','2708907PtadTC','getChatCacheInfo','addListener','toUpperCase','onRichMediaDownloadComplete','12900440mlvfFl','tmp','30470IddJNe','/gchatpic_new/0/0-0-','uploadFile','8417810MXTccB','originImageUrl','18alsqdG','filePath','getHotUpdateCachePath','startsWith','getFileCacheInfo','setCacheSilentScan','util','clearCache','md5HexStr','msgId','getRichMediaFilePathForGuild','oXrGB','FQmKj','10781435AOUArN','getChatCacheList','getImageUrl','onLoginSuccess','RqmQp','4MpQoJm','addCacheScannedPaths','getMsgService','scanCache','clearCacheDataByKeys','includes','group_rkey','getDesktopTmpPath','InUkW','indexOf','2484PjRnHy','Hvjhc','EfzNH','delete','set','nyrcG','getStorageCleanService','143071CMqzcp','getImageSize','clearChatCache','图片url获取失败','getFileSize','addCacheScanedPaths','session','join','defaultFileDownloadPath'];_0x2c58=function(){return _0x5f37e3;};return _0x2c58();}import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x7f1c3f from'file-type';import{MsgListener}from'@/core/listeners';import _0x2f415c from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x32a6(_0x1a83d1,_0x1be544){const _0x2c5845=_0x2c58();return _0x32a6=function(_0x32a65c,_0x6afaf3){_0x32a65c=_0x32a65c-0x1ec;let _0x2fd0ed=_0x2c5845[_0x32a65c];return _0x2fd0ed;},_0x32a6(_0x1a83d1,_0x1be544);}const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x5ba8d8(0x222)]=_0x2c158d=>{const _0x363ebe=_0x5ba8d8,_0x5c928c={'RqmQp':function(_0x59f7f4,_0x4707fc){return _0x59f7f4(_0x4707fc);}};for(const [_0x155ba4,_0x4db0a8]of downloadMediaTasks){_0x5c928c[_0x363ebe(0x1f8)](_0x4db0a8,_0x2c158d),downloadMediaTasks[_0x363ebe(0x206)](_0x155ba4);}},setTimeout(()=>{const _0x466ba7=_0x5ba8d8;napCatCore[_0x466ba7(0x1f7)](()=>{const _0x2d6e7c=_0x466ba7;napCatCore[_0x2d6e7c(0x220)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x41868a){return _0x7f1c3f['fileTypeFromFile'](_0x41868a);}static async[_0x5ba8d8(0x21a)](_0x54bb84,_0x43caa7){const _0x26c330=_0x5ba8d8;await napCatCore[_0x26c330(0x1ed)][_0x26c330(0x21a)](_0x54bb84,_0x43caa7);}static async['getFileSize'](_0x4bbf5d){const _0xf464ec=_0x5ba8d8;return await napCatCore[_0xf464ec(0x1ed)]['getFileSize'](_0x4bbf5d);}static async[_0x5ba8d8(0x227)](_0x46d6ae,_0x4eb772=ElementType['PIC'],_0x284dd7=0x0){const _0x55d03c=_0x5ba8d8,_0x226843={'DCkwn':function(_0x12d4f1,_0x4b54b9){return _0x12d4f1(_0x4b54b9);},'UmJUN':function(_0x5ecf2b,_0x1b4512){return _0x5ecf2b+_0x1b4512;},'nyrcG':function(_0x450259,_0x2bbe6c){return _0x450259===_0x2bbe6c;}},_0x14eff5=await _0x226843['DCkwn'](calculateFileMD5,_0x46d6ae);let _0x2456a4=(await NTQQFileApi[_0x55d03c(0x215)](_0x46d6ae))?.['ext']||'';_0x2456a4&&(_0x2456a4=_0x226843['UmJUN']('.',_0x2456a4));let _0x148d5b=''+_0x1452ba['basename'](_0x46d6ae);_0x226843[_0x55d03c(0x208)](_0x148d5b[_0x55d03c(0x202)]('.'),-0x1)&&(_0x148d5b+=_0x2456a4);const _0x56c07b=napCatCore[_0x55d03c(0x210)]['getMsgService']()[_0x55d03c(0x1f1)]({'md5HexStr':_0x14eff5,'fileName':_0x148d5b,'elementType':_0x4eb772,'elementSubType':_0x284dd7,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x55d03c(0x21a)](_0x46d6ae,_0x56c07b);const _0x25d0aa=await NTQQFileApi[_0x55d03c(0x20e)](_0x46d6ae);return{'md5':_0x14eff5,'fileName':_0x148d5b,'path':_0x56c07b,'fileSize':_0x25d0aa,'ext':_0x2456a4};}static async[_0x5ba8d8(0x21c)](_0x399769,_0x3ddc5b,_0xfbcbc,_0x37f524,_0x7e55a4,_0x144318,_0x120020=0x3e8*0x3c*0x2,_0x162d76=![]){const _0x385c4b=_0x5ba8d8,_0x21063a={'EfzNH':function(_0xd95561,_0x3e8934){return _0xd95561===_0x3e8934;},'rYfjN':function(_0xe567fc,_0x5425c7){return _0xe567fc(_0x5425c7);},'ZwdZs':function(_0x3d3d3b,_0x4d5fcf){return _0x3d3d3b(_0x4d5fcf);},'Hvjhc':function(_0x16cf5d){return _0x16cf5d();},'SGdVE':function(_0xc200a,_0x39ca55,_0x5e7123){return _0xc200a(_0x39ca55,_0x5e7123);}};if(_0x144318&&_0x1d08c5['existsSync'](_0x144318)){if(_0x162d76)try{await _0x1e2e1f[_0x385c4b(0x21b)](_0x144318);}catch(_0x15c576){}else return _0x144318;}return new Promise((_0x17c80b,_0x4f94da)=>{const _0x6bf714=_0x385c4b;let _0x3eb7ad=![];const _0x1ac3c8=_0xaffb4e=>{const _0x34037e=_0x32a6;if(_0x21063a[_0x34037e(0x205)](_0xaffb4e[_0x34037e(0x1f0)],_0x399769)){_0x3eb7ad=!![];let _0x4a2e96=_0xaffb4e[_0x34037e(0x22b)];if(_0x4a2e96[_0x34037e(0x22d)]('\x5c')){const _0x53d303=sessionConfig[_0x34037e(0x212)];_0x4a2e96=_0x1452ba[_0x34037e(0x211)](_0x53d303,_0x4a2e96);}_0x21063a['rYfjN'](_0x17c80b,_0x4a2e96);}};downloadMediaTasks[_0x6bf714(0x207)](_0x21063a[_0x6bf714(0x204)](randomUUID),_0x1ac3c8),_0x21063a['SGdVE'](setTimeout,()=>{const _0xcc3ddc=_0x6bf714;!_0x3eb7ad&&_0x21063a[_0xcc3ddc(0x216)](_0x4f94da,'下载超时');},_0x120020),napCatCore['session'][_0x6bf714(0x1fb)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x399769,'chatType':_0x3ddc5b,'peerUid':_0xfbcbc,'elementId':_0x37f524,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x7e55a4});});}static async[_0x5ba8d8(0x20b)](_0x23ef50){const _0x2944c1={'fyrEg':function(_0x19ce6c,_0x14c5ff){return _0x19ce6c(_0x14c5ff);}};return new Promise((_0x54db5c,_0x2f2e63)=>{_0x2f415c(_0x23ef50,(_0x5469fa,_0x2d21b9)=>{_0x5469fa?_0x2944c1['fyrEg'](_0x2f2e63,_0x5469fa):_0x2944c1['fyrEg'](_0x54db5c,_0x2d21b9);});});}static async[_0x5ba8d8(0x1f6)](_0x2e69cd,_0x1c15eb){const _0x56ea10=_0x5ba8d8,_0x16ee49={'oXrGB':'/download','FQmKj':function(_0x28421e,_0xcde726){return _0x28421e+_0xcde726;},'fpsmp':function(_0x445b84,_0x1d8592){return _0x445b84+_0x1d8592;},'uoYRL':function(_0x3a5042,_0x44d58c){return _0x3a5042+_0x44d58c;},'TcxgK':function(_0x566371,_0xb7f1d1){return _0x566371||_0xb7f1d1;},'yrsJU':function(_0x582125,_0x4e4141){return _0x582125||_0x4e4141;},'InUkW':function(_0x3dfc06,_0x267168,_0x582231){return _0x3dfc06(_0x267168,_0x582231);},'SJwVC':_0x56ea10(0x20d)};if(!_0x2e69cd)return'';const _0x38387c=_0x2e69cd[_0x56ea10(0x229)],_0x5d420a=_0x2e69cd[_0x56ea10(0x1ef)],_0x5da346=_0x2e69cd['md5HexStr'],_0x5e4671=_0x2e69cd['fileUuid'];if(_0x38387c){if(_0x38387c[_0x56ea10(0x22d)](_0x16ee49[_0x56ea10(0x1f2)])){if(_0x38387c[_0x56ea10(0x1fe)](_0x56ea10(0x219)))return _0x16ee49['FQmKj'](IMAGE_HTTP_HOST_NT,_0x38387c);const _0xfd7700=await rkeyManager['getRkey'](),_0x4b059f=_0x1c15eb?_0xfd7700['private_rkey']:_0xfd7700[_0x56ea10(0x1ff)];return _0x16ee49[_0x56ea10(0x1f3)](_0x16ee49[_0x56ea10(0x213)](IMAGE_HTTP_HOST_NT,_0x38387c),''+_0x4b059f);}else return _0x16ee49[_0x56ea10(0x21d)](IMAGE_HTTP_HOST,_0x38387c);}else{if(_0x16ee49[_0x56ea10(0x217)](_0x5da346,_0x5d420a))return IMAGE_HTTP_HOST+_0x56ea10(0x226)+_0x16ee49[_0x56ea10(0x214)](_0x5da346,_0x5d420a)[_0x56ea10(0x221)]()+'/0';}return _0x16ee49[_0x56ea10(0x201)](logDebug,_0x16ee49['SJwVC'],_0x2e69cd),'';}}export class NTQQFileCacheApi{static async[_0x5ba8d8(0x1ec)](_0x2754a4=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x5ba8d8(0x1ee)](_0xe5378a=[_0x5ba8d8(0x224),'hotUpdate']){const _0xf75987=_0x5ba8d8;return napCatCore[_0xf75987(0x210)]['getStorageCleanService']()[_0xf75987(0x1fd)](_0xe5378a);}static[_0x5ba8d8(0x1fa)](_0xd5f15b={}){const _0x55dec7=_0x5ba8d8;return napCatCore[_0x55dec7(0x210)]['getStorageCleanService']()[_0x55dec7(0x20f)](_0xd5f15b);}static[_0x5ba8d8(0x1fc)](){const _0x3d4166=_0x5ba8d8;return napCatCore[_0x3d4166(0x210)][_0x3d4166(0x209)]()['scanCache']();}static[_0x5ba8d8(0x22c)](){return'';}static[_0x5ba8d8(0x200)](){return'';}static[_0x5ba8d8(0x1f5)](_0x4fb8c0,_0x10ea57=0x3e8,_0x52a5bf=0x0){const _0x158c9b=_0x5ba8d8;return napCatCore[_0x158c9b(0x210)][_0x158c9b(0x209)]()[_0x158c9b(0x21f)](_0x4fb8c0,_0x10ea57,0x1,_0x52a5bf);}static[_0x5ba8d8(0x22e)](_0x657d81,_0x3061e4=0x3e8,_0x19915f){const _0x604a62=_0x19915f?_0x19915f:{'fileType':_0x657d81};}static async[_0x5ba8d8(0x20c)](_0x96831c=[],_0xba2509=[]){const _0x3ba9e3=_0x5ba8d8;return napCatCore[_0x3ba9e3(0x210)][_0x3ba9e3(0x209)]()['clearChatCacheInfo'](_0x96831c,_0xba2509);}}