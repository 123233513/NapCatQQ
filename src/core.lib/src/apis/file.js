const _0x14c271=_0x42ca;(function(_0xed578,_0x7ddce5){const _0x4b4593=_0x42ca,_0x4d8ad9=_0xed578();while(!![]){try{const _0xc64252=-parseInt(_0x4b4593(0x1e7))/0x1+parseInt(_0x4b4593(0x1eb))/0x2*(parseInt(_0x4b4593(0x1ca))/0x3)+parseInt(_0x4b4593(0x1d4))/0x4+-parseInt(_0x4b4593(0x1e2))/0x5+parseInt(_0x4b4593(0x1e4))/0x6+parseInt(_0x4b4593(0x1b5))/0x7*(parseInt(_0x4b4593(0x1c1))/0x8)+parseInt(_0x4b4593(0x1d3))/0x9*(-parseInt(_0x4b4593(0x1bf))/0xa);if(_0xc64252===_0x7ddce5)break;else _0x4d8ad9['push'](_0x4d8ad9['shift']());}catch(_0x277d72){_0x4d8ad9['push'](_0x4d8ad9['shift']());}}}(_0x1575,0xf31df));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x325ac7 from'path';import _0x56dfae from'fs';function _0x1575(){const _0x4e8bd4=['uploadFile','1503752YQGuRd','getVideoPlayUrlV2','gBhKl','onRichMediaDownloadComplete','34wzVWMk','indexOf','addCacheScanedPaths','filePath','YPfvw','jhobf','OsDZV','oNiPw','scanCache','下载超时','getVideoUrl','addListener','downloadRichMedia','getMsgService','/gchatpic_new/0/0-0-','unlink','IpOqY','dGRYH','urlResult','defaultFileDownloadPath','1407xnqqsa','msgId','getHotUpdateCachePath','copyFile','clearCache','getRkey','DySau','getDesktopTmpPath','getChatCacheList','fileUuid','19370oXONzy','PIC','26024IIyZyP','util','clearCacheDataByKeys','aldbh','delete','GiCUW','/download','group_rkey','domainUrl','57453UDTjvk','fileTypeFromFile','clearChatCache','startsWith','getRichMediaService','includes','getStorageCleanService','join','session','999XtIDGr','4667776Affihm','url','clearChatCacheInfo','downloadMedia','&rkey=','FpHEC','set','getCacheSessionPathList','TwGKy','md5HexStr','elementId','getFileSize','existsSync','addCacheScannedPaths','4411285zkABJR','setCacheSilentScan','8702754nsjrXY','basename'];_0x1575=function(){return _0x4e8bd4;};return _0x1575();}import _0x1bc39c from'fs/promises';import{logDebug}from'@/common/utils/log';function _0x42ca(_0x19c4ab,_0x1d03e8){const _0x15757b=_0x1575();return _0x42ca=function(_0x42ca71,_0x5633fb){_0x42ca71=_0x42ca71-0x1ae;let _0x4dd7c4=_0x15757b[_0x42ca71];return _0x4dd7c4;},_0x42ca(_0x19c4ab,_0x1d03e8);}import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x238258 from'file-type';import{MsgListener}from'@/core/listeners';import _0x438b17 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x14c271(0x1ea)]=_0xf74431=>{const _0x1ac714=_0x14c271,_0x34e416={'YPfvw':function(_0x112eb3,_0x26e2f9){return _0x112eb3(_0x26e2f9);}};for(const [_0x17dd4c,_0xb5b0c3]of downloadMediaTasks){_0x34e416[_0x1ac714(0x1ef)](_0xb5b0c3,_0xf74431),downloadMediaTasks[_0x1ac714(0x1c5)](_0x17dd4c);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x498ea7=_0x42ca;napCatCore[_0x498ea7(0x1f6)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x5d2f52){const _0x5367bd=_0x14c271;return _0x238258[_0x5367bd(0x1cb)](_0x5d2f52);}static async[_0x14c271(0x1b8)](_0xf23ba0,_0xa5583c){const _0x2d44be=_0x14c271;await napCatCore[_0x2d44be(0x1c2)][_0x2d44be(0x1b8)](_0xf23ba0,_0xa5583c);}static async[_0x14c271(0x1df)](_0x2af09e){const _0x18b0bd=_0x14c271;return await napCatCore[_0x18b0bd(0x1c2)][_0x18b0bd(0x1df)](_0x2af09e);}static async[_0x14c271(0x1f5)](_0x4c0d21,_0x586dce){const _0x2cd39d=_0x14c271;return(await napCatCore[_0x2cd39d(0x1d2)][_0x2cd39d(0x1ce)]()[_0x2cd39d(0x1e8)]({'chatType':_0x4c0d21['chatType'],'peerUid':_0x4c0d21['peerUid'],'guildId':'0'},_0x4c0d21[_0x2cd39d(0x1b6)],_0x586dce[_0x2cd39d(0x1de)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x2cd39d(0x1b3)][_0x2cd39d(0x1c9)][0x0][_0x2cd39d(0x1d5)];}static async[_0x14c271(0x1e6)](_0xd539a3,_0x55bfa6=ElementType[_0x14c271(0x1c0)],_0x119189=0x0){const _0x1c6a98=_0x14c271,_0x26b474={'GiCUW':function(_0x561188,_0x3fb410){return _0x561188(_0x3fb410);},'OsDZV':function(_0x4cafe1,_0x2557b8){return _0x4cafe1===_0x2557b8;}},_0x7ead50=await _0x26b474[_0x1c6a98(0x1c6)](calculateFileMD5,_0xd539a3);let _0x4e6e3a=(await NTQQFileApi['getFileType'](_0xd539a3))?.['ext']||'';_0x4e6e3a&&(_0x4e6e3a='.'+_0x4e6e3a);let _0xb086f7=''+_0x325ac7[_0x1c6a98(0x1e5)](_0xd539a3);_0x26b474[_0x1c6a98(0x1f1)](_0xb086f7[_0x1c6a98(0x1ec)]('.'),-0x1)&&(_0xb086f7+=_0x4e6e3a);const _0x2b644b=napCatCore['session'][_0x1c6a98(0x1ae)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x7ead50,'fileName':_0xb086f7,'elementType':_0x55bfa6,'elementSubType':_0x119189,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x1c6a98(0x1b8)](_0xd539a3,_0x2b644b);const _0x1c7390=await NTQQFileApi[_0x1c6a98(0x1df)](_0xd539a3);return{'md5':_0x7ead50,'fileName':_0xb086f7,'path':_0x2b644b,'fileSize':_0x1c7390,'ext':_0x4e6e3a};}static async[_0x14c271(0x1d7)](_0x471b1c,_0x1b12c3,_0x2a5852,_0x4878d2,_0x5954f9,_0x3a7204,_0xa03b46=0x3e8*0x3c*0x2,_0x2305ca=![]){const _0x84b936=_0x14c271,_0x5d1c81={'jhobf':function(_0x1c8c79,_0xce963){return _0x1c8c79(_0xce963);},'gBhKl':_0x84b936(0x1f4),'dGRYH':function(_0x550ecf){return _0x550ecf();}};if(_0x3a7204&&_0x56dfae[_0x84b936(0x1e0)](_0x3a7204)){if(_0x2305ca)try{await _0x1bc39c[_0x84b936(0x1b0)](_0x3a7204);}catch(_0x3cadc4){}else return _0x3a7204;}return new Promise((_0xb72706,_0x2189d1)=>{const _0x3463e6=_0x84b936;let _0x5f3eaf=![];const _0xd20ee8=_0x2591b7=>{const _0x39ac38=_0x42ca;if(_0x2591b7[_0x39ac38(0x1b6)]===_0x471b1c){_0x5f3eaf=!![];let _0x4bdff6=_0x2591b7[_0x39ac38(0x1ee)];if(_0x4bdff6[_0x39ac38(0x1cd)]('\x5c')){const _0xa327=sessionConfig[_0x39ac38(0x1b4)];_0x4bdff6=_0x325ac7[_0x39ac38(0x1d1)](_0xa327,_0x4bdff6);}_0x5d1c81[_0x39ac38(0x1f0)](_0xb72706,_0x4bdff6);}};downloadMediaTasks[_0x3463e6(0x1da)](_0x5d1c81[_0x3463e6(0x1b2)](randomUUID),_0xd20ee8),setTimeout(()=>{const _0x4d31be=_0x3463e6;!_0x5f3eaf&&_0x2189d1(_0x5d1c81[_0x4d31be(0x1e9)]);},_0xa03b46),napCatCore[_0x3463e6(0x1d2)][_0x3463e6(0x1ae)]()[_0x3463e6(0x1f7)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x471b1c,'chatType':_0x1b12c3,'peerUid':_0x2a5852,'elementId':_0x4878d2,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x5954f9});});}static async['getImageSize'](_0x5e3783){const _0x21fbda={'DySau':function(_0x5d32b9,_0x341f20){return _0x5d32b9(_0x341f20);},'oNiPw':function(_0x23769d,_0x1e4767,_0x3ce2bc){return _0x23769d(_0x1e4767,_0x3ce2bc);}};return new Promise((_0x58ebc9,_0x1b3b38)=>{const _0x3c8c89=_0x42ca;_0x21fbda[_0x3c8c89(0x1f2)](_0x438b17,_0x5e3783,(_0x14a3e6,_0x32cfb7)=>{const _0x1f843b=_0x3c8c89;_0x14a3e6?_0x21fbda[_0x1f843b(0x1bb)](_0x1b3b38,_0x14a3e6):_0x58ebc9(_0x32cfb7);});});}static async['getImageUrl'](_0x1588fe,_0x1f60e9){const _0x1e8788=_0x14c271,_0x4712c1={'zWQpC':_0x1e8788(0x1c7),'TwGKy':_0x1e8788(0x1d8),'FpHEC':function(_0x1817dd,_0x5af522){return _0x1817dd+_0x5af522;},'aldbh':function(_0x23865f,_0x5a89a0){return _0x23865f+_0x5a89a0;},'RShXP':function(_0x5c7637,_0x2ff667){return _0x5c7637+_0x2ff667;},'IpOqY':function(_0x581956,_0x50bfc4,_0x3fbbd8){return _0x581956(_0x50bfc4,_0x3fbbd8);}};if(!_0x1588fe)return'';const _0x149dbd=_0x1588fe['originImageUrl'],_0x499820=_0x1588fe[_0x1e8788(0x1dd)],_0x5c6759=_0x1588fe[_0x1e8788(0x1dd)],_0x28c46f=_0x1588fe[_0x1e8788(0x1be)];if(_0x149dbd){if(_0x149dbd[_0x1e8788(0x1cd)](_0x4712c1['zWQpC'])){if(_0x149dbd[_0x1e8788(0x1cf)](_0x4712c1[_0x1e8788(0x1dc)]))return _0x4712c1[_0x1e8788(0x1d9)](IMAGE_HTTP_HOST_NT,_0x149dbd);const _0x21c34b=await rkeyManager[_0x1e8788(0x1ba)](),_0x42f672=_0x1f60e9?_0x21c34b['private_rkey']:_0x21c34b[_0x1e8788(0x1c8)];return _0x4712c1[_0x1e8788(0x1c4)](_0x4712c1['RShXP'](IMAGE_HTTP_HOST_NT,_0x149dbd),''+_0x42f672);}else return IMAGE_HTTP_HOST+_0x149dbd;}else{if(_0x5c6759||_0x499820)return IMAGE_HTTP_HOST+_0x1e8788(0x1af)+(_0x5c6759||_0x499820)['toUpperCase']()+'/0';}return _0x4712c1[_0x1e8788(0x1b1)](logDebug,'图片url获取失败',_0x1588fe),'';}}export class NTQQFileCacheApi{static async[_0x14c271(0x1e3)](_0x232b7=!![]){return'';}static[_0x14c271(0x1db)](){return'';}static[_0x14c271(0x1b9)](_0x14d2ba=['tmp','hotUpdate']){const _0x4e986e=_0x14c271;return napCatCore[_0x4e986e(0x1d2)][_0x4e986e(0x1d0)]()[_0x4e986e(0x1c3)](_0x14d2ba);}static[_0x14c271(0x1e1)](_0x432905={}){const _0x64a291=_0x14c271;return napCatCore[_0x64a291(0x1d2)][_0x64a291(0x1d0)]()[_0x64a291(0x1ed)](_0x432905);}static[_0x14c271(0x1f3)](){const _0x54dfb5=_0x14c271;return napCatCore[_0x54dfb5(0x1d2)][_0x54dfb5(0x1d0)]()[_0x54dfb5(0x1f3)]();}static[_0x14c271(0x1b7)](){return'';}static[_0x14c271(0x1bc)](){return'';}static[_0x14c271(0x1bd)](_0x3dbb89,_0x19a5c7=0x3e8,_0x51f02b=0x0){const _0x5b43ba=_0x14c271;return napCatCore[_0x5b43ba(0x1d2)][_0x5b43ba(0x1d0)]()['getChatCacheInfo'](_0x3dbb89,_0x19a5c7,0x1,_0x51f02b);}static['getFileCacheInfo'](_0x256a4f,_0x14f17b=0x3e8,_0x57391a){const _0x468318=_0x57391a?_0x57391a:{'fileType':_0x256a4f};}static async[_0x14c271(0x1cc)](_0x2f25a0=[],_0x25c571=[]){const _0x25189a=_0x14c271;return napCatCore[_0x25189a(0x1d2)][_0x25189a(0x1d0)]()[_0x25189a(0x1d6)](_0x2f25a0,_0x25c571);}}