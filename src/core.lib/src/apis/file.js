const _0xa02654=_0x58d9;(function(_0x2f384a,_0x224a3c){const _0x470d70=_0x58d9,_0x4b40c6=_0x2f384a();while(!![]){try{const _0x3ae343=parseInt(_0x470d70(0x1d2))/0x1*(parseInt(_0x470d70(0x199))/0x2)+parseInt(_0x470d70(0x1cd))/0x3*(parseInt(_0x470d70(0x1ba))/0x4)+parseInt(_0x470d70(0x1a0))/0x5+-parseInt(_0x470d70(0x19e))/0x6*(-parseInt(_0x470d70(0x1a1))/0x7)+parseInt(_0x470d70(0x1c8))/0x8+parseInt(_0x470d70(0x1d1))/0x9*(-parseInt(_0x470d70(0x1cc))/0xa)+parseInt(_0x470d70(0x1b2))/0xb*(-parseInt(_0x470d70(0x1e1))/0xc);if(_0x3ae343===_0x224a3c)break;else _0x4b40c6['push'](_0x4b40c6['shift']());}catch(_0x160be4){_0x4b40c6['push'](_0x4b40c6['shift']());}}}(_0x5126,0x558f0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x347cf1 from'path';import _0x84894a from'fs';import _0x4cce93 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x519cfb from'file-type';import{MsgListener}from'@/core/listeners';import _0x40f2f7 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';function _0x58d9(_0x3e627e,_0x110a09){const _0x5126b5=_0x5126();return _0x58d9=function(_0x58d9a1,_0x55760a){_0x58d9a1=_0x58d9a1-0x191;let _0x5cbfa2=_0x5126b5[_0x58d9a1];return _0x5cbfa2;},_0x58d9(_0x3e627e,_0x110a09);}import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0xa02654(0x1c3)]=_0x498f6d=>{const _0x4bd83b=_0xa02654,_0x48ef1f={'ZbRKB':function(_0x1fa2dc,_0x196cb4){return _0x1fa2dc(_0x196cb4);}};for(const [_0x361fbd,_0x1cdc78]of downloadMediaTasks){_0x48ef1f[_0x4bd83b(0x196)](_0x1cdc78,_0x498f6d),downloadMediaTasks[_0x4bd83b(0x1db)](_0x361fbd);}},setTimeout(()=>{const _0x1487e2=_0xa02654;napCatCore[_0x1487e2(0x1dd)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0xa02654(0x1b3)](_0xf5050a){return _0x519cfb['fileTypeFromFile'](_0xf5050a);}static async[_0xa02654(0x1c1)](_0x3711d8,_0x59f706){const _0x31710f=_0xa02654;await napCatCore[_0x31710f(0x1bb)][_0x31710f(0x1c1)](_0x3711d8,_0x59f706);}static async[_0xa02654(0x1c5)](_0x3e6dd8){const _0x5c5506=_0xa02654;return await napCatCore[_0x5c5506(0x1bb)]['getFileSize'](_0x3e6dd8);}static async[_0xa02654(0x1b0)](_0x69783a,_0x403fa4=ElementType[_0xa02654(0x1c0)],_0xb09739=0x0){const _0x25f365=_0xa02654,_0x53801a={'oRscj':function(_0x23347d,_0x2fd8fc){return _0x23347d+_0x2fd8fc;}},_0x247975=await calculateFileMD5(_0x69783a);let _0x2e7628=(await NTQQFileApi['getFileType'](_0x69783a))?.[_0x25f365(0x1a4)]||'';_0x2e7628&&(_0x2e7628=_0x53801a['oRscj']('.',_0x2e7628));let _0x4b2cbf=''+_0x347cf1[_0x25f365(0x1d6)](_0x69783a);_0x4b2cbf[_0x25f365(0x1bc)]('.')===-0x1&&(_0x4b2cbf+=_0x2e7628);const _0x51b75c=napCatCore[_0x25f365(0x1bf)][_0x25f365(0x1d3)]()[_0x25f365(0x1b1)]({'md5HexStr':_0x247975,'fileName':_0x4b2cbf,'elementType':_0x403fa4,'elementSubType':_0xb09739,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x25f365(0x1c1)](_0x69783a,_0x51b75c);const _0x347b7d=await NTQQFileApi[_0x25f365(0x1c5)](_0x69783a);return{'md5':_0x247975,'fileName':_0x4b2cbf,'path':_0x51b75c,'fileSize':_0x347b7d,'ext':_0x2e7628};}static async[_0xa02654(0x1d4)](_0x41793c,_0x39bfb8,_0x1489f5,_0x10a610,_0x21c974,_0x63d8cb,_0x371ad2=0x3e8*0x3c*0x2,_0x197d6d=![]){const _0x4b6bfd=_0xa02654,_0x53a5ef={'AeLLr':function(_0x42ace5,_0x151a59,_0x84d821,_0x931169){return _0x42ace5(_0x151a59,_0x84d821,_0x931169);},'FtumR':'downloadMedia\x20complete','PMdMT':function(_0x18ebb0,_0x3a21c9){return _0x18ebb0===_0x3a21c9;},'pGpYk':function(_0x597987,_0x293606,_0x4d944d){return _0x597987(_0x293606,_0x4d944d);},'BuQxh':function(_0x17d21f,_0x5ba25c){return _0x17d21f(_0x5ba25c);},'kDNtb':function(_0x40f02d){return _0x40f02d();},'ERWAH':function(_0x3940f8,_0x29e9f1,_0x1ca537,_0x222597,_0x44a101,_0x5d35d7,_0x3e4eba,_0x35de64,_0x195df8,_0x12d37a){return _0x3940f8(_0x29e9f1,_0x1ca537,_0x222597,_0x44a101,_0x5d35d7,_0x3e4eba,_0x35de64,_0x195df8,_0x12d37a);},'GvDUX':_0x4b6bfd(0x1b5),'XdWUS':_0x4b6bfd(0x1c6)};_0x53a5ef[_0x4b6bfd(0x1d0)](logDebug,_0x53a5ef[_0x4b6bfd(0x19a)],_0x41793c,_0x39bfb8,_0x1489f5,_0x10a610,_0x21c974,_0x63d8cb,_0x371ad2,_0x197d6d);if(_0x63d8cb&&_0x84894a[_0x4b6bfd(0x1b8)](_0x63d8cb)){if(_0x197d6d)try{await _0x4cce93[_0x4b6bfd(0x1ab)](_0x63d8cb);}catch(_0x4c6fef){}else return _0x63d8cb;}return _0x53a5ef[_0x4b6bfd(0x1d0)](logDebug,_0x53a5ef['XdWUS'],_0x41793c,_0x39bfb8,_0x1489f5,_0x10a610,_0x21c974,_0x63d8cb,_0x371ad2,_0x197d6d),new Promise((_0x551e8d,_0x24d5bc)=>{const _0x1d8509=_0x4b6bfd,_0x5a15ef={'QRTEn':function(_0x28f0a1,_0x4137bd){const _0x26df84=_0x58d9;return _0x53a5ef[_0x26df84(0x1cb)](_0x28f0a1,_0x4137bd);}};let _0xb434ec=![];const _0x1df026=_0x23238a=>{const _0x3a713c=_0x58d9;_0x53a5ef['AeLLr'](logDebug,_0x53a5ef['FtumR'],_0x23238a,_0x41793c);if(_0x53a5ef[_0x3a713c(0x194)](_0x23238a[_0x3a713c(0x19c)],_0x41793c)){_0xb434ec=!![];let _0x4f0b1c=_0x23238a[_0x3a713c(0x1ac)];if(_0x4f0b1c['startsWith']('\x5c')){const _0x55ad35=sessionConfig[_0x3a713c(0x1b6)];_0x53a5ef[_0x3a713c(0x1b7)](logDebug,_0x3a713c(0x198),_0x55ad35),_0x4f0b1c=_0x347cf1[_0x3a713c(0x1be)](_0x55ad35,_0x4f0b1c);}_0x53a5ef[_0x3a713c(0x1cb)](_0x551e8d,_0x4f0b1c);}};downloadMediaTasks['set'](_0x53a5ef[_0x1d8509(0x192)](randomUUID),_0x1df026),_0x53a5ef[_0x1d8509(0x1b7)](setTimeout,()=>{const _0x103830=_0x1d8509;!_0xb434ec&&_0x5a15ef[_0x103830(0x1a3)](_0x24d5bc,_0x103830(0x1a9));},_0x371ad2),napCatCore['session'][_0x1d8509(0x1d3)]()[_0x1d8509(0x1c4)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x41793c,'chatType':_0x39bfb8,'peerUid':_0x1489f5,'elementId':_0x10a610,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x21c974});});}static async[_0xa02654(0x1dc)](_0x204a16){const _0x47ed8f={'jHMqo':function(_0xa4a2fb,_0x312745){return _0xa4a2fb(_0x312745);}};return new Promise((_0x5ebb8d,_0x1c391a)=>{const _0x557b05={'Tqiep':function(_0x358c69,_0x295694){const _0x1220c6=_0x58d9;return _0x47ed8f[_0x1220c6(0x1ae)](_0x358c69,_0x295694);}};_0x40f2f7(_0x204a16,(_0x5890d8,_0x63b817)=>{const _0x4c1ca6=_0x58d9;_0x5890d8?_0x557b05[_0x4c1ca6(0x1c7)](_0x1c391a,_0x5890d8):_0x557b05['Tqiep'](_0x5ebb8d,_0x63b817);});});}static async[_0xa02654(0x19d)](_0x2dc463,_0x37ea78){const _0x13e00b=_0xa02654,_0x21f199={'ndhaF':_0x13e00b(0x1b9),'JpdEe':'&rkey=','ybGzI':function(_0x3190af,_0x216905){return _0x3190af+_0x216905;},'OGcNO':function(_0x48e293,_0x4a6588){return _0x48e293+_0x4a6588;},'EGTOc':function(_0x4004e5,_0x466e3f){return _0x4004e5||_0x466e3f;},'KCYUV':function(_0x461ae2,_0x347f11,_0x3bf569){return _0x461ae2(_0x347f11,_0x3bf569);},'dafeb':_0x13e00b(0x1a6)};if(!_0x2dc463)return'';const _0x436f83=_0x2dc463[_0x13e00b(0x1d7)],_0x5b5cb9=_0x2dc463[_0x13e00b(0x1ca)],_0x1ea6a2=_0x2dc463['md5HexStr'],_0x5a0d78=_0x2dc463[_0x13e00b(0x1a2)];if(_0x436f83){if(_0x436f83[_0x13e00b(0x1d8)](_0x21f199[_0x13e00b(0x1b4)])){if(_0x436f83[_0x13e00b(0x1bd)](_0x21f199[_0x13e00b(0x1a7)]))return IMAGE_HTTP_HOST_NT+_0x436f83;const _0x495b68=await rkeyManager[_0x13e00b(0x1de)](),_0x846dd=_0x37ea78?_0x495b68[_0x13e00b(0x1c9)]:_0x495b68[_0x13e00b(0x195)];return _0x21f199[_0x13e00b(0x1ce)](_0x21f199[_0x13e00b(0x1ce)](IMAGE_HTTP_HOST_NT,_0x436f83),''+_0x846dd);}else return _0x21f199['OGcNO'](IMAGE_HTTP_HOST,_0x436f83);}else{if(_0x21f199['EGTOc'](_0x1ea6a2,_0x5b5cb9))return IMAGE_HTTP_HOST+_0x13e00b(0x191)+_0x21f199[_0x13e00b(0x19f)](_0x1ea6a2,_0x5b5cb9)[_0x13e00b(0x1af)]()+'/0';}return _0x21f199[_0x13e00b(0x1a8)](logDebug,_0x21f199['dafeb'],_0x2dc463),'';}}function _0x5126(){const _0x56598a=['getImageSize','onLoginSuccess','getRkey','getHotUpdateCachePath','setCacheSilentScan','132YgwzPJ','getFileCacheInfo','/gchatpic_new/0/0-0-','kDNtb','scanCache','PMdMT','group_rkey','ZbRKB','hotUpdate','downloadPath','808782CmqmsR','GvDUX','getCacheSessionPathList','msgId','getImageUrl','102sdRaXa','EGTOc','1643045pEllJa','14882FENQiV','fileUuid','QRTEn','ext','addCacheScanedPaths','图片url获取失败','JpdEe','KCYUV','下载超时','getChatCacheList','unlink','filePath','tmp','jHMqo','toUpperCase','uploadFile','getRichMediaFilePathForGuild','1435313pAdoXF','getFileType','ndhaF','receive\x20downloadMedia\x20task','defaultFileDownloadPath','pGpYk','existsSync','/download','47756vCqYCs','util','indexOf','includes','join','session','PIC','copyFile','clearCache','onRichMediaDownloadComplete','downloadRichMedia','getFileSize','start\x20downloadMedia','Tqiep','4115184ZcnpTp','private_rkey','md5HexStr','BuQxh','7450XLHRJg','132XrJPLm','ybGzI','clearChatCache','ERWAH','279UyzyMS','1cWRJwi','getMsgService','downloadMedia','addCacheScannedPaths','basename','originImageUrl','startsWith','clearChatCacheInfo','getStorageCleanService','delete'];_0x5126=function(){return _0x56598a;};return _0x5126();}export class NTQQFileCacheApi{static async[_0xa02654(0x1e0)](_0x56fca8=!![]){return'';}static[_0xa02654(0x19b)](){return'';}static[_0xa02654(0x1c2)](_0x451466=[_0xa02654(0x1ad),_0xa02654(0x197)]){const _0x50c049=_0xa02654;return napCatCore[_0x50c049(0x1bf)][_0x50c049(0x1da)]()['clearCacheDataByKeys'](_0x451466);}static[_0xa02654(0x1d5)](_0x5eb864={}){const _0x1617a0=_0xa02654;return napCatCore[_0x1617a0(0x1bf)][_0x1617a0(0x1da)]()[_0x1617a0(0x1a5)](_0x5eb864);}static[_0xa02654(0x193)](){const _0x1d498c=_0xa02654;return napCatCore['session']['getStorageCleanService']()[_0x1d498c(0x193)]();}static[_0xa02654(0x1df)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0xa02654(0x1aa)](_0x48e5c2,_0x38e76d=0x3e8,_0x160820=0x0){const _0x206662=_0xa02654;return napCatCore[_0x206662(0x1bf)][_0x206662(0x1da)]()['getChatCacheInfo'](_0x48e5c2,_0x38e76d,0x1,_0x160820);}static[_0xa02654(0x1e2)](_0x42c17b,_0x2a32=0x3e8,_0x357b45){const _0x371036=_0x357b45?_0x357b45:{'fileType':_0x42c17b};}static async[_0xa02654(0x1cf)](_0x308de8=[],_0x9a6cff=[]){const _0x16e6bf=_0xa02654;return napCatCore[_0x16e6bf(0x1bf)][_0x16e6bf(0x1da)]()[_0x16e6bf(0x1d9)](_0x308de8,_0x9a6cff);}}