const _0x4eb1a2=_0x189f;(function(_0x4250eb,_0x5ee3b1){const _0xe56991=_0x189f,_0x4747d6=_0x4250eb();while(!![]){try{const _0x7ef64a=-parseInt(_0xe56991(0x158))/0x1*(parseInt(_0xe56991(0x169))/0x2)+-parseInt(_0xe56991(0x130))/0x3+parseInt(_0xe56991(0x135))/0x4+parseInt(_0xe56991(0x168))/0x5*(-parseInt(_0xe56991(0x13a))/0x6)+-parseInt(_0xe56991(0x13c))/0x7+-parseInt(_0xe56991(0x131))/0x8*(parseInt(_0xe56991(0x12e))/0x9)+parseInt(_0xe56991(0x154))/0xa*(parseInt(_0xe56991(0x153))/0xb);if(_0x7ef64a===_0x5ee3b1)break;else _0x4747d6['push'](_0x4747d6['shift']());}catch(_0x3f92f8){_0x4747d6['push'](_0x4747d6['shift']());}}}(_0x506c,0x85c1c));function _0x189f(_0x415c6c,_0x332a7f){const _0x506ce3=_0x506c();return _0x189f=function(_0x189fea,_0x2eaeb7){_0x189fea=_0x189fea-0x12e;let _0x375222=_0x506ce3[_0x189fea];return _0x375222;},_0x189f(_0x415c6c,_0x332a7f);}import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x2c90a5 from'path';import _0x40a171 from'fs';function _0x506c(){const _0x52f1b7=['getImageSize','1524728spPeoc','delete','kQmaw','图片url获取失败','getFileCacheInfo','30nZXaha','group_rkey','7641900MFQNGT','YLLdo','getRkey','includes','ikOox','onLoginSuccess','existsSync','getRichMediaFilePathForGuild','getStorageCleanService','hocZg','startsWith','getFileType','getMsgService','lkePp','unlink','ESSEB','addListener','hotUpdate','addCacheScanedPaths','util','copyFile','basename','set','2812139nIBTpa','140GkJPPo','md5HexStr','bhFmL','defaultFileDownloadPath','38102WRTVLv','PIC','getDesktopTmpPath','clearCacheDataByKeys','addCacheScannedPaths','toUpperCase','getImageUrl','aWszr','QprDV','clearChatCache','onRichMediaDownloadComplete','tmp','下载超时','sNvCN','downloadRichMedia','scanCache','549410cOisyW','22JnyWVR','&rkey=','getChatCacheList','filePath','btiuq','getFileSize','jYZcN','SEOay','session','HJTQe','getChatCacheInfo','9NmdAGt','TTHZc','1138992ksfZzG','7780032stNFOK','private_rkey','uploadFile'];_0x506c=function(){return _0x52f1b7;};return _0x506c();}import _0x37fd09 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x5ecb3e from'file-type';import{MsgListener}from'@/core/listeners';import _0x2d2aeb from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x4eb1a2(0x162)]=_0x4ebc79=>{const _0x560b6a=_0x4eb1a2,_0x2991f4={'ikOox':function(_0x1391c7,_0x48e943){return _0x1391c7(_0x48e943);}};for(const [_0x10b278,_0x32ae3d]of downloadMediaTasks){_0x2991f4[_0x560b6a(0x140)](_0x32ae3d,_0x4ebc79),downloadMediaTasks[_0x560b6a(0x136)](_0x10b278);}},setTimeout(()=>{const _0x39a629=_0x4eb1a2;napCatCore[_0x39a629(0x141)](()=>{const _0x5bfe59=_0x39a629;napCatCore[_0x5bfe59(0x14c)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x4eb1a2(0x147)](_0x890314){return _0x5ecb3e['fileTypeFromFile'](_0x890314);}static async[_0x4eb1a2(0x150)](_0x3a6890,_0xc39f6){const _0x2133a0=_0x4eb1a2;await napCatCore[_0x2133a0(0x14f)][_0x2133a0(0x150)](_0x3a6890,_0xc39f6);}static async[_0x4eb1a2(0x16e)](_0x491fe7){const _0x568352=_0x4eb1a2;return await napCatCore[_0x568352(0x14f)]['getFileSize'](_0x491fe7);}static async[_0x4eb1a2(0x133)](_0x451829,_0x3c3dda=ElementType[_0x4eb1a2(0x159)],_0x4ff69f=0x0){const _0x51f137=_0x4eb1a2,_0x17f68c={'KIwdv':function(_0x28f356,_0x324c35){return _0x28f356(_0x324c35);},'sNvCN':function(_0x1a0613,_0x1b36bb){return _0x1a0613+_0x1b36bb;},'kQmaw':function(_0x21b5a8,_0x17c7c5){return _0x21b5a8===_0x17c7c5;}},_0x3957a0=await _0x17f68c['KIwdv'](calculateFileMD5,_0x451829);let _0xd075cd=(await NTQQFileApi[_0x51f137(0x147)](_0x451829))?.['ext']||'';_0xd075cd&&(_0xd075cd=_0x17f68c[_0x51f137(0x165)]('.',_0xd075cd));let _0x350c86=''+_0x2c90a5[_0x51f137(0x151)](_0x451829);_0x17f68c[_0x51f137(0x137)](_0x350c86['indexOf']('.'),-0x1)&&(_0x350c86+=_0xd075cd);const _0x43b3b4=napCatCore[_0x51f137(0x171)][_0x51f137(0x148)]()[_0x51f137(0x143)]({'md5HexStr':_0x3957a0,'fileName':_0x350c86,'elementType':_0x3c3dda,'elementSubType':_0x4ff69f,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x51f137(0x150)](_0x451829,_0x43b3b4);const _0x1e7bf9=await NTQQFileApi[_0x51f137(0x16e)](_0x451829);return{'md5':_0x3957a0,'fileName':_0x350c86,'path':_0x43b3b4,'fileSize':_0x1e7bf9,'ext':_0xd075cd};}static async['downloadMedia'](_0x3cf730,_0x7c919b,_0x4d4a2a,_0x21fb6e,_0x17ec68,_0x2d1d43,_0x1fca83=0x3e8*0x3c*0x2,_0x139f90=![]){const _0x3332f3=_0x4eb1a2,_0x46fe5a={'ndtKJ':function(_0x2af2fe,_0x5316e1){return _0x2af2fe===_0x5316e1;},'HJTQe':function(_0x481f2e,_0x5dc937){return _0x481f2e(_0x5dc937);},'TOAzE':function(_0x2d70bd,_0x47c111){return _0x2d70bd(_0x47c111);},'hocZg':_0x3332f3(0x164),'QprDV':function(_0x35a4f6){return _0x35a4f6();},'aWszr':function(_0x141570,_0x4fc16b,_0x36171d){return _0x141570(_0x4fc16b,_0x36171d);}};if(_0x2d1d43&&_0x40a171[_0x3332f3(0x142)](_0x2d1d43)){if(_0x139f90)try{await _0x37fd09[_0x3332f3(0x14a)](_0x2d1d43);}catch(_0x433c53){}else return _0x2d1d43;}return new Promise((_0x38e6e2,_0x47a8a8)=>{const _0x2131e3=_0x3332f3,_0x3c3435={'lkePp':function(_0x1eb89d,_0x88735c){return _0x46fe5a['TOAzE'](_0x1eb89d,_0x88735c);},'tWgAC':_0x46fe5a[_0x2131e3(0x145)]};let _0x32b3fd=![];const _0x41b971=_0x14221a=>{const _0x52dd6a=_0x2131e3;if(_0x46fe5a['ndtKJ'](_0x14221a['msgId'],_0x3cf730)){_0x32b3fd=!![];let _0x29ed29=_0x14221a[_0x52dd6a(0x16c)];if(_0x29ed29[_0x52dd6a(0x146)]('\x5c')){const _0x4c01e9=sessionConfig[_0x52dd6a(0x157)];_0x29ed29=_0x2c90a5['join'](_0x4c01e9,_0x29ed29);}_0x46fe5a[_0x52dd6a(0x172)](_0x38e6e2,_0x29ed29);}};downloadMediaTasks[_0x2131e3(0x152)](_0x46fe5a[_0x2131e3(0x160)](randomUUID),_0x41b971),_0x46fe5a[_0x2131e3(0x15f)](setTimeout,()=>{const _0x4f25aa=_0x2131e3;!_0x32b3fd&&_0x3c3435[_0x4f25aa(0x149)](_0x47a8a8,_0x3c3435['tWgAC']);},_0x1fca83),napCatCore[_0x2131e3(0x171)][_0x2131e3(0x148)]()[_0x2131e3(0x166)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3cf730,'chatType':_0x7c919b,'peerUid':_0x4d4a2a,'elementId':_0x21fb6e,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x17ec68});});}static async[_0x4eb1a2(0x134)](_0x390f5b){const _0xb412c3={'TTHZc':function(_0x5822fb,_0x95e10a){return _0x5822fb(_0x95e10a);},'YLLdo':function(_0x2010cc,_0x107317,_0xd64904){return _0x2010cc(_0x107317,_0xd64904);}};return new Promise((_0x1b1f41,_0x343c61)=>{const _0x2962bf=_0x189f,_0x362c68={'btiuq':function(_0x105276,_0x109aa4){const _0x3ff5c6=_0x189f;return _0xb412c3[_0x3ff5c6(0x12f)](_0x105276,_0x109aa4);}};_0xb412c3[_0x2962bf(0x13d)](_0x2d2aeb,_0x390f5b,(_0x52635f,_0x67cbe)=>{const _0x73e221=_0x2962bf;_0x52635f?_0x362c68[_0x73e221(0x16d)](_0x343c61,_0x52635f):_0x362c68[_0x73e221(0x16d)](_0x1b1f41,_0x67cbe);});});}static async[_0x4eb1a2(0x15e)](_0x13181f,_0x1f6f46){const _0x2b30d7=_0x4eb1a2,_0x4d1540={'jYZcN':'/download','bhFmL':_0x2b30d7(0x16a),'GJqSt':function(_0x40f448,_0x210510){return _0x40f448+_0x210510;},'ESSEB':function(_0x3624c9,_0x274b4d){return _0x3624c9||_0x274b4d;},'SEOay':function(_0x3a58d6,_0x245682,_0x16c52f){return _0x3a58d6(_0x245682,_0x16c52f);},'pRlVJ':_0x2b30d7(0x138)};if(!_0x13181f)return'';const _0x1683ab=_0x13181f['originImageUrl'],_0x5edbea=_0x13181f[_0x2b30d7(0x155)],_0x587907=_0x13181f[_0x2b30d7(0x155)],_0x3d8168=_0x13181f['fileUuid'];if(_0x1683ab){if(_0x1683ab[_0x2b30d7(0x146)](_0x4d1540[_0x2b30d7(0x16f)])){if(_0x1683ab[_0x2b30d7(0x13f)](_0x4d1540[_0x2b30d7(0x156)]))return IMAGE_HTTP_HOST_NT+_0x1683ab;const _0x2872d7=await rkeyManager[_0x2b30d7(0x13e)](),_0x4c644b=_0x1f6f46?_0x2872d7[_0x2b30d7(0x132)]:_0x2872d7[_0x2b30d7(0x13b)];return _0x4d1540['GJqSt'](IMAGE_HTTP_HOST_NT,_0x1683ab)+(''+_0x4c644b);}else return IMAGE_HTTP_HOST+_0x1683ab;}else{if(_0x587907||_0x5edbea)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x4d1540[_0x2b30d7(0x14b)](_0x587907,_0x5edbea)[_0x2b30d7(0x15d)]()+'/0';}return _0x4d1540[_0x2b30d7(0x170)](logDebug,_0x4d1540['pRlVJ'],_0x13181f),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0xafe12e=!![]){return'';}static['getCacheSessionPathList'](){return'';}static['clearCache'](_0x1c20b8=[_0x4eb1a2(0x163),_0x4eb1a2(0x14d)]){const _0x2d3040=_0x4eb1a2;return napCatCore[_0x2d3040(0x171)][_0x2d3040(0x144)]()[_0x2d3040(0x15b)](_0x1c20b8);}static[_0x4eb1a2(0x15c)](_0x477049={}){const _0x449e3e=_0x4eb1a2;return napCatCore[_0x449e3e(0x171)][_0x449e3e(0x144)]()[_0x449e3e(0x14e)](_0x477049);}static[_0x4eb1a2(0x167)](){const _0x2a9954=_0x4eb1a2;return napCatCore[_0x2a9954(0x171)][_0x2a9954(0x144)]()['scanCache']();}static['getHotUpdateCachePath'](){return'';}static[_0x4eb1a2(0x15a)](){return'';}static[_0x4eb1a2(0x16b)](_0x5c68d9,_0x3f9343=0x3e8,_0x91afb7=0x0){const _0x1f7f2e=_0x4eb1a2;return napCatCore['session'][_0x1f7f2e(0x144)]()[_0x1f7f2e(0x173)](_0x5c68d9,_0x3f9343,0x1,_0x91afb7);}static[_0x4eb1a2(0x139)](_0x4ec44d,_0x81e9e7=0x3e8,_0x33e247){const _0x33c7e3=_0x33e247?_0x33e247:{'fileType':_0x4ec44d};}static async[_0x4eb1a2(0x161)](_0x2a307e=[],_0x151bf9=[]){return napCatCore['session']['getStorageCleanService']()['clearChatCacheInfo'](_0x2a307e,_0x151bf9);}}