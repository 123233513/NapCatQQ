function _0x43fb(){const _0x12ce2c=['99442KSmgIZ','find','onLoginSuccess','defaultFileDownloadPath','8377659BtJufz','JnLNW','getStorageCleanService','1012066JisXnL','5099635UPrTwx','toUpperCase','141554bgFLqp','copyFile','set','SbDon','cUpMQ','2704WefxBg','sXBsA','getRkey','getHotUpdateCachePath','session','downloadMedia\x20complete','NTpBO','fileTypeFromFile','328DGnPba','HQQrF','clearCache','downloadMedia','getFileCacheInfo','Odyki','getFileSize','emAtq','10HvZobg','2cNRPkv','setCacheSilentScan','start\x20downloadMedia','jdNIG','addCacheScannedPaths','图片url获取失败','6KSzwgn','ncJpW','unlink','CHEUy','getDesktopTmpPath','join','ilGJT','getImageSize','delete','clearChatCacheInfo','picElement','wFZce','private_rkey','364pREvBE','onRichMediaDownloadComplete','mQIRn','ZoYvD','12tqmbZN','util','getCacheSessionPathList','&rkey=','clearChatCache','dFiea','startsWith','md5HexStr','5563327ghiAjD','addListener','msgId','getMsgService','ZmfBv','addCacheScanedPaths','nNGxo','getChatCacheList','PIC','17478kuNjAa','tmp','receive\x20downloadMedia\x20task','includes','scanCache','eQxlk','getImageUrl','getChatCacheInfo'];_0x43fb=function(){return _0x12ce2c;};return _0x43fb();}const _0x362342=_0x5ead;(function(_0x357cf1,_0x3803a9){const _0x1a8302=_0x5ead,_0x5ed56c=_0x357cf1();while(!![]){try{const _0x4ba01e=parseInt(_0x1a8302(0x111))/0x1*(parseInt(_0x1a8302(0xf8))/0x2)+parseInt(_0x1a8302(0xe9))/0x3*(parseInt(_0x1a8302(0x124))/0x4)+-parseInt(_0x1a8302(0xf9))/0x5*(parseInt(_0x1a8302(0x117))/0x6)+parseInt(_0x1a8302(0xfb))/0x7*(-parseInt(_0x1a8302(0x108))/0x8)+parseInt(_0x1a8302(0xf5))/0x9*(-parseInt(_0x1a8302(0x110))/0xa)+parseInt(_0x1a8302(0xe0))/0xb*(parseInt(_0x1a8302(0x128))/0xc)+parseInt(_0x1a8302(0x100))/0xd*(parseInt(_0x1a8302(0xf1))/0xe);if(_0x4ba01e===_0x3803a9)break;else _0x5ed56c['push'](_0x5ed56c['shift']());}catch(_0x488f2d){_0x5ed56c['push'](_0x5ed56c['shift']());}}}(_0x43fb,0xb603d));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x5ead(_0x32f238,_0x5a60ab){const _0x43fbaf=_0x43fb();return _0x5ead=function(_0x5ead43,_0x189b43){_0x5ead43=_0x5ead43-0xde;let _0xe6cff9=_0x43fbaf[_0x5ead43];return _0xe6cff9;},_0x5ead(_0x32f238,_0x5a60ab);}import _0x4054dc from'path';import _0x3c12d4 from'fs';import _0xbc9984 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x47f3ca from'file-type';import{MsgListener}from'@/core/listeners';import _0x2f230f from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{rkeyManager}from'../utils/rkey';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x362342(0x125)]=_0x35efa3=>{const _0x23883f=_0x362342,_0x3934a2={'cUpMQ':function(_0x12c6cf,_0x52662a){return _0x12c6cf(_0x52662a);}};for(const [_0xb40197,_0xfe2dc8]of downloadMediaTasks){_0x3934a2[_0x23883f(0xff)](_0xfe2dc8,_0x35efa3),downloadMediaTasks[_0x23883f(0x11f)](_0xb40197);}},setTimeout(()=>{const _0xfe61c=_0x362342;napCatCore[_0xfe61c(0xf3)](()=>{const _0x7744d0=_0xfe61c;napCatCore[_0x7744d0(0xe1)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x341fbe){const _0x1d9ac4=_0x362342;return _0x47f3ca[_0x1d9ac4(0x107)](_0x341fbe);}static async[_0x362342(0xfc)](_0x3573cb,_0x363987){const _0x544436=_0x362342;await napCatCore[_0x544436(0x129)]['copyFile'](_0x3573cb,_0x363987);}static async['getFileSize'](_0x1e0b61){const _0x4e0db6=_0x362342;return await napCatCore['util'][_0x4e0db6(0x10e)](_0x1e0b61);}static async['uploadFile'](_0x52b6a7,_0x1d7231=ElementType[_0x362342(0xe8)],_0x308df1=0x0){const _0x378170=_0x362342,_0x431fc6={'HQQrF':function(_0x5593c0,_0x176fe6){return _0x5593c0(_0x176fe6);},'CHEUy':function(_0x3df56e,_0x3f287){return _0x3df56e===_0x3f287;}},_0x151391=await _0x431fc6[_0x378170(0x109)](calculateFileMD5,_0x52b6a7);let _0x416116=(await NTQQFileApi['getFileType'](_0x52b6a7))?.['ext']||'';_0x416116&&(_0x416116='.'+_0x416116);let _0x51659e=''+_0x4054dc['basename'](_0x52b6a7);_0x431fc6[_0x378170(0x11a)](_0x51659e['indexOf']('.'),-0x1)&&(_0x51659e+=_0x416116);const _0x15b67a=napCatCore[_0x378170(0x104)][_0x378170(0xe3)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x151391,'fileName':_0x51659e,'elementType':_0x1d7231,'elementSubType':_0x308df1,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x52b6a7,_0x15b67a);const _0x43513e=await NTQQFileApi[_0x378170(0x10e)](_0x52b6a7);return{'md5':_0x151391,'fileName':_0x51659e,'path':_0x15b67a,'fileSize':_0x43513e,'ext':_0x416116};}static async[_0x362342(0x10b)](_0x158b73,_0x466d5c,_0x4c4873,_0x272da4,_0x336227,_0x5dc67a,_0x4303a0=0x3e8*0x3c*0x2,_0x3bab10=![]){const _0x54386f=_0x362342,_0x12ee52={'Odyki':function(_0x583047,_0x49c170){return _0x583047(_0x49c170);},'emAtq':_0x54386f(0x105),'ncJpW':function(_0x1b2835){return _0x1b2835();},'eQxlk':function(_0x3157c0,_0x4b0ad9,_0x4bb79c){return _0x3157c0(_0x4b0ad9,_0x4bb79c);},'RccWH':_0x54386f(0xeb),'NTpBO':_0x54386f(0x113)};logDebug(_0x12ee52['RccWH'],_0x158b73,_0x466d5c,_0x4c4873,_0x272da4,_0x336227,_0x5dc67a,_0x4303a0,_0x3bab10);if(_0x5dc67a&&_0x3c12d4['existsSync'](_0x5dc67a)){if(_0x3bab10)try{await _0xbc9984[_0x54386f(0x119)](_0x5dc67a);}catch(_0x586202){}else return _0x5dc67a;}return logDebug(_0x12ee52[_0x54386f(0x106)],_0x158b73,_0x466d5c,_0x4c4873,_0x272da4,_0x336227,_0x5dc67a,_0x4303a0,_0x3bab10),new Promise((_0x44e4f5,_0x18b2e4)=>{const _0x19084c=_0x54386f,_0x159d36={'jdNIG':function(_0x417a0f,_0x2c35ee,_0x86b917,_0x31f090){return _0x417a0f(_0x2c35ee,_0x86b917,_0x31f090);},'McaGN':_0x12ee52[_0x19084c(0x10f)],'SbDon':function(_0x50f08a,_0x319e88){return _0x50f08a===_0x319e88;},'jDvId':function(_0x1a82ce,_0x387cc3,_0xa42e23){return _0x1a82ce(_0x387cc3,_0xa42e23);},'sXBsA':'downloadPath'};let _0x4ead1f=![];const _0x3368fb=_0x14a865=>{const _0x2ac135=_0x19084c;_0x159d36[_0x2ac135(0x114)](logDebug,_0x159d36['McaGN'],_0x14a865,_0x158b73);if(_0x159d36[_0x2ac135(0xfe)](_0x14a865[_0x2ac135(0xe2)],_0x158b73)){_0x4ead1f=!![];let _0x49dcff=_0x14a865['filePath'];if(_0x49dcff[_0x2ac135(0xde)]('\x5c')){const _0x3cdd87=sessionConfig[_0x2ac135(0xf4)];_0x159d36['jDvId'](logDebug,_0x159d36[_0x2ac135(0x101)],_0x3cdd87),_0x49dcff=_0x4054dc[_0x2ac135(0x11c)](_0x3cdd87,_0x49dcff);}_0x44e4f5(_0x49dcff);}};downloadMediaTasks[_0x19084c(0xfd)](_0x12ee52[_0x19084c(0x118)](randomUUID),_0x3368fb),_0x12ee52[_0x19084c(0xee)](setTimeout,()=>{const _0xcf422b=_0x19084c;!_0x4ead1f&&_0x12ee52[_0xcf422b(0x10d)](_0x18b2e4,'下载超时');},_0x4303a0),napCatCore[_0x19084c(0x104)][_0x19084c(0xe3)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x158b73,'chatType':_0x466d5c,'peerUid':_0x4c4873,'elementId':_0x272da4,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x336227});});}static async[_0x362342(0x11e)](_0x3dc0df){const _0x3ca181={'ilGJT':function(_0xd218d,_0x159e3f){return _0xd218d(_0x159e3f);}};return new Promise((_0x2ae748,_0x11b876)=>{const _0x1d44b6={'nNGxo':function(_0x38b18c,_0x1f8334){const _0x3411c3=_0x5ead;return _0x3ca181[_0x3411c3(0x11d)](_0x38b18c,_0x1f8334);}};_0x2f230f(_0x3dc0df,(_0x3e1b57,_0x55f587)=>{const _0x23f5c2=_0x5ead;_0x3e1b57?_0x1d44b6['nNGxo'](_0x11b876,_0x3e1b57):_0x1d44b6[_0x23f5c2(0xe6)](_0x2ae748,_0x55f587);});});}static async[_0x362342(0xef)](_0x54e14a){const _0x530358=_0x362342,_0x324d7f={'mQIRn':function(_0x5b6ee9,_0x446344){return _0x5b6ee9!==_0x446344;},'ZoYvD':'/download','PtUSU':_0x530358(0x12b),'wFZce':function(_0x587a0c,_0x3fa55f){return _0x587a0c+_0x3fa55f;},'irKoj':function(_0x786912,_0x41cadb){return _0x786912+_0x41cadb;},'nGwnn':function(_0x3b8e39,_0x143aa1){return _0x3b8e39||_0x143aa1;},'dFiea':function(_0x3f9f02,_0x3f57a6){return _0x3f9f02||_0x3f57a6;},'JnLNW':function(_0x9542f6,_0x39e44d,_0x18a216){return _0x9542f6(_0x39e44d,_0x18a216);},'ZmfBv':_0x530358(0x116)},_0x174a6e=_0x324d7f[_0x530358(0x126)](_0x54e14a['chatType'],ChatType['group']),_0x3c76e9=_0x54e14a['elements'][_0x530358(0xf2)](_0x45f5dc=>!!_0x45f5dc[_0x530358(0x121)]);if(!_0x3c76e9)return'';const _0x239c54=_0x3c76e9[_0x530358(0x121)]['originImageUrl'],_0x372177=_0x3c76e9[_0x530358(0x121)][_0x530358(0xdf)],_0x4a4d91=_0x3c76e9[_0x530358(0x121)][_0x530358(0xdf)],_0x33ef8c=_0x3c76e9[_0x530358(0x121)]['fileUuid'];if(_0x239c54){if(_0x239c54[_0x530358(0xde)](_0x324d7f[_0x530358(0x127)])){if(_0x239c54[_0x530358(0xec)](_0x324d7f['PtUSU']))return _0x324d7f[_0x530358(0x122)](IMAGE_HTTP_HOST_NT,_0x239c54);const _0x581c54=await rkeyManager[_0x530358(0x102)](),_0x5ae694=_0x174a6e?_0x581c54[_0x530358(0x123)]:_0x581c54['group_rkey'];return _0x324d7f['irKoj'](IMAGE_HTTP_HOST_NT+_0x239c54,''+_0x5ae694);}else return IMAGE_HTTP_HOST+_0x239c54;}else{if(_0x324d7f['nGwnn'](_0x4a4d91,_0x372177))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x324d7f[_0x530358(0x12d)](_0x4a4d91,_0x372177)[_0x530358(0xfa)]()+'/0';}return _0x324d7f[_0x530358(0xf6)](logDebug,_0x324d7f[_0x530358(0xe4)],_0x54e14a),'';}}export class NTQQFileCacheApi{static async[_0x362342(0x112)](_0x54076b=!![]){return'';}static[_0x362342(0x12a)](){return'';}static[_0x362342(0x10a)](_0x53db59=[_0x362342(0xea),'hotUpdate']){const _0x54f901=_0x362342;return napCatCore['session'][_0x54f901(0xf7)]()['clearCacheDataByKeys'](_0x53db59);}static[_0x362342(0x115)](_0x3b9fac={}){const _0x3bb59a=_0x362342;return napCatCore[_0x3bb59a(0x104)][_0x3bb59a(0xf7)]()[_0x3bb59a(0xe5)](_0x3b9fac);}static[_0x362342(0xed)](){const _0x1e4892=_0x362342;return napCatCore[_0x1e4892(0x104)][_0x1e4892(0xf7)]()[_0x1e4892(0xed)]();}static[_0x362342(0x103)](){return'';}static[_0x362342(0x11b)](){return'';}static[_0x362342(0xe7)](_0x53ae95,_0x6cafa2=0x3e8,_0x5f9045=0x0){const _0x1dd613=_0x362342;return napCatCore['session']['getStorageCleanService']()[_0x1dd613(0xf0)](_0x53ae95,_0x6cafa2,0x1,_0x5f9045);}static[_0x362342(0x10c)](_0x349f6f,_0x89a52=0x3e8,_0x31c03d){const _0x3abe1c=_0x31c03d?_0x31c03d:{'fileType':_0x349f6f};}static async[_0x362342(0x12c)](_0x2c79f9=[],_0xb464f5=[]){const _0x4aca8f=_0x362342;return napCatCore[_0x4aca8f(0x104)][_0x4aca8f(0xf7)]()[_0x4aca8f(0x120)](_0x2c79f9,_0xb464f5);}}