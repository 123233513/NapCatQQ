const _0x47a949=_0x7ed2;(function(_0x2fdb6f,_0xd92578){const _0xa12308=_0x7ed2,_0x20e39d=_0x2fdb6f();while(!![]){try{const _0x44b67c=parseInt(_0xa12308(0x196))/0x1+parseInt(_0xa12308(0x187))/0x2+parseInt(_0xa12308(0x1c7))/0x3*(-parseInt(_0xa12308(0x1a2))/0x4)+-parseInt(_0xa12308(0x18d))/0x5+-parseInt(_0xa12308(0x199))/0x6+parseInt(_0xa12308(0x1a1))/0x7*(-parseInt(_0xa12308(0x1a6))/0x8)+parseInt(_0xa12308(0x194))/0x9*(parseInt(_0xa12308(0x169))/0xa);if(_0x44b67c===_0xd92578)break;else _0x20e39d['push'](_0x20e39d['shift']());}catch(_0xecefea){_0x20e39d['push'](_0x20e39d['shift']());}}}(_0x5982,0x89185));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0xc2edc3 from'path';import _0xba8c37 from'fs';import _0x4b3589 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x2fb63a from'file-type';import{MsgListener}from'@/core/listeners';import _0x36f102 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';function _0x7ed2(_0x3831d8,_0x38d869){const _0x598264=_0x5982();return _0x7ed2=function(_0x7ed292,_0x13c146){_0x7ed292=_0x7ed292-0x15f;let _0xebf467=_0x598264[_0x7ed292];return _0xebf467;},_0x7ed2(_0x3831d8,_0x38d869);}import _0x2619c1 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;function _0x5982(){const _0x238712=['getCacheSessionPathList','clearCacheDataByKeys','addListener','fileUuid','获取图片rkey...','33kXdZyK','downloadMedia','EUfiV','picElement','hotUpdate','fileTypeFromFile','VYckU','ztYzB','basename','lOLUY','ext','onRichMediaDownloadComplete','elementId','getChatCacheList','getHotUpdateCachePath','sourcePath','set','10gfXEdB','unlink','vzHUG','loejP','copyFile','uploadFile','defaultFileDownloadPath','clearCache','md5HexStr','PtnbH','检查rkey是否有效','originImageUrl','startsWith','catch','getFileType','peerUid','gUxcB','existsSync','elements','DxLeq','downloadRichMedia','图片rkey有效','lqmEx','scanCache','jWRpA','delete','qQxdu','开始调用moeHook获取rkey','addTask','图片rkey获取失败','258290CVVUFX','tfVEC','PIC','RUKCD','get','addCacheScanedPaths','4952580wpKTzL','downloadPath','Rlosc','then','tmp','session','MuIJz','29152593keVVVA','sFuLc','148452ycFMEd','TRNMT','xKXic','3425754ixVYrv','getRKey','chatType','hookApi\x20is\x20not\x20available','now','pfdeK','getImageSize','zgknL','7226933JEtBFc','131396RnbsYS','includes','util','filePath','8gUAlcl','&rkey=','OYDqX','toUpperCase','statusCode','getFileSize','clearChatCacheInfo','ssHSv','getRichMediaFilePathForGuild','yzbxP','pDTOK','group','getStorageCleanService','LMCeS','getMsgService','XJcdg','/download','irROC','/gchatpic_new/0/0-0-','addCacheScannedPaths','图片url获取失败','start\x20downloadMedia','mmnKw','aejDT','WzntC','join','receive\x20downloadMedia\x20task','图片rkey有误'];_0x5982=function(){return _0x238712;};return _0x5982();}const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x47a949(0x163)]=_0x10463a=>{const _0x2bfc89=_0x47a949,_0x22ae12={'jWRpA':function(_0x5c9298,_0x31138a){return _0x5c9298(_0x31138a);}};for(const [_0x17794a,_0x20cb90]of downloadMediaTasks){_0x22ae12[_0x2bfc89(0x181)](_0x20cb90,_0x10463a),downloadMediaTasks[_0x2bfc89(0x182)](_0x17794a);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x38ad66=_0x7ed2;napCatCore[_0x38ad66(0x1c4)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x47a949(0x177)](_0x54e5c6){const _0x25e805=_0x47a949;return _0x2fb63a[_0x25e805(0x1cc)](_0x54e5c6);}static async[_0x47a949(0x16d)](_0x4d07ed,_0x2a668c){const _0x2c7569=_0x47a949;await napCatCore[_0x2c7569(0x1a4)][_0x2c7569(0x16d)](_0x4d07ed,_0x2a668c);}static async[_0x47a949(0x1ab)](_0x2bbacd){const _0x3de482=_0x47a949;return await napCatCore[_0x3de482(0x1a4)][_0x3de482(0x1ab)](_0x2bbacd);}static async[_0x47a949(0x16e)](_0xdf5263,_0x2abf0d=ElementType[_0x47a949(0x189)],_0x1814eb=0x0){const _0x20afde=_0x47a949,_0x5938b6={'VzcCt':function(_0x5c89b9,_0x39a0d1){return _0x5c89b9===_0x39a0d1;}},_0x5d911f=await calculateFileMD5(_0xdf5263);let _0xb4a86f=(await NTQQFileApi[_0x20afde(0x177)](_0xdf5263))?.[_0x20afde(0x162)]||'';_0xb4a86f&&(_0xb4a86f='.'+_0xb4a86f);let _0x5c4dd1=''+_0xc2edc3[_0x20afde(0x160)](_0xdf5263);_0x5938b6['VzcCt'](_0x5c4dd1['indexOf']('.'),-0x1)&&(_0x5c4dd1+=_0xb4a86f);const _0x354414=napCatCore[_0x20afde(0x192)][_0x20afde(0x1b4)]()[_0x20afde(0x1ae)]({'md5HexStr':_0x5d911f,'fileName':_0x5c4dd1,'elementType':_0x2abf0d,'elementSubType':_0x1814eb,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0xdf5263,_0x354414);const _0x50ff78=await NTQQFileApi[_0x20afde(0x1ab)](_0xdf5263);return{'md5':_0x5d911f,'fileName':_0x5c4dd1,'path':_0x354414,'fileSize':_0x50ff78,'ext':_0xb4a86f};}static async[_0x47a949(0x1c8)](_0x3d788f,_0x3c510e,_0x408771,_0x5ebe9c,_0x379cb8,_0x3f4b20,_0x2e9010=0x3e8*0x3c*0x2,_0x259a6f=![]){const _0x4937cd=_0x47a949,_0x1de137={'aejDT':function(_0x3d8def,_0x2df3fc,_0x14ca5e,_0x374ac9){return _0x3d8def(_0x2df3fc,_0x14ca5e,_0x374ac9);},'ssHSv':'downloadMedia\x20complete','Rlosc':function(_0x57ddf6,_0x32d76a){return _0x57ddf6===_0x32d76a;},'OYDqX':function(_0x16c2a0,_0x2e24cd,_0x520ac3){return _0x16c2a0(_0x2e24cd,_0x520ac3);},'gUxcB':function(_0x24022d){return _0x24022d();},'mmnKw':function(_0x10ec65,_0x3e3a30,_0x393b88,_0x4a105d,_0x2e04dd,_0x142daa,_0x473387,_0x1b54e5,_0x2d6cf8,_0x19253f){return _0x10ec65(_0x3e3a30,_0x393b88,_0x4a105d,_0x2e04dd,_0x142daa,_0x473387,_0x1b54e5,_0x2d6cf8,_0x19253f);},'VBHqF':_0x4937cd(0x1bb)};_0x1de137[_0x4937cd(0x1bc)](logDebug,_0x4937cd(0x1c0),_0x3d788f,_0x3c510e,_0x408771,_0x5ebe9c,_0x379cb8,_0x3f4b20,_0x2e9010,_0x259a6f);if(_0x3f4b20&&_0xba8c37[_0x4937cd(0x17a)](_0x3f4b20)){if(_0x259a6f)try{await _0x4b3589[_0x4937cd(0x16a)](_0x3f4b20);}catch(_0x4304fe){}else return _0x3f4b20;}return _0x1de137[_0x4937cd(0x1bc)](logDebug,_0x1de137['VBHqF'],_0x3d788f,_0x3c510e,_0x408771,_0x5ebe9c,_0x379cb8,_0x3f4b20,_0x2e9010,_0x259a6f),new Promise((_0x8c04,_0x3c5835)=>{const _0x561f36=_0x4937cd;let _0x3f1712=![];const _0x3d48f8=_0x539664=>{const _0x1f9802=_0x7ed2;_0x1de137[_0x1f9802(0x1bd)](logDebug,_0x1de137[_0x1f9802(0x1ad)],_0x539664,_0x3d788f);if(_0x1de137[_0x1f9802(0x18f)](_0x539664['msgId'],_0x3d788f)){_0x3f1712=!![];let _0x3cfabc=_0x539664[_0x1f9802(0x1a5)];if(_0x3cfabc[_0x1f9802(0x175)]('\x5c')){const _0x3a1704=sessionConfig[_0x1f9802(0x16f)];_0x1de137[_0x1f9802(0x1a8)](logDebug,_0x1f9802(0x18e),_0x3a1704),_0x3cfabc=_0xc2edc3[_0x1f9802(0x1bf)](_0x3a1704,_0x3cfabc);}_0x8c04(_0x3cfabc);}};downloadMediaTasks[_0x561f36(0x168)](_0x1de137[_0x561f36(0x179)](randomUUID),_0x3d48f8),_0x1de137[_0x561f36(0x1a8)](setTimeout,()=>{!_0x3f1712&&_0x3c5835('下载超时');},_0x2e9010),napCatCore[_0x561f36(0x192)]['getMsgService']()[_0x561f36(0x17d)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3d788f,'chatType':_0x3c510e,'peerUid':_0x408771,'elementId':_0x5ebe9c,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x379cb8});});}static async[_0x47a949(0x19f)](_0x1151c9){const _0x5eee6f={'RUKCD':function(_0x2e0cf9,_0x1b4cf6){return _0x2e0cf9(_0x1b4cf6);}};return new Promise((_0x309ddd,_0x54cc14)=>{const _0x1fcf9f={'WzntC':function(_0x254a92,_0x503aae){const _0x2d6279=_0x7ed2;return _0x5eee6f[_0x2d6279(0x18a)](_0x254a92,_0x503aae);}};_0x36f102(_0x1151c9,(_0x131787,_0x580474)=>{const _0x426f52=_0x7ed2;_0x131787?_0x54cc14(_0x131787):_0x1fcf9f[_0x426f52(0x1be)](_0x309ddd,_0x580474);});});}static async['getImageUrl'](_0x1c692b){const _0x25b0d6=_0x47a949,_0x3ebdc0={'yzbxP':_0x25b0d6(0x186),'pfdeK':function(_0x5248e5,_0x319bfd){return _0x5248e5(_0x319bfd);},'XJcdg':function(_0xc53ec0,_0x53db58){return _0xc53ec0*_0x53db58;},'vzHUG':_0x25b0d6(0x184),'pgieL':function(_0x155397,_0x4018e7){return _0x155397+_0x4018e7;},'TRNMT':function(_0x4e4b81,_0x11f5a2,_0x685241){return _0x4e4b81(_0x11f5a2,_0x685241);},'sFuLc':_0x25b0d6(0x173),'ibxdf':function(_0x524837,_0x553dfc,_0x3cc507){return _0x524837(_0x553dfc,_0x3cc507);},'lqmEx':_0x25b0d6(0x17e),'LMCeS':function(_0x2e6ac1,_0x39abcb,_0xa22367,_0x391809){return _0x2e6ac1(_0x39abcb,_0xa22367,_0x391809);},'zgknL':function(_0x10bf07){return _0x10bf07();},'MuIJz':_0x25b0d6(0x1b6),'loejP':_0x25b0d6(0x1a7),'YSIFG':function(_0x49cc2b,_0x2fbcb3){return _0x49cc2b-_0x2fbcb3;},'qQxdu':function(_0x3db829,_0x4ead32){return _0x3db829+_0x4ead32;},'DxLeq':function(_0x1ce1d1,_0x14be48,_0x344a46){return _0x1ce1d1(_0x14be48,_0x344a46);},'tfVEC':function(_0xbf7d3,_0x42b231){return _0xbf7d3||_0x42b231;},'ISmNY':function(_0x58e725,_0x9b8f60){return _0x58e725||_0x9b8f60;},'VYckU':_0x25b0d6(0x1ba)},_0x1c20e0=_0x1c692b[_0x25b0d6(0x19b)]!==ChatType[_0x25b0d6(0x1b1)],_0x35658f=_0x1c692b[_0x25b0d6(0x17b)]['find'](_0x28b38c=>!!_0x28b38c[_0x25b0d6(0x1ca)]);if(!_0x35658f)return'';const _0x30771e=_0x35658f[_0x25b0d6(0x1ca)][_0x25b0d6(0x174)],_0x1feb15=_0x35658f[_0x25b0d6(0x1ca)][_0x25b0d6(0x171)],_0x47e1d9=_0x35658f[_0x25b0d6(0x1ca)][_0x25b0d6(0x171)],_0x188aba=_0x35658f[_0x25b0d6(0x1ca)][_0x25b0d6(0x1c5)],_0x36719b=_0x3279ee=>{const _0x40cb6=_0x25b0d6;_0x1c20e0?(privateImageRKey=_0x3279ee,lastGetPrivateRKeyTime=Date[_0x40cb6(0x19d)]()):(groupImageRKey=_0x3279ee,lastGetGroupRKeyTime=Date['now']());};if(_0x30771e){if(_0x30771e['startsWith'](_0x3ebdc0[_0x25b0d6(0x193)])){if(_0x30771e[_0x25b0d6(0x1a3)](_0x3ebdc0[_0x25b0d6(0x16c)]))return IMAGE_HTTP_HOST_NT+_0x30771e;if(!hookApi['isAvailable']())return logDebug(_0x25b0d6(0x19c)),'';const _0x360163=async()=>{const _0x41ae14=_0x25b0d6,_0x57e161={'YkpEX':function(_0x465def,_0x27341c){return _0x465def!==_0x27341c;},'PtnbH':function(_0x489944,_0x571b1d){return _0x489944(_0x571b1d);},'lOLUY':_0x3ebdc0[_0x41ae14(0x1af)]};_0x3ebdc0[_0x41ae14(0x19e)](logDebug,_0x41ae14(0x1c6)),NTQQFileApi[_0x41ae14(0x1c8)](_0x1c692b['msgId'],_0x1c692b[_0x41ae14(0x19b)],_0x1c692b[_0x41ae14(0x178)],_0x35658f[_0x41ae14(0x164)],'',_0x35658f[_0x41ae14(0x1ca)][_0x41ae14(0x167)],_0x3ebdc0[_0x41ae14(0x1b5)](0x3e8,0x1e),![])[_0x41ae14(0x190)](_0x5d7367=>{})[_0x41ae14(0x176)](logError),await _0x3ebdc0[_0x41ae14(0x19e)](sleep,0x3e8),_0x3ebdc0['pfdeK'](logDebug,_0x3ebdc0[_0x41ae14(0x16b)]);const _0x40a246=hookApi[_0x41ae14(0x19a)]()||'',_0x503e1a=_0x3ebdc0['pgieL'](IMAGE_HTTP_HOST_NT,_0x30771e)+_0x40a246;if(_0x40a246)try{_0x3ebdc0[_0x41ae14(0x197)](logDebug,_0x3ebdc0[_0x41ae14(0x195)],_0x503e1a),await new Promise((_0x3453f7,_0x471f82)=>{const _0x7de800=_0x41ae14,_0x555248={'EUfiV':function(_0x2222d0,_0x537c0c){return _0x57e161['YkpEX'](_0x2222d0,_0x537c0c);},'irROC':function(_0x2771b7,_0x171b6e){const _0x574004=_0x7ed2;return _0x57e161[_0x574004(0x172)](_0x2771b7,_0x171b6e);},'pDTOK':_0x57e161[_0x7de800(0x161)]};_0x2619c1[_0x7de800(0x18b)](_0x503e1a,_0x26f06a=>{const _0x2ea0be=_0x7de800;_0x555248[_0x2ea0be(0x1c9)](_0x26f06a[_0x2ea0be(0x1aa)],0xc8)?_0x555248[_0x2ea0be(0x1b7)](_0x471f82,_0x555248[_0x2ea0be(0x1b0)]):_0x555248[_0x2ea0be(0x1b7)](_0x3453f7,_0x26f06a);})['on']('error',_0x107f02=>{_0x471f82(_0x107f02);});}),_0x3ebdc0['ibxdf'](logDebug,_0x3ebdc0[_0x41ae14(0x17f)],_0x503e1a),_0x36719b(_0x40a246);}catch(_0x57cb3a){return _0x3ebdc0[_0x41ae14(0x1b3)](logError,_0x41ae14(0x1c1),_0x503e1a,_0x57cb3a),'';}return _0x40a246;},_0x165fd9=new Promise((_0x12cf8c,_0x17f0e9)=>{const _0x3ac172=_0x25b0d6,_0x43afef={'xKXic':function(_0x5ae314){const _0x8725b1=_0x7ed2;return _0x3ebdc0[_0x8725b1(0x1a0)](_0x5ae314);},'ztYzB':function(_0x4c3111,_0x48bf86){return _0x4c3111(_0x48bf86);}};getRKeyTaskQueue[_0x3ac172(0x185)](async()=>{const _0x5b0534=_0x3ac172,_0x24d3e2=await _0x43afef[_0x5b0534(0x198)](_0x360163);_0x43afef[_0x5b0534(0x15f)](_0x12cf8c,_0x24d3e2);});}),_0x5e7e81=_0x1c20e0?privateImageRKey:groupImageRKey,_0x2095ae=_0x1c20e0?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x3ebdc0['YSIFG'](Date[_0x25b0d6(0x19d)](),_0x2095ae)>rkeyExpireTime||!_0x5e7e81){const _0x22e759=await _0x165fd9;if(_0x22e759)return _0x3ebdc0[_0x25b0d6(0x183)](IMAGE_HTTP_HOST_NT+_0x30771e,''+_0x22e759);else _0x3ebdc0[_0x25b0d6(0x17c)](logError,_0x3ebdc0[_0x25b0d6(0x1af)],_0x30771e);}if(_0x5e7e81)return _0x3ebdc0['pgieL'](_0x3ebdc0[_0x25b0d6(0x183)](IMAGE_HTTP_HOST_NT,_0x30771e),''+_0x5e7e81);return'';}else return IMAGE_HTTP_HOST+_0x30771e;}else{if(_0x3ebdc0[_0x25b0d6(0x188)](_0x47e1d9,_0x1feb15))return IMAGE_HTTP_HOST+_0x25b0d6(0x1b8)+_0x3ebdc0['ISmNY'](_0x47e1d9,_0x1feb15)[_0x25b0d6(0x1a9)]()+'/0';}return _0x3ebdc0[_0x25b0d6(0x197)](logDebug,_0x3ebdc0[_0x25b0d6(0x1cd)],_0x1c692b),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x235818=!![]){return'';}static[_0x47a949(0x1c2)](){return'';}static[_0x47a949(0x170)](_0x58d050=[_0x47a949(0x191),_0x47a949(0x1cb)]){const _0x33cf09=_0x47a949;return napCatCore[_0x33cf09(0x192)][_0x33cf09(0x1b2)]()[_0x33cf09(0x1c3)](_0x58d050);}static[_0x47a949(0x1b9)](_0x36eb08={}){const _0x5aec59=_0x47a949;return napCatCore[_0x5aec59(0x192)]['getStorageCleanService']()[_0x5aec59(0x18c)](_0x36eb08);}static[_0x47a949(0x180)](){const _0x203f85=_0x47a949;return napCatCore['session'][_0x203f85(0x1b2)]()[_0x203f85(0x180)]();}static[_0x47a949(0x166)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x47a949(0x165)](_0x3cbb60,_0x257890=0x3e8,_0x17b85b=0x0){const _0x3b11dc=_0x47a949;return napCatCore[_0x3b11dc(0x192)]['getStorageCleanService']()['getChatCacheInfo'](_0x3cbb60,_0x257890,0x1,_0x17b85b);}static['getFileCacheInfo'](_0x53e722,_0x5a8055=0x3e8,_0x266e23){const _0x233088=_0x266e23?_0x266e23:{'fileType':_0x53e722};}static async['clearChatCache'](_0x5200a6=[],_0x176f51=[]){const _0x14e5eb=_0x47a949;return napCatCore['session'][_0x14e5eb(0x1b2)]()[_0x14e5eb(0x1ac)](_0x5200a6,_0x176f51);}}