const _0xd1a2d5=_0x4d80;(function(_0x24c504,_0x3a44f0){const _0x22f3da=_0x4d80,_0x4b9abc=_0x24c504();while(!![]){try{const _0xd9e8f1=parseInt(_0x22f3da(0xf2))/0x1*(parseInt(_0x22f3da(0xec))/0x2)+-parseInt(_0x22f3da(0x128))/0x3*(parseInt(_0x22f3da(0xee))/0x4)+-parseInt(_0x22f3da(0xff))/0x5*(parseInt(_0x22f3da(0xf6))/0x6)+-parseInt(_0x22f3da(0x122))/0x7*(parseInt(_0x22f3da(0xeb))/0x8)+-parseInt(_0x22f3da(0x110))/0x9+-parseInt(_0x22f3da(0x112))/0xa*(-parseInt(_0x22f3da(0x12b))/0xb)+parseInt(_0x22f3da(0x12e))/0xc;if(_0xd9e8f1===_0x3a44f0)break;else _0x4b9abc['push'](_0x4b9abc['shift']());}catch(_0xa7c8fb){_0x4b9abc['push'](_0x4b9abc['shift']());}}}(_0x5991,0xd35b8));function _0x5991(){const _0x18f0ba=['session','getHotUpdateCachePath','qVqTF','40tEJEFA','unlink','/gchatpic_new/0/0-0-','includes','md5HexStr','addCacheScannedPaths','clearChatCache','set','hotUpdate','getStorageCleanService','kMxcQ','downloadMedia\x20complete','delete','originImageUrl','clearCacheDataByKeys','MyGOo','qXvjZ','10871712digTXN','fileTypeFromFile','10bqBOus','FKDqE','fVEdq','start\x20downloadMedia','toUpperCase','downloadRichMedia','UiBUg','RIHFF','getImageSize','copyFile','getImageUrl','/download','scanCache','tmp','cCJqW','receive\x20downloadMedia\x20task','203caBCUt','FeKdk','downloadMedia','YfVhZ','getFileCacheInfo','getChatCacheInfo','2714991ZpMnng','uploadFile','getMsgService','9444919AaDZUT','ZlUac','getFileType','14423124MTpLNi','getDesktopTmpPath','rePTR','basename','twaXX','OJsCj','Rgqcw','onRichMediaDownloadComplete','clearChatCacheInfo','&rkey=','sGnAx','uxCSi','47440VSqtgV','1594wFzkPT','defaultFileDownloadPath','4caBYng','startsWith','setCacheSilentScan','PIC','1783uevOZO','lykPl','downloadPath','YPtHc','248214qwuoIg','getRichMediaFilePathForGuild','getRkey','getFileSize','private_rkey','图片url获取失败'];_0x5991=function(){return _0x18f0ba;};return _0x5991();}import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x56cd6b from'path';import _0x6d235d from'fs';import _0x3d2e2e from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x463a55 from'file-type';import{MsgListener}from'@/core/listeners';import _0x1107f2 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0xd1a2d5(0xe6)]=_0x67b08f=>{const _0x4a50fc=_0xd1a2d5,_0x40d2a3={'sGnAx':function(_0x1cb780,_0x27c9e7){return _0x1cb780(_0x27c9e7);}};for(const [_0xdce8aa,_0x29548d]of downloadMediaTasks){_0x40d2a3[_0x4a50fc(0xe9)](_0x29548d,_0x67b08f),downloadMediaTasks[_0x4a50fc(0x10b)](_0xdce8aa);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x1c4274){const _0xe8894c=_0xd1a2d5;return _0x463a55[_0xe8894c(0x111)](_0x1c4274);}static async[_0xd1a2d5(0x11b)](_0x52c0d2,_0x577969){const _0xe975e8=_0xd1a2d5;await napCatCore['util'][_0xe975e8(0x11b)](_0x52c0d2,_0x577969);}static async['getFileSize'](_0x1ece3b){const _0x167192=_0xd1a2d5;return await napCatCore['util'][_0x167192(0xf9)](_0x1ece3b);}static async[_0xd1a2d5(0x129)](_0x3cd62a,_0x531a96=ElementType[_0xd1a2d5(0xf1)],_0x6caefa=0x0){const _0x117157=_0xd1a2d5,_0x56028c={'gUjRn':function(_0x802ebf,_0x152a68){return _0x802ebf(_0x152a68);},'MyGOo':function(_0x4f0a04,_0x37ee5f){return _0x4f0a04+_0x37ee5f;},'qVqTF':function(_0x23a369,_0xc2bdaf){return _0x23a369===_0xc2bdaf;}},_0x146954=await _0x56028c['gUjRn'](calculateFileMD5,_0x3cd62a);let _0x101e97=(await NTQQFileApi[_0x117157(0x12d)](_0x3cd62a))?.['ext']||'';_0x101e97&&(_0x101e97=_0x56028c[_0x117157(0x10e)]('.',_0x101e97));let _0x57546f=''+_0x56cd6b[_0x117157(0x131)](_0x3cd62a);_0x56028c[_0x117157(0xfe)](_0x57546f['indexOf']('.'),-0x1)&&(_0x57546f+=_0x101e97);const _0x5763a0=napCatCore[_0x117157(0xfc)]['getMsgService']()[_0x117157(0xf7)]({'md5HexStr':_0x146954,'fileName':_0x57546f,'elementType':_0x531a96,'elementSubType':_0x6caefa,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x117157(0x11b)](_0x3cd62a,_0x5763a0);const _0x353ab0=await NTQQFileApi[_0x117157(0xf9)](_0x3cd62a);return{'md5':_0x146954,'fileName':_0x57546f,'path':_0x5763a0,'fileSize':_0x353ab0,'ext':_0x101e97};}static async[_0xd1a2d5(0x124)](_0x3866b1,_0x370516,_0x348335,_0x50903b,_0x4cdc66,_0x389873,_0x54efe2=0x3e8*0x3c*0x2,_0x316d7f=![]){const _0x3997a8=_0xd1a2d5,_0x42c7bd={'uxCSi':function(_0x215b1e,_0x12b8e0,_0x1d9493,_0x1f7f1e){return _0x215b1e(_0x12b8e0,_0x1d9493,_0x1f7f1e);},'ZlUac':function(_0x36b200,_0xc33d16,_0x25b5ca){return _0x36b200(_0xc33d16,_0x25b5ca);},'kpqpH':_0x3997a8(0xf4),'qXvjZ':function(_0x3d30a2,_0x545313){return _0x3d30a2(_0x545313);},'RIHFF':'下载超时','YfVhZ':function(_0x2b98eb){return _0x2b98eb();},'FeKdk':function(_0x237e04,_0x36f343,_0x28e5d2,_0x4e69c1,_0x3090bc,_0xb84648,_0x4d7934,_0x2f3fb2,_0x2ad1fe,_0x1cfee6){return _0x237e04(_0x36f343,_0x28e5d2,_0x4e69c1,_0x3090bc,_0xb84648,_0x4d7934,_0x2f3fb2,_0x2ad1fe,_0x1cfee6);},'YPtHc':_0x3997a8(0x121),'YBCdx':function(_0x1496a8,_0x7ca0d9,_0x3e5e85,_0x3eca65,_0x5bd8a7,_0x5ec7bc,_0x493279,_0x2646d8,_0x1637b8,_0x176acb){return _0x1496a8(_0x7ca0d9,_0x3e5e85,_0x3eca65,_0x5bd8a7,_0x5ec7bc,_0x493279,_0x2646d8,_0x1637b8,_0x176acb);},'rePTR':_0x3997a8(0x115)};_0x42c7bd[_0x3997a8(0x123)](logDebug,_0x42c7bd[_0x3997a8(0xf5)],_0x3866b1,_0x370516,_0x348335,_0x50903b,_0x4cdc66,_0x389873,_0x54efe2,_0x316d7f);if(_0x389873&&_0x6d235d['existsSync'](_0x389873)){if(_0x316d7f)try{await _0x3d2e2e[_0x3997a8(0x100)](_0x389873);}catch(_0x439eec){}else return _0x389873;}return _0x42c7bd['YBCdx'](logDebug,_0x42c7bd[_0x3997a8(0x130)],_0x3866b1,_0x370516,_0x348335,_0x50903b,_0x4cdc66,_0x389873,_0x54efe2,_0x316d7f),new Promise((_0x45cb9e,_0x3ce8cb)=>{const _0x1eba3d=_0x3997a8;let _0x23b28d=![];const _0x3631bc=_0x27a53e=>{const _0x32fda4=_0x4d80;_0x42c7bd[_0x32fda4(0xea)](logDebug,_0x32fda4(0x10a),_0x27a53e,_0x3866b1);if(_0x27a53e['msgId']===_0x3866b1){_0x23b28d=!![];let _0x29bc05=_0x27a53e['filePath'];if(_0x29bc05[_0x32fda4(0xef)]('\x5c')){const _0x4388b7=sessionConfig[_0x32fda4(0xed)];_0x42c7bd[_0x32fda4(0x12c)](logDebug,_0x42c7bd['kpqpH'],_0x4388b7),_0x29bc05=_0x56cd6b['join'](_0x4388b7,_0x29bc05);}_0x42c7bd[_0x32fda4(0x10f)](_0x45cb9e,_0x29bc05);}};downloadMediaTasks[_0x1eba3d(0x106)](_0x42c7bd[_0x1eba3d(0x125)](randomUUID),_0x3631bc),setTimeout(()=>{const _0x208617=_0x1eba3d;!_0x23b28d&&_0x42c7bd['qXvjZ'](_0x3ce8cb,_0x42c7bd[_0x208617(0x119)]);},_0x54efe2),napCatCore[_0x1eba3d(0xfc)][_0x1eba3d(0x12a)]()[_0x1eba3d(0x117)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3866b1,'chatType':_0x370516,'peerUid':_0x348335,'elementId':_0x50903b,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4cdc66});});}static async[_0xd1a2d5(0x11a)](_0x26f2c1){const _0x3c31b9={'OJsCj':function(_0x5b09ee,_0x4cae89){return _0x5b09ee(_0x4cae89);},'kMxcQ':function(_0x1f5e3f,_0x41b8f3){return _0x1f5e3f(_0x41b8f3);}};return new Promise((_0x49f998,_0x56110d)=>{const _0x417683={'UiBUg':function(_0x2ea5c3,_0xad955a){const _0x5272dd=_0x4d80;return _0x3c31b9[_0x5272dd(0xe4)](_0x2ea5c3,_0xad955a);},'twaXX':function(_0xe7ece2,_0x52bf00){const _0x36e56e=_0x4d80;return _0x3c31b9[_0x36e56e(0x109)](_0xe7ece2,_0x52bf00);}};_0x1107f2(_0x26f2c1,(_0x475765,_0x787049)=>{const _0xa05fd5=_0x4d80;_0x475765?_0x417683[_0xa05fd5(0x118)](_0x56110d,_0x475765):_0x417683[_0xa05fd5(0xe3)](_0x49f998,_0x787049);});});}static async[_0xd1a2d5(0x11c)](_0x55995f,_0xa81111){const _0x4628b7=_0xd1a2d5,_0x4abc6f={'cCJqW':_0x4628b7(0x11d),'wFJSC':_0x4628b7(0xe8),'awzEj':function(_0x213335,_0xa6efc8){return _0x213335+_0xa6efc8;},'fVEdq':function(_0x31b966,_0xf29e1f){return _0x31b966+_0xf29e1f;},'lykPl':function(_0xdf1dff,_0x175bf){return _0xdf1dff||_0x175bf;},'FKDqE':function(_0x6c492c,_0xe219c7,_0x3eb53b){return _0x6c492c(_0xe219c7,_0x3eb53b);},'Rgqcw':_0x4628b7(0xfb)};if(!_0x55995f)return'';const _0x1ab08a=_0x55995f[_0x4628b7(0x10c)],_0x35c155=_0x55995f[_0x4628b7(0x103)],_0x5f24ba=_0x55995f[_0x4628b7(0x103)],_0x32739f=_0x55995f['fileUuid'];if(_0x1ab08a){if(_0x1ab08a[_0x4628b7(0xef)](_0x4abc6f[_0x4628b7(0x120)])){if(_0x1ab08a[_0x4628b7(0x102)](_0x4abc6f['wFJSC']))return IMAGE_HTTP_HOST_NT+_0x1ab08a;const _0x357db5=await rkeyManager[_0x4628b7(0xf8)](),_0x13ac11=_0xa81111?_0x357db5[_0x4628b7(0xfa)]:_0x357db5['group_rkey'];return _0x4abc6f['awzEj'](_0x4abc6f[_0x4628b7(0x114)](IMAGE_HTTP_HOST_NT,_0x1ab08a),''+_0x13ac11);}else return IMAGE_HTTP_HOST+_0x1ab08a;}else{if(_0x4abc6f['lykPl'](_0x5f24ba,_0x35c155))return IMAGE_HTTP_HOST+_0x4628b7(0x101)+_0x4abc6f[_0x4628b7(0xf3)](_0x5f24ba,_0x35c155)[_0x4628b7(0x116)]()+'/0';}return _0x4abc6f[_0x4628b7(0x113)](logDebug,_0x4abc6f[_0x4628b7(0xe5)],_0x55995f),'';}}function _0x4d80(_0x45ac60,_0x283af0){const _0x59914b=_0x5991();return _0x4d80=function(_0x4d8012,_0x200a43){_0x4d8012=_0x4d8012-0xe3;let _0x33bdaa=_0x59914b[_0x4d8012];return _0x33bdaa;},_0x4d80(_0x45ac60,_0x283af0);}export class NTQQFileCacheApi{static async[_0xd1a2d5(0xf0)](_0x5e1c09=!![]){return'';}static['getCacheSessionPathList'](){return'';}static['clearCache'](_0xe71835=[_0xd1a2d5(0x11f),_0xd1a2d5(0x107)]){const _0x18934a=_0xd1a2d5;return napCatCore[_0x18934a(0xfc)]['getStorageCleanService']()[_0x18934a(0x10d)](_0xe71835);}static[_0xd1a2d5(0x104)](_0x38dcfb={}){const _0x22c79a=_0xd1a2d5;return napCatCore['session'][_0x22c79a(0x108)]()['addCacheScanedPaths'](_0x38dcfb);}static['scanCache'](){const _0x26679a=_0xd1a2d5;return napCatCore[_0x26679a(0xfc)][_0x26679a(0x108)]()[_0x26679a(0x11e)]();}static[_0xd1a2d5(0xfd)](){return'';}static[_0xd1a2d5(0x12f)](){return'';}static['getChatCacheList'](_0x3d77b4,_0x3167e9=0x3e8,_0x37c736=0x0){const _0x53c7a6=_0xd1a2d5;return napCatCore[_0x53c7a6(0xfc)]['getStorageCleanService']()[_0x53c7a6(0x127)](_0x3d77b4,_0x3167e9,0x1,_0x37c736);}static[_0xd1a2d5(0x126)](_0x37bed7,_0x5aa750=0x3e8,_0x23d36d){const _0x39afab=_0x23d36d?_0x23d36d:{'fileType':_0x37bed7};}static async[_0xd1a2d5(0x105)](_0x4e8eaf=[],_0x43a8f7=[]){const _0x4a3b16=_0xd1a2d5;return napCatCore[_0x4a3b16(0xfc)][_0x4a3b16(0x108)]()[_0x4a3b16(0xe7)](_0x4e8eaf,_0x43a8f7);}}