const _0x3f5952=_0x5814;(function(_0x22c87f,_0x3c33d8){const _0x5b6d7a=_0x5814,_0x1546c2=_0x22c87f();while(!![]){try{const _0xb8eed=-parseInt(_0x5b6d7a(0x1f9))/0x1+parseInt(_0x5b6d7a(0x21b))/0x2+parseInt(_0x5b6d7a(0x1ef))/0x3*(parseInt(_0x5b6d7a(0x220))/0x4)+-parseInt(_0x5b6d7a(0x1ea))/0x5*(-parseInt(_0x5b6d7a(0x228))/0x6)+-parseInt(_0x5b6d7a(0x21e))/0x7+parseInt(_0x5b6d7a(0x214))/0x8+-parseInt(_0x5b6d7a(0x213))/0x9;if(_0xb8eed===_0x3c33d8)break;else _0x1546c2['push'](_0x1546c2['shift']());}catch(_0x3a9f08){_0x1546c2['push'](_0x1546c2['shift']());}}}(_0x475f,0xca993));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1af9d6 from'path';function _0x5814(_0x2bb013,_0x3d969a){const _0x475f07=_0x475f();return _0x5814=function(_0x5814cd,_0x3cf329){_0x5814cd=_0x5814cd-0x1e4;let _0x25e38a=_0x475f07[_0x5814cd];return _0x25e38a;},_0x5814(_0x2bb013,_0x3d969a);}import _0x4a550c from'fs';import _0x47b6cf from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x183728 from'file-type';import{MsgListener}from'@/core/listeners';import _0x38e043 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x475f(){const _0x1b0aa5=['util','getDesktopTmpPath','getFileCacheInfo','getHotUpdateCachePath','tmp','KynDU','gHDcg','getCacheSessionPathList','XZjat','/gchatpic_new/0/0-0-','md5HexStr','private_rkey','downloadMedia','set','hiQkt','existsSync','daiqZ','getStorageCleanService','getFileType','vWIXe','getFileSize','unlink','scanCache','algcT','26276589lttZnz','12622136lzEnGI','startsWith','getMsgService','bnWCV','zPhOO','ext','fileUuid','1489348WyIYxG','hotUpdate','getRkey','2367743kMKuDS','getImageSize','4gZXWmI','session','toUpperCase','clearCache','delete','includes','&rkey=','originImageUrl','7914zYaIJO','rVSyL','receive\x20downloadMedia\x20task','indexOf','uploadFile','getRichMediaFilePathForGuild','/download','fileTypeFromFile','clearChatCache','getImageUrl','copyFile','图片url获取失败','uaUqF','3350TYNjdu','downloadMedia\x20complete','addCacheScanedPaths','GXGPs','ZbSKI','4858089Ajmikf','clearCacheDataByKeys','下载超时','getChatCacheInfo','GFLJG','hZUgx','join','NCZjO','addCacheScannedPaths','group_rkey','737821BnIFXD','PIC'];_0x475f=function(){return _0x1b0aa5;};return _0x475f();}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x25b5e7=>{const _0x14c329=_0x5814,_0x2285ee={'GFLJG':function(_0x384770,_0x453a0c){return _0x384770(_0x453a0c);}};for(const [_0x147407,_0x590e5b]of downloadMediaTasks){_0x2285ee[_0x14c329(0x1f3)](_0x590e5b,_0x25b5e7),downloadMediaTasks[_0x14c329(0x224)](_0x147407);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x3f5952(0x20d)](_0x494f89){const _0x2c499f=_0x3f5952;return _0x183728[_0x2c499f(0x1e4)](_0x494f89);}static async['copyFile'](_0x4a89fe,_0x3a225a){const _0x3a4047=_0x3f5952;await napCatCore[_0x3a4047(0x1fb)][_0x3a4047(0x1e7)](_0x4a89fe,_0x3a225a);}static async['getFileSize'](_0x4cf55f){const _0x57f26f=_0x3f5952;return await napCatCore[_0x57f26f(0x1fb)][_0x57f26f(0x20f)](_0x4cf55f);}static async[_0x3f5952(0x22c)](_0x3e2ef6,_0x3e946f=ElementType[_0x3f5952(0x1fa)],_0x3ee525=0x0){const _0x106f0a=_0x3f5952,_0x59f772={'gHDcg':function(_0x1e36e1,_0x310f74){return _0x1e36e1+_0x310f74;},'vWIXe':function(_0x5a093c,_0x5d82f5){return _0x5a093c===_0x5d82f5;}},_0x10f4d7=await calculateFileMD5(_0x3e2ef6);let _0x54bfb1=(await NTQQFileApi[_0x106f0a(0x20d)](_0x3e2ef6))?.[_0x106f0a(0x219)]||'';_0x54bfb1&&(_0x54bfb1=_0x59f772[_0x106f0a(0x201)]('.',_0x54bfb1));let _0x2942b2=''+_0x1af9d6['basename'](_0x3e2ef6);_0x59f772[_0x106f0a(0x20e)](_0x2942b2[_0x106f0a(0x22b)]('.'),-0x1)&&(_0x2942b2+=_0x54bfb1);const _0x45a4d8=napCatCore[_0x106f0a(0x221)]['getMsgService']()[_0x106f0a(0x22d)]({'md5HexStr':_0x10f4d7,'fileName':_0x2942b2,'elementType':_0x3e946f,'elementSubType':_0x3ee525,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x106f0a(0x1e7)](_0x3e2ef6,_0x45a4d8);const _0x4ff0af=await NTQQFileApi['getFileSize'](_0x3e2ef6);return{'md5':_0x10f4d7,'fileName':_0x2942b2,'path':_0x45a4d8,'fileSize':_0x4ff0af,'ext':_0x54bfb1};}static async[_0x3f5952(0x207)](_0x47cd3c,_0x534e06,_0x31630a,_0x2fbc1c,_0x526dc9,_0x5a585d,_0x2faa91=0x3e8*0x3c*0x2,_0x4adf08=![]){const _0x4433e4=_0x3f5952,_0x2580fe={'hZUgx':function(_0x1238c6,_0x35c109){return _0x1238c6(_0x35c109);},'algcT':_0x4433e4(0x1f1),'zPhOO':function(_0x52aa67,_0x2d03d0,_0x53b517,_0xa8356){return _0x52aa67(_0x2d03d0,_0x53b517,_0xa8356);},'zMSXw':_0x4433e4(0x1eb),'eeKGo':function(_0x3ee121,_0x3adcaf){return _0x3ee121===_0x3adcaf;},'daiqZ':function(_0x58007e,_0x539c2f,_0x2eec94){return _0x58007e(_0x539c2f,_0x2eec94);},'bnWCV':'downloadPath','ISqsV':function(_0x47c44d,_0x4724d6,_0x2cba7f,_0x42b782,_0x58358d,_0x510496,_0x146f6e,_0x4550dc,_0x49d0b0,_0x5bd85a){return _0x47c44d(_0x4724d6,_0x2cba7f,_0x42b782,_0x58358d,_0x510496,_0x146f6e,_0x4550dc,_0x49d0b0,_0x5bd85a);},'HIJAa':_0x4433e4(0x22a),'hiQkt':'start\x20downloadMedia'};_0x2580fe['ISqsV'](logDebug,_0x2580fe['HIJAa'],_0x47cd3c,_0x534e06,_0x31630a,_0x2fbc1c,_0x526dc9,_0x5a585d,_0x2faa91,_0x4adf08);if(_0x5a585d&&_0x4a550c[_0x4433e4(0x20a)](_0x5a585d)){if(_0x4adf08)try{await _0x47b6cf[_0x4433e4(0x210)](_0x5a585d);}catch(_0x36db78){}else return _0x5a585d;}return logDebug(_0x2580fe[_0x4433e4(0x209)],_0x47cd3c,_0x534e06,_0x31630a,_0x2fbc1c,_0x526dc9,_0x5a585d,_0x2faa91,_0x4adf08),new Promise((_0x5a5061,_0x286544)=>{const _0x24450b=_0x4433e4,_0x22572c={'pvOye':function(_0x5d6a8a,_0x1a7e9f,_0x58420e,_0x422f01){const _0x37b1f7=_0x5814;return _0x2580fe[_0x37b1f7(0x218)](_0x5d6a8a,_0x1a7e9f,_0x58420e,_0x422f01);},'yGWdH':_0x2580fe['zMSXw'],'XZjat':function(_0x220e84,_0x3b3744){return _0x2580fe['eeKGo'](_0x220e84,_0x3b3744);},'hbzjr':function(_0x4d0a19,_0x56b023,_0x4bc961){const _0xbcbfb8=_0x5814;return _0x2580fe[_0xbcbfb8(0x20b)](_0x4d0a19,_0x56b023,_0x4bc961);},'ZbSKI':_0x2580fe[_0x24450b(0x217)],'NCZjO':function(_0x159a6e,_0x44a952){const _0x362061=_0x24450b;return _0x2580fe[_0x362061(0x1f4)](_0x159a6e,_0x44a952);}};let _0x160f86=![];const _0x364587=_0x48498d=>{const _0x1fbca1=_0x24450b;_0x22572c['pvOye'](logDebug,_0x22572c['yGWdH'],_0x48498d,_0x47cd3c);if(_0x22572c[_0x1fbca1(0x203)](_0x48498d['msgId'],_0x47cd3c)){_0x160f86=!![];let _0x54f162=_0x48498d['filePath'];if(_0x54f162['startsWith']('\x5c')){const _0x41ed33=sessionConfig['defaultFileDownloadPath'];_0x22572c['hbzjr'](logDebug,_0x22572c[_0x1fbca1(0x1ee)],_0x41ed33),_0x54f162=_0x1af9d6[_0x1fbca1(0x1f5)](_0x41ed33,_0x54f162);}_0x22572c[_0x1fbca1(0x1f6)](_0x5a5061,_0x54f162);}};downloadMediaTasks[_0x24450b(0x208)](randomUUID(),_0x364587),_0x2580fe['daiqZ'](setTimeout,()=>{const _0x391b8e=_0x24450b;!_0x160f86&&_0x2580fe[_0x391b8e(0x1f4)](_0x286544,_0x2580fe[_0x391b8e(0x212)]);},_0x2faa91),napCatCore[_0x24450b(0x221)][_0x24450b(0x216)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x47cd3c,'chatType':_0x534e06,'peerUid':_0x31630a,'elementId':_0x2fbc1c,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x526dc9});});}static async[_0x3f5952(0x21f)](_0x298fe5){return new Promise((_0x2e9415,_0x16978f)=>{_0x38e043(_0x298fe5,(_0x53b3e7,_0x3e1bed)=>{_0x53b3e7?_0x16978f(_0x53b3e7):_0x2e9415(_0x3e1bed);});});}static async[_0x3f5952(0x1e6)](_0x7d989d,_0x12a8e4){const _0x381e5d=_0x3f5952,_0x4a1975={'nAYQt':function(_0x87211d,_0x170461){return _0x87211d+_0x170461;},'GXGPs':function(_0x4a441e,_0x5a9851){return _0x4a441e+_0x5a9851;},'uaUqF':function(_0x203bfd,_0x5c0e0d){return _0x203bfd+_0x5c0e0d;},'KynDU':function(_0x78e645,_0x425d0d){return _0x78e645+_0x425d0d;},'rVSyL':function(_0x213252,_0x2b864b){return _0x213252||_0x2b864b;},'HRbZV':function(_0x5f0894,_0x54a4db,_0x57cd52){return _0x5f0894(_0x54a4db,_0x57cd52);}};if(!_0x7d989d)return'';const _0x33b122=_0x7d989d[_0x381e5d(0x227)],_0x29c23b=_0x7d989d[_0x381e5d(0x205)],_0x50271d=_0x7d989d[_0x381e5d(0x205)],_0x45003e=_0x7d989d[_0x381e5d(0x21a)];if(_0x33b122){if(_0x33b122[_0x381e5d(0x215)](_0x381e5d(0x22e))){if(_0x33b122[_0x381e5d(0x225)](_0x381e5d(0x226)))return _0x4a1975['nAYQt'](IMAGE_HTTP_HOST_NT,_0x33b122);const _0x2d24c5=await rkeyManager[_0x381e5d(0x21d)](),_0x1b6b24=_0x12a8e4?_0x2d24c5[_0x381e5d(0x206)]:_0x2d24c5[_0x381e5d(0x1f8)];return _0x4a1975[_0x381e5d(0x1ed)](_0x4a1975[_0x381e5d(0x1e9)](IMAGE_HTTP_HOST_NT,_0x33b122),''+_0x1b6b24);}else return _0x4a1975[_0x381e5d(0x200)](IMAGE_HTTP_HOST,_0x33b122);}else{if(_0x4a1975[_0x381e5d(0x229)](_0x50271d,_0x29c23b))return IMAGE_HTTP_HOST+_0x381e5d(0x204)+_0x4a1975[_0x381e5d(0x229)](_0x50271d,_0x29c23b)[_0x381e5d(0x222)]()+'/0';}return _0x4a1975['HRbZV'](logDebug,_0x381e5d(0x1e8),_0x7d989d),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x3fad91=!![]){return'';}static[_0x3f5952(0x202)](){return'';}static[_0x3f5952(0x223)](_0x234ad5=[_0x3f5952(0x1ff),_0x3f5952(0x21c)]){const _0x18270b=_0x3f5952;return napCatCore[_0x18270b(0x221)][_0x18270b(0x20c)]()[_0x18270b(0x1f0)](_0x234ad5);}static[_0x3f5952(0x1f7)](_0x4af20f={}){const _0x4ae929=_0x3f5952;return napCatCore[_0x4ae929(0x221)][_0x4ae929(0x20c)]()[_0x4ae929(0x1ec)](_0x4af20f);}static[_0x3f5952(0x211)](){const _0x1c769c=_0x3f5952;return napCatCore[_0x1c769c(0x221)][_0x1c769c(0x20c)]()['scanCache']();}static[_0x3f5952(0x1fe)](){return'';}static[_0x3f5952(0x1fc)](){return'';}static['getChatCacheList'](_0x1ccd51,_0x2a7363=0x3e8,_0x38ea77=0x0){const _0x508ee6=_0x3f5952;return napCatCore[_0x508ee6(0x221)]['getStorageCleanService']()[_0x508ee6(0x1f2)](_0x1ccd51,_0x2a7363,0x1,_0x38ea77);}static[_0x3f5952(0x1fd)](_0x320445,_0x5946d2=0x3e8,_0x4c2523){const _0x2a8f06=_0x4c2523?_0x4c2523:{'fileType':_0x320445};}static async[_0x3f5952(0x1e5)](_0x242b0e=[],_0x5a30c5=[]){const _0x4e64d7=_0x3f5952;return napCatCore[_0x4e64d7(0x221)]['getStorageCleanService']()['clearChatCacheInfo'](_0x242b0e,_0x5a30c5);}}