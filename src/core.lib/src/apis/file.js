const _0xd6a2ce=_0x51f8;(function(_0x39ac41,_0x56a240){const _0x239baa=_0x51f8,_0x18e128=_0x39ac41();while(!![]){try{const _0x2b01f5=-parseInt(_0x239baa(0x9d))/0x1*(parseInt(_0x239baa(0xaf))/0x2)+parseInt(_0x239baa(0xa4))/0x3*(-parseInt(_0x239baa(0xa6))/0x4)+-parseInt(_0x239baa(0xad))/0x5+-parseInt(_0x239baa(0xa7))/0x6*(-parseInt(_0x239baa(0xc0))/0x7)+parseInt(_0x239baa(0xa2))/0x8*(-parseInt(_0x239baa(0x9f))/0x9)+-parseInt(_0x239baa(0xac))/0xa*(parseInt(_0x239baa(0xb3))/0xb)+-parseInt(_0x239baa(0x96))/0xc*(-parseInt(_0x239baa(0xa1))/0xd);if(_0x2b01f5===_0x56a240)break;else _0x18e128['push'](_0x18e128['shift']());}catch(_0x1d6935){_0x18e128['push'](_0x18e128['shift']());}}}(_0x2468,0x878f9));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x517eca from'path';import _0x504ebf from'fs';import _0xc25505 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x13632c from'file-type';import{MsgListener}from'@/core/listeners';function _0x2468(){const _0x51d3f3=['copyFile','wLrDI','87edAvpt','util','6789141aqIljR','getChatCacheInfo','37399102YXEBEV','8bpoCbe','session','105993kfiFuW','clearChatCache','108NmeGnx','18sdqOOy','scanCache','JWzkP','图片url获取失败','gbHZO','13220sekDsI','168825QlSOcc','set','15182wvhlhs','XWUvj','getDesktopTmpPath','addListener','891WMRBce','existsSync','&rkey=','npmws','private_rkey','getHotUpdateCachePath','getStorageCleanService','SpNpj','startsWith','hotUpdate','clearChatCacheInfo','uploadFile','clearCacheDataByKeys','438557fptSad','group_rkey','setCacheSilentScan','ULbkj','getMsgService','delete','bbfIw','ext','basename','filePath','getCacheSessionPathList','getRkey','getFileSize','getFileType','fileTypeFromFile','getImageSize','onRichMediaDownloadComplete','fileUuid','originImageUrl','ndblM','onLoginSuccess','clearCache','defaultFileDownloadPath','getChatCacheList','includes','md5HexStr','JiwBm','/download','12OWxebo','downloadMedia','join','/gchatpic_new/0/0-0-','addCacheScanedPaths'];_0x2468=function(){return _0x51d3f3;};return _0x2468();}import _0x352978 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0xd6a2ce(0xd0)]=_0x5d5cea=>{const _0x30d6d2=_0xd6a2ce;for(const [_0x2ee94e,_0x1440c6]of downloadMediaTasks){_0x1440c6(_0x5d5cea),downloadMediaTasks[_0x30d6d2(0xc5)](_0x2ee94e);}},setTimeout(()=>{const _0x6798e0=_0xd6a2ce;napCatCore[_0x6798e0(0x8e)](()=>{const _0x33fd06=_0x6798e0;napCatCore[_0x33fd06(0xb2)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0xd6a2ce(0xcd)](_0x4c82d3){const _0x30cce6=_0xd6a2ce;return _0x13632c[_0x30cce6(0xce)](_0x4c82d3);}static async[_0xd6a2ce(0x9b)](_0xd4fbf0,_0x59f77b){const _0x327ec0=_0xd6a2ce;await napCatCore[_0x327ec0(0x9e)][_0x327ec0(0x9b)](_0xd4fbf0,_0x59f77b);}static async[_0xd6a2ce(0xcc)](_0x5dc2b9){const _0x4ee10b=_0xd6a2ce;return await napCatCore[_0x4ee10b(0x9e)][_0x4ee10b(0xcc)](_0x5dc2b9);}static async[_0xd6a2ce(0xbe)](_0x41b666,_0x45f361=ElementType['PIC'],_0x3e4054=0x0){const _0x4041de=_0xd6a2ce,_0x261ca9={'wLrDI':function(_0x9c0334,_0x1082ce){return _0x9c0334(_0x1082ce);},'JWzkP':function(_0x1cd46f,_0x302c2b){return _0x1cd46f+_0x302c2b;},'fnXJE':function(_0x21430f,_0x2af7a7){return _0x21430f===_0x2af7a7;}},_0x34aba5=await _0x261ca9[_0x4041de(0x9c)](calculateFileMD5,_0x41b666);let _0x331b0b=(await NTQQFileApi[_0x4041de(0xcd)](_0x41b666))?.[_0x4041de(0xc7)]||'';_0x331b0b&&(_0x331b0b=_0x261ca9[_0x4041de(0xa9)]('.',_0x331b0b));let _0x5245c6=''+_0x517eca[_0x4041de(0xc8)](_0x41b666);_0x261ca9['fnXJE'](_0x5245c6['indexOf']('.'),-0x1)&&(_0x5245c6+=_0x331b0b);const _0x3d7916=napCatCore[_0x4041de(0xa3)][_0x4041de(0xc4)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x34aba5,'fileName':_0x5245c6,'elementType':_0x45f361,'elementSubType':_0x3e4054,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x4041de(0x9b)](_0x41b666,_0x3d7916);const _0x23a9c8=await NTQQFileApi[_0x4041de(0xcc)](_0x41b666);return{'md5':_0x34aba5,'fileName':_0x5245c6,'path':_0x3d7916,'fileSize':_0x23a9c8,'ext':_0x331b0b};}static async[_0xd6a2ce(0x97)](_0x57de69,_0x429ec1,_0x37aeb9,_0x12f8f5,_0x3b691a,_0x1b2431,_0x5d9396=0x3e8*0x3c*0x2,_0x3cf82f=![]){const _0x481d9c=_0xd6a2ce,_0x3b7e9d={'bbfIw':function(_0x5a45ca,_0x45bc0d){return _0x5a45ca(_0x45bc0d);},'gbHZO':'下载超时','obvyZ':function(_0x12b36e){return _0x12b36e();},'MNHou':function(_0x3a5f0f,_0x241324,_0x5b1d56){return _0x3a5f0f(_0x241324,_0x5b1d56);}};if(_0x1b2431&&_0x504ebf[_0x481d9c(0xb4)](_0x1b2431)){if(_0x3cf82f)try{await _0xc25505['unlink'](_0x1b2431);}catch(_0x34f254){}else return _0x1b2431;}return new Promise((_0x4beb55,_0x2d3f5c)=>{const _0x49aee8=_0x481d9c,_0x2a5572={'JJKGc':function(_0x46f915,_0x26651a){return _0x46f915===_0x26651a;},'JiwBm':function(_0x3c79a3,_0x23be6d){return _0x3c79a3(_0x23be6d);},'npmws':function(_0x3471aa,_0x411acb){const _0x553a6b=_0x51f8;return _0x3b7e9d[_0x553a6b(0xc6)](_0x3471aa,_0x411acb);},'ndblM':_0x3b7e9d[_0x49aee8(0xab)]};let _0x13ec1e=![];const _0x20c297=_0x4aa63b=>{const _0x464c95=_0x49aee8;if(_0x2a5572['JJKGc'](_0x4aa63b['msgId'],_0x57de69)){_0x13ec1e=!![];let _0x51c1b7=_0x4aa63b[_0x464c95(0xc9)];if(_0x51c1b7['startsWith']('\x5c')){const _0x221a81=sessionConfig[_0x464c95(0x90)];_0x51c1b7=_0x517eca[_0x464c95(0x98)](_0x221a81,_0x51c1b7);}_0x2a5572[_0x464c95(0x94)](_0x4beb55,_0x51c1b7);}};downloadMediaTasks[_0x49aee8(0xae)](_0x3b7e9d['obvyZ'](randomUUID),_0x20c297),_0x3b7e9d['MNHou'](setTimeout,()=>{const _0x2693f6=_0x49aee8;!_0x13ec1e&&_0x2a5572[_0x2693f6(0xb6)](_0x2d3f5c,_0x2a5572[_0x2693f6(0x8d)]);},_0x5d9396),napCatCore[_0x49aee8(0xa3)]['getMsgService']()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x57de69,'chatType':_0x429ec1,'peerUid':_0x37aeb9,'elementId':_0x12f8f5,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3b691a});});}static async[_0xd6a2ce(0xcf)](_0x1b27b7){const _0x2eaaf1={'SpNpj':function(_0x5c5422,_0x279023){return _0x5c5422(_0x279023);}};return new Promise((_0x1ef9c2,_0x4c1798)=>{_0x352978(_0x1b27b7,(_0x2cfac6,_0x387f12)=>{const _0x2ce4b1=_0x51f8;_0x2cfac6?_0x2eaaf1[_0x2ce4b1(0xba)](_0x4c1798,_0x2cfac6):_0x2eaaf1[_0x2ce4b1(0xba)](_0x1ef9c2,_0x387f12);});});}static async['getImageUrl'](_0x40c738,_0xd10a04){const _0xe4485b=_0xd6a2ce,_0x1808f2={'TmcQJ':_0xe4485b(0xb5),'ULbkj':function(_0x5e26fc,_0x28979d){return _0x5e26fc+_0x28979d;},'NHlgg':function(_0x378a00,_0x42f0ff){return _0x378a00||_0x42f0ff;},'BKjLc':function(_0x5d9d93,_0x3014bb){return _0x5d9d93||_0x3014bb;},'XWUvj':function(_0x2124e3,_0x2dcc23,_0x142868){return _0x2124e3(_0x2dcc23,_0x142868);}};if(!_0x40c738)return'';const _0x36109c=_0x40c738[_0xe4485b(0x8c)],_0x539330=_0x40c738[_0xe4485b(0x93)],_0x5b210e=_0x40c738[_0xe4485b(0x93)],_0x507ce1=_0x40c738[_0xe4485b(0x8b)];if(_0x36109c){if(_0x36109c[_0xe4485b(0xbb)](_0xe4485b(0x95))){if(_0x36109c[_0xe4485b(0x92)](_0x1808f2['TmcQJ']))return _0x1808f2[_0xe4485b(0xc3)](IMAGE_HTTP_HOST_NT,_0x36109c);const _0x4ce612=await rkeyManager[_0xe4485b(0xcb)](),_0x1767db=_0xd10a04?_0x4ce612[_0xe4485b(0xb7)]:_0x4ce612[_0xe4485b(0xc1)];return _0x1808f2[_0xe4485b(0xc3)](IMAGE_HTTP_HOST_NT+_0x36109c,''+_0x1767db);}else return _0x1808f2[_0xe4485b(0xc3)](IMAGE_HTTP_HOST,_0x36109c);}else{if(_0x1808f2['NHlgg'](_0x5b210e,_0x539330))return IMAGE_HTTP_HOST+_0xe4485b(0x99)+_0x1808f2['BKjLc'](_0x5b210e,_0x539330)['toUpperCase']()+'/0';}return _0x1808f2[_0xe4485b(0xb0)](logDebug,_0xe4485b(0xaa),_0x40c738),'';}}function _0x51f8(_0xa5dc84,_0x2e4b9e){const _0x24686a=_0x2468();return _0x51f8=function(_0x51f828,_0x509e20){_0x51f828=_0x51f828-0x8b;let _0x1b1aeb=_0x24686a[_0x51f828];return _0x1b1aeb;},_0x51f8(_0xa5dc84,_0x2e4b9e);}export class NTQQFileCacheApi{static async[_0xd6a2ce(0xc2)](_0x3e47da=!![]){return'';}static[_0xd6a2ce(0xca)](){return'';}static[_0xd6a2ce(0x8f)](_0x353fed=['tmp',_0xd6a2ce(0xbc)]){const _0x1c9daa=_0xd6a2ce;return napCatCore['session'][_0x1c9daa(0xb9)]()[_0x1c9daa(0xbf)](_0x353fed);}static['addCacheScannedPaths'](_0x13db6e={}){const _0x3b9741=_0xd6a2ce;return napCatCore[_0x3b9741(0xa3)]['getStorageCleanService']()[_0x3b9741(0x9a)](_0x13db6e);}static['scanCache'](){const _0x555a7f=_0xd6a2ce;return napCatCore['session'][_0x555a7f(0xb9)]()[_0x555a7f(0xa8)]();}static[_0xd6a2ce(0xb8)](){return'';}static[_0xd6a2ce(0xb1)](){return'';}static[_0xd6a2ce(0x91)](_0x43bb2b,_0x37e57a=0x3e8,_0x3fdcfe=0x0){const _0x562e2b=_0xd6a2ce;return napCatCore[_0x562e2b(0xa3)]['getStorageCleanService']()[_0x562e2b(0xa0)](_0x43bb2b,_0x37e57a,0x1,_0x3fdcfe);}static['getFileCacheInfo'](_0x3e7f9b,_0x33fe9b=0x3e8,_0x5495c9){const _0x29ac9c=_0x5495c9?_0x5495c9:{'fileType':_0x3e7f9b};}static async[_0xd6a2ce(0xa5)](_0x5d58f3=[],_0x5d9fec=[]){const _0x213a8a=_0xd6a2ce;return napCatCore[_0x213a8a(0xa3)][_0x213a8a(0xb9)]()[_0x213a8a(0xbd)](_0x5d58f3,_0x5d9fec);}}