const _0x55bf23=_0x309b;(function(_0x1e5f3e,_0x11d954){const _0x3a8fd9=_0x309b,_0x6b6c48=_0x1e5f3e();while(!![]){try{const _0x304267=-parseInt(_0x3a8fd9(0x184))/0x1+parseInt(_0x3a8fd9(0x183))/0x2*(parseInt(_0x3a8fd9(0x17e))/0x3)+parseInt(_0x3a8fd9(0x146))/0x4+parseInt(_0x3a8fd9(0x18a))/0x5*(-parseInt(_0x3a8fd9(0x176))/0x6)+parseInt(_0x3a8fd9(0x145))/0x7+parseInt(_0x3a8fd9(0x175))/0x8+-parseInt(_0x3a8fd9(0x171))/0x9;if(_0x304267===_0x11d954)break;else _0x6b6c48['push'](_0x6b6c48['shift']());}catch(_0x164b91){_0x6b6c48['push'](_0x6b6c48['shift']());}}}(_0x4b7d,0x7561b));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0xc33a9e from'path';import _0x194602 from'fs';import _0x51289b from'fs/promises';function _0x309b(_0x5411ff,_0x3c284d){const _0x4b7d54=_0x4b7d();return _0x309b=function(_0x309b7c,_0xaa3dff){_0x309b7c=_0x309b7c-0x143;let _0x5a311c=_0x4b7d54[_0x309b7c];return _0x5a311c;},_0x309b(_0x5411ff,_0x3c284d);}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x422dd5 from'file-type';import{MsgListener}from'@/core/listeners';function _0x4b7d(){const _0x5e59db=['delete','unlink','indexOf','392504sunuXl','2194732WxBveF','getChatCacheList','getRkey','ZYcOT','onRichMediaDownloadComplete','LjnmI','RRPXL','basename','tsKWI','downloadRichMedia','&rkey=','下载超时','getStorageCleanService','existsSync','getDesktopTmpPath','getRichMediaFilePathForGuild','MZNbB','clearCache','lhntQ','session','SinJG','HqPdx','ext','PqYKt','BgPux','addCacheScannedPaths','scanCache','getImageUrl','originImageUrl','getImageSize','getChatCacheInfo','getFileCacheInfo','/download','VCkwo','filePath','startsWith','hotUpdate','getCacheSessionPathList','getFileSize','private_rkey','defaultFileDownloadPath','toUpperCase','set','3060927Itmpuo','copyFile','clearCacheDataByKeys','downloadMedia','4951488fPtkZZ','5874TmoVck','IGetM','onLoginSuccess','mIbVI','addListener','FAKTz','md5HexStr','图片url获取失败','3RreJkS','UAvVb','/gchatpic_new/0/0-0-','getFileType','util','98364crEOaG','257154AKNFJx','setCacheSilentScan','getHotUpdateCachePath','PIC','getMsgService','clearChatCacheInfo','995ddeOsR','clearChatCache'];_0x4b7d=function(){return _0x5e59db;};return _0x4b7d();}import _0x219445 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x55bf23(0x14a)]=_0x30e1e9=>{const _0x1c8d6b=_0x55bf23,_0xd71df5={'BgPux':function(_0x4d57ee,_0x5393ba){return _0x4d57ee(_0x5393ba);}};for(const [_0x840339,_0x232915]of downloadMediaTasks){_0xd71df5[_0x1c8d6b(0x15e)](_0x232915,_0x30e1e9),downloadMediaTasks[_0x1c8d6b(0x18c)](_0x840339);}},setTimeout(()=>{const _0x14d545=_0x55bf23;napCatCore[_0x14d545(0x178)](()=>{const _0x222fa4=_0x14d545;napCatCore[_0x222fa4(0x17a)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x55bf23(0x181)](_0x296b01){return _0x422dd5['fileTypeFromFile'](_0x296b01);}static async[_0x55bf23(0x172)](_0x2b3e0c,_0x40e90b){const _0x41737f=_0x55bf23;await napCatCore[_0x41737f(0x182)][_0x41737f(0x172)](_0x2b3e0c,_0x40e90b);}static async[_0x55bf23(0x16c)](_0x54e9f){const _0x39c469=_0x55bf23;return await napCatCore[_0x39c469(0x182)]['getFileSize'](_0x54e9f);}static async['uploadFile'](_0x13eabc,_0x5c94e5=ElementType[_0x55bf23(0x187)],_0x263c29=0x0){const _0x1b9026=_0x55bf23,_0x41a1e0={'MZNbB':function(_0x572f59,_0x24ca78){return _0x572f59(_0x24ca78);},'FAKTz':function(_0x1f874b,_0x56add6){return _0x1f874b+_0x56add6;},'qCePU':function(_0x4ef9d7,_0x5f372d){return _0x4ef9d7===_0x5f372d;}},_0x343d6c=await _0x41a1e0[_0x1b9026(0x156)](calculateFileMD5,_0x13eabc);let _0x1c3003=(await NTQQFileApi[_0x1b9026(0x181)](_0x13eabc))?.[_0x1b9026(0x15c)]||'';_0x1c3003&&(_0x1c3003=_0x41a1e0[_0x1b9026(0x17b)]('.',_0x1c3003));let _0x5af45c=''+_0xc33a9e[_0x1b9026(0x14d)](_0x13eabc);_0x41a1e0['qCePU'](_0x5af45c[_0x1b9026(0x144)]('.'),-0x1)&&(_0x5af45c+=_0x1c3003);const _0x53f56c=napCatCore[_0x1b9026(0x159)]['getMsgService']()[_0x1b9026(0x155)]({'md5HexStr':_0x343d6c,'fileName':_0x5af45c,'elementType':_0x5c94e5,'elementSubType':_0x263c29,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x13eabc,_0x53f56c);const _0x3fc91e=await NTQQFileApi['getFileSize'](_0x13eabc);return{'md5':_0x343d6c,'fileName':_0x5af45c,'path':_0x53f56c,'fileSize':_0x3fc91e,'ext':_0x1c3003};}static async[_0x55bf23(0x174)](_0x46fce2,_0x41129a,_0x464b01,_0x56c4a5,_0x54d114,_0x2364e1,_0x115766=0x3e8*0x3c*0x2,_0x3ecd86=![]){const _0x1375d7=_0x55bf23,_0xed1a71={'PqYKt':function(_0x3e3bbb,_0x57af12){return _0x3e3bbb===_0x57af12;}};if(_0x2364e1&&_0x194602[_0x1375d7(0x153)](_0x2364e1)){if(_0x3ecd86)try{await _0x51289b[_0x1375d7(0x143)](_0x2364e1);}catch(_0x13648f){}else return _0x2364e1;}return new Promise((_0x48d40e,_0x19dccf)=>{const _0x2b4644=_0x1375d7,_0x11b88c={'lhntQ':function(_0x30ec35,_0x12143f){return _0x30ec35(_0x12143f);}};let _0xb0b014=![];const _0xe10cb3=_0x262dab=>{const _0x30b9d9=_0x309b;if(_0xed1a71[_0x30b9d9(0x15d)](_0x262dab['msgId'],_0x46fce2)){_0xb0b014=!![];let _0x23d81e=_0x262dab[_0x30b9d9(0x168)];if(_0x23d81e[_0x30b9d9(0x169)]('\x5c')){const _0x1ddeb9=sessionConfig[_0x30b9d9(0x16e)];_0x23d81e=_0xc33a9e['join'](_0x1ddeb9,_0x23d81e);}_0x48d40e(_0x23d81e);}};downloadMediaTasks[_0x2b4644(0x170)](randomUUID(),_0xe10cb3),setTimeout(()=>{const _0x44ed5e=_0x2b4644;!_0xb0b014&&_0x11b88c[_0x44ed5e(0x158)](_0x19dccf,_0x44ed5e(0x151));},_0x115766),napCatCore['session'][_0x2b4644(0x188)]()[_0x2b4644(0x14f)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x46fce2,'chatType':_0x41129a,'peerUid':_0x464b01,'elementId':_0x56c4a5,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x54d114});});}static async[_0x55bf23(0x163)](_0x4ed146){const _0x1176cd={'IGetM':function(_0x2f4b40,_0x222650){return _0x2f4b40(_0x222650);},'SinJG':function(_0x344f70,_0x5cd256){return _0x344f70(_0x5cd256);},'mIbVI':function(_0x5c5012,_0x4c23df,_0x993c98){return _0x5c5012(_0x4c23df,_0x993c98);}};return new Promise((_0x4ce4da,_0xca21cb)=>{const _0x1f94f3=_0x309b,_0x4b1d5e={'RRPXL':function(_0x50d35a,_0x5906ca){const _0x347b03=_0x309b;return _0x1176cd[_0x347b03(0x177)](_0x50d35a,_0x5906ca);},'xTSoy':function(_0x338374,_0xe88048){const _0x7df54e=_0x309b;return _0x1176cd[_0x7df54e(0x15a)](_0x338374,_0xe88048);}};_0x1176cd[_0x1f94f3(0x179)](_0x219445,_0x4ed146,(_0x20f474,_0x2cacbf)=>{const _0x24cc09=_0x1f94f3;_0x20f474?_0x4b1d5e[_0x24cc09(0x14c)](_0xca21cb,_0x20f474):_0x4b1d5e['xTSoy'](_0x4ce4da,_0x2cacbf);});});}static async[_0x55bf23(0x161)](_0x28c48c,_0x44e45e){const _0x38bd99=_0x55bf23,_0xbb0ca={'HqPdx':_0x38bd99(0x166),'tsKWI':_0x38bd99(0x150),'LjnmI':function(_0x2ee5bd,_0x142dd7){return _0x2ee5bd+_0x142dd7;},'fWupX':function(_0x132ac9,_0x168f18){return _0x132ac9+_0x168f18;},'GJpwf':function(_0x3d307e,_0x4cfba1){return _0x3d307e+_0x4cfba1;},'UAvVb':function(_0x3cecd2,_0x300f1e){return _0x3cecd2||_0x300f1e;},'ZYcOT':function(_0x1e4689,_0x1e8111,_0x2cd1fb){return _0x1e4689(_0x1e8111,_0x2cd1fb);},'VCkwo':_0x38bd99(0x17d)};if(!_0x28c48c)return'';const _0x4a6639=_0x28c48c[_0x38bd99(0x162)],_0xa7b803=_0x28c48c[_0x38bd99(0x17c)],_0x3aea04=_0x28c48c[_0x38bd99(0x17c)],_0x2fafc3=_0x28c48c['fileUuid'];if(_0x4a6639){if(_0x4a6639[_0x38bd99(0x169)](_0xbb0ca[_0x38bd99(0x15b)])){if(_0x4a6639['includes'](_0xbb0ca[_0x38bd99(0x14e)]))return _0xbb0ca[_0x38bd99(0x14b)](IMAGE_HTTP_HOST_NT,_0x4a6639);const _0x56fa09=await rkeyManager[_0x38bd99(0x148)](),_0x3c1d94=_0x44e45e?_0x56fa09[_0x38bd99(0x16d)]:_0x56fa09['group_rkey'];return _0xbb0ca['fWupX'](IMAGE_HTTP_HOST_NT,_0x4a6639)+(''+_0x3c1d94);}else return _0xbb0ca['GJpwf'](IMAGE_HTTP_HOST,_0x4a6639);}else{if(_0x3aea04||_0xa7b803)return IMAGE_HTTP_HOST+_0x38bd99(0x180)+_0xbb0ca[_0x38bd99(0x17f)](_0x3aea04,_0xa7b803)[_0x38bd99(0x16f)]()+'/0';}return _0xbb0ca[_0x38bd99(0x149)](logDebug,_0xbb0ca[_0x38bd99(0x167)],_0x28c48c),'';}}export class NTQQFileCacheApi{static async[_0x55bf23(0x185)](_0x4e0f0a=!![]){return'';}static[_0x55bf23(0x16b)](){return'';}static[_0x55bf23(0x157)](_0x100042=['tmp',_0x55bf23(0x16a)]){const _0x53d34d=_0x55bf23;return napCatCore[_0x53d34d(0x159)][_0x53d34d(0x152)]()[_0x53d34d(0x173)](_0x100042);}static[_0x55bf23(0x15f)](_0x8bbaa4={}){const _0x1f9779=_0x55bf23;return napCatCore[_0x1f9779(0x159)][_0x1f9779(0x152)]()['addCacheScanedPaths'](_0x8bbaa4);}static[_0x55bf23(0x160)](){const _0x13e780=_0x55bf23;return napCatCore[_0x13e780(0x159)][_0x13e780(0x152)]()[_0x13e780(0x160)]();}static[_0x55bf23(0x186)](){return'';}static[_0x55bf23(0x154)](){return'';}static[_0x55bf23(0x147)](_0x3d0d96,_0x11ad84=0x3e8,_0x4e3358=0x0){const _0x137aae=_0x55bf23;return napCatCore[_0x137aae(0x159)][_0x137aae(0x152)]()[_0x137aae(0x164)](_0x3d0d96,_0x11ad84,0x1,_0x4e3358);}static[_0x55bf23(0x165)](_0x34ce1a,_0x5b0f11=0x3e8,_0x455d1d){const _0x440dd8=_0x455d1d?_0x455d1d:{'fileType':_0x34ce1a};}static async[_0x55bf23(0x18b)](_0xf3d61e=[],_0x48cb84=[]){const _0x15d1cb=_0x55bf23;return napCatCore[_0x15d1cb(0x159)][_0x15d1cb(0x152)]()[_0x15d1cb(0x189)](_0xf3d61e,_0x48cb84);}}