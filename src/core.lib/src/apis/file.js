const _0x1911c7=_0x2327;(function(_0x4c7219,_0x1dd3ab){const _0x104cdb=_0x2327,_0x4a73ce=_0x4c7219();while(!![]){try{const _0x24dc5a=-parseInt(_0x104cdb(0xd4))/0x1*(-parseInt(_0x104cdb(0xe3))/0x2)+parseInt(_0x104cdb(0xab))/0x3*(parseInt(_0x104cdb(0xfb))/0x4)+-parseInt(_0x104cdb(0xde))/0x5+parseInt(_0x104cdb(0xbd))/0x6+-parseInt(_0x104cdb(0xe2))/0x7+parseInt(_0x104cdb(0xf2))/0x8+-parseInt(_0x104cdb(0xb9))/0x9*(parseInt(_0x104cdb(0xc1))/0xa);if(_0x24dc5a===_0x1dd3ab)break;else _0x4a73ce['push'](_0x4a73ce['shift']());}catch(_0xa41ef2){_0x4a73ce['push'](_0x4a73ce['shift']());}}}(_0x56ab,0xb7be0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x58b3e8 from'path';import _0x4d4d02 from'fs';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x23f643 from'file-type';import{MsgListener}from'@/core/listeners';function _0x2327(_0xcb58a0,_0x1d32f3){const _0x56ab44=_0x56ab();return _0x2327=function(_0x2327f8,_0x9a771d){_0x2327f8=_0x2327f8-0xa9;let _0x5616c3=_0x56ab44[_0x2327f8];return _0x5616c3;},_0x2327(_0xcb58a0,_0x1d32f3);}import _0x4ab2b1 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x56ab(){const _0x4faf17=['fXqxs','WHEdZ','sourcePath','hookApi\x20is\x20not\x20available','fileUuid','MqFUP','find','existsSync','UznGl','message','msgId','md5HexStr','request','QNDKu','teOKj','end','awoqI','3EaXBps','JHKzo','pathname','catch','setCacheSilentScan','getHotUpdateCachePath','filePath','hotUpdate','mNqMH','WqFMp','Check\x20rkey\x20headers:\x20','getDesktopTmpPath','indexOf','uaQnF','36qjdHBd','getChatCacheInfo','KAfNY','获取图片rkey...','8493588JtOuyw','sNzJV','session','getImageSize','2122760aoLqCw','getStorageCleanService','clearChatCache','destroy','ext','getRKey','scanCache','/download','util','ccpGg','GET','QXCAW','toUpperCase','host','onRichMediaDownloadComplete','addCacheScannedPaths','CbVAi','uploadFile','setTimeout','717BPfUgQ','originImageUrl','getFileSize','fileTypeFromFile','JTtEL','getFileCacheInfo','picElement','UCYIp','getMsgService','JFdBf','2533055ptqkBn','PIC','defaultFileDownloadPath','UbMxg','4212054WhGJBX','1396sONgzr','hcxxm','获取图片rkey失败','nKZFr','aLspY','then','startsWith','图片rkey获取成功','downloadRichMedia','chatType','*/*','includes','EYpIk','copyFile','cvFLC','6249552PxRXGJ','PFYgn','getFileType','获取rkey失败','UMcaM','stringify','isAvailable','getImageUrl','now','51148LVzYTq','tmp','Mozilla/5.0\x20(Windows\x20NT\x2010.0;\x20Win64;\x20x64)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/58.0.3029.110\x20Safari/537.36','下载超时','removeKernelMsgListener','statusCode','addListener','getCacheSessionPathList','Gomgf','oYcEu','HCoTY','Check\x20rkey\x20request\x20time:','&rkey=','getChatCacheList','clearChatCacheInfo','peerUid','error','join','jHeEG','The\x20image\x20URL\x20is\x20not\x20accessible.','IQGBW'];_0x56ab=function(){return _0x4faf17;};return _0x56ab();}import _0x4be4f4 from'http';import{hookApi}from'@/core/external/hook';import{sleep}from'@/common/utils/helper';let privateImageRKey='',groupImageRKey='';export class NTQQFileApi{static async['getFileType'](_0x528c64){const _0x227f45=_0x2327;return _0x23f643[_0x227f45(0xd7)](_0x528c64);}static async[_0x1911c7(0xf0)](_0x2d44a5,_0x3f5868){const _0x8e5d7a=_0x1911c7;await napCatCore[_0x8e5d7a(0xc9)][_0x8e5d7a(0xf0)](_0x2d44a5,_0x3f5868);}static async[_0x1911c7(0xd6)](_0xd1d021){return await napCatCore['util']['getFileSize'](_0xd1d021);}static async[_0x1911c7(0xd2)](_0x2484f7,_0x1923c0=ElementType[_0x1911c7(0xdf)],_0x507e13=0x0){const _0x39fc22=_0x1911c7,_0x2e2f91={'WFWVG':function(_0x4154ff,_0x1339c6){return _0x4154ff(_0x1339c6);},'TCGQT':function(_0x2d6c84,_0x3b513b){return _0x2d6c84+_0x3b513b;},'WHEdZ':function(_0x168085,_0x474e93){return _0x168085===_0x474e93;}},_0x3f1c58=await _0x2e2f91['WFWVG'](calculateFileMD5,_0x2484f7);let _0x1ee1dc=(await NTQQFileApi[_0x39fc22(0xf4)](_0x2484f7))?.[_0x39fc22(0xc5)]||'';_0x1ee1dc&&(_0x1ee1dc=_0x2e2f91['TCGQT']('.',_0x1ee1dc));let _0x41fcfd=''+_0x58b3e8['basename'](_0x2484f7);_0x2e2f91[_0x39fc22(0x111)](_0x41fcfd[_0x39fc22(0xb7)]('.'),-0x1)&&(_0x41fcfd+=_0x1ee1dc);const _0x469019=napCatCore['session']['getMsgService']()['getRichMediaFilePathForGuild']({'md5HexStr':_0x3f1c58,'fileName':_0x41fcfd,'elementType':_0x1923c0,'elementSubType':_0x507e13,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x39fc22(0xf0)](_0x2484f7,_0x469019);const _0x1b731b=await NTQQFileApi[_0x39fc22(0xd6)](_0x2484f7);return{'md5':_0x3f1c58,'fileName':_0x41fcfd,'path':_0x469019,'fileSize':_0x1b731b,'ext':_0x1ee1dc};}static async['downloadMedia'](_0x462fd8,_0x3757bd,_0x4f9958,_0x381284,_0x91f75,_0x3edc07,_0x2a153e=0x3e8*0x3c*0x2,_0x295cbe=![]){const _0x130dd3=_0x1911c7,_0x2fd6b8={'uaQnF':function(_0x1ccb44,_0x33783d){return _0x1ccb44(_0x33783d);},'aLspY':function(_0x3754d2,_0x3f9b94,_0x4d0f3b){return _0x3754d2(_0x3f9b94,_0x4d0f3b);}};if(_0x3edc07&&_0x4d4d02[_0x130dd3(0x117)](_0x3edc07)){if(_0x295cbe)_0x4d4d02['unlinkSync'](_0x3edc07);else return _0x3edc07;}const _0xf536ef=new MsgListener();return new Promise((_0x3634ef,_0x1f90d9)=>{const _0x14dee1=_0x130dd3,_0x314e57={'jHeEG':function(_0x4bb16c,_0x19f5b1){return _0x4bb16c===_0x19f5b1;},'ZbULS':function(_0x364e81,_0x5bb4ca){const _0x507032=_0x2327;return _0x2fd6b8[_0x507032(0xb8)](_0x364e81,_0x5bb4ca);},'awoqI':_0x14dee1(0xfe)};let _0x4553a1=![];_0xf536ef[_0x14dee1(0xcf)]=_0x48df96=>{const _0x11b1d5=_0x14dee1;if(_0x314e57[_0x11b1d5(0x10d)](_0x48df96[_0x11b1d5(0x11a)],_0x462fd8)){_0x4553a1=!![];let _0x6cc11f=_0x48df96[_0x11b1d5(0xb1)];if(_0x6cc11f[_0x11b1d5(0xe9)]('\x5c')){const _0x1127d7=sessionConfig?.[_0x11b1d5(0xe0)];_0x6cc11f=_0x58b3e8[_0x11b1d5(0x10c)](_0x1127d7,_0x6cc11f);}_0x314e57['ZbULS'](_0x3634ef,_0x6cc11f),napCatCore[_0x11b1d5(0xbf)][_0x11b1d5(0xdc)]()[_0x11b1d5(0xff)](_0xe46f58);}};const _0xe46f58=napCatCore[_0x14dee1(0x101)](_0xf536ef);_0x2fd6b8[_0x14dee1(0xe7)](setTimeout,()=>{const _0x591450=_0x14dee1;!_0x4553a1&&(_0x1f90d9(new Error(_0x314e57[_0x591450(0xaa)])),napCatCore[_0x591450(0xbf)]['getMsgService']()[_0x591450(0xff)](_0xe46f58));},_0x2a153e),napCatCore['session'][_0x14dee1(0xdc)]()[_0x14dee1(0xeb)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x462fd8,'chatType':_0x3757bd,'peerUid':_0x4f9958,'elementId':_0x381284,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x91f75});});}static async[_0x1911c7(0xc0)](_0x5d521a){return new Promise((_0xc8e010,_0x27b6a2)=>{_0x4ab2b1(_0x5d521a,(_0x57a19c,_0x8033da)=>{_0x57a19c?_0x27b6a2(_0x57a19c):_0xc8e010(_0x8033da);});});}static async[_0x1911c7(0xf9)](_0x7556eb){const _0x53166c=_0x1911c7,_0x484c27={'Gomgf':function(_0x17bbba,_0x909388){return _0x17bbba(_0x909388);},'UMcaM':function(_0x295a65,_0x53ee25){return _0x295a65(_0x53ee25);},'cvFLC':function(_0x7b013,_0x59f32,_0x1f6e6a){return _0x7b013(_0x59f32,_0x1f6e6a);},'fXqxs':_0x53166c(0xea),'ccpGg':function(_0x2b01ea,_0x505ead){return _0x2b01ea(_0x505ead);},'VZxeH':_0x53166c(0x10e),'YLpsF':_0x53166c(0xcb),'QNDKu':_0x53166c(0xfd),'IQGBW':_0x53166c(0xed),'nKZFr':'bytes=0-0','sNzJV':'error','JidBk':_0x53166c(0x107),'HCoTY':function(_0x43ee55,_0x1f9aa5){return _0x43ee55+_0x1f9aa5;},'oYcEu':_0x53166c(0x113),'UznGl':function(_0x17a8e7,_0x149f66){return _0x17a8e7!==_0x149f66;},'WqFMp':'appid=1406','Oxgqi':_0x53166c(0xe5),'teOKj':function(_0x3f8875,_0x3d5a90){return _0x3f8875+_0x3d5a90;},'UCYIp':function(_0x297064,_0x51d715){return _0x297064+_0x51d715;},'KAfNY':_0x53166c(0x106),'PFYgn':function(_0x8c93ff){return _0x8c93ff();},'JFdBf':function(_0x3d2319,_0xc9f6cb){return _0x3d2319+_0xc9f6cb;},'CbVAi':function(_0x661554,_0xb1e5b2,_0x434a25){return _0x661554(_0xb1e5b2,_0x434a25);},'MqFUP':_0x53166c(0xf5),'kwoBP':function(_0x48980e,_0x1d6e0a){return _0x48980e+_0x1d6e0a;},'JTtEL':function(_0x3a5715,_0x1812ab){return _0x3a5715||_0x1812ab;}},_0x13ac31=_0x7556eb['elements'][_0x53166c(0x116)](_0x4bfa22=>!!_0x4bfa22[_0x53166c(0xda)]);if(!_0x13ac31)return'';const _0x494513=_0x13ac31[_0x53166c(0xda)][_0x53166c(0xd5)],_0x389b50=_0x13ac31[_0x53166c(0xda)][_0x53166c(0x11b)],_0x5acfd1=_0x13ac31[_0x53166c(0xda)]['md5HexStr'],_0x29b860=_0x13ac31[_0x53166c(0xda)][_0x53166c(0x114)];let _0x43f2e5='';if(_0x494513){if(_0x494513[_0x53166c(0xe9)](_0x53166c(0xc8))){if(_0x494513[_0x53166c(0xee)](_0x484c27['JidBk']))_0x43f2e5=_0x484c27[_0x53166c(0x105)](IMAGE_HTTP_HOST_NT,_0x494513);else{if(!hookApi[_0x53166c(0xf8)]())return _0x484c27['ccpGg'](logDebug,_0x484c27[_0x53166c(0x104)]),'';let _0x4ac124=![];_0x484c27[_0x53166c(0x118)](_0x494513['indexOf'](_0x484c27[_0x53166c(0xb4)]),-0x1)&&(_0x4ac124=!![]);let _0x5f311d='';_0x4ac124?_0x5f311d=privateImageRKey:_0x5f311d=groupImageRKey;_0x5f311d=_0x5f311d||hookApi['getRKey']();const _0x5a16cc=async()=>{const _0x3efaf4=_0x53166c;_0x484c27[_0x3efaf4(0x103)](logDebug,_0x3efaf4(0xbc)),NTQQFileApi['downloadMedia'](_0x7556eb['msgId'],_0x7556eb[_0x3efaf4(0xec)],_0x7556eb[_0x3efaf4(0x10a)],_0x13ac31['elementId'],'',_0x13ac31[_0x3efaf4(0xda)][_0x3efaf4(0x112)],0x3e8,!![])[_0x3efaf4(0xe8)]()[_0x3efaf4(0xae)](()=>{}),await _0x484c27['UMcaM'](sleep,0x12c);const _0x350a71=hookApi[_0x3efaf4(0xc6)]();if(_0x350a71)return _0x484c27[_0x3efaf4(0xf1)](logDebug,_0x484c27[_0x3efaf4(0x110)],_0x350a71),_0x350a71;};if(!_0x5f311d)try{await _0x5a16cc();}catch(_0x46f7e6){return logError(_0x484c27['Oxgqi'],_0x46f7e6),'';}_0x43f2e5=_0x484c27[_0x53166c(0x11e)](_0x484c27[_0x53166c(0xdb)](IMAGE_HTTP_HOST_NT,_0x494513),''+_0x5f311d);const _0x10a4fd=new Promise((_0x5ae352,_0x308b52)=>{const _0x2a4e1d=_0x53166c,_0x3a9e31={'mNqMH':function(_0x5e1cdf,_0x45e7f2){const _0xcfbed3=_0x2327;return _0x484c27[_0xcfbed3(0x103)](_0x5e1cdf,_0x45e7f2);},'EYpIk':function(_0xf5ca1b,_0x332310){return _0xf5ca1b==_0x332310;},'QXCAW':function(_0x5b23c6,_0x502f03){return _0x5b23c6===_0x502f03;},'hcxxm':function(_0x35eeaa,_0x2bcde3){const _0x5ec7fa=_0x2327;return _0x484c27[_0x5ec7fa(0xca)](_0x35eeaa,_0x2bcde3);},'JHKzo':function(_0x550bdf,_0x5afa24){const _0xfe115d=_0x2327;return _0x484c27[_0xfe115d(0xf6)](_0x550bdf,_0x5afa24);},'UbMxg':_0x484c27['VZxeH'],'HKzck':function(_0x1933d1,_0x3a720d){return _0x1933d1(_0x3a720d);}},_0x52de16=new URL(_0x43f2e5),_0x517467={'method':_0x484c27['YLpsF'],'host':_0x52de16[_0x2a4e1d(0xce)],'path':_0x52de16[_0x2a4e1d(0xad)]+_0x52de16['search'],'headers':{'User-Agent':_0x484c27[_0x2a4e1d(0x11d)],'Accept':_0x484c27[_0x2a4e1d(0x10f)],'Range':_0x484c27[_0x2a4e1d(0xe6)]}},_0x2f69a4=_0x4be4f4[_0x2a4e1d(0x11c)](_0x517467,_0xdf2bc1=>{const _0x51e372=_0x2a4e1d;_0x3a9e31[_0x51e372(0xb3)](logDebug,'Check\x20rkey\x20status:\x20'+_0xdf2bc1['statusCode']),_0x3a9e31['mNqMH'](logDebug,_0x51e372(0xb5)+JSON[_0x51e372(0xf7)](_0xdf2bc1['headers'])),_0x3a9e31[_0x51e372(0xef)](_0xdf2bc1[_0x51e372(0x100)],0xc8)||_0x3a9e31[_0x51e372(0xcc)](_0xdf2bc1[_0x51e372(0x100)],0xce)?_0x3a9e31[_0x51e372(0xe4)](_0x5ae352,'ok'):_0x3a9e31[_0x51e372(0xac)](_0x308b52,_0x3a9e31[_0x51e372(0xe1)]);});_0x2f69a4[_0x2a4e1d(0xd3)](0xbb8,()=>{const _0x88784d=_0x2a4e1d;_0x2f69a4[_0x88784d(0xc4)](),_0x3a9e31['HKzck'](_0x308b52,'Check\x20rkey\x20request\x20timed\x20out');}),_0x2f69a4['on'](_0x484c27[_0x2a4e1d(0xbe)],_0x57e406=>{const _0x2ef60a=_0x2a4e1d;console[_0x2ef60a(0x10b)]('Problem\x20with\x20rkey\x20request:\x20'+_0x57e406[_0x2ef60a(0x119)]),_0x308b52(_0x57e406[_0x2ef60a(0x119)]);}),_0x2f69a4[_0x2a4e1d(0xa9)]();});try{const _0x294213=Date['now']();await _0x10a4fd;const _0x57af39=Date[_0x53166c(0xfa)]();_0x4ac124?privateImageRKey=_0x5f311d:groupImageRKey=_0x5f311d,_0x484c27['cvFLC'](logDebug,_0x484c27[_0x53166c(0xbb)],_0x57af39-_0x294213);}catch(_0x558b2d){try{await _0x484c27[_0x53166c(0xf3)](_0x5a16cc),_0x43f2e5=_0x484c27[_0x53166c(0xdd)](IMAGE_HTTP_HOST_NT+_0x494513,''+_0x5f311d);}catch(_0x3a0274){_0x484c27[_0x53166c(0xd1)](logError,_0x484c27[_0x53166c(0x115)],_0x3a0274);}}}}else _0x43f2e5=_0x484c27['kwoBP'](IMAGE_HTTP_HOST,_0x494513);}else _0x484c27[_0x53166c(0xd8)](_0x5acfd1,_0x389b50)&&(_0x43f2e5=IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x484c27[_0x53166c(0xd8)](_0x5acfd1,_0x389b50)[_0x53166c(0xcd)]()+'/0');return _0x43f2e5;}}export class NTQQFileCacheApi{static async[_0x1911c7(0xaf)](_0x23829d=!![]){return'';}static[_0x1911c7(0x102)](){return'';}static['clearCache'](_0x2d0e34=[_0x1911c7(0xfc),_0x1911c7(0xb2)]){const _0x4132e3=_0x1911c7;return napCatCore[_0x4132e3(0xbf)][_0x4132e3(0xc2)]()['clearCacheDataByKeys'](_0x2d0e34);}static[_0x1911c7(0xd0)](_0x9566a3={}){const _0x471b30=_0x1911c7;return napCatCore['session'][_0x471b30(0xc2)]()['addCacheScanedPaths'](_0x9566a3);}static[_0x1911c7(0xc7)](){const _0x427f0d=_0x1911c7;return napCatCore[_0x427f0d(0xbf)]['getStorageCleanService']()[_0x427f0d(0xc7)]();}static[_0x1911c7(0xb0)](){return'';}static[_0x1911c7(0xb6)](){return'';}static[_0x1911c7(0x108)](_0x3eccda,_0x2e5c8e=0x3e8,_0x1be313=0x0){const _0x2e19e4=_0x1911c7;return napCatCore[_0x2e19e4(0xbf)][_0x2e19e4(0xc2)]()[_0x2e19e4(0xba)](_0x3eccda,_0x2e5c8e,0x1,_0x1be313);}static[_0x1911c7(0xd9)](_0x357130,_0x1fa994=0x3e8,_0x452cf2){const _0x374a5d=_0x452cf2?_0x452cf2:{'fileType':_0x357130};}static async[_0x1911c7(0xc3)](_0x4c314d=[],_0x2b1d26=[]){const _0x20eda5=_0x1911c7;return napCatCore[_0x20eda5(0xbf)][_0x20eda5(0xc2)]()[_0x20eda5(0x109)](_0x4c314d,_0x2b1d26);}}