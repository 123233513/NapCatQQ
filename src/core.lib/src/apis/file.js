const _0xe831c1=_0x3c3a;(function(_0x19b383,_0x57ccb8){const _0x27caeb=_0x3c3a,_0x235dcd=_0x19b383();while(!![]){try{const _0x455040=parseInt(_0x27caeb(0x190))/0x1+parseInt(_0x27caeb(0x181))/0x2*(-parseInt(_0x27caeb(0x148))/0x3)+parseInt(_0x27caeb(0x17e))/0x4*(-parseInt(_0x27caeb(0x17a))/0x5)+parseInt(_0x27caeb(0x183))/0x6*(parseInt(_0x27caeb(0x161))/0x7)+-parseInt(_0x27caeb(0x14f))/0x8+parseInt(_0x27caeb(0x15c))/0x9*(-parseInt(_0x27caeb(0x16b))/0xa)+parseInt(_0x27caeb(0x189))/0xb;if(_0x455040===_0x57ccb8)break;else _0x235dcd['push'](_0x235dcd['shift']());}catch(_0x32a5e0){_0x235dcd['push'](_0x235dcd['shift']());}}}(_0x5e3c,0xdbc39));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1aaaef from'path';import _0x3d137d from'fs';import _0x1075a2 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0x5e3c(){const _0x48a923=['6WLgVsf','onLoginSuccess','chatType','clearChatCache','getFileType','addCacheScannedPaths','existsSync','401768MZsxBW','getRichMediaService','basename','downloadRichMedia','tmp','fileUuid','uploadFile','clearCache','getMsgService','hotUpdate','unlink','viERk','scanCache','9HlRAzU','filePath','getFileSize','下载超时','util','57337rLuDGl','join','&rkey=','peerUid','copyFile','private_rkey','getChatCacheList','clearCacheDataByKeys','getStorageCleanService','iAWlF','15756850cxGevH','originImageUrl','/download','msgId','clearChatCacheInfo','GPZMh','ext','getImageUrl','indexOf','addListener','elementId','md5HexStr','toUpperCase','PIC','delete','7967945NXScHH','startsWith','urlResult','NapEA','4BMuZwJ','domainUrl','HbPDZ','457426JpMZFH','XdEXK','636VPCKQN','downloadMedia','addCacheScanedPaths','getHotUpdateCachePath','session','getImageSize','37843905IKgBfW','includes','onRichMediaDownloadComplete','defaultFileDownloadPath','QvzJV','vIfqV','pYzlw','268473kweWmP'];_0x5e3c=function(){return _0x48a923;};return _0x5e3c();}import*as _0x321324 from'file-type';import{MsgListener}from'@/core/listeners';import _0x7d3f2f from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0xe831c1(0x18b)]=_0x4c6ef7=>{const _0xc37a7f=_0xe831c1,_0x211930={'SJRte':function(_0x1e4b05,_0x1c6d7f){return _0x1e4b05(_0x1c6d7f);}};for(const [_0x4d55d1,_0x49810f]of downloadMediaTasks){_0x211930['SJRte'](_0x49810f,_0x4c6ef7),downloadMediaTasks[_0xc37a7f(0x179)](_0x4d55d1);}},setTimeout(()=>{const _0x13ea30=_0xe831c1;napCatCore[_0x13ea30(0x149)](()=>{const _0x5e0d4e=_0x13ea30;napCatCore[_0x5e0d4e(0x174)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x760ee4){return _0x321324['fileTypeFromFile'](_0x760ee4);}static async[_0xe831c1(0x165)](_0x83e01e,_0x10f333){const _0x30be8c=_0xe831c1;await napCatCore[_0x30be8c(0x160)][_0x30be8c(0x165)](_0x83e01e,_0x10f333);}static async[_0xe831c1(0x15e)](_0x46648c){return await napCatCore['util']['getFileSize'](_0x46648c);}static async['getVideoUrl'](_0x504992,_0x3b49eb){const _0x388782=_0xe831c1;return(await napCatCore[_0x388782(0x187)][_0x388782(0x150)]()['getVideoPlayUrlV2']({'chatType':_0x504992[_0x388782(0x14a)],'peerUid':_0x504992[_0x388782(0x164)],'guildId':'0'},_0x504992[_0x388782(0x16e)],_0x3b49eb[_0x388782(0x175)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x388782(0x17c)][_0x388782(0x17f)][0x0]['url'];}static async[_0xe831c1(0x155)](_0x4bf859,_0x45d055=ElementType[_0xe831c1(0x178)],_0x501a96=0x0){const _0x3d335d=_0xe831c1,_0x2f551c={'QvzJV':function(_0x3c7058,_0x2c2580){return _0x3c7058(_0x2c2580);},'vIfqV':function(_0x2c8d1f,_0x16ef7a){return _0x2c8d1f+_0x16ef7a;},'TmTlx':function(_0x1abd50,_0x577a1f){return _0x1abd50===_0x577a1f;}},_0x2b4be1=await _0x2f551c[_0x3d335d(0x18d)](calculateFileMD5,_0x4bf859);let _0x5b23d=(await NTQQFileApi[_0x3d335d(0x14c)](_0x4bf859))?.[_0x3d335d(0x171)]||'';_0x5b23d&&(_0x5b23d=_0x2f551c[_0x3d335d(0x18e)]('.',_0x5b23d));let _0x26146c=''+_0x1aaaef[_0x3d335d(0x151)](_0x4bf859);_0x2f551c['TmTlx'](_0x26146c[_0x3d335d(0x173)]('.'),-0x1)&&(_0x26146c+=_0x5b23d);const _0x30ce61=napCatCore[_0x3d335d(0x187)][_0x3d335d(0x157)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x2b4be1,'fileName':_0x26146c,'elementType':_0x45d055,'elementSubType':_0x501a96,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x3d335d(0x165)](_0x4bf859,_0x30ce61);const _0x117798=await NTQQFileApi[_0x3d335d(0x15e)](_0x4bf859);return{'md5':_0x2b4be1,'fileName':_0x26146c,'path':_0x30ce61,'fileSize':_0x117798,'ext':_0x5b23d};}static async[_0xe831c1(0x184)](_0x1e4e58,_0x412df5,_0x4b28ab,_0x48ef9f,_0x3812ff,_0x2b29a9,_0x5c9a9d=0x3e8*0x3c*0x2,_0x2c7fa2=![]){const _0x5b3c5c=_0xe831c1,_0x29e6d4={'HbPDZ':function(_0x28d620,_0x55f2ad){return _0x28d620(_0x55f2ad);},'NapEA':function(_0x44d8d9,_0x597919,_0x33e825){return _0x44d8d9(_0x597919,_0x33e825);}};if(_0x2b29a9&&_0x3d137d[_0x5b3c5c(0x14e)](_0x2b29a9)){if(_0x2c7fa2)try{await _0x1075a2[_0x5b3c5c(0x159)](_0x2b29a9);}catch(_0x543ec2){}else return _0x2b29a9;}return new Promise((_0xe26beb,_0x3f83e9)=>{const _0x3c9349=_0x5b3c5c;let _0x5dc214=![];const _0x5bf33b=_0x4f13ef=>{const _0x4a6cd2=_0x3c3a;if(_0x4f13ef[_0x4a6cd2(0x16e)]===_0x1e4e58){_0x5dc214=!![];let _0xddc884=_0x4f13ef[_0x4a6cd2(0x15d)];if(_0xddc884['startsWith']('\x5c')){const _0x5150e8=sessionConfig[_0x4a6cd2(0x18c)];_0xddc884=_0x1aaaef[_0x4a6cd2(0x162)](_0x5150e8,_0xddc884);}_0x29e6d4[_0x4a6cd2(0x180)](_0xe26beb,_0xddc884);}};downloadMediaTasks['set'](randomUUID(),_0x5bf33b),_0x29e6d4[_0x3c9349(0x17d)](setTimeout,()=>{const _0x49c71e=_0x3c9349;!_0x5dc214&&_0x29e6d4['HbPDZ'](_0x3f83e9,_0x49c71e(0x15f));},_0x5c9a9d),napCatCore['session'][_0x3c9349(0x157)]()[_0x3c9349(0x152)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x1e4e58,'chatType':_0x412df5,'peerUid':_0x4b28ab,'elementId':_0x48ef9f,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3812ff});});}static async[_0xe831c1(0x188)](_0x575218){const _0x59dadf={'cQiwM':function(_0x303c85,_0x135d2d){return _0x303c85(_0x135d2d);},'iAWlF':function(_0x539eaf,_0x4e6e35){return _0x539eaf(_0x4e6e35);},'XdEXK':function(_0x5ad38f,_0x5857a6,_0x5ecb08){return _0x5ad38f(_0x5857a6,_0x5ecb08);}};return new Promise((_0x148921,_0x1d80b7)=>{const _0x376c19=_0x3c3a;_0x59dadf[_0x376c19(0x182)](_0x7d3f2f,_0x575218,(_0x467464,_0x55e119)=>{const _0x55090f=_0x376c19;_0x467464?_0x59dadf['cQiwM'](_0x1d80b7,_0x467464):_0x59dadf[_0x55090f(0x16a)](_0x148921,_0x55e119);});});}static async[_0xe831c1(0x172)](_0x2a1749,_0x5d2885){const _0x30e6a9=_0xe831c1,_0xc1c793={'GPZMh':_0x30e6a9(0x16d),'sKSpg':_0x30e6a9(0x163),'viERk':function(_0x21e4c6,_0x2dc5aa){return _0x21e4c6+_0x2dc5aa;},'lPybu':function(_0x15e75d,_0x474aa8){return _0x15e75d||_0x474aa8;},'pYzlw':function(_0x35fc6f,_0x147ed9,_0x501bf3){return _0x35fc6f(_0x147ed9,_0x501bf3);},'WlGAM':'图片url获取失败'};if(!_0x2a1749)return'';const _0x5ced00=_0x2a1749[_0x30e6a9(0x16c)],_0x419306=_0x2a1749[_0x30e6a9(0x176)],_0x3e2d44=_0x2a1749['md5HexStr'],_0x4c12d9=_0x2a1749[_0x30e6a9(0x154)];if(_0x5ced00){if(_0x5ced00[_0x30e6a9(0x17b)](_0xc1c793[_0x30e6a9(0x170)])){if(_0x5ced00[_0x30e6a9(0x18a)](_0xc1c793['sKSpg']))return IMAGE_HTTP_HOST_NT+_0x5ced00;const _0x33016c=await rkeyManager['getRkey'](),_0x557976=_0x5d2885?_0x33016c[_0x30e6a9(0x166)]:_0x33016c['group_rkey'];return _0xc1c793[_0x30e6a9(0x15a)](IMAGE_HTTP_HOST_NT,_0x5ced00)+(''+_0x557976);}else return _0xc1c793['viERk'](IMAGE_HTTP_HOST,_0x5ced00);}else{if(_0x3e2d44||_0x419306)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0xc1c793['lPybu'](_0x3e2d44,_0x419306)[_0x30e6a9(0x177)]()+'/0';}return _0xc1c793[_0x30e6a9(0x18f)](logDebug,_0xc1c793['WlGAM'],_0x2a1749),'';}}function _0x3c3a(_0x3f1c16,_0x33df6e){const _0x5e3cb9=_0x5e3c();return _0x3c3a=function(_0x3c3a96,_0x5d5b34){_0x3c3a96=_0x3c3a96-0x148;let _0x3c9589=_0x5e3cb9[_0x3c3a96];return _0x3c9589;},_0x3c3a(_0x3f1c16,_0x33df6e);}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x3e70c5=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0xe831c1(0x156)](_0x59fb9e=[_0xe831c1(0x153),_0xe831c1(0x158)]){const _0x3a8afb=_0xe831c1;return napCatCore[_0x3a8afb(0x187)][_0x3a8afb(0x169)]()[_0x3a8afb(0x168)](_0x59fb9e);}static[_0xe831c1(0x14d)](_0x335812={}){const _0x36458a=_0xe831c1;return napCatCore[_0x36458a(0x187)][_0x36458a(0x169)]()[_0x36458a(0x185)](_0x335812);}static[_0xe831c1(0x15b)](){const _0x4c729c=_0xe831c1;return napCatCore[_0x4c729c(0x187)][_0x4c729c(0x169)]()[_0x4c729c(0x15b)]();}static[_0xe831c1(0x186)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0xe831c1(0x167)](_0xcfb7d6,_0x4977f1=0x3e8,_0x228257=0x0){const _0xb3d467=_0xe831c1;return napCatCore[_0xb3d467(0x187)][_0xb3d467(0x169)]()['getChatCacheInfo'](_0xcfb7d6,_0x4977f1,0x1,_0x228257);}static['getFileCacheInfo'](_0x4732b1,_0x47cd6e=0x3e8,_0x40f4c7){const _0xd6336a=_0x40f4c7?_0x40f4c7:{'fileType':_0x4732b1};}static async[_0xe831c1(0x14b)](_0x70530b=[],_0x487a6b=[]){const _0x35b7f9=_0xe831c1;return napCatCore[_0x35b7f9(0x187)][_0x35b7f9(0x169)]()[_0x35b7f9(0x16f)](_0x70530b,_0x487a6b);}}