const _0x187a19=_0x2448;(function(_0x55bf36,_0x234cbc){const _0x114f7a=_0x2448,_0x5b4656=_0x55bf36();while(!![]){try{const _0x576306=-parseInt(_0x114f7a(0x1c3))/0x1+-parseInt(_0x114f7a(0x1dc))/0x2*(-parseInt(_0x114f7a(0x1a0))/0x3)+-parseInt(_0x114f7a(0x1ac))/0x4+-parseInt(_0x114f7a(0x1bd))/0x5*(parseInt(_0x114f7a(0x1c2))/0x6)+parseInt(_0x114f7a(0x1d9))/0x7*(-parseInt(_0x114f7a(0x1b4))/0x8)+-parseInt(_0x114f7a(0x1a3))/0x9*(parseInt(_0x114f7a(0x1cb))/0xa)+-parseInt(_0x114f7a(0x19e))/0xb*(-parseInt(_0x114f7a(0x1a8))/0xc);if(_0x576306===_0x234cbc)break;else _0x5b4656['push'](_0x5b4656['shift']());}catch(_0x16613e){_0x5b4656['push'](_0x5b4656['shift']());}}}(_0x4e96,0xeb235));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x54c9d4 from'path';import _0x506249 from'fs';import _0x4607c7 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';function _0x2448(_0x3cb1e0,_0x5a045d){const _0x4e9644=_0x4e96();return _0x2448=function(_0x24487,_0x38bdc4){_0x24487=_0x24487-0x19c;let _0x1038bd=_0x4e9644[_0x24487];return _0x1038bd;},_0x2448(_0x3cb1e0,_0x5a045d);}import{calculateFileMD5}from'@/common/utils/file';import*as _0x4584d7 from'file-type';import{MsgListener}from'@/core/listeners';import _0x32dfec from'image-size';function _0x4e96(){const _0x1b589b=['getDesktopTmpPath','clearCache','indexOf','1554616OWbiQx','getCacheSessionPathList','scanCache','session','addCacheScanedPaths','DtkpH','getRichMediaFilePathForGuild','onRichMediaDownloadComplete','168OZJPif','nqIBZ','downloadRichMedia','getFileSize','iaVnv','ZvCWS','WUJuJ','acLEO','addCacheScannedPaths','155Tzxars','uploadFile','startsWith','onLoginSuccess','existsSync','100950NxlGMZ','689537ixCmPi','&rkey=','nkYHK','tmp','set','util','SLcKU','md5HexStr','858310SnedQK','getChatCacheInfo','PIC','copyFile','fileTypeFromFile','receive\x20downloadMedia\x20task','clearChatCacheInfo','private_rkey','clearCacheDataByKeys','setCacheSilentScan','tpyjX','getMsgService','downloadPath','originImageUrl','56623nAUXUW','jKFlA','getStorageCleanService','4PgLFPS','fileUuid','clearChatCache','cTYub','图片url获取失败','getImageUrl','defaultFileDownloadPath','BKvRb','basename','lasfG','group_rkey','oAnaJ','hotUpdate','pguYb','253wypNsO','filePath','848457tBUhAj','getFileType','/gchatpic_new/0/0-0-','153rkviBf','getHotUpdateCachePath','getRkey','ext','downloadMedia\x20complete','1891956bWTAbZ'];_0x4e96=function(){return _0x1b589b;};return _0x4e96();}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x187a19(0x1b3)]=_0x2029c7=>{const _0x17962a=_0x187a19,_0x4a6f48={'oAnaJ':function(_0x3c9050,_0x5ac243){return _0x3c9050(_0x5ac243);}};for(const [_0x5f34b0,_0x4cf32f]of downloadMediaTasks){_0x4a6f48[_0x17962a(0x1e7)](_0x4cf32f,_0x2029c7),downloadMediaTasks['delete'](_0x5f34b0);}},setTimeout(()=>{const _0x30f3d0=_0x187a19;napCatCore[_0x30f3d0(0x1c0)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x187a19(0x1a1)](_0x34ccd9){const _0x295984=_0x187a19;return _0x4584d7[_0x295984(0x1cf)](_0x34ccd9);}static async[_0x187a19(0x1ce)](_0x33cbcf,_0x138701){const _0x549346=_0x187a19;await napCatCore[_0x549346(0x1c8)]['copyFile'](_0x33cbcf,_0x138701);}static async['getFileSize'](_0x52204c){const _0x62ad2f=_0x187a19;return await napCatCore['util'][_0x62ad2f(0x1b7)](_0x52204c);}static async[_0x187a19(0x1be)](_0x2ddf8a,_0x236fa3=ElementType[_0x187a19(0x1cd)],_0x448098=0x0){const _0x80e6a2=_0x187a19,_0x4c2bdf={'jKFlA':function(_0x406414,_0x308247){return _0x406414(_0x308247);},'WUJuJ':function(_0x56f079,_0x56e894){return _0x56f079+_0x56e894;}},_0x4bb1d1=await _0x4c2bdf[_0x80e6a2(0x1da)](calculateFileMD5,_0x2ddf8a);let _0x4a4000=(await NTQQFileApi[_0x80e6a2(0x1a1)](_0x2ddf8a))?.[_0x80e6a2(0x1a6)]||'';_0x4a4000&&(_0x4a4000=_0x4c2bdf[_0x80e6a2(0x1ba)]('.',_0x4a4000));let _0x591251=''+_0x54c9d4[_0x80e6a2(0x1e4)](_0x2ddf8a);_0x591251[_0x80e6a2(0x1ab)]('.')===-0x1&&(_0x591251+=_0x4a4000);const _0x215c4b=napCatCore['session'][_0x80e6a2(0x1d6)]()[_0x80e6a2(0x1b2)]({'md5HexStr':_0x4bb1d1,'fileName':_0x591251,'elementType':_0x236fa3,'elementSubType':_0x448098,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x2ddf8a,_0x215c4b);const _0x2ca7fa=await NTQQFileApi['getFileSize'](_0x2ddf8a);return{'md5':_0x4bb1d1,'fileName':_0x591251,'path':_0x215c4b,'fileSize':_0x2ca7fa,'ext':_0x4a4000};}static async['downloadMedia'](_0x7a3e53,_0x1852c9,_0x4d8b0e,_0x2a5ddd,_0xf9cbad,_0x591994,_0x1467ed=0x3e8*0x3c*0x2,_0x43d79b=![]){const _0x268dff=_0x187a19,_0x31b111={'ojHpt':function(_0x4002ca,_0x110ab3,_0x197726,_0x454354){return _0x4002ca(_0x110ab3,_0x197726,_0x454354);},'cTYub':_0x268dff(0x1a7),'ZvCWS':function(_0x1a5332,_0x1fe41d,_0x447750){return _0x1a5332(_0x1fe41d,_0x447750);},'tpyjX':_0x268dff(0x1d7),'nkYHK':function(_0x30947a,_0x38541a){return _0x30947a(_0x38541a);},'pguYb':'下载超时','DtkpH':function(_0xf76f3b){return _0xf76f3b();},'acLEO':function(_0x390bb7,_0x263cde,_0x40dff4,_0x138078,_0x3e7561,_0x1df638,_0x189b56,_0x366462,_0x55ab4a,_0x418fea){return _0x390bb7(_0x263cde,_0x40dff4,_0x138078,_0x3e7561,_0x1df638,_0x189b56,_0x366462,_0x55ab4a,_0x418fea);}};_0x31b111[_0x268dff(0x1bb)](logDebug,_0x268dff(0x1d0),_0x7a3e53,_0x1852c9,_0x4d8b0e,_0x2a5ddd,_0xf9cbad,_0x591994,_0x1467ed,_0x43d79b);if(_0x591994&&_0x506249[_0x268dff(0x1c1)](_0x591994)){if(_0x43d79b)try{await _0x4607c7['unlink'](_0x591994);}catch(_0x3bcf29){}else return _0x591994;}return logDebug('start\x20downloadMedia',_0x7a3e53,_0x1852c9,_0x4d8b0e,_0x2a5ddd,_0xf9cbad,_0x591994,_0x1467ed,_0x43d79b),new Promise((_0x571e35,_0x207ed7)=>{const _0x43e62f=_0x268dff;let _0x18d20b=![];const _0x1cc3c8=_0x386646=>{const _0x3d5130=_0x2448;_0x31b111['ojHpt'](logDebug,_0x31b111[_0x3d5130(0x1df)],_0x386646,_0x7a3e53);if(_0x386646['msgId']===_0x7a3e53){_0x18d20b=!![];let _0x5935d3=_0x386646[_0x3d5130(0x19f)];if(_0x5935d3[_0x3d5130(0x1bf)]('\x5c')){const _0x38a9c6=sessionConfig[_0x3d5130(0x1e2)];_0x31b111[_0x3d5130(0x1b9)](logDebug,_0x31b111[_0x3d5130(0x1d5)],_0x38a9c6),_0x5935d3=_0x54c9d4['join'](_0x38a9c6,_0x5935d3);}_0x31b111[_0x3d5130(0x1c5)](_0x571e35,_0x5935d3);}};downloadMediaTasks[_0x43e62f(0x1c7)](_0x31b111[_0x43e62f(0x1b1)](randomUUID),_0x1cc3c8),setTimeout(()=>{const _0x4fdf57=_0x43e62f;!_0x18d20b&&_0x31b111[_0x4fdf57(0x1c5)](_0x207ed7,_0x31b111[_0x4fdf57(0x19d)]);},_0x1467ed),napCatCore[_0x43e62f(0x1af)][_0x43e62f(0x1d6)]()[_0x43e62f(0x1b6)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x7a3e53,'chatType':_0x1852c9,'peerUid':_0x4d8b0e,'elementId':_0x2a5ddd,'thumbSize':0x0,'downloadType':0x1,'filePath':_0xf9cbad});});}static async['getImageSize'](_0x521974){const _0x362c48={'MWExB':function(_0x15a68c,_0x4bf9cc){return _0x15a68c(_0x4bf9cc);}};return new Promise((_0x3f7a2a,_0x3e794b)=>{const _0x4fc65c={'boTMb':function(_0x17a37c,_0x30451c){return _0x362c48['MWExB'](_0x17a37c,_0x30451c);},'iaVnv':function(_0x300c97,_0x313a7b){return _0x300c97(_0x313a7b);}};_0x32dfec(_0x521974,(_0x518767,_0x17eee2)=>{const _0x3e0332=_0x2448;_0x518767?_0x4fc65c['boTMb'](_0x3e794b,_0x518767):_0x4fc65c[_0x3e0332(0x1b8)](_0x3f7a2a,_0x17eee2);});});}static async[_0x187a19(0x1e1)](_0x5871fb,_0x1c8e93){const _0x34c779=_0x187a19,_0x1ab759={'nqIBZ':_0x34c779(0x1c4),'BKvRb':function(_0xc98c1f,_0x5910f1){return _0xc98c1f+_0x5910f1;},'FZbgW':function(_0x3eaa46,_0x5d559f){return _0x3eaa46||_0x5d559f;},'lasfG':function(_0xb6ae59,_0x257db4,_0x9bf43d){return _0xb6ae59(_0x257db4,_0x9bf43d);},'SLcKU':_0x34c779(0x1e0)};if(!_0x5871fb)return'';const _0x3c826f=_0x5871fb[_0x34c779(0x1d8)],_0x5ad3ce=_0x5871fb['md5HexStr'],_0x9c25ad=_0x5871fb[_0x34c779(0x1ca)],_0x155df9=_0x5871fb[_0x34c779(0x1dd)];if(_0x3c826f){if(_0x3c826f[_0x34c779(0x1bf)]('/download')){if(_0x3c826f['includes'](_0x1ab759[_0x34c779(0x1b5)]))return _0x1ab759['BKvRb'](IMAGE_HTTP_HOST_NT,_0x3c826f);const _0x3998ac=await rkeyManager[_0x34c779(0x1a5)](),_0x17252b=_0x1c8e93?_0x3998ac[_0x34c779(0x1d2)]:_0x3998ac[_0x34c779(0x1e6)];return _0x1ab759['BKvRb'](IMAGE_HTTP_HOST_NT,_0x3c826f)+(''+_0x17252b);}else return _0x1ab759[_0x34c779(0x1e3)](IMAGE_HTTP_HOST,_0x3c826f);}else{if(_0x9c25ad||_0x5ad3ce)return IMAGE_HTTP_HOST+_0x34c779(0x1a2)+_0x1ab759['FZbgW'](_0x9c25ad,_0x5ad3ce)['toUpperCase']()+'/0';}return _0x1ab759[_0x34c779(0x1e5)](logDebug,_0x1ab759[_0x34c779(0x1c9)],_0x5871fb),'';}}export class NTQQFileCacheApi{static async[_0x187a19(0x1d4)](_0x286fe1=!![]){return'';}static[_0x187a19(0x1ad)](){return'';}static[_0x187a19(0x1aa)](_0x5466da=[_0x187a19(0x1c6),_0x187a19(0x19c)]){const _0x533bb1=_0x187a19;return napCatCore[_0x533bb1(0x1af)]['getStorageCleanService']()[_0x533bb1(0x1d3)](_0x5466da);}static[_0x187a19(0x1bc)](_0x34aa83={}){const _0x33cf97=_0x187a19;return napCatCore['session']['getStorageCleanService']()[_0x33cf97(0x1b0)](_0x34aa83);}static['scanCache'](){const _0x14bbd9=_0x187a19;return napCatCore[_0x14bbd9(0x1af)]['getStorageCleanService']()[_0x14bbd9(0x1ae)]();}static[_0x187a19(0x1a4)](){return'';}static[_0x187a19(0x1a9)](){return'';}static['getChatCacheList'](_0xd5fa9a,_0xe6bf37=0x3e8,_0x229287=0x0){const _0x310e8e=_0x187a19;return napCatCore[_0x310e8e(0x1af)][_0x310e8e(0x1db)]()[_0x310e8e(0x1cc)](_0xd5fa9a,_0xe6bf37,0x1,_0x229287);}static['getFileCacheInfo'](_0x3f6a8d,_0x5adf9e=0x3e8,_0x594847){const _0x5ec836=_0x594847?_0x594847:{'fileType':_0x3f6a8d};}static async[_0x187a19(0x1de)](_0x310b75=[],_0x3bbe65=[]){const _0x1d3fb5=_0x187a19;return napCatCore[_0x1d3fb5(0x1af)][_0x1d3fb5(0x1db)]()[_0x1d3fb5(0x1d1)](_0x310b75,_0x3bbe65);}}