const _0x56d86a=_0x33a2;function _0x33a2(_0x19ca1e,_0xd558a4){const _0x5edafe=_0x5eda();return _0x33a2=function(_0x33a2be,_0x47aa6a){_0x33a2be=_0x33a2be-0x1cb;let _0x39ce49=_0x5edafe[_0x33a2be];return _0x39ce49;},_0x33a2(_0x19ca1e,_0xd558a4);}(function(_0x165e1f,_0x264f58){const _0x2cc75e=_0x33a2,_0x477624=_0x165e1f();while(!![]){try{const _0x17e968=parseInt(_0x2cc75e(0x236))/0x1*(-parseInt(_0x2cc75e(0x202))/0x2)+-parseInt(_0x2cc75e(0x1e3))/0x3+parseInt(_0x2cc75e(0x1d6))/0x4*(-parseInt(_0x2cc75e(0x21f))/0x5)+-parseInt(_0x2cc75e(0x1ee))/0x6+-parseInt(_0x2cc75e(0x215))/0x7+-parseInt(_0x2cc75e(0x1d5))/0x8*(parseInt(_0x2cc75e(0x1e2))/0x9)+parseInt(_0x2cc75e(0x21b))/0xa;if(_0x17e968===_0x264f58)break;else _0x477624['push'](_0x477624['shift']());}catch(_0x59d7fd){_0x477624['push'](_0x477624['shift']());}}}(_0x5eda,0x6a397));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x3dfdac from'path';import _0x6fa697 from'fs';import _0xee625b from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x69f22 from'file-type';import{MsgListener}from'@/core/listeners';import _0x44a3c8 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0xd0cfd3 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;function _0x5eda(){const _0x21a05f=['chatType','evzQQ','filePath','下载超时','startsWith','56084zdJBnE','mYBCH','图片url获取失败','vrmzj','ZEfpl','woNxD','getImageSize','DBTcI','kRRBz','sourcePath','getDesktopTmpPath','peerUid','kWzvQ','set','find','getImageUrl','downloadPath','tmp','geFsK','msgId','isAvailable','scanCache','session','getCacheSessionPathList','3848VcSUtH','960708mzpNQn','图片rkey有效','/gchatpic_new/0/0-0-','getChatCacheInfo','HabTp','md5HexStr','originImageUrl','onRichMediaDownloadComplete','setCacheSilentScan','getRKey','getFileType','jQSFa','9711OUWkgQ','296772EFJOow','fileUuid','ChDzc','nJEdK','图片rkey获取失败','dvlHo','fileTypeFromFile','downloadMedia','OBAGb','QOrVZ','cLYNx','3890136iNhOgE','statusCode','cnclT','hKALh','ZaHUt','QfuyZ','copyFile','uYseF','vNPVR','getMsgService','elementId','WnzpA','addCacheScanedPaths','getChatCacheList','fjVIt','now','oovlW','zPfjs','downloadMedia\x20complete','unlink','4btLITg','clearCache','includes','图片rkey有误','onLoginSuccess','picElement','QRlDC','Wbprg','&rkey=','jhzTt','RJjuW','getFileSize','defaultFileDownloadPath','indexOf','receive\x20downloadMedia\x20task','vYVCW','getStorageCleanService','start\x20downloadMedia','error','2369787aIPdZQ','then','Spbeo','getRichMediaFilePathForGuild','util','fRwcT','23922600FaGmTL','uploadFile','basename','existsSync','5dQMiWw','addTask','检查rkey是否有效','ext','toUpperCase','/download','downloadRichMedia','clearCacheDataByKeys','delete','hotUpdate','rdYpd','addCacheScannedPaths','cYUKw','mVoMp','clearChatCache','xfoNt','hookApi\x20is\x20not\x20available','UYVaT'];_0x5eda=function(){return _0x21a05f;};return _0x5eda();}const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x56d86a(0x1dd)]=_0x195b4f=>{const _0x18b9d8=_0x56d86a,_0x3534e8={'ZEfpl':function(_0x130657,_0x3600ff){return _0x130657(_0x3600ff);}};for(const [_0x2c336c,_0x2a3c85]of downloadMediaTasks){_0x3534e8[_0x18b9d8(0x23a)](_0x2a3c85,_0x195b4f),downloadMediaTasks[_0x18b9d8(0x227)](_0x2c336c);}},setTimeout(()=>{const _0x17a8cd=_0x56d86a;napCatCore[_0x17a8cd(0x206)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x56d86a(0x1e0)](_0x2fefa7){const _0x552318=_0x56d86a;return _0x69f22[_0x552318(0x1e9)](_0x2fefa7);}static async['copyFile'](_0x2ac97f,_0x48d731){const _0x5f2cad=_0x56d86a;await napCatCore[_0x5f2cad(0x219)][_0x5f2cad(0x1f4)](_0x2ac97f,_0x48d731);}static async[_0x56d86a(0x20d)](_0x3eb2d3){const _0x4bf076=_0x56d86a;return await napCatCore[_0x4bf076(0x219)][_0x4bf076(0x20d)](_0x3eb2d3);}static async[_0x56d86a(0x21c)](_0x5c7af6,_0x5c81d8=ElementType['PIC'],_0x5b3d14=0x0){const _0x3288ae=_0x56d86a,_0x309132={'tLaxU':function(_0x3e9eb8,_0x40b0a4){return _0x3e9eb8(_0x40b0a4);},'UYVaT':function(_0x1c5860,_0x2a76a1){return _0x1c5860===_0x2a76a1;}},_0x5e19a7=await _0x309132['tLaxU'](calculateFileMD5,_0x5c7af6);let _0x3edc53=(await NTQQFileApi[_0x3288ae(0x1e0)](_0x5c7af6))?.[_0x3288ae(0x222)]||'';_0x3edc53&&(_0x3edc53='.'+_0x3edc53);let _0x377567=''+_0x3dfdac[_0x3288ae(0x21d)](_0x5c7af6);_0x309132[_0x3288ae(0x230)](_0x377567[_0x3288ae(0x20f)]('.'),-0x1)&&(_0x377567+=_0x3edc53);const _0x21031b=napCatCore[_0x3288ae(0x1d3)][_0x3288ae(0x1f7)]()[_0x3288ae(0x218)]({'md5HexStr':_0x5e19a7,'fileName':_0x377567,'elementType':_0x5c81d8,'elementSubType':_0x5b3d14,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x3288ae(0x1f4)](_0x5c7af6,_0x21031b);const _0x4d3be3=await NTQQFileApi[_0x3288ae(0x20d)](_0x5c7af6);return{'md5':_0x5e19a7,'fileName':_0x377567,'path':_0x21031b,'fileSize':_0x4d3be3,'ext':_0x3edc53};}static async[_0x56d86a(0x1ea)](_0x508b36,_0x2b9f16,_0x577413,_0x33b7b3,_0x108b55,_0x138686,_0x25606c=0x3e8*0x3c*0x2,_0x3c8eb7=![]){const _0x22e017=_0x56d86a,_0x1bb6a0={'fjVIt':function(_0x335c4f,_0xf01e05){return _0x335c4f(_0xf01e05);},'zPfjs':_0x22e017(0x234),'Wbprg':function(_0x4b408b,_0x25814f,_0xe64462,_0x1a4879){return _0x4b408b(_0x25814f,_0xe64462,_0x1a4879);},'RJjuW':_0x22e017(0x200),'oovlW':function(_0x468603,_0x5c1b2c,_0x478b23){return _0x468603(_0x5c1b2c,_0x478b23);},'diTyT':function(_0x1a76fd,_0x3f7927){return _0x1a76fd(_0x3f7927);},'WnzpA':function(_0x48d2d3,_0x67ed02,_0x2eb8b7,_0x78b76d,_0x4784d1,_0x5944e8,_0x590497,_0x24498e,_0x641bfd,_0x21b3d4){return _0x48d2d3(_0x67ed02,_0x2eb8b7,_0x78b76d,_0x4784d1,_0x5944e8,_0x590497,_0x24498e,_0x641bfd,_0x21b3d4);},'lZzJk':_0x22e017(0x210),'dvlHo':_0x22e017(0x213)};_0x1bb6a0[_0x22e017(0x1f9)](logDebug,_0x1bb6a0['lZzJk'],_0x508b36,_0x2b9f16,_0x577413,_0x33b7b3,_0x108b55,_0x138686,_0x25606c,_0x3c8eb7);if(_0x138686&&_0x6fa697[_0x22e017(0x21e)](_0x138686)){if(_0x3c8eb7)try{await _0xee625b[_0x22e017(0x201)](_0x138686);}catch(_0x665ddd){}else return _0x138686;}return logDebug(_0x1bb6a0[_0x22e017(0x1e8)],_0x508b36,_0x2b9f16,_0x577413,_0x33b7b3,_0x108b55,_0x138686,_0x25606c,_0x3c8eb7),new Promise((_0x1bd799,_0x1423f1)=>{const _0x456c63=_0x22e017,_0x42fc2d={'vrmzj':function(_0x1b85ab,_0xd7e864,_0x50ff48,_0x110260){const _0x3c2742=_0x33a2;return _0x1bb6a0[_0x3c2742(0x209)](_0x1b85ab,_0xd7e864,_0x50ff48,_0x110260);},'cLYNx':_0x1bb6a0[_0x456c63(0x20c)],'cnclT':function(_0x541ad4,_0xc89c87,_0x4f85ff){const _0x38a6c0=_0x456c63;return _0x1bb6a0[_0x38a6c0(0x1fe)](_0x541ad4,_0xc89c87,_0x4f85ff);},'kRRBz':_0x456c63(0x1cd),'evzQQ':function(_0x262e0b,_0x233985){return _0x1bb6a0['diTyT'](_0x262e0b,_0x233985);}};let _0x81e45b=![];const _0x5a7f57=_0x1bc96c=>{const _0x4be45b=_0x456c63;_0x42fc2d[_0x4be45b(0x239)](logDebug,_0x42fc2d[_0x4be45b(0x1ed)],_0x1bc96c,_0x508b36);if(_0x1bc96c['msgId']===_0x508b36){_0x81e45b=!![];let _0x2b1d75=_0x1bc96c[_0x4be45b(0x233)];if(_0x2b1d75[_0x4be45b(0x235)]('\x5c')){const _0x34a524=sessionConfig[_0x4be45b(0x20e)];_0x42fc2d[_0x4be45b(0x1f0)](logDebug,_0x42fc2d[_0x4be45b(0x23e)],_0x34a524),_0x2b1d75=_0x3dfdac['join'](_0x34a524,_0x2b1d75);}_0x42fc2d[_0x4be45b(0x232)](_0x1bd799,_0x2b1d75);}};downloadMediaTasks[_0x456c63(0x243)](randomUUID(),_0x5a7f57),setTimeout(()=>{const _0x2ef6fb=_0x456c63;!_0x81e45b&&_0x1bb6a0[_0x2ef6fb(0x1fc)](_0x1423f1,_0x1bb6a0[_0x2ef6fb(0x1ff)]);},_0x25606c),napCatCore[_0x456c63(0x1d3)][_0x456c63(0x1f7)]()[_0x456c63(0x225)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x508b36,'chatType':_0x2b9f16,'peerUid':_0x577413,'elementId':_0x33b7b3,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x108b55});});}static async[_0x56d86a(0x23c)](_0x4992b2){const _0x272e5c={'OBAGb':function(_0x16c1a1,_0x222991){return _0x16c1a1(_0x222991);},'qijsU':function(_0x534387,_0x11b104,_0x447620){return _0x534387(_0x11b104,_0x447620);}};return new Promise((_0x402f68,_0x1113ff)=>{const _0x264476={'cYUKw':function(_0x52ae1c,_0x166877){return _0x52ae1c(_0x166877);},'rdYpd':function(_0x14cc31,_0x44fca1){const _0x2d60ce=_0x33a2;return _0x272e5c[_0x2d60ce(0x1eb)](_0x14cc31,_0x44fca1);}};_0x272e5c['qijsU'](_0x44a3c8,_0x4992b2,(_0x1641ba,_0x38d41a)=>{const _0xdcc681=_0x33a2;_0x1641ba?_0x264476[_0xdcc681(0x22b)](_0x1113ff,_0x1641ba):_0x264476[_0xdcc681(0x229)](_0x402f68,_0x38d41a);});});}static async[_0x56d86a(0x1cc)](_0xb94571){const _0x5f0164=_0x56d86a,_0x216f12={'Spbeo':function(_0xe72776,_0x357fe6){return _0xe72776!==_0x357fe6;},'nJEdK':function(_0x2a2d5c,_0x4e2603){return _0x2a2d5c(_0x4e2603);},'fRwcT':_0x5f0164(0x214),'leGql':function(_0xbdb706,_0x4fd85d){return _0xbdb706(_0x4fd85d);},'jQSFa':'获取图片rkey...','QfuyZ':function(_0x2c7664,_0x3e9151){return _0x2c7664*_0x3e9151;},'ChDzc':'开始调用moeHook获取rkey','woNxD':function(_0x4ec2db,_0x30107e){return _0x4ec2db+_0x30107e;},'RqjXy':function(_0x49fd3d,_0x27c0e1,_0x3bd867){return _0x49fd3d(_0x27c0e1,_0x3bd867);},'QOrVZ':function(_0xe177b1,_0x5dbb80,_0x86c38b){return _0xe177b1(_0x5dbb80,_0x86c38b);},'cOlHN':_0x5f0164(0x1d7),'kWzvQ':function(_0x5516b9,_0x363c43,_0x3b0e6e,_0x5dce88){return _0x5516b9(_0x363c43,_0x3b0e6e,_0x5dce88);},'wbluW':_0x5f0164(0x205),'QRlDC':_0x5f0164(0x20a),'geFsK':_0x5f0164(0x22f),'HabTp':function(_0x5a4fc9,_0x63cbdb){return _0x5a4fc9-_0x63cbdb;},'BhDdK':_0x5f0164(0x1e7),'vNPVR':function(_0x31fa06,_0x47959b){return _0x31fa06+_0x47959b;},'jhzTt':function(_0x4c7770,_0x588b44){return _0x4c7770||_0x588b44;},'vYVCW':function(_0x54c69f,_0x1fc133){return _0x54c69f||_0x1fc133;},'mYBCH':_0x5f0164(0x238)},_0x81c921=_0x216f12[_0x5f0164(0x217)](_0xb94571[_0x5f0164(0x231)],ChatType['group']),_0x4d7d5f=_0xb94571['elements'][_0x5f0164(0x1cb)](_0x1579b8=>!!_0x1579b8[_0x5f0164(0x207)]);if(!_0x4d7d5f)return'';const _0x4300dd=_0x4d7d5f[_0x5f0164(0x207)][_0x5f0164(0x1dc)],_0x507dd3=_0x4d7d5f['picElement']['md5HexStr'],_0xe58b0b=_0x4d7d5f[_0x5f0164(0x207)][_0x5f0164(0x1db)],_0x2c835d=_0x4d7d5f['picElement'][_0x5f0164(0x1e4)],_0x290180=_0x22614f=>{const _0x4035c9=_0x5f0164;_0x81c921?(privateImageRKey=_0x22614f,lastGetPrivateRKeyTime=Date[_0x4035c9(0x1fd)]()):(groupImageRKey=_0x22614f,lastGetGroupRKeyTime=Date[_0x4035c9(0x1fd)]());};if(_0x4300dd){if(_0x4300dd[_0x5f0164(0x235)](_0x5f0164(0x224))){if(_0x4300dd[_0x5f0164(0x204)](_0x216f12[_0x5f0164(0x208)]))return IMAGE_HTTP_HOST_NT+_0x4300dd;if(!hookApi[_0x5f0164(0x1d1)]())return logDebug(_0x216f12[_0x5f0164(0x1cf)]),'';const _0x32da34=async()=>{const _0x16e023=_0x5f0164,_0xe77f1={'mVoMp':function(_0x53877f,_0x1aaddf){return _0x216f12['Spbeo'](_0x53877f,_0x1aaddf);},'xfoNt':function(_0x9e6197,_0x1744fd){return _0x9e6197(_0x1744fd);},'uYseF':function(_0x3af8f8,_0x47e140){const _0x5b0627=_0x33a2;return _0x216f12[_0x5b0627(0x1e6)](_0x3af8f8,_0x47e140);},'DBTcI':_0x216f12[_0x16e023(0x21a)]};_0x216f12['leGql'](logDebug,_0x216f12[_0x16e023(0x1e1)]),NTQQFileApi[_0x16e023(0x1ea)](_0xb94571[_0x16e023(0x1d0)],_0xb94571['chatType'],_0xb94571[_0x16e023(0x241)],_0x4d7d5f[_0x16e023(0x1f8)],'',_0x4d7d5f[_0x16e023(0x207)][_0x16e023(0x23f)],_0x216f12[_0x16e023(0x1f3)](0x3e8,0x1e),![])[_0x16e023(0x216)](_0xab70f8=>{})['catch'](logError),await sleep(0x3e8),logDebug(_0x216f12[_0x16e023(0x1e5)]);const _0x528d01=hookApi[_0x16e023(0x1df)]()||'',_0x4ab6e7=_0x216f12['woNxD'](_0x216f12[_0x16e023(0x23b)](IMAGE_HTTP_HOST_NT,_0x4300dd),_0x528d01);if(_0x528d01)try{_0x216f12['RqjXy'](logDebug,_0x16e023(0x221),_0x4ab6e7),await new Promise((_0x399c44,_0x2648d3)=>{const _0x2736d2=_0x16e023,_0x58780c={'zobcH':function(_0x557223,_0x575e20){const _0x3e04a2=_0x33a2;return _0xe77f1[_0x3e04a2(0x22c)](_0x557223,_0x575e20);},'ZaHUt':function(_0x483fc6,_0x448b74){const _0x2245a7=_0x33a2;return _0xe77f1[_0x2245a7(0x22e)](_0x483fc6,_0x448b74);},'hKALh':function(_0x15d9bb,_0x10f3a1){const _0xcbf7d0=_0x33a2;return _0xe77f1[_0xcbf7d0(0x1f5)](_0x15d9bb,_0x10f3a1);}};_0xd0cfd3['get'](_0x4ab6e7,_0x486913=>{const _0x4c2a9f=_0x33a2;_0x58780c['zobcH'](_0x486913[_0x4c2a9f(0x1ef)],0xc8)?_0x2648d3(_0x4c2a9f(0x1e7)):_0x58780c[_0x4c2a9f(0x1f2)](_0x399c44,_0x486913);})['on'](_0xe77f1[_0x2736d2(0x23d)],_0x3ed27a=>{const _0x3761b6=_0x2736d2;_0x58780c[_0x3761b6(0x1f1)](_0x2648d3,_0x3ed27a);});}),_0x216f12[_0x16e023(0x1ec)](logDebug,_0x216f12['cOlHN'],_0x4ab6e7),_0x290180(_0x528d01);}catch(_0x11380d){return _0x216f12[_0x16e023(0x242)](logError,_0x216f12['wbluW'],_0x4ab6e7,_0x11380d),'';}return _0x528d01;},_0x5514e8=new Promise((_0x348846,_0x516a7d)=>{const _0x44939a=_0x5f0164;getRKeyTaskQueue[_0x44939a(0x220)](async()=>{const _0xef5a5c=await _0x32da34();_0x348846(_0xef5a5c);});}),_0x49d044=_0x81c921?privateImageRKey:groupImageRKey,_0x50cf0f=_0x81c921?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x216f12[_0x5f0164(0x1da)](Date[_0x5f0164(0x1fd)](),_0x50cf0f)>rkeyExpireTime||!_0x49d044){const _0x2f4572=await _0x5514e8;if(_0x2f4572)return _0x216f12[_0x5f0164(0x23b)](_0x216f12[_0x5f0164(0x23b)](IMAGE_HTTP_HOST_NT,_0x4300dd),''+_0x2f4572);else _0x216f12['QOrVZ'](logError,_0x216f12['BhDdK'],_0x4300dd);}if(_0x49d044)return _0x216f12[_0x5f0164(0x1f6)](IMAGE_HTTP_HOST_NT,_0x4300dd)+(''+_0x49d044);return'';}else return IMAGE_HTTP_HOST+_0x4300dd;}else{if(_0x216f12[_0x5f0164(0x20b)](_0xe58b0b,_0x507dd3))return IMAGE_HTTP_HOST+_0x5f0164(0x1d8)+_0x216f12[_0x5f0164(0x211)](_0xe58b0b,_0x507dd3)[_0x5f0164(0x223)]()+'/0';}return logDebug(_0x216f12[_0x5f0164(0x237)],_0xb94571),'';}}export class NTQQFileCacheApi{static async[_0x56d86a(0x1de)](_0x18eb56=!![]){return'';}static[_0x56d86a(0x1d4)](){return'';}static[_0x56d86a(0x203)](_0x631881=[_0x56d86a(0x1ce),_0x56d86a(0x228)]){const _0x45ed0b=_0x56d86a;return napCatCore[_0x45ed0b(0x1d3)][_0x45ed0b(0x212)]()[_0x45ed0b(0x226)](_0x631881);}static[_0x56d86a(0x22a)](_0x9f349a={}){const _0x355ce2=_0x56d86a;return napCatCore[_0x355ce2(0x1d3)][_0x355ce2(0x212)]()[_0x355ce2(0x1fa)](_0x9f349a);}static[_0x56d86a(0x1d2)](){const _0x392537=_0x56d86a;return napCatCore[_0x392537(0x1d3)]['getStorageCleanService']()['scanCache']();}static['getHotUpdateCachePath'](){return'';}static[_0x56d86a(0x240)](){return'';}static[_0x56d86a(0x1fb)](_0x27c747,_0x43d3b8=0x3e8,_0x11a7e5=0x0){const _0x3ff4e0=_0x56d86a;return napCatCore[_0x3ff4e0(0x1d3)]['getStorageCleanService']()[_0x3ff4e0(0x1d9)](_0x27c747,_0x43d3b8,0x1,_0x11a7e5);}static['getFileCacheInfo'](_0x510545,_0x1b26b4=0x3e8,_0x2cd347){const _0x4613a9=_0x2cd347?_0x2cd347:{'fileType':_0x510545};}static async[_0x56d86a(0x22d)](_0x38cd25=[],_0x4d6c2a=[]){const _0x806ff3=_0x56d86a;return napCatCore[_0x806ff3(0x1d3)]['getStorageCleanService']()['clearChatCacheInfo'](_0x38cd25,_0x4d6c2a);}}