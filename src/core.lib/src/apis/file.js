const _0xfe7002=_0x4c2e;(function(_0x178723,_0x1583fc){const _0x509318=_0x4c2e,_0x3ce3ce=_0x178723();while(!![]){try{const _0x247b12=-parseInt(_0x509318(0x112))/0x1*(parseInt(_0x509318(0x12d))/0x2)+parseInt(_0x509318(0x110))/0x3+parseInt(_0x509318(0x11c))/0x4*(-parseInt(_0x509318(0x10d))/0x5)+-parseInt(_0x509318(0x11a))/0x6+-parseInt(_0x509318(0x116))/0x7*(parseInt(_0x509318(0x143))/0x8)+-parseInt(_0x509318(0x147))/0x9+parseInt(_0x509318(0x140))/0xa*(parseInt(_0x509318(0x10c))/0xb);if(_0x247b12===_0x1583fc)break;else _0x3ce3ce['push'](_0x3ce3ce['shift']());}catch(_0xc5186){_0x3ce3ce['push'](_0x3ce3ce['shift']());}}}(_0x1bc1,0x781f9));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x1644b3 from'path';import _0x21872b from'fs';import _0x12640f from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0x4c2e(_0x3d0c23,_0x5a7840){const _0x1bc117=_0x1bc1();return _0x4c2e=function(_0x4c2e5f,_0x4dfc18){_0x4c2e5f=_0x4c2e5f-0x107;let _0xab47ac=_0x1bc117[_0x4c2e5f];return _0xab47ac;},_0x4c2e(_0x3d0c23,_0x5a7840);}import*as _0x156d13 from'file-type';import{MsgListener}from'@/core/listeners';import _0x4b0dde from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x197a30=>{const _0x3de97f=_0x4c2e,_0x578305={'aickB':function(_0x563b5a,_0x43695f){return _0x563b5a(_0x43695f);}};for(const [_0x15ec7f,_0x33e00a]of downloadMediaTasks){_0x578305[_0x3de97f(0x108)](_0x33e00a,_0x197a30),downloadMediaTasks[_0x3de97f(0x11e)](_0x15ec7f);}},setTimeout(()=>{const _0x23c034=_0x4c2e;napCatCore[_0x23c034(0x133)](()=>{const _0x200fa5=_0x23c034;napCatCore[_0x200fa5(0x136)](downloadMediaListener);});},0x64);function _0x1bc1(){const _0x28bc01=['UBCdR','WCrDY','start\x20downloadMedia','addCacheScannedPaths','aickB','startsWith','clearCacheDataByKeys','copyFile','78760GDKPuC','15vvMsuC','iteiL','getImageSize','2267001CKrHlX','ext','673fJOZoc','private_rkey','getStorageCleanService','getRichMediaFilePathForGuild','32739UsVAjr','drQnD','util','GDQxH','3599940qVRbJL','addCacheScanedPaths','1257332HuxXcs','group_rkey','delete','VcZvY','getCacheSessionPathList','filePath','fileUuid','RYEKs','hotUpdate','existsSync','unlink','GiTbo','defaultFileDownloadPath','downloadMedia\x20complete','set','myHFV','indexOf','170LSxreq','clearCache','clearChatCache','getMsgService','getRkey','tBqdE','onLoginSuccess','md5HexStr','wfakq','addListener','&rkey=','getChatCacheList','scanCache','xbMzS','getChatCacheInfo','lQlXG','session','图片url获取失败','join','3760RwnvdC','msgId','/gchatpic_new/0/0-0-','1488DlGooD','getImageUrl','uploadFile','getFileCacheInfo','4371174yMbNHk','getFileType','getFileSize','Ivyff','JjFpk','clearChatCacheInfo','receive\x20downloadMedia\x20task','cXITX','getDesktopTmpPath','downloadRichMedia','JXUsn'];_0x1bc1=function(){return _0x28bc01;};return _0x1bc1();}export class NTQQFileApi{static async[_0xfe7002(0x148)](_0x582c86){return _0x156d13['fileTypeFromFile'](_0x582c86);}static async[_0xfe7002(0x10b)](_0x295f8c,_0xc49003){const _0x19e38b=_0xfe7002;await napCatCore['util'][_0x19e38b(0x10b)](_0x295f8c,_0xc49003);}static async[_0xfe7002(0x149)](_0x33335e){const _0x3713b7=_0xfe7002;return await napCatCore[_0x3713b7(0x118)][_0x3713b7(0x149)](_0x33335e);}static async[_0xfe7002(0x145)](_0x4f954c,_0x50b908=ElementType['PIC'],_0x597a84=0x0){const _0x16a942=_0xfe7002,_0x311dce={'bpMEI':function(_0x5f5ac7,_0x34ca69){return _0x5f5ac7(_0x34ca69);},'xbMzS':function(_0x212e3a,_0x1a1491){return _0x212e3a+_0x1a1491;}},_0x5c01c8=await _0x311dce['bpMEI'](calculateFileMD5,_0x4f954c);let _0x320729=(await NTQQFileApi[_0x16a942(0x148)](_0x4f954c))?.[_0x16a942(0x111)]||'';_0x320729&&(_0x320729=_0x311dce[_0x16a942(0x13a)]('.',_0x320729));let _0x3e2009=''+_0x1644b3['basename'](_0x4f954c);_0x3e2009[_0x16a942(0x12c)]('.')===-0x1&&(_0x3e2009+=_0x320729);const _0x3aa322=napCatCore[_0x16a942(0x13d)][_0x16a942(0x130)]()[_0x16a942(0x115)]({'md5HexStr':_0x5c01c8,'fileName':_0x3e2009,'elementType':_0x50b908,'elementSubType':_0x597a84,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x16a942(0x10b)](_0x4f954c,_0x3aa322);const _0x2b2d30=await NTQQFileApi['getFileSize'](_0x4f954c);return{'md5':_0x5c01c8,'fileName':_0x3e2009,'path':_0x3aa322,'fileSize':_0x2b2d30,'ext':_0x320729};}static async['downloadMedia'](_0xa39a27,_0x4fc0d4,_0x552cff,_0x51bf55,_0x5046e6,_0x12f0d2,_0x144156=0x3e8*0x3c*0x2,_0x5bfb0b=![]){const _0x46a7c7=_0xfe7002,_0x38df2e={'WCrDY':function(_0x16b7e4,_0x41247a,_0x450f7f,_0x4b2bd3){return _0x16b7e4(_0x41247a,_0x450f7f,_0x4b2bd3);},'UBCdR':function(_0x34b618,_0x4f5135){return _0x34b618===_0x4f5135;},'GDQxH':function(_0xd0e06f,_0x580b9f,_0x5a44fa){return _0xd0e06f(_0x580b9f,_0x5a44fa);},'jUfel':'downloadPath','wfakq':function(_0x1110a3,_0x1cf593){return _0x1110a3(_0x1cf593);},'Ivyff':function(_0x48f1f3){return _0x48f1f3();},'lQlXG':function(_0x26f63b,_0x3054a6,_0x232fda,_0x4839dc,_0x24c5f7,_0x1d5e5c,_0x59cdff,_0x2a748b,_0x1ad7d4,_0x35db1c){return _0x26f63b(_0x3054a6,_0x232fda,_0x4839dc,_0x24c5f7,_0x1d5e5c,_0x59cdff,_0x2a748b,_0x1ad7d4,_0x35db1c);},'GiTbo':_0x46a7c7(0x14d),'drQnD':_0x46a7c7(0x154)};_0x38df2e[_0x46a7c7(0x13c)](logDebug,_0x38df2e[_0x46a7c7(0x127)],_0xa39a27,_0x4fc0d4,_0x552cff,_0x51bf55,_0x5046e6,_0x12f0d2,_0x144156,_0x5bfb0b);if(_0x12f0d2&&_0x21872b[_0x46a7c7(0x125)](_0x12f0d2)){if(_0x5bfb0b)try{await _0x12640f[_0x46a7c7(0x126)](_0x12f0d2);}catch(_0x2d62f9){}else return _0x12f0d2;}return _0x38df2e[_0x46a7c7(0x13c)](logDebug,_0x38df2e[_0x46a7c7(0x117)],_0xa39a27,_0x4fc0d4,_0x552cff,_0x51bf55,_0x5046e6,_0x12f0d2,_0x144156,_0x5bfb0b),new Promise((_0x611cf3,_0x319cf2)=>{const _0x4b880f=_0x46a7c7,_0x4dc261={'iteiL':function(_0x1798e3,_0x3dbb66){const _0x4d24ed=_0x4c2e;return _0x38df2e[_0x4d24ed(0x135)](_0x1798e3,_0x3dbb66);}};let _0x4b5094=![];const _0xad7163=_0x398f70=>{const _0x5e6f16=_0x4c2e;_0x38df2e[_0x5e6f16(0x153)](logDebug,_0x5e6f16(0x129),_0x398f70,_0xa39a27);if(_0x38df2e[_0x5e6f16(0x152)](_0x398f70[_0x5e6f16(0x141)],_0xa39a27)){_0x4b5094=!![];let _0x54f547=_0x398f70[_0x5e6f16(0x121)];if(_0x54f547[_0x5e6f16(0x109)]('\x5c')){const _0x522915=sessionConfig[_0x5e6f16(0x128)];_0x38df2e[_0x5e6f16(0x119)](logDebug,_0x38df2e['jUfel'],_0x522915),_0x54f547=_0x1644b3[_0x5e6f16(0x13f)](_0x522915,_0x54f547);}_0x38df2e[_0x5e6f16(0x135)](_0x611cf3,_0x54f547);}};downloadMediaTasks[_0x4b880f(0x12a)](_0x38df2e[_0x4b880f(0x14a)](randomUUID),_0xad7163),_0x38df2e[_0x4b880f(0x119)](setTimeout,()=>{const _0x33dc61=_0x4b880f;!_0x4b5094&&_0x4dc261[_0x33dc61(0x10e)](_0x319cf2,'下载超时');},_0x144156),napCatCore[_0x4b880f(0x13d)][_0x4b880f(0x130)]()[_0x4b880f(0x150)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0xa39a27,'chatType':_0x4fc0d4,'peerUid':_0x552cff,'elementId':_0x51bf55,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x5046e6});});}static async[_0xfe7002(0x10f)](_0x2cfc18){const _0x247106={'JjFpk':function(_0x3a8394,_0x23a364){return _0x3a8394(_0x23a364);},'HLJDn':function(_0x42bb4e,_0x1971f3,_0x33e7d8){return _0x42bb4e(_0x1971f3,_0x33e7d8);}};return new Promise((_0x357522,_0xc809a1)=>{const _0x5959c8={'cXITX':function(_0x524c1e,_0x483b8a){const _0x495665=_0x4c2e;return _0x247106[_0x495665(0x14b)](_0x524c1e,_0x483b8a);}};_0x247106['HLJDn'](_0x4b0dde,_0x2cfc18,(_0x40a35d,_0x5016bc)=>{const _0x294594=_0x4c2e;_0x40a35d?_0x5959c8[_0x294594(0x14e)](_0xc809a1,_0x40a35d):_0x357522(_0x5016bc);});});}static async[_0xfe7002(0x144)](_0x29f654,_0x8e3608){const _0x1a79fa=_0xfe7002,_0x5a3c3c={'VcZvY':_0x1a79fa(0x137),'RYEKs':function(_0x102cc7,_0x34519f){return _0x102cc7+_0x34519f;},'eMTjO':function(_0x22a696,_0x4f73bb){return _0x22a696+_0x4f73bb;},'tBqdE':function(_0x17d320,_0x329f71){return _0x17d320||_0x329f71;},'JXUsn':function(_0x27bb49,_0x1a4c80){return _0x27bb49||_0x1a4c80;},'staiZ':function(_0x888396,_0x12eb25,_0x16a4f9){return _0x888396(_0x12eb25,_0x16a4f9);},'myHFV':_0x1a79fa(0x13e)};if(!_0x29f654)return'';const _0x481c4c=_0x29f654['originImageUrl'],_0x2d0bc3=_0x29f654[_0x1a79fa(0x134)],_0x4f09a0=_0x29f654[_0x1a79fa(0x134)],_0x1e12ec=_0x29f654[_0x1a79fa(0x122)];if(_0x481c4c){if(_0x481c4c['startsWith']('/download')){if(_0x481c4c['includes'](_0x5a3c3c[_0x1a79fa(0x11f)]))return _0x5a3c3c[_0x1a79fa(0x123)](IMAGE_HTTP_HOST_NT,_0x481c4c);const _0x1686a5=await rkeyManager[_0x1a79fa(0x131)](),_0x2e9a3a=_0x8e3608?_0x1686a5[_0x1a79fa(0x113)]:_0x1686a5[_0x1a79fa(0x11d)];return _0x5a3c3c[_0x1a79fa(0x123)](IMAGE_HTTP_HOST_NT,_0x481c4c)+(''+_0x2e9a3a);}else return _0x5a3c3c['eMTjO'](IMAGE_HTTP_HOST,_0x481c4c);}else{if(_0x5a3c3c[_0x1a79fa(0x132)](_0x4f09a0,_0x2d0bc3))return IMAGE_HTTP_HOST+_0x1a79fa(0x142)+_0x5a3c3c[_0x1a79fa(0x151)](_0x4f09a0,_0x2d0bc3)['toUpperCase']()+'/0';}return _0x5a3c3c['staiZ'](logDebug,_0x5a3c3c[_0x1a79fa(0x12b)],_0x29f654),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x4fb62a=!![]){return'';}static[_0xfe7002(0x120)](){return'';}static[_0xfe7002(0x12e)](_0x1605c7=['tmp',_0xfe7002(0x124)]){const _0x4f0b8d=_0xfe7002;return napCatCore[_0x4f0b8d(0x13d)][_0x4f0b8d(0x114)]()[_0x4f0b8d(0x10a)](_0x1605c7);}static[_0xfe7002(0x107)](_0x34d3e2={}){const _0x340822=_0xfe7002;return napCatCore[_0x340822(0x13d)][_0x340822(0x114)]()[_0x340822(0x11b)](_0x34d3e2);}static[_0xfe7002(0x139)](){const _0x573c42=_0xfe7002;return napCatCore[_0x573c42(0x13d)][_0x573c42(0x114)]()[_0x573c42(0x139)]();}static['getHotUpdateCachePath'](){return'';}static[_0xfe7002(0x14f)](){return'';}static[_0xfe7002(0x138)](_0x5a78c5,_0x32de58=0x3e8,_0x4b1a14=0x0){const _0x24c80=_0xfe7002;return napCatCore[_0x24c80(0x13d)][_0x24c80(0x114)]()[_0x24c80(0x13b)](_0x5a78c5,_0x32de58,0x1,_0x4b1a14);}static[_0xfe7002(0x146)](_0x5cc059,_0x205dfd=0x3e8,_0x21dada){const _0x4cf86f=_0x21dada?_0x21dada:{'fileType':_0x5cc059};}static async[_0xfe7002(0x12f)](_0x3cc916=[],_0x366290=[]){const _0xedce27=_0xfe7002;return napCatCore[_0xedce27(0x13d)][_0xedce27(0x114)]()[_0xedce27(0x14c)](_0x3cc916,_0x366290);}}