const _0x79193a=_0x3d55;(function(_0x57a2b2,_0x1f3aa7){const _0x2e8692=_0x3d55,_0x1f1c10=_0x57a2b2();while(!![]){try{const _0x42813e=parseInt(_0x2e8692(0x203))/0x1+-parseInt(_0x2e8692(0x1f7))/0x2*(-parseInt(_0x2e8692(0x1c8))/0x3)+-parseInt(_0x2e8692(0x232))/0x4+-parseInt(_0x2e8692(0x1e6))/0x5*(parseInt(_0x2e8692(0x1cb))/0x6)+parseInt(_0x2e8692(0x1d0))/0x7*(parseInt(_0x2e8692(0x1f6))/0x8)+parseInt(_0x2e8692(0x20e))/0x9+-parseInt(_0x2e8692(0x210))/0xa;if(_0x42813e===_0x1f3aa7)break;else _0x1f1c10['push'](_0x1f1c10['shift']());}catch(_0x409210){_0x1f1c10['push'](_0x1f1c10['shift']());}}}(_0x5d07,0xe6960));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x11ddd4 from'path';import _0x394ffc from'fs';import _0x5861c3 from'fs/promises';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x327abe from'file-type';import{MsgListener}from'@/core/listeners';import _0x9ea2b2 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x5d07(){const _0x5148ef=['fBpAu','isAvailable','join','图片rkey获取失败','getStorageCleanService','ZBfBv','defaultFileDownloadPath','ext','set','117837gVWKth','getDesktopTmpPath','获取图片rkey...','4908WcFWYn','receive\x20downloadMedia\x20task',',\x20rkey:','getChatCacheList','Fasci','269934nkupxz','KlQKq','then','NBqlM','onLoginSuccess','yxXtE','sourcePath','rIFME','copyFile','includes','getCacheSessionPathList','group','downloadMedia','TcjCI','PIC','WVmWV','scanCache','eJvaZ','startsWith','getRKey','EdYcr','clearChatCache','3660pRPksk','MRfCj','fileTypeFromFile','getFileType','getMsgService','qfDCs','util','图片rkey有效','uploadFile','picElement','TBlGy','fileUuid','RoPJq','indexOf','downloadMedia\x20complete','downloadPath','352MXTFtr','12EbVsWh','get','clearCache','gKNLB','downloadRichMedia','getImageSize','AdNob','catch','getHotUpdateCachePath','HzgVo','md5HexStr','tnGre','1662318jopzFj','TVZig','originImageUrl','getChatCacheInfo','HnRIY','session','nIOgg','/download','xVOAo','unlink','find','12731913SMXIBN','hotUpdate','34554640mROKyX','onRichMediaDownloadComplete','GdiIX','clearChatCacheInfo','iJbJM','now','msgId','TtzGs','ayzkw','filePath','tmp','rjXeu','lmFQE','xkwna','QVYNs','setCacheSilentScan','addTask','qoyaf','ntBIe','addCacheScanedPaths','peerUid','existsSync','delete','getFileSize','JJITc','图片rkey有误','BcIQO','DdaZg','getRichMediaFilePathForGuild','hookApi\x20is\x20not\x20available','NUjiU','IkwQC','addListener','&rkey=','42628emlPes','addCacheScannedPaths','clearCacheDataByKeys','FgmjH','start\x20downloadMedia','/gchatpic_new/0/0-0-','getImageUrl','AHjez'];_0x5d07=function(){return _0x5148ef;};return _0x5d07();}import{sleep}from'@/common/utils/helper';import _0x546ee0 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x79193a(0x211)]=_0x32deb1=>{const _0x4236a2=_0x79193a,_0x1572c2={'GdiIX':function(_0x5c147b,_0x3aaa42){return _0x5c147b(_0x3aaa42);}};for(const [_0x3996ef,_0x1b1b7b]of downloadMediaTasks){_0x1572c2[_0x4236a2(0x212)](_0x1b1b7b,_0x32deb1),downloadMediaTasks[_0x4236a2(0x226)](_0x3996ef);}},setTimeout(()=>{const _0x4f860f=_0x79193a;napCatCore[_0x4f860f(0x1d4)](()=>{const _0x2a68e7=_0x4f860f;napCatCore[_0x2a68e7(0x230)](downloadMediaListener);});},0x64);function _0x3d55(_0x4ad99d,_0x2584a3){const _0x5d07bd=_0x5d07();return _0x3d55=function(_0x3d559b,_0x26db11){_0x3d559b=_0x3d559b-0x1bc;let _0x3d17ec=_0x5d07bd[_0x3d559b];return _0x3d17ec;},_0x3d55(_0x4ad99d,_0x2584a3);}export class NTQQFileApi{static async['getFileType'](_0x5bd7f9){const _0x4d22c2=_0x79193a;return _0x327abe[_0x4d22c2(0x1e8)](_0x5bd7f9);}static async[_0x79193a(0x1d8)](_0x6bb784,_0x10af1c){const _0x540b60=_0x79193a;await napCatCore[_0x540b60(0x1ec)][_0x540b60(0x1d8)](_0x6bb784,_0x10af1c);}static async[_0x79193a(0x227)](_0x1e0a2a){const _0x4fa3e8=_0x79193a;return await napCatCore[_0x4fa3e8(0x1ec)]['getFileSize'](_0x1e0a2a);}static async[_0x79193a(0x1ee)](_0x4f2f51,_0x86986a=ElementType[_0x79193a(0x1de)],_0xa98b66=0x0){const _0xe9424e=_0x79193a,_0x191e91={'LEbkU':function(_0x129279,_0x4000ac){return _0x129279+_0x4000ac;},'ayzkw':function(_0x591447,_0x324d94){return _0x591447===_0x324d94;}},_0x344cd7=await calculateFileMD5(_0x4f2f51);let _0x82f36=(await NTQQFileApi[_0xe9424e(0x1e9)](_0x4f2f51))?.[_0xe9424e(0x1c6)]||'';_0x82f36&&(_0x82f36=_0x191e91['LEbkU']('.',_0x82f36));let _0x14597b=''+_0x11ddd4['basename'](_0x4f2f51);_0x191e91[_0xe9424e(0x218)](_0x14597b[_0xe9424e(0x1f3)]('.'),-0x1)&&(_0x14597b+=_0x82f36);const _0x36a799=napCatCore[_0xe9424e(0x208)]['getMsgService']()[_0xe9424e(0x22c)]({'md5HexStr':_0x344cd7,'fileName':_0x14597b,'elementType':_0x86986a,'elementSubType':_0xa98b66,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x4f2f51,_0x36a799);const _0x3fda23=await NTQQFileApi['getFileSize'](_0x4f2f51);return{'md5':_0x344cd7,'fileName':_0x14597b,'path':_0x36a799,'fileSize':_0x3fda23,'ext':_0x82f36};}static async[_0x79193a(0x1dc)](_0x3bd254,_0x416fc8,_0x494bb2,_0x3747d2,_0x4c14f2,_0xd27fe6,_0xc06f33=0x3e8*0x3c*0x2,_0x5df687=![]){const _0x3d25a0=_0x79193a,_0x8164a7={'iJbJM':'下载超时','fBpAu':function(_0x31a3bf,_0x13181a,_0xfd50a8,_0x5156a3){return _0x31a3bf(_0x13181a,_0xfd50a8,_0x5156a3);},'ntBIe':function(_0x25a739,_0xce8cbf){return _0x25a739===_0xce8cbf;},'IkwQC':function(_0x220bb0,_0x45cc4f,_0x3db81f){return _0x220bb0(_0x45cc4f,_0x3db81f);},'DdaZg':function(_0x284789,_0x21d5b9){return _0x284789(_0x21d5b9);},'RoPJq':function(_0x25a8c4){return _0x25a8c4();},'TBlGy':function(_0x474977,_0x29292a,_0x3ad35b,_0x35d145,_0x4ca98e,_0x57ee25,_0x224bc3,_0x504b7e,_0xa89cf7,_0x43bc29){return _0x474977(_0x29292a,_0x3ad35b,_0x35d145,_0x4ca98e,_0x57ee25,_0x224bc3,_0x504b7e,_0xa89cf7,_0x43bc29);},'MRfCj':_0x3d25a0(0x236)};logDebug(_0x3d25a0(0x1cc),_0x3bd254,_0x416fc8,_0x494bb2,_0x3747d2,_0x4c14f2,_0xd27fe6,_0xc06f33,_0x5df687);if(_0xd27fe6&&_0x394ffc[_0x3d25a0(0x225)](_0xd27fe6)){if(_0x5df687)try{await _0x5861c3[_0x3d25a0(0x20c)](_0xd27fe6);}catch(_0x1f3683){}else return _0xd27fe6;}return _0x8164a7[_0x3d25a0(0x1f0)](logDebug,_0x8164a7[_0x3d25a0(0x1e7)],_0x3bd254,_0x416fc8,_0x494bb2,_0x3747d2,_0x4c14f2,_0xd27fe6,_0xc06f33,_0x5df687),new Promise((_0x3ec4a5,_0x579d1f)=>{const _0x6d9a1b=_0x3d25a0,_0x23435f={'nXdaN':function(_0x59c9e4,_0x4bc7f1,_0x2236c0,_0x3920ee){const _0x1578d3=_0x3d55;return _0x8164a7[_0x1578d3(0x1bf)](_0x59c9e4,_0x4bc7f1,_0x2236c0,_0x3920ee);},'AdNob':_0x6d9a1b(0x1f4),'eJvaZ':function(_0x25671d,_0x356e3b){const _0x2c2a64=_0x6d9a1b;return _0x8164a7[_0x2c2a64(0x222)](_0x25671d,_0x356e3b);},'rjXeu':function(_0x1f7a93,_0x1ed41b,_0x37d8d1){const _0x1cdd74=_0x6d9a1b;return _0x8164a7[_0x1cdd74(0x22f)](_0x1f7a93,_0x1ed41b,_0x37d8d1);},'lQyoi':function(_0x4b6440,_0x5e810b){const _0x5310b2=_0x6d9a1b;return _0x8164a7[_0x5310b2(0x22b)](_0x4b6440,_0x5e810b);}};let _0x519d4c=![];const _0x18ccb7=_0x1e9987=>{const _0x5afcde=_0x6d9a1b;_0x23435f['nXdaN'](logDebug,_0x23435f[_0x5afcde(0x1fd)],_0x1e9987,_0x3bd254);if(_0x23435f[_0x5afcde(0x1e1)](_0x1e9987[_0x5afcde(0x216)],_0x3bd254)){_0x519d4c=!![];let _0x286a5d=_0x1e9987[_0x5afcde(0x219)];if(_0x286a5d[_0x5afcde(0x1e2)]('\x5c')){const _0x3b9979=sessionConfig[_0x5afcde(0x1c5)];_0x23435f[_0x5afcde(0x21b)](logDebug,_0x5afcde(0x1f5),_0x3b9979),_0x286a5d=_0x11ddd4[_0x5afcde(0x1c1)](_0x3b9979,_0x286a5d);}_0x23435f['lQyoi'](_0x3ec4a5,_0x286a5d);}};downloadMediaTasks[_0x6d9a1b(0x1c7)](_0x8164a7[_0x6d9a1b(0x1f2)](randomUUID),_0x18ccb7),_0x8164a7[_0x6d9a1b(0x22f)](setTimeout,()=>{const _0x10ea67=_0x6d9a1b;!_0x519d4c&&_0x579d1f(_0x8164a7[_0x10ea67(0x214)]);},_0xc06f33),napCatCore[_0x6d9a1b(0x208)][_0x6d9a1b(0x1ea)]()[_0x6d9a1b(0x1fb)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x3bd254,'chatType':_0x416fc8,'peerUid':_0x494bb2,'elementId':_0x3747d2,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x4c14f2});});}static async[_0x79193a(0x1fc)](_0x3d7ebe){const _0x4a7ae9={'JJITc':function(_0x2712e7,_0x1aba86){return _0x2712e7(_0x1aba86);}};return new Promise((_0x513954,_0x1d8728)=>{_0x9ea2b2(_0x3d7ebe,(_0x42a0eb,_0x42d518)=>{const _0xd2a8b8=_0x3d55;_0x42a0eb?_0x4a7ae9[_0xd2a8b8(0x228)](_0x1d8728,_0x42a0eb):_0x513954(_0x42d518);});});}static async[_0x79193a(0x1bd)](_0x3c3363){const _0x21460d=_0x79193a,_0x55a5db={'nIOgg':function(_0x3d2cf9,_0xec7512){return _0x3d2cf9!==_0xec7512;},'TtzGs':function(_0x5f20dd,_0x2132eb){return _0x5f20dd(_0x2132eb);},'EdYcr':function(_0x998559,_0x415987){return _0x998559(_0x415987);},'zxzlq':_0x21460d(0x1ca),'NUjiU':function(_0x4673de,_0xebdb94){return _0x4673de*_0xebdb94;},'gekZQ':function(_0x1afbe5,_0x34538d){return _0x1afbe5(_0x34538d);},'yxXtE':function(_0x185cb9,_0x3be538){return _0x185cb9(_0x3be538);},'NBqlM':'开始调用moeHook获取rkey','gKNLB':function(_0x381aa9,_0x380328){return _0x381aa9+_0x380328;},'FgmjH':function(_0x4fbc85,_0x67e9e3){return _0x4fbc85+_0x67e9e3;},'qoyaf':function(_0x37a392,_0x4e391f,_0x48e9c2){return _0x37a392(_0x4e391f,_0x48e9c2);},'AHjez':'检查rkey是否有效','QVYNs':_0x21460d(0x1ed),'HnRIY':function(_0x20c63c,_0x39ec78,_0x110226,_0x1ce96c){return _0x20c63c(_0x39ec78,_0x110226,_0x1ce96c);},'xkwna':_0x21460d(0x229),'YIiCg':function(_0x1f397b){return _0x1f397b();},'ZBfBv':_0x21460d(0x20a),'BcIQO':_0x21460d(0x231),'IRfWF':_0x21460d(0x22d),'tnGre':function(_0x4f1779,_0x3be286){return _0x4f1779-_0x3be286;},'WVmWV':function(_0x4a4b5b){return _0x4a4b5b();},'rIFME':function(_0x42d1a5,_0x3779d6){return _0x42d1a5+_0x3779d6;},'TVZig':function(_0x47a29f,_0x347ed1,_0x11a74d){return _0x47a29f(_0x347ed1,_0x11a74d);},'KlQKq':function(_0x312209,_0x169211){return _0x312209+_0x169211;},'xVOAo':function(_0x38ed56,_0x1e0758){return _0x38ed56||_0x1e0758;},'qfDCs':function(_0x2ae1f6,_0x562ca9,_0x51f5d7){return _0x2ae1f6(_0x562ca9,_0x51f5d7);},'lmFQE':'图片url获取失败'},_0x4beee3=_0x55a5db[_0x21460d(0x209)](_0x3c3363['chatType'],ChatType[_0x21460d(0x1db)]),_0x32c2df=_0x3c3363['elements'][_0x21460d(0x20d)](_0x46d833=>!!_0x46d833[_0x21460d(0x1ef)]);if(!_0x32c2df)return'';const _0x43f572=_0x32c2df[_0x21460d(0x1ef)][_0x21460d(0x205)],_0x193c71=_0x32c2df[_0x21460d(0x1ef)]['md5HexStr'],_0x21270f=_0x32c2df[_0x21460d(0x1ef)][_0x21460d(0x201)],_0x14adbe=_0x32c2df['picElement'][_0x21460d(0x1f1)],_0x104c4d=_0x5757dc=>{const _0x2ce3f5=_0x21460d;_0x4beee3?(privateImageRKey=_0x5757dc,lastGetPrivateRKeyTime=Date[_0x2ce3f5(0x215)]()):(groupImageRKey=_0x5757dc,lastGetGroupRKeyTime=Date[_0x2ce3f5(0x215)]());};if(_0x43f572){if(_0x43f572[_0x21460d(0x1e2)](_0x55a5db[_0x21460d(0x1c4)])){if(_0x43f572[_0x21460d(0x1d9)](_0x55a5db[_0x21460d(0x22a)]))return IMAGE_HTTP_HOST_NT+_0x43f572;if(!hookApi[_0x21460d(0x1c0)]())return _0x55a5db[_0x21460d(0x217)](logDebug,_0x55a5db['IRfWF']),'';const _0x21aafa=async()=>{const _0xd292d0=_0x21460d,_0x3e040b={'Fasci':function(_0x4453a5,_0x3a2ba3){const _0x44d339=_0x3d55;return _0x55a5db[_0x44d339(0x209)](_0x4453a5,_0x3a2ba3);},'HzgVo':function(_0x13ac20,_0x43ba4c){const _0x1b046e=_0x3d55;return _0x55a5db[_0x1b046e(0x217)](_0x13ac20,_0x43ba4c);}};_0x55a5db[_0xd292d0(0x1e4)](logDebug,_0x55a5db['zxzlq']),NTQQFileApi[_0xd292d0(0x1dc)](_0x3c3363[_0xd292d0(0x216)],_0x3c3363['chatType'],_0x3c3363[_0xd292d0(0x224)],_0x32c2df['elementId'],'',_0x32c2df[_0xd292d0(0x1ef)][_0xd292d0(0x1d6)],_0x55a5db[_0xd292d0(0x22e)](0x3e8,0x1e),!![])[_0xd292d0(0x1d2)](_0x1e1de3=>{})[_0xd292d0(0x1fe)](logError),await _0x55a5db['gekZQ'](sleep,0x3e8),_0x55a5db[_0xd292d0(0x1d5)](logDebug,_0x55a5db[_0xd292d0(0x1d3)]);const _0x59bc30=hookApi[_0xd292d0(0x1e3)]()||'',_0x3265a8=_0x55a5db[_0xd292d0(0x1fa)](_0x55a5db[_0xd292d0(0x235)](IMAGE_HTTP_HOST_NT,_0x43f572),_0x59bc30);if(_0x59bc30)try{_0x55a5db[_0xd292d0(0x221)](logDebug,_0x55a5db[_0xd292d0(0x1be)],_0x3265a8),await new Promise((_0x1035f6,_0x95c3ef)=>{const _0x547ed0=_0xd292d0,_0x3d8f70={'TcjCI':function(_0x334a96,_0x5f2b50){const _0x570714=_0x3d55;return _0x3e040b[_0x570714(0x200)](_0x334a96,_0x5f2b50);}};_0x546ee0[_0x547ed0(0x1f8)](_0x3265a8,_0x55ded8=>{const _0x2fb144=_0x547ed0;_0x3e040b[_0x2fb144(0x1cf)](_0x55ded8['statusCode'],0xc8)?_0x95c3ef(_0x2fb144(0x1c2)):_0x3e040b[_0x2fb144(0x200)](_0x1035f6,_0x55ded8);})['on']('error',_0x579eb6=>{const _0x1b324d=_0x547ed0;_0x3d8f70[_0x1b324d(0x1dd)](_0x95c3ef,_0x579eb6);});}),_0x55a5db[_0xd292d0(0x221)](logDebug,_0x55a5db[_0xd292d0(0x21e)],_0x3265a8),_0x55a5db[_0xd292d0(0x1e4)](_0x104c4d,_0x59bc30);}catch(_0x39ef05){return _0x55a5db[_0xd292d0(0x207)](logError,_0x55a5db[_0xd292d0(0x21d)],_0x3265a8,_0x39ef05),'';}return _0x59bc30;},_0x2d060e=()=>new Promise((_0x52ecb8,_0x59074b)=>{const _0x3ca003=_0x21460d;getRKeyTaskQueue[_0x3ca003(0x220)](async()=>{const _0x23e3db=_0x3ca003,_0x19e93b=await _0x55a5db['YIiCg'](_0x21aafa);_0x55a5db[_0x23e3db(0x1d5)](_0x52ecb8,_0x19e93b);});}),_0x47ace2=_0x4beee3?privateImageRKey:groupImageRKey,_0xc25533=_0x4beee3?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x55a5db[_0x21460d(0x202)](Date[_0x21460d(0x215)](),_0xc25533)>rkeyExpireTime||!_0x47ace2){_0x55a5db[_0x21460d(0x1e4)](logDebug,'rkey过期或着未获取,\x20url:'+_0x43f572+_0x21460d(0x1cd)+_0x47ace2);const _0x3c4455=await _0x55a5db[_0x21460d(0x1df)](_0x2d060e);if(_0x3c4455)return _0x55a5db['FgmjH'](_0x55a5db[_0x21460d(0x1d7)](IMAGE_HTTP_HOST_NT,_0x43f572),''+_0x3c4455);else _0x55a5db[_0x21460d(0x204)](logError,_0x21460d(0x1c2),_0x43f572);}if(_0x47ace2)return _0x55a5db['rIFME'](_0x55a5db[_0x21460d(0x1d1)](IMAGE_HTTP_HOST_NT,_0x43f572),''+_0x47ace2);return'';}else return IMAGE_HTTP_HOST+_0x43f572;}else{if(_0x21270f||_0x193c71)return IMAGE_HTTP_HOST+_0x21460d(0x1bc)+_0x55a5db[_0x21460d(0x20b)](_0x21270f,_0x193c71)['toUpperCase']()+'/0';}return _0x55a5db[_0x21460d(0x1eb)](logDebug,_0x55a5db[_0x21460d(0x21c)],_0x3c3363),'';}}export class NTQQFileCacheApi{static async[_0x79193a(0x21f)](_0x3e3bb6=!![]){return'';}static[_0x79193a(0x1da)](){return'';}static[_0x79193a(0x1f9)](_0x7c4d4=[_0x79193a(0x21a),_0x79193a(0x20f)]){const _0x235a5c=_0x79193a;return napCatCore['session'][_0x235a5c(0x1c3)]()[_0x235a5c(0x234)](_0x7c4d4);}static[_0x79193a(0x233)](_0x3a9287={}){const _0x2784f5=_0x79193a;return napCatCore[_0x2784f5(0x208)][_0x2784f5(0x1c3)]()[_0x2784f5(0x223)](_0x3a9287);}static[_0x79193a(0x1e0)](){const _0x13fe7d=_0x79193a;return napCatCore[_0x13fe7d(0x208)][_0x13fe7d(0x1c3)]()[_0x13fe7d(0x1e0)]();}static[_0x79193a(0x1ff)](){return'';}static[_0x79193a(0x1c9)](){return'';}static[_0x79193a(0x1ce)](_0x584a2a,_0x36ea17=0x3e8,_0x4275b2=0x0){const _0x3648d8=_0x79193a;return napCatCore[_0x3648d8(0x208)][_0x3648d8(0x1c3)]()[_0x3648d8(0x206)](_0x584a2a,_0x36ea17,0x1,_0x4275b2);}static['getFileCacheInfo'](_0x12da18,_0x3a22ce=0x3e8,_0x31fbf3){const _0x31da90=_0x31fbf3?_0x31fbf3:{'fileType':_0x12da18};}static async[_0x79193a(0x1e5)](_0x4d0230=[],_0x24ba03=[]){const _0x399877=_0x79193a;return napCatCore[_0x399877(0x208)][_0x399877(0x1c3)]()[_0x399877(0x213)](_0x4d0230,_0x24ba03);}}