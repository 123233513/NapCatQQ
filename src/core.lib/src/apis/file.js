const _0x513451=_0x36af;(function(_0x4d07d4,_0x36c780){const _0x14b3b3=_0x36af,_0x57b96a=_0x4d07d4();while(!![]){try{const _0x3a8af9=-parseInt(_0x14b3b3(0x1e0))/0x1*(-parseInt(_0x14b3b3(0x21f))/0x2)+-parseInt(_0x14b3b3(0x22a))/0x3+-parseInt(_0x14b3b3(0x1e1))/0x4*(parseInt(_0x14b3b3(0x1fd))/0x5)+parseInt(_0x14b3b3(0x220))/0x6+parseInt(_0x14b3b3(0x20c))/0x7*(-parseInt(_0x14b3b3(0x208))/0x8)+-parseInt(_0x14b3b3(0x213))/0x9*(parseInt(_0x14b3b3(0x1e3))/0xa)+-parseInt(_0x14b3b3(0x1e8))/0xb*(-parseInt(_0x14b3b3(0x221))/0xc);if(_0x3a8af9===_0x36c780)break;else _0x57b96a['push'](_0x57b96a['shift']());}catch(_0x34b491){_0x57b96a['push'](_0x57b96a['shift']());}}}(_0x4ac2,0x3f07c));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x2d2243 from'path';import _0x169cb8 from'fs';function _0x36af(_0x3a0f8b,_0x788f9b){const _0x4ac220=_0x4ac2();return _0x36af=function(_0x36afd1,_0x1ab08e){_0x36afd1=_0x36afd1-0x1e0;let _0x147d71=_0x4ac220[_0x36afd1];return _0x147d71;},_0x36af(_0x3a0f8b,_0x788f9b);}import _0x21e4ab from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0xe165f3 from'file-type';import{MsgListener}from'@/core/listeners';function _0x4ac2(){const _0x2a5ef9=['FZLvP','24657FsDLZw','98756oRyFHk','util','10eiZyLP','delete','set','onRichMediaDownloadComplete','onLoginSuccess','38687gLCYtQ','OOnOw','private_rkey','addCacheScanedPaths','chatType','/gchatpic_new/0/0-0-','copyFile','ahdYw','vTgur','getStorageCleanService','fileUuid','addCacheScannedPaths','WFDJl','zIlDk','getChatCacheInfo','getImageUrl','msgId','getFileType','下载超时','wbVai','addListener','15uFHtkl','ext','group_rkey','getChatCacheList','basename','originImageUrl','join','hotUpdate','getMsgService','EFmLi','setCacheSilentScan','1329288VvbWXx','图片url获取失败','existsSync','ZWGNg','21qbHWbP','tmp','MvjNn','filePath','urlResult','downloadMedia','clearChatCacheInfo','75258vqNrfr','elementId','getCacheSessionPathList','tGjSw','puHUL','getFileSize','scanCache','gFyFF','url','downloadRichMedia','fileTypeFromFile','PIC','20SHboYq','1236204tzsFKk','2820ofyglb','md5HexStr','clearCache','getImageSize','uploadFile','rtaYj','startsWith','session','clearCacheDataByKeys','1320045JlgMtk','Tprws','wzKfT'];_0x4ac2=function(){return _0x2a5ef9;};return _0x4ac2();}import _0x1f0475 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x513451(0x1e6)]=_0x527cb6=>{const _0x55e530=_0x513451,_0x22e704={'vTgur':function(_0x27ee64,_0x48e871){return _0x27ee64(_0x48e871);}};for(const [_0x301838,_0x3368eb]of downloadMediaTasks){_0x22e704[_0x55e530(0x1f0)](_0x3368eb,_0x527cb6),downloadMediaTasks[_0x55e530(0x1e4)](_0x301838);}},setTimeout(()=>{const _0x21e2e7=_0x513451;napCatCore[_0x21e2e7(0x1e7)](()=>{const _0x49cd54=_0x21e2e7;napCatCore[_0x49cd54(0x1fc)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x513451(0x1f9)](_0x3df700){const _0x2e2147=_0x513451;return _0xe165f3[_0x2e2147(0x21d)](_0x3df700);}static async[_0x513451(0x1ee)](_0x18058b,_0x2394fc){const _0x1898f8=_0x513451;await napCatCore[_0x1898f8(0x1e2)][_0x1898f8(0x1ee)](_0x18058b,_0x2394fc);}static async['getFileSize'](_0xc6957d){const _0x180b3d=_0x513451;return await napCatCore[_0x180b3d(0x1e2)][_0x180b3d(0x218)](_0xc6957d);}static async['getVideoUrl'](_0x53eaca,_0x73f7f0){const _0x393ee8=_0x513451;return(await napCatCore[_0x393ee8(0x228)]['getRichMediaService']()['getVideoPlayUrlV2']({'chatType':_0x53eaca[_0x393ee8(0x1ec)],'peerUid':_0x53eaca['peerUid'],'guildId':'0'},_0x53eaca[_0x393ee8(0x1f8)],_0x73f7f0[_0x393ee8(0x214)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x393ee8(0x210)]['domainUrl'][0x0][_0x393ee8(0x21b)];}static async[_0x513451(0x225)](_0x3ed508,_0x5bc295=ElementType[_0x513451(0x21e)],_0x49aa6a=0x0){const _0xb0f684=_0x513451,_0xec991a={'FZLvP':function(_0x17efb6,_0x29f5be){return _0x17efb6===_0x29f5be;}},_0x22ba39=await calculateFileMD5(_0x3ed508);let _0x50d7a5=(await NTQQFileApi[_0xb0f684(0x1f9)](_0x3ed508))?.[_0xb0f684(0x1fe)]||'';_0x50d7a5&&(_0x50d7a5='.'+_0x50d7a5);let _0x4430ba=''+_0x2d2243[_0xb0f684(0x201)](_0x3ed508);_0xec991a[_0xb0f684(0x22d)](_0x4430ba['indexOf']('.'),-0x1)&&(_0x4430ba+=_0x50d7a5);const _0x3e735e=napCatCore[_0xb0f684(0x228)][_0xb0f684(0x205)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x22ba39,'fileName':_0x4430ba,'elementType':_0x5bc295,'elementSubType':_0x49aa6a,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0xb0f684(0x1ee)](_0x3ed508,_0x3e735e);const _0x199a43=await NTQQFileApi[_0xb0f684(0x218)](_0x3ed508);return{'md5':_0x22ba39,'fileName':_0x4430ba,'path':_0x3e735e,'fileSize':_0x199a43,'ext':_0x50d7a5};}static async[_0x513451(0x211)](_0x550a92,_0x227c47,_0x335639,_0x2a809e,_0x2826a4,_0x467463,_0x5ed410=0x3e8*0x3c*0x2,_0x32bae1=![]){const _0x1e069d=_0x513451,_0x37e55d={'WFDJl':function(_0x43e4d7,_0x392bed){return _0x43e4d7(_0x392bed);},'wbVai':_0x1e069d(0x1fa),'Tprws':function(_0x3c971d,_0x37dbcc){return _0x3c971d===_0x37dbcc;},'ZWGNg':function(_0x8699b8){return _0x8699b8();},'EFmLi':function(_0xce6098,_0x44fad9,_0x4fd44b){return _0xce6098(_0x44fad9,_0x4fd44b);}};if(_0x467463&&_0x169cb8[_0x1e069d(0x20a)](_0x467463)){if(_0x32bae1)try{await _0x21e4ab['unlink'](_0x467463);}catch(_0x1a8478){}else return _0x467463;}return new Promise((_0x51e6f5,_0x54eec9)=>{const _0xc9471f=_0x1e069d,_0x572a6f={'zIlDk':function(_0x128a32,_0x5bace2){const _0x4510c6=_0x36af;return _0x37e55d[_0x4510c6(0x22b)](_0x128a32,_0x5bace2);}};let _0x4863b2=![];const _0x3331ad=_0x3334af=>{const _0x343ea1=_0x36af;if(_0x572a6f[_0x343ea1(0x1f5)](_0x3334af[_0x343ea1(0x1f8)],_0x550a92)){_0x4863b2=!![];let _0x12aa59=_0x3334af[_0x343ea1(0x20f)];if(_0x12aa59[_0x343ea1(0x227)]('\x5c')){const _0x5ba032=sessionConfig['defaultFileDownloadPath'];_0x12aa59=_0x2d2243[_0x343ea1(0x203)](_0x5ba032,_0x12aa59);}_0x51e6f5(_0x12aa59);}};downloadMediaTasks[_0xc9471f(0x1e5)](_0x37e55d[_0xc9471f(0x20b)](randomUUID),_0x3331ad),_0x37e55d[_0xc9471f(0x206)](setTimeout,()=>{const _0xb1ea6e=_0xc9471f;!_0x4863b2&&_0x37e55d[_0xb1ea6e(0x1f4)](_0x54eec9,_0x37e55d[_0xb1ea6e(0x1fb)]);},_0x5ed410),napCatCore[_0xc9471f(0x228)][_0xc9471f(0x205)]()[_0xc9471f(0x21c)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x550a92,'chatType':_0x227c47,'peerUid':_0x335639,'elementId':_0x2a809e,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x2826a4});});}static async[_0x513451(0x224)](_0x3adf53){const _0xe02ea={'Oqimk':function(_0x2606a6,_0x28affa){return _0x2606a6(_0x28affa);},'wzKfT':function(_0x474859,_0x39373a,_0x46dbd2){return _0x474859(_0x39373a,_0x46dbd2);}};return new Promise((_0xae0897,_0x5a944c)=>{const _0x9006ec=_0x36af,_0x3d570b={'rtaYj':function(_0x1c086c,_0x5d3ffd){return _0xe02ea['Oqimk'](_0x1c086c,_0x5d3ffd);}};_0xe02ea[_0x9006ec(0x22c)](_0x1f0475,_0x3adf53,(_0x20f963,_0x5e9c8f)=>{const _0x292545=_0x9006ec;_0x20f963?_0x3d570b[_0x292545(0x226)](_0x5a944c,_0x20f963):_0x3d570b[_0x292545(0x226)](_0xae0897,_0x5e9c8f);});});}static async[_0x513451(0x1f7)](_0x29a01c,_0x3dc662){const _0x3cdba9=_0x513451,_0x517655={'MvjNn':'/download','ahdYw':'&rkey=','gFyFF':function(_0x572a39,_0x513b7){return _0x572a39+_0x513b7;},'puHUL':function(_0x12d20d,_0x3a5b58){return _0x12d20d||_0x3a5b58;},'OOnOw':function(_0x303c19,_0x428b7e,_0x365c9e){return _0x303c19(_0x428b7e,_0x365c9e);},'tGjSw':_0x3cdba9(0x209)};if(!_0x29a01c)return'';const _0x525c2c=_0x29a01c[_0x3cdba9(0x202)],_0x2f01a3=_0x29a01c[_0x3cdba9(0x222)],_0xef9fb8=_0x29a01c[_0x3cdba9(0x222)],_0x2f6b32=_0x29a01c[_0x3cdba9(0x1f2)];if(_0x525c2c){if(_0x525c2c[_0x3cdba9(0x227)](_0x517655[_0x3cdba9(0x20e)])){if(_0x525c2c['includes'](_0x517655[_0x3cdba9(0x1ef)]))return _0x517655[_0x3cdba9(0x21a)](IMAGE_HTTP_HOST_NT,_0x525c2c);const _0x1af3c3=await rkeyManager['getRkey'](),_0x3dea8d=_0x3dc662?_0x1af3c3[_0x3cdba9(0x1ea)]:_0x1af3c3[_0x3cdba9(0x1ff)];return _0x517655[_0x3cdba9(0x21a)](IMAGE_HTTP_HOST_NT+_0x525c2c,''+_0x3dea8d);}else return IMAGE_HTTP_HOST+_0x525c2c;}else{if(_0xef9fb8||_0x2f01a3)return IMAGE_HTTP_HOST+_0x3cdba9(0x1ed)+_0x517655[_0x3cdba9(0x217)](_0xef9fb8,_0x2f01a3)['toUpperCase']()+'/0';}return _0x517655[_0x3cdba9(0x1e9)](logDebug,_0x517655[_0x3cdba9(0x216)],_0x29a01c),'';}}export class NTQQFileCacheApi{static async[_0x513451(0x207)](_0x4114d0=!![]){return'';}static[_0x513451(0x215)](){return'';}static[_0x513451(0x223)](_0x354f62=[_0x513451(0x20d),_0x513451(0x204)]){const _0x33f612=_0x513451;return napCatCore[_0x33f612(0x228)][_0x33f612(0x1f1)]()[_0x33f612(0x229)](_0x354f62);}static[_0x513451(0x1f3)](_0x368ea1={}){const _0x7b71fc=_0x513451;return napCatCore[_0x7b71fc(0x228)][_0x7b71fc(0x1f1)]()[_0x7b71fc(0x1eb)](_0x368ea1);}static[_0x513451(0x219)](){const _0x237d95=_0x513451;return napCatCore['session'][_0x237d95(0x1f1)]()[_0x237d95(0x219)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x513451(0x200)](_0x57938d,_0x479963=0x3e8,_0x2f31fe=0x0){const _0x2b9c53=_0x513451;return napCatCore[_0x2b9c53(0x228)][_0x2b9c53(0x1f1)]()[_0x2b9c53(0x1f6)](_0x57938d,_0x479963,0x1,_0x2f31fe);}static['getFileCacheInfo'](_0x2e30dc,_0x50befc=0x3e8,_0x9a53a6){const _0x23cb07=_0x9a53a6?_0x9a53a6:{'fileType':_0x2e30dc};}static async['clearChatCache'](_0x2fff83=[],_0xeeb278=[]){const _0x38ced7=_0x513451;return napCatCore[_0x38ced7(0x228)][_0x38ced7(0x1f1)]()[_0x38ced7(0x212)](_0x2fff83,_0xeeb278);}}