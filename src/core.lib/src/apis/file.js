const _0x321d20=_0x51af;function _0x51af(_0x2d9731,_0x171226){const _0x4bafbe=_0x4baf();return _0x51af=function(_0x51af46,_0x30ef3b){_0x51af46=_0x51af46-0x169;let _0x285bf0=_0x4bafbe[_0x51af46];return _0x285bf0;},_0x51af(_0x2d9731,_0x171226);}(function(_0x406300,_0x2ba561){const _0x403802=_0x51af,_0x2a64a7=_0x406300();while(!![]){try{const _0x18199e=parseInt(_0x403802(0x1a4))/0x1*(-parseInt(_0x403802(0x18e))/0x2)+-parseInt(_0x403802(0x1b1))/0x3+-parseInt(_0x403802(0x1a2))/0x4*(parseInt(_0x403802(0x191))/0x5)+parseInt(_0x403802(0x175))/0x6*(-parseInt(_0x403802(0x170))/0x7)+parseInt(_0x403802(0x17b))/0x8+-parseInt(_0x403802(0x1a1))/0x9*(-parseInt(_0x403802(0x184))/0xa)+-parseInt(_0x403802(0x180))/0xb*(-parseInt(_0x403802(0x17c))/0xc);if(_0x18199e===_0x2ba561)break;else _0x2a64a7['push'](_0x2a64a7['shift']());}catch(_0x5988f7){_0x2a64a7['push'](_0x2a64a7['shift']());}}}(_0x4baf,0x3338a));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x27e9e8 from'path';import _0x388ad6 from'fs';import _0x222893 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x289ea4 from'file-type';import{MsgListener}from'@/core/listeners';import _0x52251b from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';function _0x4baf(){const _0x17b789=['getRichMediaFilePathForGuild','fUufe','hotUpdate','downloadMedia','session','eZSDZ','getImageUrl','18vNtWoh','4gCVTPx','onLoginSuccess','17xJPdAZ','addCacheScanedPaths','WisMl','defaultFileDownloadPath','msgId','downloadPath','receive\x20downloadMedia\x20task','toUpperCase','mLTfE','getMsgService','downloadMedia\x20complete','copyFile','includes','818208hoZZBV','bcxJz','delete','/gchatpic_new/0/0-0-','existsSync','join','getFileCacheInfo','abaFr','/download','BaNZu','GVUbx','icZUK','getFileSize','&rkey=','addListener','getFileType','scanCache','7nOHjGj','onRichMediaDownloadComplete','cvSzx','LDvpV','getDesktopTmpPath','893166DmqAnE','HjTRF','private_rkey','BEuHp','YSUTr','BfmIe','1661456wyQToQ','240852kYaqQU','getChatCacheList','ubIek','fileUuid','165bpxxod','clearCacheDataByKeys','下载超时','SQChc','1220680SszGOH','图片url获取失败','PIC','setCacheSilentScan','getHotUpdateCachePath','unlink','fileTypeFromFile','mfPxG','clearCache','downloadRichMedia','5710YyXZRw','originImageUrl','startsWith','364745xEvQhf','tmp','VNtkC','getStorageCleanService','group_rkey','getRkey','uploadFile','clearChatCache','util'];_0x4baf=function(){return _0x17b789;};return _0x4baf();}const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x321d20(0x171)]=_0x271682=>{const _0x3007ef=_0x321d20;for(const [_0x4b47c8,_0x4f1512]of downloadMediaTasks){_0x4f1512(_0x271682),downloadMediaTasks[_0x3007ef(0x1b3)](_0x4b47c8);}},setTimeout(()=>{const _0x3509ce=_0x321d20;napCatCore[_0x3509ce(0x1a3)](()=>{const _0xeced27=_0x3509ce;napCatCore[_0xeced27(0x16d)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x2fc856){const _0x18b70d=_0x321d20;return _0x289ea4[_0x18b70d(0x18a)](_0x2fc856);}static async['copyFile'](_0x4d574f,_0x2a9d4f){const _0x943aa2=_0x321d20;await napCatCore[_0x943aa2(0x199)][_0x943aa2(0x1af)](_0x4d574f,_0x2a9d4f);}static async['getFileSize'](_0x4f7b0f){const _0x5eeed7=_0x321d20;return await napCatCore[_0x5eeed7(0x199)][_0x5eeed7(0x16b)](_0x4f7b0f);}static async[_0x321d20(0x197)](_0x143cf8,_0x139f3e=ElementType[_0x321d20(0x186)],_0x5ebb7c=0x0){const _0x1f8b79=_0x321d20,_0x3859d5={'BWnEw':function(_0x6d7368,_0x1c5d4a){return _0x6d7368(_0x1c5d4a);},'DPIji':function(_0x3b42df,_0x208801){return _0x3b42df+_0x208801;},'eZSDZ':function(_0x380aeb,_0x5d2652){return _0x380aeb===_0x5d2652;}},_0x11f102=await _0x3859d5['BWnEw'](calculateFileMD5,_0x143cf8);let _0x191196=(await NTQQFileApi[_0x1f8b79(0x16e)](_0x143cf8))?.['ext']||'';_0x191196&&(_0x191196=_0x3859d5['DPIji']('.',_0x191196));let _0x37125c=''+_0x27e9e8['basename'](_0x143cf8);_0x3859d5[_0x1f8b79(0x19f)](_0x37125c['indexOf']('.'),-0x1)&&(_0x37125c+=_0x191196);const _0x3e8248=napCatCore['session'][_0x1f8b79(0x1ad)]()[_0x1f8b79(0x19a)]({'md5HexStr':_0x11f102,'fileName':_0x37125c,'elementType':_0x139f3e,'elementSubType':_0x5ebb7c,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x143cf8,_0x3e8248);const _0x2d7b5b=await NTQQFileApi[_0x1f8b79(0x16b)](_0x143cf8);return{'md5':_0x11f102,'fileName':_0x37125c,'path':_0x3e8248,'fileSize':_0x2d7b5b,'ext':_0x191196};}static async[_0x321d20(0x19d)](_0x5c6791,_0x1e087c,_0x300a7f,_0x19ec40,_0x374a55,_0x1eda96,_0x148e92=0x3e8*0x3c*0x2,_0x582d6f=![]){const _0x3b9566=_0x321d20,_0x453226={'mEUmU':function(_0x4c0b91,_0x537dfd,_0x157b93,_0x5cfb2c){return _0x4c0b91(_0x537dfd,_0x157b93,_0x5cfb2c);},'VNtkC':_0x3b9566(0x1ae),'mfPxG':_0x3b9566(0x1a9),'LDvpV':function(_0x107c9b,_0xe68ba3){return _0x107c9b(_0xe68ba3);},'mLTfE':function(_0x459ff6,_0x5ddb6d){return _0x459ff6(_0x5ddb6d);},'eFoxR':function(_0x2e708c){return _0x2e708c();},'HjTRF':function(_0x19fd4a,_0x23bcab,_0x1d2cea){return _0x19fd4a(_0x23bcab,_0x1d2cea);},'WisMl':function(_0x4cfae1,_0x87dc47,_0x1bdf7b,_0x3b26ac,_0x5304b9,_0x2c0cee,_0x523f3a,_0x4c3739,_0x3a8ce6,_0x4cfc1a){return _0x4cfae1(_0x87dc47,_0x1bdf7b,_0x3b26ac,_0x5304b9,_0x2c0cee,_0x523f3a,_0x4c3739,_0x3a8ce6,_0x4cfc1a);}};logDebug(_0x3b9566(0x1aa),_0x5c6791,_0x1e087c,_0x300a7f,_0x19ec40,_0x374a55,_0x1eda96,_0x148e92,_0x582d6f);if(_0x1eda96&&_0x388ad6[_0x3b9566(0x1b5)](_0x1eda96)){if(_0x582d6f)try{await _0x222893[_0x3b9566(0x189)](_0x1eda96);}catch(_0x1c0bee){}else return _0x1eda96;}return _0x453226[_0x3b9566(0x1a6)](logDebug,'start\x20downloadMedia',_0x5c6791,_0x1e087c,_0x300a7f,_0x19ec40,_0x374a55,_0x1eda96,_0x148e92,_0x582d6f),new Promise((_0x18e994,_0x466549)=>{const _0x288627=_0x3b9566,_0xe4e8f3={'FuSvk':function(_0xd32363,_0x54e67d,_0x33bcb5,_0x205c7b){return _0x453226['mEUmU'](_0xd32363,_0x54e67d,_0x33bcb5,_0x205c7b);},'GVUbx':_0x453226[_0x288627(0x193)],'fDvOE':function(_0x455869,_0x2939ae,_0x1dcb23){return _0x455869(_0x2939ae,_0x1dcb23);},'bcxJz':_0x453226[_0x288627(0x18b)],'VHwUf':function(_0x501f9a,_0x5871c8){const _0x39e2f2=_0x288627;return _0x453226[_0x39e2f2(0x173)](_0x501f9a,_0x5871c8);},'SQChc':function(_0x339c39,_0x5e8a1b){const _0xd5c8be=_0x288627;return _0x453226[_0xd5c8be(0x1ac)](_0x339c39,_0x5e8a1b);},'cvSzx':_0x288627(0x182)};let _0x399250=![];const _0x5f3906=_0xd1c0c=>{const _0x5875b1=_0x288627;_0xe4e8f3['FuSvk'](logDebug,_0xe4e8f3[_0x5875b1(0x169)],_0xd1c0c,_0x5c6791);if(_0xd1c0c[_0x5875b1(0x1a8)]===_0x5c6791){_0x399250=!![];let _0x59e0a2=_0xd1c0c['filePath'];if(_0x59e0a2[_0x5875b1(0x190)]('\x5c')){const _0x250995=sessionConfig[_0x5875b1(0x1a7)];_0xe4e8f3['fDvOE'](logDebug,_0xe4e8f3[_0x5875b1(0x1b2)],_0x250995),_0x59e0a2=_0x27e9e8[_0x5875b1(0x1b6)](_0x250995,_0x59e0a2);}_0xe4e8f3['VHwUf'](_0x18e994,_0x59e0a2);}};downloadMediaTasks['set'](_0x453226['eFoxR'](randomUUID),_0x5f3906),_0x453226[_0x288627(0x176)](setTimeout,()=>{const _0x58de5a=_0x288627;!_0x399250&&_0xe4e8f3[_0x58de5a(0x183)](_0x466549,_0xe4e8f3[_0x58de5a(0x172)]);},_0x148e92),napCatCore[_0x288627(0x19e)][_0x288627(0x1ad)]()[_0x288627(0x18d)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x5c6791,'chatType':_0x1e087c,'peerUid':_0x300a7f,'elementId':_0x19ec40,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x374a55});});}static async['getImageSize'](_0xde6437){const _0x27036c={'icZUK':function(_0x20187c,_0x1bb89f,_0x4c31d6){return _0x20187c(_0x1bb89f,_0x4c31d6);}};return new Promise((_0xb35431,_0x1f1a14)=>{const _0x17e4a0=_0x51af,_0x580ae7={'fUufe':function(_0x1174c4,_0x142c8e){return _0x1174c4(_0x142c8e);}};_0x27036c[_0x17e4a0(0x16a)](_0x52251b,_0xde6437,(_0x4d211c,_0x11447a)=>{const _0x35bb50=_0x17e4a0;_0x4d211c?_0x580ae7[_0x35bb50(0x19b)](_0x1f1a14,_0x4d211c):_0x580ae7['fUufe'](_0xb35431,_0x11447a);});});}static async[_0x321d20(0x1a0)](_0x40d811,_0x31790e){const _0x340347=_0x321d20,_0x3649d9={'BEuHp':_0x340347(0x1b9),'YSUTr':_0x340347(0x16c),'BfmIe':function(_0x1af9cb,_0x33bbcc){return _0x1af9cb+_0x33bbcc;},'abaFr':function(_0x3ae576,_0x2a5ea0){return _0x3ae576||_0x2a5ea0;},'ubIek':function(_0x16ea79,_0x13002a){return _0x16ea79||_0x13002a;},'kZbOz':function(_0x978ed5,_0x2eab68,_0xca2fb6){return _0x978ed5(_0x2eab68,_0xca2fb6);},'BaNZu':_0x340347(0x185)};if(!_0x40d811)return'';const _0x34de5b=_0x40d811[_0x340347(0x18f)],_0x42324a=_0x40d811['md5HexStr'],_0x3e2dd5=_0x40d811['md5HexStr'],_0x3ab477=_0x40d811[_0x340347(0x17f)];if(_0x34de5b){if(_0x34de5b[_0x340347(0x190)](_0x3649d9[_0x340347(0x178)])){if(_0x34de5b[_0x340347(0x1b0)](_0x3649d9[_0x340347(0x179)]))return _0x3649d9[_0x340347(0x17a)](IMAGE_HTTP_HOST_NT,_0x34de5b);const _0x544a35=await rkeyManager[_0x340347(0x196)](),_0x4bae28=_0x31790e?_0x544a35[_0x340347(0x177)]:_0x544a35[_0x340347(0x195)];return _0x3649d9[_0x340347(0x17a)](IMAGE_HTTP_HOST_NT+_0x34de5b,''+_0x4bae28);}else return _0x3649d9[_0x340347(0x17a)](IMAGE_HTTP_HOST,_0x34de5b);}else{if(_0x3649d9[_0x340347(0x1b8)](_0x3e2dd5,_0x42324a))return IMAGE_HTTP_HOST+_0x340347(0x1b4)+_0x3649d9[_0x340347(0x17e)](_0x3e2dd5,_0x42324a)[_0x340347(0x1ab)]()+'/0';}return _0x3649d9['kZbOz'](logDebug,_0x3649d9[_0x340347(0x1ba)],_0x40d811),'';}}export class NTQQFileCacheApi{static async[_0x321d20(0x187)](_0x3151b8=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x321d20(0x18c)](_0x34305d=[_0x321d20(0x192),_0x321d20(0x19c)]){const _0x5ad679=_0x321d20;return napCatCore[_0x5ad679(0x19e)]['getStorageCleanService']()[_0x5ad679(0x181)](_0x34305d);}static['addCacheScannedPaths'](_0x586a7f={}){const _0x5d0563=_0x321d20;return napCatCore['session']['getStorageCleanService']()[_0x5d0563(0x1a5)](_0x586a7f);}static['scanCache'](){const _0x33b34e=_0x321d20;return napCatCore[_0x33b34e(0x19e)][_0x33b34e(0x194)]()[_0x33b34e(0x16f)]();}static[_0x321d20(0x188)](){return'';}static[_0x321d20(0x174)](){return'';}static[_0x321d20(0x17d)](_0x37371f,_0x5347d2=0x3e8,_0x1f0ffa=0x0){const _0x158c06=_0x321d20;return napCatCore[_0x158c06(0x19e)][_0x158c06(0x194)]()['getChatCacheInfo'](_0x37371f,_0x5347d2,0x1,_0x1f0ffa);}static[_0x321d20(0x1b7)](_0xab53a4,_0x576105=0x3e8,_0x10ef69){const _0x25d6dd=_0x10ef69?_0x10ef69:{'fileType':_0xab53a4};}static async[_0x321d20(0x198)](_0x4d2df9=[],_0x4ed33d=[]){const _0x448c26=_0x321d20;return napCatCore[_0x448c26(0x19e)][_0x448c26(0x194)]()['clearChatCacheInfo'](_0x4d2df9,_0x4ed33d);}}