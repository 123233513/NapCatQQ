const _0x2bdd3b=_0x2eb2;(function(_0x266cc8,_0xf7a30e){const _0x4fa071=_0x2eb2,_0x158715=_0x266cc8();while(!![]){try{const _0x302278=-parseInt(_0x4fa071(0xf1))/0x1+parseInt(_0x4fa071(0xe2))/0x2+parseInt(_0x4fa071(0xfc))/0x3*(parseInt(_0x4fa071(0x10d))/0x4)+parseInt(_0x4fa071(0xeb))/0x5+-parseInt(_0x4fa071(0x113))/0x6*(-parseInt(_0x4fa071(0x103))/0x7)+-parseInt(_0x4fa071(0xf5))/0x8+-parseInt(_0x4fa071(0xdb))/0x9*(parseInt(_0x4fa071(0xf7))/0xa);if(_0x302278===_0xf7a30e)break;else _0x158715['push'](_0x158715['shift']());}catch(_0x13f9ad){_0x158715['push'](_0x158715['shift']());}}}(_0x5ded,0x8dbec));function _0x5ded(){const _0x998065=['urlResult','FVOVo','join','copyFile','pxsxk','getFileType','kPNJl','ILsnC','203248MOCtLX','hotUpdate','&rkey=','toUpperCase','getImageUrl','lnEhG','19614odjXFV','util','ext','group_rkey','getRichMediaService','getVideoUrl','getRichMediaFilePathForGuild','downloadRichMedia','下载超时','zIoTx','includes','clearCacheDataByKeys','addListener','startsWith','GZvpe','unlink','setCacheSilentScan','sOjFH','tmp','getStorageCleanService','onRichMediaDownloadComplete','getFileCacheInfo','getRkey','2034CdDUeM','getImageSize','eKLRu','onLoginSuccess','msgId','downloadMedia','domainUrl','1847012hhWtvl','MDSyT','getChatCacheInfo','addCacheScannedPaths','zDQGz','clearCache','getFileSize','md5HexStr','scanCache','5225840HTACJF','url','mtPuv','set','clearChatCache','addCacheScanedPaths','960113RVLyKC','CTWUf','dXWjN','clJXr','8807088OJQKjU','getMsgService','21320ulBPaO','图片url获取失败','cEtsT','peerUid','fileTypeFromFile','51ectDEx','getVideoPlayUrlV2','/gchatpic_new/0/0-0-','chatType','/download','session','clearChatCacheInfo','623WjaCBA','existsSync'];_0x5ded=function(){return _0x998065;};return _0x5ded();}import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x26bb1a from'path';import _0xf55a7f from'fs';import _0x391cd1 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x284c94 from'file-type';import{MsgListener}from'@/core/listeners';function _0x2eb2(_0x4f304a,_0x3ce09d){const _0x5ded4a=_0x5ded();return _0x2eb2=function(_0x2eb21c,_0x29874c){_0x2eb21c=_0x2eb21c-0xd5;let _0x4c4245=_0x5ded4a[_0x2eb21c];return _0x4c4245;},_0x2eb2(_0x4f304a,_0x3ce09d);}import _0x24259e from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x2bdd3b(0xd8)]=_0x23abce=>{for(const [_0x3e5c70,_0x1aec26]of downloadMediaTasks){_0x1aec26(_0x23abce),downloadMediaTasks['delete'](_0x3e5c70);}},setTimeout(()=>{const _0x57dd4b=_0x2bdd3b;napCatCore[_0x57dd4b(0xde)](()=>{const _0x597ec5=_0x57dd4b;napCatCore[_0x597ec5(0x11f)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x2bdd3b(0x10a)](_0x50d1ae){const _0x3e9191=_0x2bdd3b;return _0x284c94[_0x3e9191(0xfb)](_0x50d1ae);}static async['copyFile'](_0x3892f8,_0x4c3d7b){const _0x55d4cc=_0x2bdd3b;await napCatCore[_0x55d4cc(0x114)]['copyFile'](_0x3892f8,_0x4c3d7b);}static async[_0x2bdd3b(0xe8)](_0x5e5ad8){const _0x13b86a=_0x2bdd3b;return await napCatCore[_0x13b86a(0x114)]['getFileSize'](_0x5e5ad8);}static async[_0x2bdd3b(0x118)](_0x691810,_0x5afad1){const _0x54beb8=_0x2bdd3b;return(await napCatCore[_0x54beb8(0x101)][_0x54beb8(0x117)]()[_0x54beb8(0xfd)]({'chatType':_0x691810[_0x54beb8(0xff)],'peerUid':_0x691810[_0x54beb8(0xfa)],'guildId':'0'},_0x691810[_0x54beb8(0xdf)],_0x5afad1['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x54beb8(0x105)][_0x54beb8(0xe1)][0x0][_0x54beb8(0xec)];}static async['uploadFile'](_0x19adf0,_0x18e110=ElementType['PIC'],_0x2eef21=0x0){const _0x22a5c6=_0x2bdd3b,_0x157fa5={'sOjFH':function(_0x4551d3,_0x5a86bc){return _0x4551d3(_0x5a86bc);},'FVOVo':function(_0x3ec294,_0x5bdf40){return _0x3ec294+_0x5bdf40;},'MDSyT':function(_0x3f83e4,_0x593852){return _0x3f83e4===_0x593852;}},_0x41303d=await _0x157fa5[_0x22a5c6(0xd5)](calculateFileMD5,_0x19adf0);let _0xadec6d=(await NTQQFileApi['getFileType'](_0x19adf0))?.[_0x22a5c6(0x115)]||'';_0xadec6d&&(_0xadec6d=_0x157fa5[_0x22a5c6(0x106)]('.',_0xadec6d));let _0xffa011=''+_0x26bb1a['basename'](_0x19adf0);_0x157fa5[_0x22a5c6(0xe3)](_0xffa011['indexOf']('.'),-0x1)&&(_0xffa011+=_0xadec6d);const _0x4e04e0=napCatCore[_0x22a5c6(0x101)][_0x22a5c6(0xf6)]()[_0x22a5c6(0x119)]({'md5HexStr':_0x41303d,'fileName':_0xffa011,'elementType':_0x18e110,'elementSubType':_0x2eef21,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x22a5c6(0x108)](_0x19adf0,_0x4e04e0);const _0x1b37ff=await NTQQFileApi[_0x22a5c6(0xe8)](_0x19adf0);return{'md5':_0x41303d,'fileName':_0xffa011,'path':_0x4e04e0,'fileSize':_0x1b37ff,'ext':_0xadec6d};}static async[_0x2bdd3b(0xe0)](_0x428765,_0x37137c,_0x18b1cb,_0x3d476f,_0x35b683,_0xfb4b57,_0x54fd3a=0x3e8*0x3c*0x2,_0x549b27=![]){const _0xe62d15=_0x2bdd3b,_0x3dd112={'lnEhG':function(_0x264b4f,_0x125c4f){return _0x264b4f(_0x125c4f);},'CTWUf':_0xe62d15(0x11b),'kPNJl':function(_0x5d0800){return _0x5d0800();}};if(_0xfb4b57&&_0xf55a7f[_0xe62d15(0x104)](_0xfb4b57)){if(_0x549b27)try{await _0x391cd1[_0xe62d15(0x122)](_0xfb4b57);}catch(_0x3c67a9){}else return _0xfb4b57;}return new Promise((_0x59eb5b,_0xd4ec87)=>{const _0x25d3ed=_0xe62d15,_0x4a96e0={'eKLRu':function(_0x5b3501,_0x3acc0d){const _0x2f92d8=_0x2eb2;return _0x3dd112[_0x2f92d8(0x112)](_0x5b3501,_0x3acc0d);},'pxsxk':_0x3dd112[_0x25d3ed(0xf2)]};let _0x35f967=![];const _0x2c1030=_0x226d8f=>{const _0x49cb0c=_0x25d3ed;if(_0x226d8f['msgId']===_0x428765){_0x35f967=!![];let _0x5a0f1e=_0x226d8f['filePath'];if(_0x5a0f1e[_0x49cb0c(0x120)]('\x5c')){const _0x568223=sessionConfig['defaultFileDownloadPath'];_0x5a0f1e=_0x26bb1a[_0x49cb0c(0x107)](_0x568223,_0x5a0f1e);}_0x59eb5b(_0x5a0f1e);}};downloadMediaTasks[_0x25d3ed(0xee)](_0x3dd112[_0x25d3ed(0x10b)](randomUUID),_0x2c1030),setTimeout(()=>{const _0x50eab2=_0x25d3ed;!_0x35f967&&_0x4a96e0[_0x50eab2(0xdd)](_0xd4ec87,_0x4a96e0[_0x50eab2(0x109)]);},_0x54fd3a),napCatCore['session']['getMsgService']()[_0x25d3ed(0x11a)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x428765,'chatType':_0x37137c,'peerUid':_0x18b1cb,'elementId':_0x3d476f,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x35b683});});}static async[_0x2bdd3b(0xdc)](_0x445252){const _0x4dce23={'dXWjN':function(_0xecfbf6,_0x39fb49){return _0xecfbf6(_0x39fb49);},'CuwlW':function(_0x24ae93,_0x4676e6){return _0x24ae93(_0x4676e6);},'zIoTx':function(_0x4cb9c2,_0x2b726c,_0x27d18f){return _0x4cb9c2(_0x2b726c,_0x27d18f);}};return new Promise((_0x2c8503,_0x1853bd)=>{const _0x17ddc8=_0x2eb2;_0x4dce23[_0x17ddc8(0x11c)](_0x24259e,_0x445252,(_0x3caea6,_0x370295)=>{const _0x100db8=_0x17ddc8;_0x3caea6?_0x4dce23[_0x100db8(0xf3)](_0x1853bd,_0x3caea6):_0x4dce23['CuwlW'](_0x2c8503,_0x370295);});});}static async[_0x2bdd3b(0x111)](_0x8e00d7,_0x3b23e1){const _0x356f6d=_0x2bdd3b,_0x4de311={'ILsnC':_0x356f6d(0x100),'cEtsT':_0x356f6d(0x10f),'mtPuv':function(_0x5df1de,_0x28579f){return _0x5df1de+_0x28579f;},'clJXr':function(_0x3de6b5,_0x4100a3){return _0x3de6b5||_0x4100a3;},'zDQGz':function(_0x19bfdc,_0x32042,_0x31f4c3){return _0x19bfdc(_0x32042,_0x31f4c3);},'GZvpe':_0x356f6d(0xf8)};if(!_0x8e00d7)return'';const _0x132596=_0x8e00d7['originImageUrl'],_0x2e1995=_0x8e00d7[_0x356f6d(0xe9)],_0x33038c=_0x8e00d7[_0x356f6d(0xe9)],_0x452b69=_0x8e00d7['fileUuid'];if(_0x132596){if(_0x132596[_0x356f6d(0x120)](_0x4de311[_0x356f6d(0x10c)])){if(_0x132596[_0x356f6d(0x11d)](_0x4de311[_0x356f6d(0xf9)]))return _0x4de311[_0x356f6d(0xed)](IMAGE_HTTP_HOST_NT,_0x132596);const _0x55b73f=await rkeyManager[_0x356f6d(0xda)](),_0x451dfe=_0x3b23e1?_0x55b73f['private_rkey']:_0x55b73f[_0x356f6d(0x116)];return _0x4de311[_0x356f6d(0xed)](IMAGE_HTTP_HOST_NT+_0x132596,''+_0x451dfe);}else return IMAGE_HTTP_HOST+_0x132596;}else{if(_0x4de311['clJXr'](_0x33038c,_0x2e1995))return IMAGE_HTTP_HOST+_0x356f6d(0xfe)+_0x4de311[_0x356f6d(0xf4)](_0x33038c,_0x2e1995)[_0x356f6d(0x110)]()+'/0';}return _0x4de311[_0x356f6d(0xe6)](logDebug,_0x4de311[_0x356f6d(0x121)],_0x8e00d7),'';}}export class NTQQFileCacheApi{static async[_0x2bdd3b(0x123)](_0x583fda=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x2bdd3b(0xe7)](_0x73acad=[_0x2bdd3b(0xd6),_0x2bdd3b(0x10e)]){const _0x308517=_0x2bdd3b;return napCatCore[_0x308517(0x101)]['getStorageCleanService']()[_0x308517(0x11e)](_0x73acad);}static[_0x2bdd3b(0xe5)](_0x31024f={}){const _0x11dfe8=_0x2bdd3b;return napCatCore[_0x11dfe8(0x101)][_0x11dfe8(0xd7)]()[_0x11dfe8(0xf0)](_0x31024f);}static['scanCache'](){const _0xb30749=_0x2bdd3b;return napCatCore[_0xb30749(0x101)][_0xb30749(0xd7)]()[_0xb30749(0xea)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static['getChatCacheList'](_0x26c615,_0x256722=0x3e8,_0x488375=0x0){const _0x1b5209=_0x2bdd3b;return napCatCore[_0x1b5209(0x101)][_0x1b5209(0xd7)]()[_0x1b5209(0xe4)](_0x26c615,_0x256722,0x1,_0x488375);}static[_0x2bdd3b(0xd9)](_0xc1ac28,_0x9a76c3=0x3e8,_0x551cd1){const _0x4fa808=_0x551cd1?_0x551cd1:{'fileType':_0xc1ac28};}static async[_0x2bdd3b(0xef)](_0x284b98=[],_0xbd1ed2=[]){const _0x18599b=_0x2bdd3b;return napCatCore[_0x18599b(0x101)][_0x18599b(0xd7)]()[_0x18599b(0x102)](_0x284b98,_0xbd1ed2);}}