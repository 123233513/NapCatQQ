const _0x23835f=_0x1f26;(function(_0x178da4,_0x4cca5a){const _0x3c5f88=_0x1f26,_0x9fc8f9=_0x178da4();while(!![]){try{const _0x4ff37a=parseInt(_0x3c5f88(0x123))/0x1+-parseInt(_0x3c5f88(0x13e))/0x2*(parseInt(_0x3c5f88(0x119))/0x3)+parseInt(_0x3c5f88(0x157))/0x4+-parseInt(_0x3c5f88(0x111))/0x5*(parseInt(_0x3c5f88(0x112))/0x6)+-parseInt(_0x3c5f88(0x128))/0x7*(parseInt(_0x3c5f88(0x13c))/0x8)+parseInt(_0x3c5f88(0x156))/0x9+parseInt(_0x3c5f88(0x164))/0xa*(parseInt(_0x3c5f88(0x11f))/0xb);if(_0x4ff37a===_0x4cca5a)break;else _0x9fc8f9['push'](_0x9fc8f9['shift']());}catch(_0xc239fc){_0x9fc8f9['push'](_0x9fc8f9['shift']());}}}(_0x9854,0xbf7b8));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x545920 from'path';function _0x1f26(_0xa75469,_0x569cb3){const _0x9854db=_0x9854();return _0x1f26=function(_0x1f2652,_0x57d6ba){_0x1f2652=_0x1f2652-0x10f;let _0x461048=_0x9854db[_0x1f2652];return _0x461048;},_0x1f26(_0xa75469,_0x569cb3);}import _0x2a4001 from'fs';function _0x9854(){const _0x21cba8=['addCacheScannedPaths','util','addCacheScanedPaths','MlTzQ','oigbW','GvZKk','/gchatpic_new/0/0-0-','wmBiP','3920wBOBZp','rbVOr','downloadRichMedia','5YUtirx','7883334GQRYIX','clearCache','irzSL','md5HexStr','getRkey','includes','start\x20downloadMedia','9hcfiVF','MaCnP','getRichMediaFilePathForGuild','copyFile','uploadFile','wUTNy','29579QKszHJ','getMsgService','getImageUrl','下载超时','915870AurKDO','downloadMedia\x20complete','join','getDesktopTmpPath','图片url获取失败','7rFIwOc','zVwGI','MWRjx','kIiqd','KzTIf','cKrCK','unlink','toUpperCase','LUwhH','downloadMedia','onRichMediaDownloadComplete','qZHeu','msgId','ext','HObqD','receive\x20downloadMedia\x20task','hJXoc','delete','IGFZw','group_rkey','348136wSRVgX','setCacheSilentScan','819600vxoxon','session','onLoginSuccess','startsWith','getHotUpdateCachePath','getFileCacheInfo','fileTypeFromFile','downloadPath','OTAXf','DetYr','noPNY','PIC','getFileType','getCacheSessionPathList','getStorageCleanService','existsSync','EZidG','clearCacheDataByKeys','filePath','tmp','clearChatCacheInfo','set','getChatCacheInfo','hotUpdate','4207752oISxVi','3734528YCJMVr','scanCache','getImageSize','getChatCacheList','getFileSize'];_0x9854=function(){return _0x21cba8;};return _0x9854();}import _0x1bd36a from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x2e75cd from'file-type';import{MsgListener}from'@/core/listeners';import _0x56f517 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x23835f(0x132)]=_0x2c2874=>{const _0x445d7e=_0x23835f;for(const [_0x5081b6,_0x483fb9]of downloadMediaTasks){_0x483fb9(_0x2c2874),downloadMediaTasks[_0x445d7e(0x139)](_0x5081b6);}},setTimeout(()=>{const _0x549b0b=_0x23835f;napCatCore[_0x549b0b(0x140)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x23835f(0x14a)](_0x2b5fcc){const _0x16fc3c=_0x23835f;return _0x2e75cd[_0x16fc3c(0x144)](_0x2b5fcc);}static async[_0x23835f(0x11c)](_0x2ce61f,_0x3af45a){const _0xbb07b1=_0x23835f;await napCatCore[_0xbb07b1(0x15d)][_0xbb07b1(0x11c)](_0x2ce61f,_0x3af45a);}static async['getFileSize'](_0x32dddb){const _0x540623=_0x23835f;return await napCatCore['util'][_0x540623(0x15b)](_0x32dddb);}static async[_0x23835f(0x11d)](_0x378c18,_0xfb5c8d=ElementType[_0x23835f(0x149)],_0x33c008=0x0){const _0x117ad7=_0x23835f,_0x25d04e={'hJXoc':function(_0x11970b,_0x3cc7fe){return _0x11970b(_0x3cc7fe);},'KzTIf':function(_0x167a89,_0x4a9414){return _0x167a89===_0x4a9414;}},_0x4cf355=await _0x25d04e[_0x117ad7(0x138)](calculateFileMD5,_0x378c18);let _0x5a21f8=(await NTQQFileApi[_0x117ad7(0x14a)](_0x378c18))?.[_0x117ad7(0x135)]||'';_0x5a21f8&&(_0x5a21f8='.'+_0x5a21f8);let _0x4c96fb=''+_0x545920['basename'](_0x378c18);_0x25d04e[_0x117ad7(0x12c)](_0x4c96fb['indexOf']('.'),-0x1)&&(_0x4c96fb+=_0x5a21f8);const _0x3f98c7=napCatCore[_0x117ad7(0x13f)][_0x117ad7(0x120)]()[_0x117ad7(0x11b)]({'md5HexStr':_0x4cf355,'fileName':_0x4c96fb,'elementType':_0xfb5c8d,'elementSubType':_0x33c008,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x117ad7(0x11c)](_0x378c18,_0x3f98c7);const _0x2c4a18=await NTQQFileApi['getFileSize'](_0x378c18);return{'md5':_0x4cf355,'fileName':_0x4c96fb,'path':_0x3f98c7,'fileSize':_0x2c4a18,'ext':_0x5a21f8};}static async[_0x23835f(0x131)](_0x285687,_0x4f0f64,_0x4d66e0,_0x88e329,_0x1b3226,_0x160486,_0x2597e2=0x3e8*0x3c*0x2,_0xb2ef99=![]){const _0xf52bc8=_0x23835f,_0x411664={'kIiqd':_0xf52bc8(0x124),'wUTNy':_0xf52bc8(0x145),'RtHIB':function(_0x1ff8a8){return _0x1ff8a8();},'MGgNC':function(_0x662d7a,_0x9b07fe,_0x3e994b){return _0x662d7a(_0x9b07fe,_0x3e994b);},'zVwGI':function(_0x6228f0,_0x38438c,_0x2ed0e6,_0x38b048,_0x183da7,_0x3853ea,_0x5a7335,_0x39f789,_0x4e10d1,_0x35f638){return _0x6228f0(_0x38438c,_0x2ed0e6,_0x38b048,_0x183da7,_0x3853ea,_0x5a7335,_0x39f789,_0x4e10d1,_0x35f638);},'oigbW':_0xf52bc8(0x118)};logDebug(_0xf52bc8(0x137),_0x285687,_0x4f0f64,_0x4d66e0,_0x88e329,_0x1b3226,_0x160486,_0x2597e2,_0xb2ef99);if(_0x160486&&_0x2a4001[_0xf52bc8(0x14d)](_0x160486)){if(_0xb2ef99)try{await _0x1bd36a[_0xf52bc8(0x12e)](_0x160486);}catch(_0x2e77c6){}else return _0x160486;}return _0x411664[_0xf52bc8(0x129)](logDebug,_0x411664[_0xf52bc8(0x160)],_0x285687,_0x4f0f64,_0x4d66e0,_0x88e329,_0x1b3226,_0x160486,_0x2597e2,_0xb2ef99),new Promise((_0xf9926c,_0x4ac890)=>{const _0x303c28=_0xf52bc8,_0x527b77={'noPNY':function(_0x118ed2,_0x4cc46a,_0x4a4151,_0x58902f){return _0x118ed2(_0x4cc46a,_0x4a4151,_0x58902f);},'rbVOr':_0x411664[_0x303c28(0x12b)],'Bolgi':_0x411664[_0x303c28(0x11e)],'DetYr':function(_0x479f53,_0x4ceab3){return _0x479f53(_0x4ceab3);},'wmBiP':_0x303c28(0x122)};let _0x430512=![];const _0x2fab12=_0x262c59=>{const _0x27942c=_0x303c28;_0x527b77[_0x27942c(0x148)](logDebug,_0x527b77[_0x27942c(0x10f)],_0x262c59,_0x285687);if(_0x262c59[_0x27942c(0x134)]===_0x285687){_0x430512=!![];let _0x54c720=_0x262c59[_0x27942c(0x150)];if(_0x54c720[_0x27942c(0x141)]('\x5c')){const _0x17b16f=sessionConfig['defaultFileDownloadPath'];logDebug(_0x527b77['Bolgi'],_0x17b16f),_0x54c720=_0x545920[_0x27942c(0x125)](_0x17b16f,_0x54c720);}_0xf9926c(_0x54c720);}};downloadMediaTasks[_0x303c28(0x153)](_0x411664['RtHIB'](randomUUID),_0x2fab12),_0x411664['MGgNC'](setTimeout,()=>{const _0x32e0ec=_0x303c28;!_0x430512&&_0x527b77[_0x32e0ec(0x147)](_0x4ac890,_0x527b77[_0x32e0ec(0x163)]);},_0x2597e2),napCatCore[_0x303c28(0x13f)]['getMsgService']()[_0x303c28(0x110)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x285687,'chatType':_0x4f0f64,'peerUid':_0x4d66e0,'elementId':_0x88e329,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1b3226});});}static async[_0x23835f(0x159)](_0x56ce14){const _0x4adb33={'cKrCK':function(_0x7654ea,_0x5c5b1c){return _0x7654ea(_0x5c5b1c);},'irzSL':function(_0x1aad0f,_0x566981,_0x1bb26a){return _0x1aad0f(_0x566981,_0x1bb26a);}};return new Promise((_0x12e409,_0x4b508c)=>{const _0x3c9e1b=_0x1f26;_0x4adb33[_0x3c9e1b(0x114)](_0x56f517,_0x56ce14,(_0x137a16,_0x550b0d)=>{const _0x39c6ed=_0x3c9e1b;_0x137a16?_0x4adb33[_0x39c6ed(0x12d)](_0x4b508c,_0x137a16):_0x4adb33[_0x39c6ed(0x12d)](_0x12e409,_0x550b0d);});});}static async[_0x23835f(0x121)](_0x4fbcc0,_0x25df88){const _0x36dc61=_0x23835f,_0x464ac9={'IGFZw':'/download','MlTzQ':'&rkey=','EZidG':function(_0x1bd3ad,_0x49279e){return _0x1bd3ad+_0x49279e;},'OTAXf':function(_0x5e483b,_0x3d5ab5){return _0x5e483b+_0x3d5ab5;},'MaCnP':function(_0x21bacc,_0x587893){return _0x21bacc+_0x587893;},'qZHeu':function(_0x7e088d,_0x328367){return _0x7e088d+_0x328367;},'LUwhH':function(_0x4727e5,_0x536f45){return _0x4727e5||_0x536f45;},'MWRjx':function(_0x10ba6f,_0x3a06e4){return _0x10ba6f||_0x3a06e4;},'GvZKk':function(_0x38b8bb,_0x542955,_0x2ba5fa){return _0x38b8bb(_0x542955,_0x2ba5fa);},'HObqD':_0x36dc61(0x127)};if(!_0x4fbcc0)return'';const _0x2fc8d2=_0x4fbcc0['originImageUrl'],_0x52941f=_0x4fbcc0[_0x36dc61(0x115)],_0x355253=_0x4fbcc0[_0x36dc61(0x115)],_0x2441f7=_0x4fbcc0['fileUuid'];if(_0x2fc8d2){if(_0x2fc8d2[_0x36dc61(0x141)](_0x464ac9[_0x36dc61(0x13a)])){if(_0x2fc8d2[_0x36dc61(0x117)](_0x464ac9[_0x36dc61(0x15f)]))return _0x464ac9[_0x36dc61(0x14e)](IMAGE_HTTP_HOST_NT,_0x2fc8d2);const _0x52fc1a=await rkeyManager[_0x36dc61(0x116)](),_0x228a54=_0x25df88?_0x52fc1a['private_rkey']:_0x52fc1a[_0x36dc61(0x13b)];return _0x464ac9[_0x36dc61(0x146)](_0x464ac9[_0x36dc61(0x11a)](IMAGE_HTTP_HOST_NT,_0x2fc8d2),''+_0x228a54);}else return _0x464ac9[_0x36dc61(0x133)](IMAGE_HTTP_HOST,_0x2fc8d2);}else{if(_0x464ac9[_0x36dc61(0x130)](_0x355253,_0x52941f))return IMAGE_HTTP_HOST+_0x36dc61(0x162)+_0x464ac9[_0x36dc61(0x12a)](_0x355253,_0x52941f)[_0x36dc61(0x12f)]()+'/0';}return _0x464ac9[_0x36dc61(0x161)](logDebug,_0x464ac9[_0x36dc61(0x136)],_0x4fbcc0),'';}}export class NTQQFileCacheApi{static async[_0x23835f(0x13d)](_0x241a9c=!![]){return'';}static[_0x23835f(0x14b)](){return'';}static[_0x23835f(0x113)](_0x4272be=[_0x23835f(0x151),_0x23835f(0x155)]){const _0x10310e=_0x23835f;return napCatCore[_0x10310e(0x13f)][_0x10310e(0x14c)]()[_0x10310e(0x14f)](_0x4272be);}static[_0x23835f(0x15c)](_0x6a5ab3={}){const _0xec31af=_0x23835f;return napCatCore[_0xec31af(0x13f)]['getStorageCleanService']()[_0xec31af(0x15e)](_0x6a5ab3);}static[_0x23835f(0x158)](){const _0x4276c2=_0x23835f;return napCatCore[_0x4276c2(0x13f)][_0x4276c2(0x14c)]()['scanCache']();}static[_0x23835f(0x142)](){return'';}static[_0x23835f(0x126)](){return'';}static[_0x23835f(0x15a)](_0x23ef51,_0x2bee90=0x3e8,_0x3ba9f7=0x0){const _0x18d1c6=_0x23835f;return napCatCore[_0x18d1c6(0x13f)][_0x18d1c6(0x14c)]()[_0x18d1c6(0x154)](_0x23ef51,_0x2bee90,0x1,_0x3ba9f7);}static[_0x23835f(0x143)](_0x1e6703,_0x47eb51=0x3e8,_0x36f61f){const _0x2d5795=_0x36f61f?_0x36f61f:{'fileType':_0x1e6703};}static async['clearChatCache'](_0x234cda=[],_0x774559=[]){const _0x4ab0e2=_0x23835f;return napCatCore[_0x4ab0e2(0x13f)]['getStorageCleanService']()[_0x4ab0e2(0x152)](_0x234cda,_0x774559);}}