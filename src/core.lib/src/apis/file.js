const _0x51abdb=_0x27be;(function(_0x394462,_0x54dfe6){const _0x240725=_0x27be,_0x1b6a1b=_0x394462();while(!![]){try{const _0x4a7857=-parseInt(_0x240725(0x19a))/0x1+-parseInt(_0x240725(0x180))/0x2+parseInt(_0x240725(0x1a6))/0x3*(parseInt(_0x240725(0x1ad))/0x4)+parseInt(_0x240725(0x153))/0x5*(-parseInt(_0x240725(0x1a3))/0x6)+-parseInt(_0x240725(0x1af))/0x7+parseInt(_0x240725(0x17a))/0x8*(-parseInt(_0x240725(0x190))/0x9)+parseInt(_0x240725(0x1b4))/0xa;if(_0x4a7857===_0x54dfe6)break;else _0x1b6a1b['push'](_0x1b6a1b['shift']());}catch(_0x5dcec0){_0x1b6a1b['push'](_0x1b6a1b['shift']());}}}(_0x14a6,0x936a2));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x5f0b42 from'path';import _0x588733 from'fs';import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x38e6e4 from'file-type';import{MsgListener}from'@/core/listeners';import _0xba0b96 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x27be(_0x24813f,_0x9c1b11){const _0x14a609=_0x14a6();return _0x27be=function(_0x27be2b,_0x1010f1){_0x27be2b=_0x27be2b-0x152;let _0x179ca2=_0x14a609[_0x27be2b];return _0x179ca2;},_0x27be(_0x24813f,_0x9c1b11);}function _0x14a6(){const _0x1c36ff=['*/*','Check\x20rkey\x20headers:\x20','rcuYf','Problem\x20with\x20rkey\x20request:\x20','chatType','47025meOZcj','session','bkXZq','XRNUW','/download','UyxSc','XpgWm','headers','获取图片rkey...','6pVOrld','defaultFileDownloadPath','uploadFile','45sJlpDN','copyFile','getImageSize','setTimeout','getMsgService','startsWith','nmUkP','101668iAYNxr','error','4367426TrkxRk','statusCode','iWQhf','pathname','xhSSw','25365190UcLPmY','elements','jZJmY','lcBvb','eOFbw','xiXIs','getFileSize','EHgCF','eKKBn','4725720kZWnRe','cvBKi','now','CurwW','Ocwfz','GET','qMhNi','util','originImageUrl','getImageUrl','mjLtp','end','md5HexStr','Check\x20rkey\x20request\x20timed\x20out','fileUuid','picElement','Vygit','request','MlQct','PIC','下载超时','isAvailable','find','KjsUr','&rkey=','dhGiN','获取图片rkey失败','onRichMediaDownloadComplete','图片rkey获取成功','search','message','basename','getRichMediaFilePathForGuild','addListener','stringify','catch','/gchatpic_new/0/0-0-','downloadRichMedia','RUwca','2029256YmhWXd','KWsoR','existsSync','removeKernelMsgListener','bytes=0-0','downloadMedia','888440FPaDhd','toUpperCase','QpTOD','The\x20image\x20URL\x20is\x20not\x20accessible.','jeHjk','filePath','HRnCJ','3|4|2|0|1','HKMUi','Check\x20rkey\x20request\x20time:','peerUid','KpHUe','msgId','sourcePath','getFileType','fileTypeFromFile','9KyzdCK','LZafX','getRKey','ErPYY','join'];_0x14a6=function(){return _0x1c36ff;};return _0x14a6();}import _0xe128a1 from'http';import{hookApi}from'@/core/external/hook';import{sleep}from'@/common/utils/helper';export class NTQQFileApi{static async['getFileType'](_0xa9d413){const _0x427dbf=_0x27be;return _0x38e6e4[_0x427dbf(0x18f)](_0xa9d413);}static async[_0x51abdb(0x1a7)](_0x4bdf3b,_0x2ccc59){await napCatCore['util']['copyFile'](_0x4bdf3b,_0x2ccc59);}static async[_0x51abdb(0x1ba)](_0x51b203){const _0x24d5ff=_0x51abdb;return await napCatCore[_0x24d5ff(0x15a)][_0x24d5ff(0x1ba)](_0x51b203);}static async[_0x51abdb(0x1a5)](_0x557da2,_0x35d1a7=ElementType[_0x51abdb(0x166)],_0x436ad7=0x0){const _0x3ab202=_0x51abdb,_0x95cba7={'XpgWm':function(_0x3e630f,_0x236e57){return _0x3e630f(_0x236e57);},'iWQhf':function(_0x18c8c4,_0x388ece){return _0x18c8c4===_0x388ece;}},_0x5799ec=await _0x95cba7[_0x3ab202(0x1a0)](calculateFileMD5,_0x557da2);let _0x3c0477=(await NTQQFileApi[_0x3ab202(0x18e)](_0x557da2))?.['ext']||'';_0x3c0477&&(_0x3c0477='.'+_0x3c0477);let _0x1ae47c=''+_0x5f0b42[_0x3ab202(0x172)](_0x557da2);_0x95cba7[_0x3ab202(0x1b1)](_0x1ae47c['indexOf']('.'),-0x1)&&(_0x1ae47c+=_0x3c0477);const _0x4bfffa=napCatCore['session'][_0x3ab202(0x1aa)]()[_0x3ab202(0x173)]({'md5HexStr':_0x5799ec,'fileName':_0x1ae47c,'elementType':_0x35d1a7,'elementSubType':_0x436ad7,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x557da2,_0x4bfffa);const _0x5c2e77=await NTQQFileApi[_0x3ab202(0x1ba)](_0x557da2);return{'md5':_0x5799ec,'fileName':_0x1ae47c,'path':_0x4bfffa,'fileSize':_0x5c2e77,'ext':_0x3c0477};}static async[_0x51abdb(0x17f)](_0x18c91b,_0x1cb496,_0x595aff,_0x5430e3,_0x3ef216,_0x4e027c,_0x2803f2=0x3e8*0x3c*0x2,_0x10019a=![]){const _0x41f9e7=_0x51abdb,_0x221cd9={'KpHUe':function(_0x249261,_0x27fc39){return _0x249261===_0x27fc39;},'cvBKi':function(_0x18a06a,_0x2128ea){return _0x18a06a(_0x2128ea);},'rcuYf':function(_0x2cc033,_0x2fa05a,_0x10c05b){return _0x2cc033(_0x2fa05a,_0x10c05b);}};if(_0x4e027c&&_0x588733[_0x41f9e7(0x17c)](_0x4e027c)){if(_0x10019a)_0x588733['unlinkSync'](_0x4e027c);else return _0x4e027c;}const _0x26b828=new MsgListener();return new Promise((_0x4a1fad,_0x3ccb52)=>{const _0x48da8f=_0x41f9e7;let _0x10b4c9=![];_0x26b828[_0x48da8f(0x16e)]=_0x24e62e=>{const _0x4beab6=_0x48da8f;if(_0x221cd9[_0x4beab6(0x18b)](_0x24e62e[_0x4beab6(0x18c)],_0x18c91b)){_0x10b4c9=!![];let _0x2c188e=_0x24e62e[_0x4beab6(0x185)];if(_0x2c188e[_0x4beab6(0x1ab)]('\x5c')){const _0x29c64b=sessionConfig?.[_0x4beab6(0x1a4)];_0x2c188e=_0x5f0b42[_0x4beab6(0x194)](_0x29c64b,_0x2c188e);}_0x4a1fad(_0x2c188e),napCatCore[_0x4beab6(0x19b)][_0x4beab6(0x1aa)]()[_0x4beab6(0x17d)](_0x257435);}};const _0x257435=napCatCore[_0x48da8f(0x174)](_0x26b828);_0x221cd9[_0x48da8f(0x197)](setTimeout,()=>{const _0x20ae71=_0x48da8f;!_0x10b4c9&&(_0x221cd9[_0x20ae71(0x154)](_0x3ccb52,new Error(_0x20ae71(0x167))),napCatCore[_0x20ae71(0x19b)][_0x20ae71(0x1aa)]()[_0x20ae71(0x17d)](_0x257435));},_0x2803f2),napCatCore[_0x48da8f(0x19b)][_0x48da8f(0x1aa)]()[_0x48da8f(0x178)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x18c91b,'chatType':_0x1cb496,'peerUid':_0x595aff,'elementId':_0x5430e3,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3ef216});});}static async[_0x51abdb(0x1a8)](_0x1ef693){return new Promise((_0x296af7,_0x4e5845)=>{const _0x2724f4={'HRnCJ':function(_0x316008,_0x17a3cc){return _0x316008(_0x17a3cc);}};_0xba0b96(_0x1ef693,(_0x219423,_0x6aa04d)=>{const _0x1c3704=_0x27be;_0x219423?_0x4e5845(_0x219423):_0x2724f4[_0x1c3704(0x186)](_0x296af7,_0x6aa04d);});});}static async[_0x51abdb(0x15c)](_0x4a1afa){const _0x4798d0=_0x51abdb,_0x5b9a2b={'xiXIs':_0x4798d0(0x187),'qMhNi':function(_0x16ab6f,_0x3e1776,_0xb013f3){return _0x16ab6f(_0x3e1776,_0xb013f3);},'qFYfO':_0x4798d0(0x16f),'CurwW':function(_0x4901b1,_0x3d989a){return _0x4901b1(_0x3d989a);},'xhSSw':_0x4798d0(0x1a2),'KjsUr':function(_0x13bbb7,_0x4e823c){return _0x13bbb7(_0x4e823c);},'UyxSc':_0x4798d0(0x160),'Ocwfz':function(_0x395e82,_0x11bebf){return _0x395e82(_0x11bebf);},'cTLdM':_0x4798d0(0x158),'nmUkP':'Mozilla/5.0\x20(Windows\x20NT\x2010.0;\x20Win64;\x20x64)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/58.0.3029.110\x20Safari/537.36','LZafX':_0x4798d0(0x195),'hOovT':_0x4798d0(0x17e),'XRNUW':_0x4798d0(0x1ae),'jeHjk':_0x4798d0(0x19e),'EHgCF':_0x4798d0(0x16b),'eKKBn':function(_0x4ca97f,_0x5ddc4f){return _0x4ca97f+_0x5ddc4f;},'RUwca':function(_0x1e8d19,_0x50e171){return _0x1e8d19(_0x50e171);},'LxtIH':'hookApi\x20is\x20not\x20available','MlQct':function(_0x390fc2){return _0x390fc2();},'ErPYY':function(_0x25ede4,_0x50c903,_0x31b6ef){return _0x25ede4(_0x50c903,_0x31b6ef);},'hyehO':_0x4798d0(0x16d),'lcBvb':function(_0x4cca6c,_0x3e0ef1,_0x40d273){return _0x4cca6c(_0x3e0ef1,_0x40d273);},'KWsoR':function(_0x2f9bde,_0x2e7d64){return _0x2f9bde-_0x2e7d64;},'vyFEQ':'获取rkey失败','QpTOD':function(_0x38a8f6,_0x540182){return _0x38a8f6+_0x540182;},'HKMUi':function(_0x3cca0b,_0x37fa09){return _0x3cca0b||_0x37fa09;}},_0x500982=_0x4a1afa[_0x4798d0(0x1b5)][_0x4798d0(0x169)](_0x413149=>!!_0x413149[_0x4798d0(0x162)]);if(!_0x500982)return'';const _0x3f62b0=_0x500982[_0x4798d0(0x162)][_0x4798d0(0x15b)],_0x161973=_0x500982['picElement'][_0x4798d0(0x15f)],_0x404310=_0x500982[_0x4798d0(0x162)][_0x4798d0(0x15f)],_0x3c7ce1=_0x500982[_0x4798d0(0x162)][_0x4798d0(0x161)];let _0x41c205='';if(_0x3f62b0){if(_0x3f62b0[_0x4798d0(0x1ab)](_0x5b9a2b[_0x4798d0(0x184)])){if(_0x3f62b0['includes'](_0x5b9a2b[_0x4798d0(0x1bb)]))_0x41c205=_0x5b9a2b[_0x4798d0(0x152)](IMAGE_HTTP_HOST_NT,_0x3f62b0);else{if(!hookApi[_0x4798d0(0x168)]())return _0x5b9a2b[_0x4798d0(0x179)](logDebug,_0x5b9a2b['LxtIH']),'';let _0xba24c6=hookApi[_0x4798d0(0x192)]();const _0x25abd8=async()=>{const _0xdd1286=_0x4798d0,_0x28b1cc=_0x5b9a2b[_0xdd1286(0x1b9)]['split']('|');let _0x30e9de=0x0;while(!![]){switch(_0x28b1cc[_0x30e9de++]){case'0':_0xba24c6=hookApi[_0xdd1286(0x192)]();continue;case'1':_0xba24c6&&_0x5b9a2b[_0xdd1286(0x159)](logDebug,_0x5b9a2b['qFYfO'],_0xba24c6);continue;case'2':await _0x5b9a2b[_0xdd1286(0x156)](sleep,0x12c);continue;case'3':logDebug(_0x5b9a2b[_0xdd1286(0x1b3)]);continue;case'4':NTQQFileApi[_0xdd1286(0x17f)](_0x4a1afa[_0xdd1286(0x18c)],_0x4a1afa[_0xdd1286(0x199)],_0x4a1afa[_0xdd1286(0x18a)],_0x500982['elementId'],'',_0x500982[_0xdd1286(0x162)][_0xdd1286(0x18d)],0x3e8,!![])['then']()[_0xdd1286(0x176)](()=>{});continue;}break;}};if(!_0xba24c6)try{await _0x5b9a2b['MlQct'](_0x25abd8);}catch(_0x5276eb){return _0x5b9a2b[_0x4798d0(0x193)](logError,_0x5b9a2b['hyehO'],_0x5276eb),'';}_0x41c205=_0x5b9a2b[_0x4798d0(0x152)](_0x5b9a2b[_0x4798d0(0x152)](IMAGE_HTTP_HOST_NT,_0x3f62b0),''+_0xba24c6);const _0x850404=new Promise((_0x2d54df,_0x1825e0)=>{const _0x2a2124=_0x4798d0,_0x1f47d0={'Vygit':function(_0xbbfbec,_0x1380e7){const _0x1b3dd7=_0x27be;return _0x5b9a2b[_0x1b3dd7(0x16a)](_0xbbfbec,_0x1380e7);},'mjLtp':function(_0x21eaef,_0x4b5eac){const _0x7c13ca=_0x27be;return _0x5b9a2b[_0x7c13ca(0x157)](_0x21eaef,_0x4b5eac);},'eOFbw':function(_0x12ebe1,_0x1d5586){return _0x12ebe1===_0x1d5586;},'bkXZq':function(_0x377dd0,_0x4b65bc){const _0x4ef6bb=_0x27be;return _0x5b9a2b[_0x4ef6bb(0x16a)](_0x377dd0,_0x4b65bc);},'dhGiN':function(_0x5dc39c,_0x2bfdda){const _0x5056b7=_0x27be;return _0x5b9a2b[_0x5056b7(0x156)](_0x5dc39c,_0x2bfdda);},'jZJmY':_0x2a2124(0x183)},_0x445d2f=new URL(_0x41c205),_0x6f4d79={'method':_0x5b9a2b['cTLdM'],'host':_0x445d2f['host'],'path':_0x445d2f[_0x2a2124(0x1b2)]+_0x445d2f[_0x2a2124(0x170)],'headers':{'User-Agent':_0x5b9a2b[_0x2a2124(0x1ac)],'Accept':_0x5b9a2b[_0x2a2124(0x191)],'Range':_0x5b9a2b['hOovT']}},_0x3dcdc2=_0xe128a1[_0x2a2124(0x164)](_0x6f4d79,_0xe35368=>{const _0x257e96=_0x2a2124;_0x1f47d0[_0x257e96(0x163)](logDebug,'Check\x20rkey\x20status:\x20'+_0xe35368[_0x257e96(0x1b0)]),_0x1f47d0[_0x257e96(0x15d)](logDebug,_0x257e96(0x196)+JSON[_0x257e96(0x175)](_0xe35368[_0x257e96(0x1a1)])),_0xe35368[_0x257e96(0x1b0)]==0xc8||_0x1f47d0[_0x257e96(0x1b8)](_0xe35368[_0x257e96(0x1b0)],0xce)?_0x1f47d0[_0x257e96(0x19c)](_0x2d54df,'ok'):_0x1f47d0[_0x257e96(0x16c)](_0x1825e0,_0x1f47d0[_0x257e96(0x1b6)]);});_0x3dcdc2[_0x2a2124(0x1a9)](0xbb8,()=>{const _0x4b35c4=_0x2a2124;_0x3dcdc2['destroy'](),_0x5b9a2b[_0x4b35c4(0x16a)](_0x1825e0,_0x5b9a2b[_0x4b35c4(0x19f)]);}),_0x3dcdc2['on'](_0x5b9a2b[_0x2a2124(0x19d)],_0x2dabac=>{const _0x6deff5=_0x2a2124;console[_0x6deff5(0x1ae)](_0x6deff5(0x198)+_0x2dabac[_0x6deff5(0x171)]),_0x1f47d0[_0x6deff5(0x15d)](_0x1825e0,_0x2dabac[_0x6deff5(0x171)]);}),_0x3dcdc2[_0x2a2124(0x15e)]();});try{const _0x22acf6=Date['now']();await _0x850404;const _0x1458b8=Date[_0x4798d0(0x155)]();_0x5b9a2b[_0x4798d0(0x1b7)](logDebug,_0x4798d0(0x189),_0x5b9a2b[_0x4798d0(0x17b)](_0x1458b8,_0x22acf6));}catch(_0x324781){try{await _0x5b9a2b[_0x4798d0(0x165)](_0x25abd8),_0x41c205=_0x5b9a2b['eKKBn'](_0x5b9a2b[_0x4798d0(0x152)](IMAGE_HTTP_HOST_NT,_0x3f62b0),''+_0xba24c6);}catch(_0x4e4c11){logError(_0x5b9a2b['vyFEQ'],_0x4e4c11);}}}}else _0x41c205=_0x5b9a2b[_0x4798d0(0x182)](IMAGE_HTTP_HOST,_0x3f62b0);}else _0x5b9a2b[_0x4798d0(0x188)](_0x404310,_0x161973)&&(_0x41c205=IMAGE_HTTP_HOST+_0x4798d0(0x177)+_0x5b9a2b[_0x4798d0(0x188)](_0x404310,_0x161973)[_0x4798d0(0x181)]()+'/0');return _0x41c205;}}
