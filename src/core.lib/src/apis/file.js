const _0x252bf0=_0x53ae;(function(_0x68550e,_0x3214b4){const _0x4c6c45=_0x53ae,_0x2b361d=_0x68550e();while(!![]){try{const _0x28babd=-parseInt(_0x4c6c45(0xcb))/0x1+-parseInt(_0x4c6c45(0xd9))/0x2+-parseInt(_0x4c6c45(0xcc))/0x3+-parseInt(_0x4c6c45(0xf8))/0x4*(parseInt(_0x4c6c45(0xae))/0x5)+parseInt(_0x4c6c45(0xd3))/0x6*(-parseInt(_0x4c6c45(0xf0))/0x7)+parseInt(_0x4c6c45(0xa6))/0x8+parseInt(_0x4c6c45(0xe5))/0x9*(parseInt(_0x4c6c45(0x10f))/0xa);if(_0x28babd===_0x3214b4)break;else _0x2b361d['push'](_0x2b361d['shift']());}catch(_0x3706a8){_0x2b361d['push'](_0x2b361d['shift']());}}}(_0x9c54,0x9dedc));import{ChatType,ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x589c9e from'path';import _0x2d8397 from'fs';import _0x3f2b02 from'fs/promises';function _0x53ae(_0x4a2f8b,_0x4ec85d){const _0x9c54fb=_0x9c54();return _0x53ae=function(_0x53aea6,_0xe1a80c){_0x53aea6=_0x53aea6-0xa0;let _0x16da26=_0x9c54fb[_0x53aea6];return _0x16da26;},_0x53ae(_0x4a2f8b,_0x4ec85d);}import{logDebug,logError}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x20034c from'file-type';import{MsgListener}from'@/core/listeners';function _0x9c54(){const _0x316faa=['downloadMedia','indexOf','onLoginSuccess','downloadRichMedia','ECvMm','fileTypeFromFile','/download','getFileType','picElement','getFileSize','TDNtb','eNzTD','unlink','join','getImageUrl','412946LTeiSM','3106971lxWwmq','catch','hotUpdate','downloadPath','mCgLM','iLwoP','isAvailable','48PCuSiG','util','onRichMediaDownloadComplete','existsSync','getChatCacheList','acTgO','1086462aUJmcV','sourcePath','HxTWw','rIOjy','xYsiy','delete','HOQjt','图片url获取失败','getStorageCleanService','图片rkey获取失败','EbZDF','addTask','27024993RmLMjy','nAzXj','now','getRichMediaFilePathForGuild','defaultFileDownloadPath','vPNTn','getFileCacheInfo','pGgOh','检查rkey是否有效','lpwKd','get','904953KzNOfI','NhvSD','DBmjg','nnuPf','chatType','xwtEL','LBBHi','SPiEx','4aYXMsl','peerUid','Bicss','receive\x20downloadMedia\x20task','fileUuid','EWXxO','clearCacheDataByKeys','getCacheSessionPathList','OdMZh','downloadMedia\x20complete','copyFile','lWQVH','iumJF','addCacheScanedPaths','md5HexStr','ext','group','clearChatCache','yPRgB','session','filePath','getHotUpdateCachePath','BjxtY','10FokZJQ','mQGHO','hookApi\x20is\x20not\x20available','gVChc','FlThr','addCacheScannedPaths','/gchatpic_new/0/0-0-','tmp','7118464JIubHJ','getMsgService','basename','msgId','set','clearCache','imLcJ','HSLZA','1098215MakqKa','CsNXh','ugVPl','MoIhY','XaEBb','addListener','&rkey=','图片rkey有效','sUuDw','getRKey','uploadFile','gKEVo','startsWith','图片rkey有误'];_0x9c54=function(){return _0x316faa;};return _0x9c54();}import _0x4c5385 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{hookApi}from'@/core/external/hook';import{randomUUID}from'crypto';import{AsyncQueue}from'@/common/utils/AsyncQueue';import{sleep}from'@/common/utils/helper';import _0x654b74 from'https';let privateImageRKey='',groupImageRKey='',lastGetPrivateRKeyTime=0x0,lastGetGroupRKeyTime=0x0;const rkeyExpireTime=0x3e8*0x3c*0x1e,getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x252bf0(0xd5)]=_0x53bacf=>{const _0x2e42be=_0x252bf0,_0x230d45={'FYKjn':function(_0x5ab18e,_0x15cfa4){return _0x5ab18e(_0x15cfa4);}};for(const [_0x4d6575,_0x31708f]of downloadMediaTasks){_0x230d45['FYKjn'](_0x31708f,_0x53bacf),downloadMediaTasks[_0x2e42be(0xde)](_0x4d6575);}},setTimeout(()=>{const _0x4bccc3=_0x252bf0;napCatCore[_0x4bccc3(0xbe)](()=>{const _0x3af44d=_0x4bccc3;napCatCore[_0x3af44d(0xb3)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x252bf0(0xc3)](_0x5a064a){const _0x3f0fcc=_0x252bf0;return _0x20034c[_0x3f0fcc(0xc1)](_0x5a064a);}static async['copyFile'](_0xdc509d,_0x5d3a08){const _0x303099=_0x252bf0;await napCatCore['util'][_0x303099(0x102)](_0xdc509d,_0x5d3a08);}static async['getFileSize'](_0x1cb40a){const _0xa7505e=_0x252bf0;return await napCatCore[_0xa7505e(0xd4)]['getFileSize'](_0x1cb40a);}static async[_0x252bf0(0xb8)](_0xe19a24,_0x326e21=ElementType['PIC'],_0x58f2a7=0x0){const _0x3529a5=_0x252bf0,_0x56d630={'MoIhY':function(_0x21d739,_0x1f7f29){return _0x21d739(_0x1f7f29);},'CsNXh':function(_0x159ad4,_0x4828f0){return _0x159ad4+_0x4828f0;},'xwtEL':function(_0x33d4a8,_0x3f59d5){return _0x33d4a8===_0x3f59d5;}},_0xcf6090=await _0x56d630[_0x3529a5(0xb1)](calculateFileMD5,_0xe19a24);let _0x744245=(await NTQQFileApi[_0x3529a5(0xc3)](_0xe19a24))?.[_0x3529a5(0x107)]||'';_0x744245&&(_0x744245=_0x56d630[_0x3529a5(0xaf)]('.',_0x744245));let _0x292687=''+_0x589c9e[_0x3529a5(0xa8)](_0xe19a24);_0x56d630[_0x3529a5(0xf5)](_0x292687[_0x3529a5(0xbd)]('.'),-0x1)&&(_0x292687+=_0x744245);const _0x1870bc=napCatCore[_0x3529a5(0x10b)]['getMsgService']()[_0x3529a5(0xe8)]({'md5HexStr':_0xcf6090,'fileName':_0x292687,'elementType':_0x326e21,'elementSubType':_0x58f2a7,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x3529a5(0x102)](_0xe19a24,_0x1870bc);const _0x4110ad=await NTQQFileApi[_0x3529a5(0xc5)](_0xe19a24);return{'md5':_0xcf6090,'fileName':_0x292687,'path':_0x1870bc,'fileSize':_0x4110ad,'ext':_0x744245};}static async[_0x252bf0(0xbc)](_0x59d962,_0x38f204,_0x3fe80a,_0xecfd6c,_0x1a4a14,_0x3cbc70,_0x34338e=0x3e8*0x3c*0x2,_0x5061c3=![]){const _0x49a533=_0x252bf0,_0x1b3ccc={'pGgOh':function(_0x52c877,_0x2b7da8){return _0x52c877(_0x2b7da8);},'yjGvV':'下载超时','vPNTn':function(_0x59672e,_0x4eba09,_0x164a1e,_0x210231){return _0x59672e(_0x4eba09,_0x164a1e,_0x210231);},'HxTWw':_0x49a533(0xcf),'EWXxO':function(_0x217dc5){return _0x217dc5();},'OdMZh':function(_0x373c99,_0x3d21d5,_0x2943c8){return _0x373c99(_0x3d21d5,_0x2943c8);},'imLcJ':_0x49a533(0xfb),'ZIeHS':'start\x20downloadMedia'};logDebug(_0x1b3ccc[_0x49a533(0xac)],_0x59d962,_0x38f204,_0x3fe80a,_0xecfd6c,_0x1a4a14,_0x3cbc70,_0x34338e,_0x5061c3);if(_0x3cbc70&&_0x2d8397[_0x49a533(0xd6)](_0x3cbc70)){if(_0x5061c3)try{await _0x3f2b02[_0x49a533(0xc8)](_0x3cbc70);}catch(_0x2c4bbc){}else return _0x3cbc70;}return logDebug(_0x1b3ccc['ZIeHS'],_0x59d962,_0x38f204,_0x3fe80a,_0xecfd6c,_0x1a4a14,_0x3cbc70,_0x34338e,_0x5061c3),new Promise((_0x1db8d5,_0x13d129)=>{const _0x11b793=_0x49a533,_0x2d1b31={'sUuDw':function(_0xe69979,_0x2adac3,_0x3b4c69,_0xd9fa6f){const _0x31d29c=_0x53ae;return _0x1b3ccc[_0x31d29c(0xea)](_0xe69979,_0x2adac3,_0x3b4c69,_0xd9fa6f);},'HOQjt':_0x11b793(0x101),'Bicss':_0x1b3ccc[_0x11b793(0xdb)]};let _0x491fed=![];const _0x2ac34f=_0x5d05b2=>{const _0x4f1999=_0x11b793;_0x2d1b31[_0x4f1999(0xb6)](logDebug,_0x2d1b31[_0x4f1999(0xdf)],_0x5d05b2,_0x59d962);if(_0x5d05b2[_0x4f1999(0xa9)]===_0x59d962){_0x491fed=!![];let _0x26a91b=_0x5d05b2[_0x4f1999(0x10c)];if(_0x26a91b[_0x4f1999(0xba)]('\x5c')){const _0x753650=sessionConfig[_0x4f1999(0xe9)];logDebug(_0x2d1b31[_0x4f1999(0xfa)],_0x753650),_0x26a91b=_0x589c9e[_0x4f1999(0xc9)](_0x753650,_0x26a91b);}_0x1db8d5(_0x26a91b);}};downloadMediaTasks[_0x11b793(0xaa)](_0x1b3ccc[_0x11b793(0xfd)](randomUUID),_0x2ac34f),_0x1b3ccc[_0x11b793(0x100)](setTimeout,()=>{const _0x519cbc=_0x11b793;!_0x491fed&&_0x1b3ccc[_0x519cbc(0xec)](_0x13d129,_0x1b3ccc['yjGvV']);},_0x34338e),napCatCore[_0x11b793(0x10b)][_0x11b793(0xa7)]()[_0x11b793(0xbf)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x59d962,'chatType':_0x38f204,'peerUid':_0x3fe80a,'elementId':_0xecfd6c,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x1a4a14});});}static async['getImageSize'](_0x5098e1){const _0x1093ac={'pAHpP':function(_0x316b7b,_0x3b3c43,_0x3a4ea6){return _0x316b7b(_0x3b3c43,_0x3a4ea6);}};return new Promise((_0x47c87d,_0x41ce7c)=>{_0x1093ac['pAHpP'](_0x4c5385,_0x5098e1,(_0x5dacc1,_0x332a80)=>{_0x5dacc1?_0x41ce7c(_0x5dacc1):_0x47c87d(_0x332a80);});});}static async[_0x252bf0(0xca)](_0xee98cd){const _0xe578a4=_0x252bf0,_0x380b22={'eNzTD':_0xe578a4(0xe2),'CsBYi':'error','FlThr':function(_0x37baac,_0x993e0c){return _0x37baac(_0x993e0c);},'XaEBb':function(_0x107e88,_0x50dcce){return _0x107e88*_0x50dcce;},'ugVPl':function(_0x5bba38,_0x2380e4){return _0x5bba38(_0x2380e4);},'xYsiy':'开始调用moeHook获取rkey','nnuPf':function(_0x272cf0,_0x1f5d63){return _0x272cf0+_0x1f5d63;},'ptubu':function(_0x104f03,_0x375675){return _0x104f03+_0x375675;},'DBmjg':function(_0xbc5731,_0x48a152,_0x503286){return _0xbc5731(_0x48a152,_0x503286);},'EbZDF':_0xe578a4(0xed),'lLFWW':function(_0x2e3e8d,_0xebd0c3,_0x1e4354){return _0x2e3e8d(_0xebd0c3,_0x1e4354);},'SPiEx':_0xe578a4(0xb5),'iumJF':function(_0x5e77b7,_0x259660){return _0x5e77b7(_0x259660);},'cBzls':function(_0x4b4eaf,_0x4a66ff,_0x126361,_0x4295e8){return _0x4b4eaf(_0x4a66ff,_0x126361,_0x4295e8);},'lpwKd':_0xe578a4(0xbb),'rIOjy':function(_0x11895e){return _0x11895e();},'mCgLM':function(_0x797b33,_0x464d30){return _0x797b33(_0x464d30);},'acTgO':function(_0x31d528,_0x42e1ec){return _0x31d528!==_0x42e1ec;},'wPiSE':_0xe578a4(0xc2),'VfwTm':_0xe578a4(0xa0),'BjxtY':function(_0x746229,_0x4ed4bd){return _0x746229-_0x4ed4bd;},'iLwoP':function(_0x4f0f45,_0x1501f0,_0x256588){return _0x4f0f45(_0x1501f0,_0x256588);},'ECvMm':function(_0x3b2b52,_0x7fe01d){return _0x3b2b52+_0x7fe01d;},'gKEVo':function(_0x18d1aa,_0x2c7712){return _0x18d1aa+_0x2c7712;},'NhvSD':function(_0x33d5ae,_0x4b4355){return _0x33d5ae||_0x4b4355;},'GtjDa':function(_0x53e075,_0x44d4db,_0x5838c6){return _0x53e075(_0x44d4db,_0x5838c6);},'lWQVH':_0xe578a4(0xe0)},_0x16c7b6=_0x380b22[_0xe578a4(0xd8)](_0xee98cd[_0xe578a4(0xf4)],ChatType[_0xe578a4(0x108)]),_0x558ce4=_0xee98cd['elements']['find'](_0x57d88d=>!!_0x57d88d[_0xe578a4(0xc4)]);if(!_0x558ce4)return'';const _0x234b27=_0x558ce4[_0xe578a4(0xc4)]['originImageUrl'],_0xe59313=_0x558ce4[_0xe578a4(0xc4)][_0xe578a4(0x106)],_0x1188d9=_0x558ce4[_0xe578a4(0xc4)][_0xe578a4(0x106)],_0x4746d2=_0x558ce4[_0xe578a4(0xc4)][_0xe578a4(0xfc)],_0x5f0ac4=_0x254c78=>{const _0x131807=_0xe578a4;_0x16c7b6?(privateImageRKey=_0x254c78,lastGetPrivateRKeyTime=Date[_0x131807(0xe7)]()):(groupImageRKey=_0x254c78,lastGetGroupRKeyTime=Date[_0x131807(0xe7)]());};if(_0x234b27){if(_0x234b27[_0xe578a4(0xba)](_0x380b22['wPiSE'])){if(_0x234b27['includes'](_0xe578a4(0xb4)))return IMAGE_HTTP_HOST_NT+_0x234b27;if(!hookApi[_0xe578a4(0xd2)]())return _0x380b22[_0xe578a4(0xd0)](logDebug,_0x380b22['VfwTm']),'';const _0x370f00=async()=>{const _0x3fa3fa=_0xe578a4,_0x1d21fd={'nAzXj':function(_0x568dc7,_0x30d8c8){return _0x568dc7!==_0x30d8c8;},'HSLZA':function(_0x5ec285,_0x3c67b0){return _0x5ec285(_0x3c67b0);},'iHMOK':_0x380b22[_0x3fa3fa(0xc7)],'mQGHO':_0x380b22['CsBYi']};_0x380b22[_0x3fa3fa(0xa2)](logDebug,'获取图片rkey...'),NTQQFileApi[_0x3fa3fa(0xbc)](_0xee98cd[_0x3fa3fa(0xa9)],_0xee98cd[_0x3fa3fa(0xf4)],_0xee98cd[_0x3fa3fa(0xf9)],_0x558ce4['elementId'],'',_0x558ce4['picElement'][_0x3fa3fa(0xda)],_0x380b22[_0x3fa3fa(0xb2)](0x3e8,0x1e),![])['then'](_0x5e1d1a=>{})[_0x3fa3fa(0xcd)](logError),await _0x380b22['FlThr'](sleep,0x3e8),_0x380b22[_0x3fa3fa(0xb0)](logDebug,_0x380b22[_0x3fa3fa(0xdd)]);const _0x16da4d=hookApi[_0x3fa3fa(0xb7)]()||'',_0x2d04eb=_0x380b22[_0x3fa3fa(0xf3)](_0x380b22['ptubu'](IMAGE_HTTP_HOST_NT,_0x234b27),_0x16da4d);if(_0x16da4d)try{_0x380b22[_0x3fa3fa(0xf2)](logDebug,_0x380b22[_0x3fa3fa(0xe3)],_0x2d04eb),await new Promise((_0x519d2e,_0x1b3987)=>{const _0x56cf22=_0x3fa3fa,_0x415cec={'LBBHi':function(_0x2f6eab,_0x3e03fe){const _0x124605=_0x53ae;return _0x1d21fd[_0x124605(0xe6)](_0x2f6eab,_0x3e03fe);},'TDNtb':function(_0x17e6d9,_0x5c239d){const _0x340304=_0x53ae;return _0x1d21fd[_0x340304(0xad)](_0x17e6d9,_0x5c239d);},'gVChc':_0x1d21fd['iHMOK'],'yPRgB':function(_0x5b5e69,_0x57abb8){const _0x276e54=_0x53ae;return _0x1d21fd[_0x276e54(0xad)](_0x5b5e69,_0x57abb8);}};_0x654b74[_0x56cf22(0xef)](_0x2d04eb,_0x8dc0ee=>{const _0x48afa3=_0x56cf22;_0x415cec[_0x48afa3(0xf6)](_0x8dc0ee['statusCode'],0xc8)?_0x415cec[_0x48afa3(0xc6)](_0x1b3987,_0x415cec[_0x48afa3(0xa1)]):_0x415cec[_0x48afa3(0xc6)](_0x519d2e,_0x8dc0ee);})['on'](_0x1d21fd[_0x56cf22(0x110)],_0x15f665=>{const _0x3a152d=_0x56cf22;_0x415cec[_0x3a152d(0x10a)](_0x1b3987,_0x15f665);});}),_0x380b22['lLFWW'](logDebug,_0x380b22[_0x3fa3fa(0xf7)],_0x2d04eb),_0x380b22[_0x3fa3fa(0x104)](_0x5f0ac4,_0x16da4d);}catch(_0x2f59c9){return _0x380b22['cBzls'](logError,_0x380b22[_0x3fa3fa(0xee)],_0x2d04eb,_0x2f59c9),'';}return _0x16da4d;},_0x1e8f56=new Promise((_0x385ac0,_0x1e754a)=>{const _0x3dc677=_0xe578a4;getRKeyTaskQueue[_0x3dc677(0xe4)](async()=>{const _0x33101c=_0x3dc677,_0x2f1215=await _0x380b22[_0x33101c(0xdc)](_0x370f00);_0x380b22['mCgLM'](_0x385ac0,_0x2f1215);});}),_0x5730a=_0x16c7b6?privateImageRKey:groupImageRKey,_0x3da116=_0x16c7b6?lastGetPrivateRKeyTime:lastGetGroupRKeyTime;if(_0x380b22[_0xe578a4(0x10e)](Date[_0xe578a4(0xe7)](),_0x3da116)>rkeyExpireTime||!_0x5730a){const _0x5a8fc3=await _0x1e8f56;if(_0x5a8fc3)return IMAGE_HTTP_HOST_NT+_0x234b27+(''+_0x5a8fc3);else _0x380b22[_0xe578a4(0xd1)](logError,_0x380b22[_0xe578a4(0xc7)],_0x234b27);}if(_0x5730a)return _0x380b22[_0xe578a4(0xc0)](IMAGE_HTTP_HOST_NT+_0x234b27,''+_0x5730a);return'';}else return _0x380b22[_0xe578a4(0xb9)](IMAGE_HTTP_HOST,_0x234b27);}else{if(_0x1188d9||_0xe59313)return IMAGE_HTTP_HOST+_0xe578a4(0xa4)+_0x380b22[_0xe578a4(0xf1)](_0x1188d9,_0xe59313)['toUpperCase']()+'/0';}return _0x380b22['GtjDa'](logDebug,_0x380b22[_0xe578a4(0x103)],_0xee98cd),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x167f7f=!![]){return'';}static[_0x252bf0(0xff)](){return'';}static[_0x252bf0(0xab)](_0x1f4fcb=[_0x252bf0(0xa5),_0x252bf0(0xce)]){const _0x433496=_0x252bf0;return napCatCore[_0x433496(0x10b)][_0x433496(0xe1)]()[_0x433496(0xfe)](_0x1f4fcb);}static[_0x252bf0(0xa3)](_0x3f0e81={}){const _0x212a87=_0x252bf0;return napCatCore[_0x212a87(0x10b)][_0x212a87(0xe1)]()[_0x212a87(0x105)](_0x3f0e81);}static['scanCache'](){const _0x518a91=_0x252bf0;return napCatCore['session'][_0x518a91(0xe1)]()['scanCache']();}static[_0x252bf0(0x10d)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x252bf0(0xd7)](_0x40dfa1,_0x535e95=0x3e8,_0x3c40d4=0x0){const _0x4529d2=_0x252bf0;return napCatCore['session'][_0x4529d2(0xe1)]()['getChatCacheInfo'](_0x40dfa1,_0x535e95,0x1,_0x3c40d4);}static[_0x252bf0(0xeb)](_0x53a3d3,_0x17a860=0x3e8,_0x50d9f3){const _0x2abcbd=_0x50d9f3?_0x50d9f3:{'fileType':_0x53a3d3};}static async[_0x252bf0(0x109)](_0x43f5e1=[],_0x5422f3=[]){const _0x4a298c=_0x252bf0;return napCatCore[_0x4a298c(0x10b)]['getStorageCleanService']()['clearChatCacheInfo'](_0x43f5e1,_0x5422f3);}}