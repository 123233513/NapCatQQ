const _0x509a74=_0x5300;(function(_0x4a65ba,_0x3d8e30){const _0x228a25=_0x5300,_0x30671e=_0x4a65ba();while(!![]){try{const _0x4fc452=parseInt(_0x228a25(0xed))/0x1*(parseInt(_0x228a25(0xb9))/0x2)+parseInt(_0x228a25(0xc4))/0x3*(parseInt(_0x228a25(0xb1))/0x4)+parseInt(_0x228a25(0xd3))/0x5+parseInt(_0x228a25(0xe0))/0x6+parseInt(_0x228a25(0xad))/0x7+parseInt(_0x228a25(0xdb))/0x8*(parseInt(_0x228a25(0xac))/0x9)+parseInt(_0x228a25(0xdd))/0xa*(-parseInt(_0x228a25(0xbc))/0xb);if(_0x4fc452===_0x3d8e30)break;else _0x30671e['push'](_0x30671e['shift']());}catch(_0x478be7){_0x30671e['push'](_0x30671e['shift']());}}}(_0x4c1b,0xbf8ee));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x537e12 from'path';import _0x4cd3ba from'fs';import _0x47a7a0 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x5df397 from'file-type';function _0x4c1b(){const _0xae6777=['wLOsf','zLUTA','tmp','util','getFileType','setCacheSilentScan','sVwda','fileUuid','2385110otcioQ','KXlIJ','wRfmx','indexOf','basename','msgId','getRichMediaService','elementId','2523256nmDJAJ','getFileCacheInfo','7758410WqmJof','下载超时','unlink','3756204TTwTLb','getRichMediaFilePathForGuild','set','ogmdn','/gchatpic_new/0/0-0-','clearChatCacheInfo','LqVAm','clearChatCache','domainUrl','addListener','getFileSize','downloadMedia','delete','1lWPvdT','originImageUrl','lzCkf','addCacheScanedPaths','uploadFile','/download','md5HexStr','startsWith','session','romPd','onLoginSuccess','fileTypeFromFile','9SWSadk','7210707eBjeAc','CqEEL','getStorageCleanService','chatType','1876408YUgVpw','hotUpdate','addCacheScannedPaths','includes','getChatCacheList','urlResult','图片url获取失败','copyFile','388958BslXja','ext','join','33aaaGOv','getMsgService','getImageSize','private_rkey','onRichMediaDownloadComplete','getVideoPlayUrlV2','SmLZO','hXjws','3ZFpprK','peerUid','PIC','clearCacheDataByKeys','nKlUJ','getImageUrl','scanCache'];_0x4c1b=function(){return _0xae6777;};return _0x4c1b();}import{MsgListener}from'@/core/listeners';import _0x17a615 from'image-size';import{sessionConfig}from'@/core/sessionConfig';function _0x5300(_0x3215a8,_0x547dc6){const _0x4c1b99=_0x4c1b();return _0x5300=function(_0x5300be,_0x35a5e2){_0x5300be=_0x5300be-0xab;let _0x409530=_0x4c1b99[_0x5300be];return _0x409530;},_0x5300(_0x3215a8,_0x547dc6);}import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x509a74(0xc0)]=_0x5f1bbc=>{const _0x480b20=_0x509a74,_0x580081={'wRfmx':function(_0x46fe38,_0x57e460){return _0x46fe38(_0x57e460);}};for(const [_0x3e5713,_0x2557c6]of downloadMediaTasks){_0x580081[_0x480b20(0xd5)](_0x2557c6,_0x5f1bbc),downloadMediaTasks[_0x480b20(0xec)](_0x3e5713);}},setTimeout(()=>{const _0x3cd8ad=_0x509a74;napCatCore[_0x3cd8ad(0xf7)](()=>{const _0x1a6ed9=_0x3cd8ad;napCatCore[_0x1a6ed9(0xe9)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x4cf5b8){const _0x1b03e7=_0x509a74;return _0x5df397[_0x1b03e7(0xab)](_0x4cf5b8);}static async[_0x509a74(0xb8)](_0x2b5440,_0x3763b4){const _0x23b8d1=_0x509a74;await napCatCore['util'][_0x23b8d1(0xb8)](_0x2b5440,_0x3763b4);}static async[_0x509a74(0xea)](_0x4539c6){const _0x46ce34=_0x509a74;return await napCatCore[_0x46ce34(0xce)][_0x46ce34(0xea)](_0x4539c6);}static async['getVideoUrl'](_0x38a5ab,_0x10dcec){const _0xf858dd=_0x509a74;return(await napCatCore['session'][_0xf858dd(0xd9)]()[_0xf858dd(0xc1)]({'chatType':_0x38a5ab[_0xf858dd(0xb0)],'peerUid':_0x38a5ab[_0xf858dd(0xc5)],'guildId':'0'},_0x38a5ab[_0xf858dd(0xd8)],_0x10dcec[_0xf858dd(0xda)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0xf858dd(0xb6)][_0xf858dd(0xe8)][0x0]['url'];}static async[_0x509a74(0xf1)](_0x4ca8a6,_0x4adfaf=ElementType[_0x509a74(0xc6)],_0x35051c=0x0){const _0x312efc=_0x509a74,_0x105c87={'romPd':function(_0x576bf5,_0xc92dc9){return _0x576bf5+_0xc92dc9;},'BjxYQ':function(_0x1c2bfe,_0x1a72d0){return _0x1c2bfe===_0x1a72d0;}},_0x1b37ce=await calculateFileMD5(_0x4ca8a6);let _0x478c33=(await NTQQFileApi[_0x312efc(0xcf)](_0x4ca8a6))?.[_0x312efc(0xba)]||'';_0x478c33&&(_0x478c33=_0x105c87[_0x312efc(0xf6)]('.',_0x478c33));let _0x102fdf=''+_0x537e12[_0x312efc(0xd7)](_0x4ca8a6);_0x105c87['BjxYQ'](_0x102fdf[_0x312efc(0xd6)]('.'),-0x1)&&(_0x102fdf+=_0x478c33);const _0x4fead1=napCatCore[_0x312efc(0xf5)][_0x312efc(0xbd)]()[_0x312efc(0xe1)]({'md5HexStr':_0x1b37ce,'fileName':_0x102fdf,'elementType':_0x4adfaf,'elementSubType':_0x35051c,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x312efc(0xb8)](_0x4ca8a6,_0x4fead1);const _0x23543f=await NTQQFileApi['getFileSize'](_0x4ca8a6);return{'md5':_0x1b37ce,'fileName':_0x102fdf,'path':_0x4fead1,'fileSize':_0x23543f,'ext':_0x478c33};}static async[_0x509a74(0xeb)](_0x57cdc1,_0x2c965b,_0x510a76,_0x4e2314,_0x38827d,_0x41f64a,_0x5dcb4b=0x3e8*0x3c*0x2,_0x418d3a=![]){const _0x3896fb=_0x509a74,_0x5007a6={'ZEhEf':function(_0x15f979,_0x45460f){return _0x15f979(_0x45460f);},'sVwda':_0x3896fb(0xde),'LqVAm':function(_0x1e5354,_0x33fd51,_0x1398a4){return _0x1e5354(_0x33fd51,_0x1398a4);}};if(_0x41f64a&&_0x4cd3ba['existsSync'](_0x41f64a)){if(_0x418d3a)try{await _0x47a7a0[_0x3896fb(0xdf)](_0x41f64a);}catch(_0x471387){}else return _0x41f64a;}return new Promise((_0x16bad1,_0x18c7ab)=>{const _0x227919=_0x3896fb,_0x196859={'zLUTA':function(_0x439572,_0xaf19aa){return _0x5007a6['ZEhEf'](_0x439572,_0xaf19aa);},'ogmdn':_0x5007a6[_0x227919(0xd1)]};let _0xbae5c4=![];const _0x7b3363=_0x108acc=>{const _0x4ed05c=_0x227919;if(_0x108acc[_0x4ed05c(0xd8)]===_0x57cdc1){_0xbae5c4=!![];let _0x2de962=_0x108acc['filePath'];if(_0x2de962[_0x4ed05c(0xf4)]('\x5c')){const _0x12a8eb=sessionConfig['defaultFileDownloadPath'];_0x2de962=_0x537e12[_0x4ed05c(0xbb)](_0x12a8eb,_0x2de962);}_0x16bad1(_0x2de962);}};downloadMediaTasks[_0x227919(0xe2)](randomUUID(),_0x7b3363),_0x5007a6[_0x227919(0xe6)](setTimeout,()=>{const _0x41bd9c=_0x227919;!_0xbae5c4&&_0x196859[_0x41bd9c(0xcc)](_0x18c7ab,_0x196859[_0x41bd9c(0xe3)]);},_0x5dcb4b),napCatCore[_0x227919(0xf5)][_0x227919(0xbd)]()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x57cdc1,'chatType':_0x2c965b,'peerUid':_0x510a76,'elementId':_0x4e2314,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x38827d});});}static async[_0x509a74(0xbe)](_0x46e90e){const _0x28c214={'KXlIJ':function(_0x34028b,_0x78ad0e){return _0x34028b(_0x78ad0e);},'lzCkf':function(_0x5136a2,_0xf883b,_0x15840){return _0x5136a2(_0xf883b,_0x15840);}};return new Promise((_0x491279,_0x2e25d7)=>{const _0x493f8b=_0x5300,_0x18d0d4={'LEgyv':function(_0x54e086,_0xdef318){const _0x3a1934=_0x5300;return _0x28c214[_0x3a1934(0xd4)](_0x54e086,_0xdef318);}};_0x28c214[_0x493f8b(0xef)](_0x17a615,_0x46e90e,(_0xd45663,_0x452ebd)=>{_0xd45663?_0x18d0d4['LEgyv'](_0x2e25d7,_0xd45663):_0x491279(_0x452ebd);});});}static async[_0x509a74(0xc9)](_0x349203,_0x37e00b){const _0x4237c1=_0x509a74,_0x466385={'DhrlG':_0x4237c1(0xf2),'wLOsf':'&rkey=','hXjws':function(_0x48f559,_0x515b89){return _0x48f559+_0x515b89;},'nKlUJ':function(_0x3a1c33,_0x131178){return _0x3a1c33+_0x131178;},'SmLZO':function(_0x334e20,_0x39d5cb){return _0x334e20+_0x39d5cb;},'kDOev':function(_0x396572,_0x33e2d5){return _0x396572||_0x33e2d5;},'NRvXw':function(_0x5b2015,_0x509d88,_0x37e631){return _0x5b2015(_0x509d88,_0x37e631);},'CqEEL':_0x4237c1(0xb7)};if(!_0x349203)return'';const _0x382733=_0x349203[_0x4237c1(0xee)],_0x153df5=_0x349203[_0x4237c1(0xf3)],_0x2520b3=_0x349203[_0x4237c1(0xf3)],_0x5b8d9d=_0x349203[_0x4237c1(0xd2)];if(_0x382733){if(_0x382733['startsWith'](_0x466385['DhrlG'])){if(_0x382733[_0x4237c1(0xb4)](_0x466385[_0x4237c1(0xcb)]))return _0x466385[_0x4237c1(0xc3)](IMAGE_HTTP_HOST_NT,_0x382733);const _0x1aae4c=await rkeyManager['getRkey'](),_0x51b94f=_0x37e00b?_0x1aae4c[_0x4237c1(0xbf)]:_0x1aae4c['group_rkey'];return _0x466385[_0x4237c1(0xc3)](_0x466385[_0x4237c1(0xc8)](IMAGE_HTTP_HOST_NT,_0x382733),''+_0x51b94f);}else return _0x466385[_0x4237c1(0xc2)](IMAGE_HTTP_HOST,_0x382733);}else{if(_0x466385['kDOev'](_0x2520b3,_0x153df5))return IMAGE_HTTP_HOST+_0x4237c1(0xe4)+_0x466385['kDOev'](_0x2520b3,_0x153df5)['toUpperCase']()+'/0';}return _0x466385['NRvXw'](logDebug,_0x466385[_0x4237c1(0xae)],_0x349203),'';}}export class NTQQFileCacheApi{static async[_0x509a74(0xd0)](_0x1dac41=!![]){return'';}static['getCacheSessionPathList'](){return'';}static['clearCache'](_0x2bf924=[_0x509a74(0xcd),_0x509a74(0xb2)]){const _0x2e489e=_0x509a74;return napCatCore[_0x2e489e(0xf5)][_0x2e489e(0xaf)]()[_0x2e489e(0xc7)](_0x2bf924);}static[_0x509a74(0xb3)](_0x49b8b0={}){const _0x4396f6=_0x509a74;return napCatCore[_0x4396f6(0xf5)][_0x4396f6(0xaf)]()[_0x4396f6(0xf0)](_0x49b8b0);}static[_0x509a74(0xca)](){const _0x5b58d0=_0x509a74;return napCatCore['session'][_0x5b58d0(0xaf)]()[_0x5b58d0(0xca)]();}static['getHotUpdateCachePath'](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x509a74(0xb5)](_0x4ff74c,_0xec9763=0x3e8,_0xe812be=0x0){const _0x52b739=_0x509a74;return napCatCore['session'][_0x52b739(0xaf)]()['getChatCacheInfo'](_0x4ff74c,_0xec9763,0x1,_0xe812be);}static[_0x509a74(0xdc)](_0x28d6ca,_0x1a834f=0x3e8,_0x198df6){const _0x13f481=_0x198df6?_0x198df6:{'fileType':_0x28d6ca};}static async[_0x509a74(0xe7)](_0x4e5c08=[],_0x58a95e=[]){const _0x151746=_0x509a74;return napCatCore[_0x151746(0xf5)]['getStorageCleanService']()[_0x151746(0xe5)](_0x4e5c08,_0x58a95e);}}