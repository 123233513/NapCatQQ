const _0x135922=_0x56e5;(function(_0x1d2fd3,_0x2ceda6){const _0x51f264=_0x56e5,_0x53dd99=_0x1d2fd3();while(!![]){try{const _0x304aab=-parseInt(_0x51f264(0x162))/0x1*(-parseInt(_0x51f264(0x134))/0x2)+parseInt(_0x51f264(0x131))/0x3*(-parseInt(_0x51f264(0x148))/0x4)+parseInt(_0x51f264(0x115))/0x5+parseInt(_0x51f264(0x10f))/0x6*(parseInt(_0x51f264(0x14c))/0x7)+parseInt(_0x51f264(0x119))/0x8+parseInt(_0x51f264(0x15c))/0x9*(parseInt(_0x51f264(0x12f))/0xa)+-parseInt(_0x51f264(0x160))/0xb*(parseInt(_0x51f264(0x132))/0xc);if(_0x304aab===_0x2ceda6)break;else _0x53dd99['push'](_0x53dd99['shift']());}catch(_0x145ae3){_0x53dd99['push'](_0x53dd99['shift']());}}}(_0x3d97,0x5070c));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x3fb0e1}from'node:fs';import _0x3e6fd9 from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';function _0x56e5(_0x2ccad7,_0x2684d7){const _0x3d9746=_0x3d97();return _0x56e5=function(_0x56e572,_0x291227){_0x56e572=_0x56e572-0x10f;let _0x3c6e51=_0x3d9746[_0x56e572];return _0x3c6e51;},_0x56e5(_0x2ccad7,_0x2684d7);}import{encodeSilk}from'@/common/utils/audio';import _0x28c71f from'./face_config.json';import*as _0x3406eb from'node:path';import{SignMiniApp}from'../apis';export const mFaceCache=new Map();export class SendMsgElementConstructor{static['text'](_0x5a30ae){const _0x5bf715=_0x56e5;return{'elementType':ElementType[_0x5bf715(0x116)],'elementId':'','textElement':{'content':_0x5a30ae,'atType':AtType[_0x5bf715(0x166)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x10a0d0,_0x22f01c,_0x4e85b1,_0x18ba08){return{'elementType':ElementType['TEXT'],'elementId':'','textElement':{'content':'@'+_0x18ba08,'atType':_0x4e85b1,'atUid':_0x10a0d0,'atTinyId':'','atNtUid':_0x22f01c}};}static[_0x135922(0x13d)](_0xa28229,_0x2134fc,_0x41e756,_0x1505f5){const _0x35b487=_0x135922;return{'elementType':ElementType[_0x35b487(0x14f)],'elementId':'','replyElement':{'replayMsgSeq':_0xa28229,'replayMsgId':_0x2134fc,'senderUin':_0x41e756,'senderUinStr':_0x1505f5}};}static async['pic'](_0x4f740e,_0x2e8cd1='',_0x44091c=0x0){const _0x328643=_0x135922,_0x47da78={'ycILf':function(_0x2dfffc,_0x2ff439){return _0x2dfffc(_0x2ff439);}},{md5:_0x7ca920,fileName:_0x34681c,path:_0x3d88bf,fileSize:_0x341f7a}=await NTQQFileApi[_0x328643(0x15e)](_0x4f740e,ElementType[_0x328643(0x12e)],_0x44091c);if(_0x341f7a===0x0)throw _0x328643(0x150);const _0xbe979d=await NTQQFileApi['getImageSize'](_0x4f740e),_0x34ec0a={'md5HexStr':_0x7ca920,'fileSize':_0x341f7a[_0x328643(0x158)](),'picWidth':_0xbe979d?.[_0x328643(0x155)],'picHeight':_0xbe979d?.[_0x328643(0x111)],'fileName':_0x34681c,'sourcePath':_0x3d88bf,'original':!![],'picType':_0x47da78[_0x328643(0x167)](isGIF,_0x4f740e)?PicType[_0x328643(0x14a)]:PicType['jpg'],'picSubType':_0x44091c,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x2e8cd1};return{'elementType':ElementType[_0x328643(0x12e)],'elementId':'','picElement':_0x34ec0a};}static async[_0x135922(0x14b)](_0x1b5f71,_0x3bc6df=''){const _0x3ef751=_0x135922,_0x5f0d6e={'kDpPr':function(_0x23ba66,_0x2cd9c7){return _0x23ba66===_0x2cd9c7;},'GBLze':'文件异常，大小为0','eINxA':function(_0x1515f9,_0x5b0b7b){return _0x1515f9||_0x5b0b7b;}},{md5:_0xee521f,fileName:_0x1aca8c,path:_0x39a200,fileSize:_0xaaaf09}=await NTQQFileApi['uploadFile'](_0x1b5f71,ElementType[_0x3ef751(0x165)]);if(_0x5f0d6e[_0x3ef751(0x12c)](_0xaaaf09,0x0))throw _0x5f0d6e[_0x3ef751(0x161)];const _0x384423={'elementType':ElementType[_0x3ef751(0x165)],'elementId':'','fileElement':{'fileName':_0x5f0d6e[_0x3ef751(0x123)](_0x3bc6df,_0x1aca8c),'filePath':_0x39a200,'fileSize':_0xaaaf09['toString']()}};return _0x384423;}static async[_0x135922(0x154)](_0x51a7b0,_0x5b561a='',_0x3cc083=''){const _0x2bad92=_0x135922,_0xd25a20={'npjfe':function(_0x5613c0,_0x82cf17,_0x19f444){return _0x5613c0(_0x82cf17,_0x19f444);},'iFGlA':_0x2bad92(0x152),'JUzXS':_0x2bad92(0x13f),'EfTzC':function(_0x47cb00,_0x3ec6cd){return _0x47cb00===_0x3ec6cd;},'ffYFz':'文件异常，大小为0','mqjRe':function(_0x317b83,_0x349b23){return _0x317b83(_0x349b23);},'Guktl':_0x2bad92(0x168),'bcMRO':function(_0x138cac,_0x1d8ba4){return _0x138cac||_0x1d8ba4;},'KUMVi':function(_0x2cf682,_0x457b4c){return _0x2cf682+_0x457b4c;}},{fileName:_0x529d28,path:_0x7323e2,fileSize:_0x3f1139,md5:_0x1a7817}=await NTQQFileApi['uploadFile'](_0x51a7b0,ElementType[_0x2bad92(0x11a)]);if(_0xd25a20[_0x2bad92(0x16b)](_0x3f1139,0x0))throw _0xd25a20[_0x2bad92(0x13e)];let _0x11a3b7=_0x7323e2[_0x2bad92(0x124)](_0x3406eb['sep']+_0x2bad92(0x113)+_0x3406eb['sep'],_0x3406eb[_0x2bad92(0x151)]+_0x2bad92(0x140)+_0x3406eb[_0x2bad92(0x151)]);_0x11a3b7=_0x3406eb[_0x2bad92(0x14e)](_0x11a3b7);let _0x52b690={'width':0x780,'height':0x438,'time':0xf,'format':_0x2bad92(0x11f),'size':_0x3f1139,'filePath':_0x51a7b0};try{_0x52b690=await _0xd25a20['mqjRe'](getVideoInfo,_0x7323e2);}catch(_0x14c8d6){_0xd25a20['npjfe'](logError,_0xd25a20[_0x2bad92(0x16c)],_0x14c8d6);}const _0x4a1526=new Promise((_0xc9075,_0x118af6)=>{const _0x47f9bb=_0x2bad92,_0x10cd75={'KzMZC':function(_0x57d447,_0x3eead8,_0x26ead2){const _0x253bfe=_0x56e5;return _0xd25a20[_0x253bfe(0x163)](_0x57d447,_0x3eead8,_0x26ead2);}},_0x23fe5f=_0x1a7817+_0x47f9bb(0x11b),_0x1ef672=_0x3406eb['join'](_0x11a3b7,_0x23fe5f);_0x3e6fd9(_0x51a7b0)['on'](_0x47f9bb(0x13f),()=>{})['on'](_0xd25a20[_0x47f9bb(0x11d)],_0x4c585a=>{const _0xad6b08=_0x47f9bb,_0xcd37dc={'VvmqT':function(_0xe8126a,_0x1d7272){return _0xe8126a(_0x1d7272);}};_0x10cd75[_0xad6b08(0x15f)](logDebug,_0xad6b08(0x133),_0x4c585a),_0x3cc083?_0x3fb0e1[_0xad6b08(0x147)](_0x3cc083,_0x1ef672)[_0xad6b08(0x145)](()=>{const _0x4fe196=_0xad6b08;_0xcd37dc[_0x4fe196(0x139)](_0xc9075,_0x1ef672);})[_0xad6b08(0x169)](_0x118af6):_0x3fb0e1['writeFile'](_0x1ef672,defaultVideoThumb)[_0xad6b08(0x145)](()=>{const _0x179453=_0xad6b08;_0xcd37dc[_0x179453(0x139)](_0xc9075,_0x1ef672);})['catch'](_0x118af6);})[_0x47f9bb(0x125)]({'timestamps':[0x0],'filename':_0x23fe5f,'folder':_0x11a3b7,'size':_0x52b690[_0x47f9bb(0x155)]+'x'+_0x52b690[_0x47f9bb(0x111)]})['on'](_0xd25a20[_0x47f9bb(0x12a)],()=>{_0xc9075(_0x1ef672);});}),_0x1576d9=new Map(),_0x17a57a=await _0x4a1526,_0x327a04=(await _0x3fb0e1['stat'](_0x17a57a))[_0x2bad92(0x127)];_0x1576d9['set'](0x0,_0x17a57a);const _0x1eec91=await calculateFileMD5(_0x17a57a),_0x175ca4={'elementType':ElementType[_0x2bad92(0x11a)],'elementId':'','videoElement':{'fileName':_0xd25a20[_0x2bad92(0x156)](_0x5b561a,_0x529d28),'filePath':_0x7323e2,'videoMd5':_0x1a7817,'thumbMd5':_0x1eec91,'fileTime':_0x52b690[_0x2bad92(0x11e)],'thumbPath':_0x1576d9,'thumbSize':_0x327a04,'thumbWidth':_0x52b690[_0x2bad92(0x155)],'thumbHeight':_0x52b690[_0x2bad92(0x111)],'fileSize':_0xd25a20['KUMVi']('',_0x3f1139)}};return _0x175ca4;}static async['ptt'](_0x356c7b){const _0xa12643=_0x135922,_0x73d51f={'HyYyB':function(_0x15167b,_0x2536ac){return _0x15167b(_0x2536ac);},'dhwSz':_0xa12643(0x150),'PdKVI':function(_0x396202,_0x191d01){return _0x396202||_0x191d01;}},{converted:_0x45721b,path:_0x468787,duration:_0x391993}=await _0x73d51f[_0xa12643(0x164)](encodeSilk,_0x356c7b);if(!_0x468787)throw _0xa12643(0x128);const {md5:_0x3dfbc6,fileName:_0x1d233b,path:_0x26ff3a,fileSize:_0x4eb922}=await NTQQFileApi['uploadFile'](_0x468787,ElementType[_0xa12643(0x16a)]);if(_0x4eb922===0x0)throw _0x73d51f['dhwSz'];return _0x45721b&&_0x3fb0e1['unlink'](_0x468787)[_0xa12643(0x145)](),{'elementType':ElementType['PTT'],'elementId':'','pttElement':{'fileName':_0x1d233b,'filePath':_0x26ff3a,'md5HexStr':_0x3dfbc6,'fileSize':_0x4eb922,'duration':_0x73d51f[_0xa12643(0x13a)](_0x391993,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static[_0x135922(0x135)](_0x3440c0){const _0x52fa98=_0x135922,_0x51e677={'WCpmZ':function(_0x2e59ab,_0x111636){return _0x2e59ab(_0x111636);},'belDX':function(_0x20084a,_0x18ff6e){return _0x20084a>=_0x18ff6e;}},_0x2d4a9c=_0x28c71f[_0x52fa98(0x13c)],_0x2b050c=_0x28c71f[_0x52fa98(0x121)],_0x1b7022=_0x2d4a9c[_0x52fa98(0x149)](_0x26e740=>_0x26e740[_0x52fa98(0x137)]===_0x3440c0[_0x52fa98(0x158)]());_0x3440c0=_0x51e677[_0x52fa98(0x146)](parseInt,_0x3440c0[_0x52fa98(0x158)]());let _0x4200bd=0x1;return _0x51e677[_0x52fa98(0x138)](_0x3440c0,0xde)&&(_0x4200bd=0x2),_0x1b7022[_0x52fa98(0x15b)]&&(_0x4200bd=0x3),{'elementType':ElementType[_0x52fa98(0x141)],'elementId':'','faceElement':{'faceIndex':_0x3440c0,'faceType':_0x4200bd,'faceText':_0x1b7022['QDes'],'stickerId':_0x1b7022[_0x52fa98(0x12b)],'stickerType':_0x1b7022[_0x52fa98(0x15b)],'packId':_0x1b7022[_0x52fa98(0x130)],'sourceType':0x1}};}static['mface'](_0x5da1f1,_0x21df29,_0x366efb,_0x50c874){const _0x298ed3=_0x135922,_0x110a76={'dBYmT':_0x298ed3(0x11c)};return{'elementType':ElementType[_0x298ed3(0x142)],'marketFaceElement':{'emojiPackageId':_0x5da1f1,'emojiId':_0x21df29,'key':_0x366efb,'faceName':_0x50c874||mFaceCache[_0x298ed3(0x118)](_0x21df29)||_0x110a76[_0x298ed3(0x14d)]}};}static['dice'](_0x4013eb){const _0x5503a6=_0x135922,_0x52dd35={'wpTQL':_0x5503a6(0x129)};return{'elementType':ElementType[_0x5503a6(0x141)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x5503a6(0x117)],'faceType':FaceType['dice'],'faceText':_0x52dd35[_0x5503a6(0x120)],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x135922(0x12d)](_0x51c162){const _0x1b6a5e=_0x135922,_0x48f062={'QdNBR':_0x1b6a5e(0x114)};return{'elementType':ElementType[_0x1b6a5e(0x141)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x1b6a5e(0x144)],'faceText':_0x48f062['QdNBR'],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x135922(0x112)](_0x338d39){const _0x23fe00=_0x135922,_0x3ece88={'zMOjR':function(_0x537dae,_0x48f31e){return _0x537dae!==_0x48f31e;},'muLkH':'string'};return _0x3ece88[_0x23fe00(0x16d)](typeof _0x338d39,_0x3ece88['muLkH'])&&(_0x338d39=JSON[_0x23fe00(0x153)](_0x338d39)),{'elementType':ElementType[_0x23fe00(0x13b)],'elementId':'','arkElement':{'bytesData':_0x338d39,'linkInfo':null,'subElementType':null}};}static[_0x135922(0x143)](_0x47512c){const _0xbac18f=_0x135922;return{'elementType':ElementType[_0xbac18f(0x136)],'elementId':'','markdownElement':{'content':_0x47512c}};}static async[_0x135922(0x157)](){const _0x5664bc=_0x135922,_0x4025f1={'fqqfs':function(_0x2f766a,_0x37fed2){return _0x2f766a(_0x37fed2);},'DTvhc':_0x5664bc(0x159),'dhcPD':_0x5664bc(0x126)};let _0x59f859=await _0x4025f1[_0x5664bc(0x15d)](SignMiniApp,{'prompt':_0x4025f1[_0x5664bc(0x15a)],'title':_0x5664bc(0x159),'preview':_0x5664bc(0x122),'jumpUrl':'https://www.bilibili.com/','tag':_0x5664bc(0x159),'tagIcon':_0x4025f1[_0x5664bc(0x110)],'source':_0x4025f1['DTvhc'],'sourcelogo':_0x4025f1[_0x5664bc(0x110)]});return{'elementType':ElementType[_0x5664bc(0x13b)],'elementId':'','arkElement':{'bytesData':_0x59f859,'linkInfo':null,'subElementType':null}};}}function _0x3d97(){const _0x1efd79=['KzMZC','151591NtpeXW','GBLze','1kbxDSy','npjfe','HyYyB','FILE','notAt','ycILf','获取视频信息失败','catch','PTT','EfTzC','Guktl','zMOjR','542046KJQNQy','dhcPD','height','ark','Ori','[包剪锤]','349765qkqjdM','TEXT','dice','get','4060080zUEPYF','VIDEO','_0.png','[商城表情]','iFGlA','time','mp4','wpTQL','emoji','https://tianquan.gtimg.cn/qqAIAgent/item/7/square.png','eINxA','replace','screenshots','https://tianquan.gtimg.cn/shoal/qqAIAgent/3e9d70c9-d98c-45b8-80b4-79d82971b514.png','size','语音转换失败,\x20请检查语音文件是否正常','[骰子]','JUzXS','AniStickerId','kDpPr','rps','PIC','935730APFBZS','AniStickerPackId','3kgJrgf','1164XdwIuU','获取视频封面失败，使用默认封面','929834CGYeeC','face','MARKDOWN','QSid','belDX','VvmqT','PdKVI','ARK','sysface','reply','ffYFz','end','Thumb','FACE','MFACE','markdown','RPS','then','WCpmZ','copyFile','485964OPsmTZ','find','gif','file','7PetNHy','dBYmT','dirname','REPLY','文件异常，大小为0','sep','error','stringify','video','width','bcMRO','miniapp','toString','Bot\x20Test','DTvhc','AniStickerType','63SVXDkg','fqqfs','uploadFile'];_0x3d97=function(){return _0x1efd79;};return _0x3d97();}