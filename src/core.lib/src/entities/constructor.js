const _0x20b379=_0x4ddf;(function(_0xe3f994,_0x59db97){const _0x468a24=_0x4ddf,_0x36d311=_0xe3f994();while(!![]){try{const _0x66f6ad=parseInt(_0x468a24(0xc8))/0x1*(-parseInt(_0x468a24(0xe2))/0x2)+-parseInt(_0x468a24(0xf0))/0x3+parseInt(_0x468a24(0xb9))/0x4*(-parseInt(_0x468a24(0xf3))/0x5)+parseInt(_0x468a24(0xab))/0x6+parseInt(_0x468a24(0xe3))/0x7+parseInt(_0x468a24(0xd5))/0x8*(-parseInt(_0x468a24(0xa4))/0x9)+parseInt(_0x468a24(0xb5))/0xa;if(_0x66f6ad===_0x59db97)break;else _0x36d311['push'](_0x36d311['shift']());}catch(_0x4f6cef){_0x36d311['push'](_0x36d311['shift']());}}}(_0x18c9,0x9fc4f));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x387731}from'node:fs';import _0x321207 from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';function _0x4ddf(_0x33053f,_0x2cd024){const _0x18c939=_0x18c9();return _0x4ddf=function(_0x4ddf32,_0x12e66e){_0x4ddf32=_0x4ddf32-0xa4;let _0x3f55c6=_0x18c939[_0x4ddf32];return _0x3f55c6;},_0x4ddf(_0x33053f,_0x2cd024);}import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';export const mFaceCache=new Map();export class SendMsgElementConstructor{static[_0x20b379(0xce)](_0xc41697){const _0x401d98=_0x20b379;return{'elementType':ElementType[_0x401d98(0xcb)],'elementId':'','textElement':{'content':_0xc41697,'atType':AtType['notAt'],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x41c9f7,_0xc3de07,_0x493e61,_0x7a7a6e){return{'elementType':ElementType['TEXT'],'elementId':'','textElement':{'content':'@'+_0x7a7a6e,'atType':_0x493e61,'atUid':_0x41c9f7,'atTinyId':'','atNtUid':_0xc3de07}};}static[_0x20b379(0xaf)](_0x161253,_0x58fda6,_0x258bbc,_0x4134f8){return{'elementType':ElementType['REPLY'],'elementId':'','replyElement':{'replayMsgSeq':_0x161253,'replayMsgId':_0x58fda6,'senderUin':_0x258bbc,'senderUinStr':_0x4134f8}};}static async[_0x20b379(0xd0)](_0xd7e2f9,_0x1b1cc1='',_0x1f1787=0x0){const _0x328bf2=_0x20b379,_0x5d699f={'VHzKK':function(_0x585dcf,_0x2cc94f){return _0x585dcf===_0x2cc94f;},'xEhcG':'文件异常，大小为0','VAJNK':function(_0x26c277,_0x5bc2cd){return _0x26c277(_0x5bc2cd);},'fWjeH':function(_0x310359,_0x4deca1,_0x28e1ad){return _0x310359(_0x4deca1,_0x28e1ad);}},{md5:_0x1f98a5,fileName:_0x27385a,path:_0x380550,fileSize:_0x2dcfbf}=await NTQQFileApi['uploadFile'](_0xd7e2f9,ElementType[_0x328bf2(0xe6)],_0x1f1787);if(_0x5d699f[_0x328bf2(0xa6)](_0x2dcfbf,0x0))throw _0x5d699f[_0x328bf2(0xee)];const _0x3e6c8a=await NTQQFileApi[_0x328bf2(0xad)](_0xd7e2f9),_0x280b8a={'md5HexStr':_0x1f98a5,'fileSize':_0x2dcfbf[_0x328bf2(0xf8)](),'picWidth':_0x3e6c8a?.[_0x328bf2(0xa5)],'picHeight':_0x3e6c8a?.[_0x328bf2(0xbb)],'fileName':_0x27385a,'sourcePath':_0x380550,'original':!![],'picType':_0x5d699f[_0x328bf2(0xe8)](isGIF,_0xd7e2f9)?PicType[_0x328bf2(0xaa)]:PicType[_0x328bf2(0xe9)],'picSubType':_0x1f1787,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x1b1cc1};return _0x5d699f['fWjeH'](logDebug,_0x328bf2(0xe7),_0x280b8a),{'elementType':ElementType[_0x328bf2(0xe6)],'elementId':'','picElement':_0x280b8a};}static async['file'](_0x4c9dd1,_0x38ce8a=''){const _0x53422b=_0x20b379,_0x4c6544={'QBXJg':function(_0x35ba6e,_0x4a3fbe){return _0x35ba6e===_0x4a3fbe;},'JIxTb':function(_0x20c98a,_0xeef553){return _0x20c98a||_0xeef553;}},{md5:_0x33b47b,fileName:_0x1dabde,path:_0x416bb3,fileSize:_0x4ac47e}=await NTQQFileApi['uploadFile'](_0x4c9dd1,ElementType[_0x53422b(0xec)]);if(_0x4c6544['QBXJg'](_0x4ac47e,0x0))throw _0x53422b(0xc3);const _0x3872c9={'elementType':ElementType['FILE'],'elementId':'','fileElement':{'fileName':_0x4c6544[_0x53422b(0xd8)](_0x38ce8a,_0x1dabde),'filePath':_0x416bb3,'fileSize':_0x4ac47e['toString']()}};return _0x3872c9;}static async[_0x20b379(0xcc)](_0xa0d8d5,_0x26ebf7='',_0x4ad2c8=''){const _0x570e81=_0x20b379,_0x56c564={'UjqWF':function(_0x31427f,_0x8803cc,_0x56c913){return _0x31427f(_0x8803cc,_0x56c913);},'OIpXO':_0x570e81(0xe1),'LBfSO':function(_0x146c08,_0x309e11){return _0x146c08(_0x309e11);},'xsAnm':function(_0x84d171,_0x11ce7d){return _0x84d171(_0x11ce7d);},'iyriZ':_0x570e81(0xda),'AQzfD':function(_0x1548e0,_0x519924){return _0x1548e0+_0x519924;},'dXruq':function(_0x53b656,_0x28d739){return _0x53b656===_0x28d739;},'ACSxD':_0x570e81(0xc3),'fUNru':'mp4','CUvse':function(_0x35e354,_0x4b07be){return _0x35e354(_0x4b07be);},'UvBfS':'视频信息','WczMA':_0x570e81(0xb2),'zGBnE':function(_0x596323,_0x5331cb){return _0x596323||_0x5331cb;}},{fileName:_0x4affa0,path:_0x52f59e,fileSize:_0x37173d,md5:_0x414f74}=await NTQQFileApi[_0x570e81(0xd2)](_0xa0d8d5,ElementType[_0x570e81(0xb6)]);if(_0x56c564[_0x570e81(0xf1)](_0x37173d,0x0))throw _0x56c564[_0x570e81(0xbf)];const _0x9ac270=_0x56c564[_0x570e81(0xc6)](require,_0x570e81(0xed));let _0x516b08=_0x52f59e[_0x570e81(0xd1)](_0x9ac270[_0x570e81(0xbc)]+_0x570e81(0xc4)+_0x9ac270[_0x570e81(0xbc)],_0x9ac270[_0x570e81(0xbc)]+'Thumb'+_0x9ac270[_0x570e81(0xbc)]);_0x516b08=_0x9ac270[_0x570e81(0xea)](_0x516b08);let _0x1b8940={'width':0x780,'height':0x438,'time':0xf,'format':_0x56c564['fUNru'],'size':_0x37173d,'filePath':_0xa0d8d5};try{_0x1b8940=await _0x56c564[_0x570e81(0xd9)](getVideoInfo,_0x52f59e),_0x56c564[_0x570e81(0xd6)](logDebug,_0x56c564[_0x570e81(0xc1)],_0x1b8940);}catch(_0x102308){logError(_0x56c564[_0x570e81(0xe4)],_0x102308);}const _0x2d252a=new Promise((_0x1ed5db,_0x155d25)=>{const _0x55ad09=_0x570e81,_0x34980f={'ojgAA':function(_0x120195,_0x2b2231){return _0x120195(_0x2b2231);},'oWzdQ':function(_0x4762ff,_0x3767c1){return _0x56c564['LBfSO'](_0x4762ff,_0x3767c1);}},_0xdffb26=_0x414f74+_0x55ad09(0xd3),_0x4bf744=_0x9ac270[_0x55ad09(0xdc)](_0x516b08,_0xdffb26);_0x56c564[_0x55ad09(0xd4)](_0x321207,_0xa0d8d5)['on'](_0x56c564[_0x55ad09(0xc2)],()=>{})['on'](_0x55ad09(0xf6),_0x50a851=>{const _0x580f9a=_0x55ad09;_0x56c564['UjqWF'](logDebug,_0x56c564[_0x580f9a(0xc0)],_0x50a851),_0x4ad2c8?_0x387731[_0x580f9a(0xf4)](_0x4ad2c8,_0x4bf744)[_0x580f9a(0xf2)](()=>{const _0x116b70=_0x580f9a;_0x34980f[_0x116b70(0xdb)](_0x1ed5db,_0x4bf744);})[_0x580f9a(0xde)](_0x155d25):_0x387731[_0x580f9a(0xac)](_0x4bf744,defaultVideoThumb)[_0x580f9a(0xf2)](()=>{const _0x196171=_0x580f9a;_0x34980f[_0x196171(0xdb)](_0x1ed5db,_0x4bf744);})[_0x580f9a(0xde)](_0x155d25);})[_0x55ad09(0xdf)]({'timestamps':[0x0],'filename':_0xdffb26,'folder':_0x516b08,'size':_0x56c564['AQzfD'](_0x56c564[_0x55ad09(0xc5)](_0x1b8940['width'],'x'),_0x1b8940[_0x55ad09(0xbb)])})['on'](_0x56c564[_0x55ad09(0xc2)],()=>{const _0x3cfd43=_0x55ad09;_0x34980f[_0x3cfd43(0xf9)](_0x1ed5db,_0x4bf744);});}),_0x200b19=new Map(),_0x40c125=await _0x2d252a,_0x2ed855=(await _0x387731[_0x570e81(0xca)](_0x40c125))[_0x570e81(0xb7)];_0x200b19[_0x570e81(0xbd)](0x0,_0x40c125);const _0x318d70=await calculateFileMD5(_0x40c125),_0x88baa5={'elementType':ElementType[_0x570e81(0xb6)],'elementId':'','videoElement':{'fileName':_0x56c564[_0x570e81(0xeb)](_0x26ebf7,_0x4affa0),'filePath':_0x52f59e,'videoMd5':_0x414f74,'thumbMd5':_0x318d70,'fileTime':_0x1b8940[_0x570e81(0xe5)],'thumbPath':_0x200b19,'thumbSize':_0x2ed855,'thumbWidth':_0x1b8940['width'],'thumbHeight':_0x1b8940[_0x570e81(0xbb)],'fileSize':''+_0x37173d}};return _0x88baa5;}static async['ptt'](_0x341dfb){const _0x4c82ea=_0x20b379,_0x1d9722={'YDzqi':function(_0x2ea628,_0x284425){return _0x2ea628===_0x284425;},'uAbPP':function(_0x2c26c0,_0x3a3c63){return _0x2c26c0||_0x3a3c63;}},{converted:_0x268db6,path:_0x4aa5a3,duration:_0x4764cd}=await encodeSilk(_0x341dfb);if(!_0x4aa5a3)throw _0x4c82ea(0xdd);const {md5:_0x2e3adf,fileName:_0x8a4fe7,path:_0x23e6e1,fileSize:_0x2fd079}=await NTQQFileApi[_0x4c82ea(0xd2)](_0x4aa5a3,ElementType[_0x4c82ea(0xcd)]);if(_0x1d9722[_0x4c82ea(0xf7)](_0x2fd079,0x0))throw _0x4c82ea(0xc3);return _0x268db6&&_0x387731[_0x4c82ea(0xa9)](_0x4aa5a3)[_0x4c82ea(0xf2)](),{'elementType':ElementType['PTT'],'elementId':'','pttElement':{'fileName':_0x8a4fe7,'filePath':_0x23e6e1,'md5HexStr':_0x2e3adf,'fileSize':_0x2fd079,'duration':_0x1d9722[_0x4c82ea(0xae)](_0x4764cd,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static['face'](_0x241966){const _0x3f4b4d=_0x20b379,_0x337bc1={'iGSnr':function(_0x1b673e,_0x1e8a1b){return _0x1b673e<_0x1e8a1b;}};return{'elementType':ElementType[_0x3f4b4d(0xb3)],'elementId':'','faceElement':{'faceIndex':_0x241966,'faceType':_0x337bc1['iGSnr'](_0x241966,0xde)?FaceType[_0x3f4b4d(0xc9)]:FaceType[_0x3f4b4d(0xc7)]}};}static['mface'](_0x1a54f2,_0x5766ad,_0x25491b,_0x7c5f41){const _0x42fcac=_0x20b379;return{'elementType':ElementType[_0x42fcac(0xd7)],'marketFaceElement':{'emojiPackageId':_0x1a54f2,'emojiId':_0x5766ad,'key':_0x25491b,'faceName':_0x7c5f41||mFaceCache[_0x42fcac(0xcf)](_0x5766ad)||_0x42fcac(0xa7)}};}static['dice'](_0x282ff3){const _0x5da0da=_0x20b379,_0x4c8c68={'UzYyX':'[骰子]'};return{'elementType':ElementType[_0x5da0da(0xb3)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x5da0da(0xb1)],'faceType':FaceType[_0x5da0da(0xb1)],'faceText':_0x4c8c68[_0x5da0da(0xb8)],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x20b379(0xb0)](_0x596bd7){const _0x4673e0=_0x20b379,_0x2b6cb5={'uMOXy':_0x4673e0(0xe0)};return{'elementType':ElementType[_0x4673e0(0xb3)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x4673e0(0xbe)],'faceText':_0x2b6cb5[_0x4673e0(0xb4)],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static['ark'](_0x1ad69c){const _0x732e3a=_0x20b379,_0x52c8b8={'MGade':function(_0x37b328,_0xc479a8){return _0x37b328!==_0xc479a8;},'mrNGg':'string'};return _0x52c8b8[_0x732e3a(0xf5)](typeof _0x1ad69c,_0x52c8b8['mrNGg'])&&(_0x1ad69c=JSON[_0x732e3a(0xef)](_0x1ad69c)),{'elementType':ElementType[_0x732e3a(0xba)],'elementId':'','arkElement':{'bytesData':_0x1ad69c,'linkInfo':null,'subElementType':null}};}static[_0x20b379(0xa8)](_0x54ac47){return{'elementType':ElementType['MARKDOWN'],'elementId':'','markdownElement':{'content':_0x54ac47}};}}function _0x18c9(){const _0x5ced2a=['stringify','1658520uZGHgf','dXruq','then','490EyFzEC','copyFile','MGade','error','YDzqi','toString','oWzdQ','9276219iCUXOt','width','VHzKK','[商城表情]','markdown','unlink','gif','5388984exhdaf','writeFile','getImageSize','uAbPP','reply','rps','dice','获取视频信息失败','FACE','uMOXy','24402610fkJpFn','VIDEO','size','UzYyX','15892mflGwO','ARK','height','sep','set','RPS','ACSxD','OIpXO','UvBfS','iyriZ','文件异常，大小为0','Ori','AQzfD','LBfSO','normal2','91606iSZOkM','normal','stat','TEXT','video','PTT','text','get','pic','replace','uploadFile','_0.png','xsAnm','8DEhgaL','UjqWF','MFACE','JIxTb','CUvse','end','ojgAA','join','语音转换失败,\x20请检查语音文件是否正常','catch','screenshots','[包剪锤]','获取视频封面失败，使用默认封面','22UpZqyH','2075787YjZzdw','WczMA','time','PIC','图片信息','VAJNK','jpg','dirname','zGBnE','FILE','path','xEhcG'];_0x18c9=function(){return _0x5ced2a;};return _0x18c9();}