const _0x23dd7c=_0x3d82;(function(_0x3408d4,_0xe70e71){const _0x49e3e1=_0x3d82,_0x39c040=_0x3408d4();while(!![]){try{const _0x4943b3=parseInt(_0x49e3e1(0x117))/0x1+-parseInt(_0x49e3e1(0x127))/0x2+-parseInt(_0x49e3e1(0x121))/0x3*(-parseInt(_0x49e3e1(0x119))/0x4)+-parseInt(_0x49e3e1(0x12c))/0x5*(-parseInt(_0x49e3e1(0xff))/0x6)+parseInt(_0x49e3e1(0xf1))/0x7+-parseInt(_0x49e3e1(0x11f))/0x8+parseInt(_0x49e3e1(0xf2))/0x9*(-parseInt(_0x49e3e1(0x114))/0xa);if(_0x4943b3===_0xe70e71)break;else _0x39c040['push'](_0x39c040['shift']());}catch(_0x319fd6){_0x39c040['push'](_0x39c040['shift']());}}}(_0x2d82,0x3cdd0));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x33387d}from'node:fs';import _0x410d9c from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';function _0x2d82(){const _0x12d29f=['markdown','stringify','reply','height','qMWug','10182UIYYgF','zMMAN','notAt','ark','DkUaE','图片信息','rps','[包剪锤]','dice','获取视频信息失败','ptt','upstM','hRwhi','JFiQk','qcWrP','OLhXM','stat','size','emoji','KytIi','writeFile','1607890OtcJnk','screenshots','aaGaY','488687NJqwsO','kMdyp','68IwqAex','uploadFile','AniStickerPackId','QDes','find','unlink','1516480mBCele','Ori','23739vNFktR','mface','Thumb','wRSdf','Tvbsu','catch','715752CNwXqw','oGpxM','toString','wjTWn','ARK','1150rJhLbH','XXNqZ','eBFKT','error','sep','cBaGu','mp4','TeAdg','gENeA','REPLY','sysface','join','HGFCR','text','VIDEO','文件异常，大小为0','gif','fjUEp','WtBBQ','MFACE','BlcZq','_0.png','file','jpg','FMqGx','PIC','width','then','视频信息','jQzaV','end','FILE','FtgPn','dirname','video','1859067Idqosu','27qXkXvW','bSIzw','NRHHp','FACE','[商城表情]','RzMWx','time','AniStickerType'];_0x2d82=function(){return _0x12d29f;};return _0x2d82();}import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';import _0x145295 from'./face_config.json';export const mFaceCache=new Map();function _0x3d82(_0x57d410,_0x1e9a38){const _0x2d826c=_0x2d82();return _0x3d82=function(_0x3d823d,_0xcbefa1){_0x3d823d=_0x3d823d-0xf1;let _0x1738cd=_0x2d826c[_0x3d823d];return _0x1738cd;},_0x3d82(_0x57d410,_0x1e9a38);}export class SendMsgElementConstructor{static[_0x23dd7c(0x139)](_0x5d8d17){const _0xc430ec=_0x23dd7c;return{'elementType':ElementType['TEXT'],'elementId':'','textElement':{'content':_0x5d8d17,'atType':AtType[_0xc430ec(0x101)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x33c9f2,_0xbbc198,_0x3e1531,_0x8de6a2){return{'elementType':ElementType['TEXT'],'elementId':'','textElement':{'content':'@'+_0x8de6a2,'atType':_0x3e1531,'atUid':_0x33c9f2,'atTinyId':'','atNtUid':_0xbbc198}};}static[_0x23dd7c(0xfc)](_0x2f72ca,_0x25689f,_0x44b862,_0x518093){const _0x178b76=_0x23dd7c;return{'elementType':ElementType[_0x178b76(0x135)],'elementId':'','replyElement':{'replayMsgSeq':_0x2f72ca,'replayMsgId':_0x25689f,'senderUin':_0x44b862,'senderUinStr':_0x518093}};}static async['pic'](_0x46314a,_0x44c257='',_0x209bf4=0x0){const _0x57fee0=_0x23dd7c,_0x23dda7={'JFiQk':function(_0x145f96,_0x9780a1){return _0x145f96===_0x9780a1;},'yyIrw':'文件异常，大小为0','RzMWx':function(_0x55cf92,_0x1bed68){return _0x55cf92(_0x1bed68);},'NRHHp':_0x57fee0(0x104)},{md5:_0x4f99c2,fileName:_0x3ee7df,path:_0x17d57a,fileSize:_0x18741d}=await NTQQFileApi[_0x57fee0(0x11a)](_0x46314a,ElementType['PIC'],_0x209bf4);if(_0x23dda7[_0x57fee0(0x10c)](_0x18741d,0x0))throw _0x23dda7['yyIrw'];const _0x523db9=await NTQQFileApi['getImageSize'](_0x46314a),_0x35478b={'md5HexStr':_0x4f99c2,'fileSize':_0x18741d[_0x57fee0(0x129)](),'picWidth':_0x523db9?.['width'],'picHeight':_0x523db9?.[_0x57fee0(0xfd)],'fileName':_0x3ee7df,'sourcePath':_0x17d57a,'original':!![],'picType':_0x23dda7[_0x57fee0(0xf7)](isGIF,_0x46314a)?PicType[_0x57fee0(0x13c)]:PicType[_0x57fee0(0x143)],'picSubType':_0x209bf4,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x44c257};return logDebug(_0x23dda7[_0x57fee0(0xf4)],_0x35478b),{'elementType':ElementType[_0x57fee0(0x145)],'elementId':'','picElement':_0x35478b};}static async[_0x23dd7c(0x142)](_0xbee264,_0x335c4b=''){const _0x2cd623=_0x23dd7c,_0x24874c={'KytIi':function(_0x4dca19,_0x3977d1){return _0x4dca19===_0x3977d1;},'oGpxM':_0x2cd623(0x13b),'WhIOA':function(_0x576bcc,_0xd1287d){return _0x576bcc||_0xd1287d;}},{md5:_0x1b2f31,fileName:_0x57bc2b,path:_0x4986b8,fileSize:_0x1c92d9}=await NTQQFileApi[_0x2cd623(0x11a)](_0xbee264,ElementType[_0x2cd623(0x14b)]);if(_0x24874c[_0x2cd623(0x112)](_0x1c92d9,0x0))throw _0x24874c[_0x2cd623(0x128)];const _0x3cb925={'elementType':ElementType[_0x2cd623(0x14b)],'elementId':'','fileElement':{'fileName':_0x24874c['WhIOA'](_0x335c4b,_0x57bc2b),'filePath':_0x4986b8,'fileSize':_0x1c92d9[_0x2cd623(0x129)]()}};return _0x3cb925;}static async[_0x23dd7c(0x14e)](_0x7a650c,_0x47059f='',_0x5cec6a=''){const _0x54698c=_0x23dd7c,_0x47acd0={'fjUEp':function(_0x110597,_0x195249){return _0x110597(_0x195249);},'XXNqZ':function(_0x286c2f,_0x274415,_0x1ebcc8){return _0x286c2f(_0x274415,_0x1ebcc8);},'wRSdf':'获取视频封面失败，使用默认封面','HGFCR':function(_0x28d7b1,_0x514124){return _0x28d7b1(_0x514124);},'FMqGx':_0x54698c(0x14a),'kMdyp':_0x54698c(0x12f),'zMMAN':function(_0x1ec7bb,_0x45f274){return _0x1ec7bb+_0x45f274;},'BlcZq':function(_0x4cdeb6,_0x514abd){return _0x4cdeb6+_0x514abd;},'DkUaE':_0x54698c(0x13b),'wjTWn':function(_0x2f5bc4,_0x1e7f97){return _0x2f5bc4(_0x1e7f97);},'WtBBQ':'path','jQzaV':_0x54698c(0x132),'cBaGu':_0x54698c(0x148),'qcWrP':function(_0x22b856,_0x2068bf,_0x12aead){return _0x22b856(_0x2068bf,_0x12aead);},'aaGaY':_0x54698c(0x108),'bSIzw':function(_0x56231c,_0xc9f845){return _0x56231c||_0xc9f845;}},{fileName:_0x5701b3,path:_0x7369ec,fileSize:_0x36780e,md5:_0x5470e1}=await NTQQFileApi['uploadFile'](_0x7a650c,ElementType[_0x54698c(0x13a)]);if(_0x36780e===0x0)throw _0x47acd0[_0x54698c(0x103)];const _0x2dc93f=_0x47acd0[_0x54698c(0x12a)](require,_0x47acd0[_0x54698c(0x13e)]);let _0x2d7bd7=_0x7369ec['replace'](_0x2dc93f['sep']+_0x54698c(0x120)+_0x2dc93f[_0x54698c(0x130)],_0x2dc93f[_0x54698c(0x130)]+_0x54698c(0x123)+_0x2dc93f[_0x54698c(0x130)]);_0x2d7bd7=_0x2dc93f[_0x54698c(0x14d)](_0x2d7bd7);let _0x43778a={'width':0x780,'height':0x438,'time':0xf,'format':_0x47acd0[_0x54698c(0x149)],'size':_0x36780e,'filePath':_0x7a650c};try{_0x43778a=await _0x47acd0[_0x54698c(0x13d)](getVideoInfo,_0x7369ec),logDebug(_0x47acd0[_0x54698c(0x131)],_0x43778a);}catch(_0x4896e3){_0x47acd0[_0x54698c(0x10d)](logError,_0x47acd0[_0x54698c(0x116)],_0x4896e3);}const _0x1cf7c7=new Promise((_0x5463c6,_0x57389d)=>{const _0x39e0e4=_0x54698c,_0xa13849={'nKaLU':function(_0xb0e14b,_0x577da6){const _0x486402=_0x3d82;return _0x47acd0[_0x486402(0x13d)](_0xb0e14b,_0x577da6);},'OLhXM':function(_0x5c3800,_0x1648d0,_0x592634){const _0x31efed=_0x3d82;return _0x47acd0[_0x31efed(0x12d)](_0x5c3800,_0x1648d0,_0x592634);},'qMWug':_0x47acd0[_0x39e0e4(0x124)]},_0x12af08=_0x5470e1+_0x39e0e4(0x141),_0x2b5be6=_0x2dc93f[_0x39e0e4(0x137)](_0x2d7bd7,_0x12af08);_0x47acd0[_0x39e0e4(0x138)](_0x410d9c,_0x7a650c)['on'](_0x47acd0[_0x39e0e4(0x144)],()=>{})['on'](_0x47acd0[_0x39e0e4(0x118)],_0xa3f59d=>{const _0x5b8e30=_0x39e0e4;_0xa13849[_0x5b8e30(0x10e)](logDebug,_0xa13849[_0x5b8e30(0xfe)],_0xa3f59d),_0x5cec6a?_0x33387d['copyFile'](_0x5cec6a,_0x2b5be6)['then'](()=>{_0xa13849['nKaLU'](_0x5463c6,_0x2b5be6);})[_0x5b8e30(0x126)](_0x57389d):_0x33387d[_0x5b8e30(0x113)](_0x2b5be6,defaultVideoThumb)[_0x5b8e30(0x147)](()=>{_0x5463c6(_0x2b5be6);})['catch'](_0x57389d);})[_0x39e0e4(0x115)]({'timestamps':[0x0],'filename':_0x12af08,'folder':_0x2d7bd7,'size':_0x47acd0[_0x39e0e4(0x100)](_0x47acd0[_0x39e0e4(0x140)](_0x43778a[_0x39e0e4(0x146)],'x'),_0x43778a[_0x39e0e4(0xfd)])})['on'](_0x39e0e4(0x14a),()=>{_0x5463c6(_0x2b5be6);});}),_0x4c00cb=new Map(),_0x48c534=await _0x1cf7c7,_0x4b60cb=(await _0x33387d[_0x54698c(0x10f)](_0x48c534))[_0x54698c(0x110)];_0x4c00cb['set'](0x0,_0x48c534);const _0x1e5841=await calculateFileMD5(_0x48c534),_0x292656={'elementType':ElementType['VIDEO'],'elementId':'','videoElement':{'fileName':_0x47acd0[_0x54698c(0xf3)](_0x47059f,_0x5701b3),'filePath':_0x7369ec,'videoMd5':_0x5470e1,'thumbMd5':_0x1e5841,'fileTime':_0x43778a[_0x54698c(0xf8)],'thumbPath':_0x4c00cb,'thumbSize':_0x4b60cb,'thumbWidth':_0x43778a[_0x54698c(0x146)],'thumbHeight':_0x43778a[_0x54698c(0xfd)],'fileSize':_0x47acd0[_0x54698c(0x100)]('',_0x36780e)}};return _0x292656;}static async[_0x23dd7c(0x109)](_0x71a14b){const _0x954ad2=_0x23dd7c,_0x58194b={'Tvbsu':function(_0x1c681a,_0x287cb0){return _0x1c681a(_0x287cb0);},'RTueo':'语音转换失败,\x20请检查语音文件是否正常','TeAdg':function(_0xd2403c,_0x40b23b){return _0xd2403c===_0x40b23b;},'gENeA':'文件异常，大小为0','FtgPn':function(_0x47603c,_0x25de7d){return _0x47603c||_0x25de7d;}},{converted:_0x48cb03,path:_0x2f05c7,duration:_0x1ae5f4}=await _0x58194b[_0x954ad2(0x125)](encodeSilk,_0x71a14b);if(!_0x2f05c7)throw _0x58194b['RTueo'];const {md5:_0xcd1574,fileName:_0x2fb2c4,path:_0x1e55a1,fileSize:_0x30eaec}=await NTQQFileApi['uploadFile'](_0x2f05c7,ElementType['PTT']);if(_0x58194b[_0x954ad2(0x133)](_0x30eaec,0x0))throw _0x58194b[_0x954ad2(0x134)];return _0x48cb03&&_0x33387d[_0x954ad2(0x11e)](_0x2f05c7)['then'](),{'elementType':ElementType['PTT'],'elementId':'','pttElement':{'fileName':_0x2fb2c4,'filePath':_0x1e55a1,'md5HexStr':_0xcd1574,'fileSize':_0x30eaec,'duration':_0x58194b[_0x954ad2(0x14c)](_0x1ae5f4,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static['face'](_0x120a34){const _0x56ab37=_0x23dd7c,_0x43543c=_0x145295[_0x56ab37(0x136)],_0x16b22f=_0x145295[_0x56ab37(0x111)],_0x561a6c=_0x43543c[_0x56ab37(0x11d)](_0x101184=>_0x101184['QSid']===_0x120a34[_0x56ab37(0x129)]());_0x120a34=parseInt(_0x120a34[_0x56ab37(0x129)]());let _0xd76008=0x1;return _0x120a34>=0xde&&(_0xd76008=0x2),_0x561a6c[_0x56ab37(0xf9)]&&(_0xd76008=0x3),{'elementType':ElementType[_0x56ab37(0xf5)],'elementId':'','faceElement':{'faceIndex':_0x120a34,'faceType':_0xd76008,'faceText':_0x561a6c[_0x56ab37(0x11c)],'stickerId':_0x561a6c['AniStickerId'],'stickerType':_0x561a6c[_0x56ab37(0xf9)],'packId':_0x561a6c[_0x56ab37(0x11b)],'sourceType':0x1}};}static[_0x23dd7c(0x122)](_0x49995c,_0x238db4,_0xf60044,_0x4fd4da){const _0x1e355f=_0x23dd7c;return{'elementType':ElementType[_0x1e355f(0x13f)],'marketFaceElement':{'emojiPackageId':_0x49995c,'emojiId':_0x238db4,'key':_0xf60044,'faceName':_0x4fd4da||mFaceCache['get'](_0x238db4)||_0x1e355f(0xf6)}};}static['dice'](_0x886cee){const _0x5db556=_0x23dd7c,_0x33477d={'upstM':'[骰子]'};return{'elementType':ElementType[_0x5db556(0xf5)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x5db556(0x107)],'faceType':FaceType['dice'],'faceText':_0x33477d[_0x5db556(0x10a)],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x23dd7c(0x105)](_0x4e4d24){const _0x48980a=_0x23dd7c;return{'elementType':ElementType[_0x48980a(0xf5)],'elementId':'','faceElement':{'faceIndex':FaceIndex['RPS'],'faceText':_0x48980a(0x106),'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x23dd7c(0x102)](_0x27536e){const _0x340661=_0x23dd7c,_0x57b9cb={'eBFKT':function(_0x310c90,_0x521b52){return _0x310c90!==_0x521b52;},'hRwhi':'string'};return _0x57b9cb[_0x340661(0x12e)](typeof _0x27536e,_0x57b9cb[_0x340661(0x10b)])&&(_0x27536e=JSON[_0x340661(0xfb)](_0x27536e)),{'elementType':ElementType[_0x340661(0x12b)],'elementId':'','arkElement':{'bytesData':_0x27536e,'linkInfo':null,'subElementType':null}};}static[_0x23dd7c(0xfa)](_0x37dd4e){return{'elementType':ElementType['MARKDOWN'],'elementId':'','markdownElement':{'content':_0x37dd4e}};}}