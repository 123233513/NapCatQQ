const _0x1d7c70=_0x3202;(function(_0x3cb1c5,_0x2126d3){const _0x280d80=_0x3202,_0x42c888=_0x3cb1c5();while(!![]){try{const _0xe0466e=-parseInt(_0x280d80(0xc8))/0x1*(parseInt(_0x280d80(0xfe))/0x2)+-parseInt(_0x280d80(0xea))/0x3*(parseInt(_0x280d80(0xf0))/0x4)+parseInt(_0x280d80(0xf1))/0x5*(-parseInt(_0x280d80(0xd4))/0x6)+-parseInt(_0x280d80(0xb5))/0x7*(-parseInt(_0x280d80(0xfa))/0x8)+-parseInt(_0x280d80(0xcf))/0x9*(parseInt(_0x280d80(0x100))/0xa)+parseInt(_0x280d80(0xf2))/0xb+parseInt(_0x280d80(0xec))/0xc;if(_0xe0466e===_0x2126d3)break;else _0x42c888['push'](_0x42c888['shift']());}catch(_0x23e53a){_0x42c888['push'](_0x42c888['shift']());}}}(_0x43bb,0x967b8));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x262b3a}from'node:fs';function _0x43bb(){const _0x3570f7=['ark','getImageSize','1420hRfvIX','10kReBGy','4753870NehVWV','end','GpviC','文件异常，大小为0','[骰子]','FACE','face','DDXXj','112kauzri','ARK','markdown','catch','14290ZBsuGi','Thumb','530890POqONJ','join','XfrpY','QDes','text','mp4','uploadFile','then','[商城表情]','获取视频信息失败','XTtFc','toString','pic','TOSDn','qRbZi','reply','writeFile','PTT','[包剪锤]','size','AniStickerType','12061TjroDZ','video','TruWm','dice','gif','cuVtK','eATEH','AniStickerId','vbucY','ApXDW','PIC','get','QSid','kmTuf','语音转换失败,\x20请检查语音文件是否正常','RPS','string','mAMUb','CDsJG','23VWGkeQ','AniStickerPackId','FPlrE','jpg','notAt','mface','https://tianquan.gtimg.cn/shoal/qqAIAgent/3e9d70c9-d98c-45b8-80b4-79d82971b514.png','198LfFqAo','TEXT','oWnKU','SOagL','VXmBH','2829678pFBUyH','file','dirname','FILE','unlink','MARKDOWN','clrUG','width','jIbKd','zNpSg','EWsXU','sep','time','获取视频封面失败，使用默认封面','error','OzoyL','stat','OymQy','AttEL','height','VIDEO','find','6159qAhHaj','Bot\x20Test','37973016NybhiC','miniapp'];_0x43bb=function(){return _0x3570f7;};return _0x43bb();}import _0x16beec from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';import _0x3ec309 from'./face_config.json';import*as _0x3b2010 from'node:path';import{SignMiniApp}from'../apis';export const mFaceCache=new Map();function _0x3202(_0x589f43,_0x5e21a6){const _0x43bb28=_0x43bb();return _0x3202=function(_0x320213,_0x411c02){_0x320213=_0x320213-0xb2;let _0x328eb8=_0x43bb28[_0x320213];return _0x328eb8;},_0x3202(_0x589f43,_0x5e21a6);}export class SendMsgElementConstructor{static[_0x1d7c70(0x104)](_0x387027){const _0x18ccb1=_0x1d7c70;return{'elementType':ElementType[_0x18ccb1(0xd0)],'elementId':'','textElement':{'content':_0x387027,'atType':AtType[_0x18ccb1(0xcc)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x3e6e03,_0x294f44,_0xe20cc6,_0xdb0a17){return{'elementType':ElementType['TEXT'],'elementId':'','textElement':{'content':'@'+_0xdb0a17,'atType':_0xe20cc6,'atUid':_0x3e6e03,'atTinyId':'','atNtUid':_0x294f44}};}static[_0x1d7c70(0x10f)](_0x5aad89,_0x484440,_0x50b7a9,_0x353f0f){return{'elementType':ElementType['REPLY'],'elementId':'','replyElement':{'replayMsgSeq':_0x5aad89,'replayMsgId':_0x484440,'senderUin':_0x50b7a9,'senderUinStr':_0x353f0f}};}static async[_0x1d7c70(0x10c)](_0x2b407c,_0x4eb947='',_0x4b01de=0x0){const _0x591d69=_0x1d7c70,_0x44539e={'OymQy':function(_0x4cdf50,_0x38a0e7){return _0x4cdf50===_0x38a0e7;},'eATEH':function(_0x647547,_0x5af16a){return _0x647547(_0x5af16a);}},{md5:_0x161081,fileName:_0x368143,path:_0x34cb6b,fileSize:_0x38ad14}=await NTQQFileApi[_0x591d69(0x106)](_0x2b407c,ElementType[_0x591d69(0xbf)],_0x4b01de);if(_0x44539e[_0x591d69(0xe5)](_0x38ad14,0x0))throw _0x591d69(0xf5);const _0x39e3c0=await NTQQFileApi[_0x591d69(0xef)](_0x2b407c),_0x17bdba={'md5HexStr':_0x161081,'fileSize':_0x38ad14['toString'](),'picWidth':_0x39e3c0?.[_0x591d69(0xdb)],'picHeight':_0x39e3c0?.[_0x591d69(0xe7)],'fileName':_0x368143,'sourcePath':_0x34cb6b,'original':!![],'picType':_0x44539e[_0x591d69(0xbb)](isGIF,_0x2b407c)?PicType[_0x591d69(0xb9)]:PicType[_0x591d69(0xcb)],'picSubType':_0x4b01de,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x4eb947};return{'elementType':ElementType['PIC'],'elementId':'','picElement':_0x17bdba};}static async[_0x1d7c70(0xd5)](_0xebf24d,_0x2e0c48='',_0x91755a=''){const _0x44d49e=_0x1d7c70,_0x271abf={'fEsLh':function(_0x5c5940,_0x23d643){return _0x5c5940===_0x23d643;}},{md5:_0x106be8,fileName:_0x5b5a32,path:_0x55d8cd,fileSize:_0x4efc58}=await NTQQFileApi[_0x44d49e(0x106)](_0xebf24d,ElementType['FILE']);if(_0x271abf['fEsLh'](_0x4efc58,0x0))throw _0x44d49e(0xf5);const _0x63a404={'elementType':ElementType[_0x44d49e(0xd7)],'elementId':'','fileElement':{'fileName':_0x2e0c48||_0x5b5a32,'folderId':_0x91755a,'filePath':_0x55d8cd,'fileSize':_0x4efc58[_0x44d49e(0x10b)]()}};return _0x63a404;}static async[_0x1d7c70(0xb6)](_0x2db750,_0x21a3a0='',_0x128f82=''){const _0x4e73cf=_0x1d7c70,_0x266aef={'FPlrE':function(_0x4f8f8b,_0x440aff,_0x3ba3f1){return _0x4f8f8b(_0x440aff,_0x3ba3f1);},'EWsXU':_0x4e73cf(0xe1),'kmTuf':_0x4e73cf(0xf3),'qRbZi':_0x4e73cf(0xe2),'oWnKU':function(_0x4ebfb3,_0x4a3e9a){return _0x4ebfb3+_0x4a3e9a;},'CDsJG':function(_0x512b2e,_0x2075d9){return _0x512b2e===_0x2075d9;},'TOSDn':'文件异常，大小为0','XTtFc':_0x4e73cf(0x105),'cuVtK':function(_0x3027e1,_0x268a30){return _0x3027e1(_0x268a30);},'ZEZuQ':function(_0x5ce621,_0x59dd56,_0x30bec9){return _0x5ce621(_0x59dd56,_0x30bec9);},'mAMUb':_0x4e73cf(0x109),'trcFr':function(_0x234fb0,_0x4c88ba){return _0x234fb0+_0x4c88ba;}},{fileName:_0x1ef90a,path:_0x11bb8f,fileSize:_0x43820d,md5:_0x3c33fd}=await NTQQFileApi[_0x4e73cf(0x106)](_0x2db750,ElementType[_0x4e73cf(0xe8)]);if(_0x266aef[_0x4e73cf(0xc7)](_0x43820d,0x0))throw _0x266aef[_0x4e73cf(0x10d)];let _0x49cb17=_0x11bb8f['replace'](_0x3b2010['sep']+'Ori'+_0x3b2010['sep'],_0x3b2010[_0x4e73cf(0xdf)]+_0x4e73cf(0xff)+_0x3b2010[_0x4e73cf(0xdf)]);_0x49cb17=_0x3b2010[_0x4e73cf(0xd6)](_0x49cb17);let _0x1d009f={'width':0x780,'height':0x438,'time':0xf,'format':_0x266aef[_0x4e73cf(0x10a)],'size':_0x43820d,'filePath':_0x2db750};try{_0x1d009f=await _0x266aef[_0x4e73cf(0xba)](getVideoInfo,_0x11bb8f);}catch(_0x40f4a4){_0x266aef['ZEZuQ'](logError,_0x266aef[_0x4e73cf(0xc6)],_0x40f4a4);}const _0x498fce=new Promise((_0x5ef93e,_0x183601)=>{const _0x29143c=_0x4e73cf,_0x45ecd2={'TruWm':function(_0xa422ba,_0x404988,_0x199a25){const _0x40e023=_0x3202;return _0x266aef[_0x40e023(0xca)](_0xa422ba,_0x404988,_0x199a25);},'clrUG':_0x266aef[_0x29143c(0xde)]},_0x472888=_0x3c33fd+'_0.png',_0x2639b7=_0x3b2010[_0x29143c(0x101)](_0x49cb17,_0x472888);_0x16beec(_0x2db750)['on'](_0x266aef[_0x29143c(0xc2)],()=>{})['on'](_0x266aef[_0x29143c(0x10e)],_0x245da0=>{const _0x3e390b=_0x29143c,_0x4c528d={'XfrpY':function(_0x592e7d,_0xd1a093){return _0x592e7d(_0xd1a093);}};_0x45ecd2[_0x3e390b(0xb7)](logDebug,_0x45ecd2[_0x3e390b(0xda)],_0x245da0),_0x128f82?_0x262b3a['copyFile'](_0x128f82,_0x2639b7)[_0x3e390b(0x107)](()=>{_0x4c528d['XfrpY'](_0x5ef93e,_0x2639b7);})[_0x3e390b(0xfd)](_0x183601):_0x262b3a[_0x3e390b(0x110)](_0x2639b7,defaultVideoThumb)[_0x3e390b(0x107)](()=>{const _0x5ed456=_0x3e390b;_0x4c528d[_0x5ed456(0x102)](_0x5ef93e,_0x2639b7);})[_0x3e390b(0xfd)](_0x183601);})['screenshots']({'timestamps':[0x0],'filename':_0x472888,'folder':_0x49cb17,'size':_0x266aef['oWnKU'](_0x266aef[_0x29143c(0xd1)](_0x1d009f[_0x29143c(0xdb)],'x'),_0x1d009f['height'])})['on'](_0x266aef['kmTuf'],()=>{_0x5ef93e(_0x2639b7);});}),_0x5db1ec=new Map(),_0x247193=await _0x498fce,_0x2a7602=(await _0x262b3a[_0x4e73cf(0xe4)](_0x247193))[_0x4e73cf(0xb3)];_0x5db1ec['set'](0x0,_0x247193);const _0x93fd2d=await _0x266aef[_0x4e73cf(0xba)](calculateFileMD5,_0x247193),_0x1ba31f={'elementType':ElementType['VIDEO'],'elementId':'','videoElement':{'fileName':_0x21a3a0||_0x1ef90a,'filePath':_0x11bb8f,'videoMd5':_0x3c33fd,'thumbMd5':_0x93fd2d,'fileTime':_0x1d009f[_0x4e73cf(0xe0)],'thumbPath':_0x5db1ec,'thumbSize':_0x2a7602,'thumbWidth':_0x1d009f[_0x4e73cf(0xdb)],'thumbHeight':_0x1d009f[_0x4e73cf(0xe7)],'fileSize':_0x266aef['trcFr']('',_0x43820d)}};return _0x1ba31f;}static async['ptt'](_0x2e79de){const _0x59cc45=_0x1d7c70,_0x3db334={'SOagL':function(_0x57bfdd,_0x7924e0){return _0x57bfdd(_0x7924e0);},'ApXDW':_0x59cc45(0xc3),'zJlJQ':function(_0x1f8a35,_0x2ac1d3){return _0x1f8a35===_0x2ac1d3;},'OzoyL':_0x59cc45(0xf5),'jIbKd':function(_0x2c0705,_0x4460ce){return _0x2c0705||_0x4460ce;}},{converted:_0x39be65,path:_0x32fc60,duration:_0x4a3671}=await _0x3db334[_0x59cc45(0xd2)](encodeSilk,_0x2e79de);if(!_0x32fc60)throw _0x3db334[_0x59cc45(0xbe)];const {md5:_0x12b44e,fileName:_0x204e95,path:_0x9e6e8e,fileSize:_0x25aedb}=await NTQQFileApi[_0x59cc45(0x106)](_0x32fc60,ElementType[_0x59cc45(0x111)]);if(_0x3db334['zJlJQ'](_0x25aedb,0x0))throw _0x3db334[_0x59cc45(0xe3)];return _0x39be65&&_0x262b3a[_0x59cc45(0xd8)](_0x32fc60)[_0x59cc45(0x107)](),{'elementType':ElementType[_0x59cc45(0x111)],'elementId':'','pttElement':{'fileName':_0x204e95,'filePath':_0x9e6e8e,'md5HexStr':_0x12b44e,'fileSize':_0x25aedb,'duration':_0x3db334[_0x59cc45(0xdc)](_0x4a3671,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static[_0x1d7c70(0xf8)](_0x5b3aa8){const _0x1f1b55=_0x1d7c70,_0x521f2e={'VXmBH':function(_0x26adbf,_0x341af7){return _0x26adbf(_0x341af7);},'AttEL':function(_0xb806a6,_0x1ebc3f){return _0xb806a6>=_0x1ebc3f;}},_0x148486=_0x3ec309['sysface'],_0x33847d=_0x3ec309['emoji'],_0x3c95f3=_0x148486[_0x1f1b55(0xe9)](_0x46605c=>_0x46605c[_0x1f1b55(0xc1)]===_0x5b3aa8[_0x1f1b55(0x10b)]());_0x5b3aa8=_0x521f2e[_0x1f1b55(0xd3)](parseInt,_0x5b3aa8[_0x1f1b55(0x10b)]());let _0x38ea4a=0x1;return _0x521f2e[_0x1f1b55(0xe6)](_0x5b3aa8,0xde)&&(_0x38ea4a=0x2),_0x3c95f3['AniStickerType']&&(_0x38ea4a=0x3),{'elementType':ElementType[_0x1f1b55(0xf7)],'elementId':'','faceElement':{'faceIndex':_0x5b3aa8,'faceType':_0x38ea4a,'faceText':_0x3c95f3[_0x1f1b55(0x103)],'stickerId':_0x3c95f3[_0x1f1b55(0xbc)],'stickerType':_0x3c95f3[_0x1f1b55(0xb4)],'packId':_0x3c95f3[_0x1f1b55(0xc9)],'sourceType':0x1}};}static[_0x1d7c70(0xcd)](_0x34d08e,_0x56dbcb,_0x2c5707,_0x105274){const _0x5581e4=_0x1d7c70,_0x2b20c0={'zNpSg':_0x5581e4(0x108)};return{'elementType':ElementType['MFACE'],'marketFaceElement':{'emojiPackageId':_0x34d08e,'emojiId':_0x56dbcb,'key':_0x2c5707,'faceName':_0x105274||mFaceCache[_0x5581e4(0xc0)](_0x56dbcb)||_0x2b20c0[_0x5581e4(0xdd)]}};}static['dice'](_0x21211c){const _0x458fe2=_0x1d7c70;return{'elementType':ElementType[_0x458fe2(0xf7)],'elementId':'','faceElement':{'faceIndex':FaceIndex['dice'],'faceType':FaceType[_0x458fe2(0xb8)],'faceText':_0x458fe2(0xf6),'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static['rps'](_0x28200b){const _0x453cc8=_0x1d7c70,_0x565572={'aSaab':_0x453cc8(0xb2)};return{'elementType':ElementType['FACE'],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x453cc8(0xc4)],'faceText':_0x565572['aSaab'],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x1d7c70(0xee)](_0x494919){const _0x60939=_0x1d7c70;return typeof _0x494919!==_0x60939(0xc5)&&(_0x494919=JSON['stringify'](_0x494919)),{'elementType':ElementType[_0x60939(0xfb)],'elementId':'','arkElement':{'bytesData':_0x494919,'linkInfo':null,'subElementType':null}};}static[_0x1d7c70(0xfc)](_0x3bb38e){const _0x88a218=_0x1d7c70;return{'elementType':ElementType[_0x88a218(0xd9)],'elementId':'','markdownElement':{'content':_0x3bb38e}};}static async[_0x1d7c70(0xed)](){const _0x5bd07a=_0x1d7c70,_0x356951={'vbucY':function(_0x2b87a6,_0x42b57b){return _0x2b87a6(_0x42b57b);},'GpviC':'Bot\x20Test','DDXXj':'https://tianquan.gtimg.cn/qqAIAgent/item/7/square.png'};let _0x2ecaa2=await _0x356951[_0x5bd07a(0xbd)](SignMiniApp,{'prompt':_0x5bd07a(0xeb),'title':_0x356951[_0x5bd07a(0xf4)],'preview':_0x356951[_0x5bd07a(0xf9)],'jumpUrl':'https://www.bilibili.com/','tag':_0x356951[_0x5bd07a(0xf4)],'tagIcon':_0x5bd07a(0xce),'source':_0x356951[_0x5bd07a(0xf4)],'sourcelogo':_0x5bd07a(0xce)});return{'elementType':ElementType[_0x5bd07a(0xfb)],'elementId':'','arkElement':{'bytesData':_0x2ecaa2,'linkInfo':null,'subElementType':null}};}}