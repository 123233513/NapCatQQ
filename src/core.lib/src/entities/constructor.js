const _0x93ace4=_0x2b86;(function(_0x45e22a,_0x5307c3){const _0x11ac8c=_0x2b86,_0x1f1cd1=_0x45e22a();while(!![]){try{const _0x1e5cac=-parseInt(_0x11ac8c(0x123))/0x1+-parseInt(_0x11ac8c(0x12a))/0x2*(-parseInt(_0x11ac8c(0x151))/0x3)+-parseInt(_0x11ac8c(0x115))/0x4+parseInt(_0x11ac8c(0x14b))/0x5+parseInt(_0x11ac8c(0x15a))/0x6*(-parseInt(_0x11ac8c(0x112))/0x7)+-parseInt(_0x11ac8c(0x14d))/0x8*(-parseInt(_0x11ac8c(0x120))/0x9)+parseInt(_0x11ac8c(0x157))/0xa*(-parseInt(_0x11ac8c(0x13e))/0xb);if(_0x1e5cac===_0x5307c3)break;else _0x1f1cd1['push'](_0x1f1cd1['shift']());}catch(_0xcbb42c){_0x1f1cd1['push'](_0x1f1cd1['shift']());}}}(_0x4711,0x6169b));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x218cee}from'node:fs';import _0x54c5bb from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';function _0x4711(){const _0x3e1146=['视频信息','unlink','RPS','_0.png','jpg','Thumb','pEbRR','图片信息','获取视频信息失败','[骰子]','notAt','1489033WBwHAd','file','hWLKd','2761896reXCTW','[包剪锤]','mp4','MFACE','screenshots','TEXT','dirname','文件异常，大小为0','SgZpy','OozAu','ffUAs','9TvjOBn','normal2','width','368207VEdgYK','sep','语音转换失败,\x20请检查语音文件是否正常','toString','[商城表情]','path','RsQyf','20FCXJDa','text','REPLY','LnwqG','iOIWc','uploadFile','dice','FDVmF','video','string','PTT','then','copyFile','TlLud','idZfM','writeFile','hohLS','error','reply','获取视频封面失败，使用默认封面','102377LYNlHV','catch','GHvGx','rps','XHDMc','ark','stringify','njvzc','fphmf','SEnBg','FACE','uRhWr','JSirV','2781320HioVGh','RKfqW','4093184jaDuRE','set','sxfFK','height','200292ezPEiX','rEaRl','mface','time','HptIQ','PdxbX','70gauboc','gif','get','6RGlrbt'];_0x4711=function(){return _0x3e1146;};return _0x4711();}import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';function _0x2b86(_0x22fea1,_0x52971d){const _0x471115=_0x4711();return _0x2b86=function(_0x2b862a,_0x1528fa){_0x2b862a=_0x2b862a-0x111;let _0x174662=_0x471115[_0x2b862a];return _0x174662;},_0x2b86(_0x22fea1,_0x52971d);}export const mFaceCache=new Map();export class SendMsgElementConstructor{static[_0x93ace4(0x12b)](_0x1f1cfd){const _0x330ea4=_0x93ace4;return{'elementType':ElementType[_0x330ea4(0x11a)],'elementId':'','textElement':{'content':_0x1f1cfd,'atType':AtType[_0x330ea4(0x111)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x33f89b,_0x4df2f7,_0x25729d,_0x4047ea){const _0x5c153d=_0x93ace4;return{'elementType':ElementType[_0x5c153d(0x11a)],'elementId':'','textElement':{'content':'@'+_0x4047ea,'atType':_0x25729d,'atUid':_0x33f89b,'atTinyId':'','atNtUid':_0x4df2f7}};}static[_0x93ace4(0x13c)](_0x5f46b3,_0x52c704,_0x213e89,_0x2e06c4){const _0x53f02d=_0x93ace4;return{'elementType':ElementType[_0x53f02d(0x12c)],'elementId':'','replyElement':{'replayMsgSeq':_0x5f46b3,'replayMsgId':_0x52c704,'senderUin':_0x213e89,'senderUinStr':_0x2e06c4}};}static async['pic'](_0x3551fa,_0x1bb43f='',_0xacaac4=0x0){const _0x379dcd=_0x93ace4,_0x1fa2fb={'FDVmF':function(_0x38145a,_0x40ee8a){return _0x38145a===_0x40ee8a;},'ffUAs':_0x379dcd(0x11c),'LnwqG':function(_0x3b214c,_0xf6d743,_0x2c9315){return _0x3b214c(_0xf6d743,_0x2c9315);},'AzhxS':_0x379dcd(0x162)},{md5:_0x5166ee,fileName:_0x775e9e,path:_0x3dfbab,fileSize:_0x33f3a0}=await NTQQFileApi[_0x379dcd(0x12f)](_0x3551fa,ElementType['PIC'],_0xacaac4);if(_0x1fa2fb[_0x379dcd(0x131)](_0x33f3a0,0x0))throw _0x1fa2fb[_0x379dcd(0x11f)];const _0x366b06=await NTQQFileApi['getImageSize'](_0x3551fa),_0x2059fd={'md5HexStr':_0x5166ee,'fileSize':_0x33f3a0[_0x379dcd(0x126)](),'picWidth':_0x366b06?.[_0x379dcd(0x122)],'picHeight':_0x366b06?.[_0x379dcd(0x150)],'fileName':_0x775e9e,'sourcePath':_0x3dfbab,'original':!![],'picType':isGIF(_0x3551fa)?PicType[_0x379dcd(0x158)]:PicType[_0x379dcd(0x15f)],'picSubType':_0xacaac4,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x1bb43f};return _0x1fa2fb[_0x379dcd(0x12d)](logDebug,_0x1fa2fb['AzhxS'],_0x2059fd),{'elementType':ElementType['PIC'],'elementId':'','picElement':_0x2059fd};}static async[_0x93ace4(0x113)](_0x28b688,_0x326293=''){const _0x22438f=_0x93ace4,_0x27d7fb={'uRhWr':function(_0x34fc81,_0x5dd9b3){return _0x34fc81===_0x5dd9b3;},'idZfM':function(_0x325d0d,_0x110305){return _0x325d0d||_0x110305;}},{md5:_0x4d26a7,fileName:_0x6e575b,path:_0x8b4d03,fileSize:_0x3b604f}=await NTQQFileApi['uploadFile'](_0x28b688,ElementType['FILE']);if(_0x27d7fb[_0x22438f(0x149)](_0x3b604f,0x0))throw _0x22438f(0x11c);const _0x5f4f42={'elementType':ElementType['FILE'],'elementId':'','fileElement':{'fileName':_0x27d7fb[_0x22438f(0x138)](_0x326293,_0x6e575b),'filePath':_0x8b4d03,'fileSize':_0x3b604f[_0x22438f(0x126)]()}};return _0x5f4f42;}static async[_0x93ace4(0x132)](_0x40ccfc,_0x5531c6='',_0x2b3198=''){const _0x12b2d7=_0x93ace4,_0x1f78b4={'HptIQ':function(_0x24e944,_0x384ef5,_0x1f02c9){return _0x24e944(_0x384ef5,_0x1f02c9);},'SEnBg':_0x12b2d7(0x13d),'ceDTx':function(_0x320c3e,_0x5921e3){return _0x320c3e(_0x5921e3);},'fphmf':'end','JRVFl':_0x12b2d7(0x13b),'SgZpy':function(_0x2a20d7,_0x18f92f){return _0x2a20d7+_0x18f92f;},'rEaRl':_0x12b2d7(0x11c),'sxfFK':_0x12b2d7(0x128),'hWLKd':_0x12b2d7(0x117),'pEbRR':function(_0x8a6818,_0x53189b){return _0x8a6818(_0x53189b);},'MPtYH':_0x12b2d7(0x15b),'JSirV':function(_0x16b6f4,_0x257be4,_0xdf3377){return _0x16b6f4(_0x257be4,_0xdf3377);},'RsQyf':_0x12b2d7(0x163),'RKfqW':function(_0x534df8,_0x556f9d){return _0x534df8(_0x556f9d);},'iDifi':function(_0x411b68,_0x2a28e6){return _0x411b68||_0x2a28e6;}},{fileName:_0x5d2dbb,path:_0x1d55fd,fileSize:_0x241caa,md5:_0x470cde}=await NTQQFileApi[_0x12b2d7(0x12f)](_0x40ccfc,ElementType['VIDEO']);if(_0x241caa===0x0)throw _0x1f78b4[_0x12b2d7(0x152)];const _0x52f981=require(_0x1f78b4[_0x12b2d7(0x14f)]);let _0x970504=_0x1d55fd['replace'](_0x52f981[_0x12b2d7(0x124)]+'Ori'+_0x52f981[_0x12b2d7(0x124)],_0x52f981[_0x12b2d7(0x124)]+_0x12b2d7(0x160)+_0x52f981['sep']);_0x970504=_0x52f981[_0x12b2d7(0x11b)](_0x970504);let _0x48b9da={'width':0x780,'height':0x438,'time':0xf,'format':_0x1f78b4[_0x12b2d7(0x114)],'size':_0x241caa,'filePath':_0x40ccfc};try{_0x48b9da=await _0x1f78b4[_0x12b2d7(0x161)](getVideoInfo,_0x1d55fd),_0x1f78b4['HptIQ'](logDebug,_0x1f78b4['MPtYH'],_0x48b9da);}catch(_0x4d81a9){_0x1f78b4[_0x12b2d7(0x14a)](logError,_0x1f78b4[_0x12b2d7(0x129)],_0x4d81a9);}const _0x46fcbe=new Promise((_0x487aeb,_0x685788)=>{const _0x39a6f6=_0x12b2d7,_0x362211={'PdxbX':function(_0x21728c,_0x17f423){return _0x1f78b4['ceDTx'](_0x21728c,_0x17f423);}},_0x3253ca=_0x470cde+_0x39a6f6(0x15e),_0x59aee7=_0x52f981['join'](_0x970504,_0x3253ca);_0x54c5bb(_0x40ccfc)['on'](_0x1f78b4[_0x39a6f6(0x146)],()=>{})['on'](_0x1f78b4['JRVFl'],_0xe1f5d1=>{const _0xfec582=_0x39a6f6,_0xfd46e5={'njvzc':function(_0x5e3d6c,_0x1414a1){return _0x5e3d6c(_0x1414a1);}};_0x1f78b4[_0xfec582(0x155)](logDebug,_0x1f78b4[_0xfec582(0x147)],_0xe1f5d1),_0x2b3198?_0x218cee[_0xfec582(0x136)](_0x2b3198,_0x59aee7)[_0xfec582(0x135)](()=>{const _0x594e6d=_0xfec582;_0x362211[_0x594e6d(0x156)](_0x487aeb,_0x59aee7);})['catch'](_0x685788):_0x218cee[_0xfec582(0x139)](_0x59aee7,defaultVideoThumb)[_0xfec582(0x135)](()=>{const _0x271dfc=_0xfec582;_0xfd46e5[_0x271dfc(0x145)](_0x487aeb,_0x59aee7);})[_0xfec582(0x13f)](_0x685788);})[_0x39a6f6(0x119)]({'timestamps':[0x0],'filename':_0x3253ca,'folder':_0x970504,'size':_0x1f78b4[_0x39a6f6(0x11d)](_0x48b9da[_0x39a6f6(0x122)]+'x',_0x48b9da[_0x39a6f6(0x150)])})['on'](_0x1f78b4[_0x39a6f6(0x146)],()=>{_0x487aeb(_0x59aee7);});}),_0x287510=new Map(),_0x41b11d=await _0x46fcbe,_0x2bc242=(await _0x218cee['stat'](_0x41b11d))['size'];_0x287510[_0x12b2d7(0x14e)](0x0,_0x41b11d);const _0x3d9585=await _0x1f78b4[_0x12b2d7(0x14c)](calculateFileMD5,_0x41b11d),_0x4b44a3={'elementType':ElementType['VIDEO'],'elementId':'','videoElement':{'fileName':_0x1f78b4['iDifi'](_0x5531c6,_0x5d2dbb),'filePath':_0x1d55fd,'videoMd5':_0x470cde,'thumbMd5':_0x3d9585,'fileTime':_0x48b9da[_0x12b2d7(0x154)],'thumbPath':_0x287510,'thumbSize':_0x2bc242,'thumbWidth':_0x48b9da['width'],'thumbHeight':_0x48b9da['height'],'fileSize':_0x1f78b4[_0x12b2d7(0x11d)]('',_0x241caa)}};return _0x4b44a3;}static async['ptt'](_0x10fe43){const _0x18e1de=_0x93ace4,_0x2aef60={'LpIGG':function(_0xbbd906,_0x478c02){return _0xbbd906(_0x478c02);},'zOVNN':_0x18e1de(0x125),'hohLS':_0x18e1de(0x11c)},{converted:_0x74ce87,path:_0x104e90,duration:_0x4c5ecf}=await _0x2aef60['LpIGG'](encodeSilk,_0x10fe43);if(!_0x104e90)throw _0x2aef60['zOVNN'];const {md5:_0x41e509,fileName:_0x1da344,path:_0x1141ed,fileSize:_0x46447a}=await NTQQFileApi[_0x18e1de(0x12f)](_0x104e90,ElementType[_0x18e1de(0x134)]);if(_0x46447a===0x0)throw _0x2aef60[_0x18e1de(0x13a)];return _0x74ce87&&_0x218cee[_0x18e1de(0x15c)](_0x104e90)['then'](),{'elementType':ElementType['PTT'],'elementId':'','pttElement':{'fileName':_0x1da344,'filePath':_0x1141ed,'md5HexStr':_0x41e509,'fileSize':_0x46447a,'duration':_0x4c5ecf||0x1,'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static['face'](_0x3d14e1){const _0xc9bf46=_0x93ace4,_0x5c04f0={'TlLud':function(_0x3a6b47,_0x2c6ddc){return _0x3a6b47<_0x2c6ddc;}};return{'elementType':ElementType[_0xc9bf46(0x148)],'elementId':'','faceElement':{'faceIndex':_0x3d14e1,'faceType':_0x5c04f0[_0xc9bf46(0x137)](_0x3d14e1,0xde)?FaceType['normal']:FaceType[_0xc9bf46(0x121)]}};}static[_0x93ace4(0x153)](_0xdcd6be,_0x4b3393,_0x5308bc,_0x50014e){const _0x311f1e=_0x93ace4,_0x48eb14={'iOIWc':_0x311f1e(0x127)};return{'elementType':ElementType[_0x311f1e(0x118)],'marketFaceElement':{'emojiPackageId':_0xdcd6be,'emojiId':_0x4b3393,'key':_0x5308bc,'faceName':_0x50014e||mFaceCache[_0x311f1e(0x159)](_0x4b3393)||_0x48eb14[_0x311f1e(0x12e)]}};}static['dice'](_0x4be4a6){const _0x2f3924=_0x93ace4,_0x1c70b3={'GHvGx':_0x2f3924(0x164)};return{'elementType':ElementType[_0x2f3924(0x148)],'elementId':'','faceElement':{'faceIndex':FaceIndex['dice'],'faceType':FaceType[_0x2f3924(0x130)],'faceText':_0x1c70b3[_0x2f3924(0x140)],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x93ace4(0x141)](_0x480595){const _0x4e8976=_0x93ace4;return{'elementType':ElementType[_0x4e8976(0x148)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x4e8976(0x15d)],'faceText':_0x4e8976(0x116),'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x93ace4(0x143)](_0x2a568b){const _0x4d6b38=_0x93ace4,_0x167d2f={'XHDMc':function(_0x4227a6,_0x41c4fa){return _0x4227a6!==_0x41c4fa;},'OozAu':_0x4d6b38(0x133)};return _0x167d2f[_0x4d6b38(0x142)](typeof _0x2a568b,_0x167d2f[_0x4d6b38(0x11e)])&&(_0x2a568b=JSON[_0x4d6b38(0x144)](_0x2a568b)),{'elementType':ElementType['ARK'],'elementId':'','arkElement':{'bytesData':_0x2a568b,'linkInfo':null,'subElementType':null}};}static['markdown'](_0x5977f2){return{'elementType':ElementType['MARKDOWN'],'elementId':'','markdownElement':{'content':_0x5977f2}};}}