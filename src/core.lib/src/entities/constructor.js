const _0xf3922d=_0x5cc8;function _0x1ebe(){const _0x5e3034=['cqJqP','WoiZU','toString','Eyllr','normal2','VIDEO','time','normal','获取视频信息失败','dXFvK','onryw','file','6CmngpH','NqmJV','获取视频封面失败，使用默认封面','replace','[商城表情]','xoWsC','25528foBjNN','1949640bdGqQF','PIC','size','Thumb','path','VGtEm','get','uploadFile','1183aIFxEg','Ori','yGhAS','_0.png','TgKRV','PPwsA','WvtwI','mp4','then','reply','[骰子]','文件异常，大小为0','dice','6449gnTsPG','rps','3pXRFIz','64yitdkP','MHnOA','set','pCIVi','ptt','RPS','[包剪锤]','gif','catch','kCiBA','tjuxL','hrDzV','width','nwPWW','jTnMy','sep','CTcWL','视频信息','WFLuW','3164405gzCyUP','1470861xblnNt','MARKDOWN','TEXT','FILE','jpg','writeFile','getImageSize','uoKLk','PTT','join','REPLY','FACE','ZZVoa','stringify','string','height','cSPWg','19389678NZXmOb','语音转换失败,\x20请检查语音文件是否正常','ark','screenshots','video','mface','face','JyHNQ','2980684ISjIpn','end','gFWMC','dirname'];_0x1ebe=function(){return _0x5e3034;};return _0x1ebe();}(function(_0x240d77,_0x5b544c){const _0x15b921=_0x5cc8,_0x33a10c=_0x240d77();while(!![]){try{const _0x1f78ef=parseInt(_0x15b921(0x1d5))/0x1*(parseInt(_0x15b921(0x1d8))/0x2)+parseInt(_0x15b921(0x1d7))/0x3*(parseInt(_0x15b921(0x1a9))/0x4)+-parseInt(_0x15b921(0x1eb))/0x5*(-parseInt(_0x15b921(0x1b9))/0x6)+-parseInt(_0x15b921(0x1c8))/0x7*(-parseInt(_0x15b921(0x1bf))/0x8)+-parseInt(_0x15b921(0x1ec))/0x9+parseInt(_0x15b921(0x1c0))/0xa+-parseInt(_0x15b921(0x1a1))/0xb;if(_0x1f78ef===_0x5b544c)break;else _0x33a10c['push'](_0x33a10c['shift']());}catch(_0x1028ff){_0x33a10c['push'](_0x33a10c['shift']());}}}(_0x1ebe,0x5fd58));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';function _0x5cc8(_0xfd2de2,_0x59b0f4){const _0x1ebe1d=_0x1ebe();return _0x5cc8=function(_0x5cc895,_0x2ce2c1){_0x5cc895=_0x5cc895-0x196;let _0x3b6ad2=_0x1ebe1d[_0x5cc895];return _0x3b6ad2;},_0x5cc8(_0xfd2de2,_0x59b0f4);}import{promises as _0x154d25}from'node:fs';import _0x3bd43b from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';export const mFaceCache=new Map();export class SendMsgElementConstructor{static['text'](_0x19cbf0){const _0x37d302=_0x5cc8;return{'elementType':ElementType[_0x37d302(0x1ee)],'elementId':'','textElement':{'content':_0x19cbf0,'atType':AtType['notAt'],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x566a3b,_0x24a881,_0x4c44f6,_0x4c5493){return{'elementType':ElementType['TEXT'],'elementId':'','textElement':{'content':'@'+_0x4c5493,'atType':_0x4c44f6,'atUid':_0x566a3b,'atTinyId':'','atNtUid':_0x24a881}};}static[_0xf3922d(0x1d1)](_0x2b2730,_0x54d2b6,_0x5b589b,_0x5b2496){const _0x940962=_0xf3922d;return{'elementType':ElementType[_0x940962(0x19a)],'elementId':'','replyElement':{'replayMsgSeq':_0x2b2730,'replayMsgId':_0x54d2b6,'senderUin':_0x5b589b,'senderUinStr':_0x5b2496}};}static async['pic'](_0x19ced8,_0x273fe4='',_0x1641f7=0x0){const _0x3923ad=_0xf3922d,_0x57796d={'hrDzV':_0x3923ad(0x1d3),'kCiBA':function(_0x4ad349,_0x37a223){return _0x4ad349(_0x37a223);},'WvtwI':function(_0x6bea3c,_0x2d4266,_0x5702ef){return _0x6bea3c(_0x2d4266,_0x5702ef);}},{md5:_0x42532e,fileName:_0x82fa63,path:_0x3c37ab,fileSize:_0x537eb0}=await NTQQFileApi['uploadFile'](_0x19ced8,ElementType[_0x3923ad(0x1c1)],_0x1641f7);if(_0x537eb0===0x0)throw _0x57796d[_0x3923ad(0x1e3)];const _0x1ca41c=await NTQQFileApi[_0x3923ad(0x196)](_0x19ced8),_0x5e01c1={'md5HexStr':_0x42532e,'fileSize':_0x537eb0[_0x3923ad(0x1af)](),'picWidth':_0x1ca41c?.[_0x3923ad(0x1e4)],'picHeight':_0x1ca41c?.[_0x3923ad(0x19f)],'fileName':_0x82fa63,'sourcePath':_0x3c37ab,'original':!![],'picType':_0x57796d[_0x3923ad(0x1e1)](isGIF,_0x19ced8)?PicType[_0x3923ad(0x1df)]:PicType[_0x3923ad(0x1f0)],'picSubType':_0x1641f7,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x273fe4};return _0x57796d[_0x3923ad(0x1ce)](logDebug,'图片信息',_0x5e01c1),{'elementType':ElementType[_0x3923ad(0x1c1)],'elementId':'','picElement':_0x5e01c1};}static async[_0xf3922d(0x1b8)](_0x5986d9,_0xf725a7=''){const _0x9c3534=_0xf3922d,_0x4690d0={'Eyllr':function(_0x3aa793,_0x29b5f3){return _0x3aa793===_0x29b5f3;},'NqmJV':function(_0x297401,_0x2ba9a5){return _0x297401||_0x2ba9a5;}},{md5:_0x18ed63,fileName:_0x3da176,path:_0x47993a,fileSize:_0x947cb0}=await NTQQFileApi[_0x9c3534(0x1c7)](_0x5986d9,ElementType[_0x9c3534(0x1ef)]);if(_0x4690d0[_0x9c3534(0x1b0)](_0x947cb0,0x0))throw _0x9c3534(0x1d3);const _0x23834a={'elementType':ElementType[_0x9c3534(0x1ef)],'elementId':'','fileElement':{'fileName':_0x4690d0[_0x9c3534(0x1ba)](_0xf725a7,_0x3da176),'filePath':_0x47993a,'fileSize':_0x947cb0['toString']()}};return _0x23834a;}static async[_0xf3922d(0x1a5)](_0x148b48,_0x51e0b9='',_0xc53192=''){const _0x1e42c4=_0xf3922d,_0x458fb2={'WFLuW':function(_0x9f290c,_0x4c6659){return _0x9f290c(_0x4c6659);},'CTcWL':function(_0x43e07b,_0x381cec,_0x49881d){return _0x43e07b(_0x381cec,_0x49881d);},'jTnMy':_0x1e42c4(0x1bb),'uoKLk':_0x1e42c4(0x1aa),'pcAfH':'error','pCIVi':function(_0x3221ff,_0x26a987){return _0x3221ff+_0x26a987;},'TgKRV':function(_0x36f0bf,_0x5d7374){return _0x36f0bf+_0x5d7374;},'yGhAS':function(_0x3a1143,_0x392e65){return _0x3a1143===_0x392e65;},'JyHNQ':_0x1e42c4(0x1d3),'MHnOA':_0x1e42c4(0x1c4),'PPwsA':_0x1e42c4(0x1cf),'ZZVoa':_0x1e42c4(0x1e9),'xoWsC':function(_0x14cbe4,_0x61353d){return _0x14cbe4(_0x61353d);},'nJhdn':function(_0x4a18a0,_0x15bfbc){return _0x4a18a0+_0x15bfbc;}},{fileName:_0x2d2562,path:_0x5a7fb2,fileSize:_0x2fe2f9,md5:_0x2a1a5e}=await NTQQFileApi[_0x1e42c4(0x1c7)](_0x148b48,ElementType[_0x1e42c4(0x1b2)]);if(_0x458fb2[_0x1e42c4(0x1ca)](_0x2fe2f9,0x0))throw _0x458fb2[_0x1e42c4(0x1a8)];const _0x2588cf=require(_0x458fb2[_0x1e42c4(0x1d9)]);let _0x1ed63a=_0x5a7fb2[_0x1e42c4(0x1bc)](_0x2588cf[_0x1e42c4(0x1e7)]+_0x1e42c4(0x1c9)+_0x2588cf['sep'],_0x2588cf['sep']+_0x1e42c4(0x1c3)+_0x2588cf[_0x1e42c4(0x1e7)]);_0x1ed63a=_0x2588cf[_0x1e42c4(0x1ac)](_0x1ed63a);let _0x3d82ad={'width':0x780,'height':0x438,'time':0xf,'format':_0x458fb2[_0x1e42c4(0x1cd)],'size':_0x2fe2f9,'filePath':_0x148b48};try{_0x3d82ad=await getVideoInfo(_0x5a7fb2),_0x458fb2[_0x1e42c4(0x1e8)](logDebug,_0x458fb2[_0x1e42c4(0x19c)],_0x3d82ad);}catch(_0x14afa5){logError(_0x1e42c4(0x1b5),_0x14afa5);}const _0xfad0fe=new Promise((_0x437068,_0x15192c)=>{const _0x2fd1e8=_0x1e42c4,_0x246e4c={'cSPWg':function(_0x313115,_0x3fbd3b){const _0x1d2994=_0x5cc8;return _0x458fb2[_0x1d2994(0x1ea)](_0x313115,_0x3fbd3b);},'dXFvK':function(_0xe02b70,_0x33af57,_0xde9bfd){const _0xc0039=_0x5cc8;return _0x458fb2[_0xc0039(0x1e8)](_0xe02b70,_0x33af57,_0xde9bfd);},'WoiZU':_0x458fb2[_0x2fd1e8(0x1e6)]},_0x1d2e6f=_0x2a1a5e+_0x2fd1e8(0x1cb),_0x3223a6=_0x2588cf[_0x2fd1e8(0x199)](_0x1ed63a,_0x1d2e6f);_0x458fb2['WFLuW'](_0x3bd43b,_0x148b48)['on'](_0x458fb2['uoKLk'],()=>{})['on'](_0x458fb2['pcAfH'],_0xdebed2=>{const _0x51958f=_0x2fd1e8,_0x460b7e={'gFWMC':function(_0x4f9df1,_0xa6d2f1){const _0x11fbb3=_0x5cc8;return _0x246e4c[_0x11fbb3(0x1a0)](_0x4f9df1,_0xa6d2f1);}};_0x246e4c[_0x51958f(0x1b6)](logDebug,_0x246e4c[_0x51958f(0x1ae)],_0xdebed2),_0xc53192?_0x154d25['copyFile'](_0xc53192,_0x3223a6)[_0x51958f(0x1d0)](()=>{_0x460b7e['gFWMC'](_0x437068,_0x3223a6);})[_0x51958f(0x1e0)](_0x15192c):_0x154d25[_0x51958f(0x1f1)](_0x3223a6,defaultVideoThumb)['then'](()=>{const _0x56960f=_0x51958f;_0x460b7e[_0x56960f(0x1ab)](_0x437068,_0x3223a6);})[_0x51958f(0x1e0)](_0x15192c);})[_0x2fd1e8(0x1a4)]({'timestamps':[0x0],'filename':_0x1d2e6f,'folder':_0x1ed63a,'size':_0x458fb2[_0x2fd1e8(0x1db)](_0x458fb2[_0x2fd1e8(0x1cc)](_0x3d82ad['width'],'x'),_0x3d82ad['height'])})['on'](_0x458fb2[_0x2fd1e8(0x197)],()=>{const _0xeaac30=_0x2fd1e8;_0x458fb2[_0xeaac30(0x1ea)](_0x437068,_0x3223a6);});}),_0x438cd0=new Map(),_0x2bf7e6=await _0xfad0fe,_0x31b87=(await _0x154d25['stat'](_0x2bf7e6))[_0x1e42c4(0x1c2)];_0x438cd0[_0x1e42c4(0x1da)](0x0,_0x2bf7e6);const _0x23a3a0=await _0x458fb2[_0x1e42c4(0x1be)](calculateFileMD5,_0x2bf7e6),_0x2d0aaa={'elementType':ElementType[_0x1e42c4(0x1b2)],'elementId':'','videoElement':{'fileName':_0x51e0b9||_0x2d2562,'filePath':_0x5a7fb2,'videoMd5':_0x2a1a5e,'thumbMd5':_0x23a3a0,'fileTime':_0x3d82ad[_0x1e42c4(0x1b3)],'thumbPath':_0x438cd0,'thumbSize':_0x31b87,'thumbWidth':_0x3d82ad[_0x1e42c4(0x1e4)],'thumbHeight':_0x3d82ad[_0x1e42c4(0x19f)],'fileSize':_0x458fb2['nJhdn']('',_0x2fe2f9)}};return _0x2d0aaa;}static async[_0xf3922d(0x1dc)](_0x1a9c6e){const _0x316eca=_0xf3922d,_0x26d802={'nwPWW':_0x316eca(0x1a2),'aSidh':function(_0x4a2747,_0x3e0c4f){return _0x4a2747===_0x3e0c4f;},'tjuxL':'文件异常，大小为0','iLVIZ':function(_0x37a49d,_0x260b13){return _0x37a49d||_0x260b13;}},{converted:_0x5c3f25,path:_0x1d6ca5,duration:_0x111d38}=await encodeSilk(_0x1a9c6e);if(!_0x1d6ca5)throw _0x26d802[_0x316eca(0x1e5)];const {md5:_0x476a7d,fileName:_0x70a1af,path:_0x9fcd9,fileSize:_0x3f2591}=await NTQQFileApi['uploadFile'](_0x1d6ca5,ElementType['PTT']);if(_0x26d802['aSidh'](_0x3f2591,0x0))throw _0x26d802[_0x316eca(0x1e2)];return _0x5c3f25&&_0x154d25['unlink'](_0x1d6ca5)[_0x316eca(0x1d0)](),{'elementType':ElementType[_0x316eca(0x198)],'elementId':'','pttElement':{'fileName':_0x70a1af,'filePath':_0x9fcd9,'md5HexStr':_0x476a7d,'fileSize':_0x3f2591,'duration':_0x26d802['iLVIZ'](_0x111d38,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static[_0xf3922d(0x1a7)](_0x3e3fea){const _0xc9e8f5=_0xf3922d,_0x13a1d7={'cqJqP':function(_0x52372d,_0x5434fc){return _0x52372d<_0x5434fc;}};return{'elementType':ElementType[_0xc9e8f5(0x19b)],'elementId':'','faceElement':{'faceIndex':_0x3e3fea,'faceType':_0x13a1d7[_0xc9e8f5(0x1ad)](_0x3e3fea,0xde)?FaceType[_0xc9e8f5(0x1b4)]:FaceType[_0xc9e8f5(0x1b1)]}};}static[_0xf3922d(0x1a6)](_0x5e42ce,_0x2f45f2,_0x1536c9,_0x33759f){const _0x5850f6=_0xf3922d,_0x50a0f0={'RDbFP':_0x5850f6(0x1bd)};return{'elementType':ElementType['MFACE'],'marketFaceElement':{'emojiPackageId':_0x5e42ce,'emojiId':_0x2f45f2,'key':_0x1536c9,'faceName':_0x33759f||mFaceCache[_0x5850f6(0x1c6)](_0x2f45f2)||_0x50a0f0['RDbFP']}};}static[_0xf3922d(0x1d4)](_0x449620){const _0x336010=_0xf3922d,_0x4c9789={'onryw':_0x336010(0x1d2)};return{'elementType':ElementType[_0x336010(0x19b)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x336010(0x1d4)],'faceType':FaceType[_0x336010(0x1d4)],'faceText':_0x4c9789[_0x336010(0x1b7)],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0xf3922d(0x1d6)](_0x10ffb5){const _0x541681=_0xf3922d,_0x54c475={'VGtEm':_0x541681(0x1de)};return{'elementType':ElementType[_0x541681(0x19b)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x541681(0x1dd)],'faceText':_0x54c475[_0x541681(0x1c5)],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0xf3922d(0x1a3)](_0x5c4223){const _0x1c08a4=_0xf3922d;return typeof _0x5c4223!==_0x1c08a4(0x19e)&&(_0x5c4223=JSON[_0x1c08a4(0x19d)](_0x5c4223)),{'elementType':ElementType['ARK'],'elementId':'','arkElement':{'bytesData':_0x5c4223,'linkInfo':null,'subElementType':null}};}static['markdown'](_0x118438){const _0x5a6627=_0xf3922d;return{'elementType':ElementType[_0x5a6627(0x1ed)],'elementId':'','markdownElement':{'content':_0x118438}};}}