const _0x2040c9=_0x48c3;(function(_0x232b68,_0xbdeef8){const _0x2497a3=_0x48c3,_0xc416a5=_0x232b68();while(!![]){try{const _0x31b7a7=parseInt(_0x2497a3(0xd3))/0x1+parseInt(_0x2497a3(0xd2))/0x2+parseInt(_0x2497a3(0xf4))/0x3*(-parseInt(_0x2497a3(0xc1))/0x4)+-parseInt(_0x2497a3(0xcb))/0x5+parseInt(_0x2497a3(0xc0))/0x6+parseInt(_0x2497a3(0xb9))/0x7+-parseInt(_0x2497a3(0xff))/0x8;if(_0x31b7a7===_0xbdeef8)break;else _0xc416a5['push'](_0xc416a5['shift']());}catch(_0x46ab63){_0xc416a5['push'](_0xc416a5['shift']());}}}(_0x47b4,0xf095c));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';function _0x48c3(_0x55de19,_0x17fd82){const _0x47b4e9=_0x47b4();return _0x48c3=function(_0x48c32b,_0x34530e){_0x48c32b=_0x48c32b-0xb1;let _0xdc1f7a=_0x47b4e9[_0x48c32b];return _0xdc1f7a;},_0x48c3(_0x55de19,_0x17fd82);}import{promises as _0x28eecd}from'node:fs';import _0x5b91b5 from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';function _0x47b4(){const _0x125821=['VIDEO','RPS','REPLY','文件异常，大小为0','语音转换失败,\x20请检查语音文件是否正常','bYgjG','_0.png','FACE','FILE','图片信息','6LerNfk','PhSFY','mp4','dRgwx','wPvIC','lqEfo','ptt','QdWRv','MfWOv','writeFile','MYibT','4552192LebMhK','FHoqa','RfKMD','rps','dice','toString','wdwLv','then','set','Ori','视频信息','copyFile','sFjfZ','text','pic','join','3673628mfHUrJ','MARKDOWN','face','PIC','width','PKioH','IUyGi','3024708WYVxiZ','1990484MTQjMi','jpg','end','ZplfA','xrXLv','markdown','[骰子]','获取视频信息失败','path','notAt','2604485eczXIU','uploadFile','replace','MFACE','catch','mdApd','time','1524990SIOmAY','1279182pPvoOs','[商城表情]','error','dirname','PTT','normal2','stringify','TEXT','RlRga','tJoWw','ark','getImageSize','gif','rjnbs','string','Dmuwb','获取视频封面失败，使用默认封面','height','screenshots','unlink','[包剪锤]','sep','NJIvg'];_0x47b4=function(){return _0x125821;};return _0x47b4();}import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';export const mFaceCache=new Map();export class SendMsgElementConstructor{static[_0x2040c9(0xb6)](_0x4a3472){const _0xe7a8fa=_0x2040c9;return{'elementType':ElementType[_0xe7a8fa(0xda)],'elementId':'','textElement':{'content':_0x4a3472,'atType':AtType[_0xe7a8fa(0xca)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x3b6546,_0x5c0ae3,_0x176ec3,_0x289487){const _0x58e6f9=_0x2040c9;return{'elementType':ElementType[_0x58e6f9(0xda)],'elementId':'','textElement':{'content':'@'+_0x289487,'atType':_0x176ec3,'atUid':_0x3b6546,'atTinyId':'','atNtUid':_0x5c0ae3}};}static['reply'](_0x25b6fc,_0x46f075,_0x3bd010,_0x354e34){const _0x5a9ea4=_0x2040c9;return{'elementType':ElementType[_0x5a9ea4(0xec)],'elementId':'','replyElement':{'replayMsgSeq':_0x25b6fc,'replayMsgId':_0x46f075,'senderUin':_0x3bd010,'senderUinStr':_0x354e34}};}static async[_0x2040c9(0xb7)](_0x33b0f0,_0x3e936c='',_0x1ed57f=0x0){const _0x28e9fc=_0x2040c9,_0x4cec65={'RfKMD':function(_0x1581d4,_0x406758){return _0x1581d4===_0x406758;},'sdxCI':_0x28e9fc(0xed),'QdWRv':function(_0x94bd39,_0x7a38ac){return _0x94bd39(_0x7a38ac);},'eBJKf':_0x28e9fc(0xf3)},{md5:_0x3be3c2,fileName:_0x53c9cd,path:_0x288c5d,fileSize:_0x5af479}=await NTQQFileApi[_0x28e9fc(0xcc)](_0x33b0f0,ElementType['PIC'],_0x1ed57f);if(_0x4cec65[_0x28e9fc(0x101)](_0x5af479,0x0))throw _0x4cec65['sdxCI'];const _0x1110e7=await NTQQFileApi[_0x28e9fc(0xde)](_0x33b0f0),_0x4b26dd={'md5HexStr':_0x3be3c2,'fileSize':_0x5af479[_0x28e9fc(0x104)](),'picWidth':_0x1110e7?.[_0x28e9fc(0xbd)],'picHeight':_0x1110e7?.['height'],'fileName':_0x53c9cd,'sourcePath':_0x288c5d,'original':!![],'picType':_0x4cec65[_0x28e9fc(0xfb)](isGIF,_0x33b0f0)?PicType[_0x28e9fc(0xdf)]:PicType[_0x28e9fc(0xc2)],'picSubType':_0x1ed57f,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x3e936c};return logDebug(_0x4cec65['eBJKf'],_0x4b26dd),{'elementType':ElementType[_0x28e9fc(0xbc)],'elementId':'','picElement':_0x4b26dd};}static async['file'](_0x1959d3,_0x465d58=''){const _0x3d2911=_0x2040c9,_0x3963a1={'IUyGi':function(_0x166392,_0x2917b1){return _0x166392===_0x2917b1;}},{md5:_0x553e7f,fileName:_0x5e21ff,path:_0x21f6b1,fileSize:_0x247040}=await NTQQFileApi[_0x3d2911(0xcc)](_0x1959d3,ElementType[_0x3d2911(0xf2)]);if(_0x3963a1[_0x3d2911(0xbf)](_0x247040,0x0))throw'文件异常，大小为0';const _0x5dc981={'elementType':ElementType[_0x3d2911(0xf2)],'elementId':'','fileElement':{'fileName':_0x465d58||_0x5e21ff,'filePath':_0x21f6b1,'fileSize':_0x247040['toString']()}};return _0x5dc981;}static async['video'](_0x3184e5,_0x13ea10='',_0x242060=''){const _0xc62665=_0x2040c9,_0x188081={'MfWOv':_0xc62665(0xe3),'Dmuwb':function(_0x3fee64,_0x1a2c90){return _0x3fee64(_0x1a2c90);},'wdwLv':function(_0x24d161,_0x3c7ab6){return _0x24d161(_0x3c7ab6);},'lqEfo':_0xc62665(0xc3),'wPvIC':_0xc62665(0xd5),'mdApd':function(_0x4fb990,_0x44e583){return _0x4fb990+_0x44e583;},'xrXLv':function(_0x1113f0,_0x34c199){return _0x1113f0+_0x34c199;},'vhidf':function(_0x54d136,_0x329d72){return _0x54d136===_0x329d72;},'bYgjG':'文件异常，大小为0','pRYrb':_0xc62665(0xc9),'RlRga':_0xc62665(0xf6),'NJIvg':function(_0x237205,_0x1280f3,_0x7b67a7){return _0x237205(_0x1280f3,_0x7b67a7);},'rjnbs':_0xc62665(0xb3),'dRgwx':function(_0x5913d9,_0x1f4662){return _0x5913d9||_0x1f4662;},'bWwll':function(_0x3b5183,_0x538b0d){return _0x3b5183+_0x538b0d;}},{fileName:_0x473dba,path:_0x2771fe,fileSize:_0x4e5d94,md5:_0x51cf73}=await NTQQFileApi['uploadFile'](_0x3184e5,ElementType['VIDEO']);if(_0x188081['vhidf'](_0x4e5d94,0x0))throw _0x188081[_0xc62665(0xef)];const _0x1618b3=_0x188081[_0xc62665(0x105)](require,_0x188081['pRYrb']);let _0x5839f4=_0x2771fe[_0xc62665(0xcd)](_0x1618b3['sep']+_0xc62665(0xb2)+_0x1618b3['sep'],_0x1618b3[_0xc62665(0xe8)]+'Thumb'+_0x1618b3[_0xc62665(0xe8)]);_0x5839f4=_0x1618b3[_0xc62665(0xd6)](_0x5839f4);let _0x11e42a={'width':0x780,'height':0x438,'time':0xf,'format':_0x188081[_0xc62665(0xdb)],'size':_0x4e5d94,'filePath':_0x3184e5};try{_0x11e42a=await _0x188081[_0xc62665(0xe2)](getVideoInfo,_0x2771fe),_0x188081[_0xc62665(0xe9)](logDebug,_0x188081[_0xc62665(0xe0)],_0x11e42a);}catch(_0x198392){_0x188081[_0xc62665(0xe9)](logError,_0xc62665(0xc8),_0x198392);}const _0x40231d=new Promise((_0x129947,_0x27a07d)=>{const _0x34ef4a=_0xc62665,_0xf18d84={'sFjfZ':function(_0x3bd6a0,_0x14770f){const _0x3df87b=_0x48c3;return _0x188081[_0x3df87b(0xe2)](_0x3bd6a0,_0x14770f);},'xSzQB':function(_0x5df604,_0x42f67d){return _0x188081['Dmuwb'](_0x5df604,_0x42f67d);}},_0x3dce88=_0x51cf73+_0x34ef4a(0xf0),_0x19b773=_0x1618b3[_0x34ef4a(0xb8)](_0x5839f4,_0x3dce88);_0x188081['wdwLv'](_0x5b91b5,_0x3184e5)['on'](_0x188081[_0x34ef4a(0xf9)],()=>{})['on'](_0x188081[_0x34ef4a(0xf8)],_0x2b997e=>{const _0x4f83e3=_0x34ef4a;logDebug(_0x188081[_0x4f83e3(0xfc)],_0x2b997e),_0x242060?_0x28eecd[_0x4f83e3(0xb4)](_0x242060,_0x19b773)[_0x4f83e3(0x106)](()=>{const _0x10a43c=_0x4f83e3;_0xf18d84[_0x10a43c(0xb5)](_0x129947,_0x19b773);})['catch'](_0x27a07d):_0x28eecd[_0x4f83e3(0xfd)](_0x19b773,defaultVideoThumb)[_0x4f83e3(0x106)](()=>{_0xf18d84['xSzQB'](_0x129947,_0x19b773);})[_0x4f83e3(0xcf)](_0x27a07d);})[_0x34ef4a(0xe5)]({'timestamps':[0x0],'filename':_0x3dce88,'folder':_0x5839f4,'size':_0x188081[_0x34ef4a(0xd0)](_0x188081[_0x34ef4a(0xc5)](_0x11e42a[_0x34ef4a(0xbd)],'x'),_0x11e42a[_0x34ef4a(0xe4)])})['on'](_0x188081[_0x34ef4a(0xf9)],()=>{const _0x22de43=_0x34ef4a;_0x188081[_0x22de43(0xe2)](_0x129947,_0x19b773);});}),_0x3b18c4=new Map(),_0x3ba069=await _0x40231d,_0x33b753=(await _0x28eecd['stat'](_0x3ba069))['size'];_0x3b18c4[_0xc62665(0xb1)](0x0,_0x3ba069);const _0x89c7b3=await _0x188081[_0xc62665(0x105)](calculateFileMD5,_0x3ba069),_0x4c60c8={'elementType':ElementType[_0xc62665(0xea)],'elementId':'','videoElement':{'fileName':_0x188081[_0xc62665(0xf7)](_0x13ea10,_0x473dba),'filePath':_0x2771fe,'videoMd5':_0x51cf73,'thumbMd5':_0x89c7b3,'fileTime':_0x11e42a[_0xc62665(0xd1)],'thumbPath':_0x3b18c4,'thumbSize':_0x33b753,'thumbWidth':_0x11e42a[_0xc62665(0xbd)],'thumbHeight':_0x11e42a[_0xc62665(0xe4)],'fileSize':_0x188081['bWwll']('',_0x4e5d94)}};return _0x4c60c8;}static async[_0x2040c9(0xfa)](_0x587949){const _0x3f0ccc=_0x2040c9,_0x511cc8={'EocYa':function(_0x502996,_0x44c664){return _0x502996(_0x44c664);},'FHoqa':'文件异常，大小为0','tJoWw':function(_0x2cf4a5,_0x365157){return _0x2cf4a5||_0x365157;}},{converted:_0x5857ba,path:_0x5817f6,duration:_0x5b88cc}=await _0x511cc8['EocYa'](encodeSilk,_0x587949);if(!_0x5817f6)throw _0x3f0ccc(0xee);const {md5:_0x42c33a,fileName:_0xc66341,path:_0x9955df,fileSize:_0x419d47}=await NTQQFileApi['uploadFile'](_0x5817f6,ElementType[_0x3f0ccc(0xd7)]);if(_0x419d47===0x0)throw _0x511cc8[_0x3f0ccc(0x100)];return _0x5857ba&&_0x28eecd[_0x3f0ccc(0xe6)](_0x5817f6)[_0x3f0ccc(0x106)](),{'elementType':ElementType[_0x3f0ccc(0xd7)],'elementId':'','pttElement':{'fileName':_0xc66341,'filePath':_0x9955df,'md5HexStr':_0x42c33a,'fileSize':_0x419d47,'duration':_0x511cc8[_0x3f0ccc(0xdc)](_0x5b88cc,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static[_0x2040c9(0xbb)](_0x4af9b3){const _0x4a4172=_0x2040c9,_0xf964ac={'ZplfA':function(_0x319828,_0x1210a7){return _0x319828<_0x1210a7;}};return{'elementType':ElementType[_0x4a4172(0xf1)],'elementId':'','faceElement':{'faceIndex':_0x4af9b3,'faceType':_0xf964ac[_0x4a4172(0xc4)](_0x4af9b3,0xde)?FaceType['normal']:FaceType[_0x4a4172(0xd8)]}};}static['mface'](_0x105240,_0xcf06ce,_0x38767d,_0x184546){const _0x28a0b4=_0x2040c9,_0x35664d={'MYibT':_0x28a0b4(0xd4)};return{'elementType':ElementType[_0x28a0b4(0xce)],'marketFaceElement':{'emojiPackageId':_0x105240,'emojiId':_0xcf06ce,'key':_0x38767d,'faceName':_0x184546||mFaceCache['get'](_0xcf06ce)||_0x35664d[_0x28a0b4(0xfe)]}};}static[_0x2040c9(0x103)](_0x213500){const _0x30e021=_0x2040c9,_0x37d8b5={'TWNQZ':_0x30e021(0xc7)};return{'elementType':ElementType['FACE'],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x30e021(0x103)],'faceType':FaceType[_0x30e021(0x103)],'faceText':_0x37d8b5['TWNQZ'],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x2040c9(0x102)](_0x4f982d){const _0x494af3=_0x2040c9,_0x19e053={'PhSFY':_0x494af3(0xe7)};return{'elementType':ElementType['FACE'],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x494af3(0xeb)],'faceText':_0x19e053[_0x494af3(0xf5)],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x2040c9(0xdd)](_0x451e27){const _0x2124df=_0x2040c9,_0x3d995c={'PKioH':function(_0x459a9b,_0x2bcf2b){return _0x459a9b!==_0x2bcf2b;}};return _0x3d995c[_0x2124df(0xbe)](typeof _0x451e27,_0x2124df(0xe1))&&(_0x451e27=JSON[_0x2124df(0xd9)](_0x451e27)),{'elementType':ElementType['ARK'],'elementId':'','arkElement':{'bytesData':_0x451e27,'linkInfo':null,'subElementType':null}};}static[_0x2040c9(0xc6)](_0x4594ae){const _0x7f0a31=_0x2040c9;return{'elementType':ElementType[_0x7f0a31(0xba)],'elementId':'','markdownElement':{'content':_0x4594ae}};}}