const _0x2ec5bf=_0x862f;(function(_0xafd43e,_0x4f637a){const _0x232b07=_0x862f,_0x4e7178=_0xafd43e();while(!![]){try{const _0x5581ae=parseInt(_0x232b07(0x117))/0x1*(-parseInt(_0x232b07(0x110))/0x2)+parseInt(_0x232b07(0xcd))/0x3*(parseInt(_0x232b07(0xd6))/0x4)+parseInt(_0x232b07(0xe3))/0x5*(-parseInt(_0x232b07(0x118))/0x6)+parseInt(_0x232b07(0xed))/0x7*(parseInt(_0x232b07(0xdd))/0x8)+parseInt(_0x232b07(0x10f))/0x9*(parseInt(_0x232b07(0xd3))/0xa)+-parseInt(_0x232b07(0xca))/0xb*(parseInt(_0x232b07(0xc7))/0xc)+parseInt(_0x232b07(0xff))/0xd*(parseInt(_0x232b07(0xee))/0xe);if(_0x5581ae===_0x4f637a)break;else _0x4e7178['push'](_0x4e7178['shift']());}catch(_0x41e317){_0x4e7178['push'](_0x4e7178['shift']());}}}(_0x92dd,0x7ef83));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x398f30}from'node:fs';import _0x4ae4f6 from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';function _0x862f(_0x24bbdf,_0x3f4f10){const _0x92ddb5=_0x92dd();return _0x862f=function(_0x862fca,_0x2ac7ff){_0x862fca=_0x862fca-0xc1;let _0x27b350=_0x92ddb5[_0x862fca];return _0x27b350;},_0x862f(_0x24bbdf,_0x3f4f10);}import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';function _0x92dd(){const _0x528ddf=['PIC','UGJFb','UoLmf','eetkj','16DCDqCm','iMuQE','JEuUD','string','gif','then','15igxkBs','screenshots','MARKDOWN','error','语音转换失败,\x20请检查语音文件是否正常','VIDEO','end','获取视频信息失败','pic','FILE','419986WqzhTF','14ODPcZo','xUsOq','size','jCVap','vCfBB','mp4','rsatO','notAt','height','getImageSize','文件异常，大小为0','ARK','dirname','RivuF','jpg','kKjsX','unlink','32013319vMXUet','NjsaS','OZXCI','rwRRP','HBJSs','_0.png','width','ZGyCR','Zamcl','video','rps','set','MZaXF','[包剪锤]','path','TEXT','9UJidha','1262174WIxIKl','uploadFile','catch','sep','获取视频封面失败，使用默认封面','copyFile','ptt','1IyrRox','1663764FliaWE','PTT','normal','stat','time','RPS','writeFile','trOqS','12CHvZyV','KcZNr','Ori','9791452BroqNR','dice','cMZXl','318561XGPvgL','FACE','kwgRS','mface','toString','olQaI','782350NTrxfJ','text','face','8AJHWJX','图片信息','markdown'];_0x92dd=function(){return _0x528ddf;};return _0x92dd();}import{encodeSilk}from'@/common/utils/audio';export const mFaceCache=new Map();export class SendMsgElementConstructor{static[_0x2ec5bf(0xd4)](_0xa60653){const _0x4c6126=_0x2ec5bf;return{'elementType':ElementType[_0x4c6126(0x10e)],'elementId':'','textElement':{'content':_0xa60653,'atType':AtType[_0x4c6126(0xf5)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x1405d2,_0x512f20,_0x3b2613,_0x398809){const _0x2f8453=_0x2ec5bf;return{'elementType':ElementType[_0x2f8453(0x10e)],'elementId':'','textElement':{'content':'@'+_0x398809,'atType':_0x3b2613,'atUid':_0x1405d2,'atTinyId':'','atNtUid':_0x512f20}};}static['reply'](_0x882439,_0x340dd2,_0x9d8a23,_0x433653){return{'elementType':ElementType['REPLY'],'elementId':'','replyElement':{'replayMsgSeq':_0x882439,'replayMsgId':_0x340dd2,'senderUin':_0x9d8a23,'senderUinStr':_0x433653}};}static async[_0x2ec5bf(0xeb)](_0x30b813,_0x558d92='',_0xb955f2=0x0){const _0x4f5dc7=_0x2ec5bf,_0x413573={'Zamcl':'文件异常，大小为0','KcZNr':function(_0x496fe7,_0x310b28){return _0x496fe7(_0x310b28);},'MZaXF':function(_0x47d1cc,_0x2061ce,_0x146fd4){return _0x47d1cc(_0x2061ce,_0x146fd4);}},{md5:_0x431dec,fileName:_0x15e3f2,path:_0x5aa414,fileSize:_0x7ba8d}=await NTQQFileApi[_0x4f5dc7(0x111)](_0x30b813,ElementType[_0x4f5dc7(0xd9)],_0xb955f2);if(_0x7ba8d===0x0)throw _0x413573[_0x4f5dc7(0x107)];const _0x24ce8a=await NTQQFileApi[_0x4f5dc7(0xf7)](_0x30b813),_0x1248c3={'md5HexStr':_0x431dec,'fileSize':_0x7ba8d['toString'](),'picWidth':_0x24ce8a?.[_0x4f5dc7(0x105)],'picHeight':_0x24ce8a?.[_0x4f5dc7(0xf6)],'fileName':_0x15e3f2,'sourcePath':_0x5aa414,'original':!![],'picType':_0x413573[_0x4f5dc7(0xc8)](isGIF,_0x30b813)?PicType[_0x4f5dc7(0xe1)]:PicType[_0x4f5dc7(0xfc)],'picSubType':_0xb955f2,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x558d92};return _0x413573[_0x4f5dc7(0x10b)](logDebug,_0x4f5dc7(0xd7),_0x1248c3),{'elementType':ElementType[_0x4f5dc7(0xd9)],'elementId':'','picElement':_0x1248c3};}static async['file'](_0x96085a,_0x21e4cd=''){const _0xb10ce5=_0x2ec5bf,_0x5a9493={'OZXCI':function(_0xd5a793,_0xaaa22e){return _0xd5a793===_0xaaa22e;},'rsatO':_0xb10ce5(0xf8),'cMZXl':function(_0x5b9b7c,_0x196895){return _0x5b9b7c||_0x196895;}},{md5:_0x3d78de,fileName:_0x183e7c,path:_0x3aca3b,fileSize:_0x434099}=await NTQQFileApi[_0xb10ce5(0x111)](_0x96085a,ElementType[_0xb10ce5(0xec)]);if(_0x5a9493[_0xb10ce5(0x101)](_0x434099,0x0))throw _0x5a9493[_0xb10ce5(0xf4)];const _0x242734={'elementType':ElementType[_0xb10ce5(0xec)],'elementId':'','fileElement':{'fileName':_0x5a9493[_0xb10ce5(0xcc)](_0x21e4cd,_0x183e7c),'filePath':_0x3aca3b,'fileSize':_0x434099[_0xb10ce5(0xd1)]()}};return _0x242734;}static async[_0x2ec5bf(0x108)](_0x49dd6d,_0x4376e6='',_0x3d92f2=''){const _0x48d4e2=_0x2ec5bf,_0x5537ff={'YcNFY':function(_0x5365d3,_0xf8d40,_0x3e4e18){return _0x5365d3(_0xf8d40,_0x3e4e18);},'jfTtz':_0x48d4e2(0x114),'ZGyCR':function(_0x3515c1,_0x513031){return _0x3515c1(_0x513031);},'UoLmf':function(_0xde9635,_0xd64965){return _0xde9635(_0xd64965);},'WlAKc':function(_0x3dffb7,_0x2cd0c4){return _0x3dffb7+_0x2cd0c4;},'kKjsX':function(_0xf8d328,_0x5a5801){return _0xf8d328===_0x5a5801;},'trOqS':_0x48d4e2(0xf8),'eetkj':_0x48d4e2(0x10d),'RivuF':function(_0x3b542a,_0x301825){return _0x3b542a(_0x301825);},'JEuUD':'视频信息','olQaI':function(_0x5e6021,_0x2b63cc){return _0x5e6021||_0x2b63cc;},'iMuQE':function(_0x2e8fdd,_0x156d4d){return _0x2e8fdd+_0x156d4d;}},{fileName:_0x1d668b,path:_0x1bbf21,fileSize:_0xb5f39a,md5:_0x2827b9}=await NTQQFileApi[_0x48d4e2(0x111)](_0x49dd6d,ElementType[_0x48d4e2(0xe8)]);if(_0x5537ff[_0x48d4e2(0xfd)](_0xb5f39a,0x0))throw _0x5537ff[_0x48d4e2(0xc6)];const _0x121e27=_0x5537ff[_0x48d4e2(0xdb)](require,_0x5537ff[_0x48d4e2(0xdc)]);let _0x1c3d9f=_0x1bbf21['replace'](_0x121e27[_0x48d4e2(0x113)]+_0x48d4e2(0xc9)+_0x121e27['sep'],_0x121e27[_0x48d4e2(0x113)]+'Thumb'+_0x121e27[_0x48d4e2(0x113)]);_0x1c3d9f=_0x121e27[_0x48d4e2(0xfa)](_0x1c3d9f);let _0x2cce4d={'width':0x780,'height':0x438,'time':0xf,'format':_0x48d4e2(0xf3),'size':_0xb5f39a,'filePath':_0x49dd6d};try{_0x2cce4d=await _0x5537ff[_0x48d4e2(0xfb)](getVideoInfo,_0x1bbf21),_0x5537ff['YcNFY'](logDebug,_0x5537ff[_0x48d4e2(0xdf)],_0x2cce4d);}catch(_0x3699e3){logError(_0x48d4e2(0xea),_0x3699e3);}const _0x38343b=new Promise((_0x2a6504,_0x3be012)=>{const _0x54cd38=_0x48d4e2,_0x246552={'NjsaS':function(_0x19cde7,_0x57f52e){const _0x3b7787=_0x862f;return _0x5537ff[_0x3b7787(0x106)](_0x19cde7,_0x57f52e);}},_0x3bc056=_0x2827b9+_0x54cd38(0x104),_0x3aa50d=_0x121e27['join'](_0x1c3d9f,_0x3bc056);_0x5537ff[_0x54cd38(0xdb)](_0x4ae4f6,_0x49dd6d)['on'](_0x54cd38(0xe9),()=>{})['on'](_0x54cd38(0xe6),_0x101236=>{const _0x15289e=_0x54cd38;_0x5537ff['YcNFY'](logDebug,_0x5537ff['jfTtz'],_0x101236),_0x3d92f2?_0x398f30[_0x15289e(0x115)](_0x3d92f2,_0x3aa50d)['then'](()=>{const _0x22423b=_0x15289e;_0x246552[_0x22423b(0x100)](_0x2a6504,_0x3aa50d);})[_0x15289e(0x112)](_0x3be012):_0x398f30[_0x15289e(0xc5)](_0x3aa50d,defaultVideoThumb)[_0x15289e(0xe2)](()=>{const _0x203727=_0x15289e;_0x246552[_0x203727(0x100)](_0x2a6504,_0x3aa50d);})[_0x15289e(0x112)](_0x3be012);})[_0x54cd38(0xe4)]({'timestamps':[0x0],'filename':_0x3bc056,'folder':_0x1c3d9f,'size':_0x5537ff['WlAKc'](_0x2cce4d['width']+'x',_0x2cce4d[_0x54cd38(0xf6)])})['on']('end',()=>{_0x2a6504(_0x3aa50d);});}),_0x134f50=new Map(),_0x319aeb=await _0x38343b,_0x2dc60e=(await _0x398f30[_0x48d4e2(0xc2)](_0x319aeb))[_0x48d4e2(0xf0)];_0x134f50[_0x48d4e2(0x10a)](0x0,_0x319aeb);const _0x487b4e=await _0x5537ff[_0x48d4e2(0x106)](calculateFileMD5,_0x319aeb),_0x201593={'elementType':ElementType[_0x48d4e2(0xe8)],'elementId':'','videoElement':{'fileName':_0x5537ff[_0x48d4e2(0xd2)](_0x4376e6,_0x1d668b),'filePath':_0x1bbf21,'videoMd5':_0x2827b9,'thumbMd5':_0x487b4e,'fileTime':_0x2cce4d[_0x48d4e2(0xc3)],'thumbPath':_0x134f50,'thumbSize':_0x2dc60e,'thumbWidth':_0x2cce4d[_0x48d4e2(0x105)],'thumbHeight':_0x2cce4d[_0x48d4e2(0xf6)],'fileSize':_0x5537ff[_0x48d4e2(0xde)]('',_0xb5f39a)}};return _0x201593;}static async[_0x2ec5bf(0x116)](_0x1311bc){const _0x24dda2=_0x2ec5bf,_0x159ae9={'xUsOq':function(_0x563d8e,_0x272e2a){return _0x563d8e(_0x272e2a);},'YSmFt':_0x24dda2(0xe7),'rwRRP':function(_0x111041,_0x7496c9){return _0x111041===_0x7496c9;},'jCVap':function(_0x5a81d5,_0x452792){return _0x5a81d5||_0x452792;}},{converted:_0x38921b,path:_0x488bec,duration:_0x504db5}=await _0x159ae9[_0x24dda2(0xef)](encodeSilk,_0x1311bc);if(!_0x488bec)throw _0x159ae9['YSmFt'];const {md5:_0x35d77b,fileName:_0x3a934d,path:_0x3528c1,fileSize:_0x3dac09}=await NTQQFileApi['uploadFile'](_0x488bec,ElementType['PTT']);if(_0x159ae9[_0x24dda2(0x102)](_0x3dac09,0x0))throw'文件异常，大小为0';return _0x38921b&&_0x398f30[_0x24dda2(0xfe)](_0x488bec)[_0x24dda2(0xe2)](),{'elementType':ElementType[_0x24dda2(0x119)],'elementId':'','pttElement':{'fileName':_0x3a934d,'filePath':_0x3528c1,'md5HexStr':_0x35d77b,'fileSize':_0x3dac09,'duration':_0x159ae9[_0x24dda2(0xf1)](_0x504db5,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static[_0x2ec5bf(0xd5)](_0x4ad6da){const _0x19881c=_0x2ec5bf,_0x2cb068={'kwgRS':function(_0x4fcdcd,_0x9dbd90){return _0x4fcdcd<_0x9dbd90;}};return{'elementType':ElementType[_0x19881c(0xce)],'elementId':'','faceElement':{'faceIndex':_0x4ad6da,'faceType':_0x2cb068[_0x19881c(0xcf)](_0x4ad6da,0xde)?FaceType[_0x19881c(0xc1)]:FaceType['normal2']}};}static[_0x2ec5bf(0xd0)](_0x4d8a71,_0x36f6b9,_0x5e4256,_0xb74dab){return{'elementType':ElementType['MFACE'],'marketFaceElement':{'emojiPackageId':_0x4d8a71,'emojiId':_0x36f6b9,'key':_0x5e4256,'faceName':_0xb74dab||mFaceCache['get'](_0x36f6b9)||'[商城表情]'}};}static[_0x2ec5bf(0xcb)](_0x178b37){const _0x255eb0=_0x2ec5bf,_0x1cc3d1={'vCfBB':'[骰子]'};return{'elementType':ElementType[_0x255eb0(0xce)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x255eb0(0xcb)],'faceType':FaceType['dice'],'faceText':_0x1cc3d1[_0x255eb0(0xf2)],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x2ec5bf(0x109)](_0x487e53){const _0x3a9f23=_0x2ec5bf,_0x21480a={'guGGM':_0x3a9f23(0x10c)};return{'elementType':ElementType[_0x3a9f23(0xce)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x3a9f23(0xc4)],'faceText':_0x21480a['guGGM'],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static['ark'](_0x2c908b){const _0x245951=_0x2ec5bf,_0x56728c={'HBJSs':function(_0x4e6cc5,_0x297c00){return _0x4e6cc5!==_0x297c00;},'UGJFb':_0x245951(0xe0)};return _0x56728c[_0x245951(0x103)](typeof _0x2c908b,_0x56728c[_0x245951(0xda)])&&(_0x2c908b=JSON['stringify'](_0x2c908b)),{'elementType':ElementType[_0x245951(0xf9)],'elementId':'','arkElement':{'bytesData':_0x2c908b,'linkInfo':null,'subElementType':null}};}static[_0x2ec5bf(0xd8)](_0x13061e){const _0x5e9b80=_0x2ec5bf;return{'elementType':ElementType[_0x5e9b80(0xe5)],'elementId':'','markdownElement':{'content':_0x13061e}};}}