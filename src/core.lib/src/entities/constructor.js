const _0x1ea995=_0x458a;(function(_0x3c0bf7,_0x3c7421){const _0x1be1e5=_0x458a,_0xf18d29=_0x3c0bf7();while(!![]){try{const _0x447a10=-parseInt(_0x1be1e5(0x100))/0x1+parseInt(_0x1be1e5(0x10f))/0x2+parseInt(_0x1be1e5(0xcf))/0x3+-parseInt(_0x1be1e5(0xdf))/0x4+parseInt(_0x1be1e5(0xd5))/0x5*(-parseInt(_0x1be1e5(0x127))/0x6)+-parseInt(_0x1be1e5(0xe4))/0x7+-parseInt(_0x1be1e5(0x125))/0x8*(-parseInt(_0x1be1e5(0xf0))/0x9);if(_0x447a10===_0x3c7421)break;else _0xf18d29['push'](_0xf18d29['shift']());}catch(_0x2fe8e7){_0xf18d29['push'](_0xf18d29['shift']());}}}(_0x3868,0xb5d75));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x3d7158}from'node:fs';import _0x2dbe3e from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';function _0x458a(_0x3dfac9,_0x192425){const _0x386870=_0x3868();return _0x458a=function(_0x458a44,_0x155f7b){_0x458a44=_0x458a44-0xc9;let _0x24dd75=_0x386870[_0x458a44];return _0x24dd75;},_0x458a(_0x3dfac9,_0x192425);}function _0x3868(){const _0x286be7=['join','fsDid','QSid','stringify','Hqnfu','PTT','Ori','face','reply','FWpjm','catch','unlink','yLExe','height','1666096nlpBQb','MARKDOWN','uploadFile','TEXT','copyFile','get','ark','视频信息','wriKx','emoji','set','MhouT','ARK','GgLmg','Jbbow','fFGQQ','fAIxR','[商城表情]','string','notAt','[包剪锤]','FILE','791176sJednY','file','6mJhJUV','NZbur','[骰子]','eommx','RPS','AniStickerId','dirname','QDes','3844236nTSuLM','ptt','jpg','toString','vssBn','ddaZr','3201295ETzXbf','getImageSize','rps','sysface','Fmbtk','width','REPLY','图片信息','mface','sep','973452zSRcOq','markdown','获取视频封面失败，使用默认封面','mp4','MUTGe','3749389OHMeBS','pic','fKOJf','FACE','wkVTk','文件异常，大小为0','rzPoe','wLIyR','HrMqv','size','AniStickerPackId','replace','54fZBOEu','Kkvds','语音转换失败,\x20请检查语音文件是否正常','screenshots','PIC','VIDEO','KMUQT','eRChY','video','writeFile','WReHf','dice','Thumb','then','end','_0.png','543772oJNAUi'];_0x3868=function(){return _0x286be7;};return _0x3868();}import _0x2fe847 from'./face_config.json';import*as _0x4e1a7b from'node:path';export const mFaceCache=new Map();export class SendMsgElementConstructor{static['text'](_0xd0b66d){const _0xfea38c=_0x458a;return{'elementType':ElementType[_0xfea38c(0x112)],'elementId':'','textElement':{'content':_0xd0b66d,'atType':AtType[_0xfea38c(0x122)],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x54c8c4,_0x393126,_0x17c172,_0x471863){const _0x44ee25=_0x458a;return{'elementType':ElementType[_0x44ee25(0x112)],'elementId':'','textElement':{'content':'@'+_0x471863,'atType':_0x17c172,'atUid':_0x54c8c4,'atTinyId':'','atNtUid':_0x393126}};}static[_0x1ea995(0x109)](_0x4824b7,_0x3b4f5d,_0x3da46b,_0x2267e5){const _0x435dfa=_0x1ea995;return{'elementType':ElementType[_0x435dfa(0xdb)],'elementId':'','replyElement':{'replayMsgSeq':_0x4824b7,'replayMsgId':_0x3b4f5d,'senderUin':_0x3da46b,'senderUinStr':_0x2267e5}};}static async[_0x1ea995(0xe5)](_0x30d505,_0x1621fc='',_0x432a46=0x0){const _0x219942=_0x1ea995,_0x3d3648={'yLExe':function(_0x15f5b5,_0x3848cb){return _0x15f5b5===_0x3848cb;},'WReHf':_0x219942(0xe9),'KMUQT':function(_0x7db0bd,_0x3f103e){return _0x7db0bd(_0x3f103e);},'NZbur':function(_0x528bec,_0x54d737,_0x363f5f){return _0x528bec(_0x54d737,_0x363f5f);},'rsnEw':_0x219942(0xdc)},{md5:_0x3f0930,fileName:_0x966eab,path:_0x1f3a28,fileSize:_0x426f24}=await NTQQFileApi['uploadFile'](_0x30d505,ElementType[_0x219942(0xf4)],_0x432a46);if(_0x3d3648[_0x219942(0x10d)](_0x426f24,0x0))throw _0x3d3648[_0x219942(0xfa)];const _0x545616=await NTQQFileApi[_0x219942(0xd6)](_0x30d505),_0x5d1716={'md5HexStr':_0x3f0930,'fileSize':_0x426f24[_0x219942(0xd2)](),'picWidth':_0x545616?.[_0x219942(0xda)],'picHeight':_0x545616?.['height'],'fileName':_0x966eab,'sourcePath':_0x1f3a28,'original':!![],'picType':_0x3d3648[_0x219942(0xf6)](isGIF,_0x30d505)?PicType['gif']:PicType[_0x219942(0xd1)],'picSubType':_0x432a46,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x1621fc};return _0x3d3648[_0x219942(0x128)](logDebug,_0x3d3648['rsnEw'],_0x5d1716),{'elementType':ElementType['PIC'],'elementId':'','picElement':_0x5d1716};}static async[_0x1ea995(0x126)](_0x729075,_0x48be2e=''){const _0x2e0998=_0x1ea995,_0x3a8841={'Kkvds':function(_0x51915f,_0x452ba8){return _0x51915f===_0x452ba8;},'iisKv':_0x2e0998(0xe9),'zywsr':function(_0x3be0b2,_0x3e7003){return _0x3be0b2||_0x3e7003;}},{md5:_0x1455a6,fileName:_0x42a3ae,path:_0x5b5410,fileSize:_0x276fc6}=await NTQQFileApi[_0x2e0998(0x111)](_0x729075,ElementType[_0x2e0998(0x124)]);if(_0x3a8841[_0x2e0998(0xf1)](_0x276fc6,0x0))throw _0x3a8841['iisKv'];const _0x1252f1={'elementType':ElementType[_0x2e0998(0x124)],'elementId':'','fileElement':{'fileName':_0x3a8841['zywsr'](_0x48be2e,_0x42a3ae),'filePath':_0x5b5410,'fileSize':_0x276fc6[_0x2e0998(0xd2)]()}};return _0x1252f1;}static async[_0x1ea995(0xf8)](_0xd9bdb4,_0x55a4d5='',_0x44502e=''){const _0x385619=_0x1ea995,_0x26eac2={'HrMqv':function(_0x36c1c8,_0x4a6d1d,_0x441b05){return _0x36c1c8(_0x4a6d1d,_0x441b05);},'FWpjm':_0x385619(0xe1),'ddaZr':function(_0x435eb5,_0x111d15){return _0x435eb5(_0x111d15);},'eRChY':function(_0x2d7a73,_0x16ae96){return _0x2d7a73(_0x16ae96);},'wriKx':_0x385619(0xfe),'wLIyR':'error','GgLmg':function(_0x2c004b,_0x5f300a){return _0x2c004b+_0x5f300a;},'eommx':function(_0x59ccdd,_0x4fe2c7){return _0x59ccdd===_0x4fe2c7;},'kFkqh':_0x385619(0xe9),'Jbbow':_0x385619(0xe2),'fsDid':_0x385619(0x116),'rzPoe':function(_0x355476,_0x1c8be2,_0x59f8db){return _0x355476(_0x1c8be2,_0x59f8db);},'fAIxR':function(_0x2d4d9d,_0x5addc1){return _0x2d4d9d(_0x5addc1);},'fFGQQ':function(_0x4b9546,_0x1fa02f){return _0x4b9546||_0x1fa02f;},'vssBn':function(_0x317781,_0x5dead0){return _0x317781+_0x5dead0;}},{fileName:_0x5e233e,path:_0x3e4766,fileSize:_0x486b6d,md5:_0x38274c}=await NTQQFileApi['uploadFile'](_0xd9bdb4,ElementType[_0x385619(0xf5)]);if(_0x26eac2[_0x385619(0xca)](_0x486b6d,0x0))throw _0x26eac2['kFkqh'];let _0x39663a=_0x3e4766[_0x385619(0xef)](_0x4e1a7b[_0x385619(0xde)]+_0x385619(0x107)+_0x4e1a7b['sep'],_0x4e1a7b[_0x385619(0xde)]+_0x385619(0xfc)+_0x4e1a7b[_0x385619(0xde)]);_0x39663a=_0x4e1a7b[_0x385619(0xcd)](_0x39663a);let _0x55d17f={'width':0x780,'height':0x438,'time':0xf,'format':_0x26eac2[_0x385619(0x11d)],'size':_0x486b6d,'filePath':_0xd9bdb4};try{_0x55d17f=await _0x26eac2[_0x385619(0xd4)](getVideoInfo,_0x3e4766),logDebug(_0x26eac2[_0x385619(0x102)],_0x55d17f);}catch(_0x393b29){_0x26eac2[_0x385619(0xea)](logError,'获取视频信息失败',_0x393b29);}const _0x3cac55=new Promise((_0x2f33b9,_0xeb7db9)=>{const _0x47f92e=_0x385619,_0x222f9d={'Plwqg':function(_0x367f00,_0x30980b){return _0x26eac2['ddaZr'](_0x367f00,_0x30980b);},'KgQQh':function(_0x4315ef,_0x5ba70d){const _0x465e4a=_0x458a;return _0x26eac2[_0x465e4a(0xd4)](_0x4315ef,_0x5ba70d);}},_0x27ade7=_0x38274c+_0x47f92e(0xff),_0x451043=_0x4e1a7b[_0x47f92e(0x101)](_0x39663a,_0x27ade7);_0x26eac2[_0x47f92e(0xf7)](_0x2dbe3e,_0xd9bdb4)['on'](_0x26eac2[_0x47f92e(0x117)],()=>{})['on'](_0x26eac2[_0x47f92e(0xeb)],_0x3601d4=>{const _0x256a7e=_0x47f92e;_0x26eac2[_0x256a7e(0xec)](logDebug,_0x26eac2[_0x256a7e(0x10a)],_0x3601d4),_0x44502e?_0x3d7158[_0x256a7e(0x113)](_0x44502e,_0x451043)[_0x256a7e(0xfd)](()=>{_0x222f9d['Plwqg'](_0x2f33b9,_0x451043);})[_0x256a7e(0x10b)](_0xeb7db9):_0x3d7158[_0x256a7e(0xf9)](_0x451043,defaultVideoThumb)['then'](()=>{_0x222f9d['KgQQh'](_0x2f33b9,_0x451043);})[_0x256a7e(0x10b)](_0xeb7db9);})[_0x47f92e(0xf3)]({'timestamps':[0x0],'filename':_0x27ade7,'folder':_0x39663a,'size':_0x26eac2[_0x47f92e(0x11c)](_0x55d17f[_0x47f92e(0xda)],'x')+_0x55d17f[_0x47f92e(0x10e)]})['on'](_0x26eac2[_0x47f92e(0x117)],()=>{const _0x2bc518=_0x47f92e;_0x26eac2[_0x2bc518(0xd4)](_0x2f33b9,_0x451043);});}),_0x3c2037=new Map(),_0x3f1c18=await _0x3cac55,_0x22c428=(await _0x3d7158['stat'](_0x3f1c18))[_0x385619(0xed)];_0x3c2037[_0x385619(0x119)](0x0,_0x3f1c18);const _0x5e3fd1=await _0x26eac2[_0x385619(0x11f)](calculateFileMD5,_0x3f1c18),_0x184261={'elementType':ElementType[_0x385619(0xf5)],'elementId':'','videoElement':{'fileName':_0x26eac2[_0x385619(0x11e)](_0x55a4d5,_0x5e233e),'filePath':_0x3e4766,'videoMd5':_0x38274c,'thumbMd5':_0x5e3fd1,'fileTime':_0x55d17f['time'],'thumbPath':_0x3c2037,'thumbSize':_0x22c428,'thumbWidth':_0x55d17f['width'],'thumbHeight':_0x55d17f[_0x385619(0x10e)],'fileSize':_0x26eac2[_0x385619(0xd3)]('',_0x486b6d)}};return _0x184261;}static async[_0x1ea995(0xd0)](_0xa97de2){const _0x138003=_0x1ea995,_0x439cb0={'Fmbtk':_0x138003(0xf2),'dDYiK':function(_0x43c3e6,_0x8c0786){return _0x43c3e6===_0x8c0786;},'wkVTk':_0x138003(0xe9),'MhouT':function(_0x3c5903,_0xe8b7ad){return _0x3c5903||_0xe8b7ad;}},{converted:_0x257bcd,path:_0xfb959f,duration:_0x58a57a}=await encodeSilk(_0xa97de2);if(!_0xfb959f)throw _0x439cb0[_0x138003(0xd9)];const {md5:_0xf39acb,fileName:_0x2e6965,path:_0x2e0196,fileSize:_0xe4b306}=await NTQQFileApi[_0x138003(0x111)](_0xfb959f,ElementType[_0x138003(0x106)]);if(_0x439cb0['dDYiK'](_0xe4b306,0x0))throw _0x439cb0[_0x138003(0xe8)];return _0x257bcd&&_0x3d7158[_0x138003(0x10c)](_0xfb959f)['then'](),{'elementType':ElementType['PTT'],'elementId':'','pttElement':{'fileName':_0x2e6965,'filePath':_0x2e0196,'md5HexStr':_0xf39acb,'fileSize':_0xe4b306,'duration':_0x439cb0[_0x138003(0x11a)](_0x58a57a,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static[_0x1ea995(0x108)](_0x2843c3){const _0x41e360=_0x1ea995,_0x205ca3={'MUTGe':function(_0x1e3dd4,_0x5d2aa6){return _0x1e3dd4>=_0x5d2aa6;}},_0x1c2de7=_0x2fe847[_0x41e360(0xd8)],_0x4c7966=_0x2fe847[_0x41e360(0x118)],_0x59c400=_0x1c2de7['find'](_0x52f48d=>_0x52f48d[_0x41e360(0x103)]===_0x2843c3[_0x41e360(0xd2)]());_0x2843c3=parseInt(_0x2843c3['toString']());let _0x444254=0x1;return _0x205ca3[_0x41e360(0xe3)](_0x2843c3,0xde)&&(_0x444254=0x2),_0x59c400['AniStickerType']&&(_0x444254=0x3),{'elementType':ElementType[_0x41e360(0xe7)],'elementId':'','faceElement':{'faceIndex':_0x2843c3,'faceType':_0x444254,'faceText':_0x59c400[_0x41e360(0xce)],'stickerId':_0x59c400[_0x41e360(0xcc)],'stickerType':_0x59c400['AniStickerType'],'packId':_0x59c400[_0x41e360(0xee)],'sourceType':0x1}};}static[_0x1ea995(0xdd)](_0x40ceae,_0x1d9ab4,_0x3666cf,_0x50744f){const _0x407f34=_0x1ea995,_0x2722dd={'Hqnfu':_0x407f34(0x120)};return{'elementType':ElementType['MFACE'],'marketFaceElement':{'emojiPackageId':_0x40ceae,'emojiId':_0x1d9ab4,'key':_0x3666cf,'faceName':_0x50744f||mFaceCache[_0x407f34(0x114)](_0x1d9ab4)||_0x2722dd[_0x407f34(0x105)]}};}static[_0x1ea995(0xfb)](_0x2b9bf5){const _0x7f07a3=_0x1ea995,_0x5bc765={'tblck':_0x7f07a3(0xc9)};return{'elementType':ElementType['FACE'],'elementId':'','faceElement':{'faceIndex':FaceIndex['dice'],'faceType':FaceType[_0x7f07a3(0xfb)],'faceText':_0x5bc765['tblck'],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x1ea995(0xd7)](_0x38d6b9){const _0x305913=_0x1ea995;return{'elementType':ElementType[_0x305913(0xe7)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x305913(0xcb)],'faceText':_0x305913(0x123),'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x1ea995(0x115)](_0x5c3c24){const _0x34f599=_0x1ea995,_0x3770a6={'mrmgx':function(_0x8d9da1,_0x562986){return _0x8d9da1!==_0x562986;},'fKOJf':_0x34f599(0x121)};return _0x3770a6['mrmgx'](typeof _0x5c3c24,_0x3770a6[_0x34f599(0xe6)])&&(_0x5c3c24=JSON[_0x34f599(0x104)](_0x5c3c24)),{'elementType':ElementType[_0x34f599(0x11b)],'elementId':'','arkElement':{'bytesData':_0x5c3c24,'linkInfo':null,'subElementType':null}};}static[_0x1ea995(0xe0)](_0x15a2ce){const _0x1a46be=_0x1ea995;return{'elementType':ElementType[_0x1a46be(0x110)],'elementId':'','markdownElement':{'content':_0x15a2ce}};}}